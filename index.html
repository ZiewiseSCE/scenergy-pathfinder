<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar Pathfinder</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#101a33; --panel2:#0f1830; --text:#e7ecff; --muted:#aab6e8;
      --line:rgba(255,255,255,.10); --good:#2ee59d; --bad:#ff5a7a; --warn:#ffcc66;
      --btn:#3b82f6; --btn2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR";
      background:radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.30), transparent 55%),
                 radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.20), transparent 60%),
                 var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }
    .wrap{width:min(1100px,100%)}
    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:18px;
    }
    .brand{display:flex; flex-direction:column; gap:6px}
    .brand h1{margin:0; font-size:22px; letter-spacing:.2px}
    .brand p{margin:0; color:var(--muted); font-size:13px}
    .pill{padding:6px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted)}

    .grid{display:grid; grid-template-columns: 420px 1fr; gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 8px 0; font-size:15px}
    .desc{margin:0 0 14px 0; color:var(--muted); font-size:13px; line-height:1.45}

    label{display:block; font-size:12px; color:var(--muted); margin:12px 0 6px}
    input[type=text]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(10,15,30,.55); color:var(--text); outline:none;
    }
    input[type=text]:focus{border-color:rgba(59,130,246,.7); box-shadow:0 0 0 4px rgba(59,130,246,.15)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      padding:11px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
      background:rgba(59,130,246,.18); color:var(--text); cursor:pointer;
      font-weight:600; letter-spacing:.2px;
    }
    .btn.primary{background:rgba(34,197,94,.18)}
    .btn:hover{filter:brightness(1.08)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .hint{font-size:12px; color:var(--muted); line-height:1.5}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .status{
      margin-top:12px; border-radius:14px; border:1px solid var(--line);
      background:rgba(10,15,30,.45); padding:12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dot{width:10px; height:10px; border-radius:50%; margin-top:4px}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .status b{display:block; font-size:13px; margin-bottom:4px}
    .status p{margin:0; font-size:12px; color:var(--muted); line-height:1.45}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .action{
      flex:1; min-width:180px;
      border-radius:16px; border:1px solid var(--line);
      background:rgba(10,15,30,.45);
      padding:14px;
    }
    .action h3{margin:0 0 6px 0; font-size:14px}
    .action p{margin:0 0 10px 0; color:var(--muted); font-size:12px; line-height:1.45}
    .action a{
      display:inline-block; padding:10px 12px; border-radius:12px;
      background:rgba(59,130,246,.18); border:1px solid rgba(255,255,255,.14);
      color:var(--text); text-decoration:none; font-weight:600;
    }
    .action a:hover{filter:brightness(1.08)}

    .foot{margin-top:14px; color:var(--muted); font-size:12px; line-height:1.5}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Solar Pathfinder</h1>
        <p>라이선스 등록 후 프로그램을 사용할 수 있습니다.</p>
      </div>
      <div class="pill">Device-locked License</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>라이선스 등록</h2>
        <p class="desc">메일로 받은 라이선스 키를 붙여넣거나, 라이선스 파일(.lic/.key/.txt)을 업로드하세요. 등록은 이 기기에 1회 바인딩됩니다.</p>

        <label for="backendInput">백엔드 주소</label>
        <input id="backendInput" type="text" placeholder="예: https://port-0-xxxxx.sel3.cloudtype.app" autocomplete="off" />
        <p class="hint" style="margin:6px 0 0 0">※ 처음 1회만 설정하면 브라우저에 저장됩니다. DNS 오류(ERR_NAME_NOT_RESOLVED)는 보통 백엔드 주소 오타/누락입니다.</p>

        <label for="tokenInput">라이선스 키</label>
        <input id="tokenInput" type="text" placeholder="예: SCE-AAA-111" autocomplete="off" />

        <div class="row" style="margin-top:12px">
          <input id="fileInput" type="file" accept=".lic,.key,.txt" />
          <button id="btnActivate" class="btn primary">등록하고 시작</button>
        </div>

        <div id="statusBox" class="status" style="display:none">
          <div id="statusDot" class="dot warn"></div>
          <div>
            <b id="statusTitle">상태</b>
            <p id="statusMsg">-</p>
            <p class="hint" style="margin-top:6px"><span class="mono">만료일</span>: <span id="expiresAt">-</span></p>
          </div>
        </div>

        <div class="foot">
          • 이 사이트는 서버에서 만료/폐기 여부를 확인합니다.<br />
          • 라이선스가 만료되면 새 키를 발급받아 다시 등록해야 합니다.
        </div>
      </div>

      <div class="card">
        <h2>프로그램</h2>
        <p class="desc">인증이 완료되면 기능을 사용할 수 있습니다.</p>

        <div class="actions">
          <div class="action">
            <h3>Pathfinder</h3>
            <p>태양광 지붕 대상 탐색/분석 화면으로 이동합니다.</p>
            <a id="goMain" href="#" onclick="return false;">열기</a>
          </div>
          <div class="action">
            <h3>Report</h3>
            <p>분석 결과 상세 리포트 화면을 확인합니다.</p>
            <a id="goReport" href="#" onclick="return false;">열기</a>
          </div>
        </div>

        <div class="status" id="lockedBox">
          <div class="dot warn"></div>
          <div>
            <b>잠김</b>
            <p>라이선스 인증이 필요합니다. 왼쪽에서 키를 등록하세요.</p>
          </div>
        </div>

        <div class="status" id="unlockedBox" style="display:none">
          <div class="dot good"></div>
          <div>
            <b>인증 완료</b>
            <p>이 기기에서 사용 가능합니다.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="adminWrap" style="margin-top:16px; display:none">
      <div class="card">
        <div class="top" style="margin:0 0 8px 0">
          <div class="brand">
            <h2 style="margin:0">관리자</h2>
            <p style="margin:0; color:var(--muted); font-size:13px">라이선스 발급/조회/리셋/폐기</p>
          </div>
          <div class="pill">Admin</div>
        </div>

        <label for="adminKeyInput">ADMIN_API_KEY</label>
        <input id="adminKeyInput" type="text" placeholder="Cloudtype에 설정한 ADMIN_API_KEY 입력" autocomplete="off" />
        <div class="row" style="margin-top:10px">
          <button id="btnAdminLoad" class="btn">목록 새로고침</button>
        </div>

        <div class="grid" style="grid-template-columns: 420px 1fr; margin-top:14px">
          <div class="card" style="padding:14px; border-radius:16px">
            <h2 style="margin:0 0 8px 0">라이선스 발급</h2>
            <p class="desc" style="margin:0 0 10px 0">만료일을 선택하고 발급하면 토큰이 생성됩니다. 생성된 토큰을 메일로 전달하세요.</p>
            <label for="issueExpiry">만료일</label>
            <input id="issueExpiry" type="text" placeholder="예: 2026-02-29T23:59:59+09:00" />
            <label for="issueNote">비고(옵션)</label>
            <input id="issueNote" type="text" placeholder="예: Tablet-01" />
            <div class="row" style="margin-top:10px">
              <button id="btnIssue" class="btn primary">발급</button>
              <button id="btnFill30d" class="btn">+30일</button>
              <button id="btnFill90d" class="btn">+90일</button>
            </div>
            <div class="status" id="issueStatus" style="display:none; margin-top:12px">
              <div id="issueDot" class="dot warn"></div>
              <div>
                <b id="issueTitle">-</b>
                <p id="issueMsg">-</p>
              </div>
            </div>
          </div>

          <div class="card" style="padding:14px; border-radius:16px">
            <h2 style="margin:0 0 8px 0">라이선스 목록</h2>
            <p class="desc" style="margin:0 0 10px 0">Reset은 바인딩을 풀어 재등록을 허용합니다. Revoke는 즉시 차단합니다.</p>
            <div style="overflow:auto; border:1px solid var(--line); border-radius:14px">
              <table style="width:100%; border-collapse:collapse; font-size:12px">
                <thead style="background:rgba(10,15,30,.55)">
                  <tr>
                    <th style="text-align:left; padding:10px; border-bottom:1px solid var(--line)">Token</th>
                    <th style="text-align:left; padding:10px; border-bottom:1px solid var(--line)">Expires</th>
                    <th style="text-align:left; padding:10px; border-bottom:1px solid var(--line)">State</th>
                    <th style="text-align:left; padding:10px; border-bottom:1px solid var(--line)">Note</th>
                    <th style="text-align:left; padding:10px; border-bottom:1px solid var(--line)">Actions</th>
                  </tr>
                </thead>
                <tbody id="adminTbody"></tbody>
              </table>
            </div>
            <p class="hint" style="margin-top:10px">※ 관리자키는 HTML에 저장하지 마세요. 필요할 때 입력하고 새로고침하면 됩니다.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // backend URL: ?backend=https://...cloudtype.app
  const params = new URLSearchParams(location.search);
  const LS_BACKEND = 'spf_backend';
  const LS_TOKEN = 'spf_token';
  const isAdmin = (params.get('admin') || '') === '1';

  let BACKEND = (params.get('backend') || localStorage.getItem(LS_BACKEND) || '').trim();

  const backendInput = document.getElementById('backendInput');
  const tokenInput = document.getElementById('tokenInput');
  const fileInput = document.getElementById('fileInput');
  const btnActivate = document.getElementById('btnActivate');

  const statusBox = document.getElementById('statusBox');
  const statusDot = document.getElementById('statusDot');
  const statusTitle = document.getElementById('statusTitle');
  const statusMsg = document.getElementById('statusMsg');
  const expiresAt = document.getElementById('expiresAt');

  const lockedBox = document.getElementById('lockedBox');
  const unlockedBox = document.getElementById('unlockedBox');

  const goMain = document.getElementById('goMain');
  const goReport = document.getElementById('goReport');

  backendInput.value = BACKEND;
  backendInput.addEventListener('change', ()=>{
    BACKEND = (backendInput.value || '').trim();
    if(BACKEND) localStorage.setItem(LS_BACKEND, BACKEND);
  });

  function showStatus(kind, title, msg, exp){
    statusBox.style.display = 'flex';
    statusDot.className = 'dot ' + (kind || 'warn');
    statusTitle.textContent = title || '상태';
    statusMsg.textContent = msg || '-';
    expiresAt.textContent = exp || '-';
  }

  function setUnlocked(isOk){
    lockedBox.style.display = isOk ? 'none' : 'flex';
    unlockedBox.style.display = isOk ? 'flex' : 'none';
    const hrefMain = isOk ? ('./scenergy-pathfinder/' + location.search) : '#';
    const hrefReport = isOk ? ('./report.html' + location.search) : '#';
    goMain.href = hrefMain;
    goReport.href = hrefReport;
    goMain.onclick = isOk ? null : (e)=>{e.preventDefault();};
    goReport.onclick = isOk ? null : (e)=>{e.preventDefault();};
  }

  // Lightweight fingerprint (stable-ish): UA + platform + language + timezone + cores
  async function getFingerprint(){
    const nav = navigator;
    const parts = [
      nav.userAgent || '',
      nav.platform || '',
      nav.language || '',
      Intl.DateTimeFormat().resolvedOptions().timeZone || '',
      String(nav.hardwareConcurrency || ''),
    ].join('||');
    const enc = new TextEncoder().encode(parts);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function api(path, opts){
    if(!BACKEND){ throw new Error('백엔드 주소를 입력하세요. (예: https://port-0-...cloudtype.app)'); }
    const fp = await getFingerprint();
    const token = (localStorage.getItem(LS_TOKEN) || '').trim();
    const headers = Object.assign({
      'Content-Type': 'application/json',
      'X-CLIENT-TOKEN': token,
      'X-CLIENT-FP': fp,
    }, (opts && opts.headers) || {});

    const res = await fetch(BACKEND.replace(/\/$/, '') + path, Object.assign({}, opts || {}, {headers}));
    const data = await res.json().catch(()=>({}));
    return {res, data};
  }

  async function verifyExisting(){
    try{
      const {res, data} = await api('/api/auth/verify', {method:'GET'});
      if(res.ok && data.ok){
        showStatus('good', '인증 완료', '이 기기에서 사용 가능합니다.', data.expires_at);
        setUnlocked(true);
        return;
      }
      if(res.ok && data.ok === false){
        // Not activated or missing fp
        showStatus('warn', '등록 필요', data.msg || '라이선스 등록이 필요합니다.', data.expires_at);
      } else {
        showStatus('bad', '인증 실패', (data && data.msg) || '인증에 실패했습니다.', data.expires_at);
      }
    }catch(e){
      showStatus('bad', '연결 실패', e.message || '서버에 연결할 수 없습니다.', '-');
    }
    setUnlocked(false);
  }

  fileInput.addEventListener('change', async ()=>{
    const f = fileInput.files && fileInput.files[0];
    if(!f) return;
    const text = await f.text();
    tokenInput.value = (text || '').trim();
  });

  btnActivate.addEventListener('click', async ()=>{
    const token = (tokenInput.value || '').trim();
    if(!token){
      showStatus('warn','키 필요','라이선스 키를 입력하거나 파일을 업로드하세요.','-');
      return;
    }
    try{
      const fp = await getFingerprint();
      // Save token locally first so follow-up verify uses it
      localStorage.setItem(LS_TOKEN, token);
      const {res, data} = await api('/api/license/activate', {
        method:'POST',
        body: JSON.stringify({token, fingerprint: fp})
      });
      if(res.ok && data.ok){
        showStatus('good','등록 완료','라이선스가 이 기기에 등록되었습니다.', data.expires_at);
        setUnlocked(true);
      } else {
        showStatus('bad','등록 실패', (data && data.msg) || '등록에 실패했습니다.', data.expires_at);
        setUnlocked(false);
      }
    }catch(e){
      showStatus('bad','연결 실패', e.message || '서버에 연결할 수 없습니다.','-');
      setUnlocked(false);
    }
  });

  // init
  const saved = (localStorage.getItem(LS_TOKEN) || '').trim();
  if(saved) tokenInput.value = saved;
  verifyExisting();

  // -----------------------
  // Admin UI
  // -----------------------
  const adminWrap = document.getElementById('adminWrap');
  if(isAdmin){
    adminWrap.style.display = 'block';
    const adminKeyInput = document.getElementById('adminKeyInput');
    const btnAdminLoad = document.getElementById('btnAdminLoad');
    const btnIssue = document.getElementById('btnIssue');
    const btnFill30d = document.getElementById('btnFill30d');
    const btnFill90d = document.getElementById('btnFill90d');
    const issueExpiry = document.getElementById('issueExpiry');
    const issueNote = document.getElementById('issueNote');
    const adminTbody = document.getElementById('adminTbody');
    const issueStatus = document.getElementById('issueStatus');
    const issueDot = document.getElementById('issueDot');
    const issueTitle = document.getElementById('issueTitle');
    const issueMsg = document.getElementById('issueMsg');

    function showIssue(kind, title, msg){
      issueStatus.style.display = 'flex';
      issueDot.className = 'dot ' + (kind || 'warn');
      issueTitle.textContent = title || '-';
      issueMsg.textContent = msg || '-';
    }

    function isoPlusDays(days){
      const d = new Date();
      d.setDate(d.getDate() + days);
      // Asia/Seoul offset formatting (+09:00)
      const tzOffMin = -d.getTimezoneOffset();
      const sign = tzOffMin >= 0 ? '+' : '-';
      const hh = String(Math.floor(Math.abs(tzOffMin)/60)).padStart(2,'0');
      const mm = String(Math.abs(tzOffMin)%60).padStart(2,'0');
      const pad = (n)=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T23:59:59${sign}${hh}:${mm}`;
    }
    btnFill30d.onclick = ()=>{ issueExpiry.value = isoPlusDays(30); };
    btnFill90d.onclick = ()=>{ issueExpiry.value = isoPlusDays(90); };

    async function adminFetch(path, opts){
      if(!BACKEND){ throw new Error('백엔드 주소를 입력하세요.'); }
      const key = (adminKeyInput.value || '').trim();
      if(!key){ throw new Error('ADMIN_API_KEY를 입력하세요.'); }
      const headers = Object.assign({
        'Content-Type': 'application/json',
        'X-ADMIN-KEY': key,
      }, (opts && opts.headers) || {});
      const res = await fetch(BACKEND.replace(/\/$/, '') + path, Object.assign({}, opts||{}, {headers}));
      const data = await res.json().catch(()=>({}));
      return {res, data};
    }

    function renderRows(items){
      adminTbody.innerHTML = '';
      (items||[]).forEach(it=>{
        const state = it.revoked ? 'REVOKED' : (it.bound ? 'BOUND' : 'NEW');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:10px; border-bottom:1px solid var(--line)"><span class="mono">${it.token}</span></td>
          <td style="padding:10px; border-bottom:1px solid var(--line)">${it.expires_at || ''}</td>
          <td style="padding:10px; border-bottom:1px solid var(--line)">${state}</td>
          <td style="padding:10px; border-bottom:1px solid var(--line)">${(it.note||'').replace(/</g,'&lt;')}</td>
          <td style="padding:10px; border-bottom:1px solid var(--line)">
            <button class="btn" data-act="copy" data-token="${it.token}">Copy</button>
            <button class="btn" data-act="reset" data-token="${it.token}">Reset</button>
            <button class="btn" data-act="revoke" data-token="${it.token}">Revoke</button>
          </td>
        `;
        adminTbody.appendChild(tr);
      });
    }

    async function loadLicenses(){
      try{
        const {res, data} = await adminFetch('/api/admin/licenses', {method:'GET'});
        if(res.ok && data.ok){
          renderRows(data.licenses || []);
          showIssue('good','로드 완료',`총 ${data.count||0}개`);
        }else{
          showIssue('bad','로드 실패', (data && data.msg) || '실패');
        }
      }catch(e){
        showIssue('bad','네트워크 오류', e.message || '연결 실패');
      }
    }

    btnAdminLoad.onclick = (e)=>{ e.preventDefault(); loadLicenses(); };

    btnIssue.onclick = async (e)=>{
      e.preventDefault();
      try{
        const exp = (issueExpiry.value||'').trim();
        if(!exp){ showIssue('warn','만료일 필요','expires_at 값을 입력하세요.'); return; }
        const note = (issueNote.value||'').trim();
        const {res, data} = await adminFetch('/api/admin/licenses', {
          method:'POST',
          body: JSON.stringify({expires_at: exp, note})
        });
        if(res.ok && data.ok){
          const tok = data.token;
          await navigator.clipboard.writeText(tok).catch(()=>{});
          showIssue('good','발급 완료',`토큰: ${tok} (클립보드 복사됨)`);
          loadLicenses();
        }else{
          showIssue('bad','발급 실패', (data && data.msg) || '실패');
        }
      }catch(e){
        showIssue('bad','네트워크 오류', e.message || '연결 실패');
      }
    };

    adminTbody.addEventListener('click', async (e)=>{
      const btn = e.target && e.target.closest('button');
      if(!btn) return;
      const act = btn.getAttribute('data-act');
      const token = btn.getAttribute('data-token');
      if(!act || !token) return;
      try{
        if(act === 'copy'){
          await navigator.clipboard.writeText(token).catch(()=>{});
          showIssue('good','복사 완료',`클립보드에 복사됨: ${token}`);
          return;
        }
        if(act === 'reset'){
          const {res, data} = await adminFetch(`/api/admin/licenses/${encodeURIComponent(token)}/reset`, {method:'POST'});
          if(res.ok && data.ok){ showIssue('good','Reset 완료',token); loadLicenses(); }
          else { showIssue('bad','Reset 실패', (data && data.msg) || '실패'); }
          return;
        }
        if(act === 'revoke'){
          const {res, data} = await adminFetch(`/api/admin/licenses/${encodeURIComponent(token)}/revoke`, {method:'POST'});
          if(res.ok && data.ok){ showIssue('good','Revoke 완료',token); loadLicenses(); }
          else { showIssue('bad','Revoke 실패', (data && data.msg) || '실패'); }
          return;
        }
      }catch(err){
        showIssue('bad','네트워크 오류', err.message || '연결 실패');
      }
    });

    // auto load
    loadLicenses();
  }
})();
</script>
</body>
</html>
