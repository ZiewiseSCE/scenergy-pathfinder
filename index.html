<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar Pathfinder</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b1020;color:#e8eeff;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{max-width:780px;width:100%;background:#121a33;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{border-radius:12px;border:1px solid rgba(255,255,255,.16);background:#0f1630;color:#e8eeff;padding:12px;font-size:14px}
    input{flex:1;min-width:260px}
    button{cursor:pointer;font-weight:700}
    button.primary{background:#60a5fa;border-color:#60a5fa;color:#081024}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;word-break:break-all}
    .muted{color:#93a4c7;font-size:12px;line-height:1.45}
    .ok{color:#34d399}
    .bad{color:#f87171}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px">License Gate</h2>
    <div class="muted">첫 1회 등록 후에는 자동 인증(/api/auth/auto)로 바로 메인으로 이동합니다.</div>
    <div style="height:10px"></div>

    <div class="row">
      <div class="muted">Backend:</div>
      <div class="mono" id="backendText">-</div>
    </div>
    <div style="height:8px"></div>

    <div class="row">
      <div class="muted">Fingerprint:</div>
      <div class="mono" id="fpText">-</div>
    </div>

    <div style="height:14px"></div>
    <div class="row">
      <input id="tokenInput" placeholder="라이선스 키 (예: SCE-XXXXXXXXXX)" autocomplete="off" />
      <button class="primary" onclick="activate()">등록</button>
      <button onclick="verify()">검증</button>
    </div>

    <div style="height:14px"></div>
    <div id="msg" class="muted">준비 중...</div>

    <div style="height:14px"></div>
    <div class="muted">
      • 관리자 발급 페이지: <span class="mono">/admin.html</span><br>
      • 리다이렉트 목적지: <span class="mono">?next=/map.html</span> (기본: ./map.html)
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const DEFAULT_BACKEND = "https://port-0-solar-server-mkiol9jsc308f567.sel3.cloudtype.app";
  const BACKEND_URL = (params.get("backend") || DEFAULT_BACKEND).replace(/\/$/, "");
  const NEXT_URL = (params.get("next") || "./map.html").trim();

  document.getElementById("backendText").innerText = BACKEND_URL;

  const LS_FP="spf_fp";
  const LS_TOKEN="spf_token";

  function setMsg(html){ document.getElementById("msg").innerHTML = html; }

  async function sha256Hex(input){
    const enc=new TextEncoder();
    const buf=await crypto.subtle.digest("SHA-256", enc.encode(input));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function computeFp(){
    const parts=[navigator.userAgent,navigator.platform,navigator.language,Intl.DateTimeFormat().resolvedOptions().timeZone].join("|");
    return await sha256Hex(parts);
  }

  function lsGet(k){ try{return (localStorage.getItem(k)||"").trim();}catch(e){return "";} }
  function lsSet(k,v){ try{localStorage.setItem(k,(v||"").trim());}catch(e){} }

  function go(){ location.replace(NEXT_URL); }

  async function api(path, body){
    const res = await fetch(BACKEND_URL + path, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body||{})
    });
    const data = await res.json().catch(()=>({}));
    return {res,data};
  }

  async function auto(fp){
    return await api("/api/auth/auto", {fingerprint: fp});
  }

  async function verify(){
    const fp = lsGet(LS_FP);
    const token = lsGet(LS_TOKEN) || document.getElementById("tokenInput").value.trim();
    if(!fp) return setMsg("<span class='bad'>FP 없음</span>");
    if(!token) return setMsg("<span class='bad'>키를 입력하세요</span>");

    setMsg("검증 중...");
    const {res,data} = await api("/api/auth/verify", {token, fingerprint: fp});
    if(res.ok && data.ok===true){
      lsSet(LS_TOKEN, token);
      setMsg("<span class='ok'>인증 OK</span> 만료: " + (data.expires_at||"-") + " → 이동합니다");
      setTimeout(go, 500);
      return;
    }
    setMsg("<span class='bad'>인증 실패</span> " + (data.msg||res.status));
  }

  async function activate(){
    const fp = lsGet(LS_FP);
    const token = document.getElementById("tokenInput").value.trim() || lsGet(LS_TOKEN);
    if(!fp) return setMsg("<span class='bad'>FP 없음</span>");
    if(!token) return setMsg("<span class='bad'>키를 입력하세요</span>");

    setMsg("등록 중...");
    const {res,data} = await api("/api/license/activate", {token, fingerprint: fp});
    if(res.ok && data.ok===true){
      lsSet(LS_TOKEN, token);
      setMsg("<span class='ok'>등록 OK</span> 만료: " + (data.expires_at||"-") + " → 이동합니다");
      setTimeout(go, 500);
      return;
    }
    setMsg("<span class='bad'>등록 실패</span> " + (data.msg||res.status));
  }

  (async function init(){
    const fp = await computeFp();
    lsSet(LS_FP, fp);
    document.getElementById("fpText").innerText = fp;

    // ✅ auto first: solves "stuck on license screen"
    setMsg("자동 인증 확인 중...");
    const {res,data} = await auto(fp);
    if(res.ok && data.ok===true){
      setMsg("<span class='ok'>자동 인증 OK</span> 만료: " + (data.expires_at||"-") + " → 이동합니다");
      setTimeout(go, 500);
      return;
    }
    setMsg("자동 인증 없음. 키를 입력해서 등록하세요.");
  })();
</script>
</body>
</html>


