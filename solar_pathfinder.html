<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íƒœì–‘ê´‘ Pathfinder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ìŠ¤íƒ€ì¼/ë””ìì¸ ê´€ë ¨ ë¶€ë¶„ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
      body {
        background: radial-gradient(circle at top, #1f2937 0, #020617 40%, #000 100%);
        color: #e5e7eb;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      .glass {
        background: linear-gradient(to bottom right, rgba(15,23,42,0.85), rgba(15,23,42,0.6));
        border: 1px solid rgba(148,163,184,0.3);
        box-shadow: 0 15px 35px rgba(15,23,42,0.8);
      }
      .result-card {
        background: linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.92));
        border: 1px solid rgba(148,163,184,0.5);
        box-shadow: 0 20px 50px rgba(15,23,42,0.95);
      }
      .zoom-indicator-glass {
        background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(15,23,42,0.9));
        border: 1px solid rgba(148,163,184,0.6);
        box-shadow: 0 12px 30px rgba(15,23,42,0.9);
      }
      .btn-primary {
        background: linear-gradient(to right, #4f46e5, #06b6d4);
      }
      .btn-primary:hover {
        background: linear-gradient(to right, #4338ca, #0891b2);
      }
      .btn-ghost {
        background: rgba(15,23,42,0.9);
      }
      .btn-ghost:hover {
        background: rgba(30,64,175,0.4);
      }
      .map-control {
        background: linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.92));
        border: 1px solid rgba(148,163,184,0.5);
      }
      .toast {
        backdrop-filter: blur(8px);
      }
      #map {
        position: relative;
      }
      .kakao-map-layer {
        position: absolute;
        inset: 0;
        z-index: 0;
      }
    </style>
</head>
<body class="min-h-screen">
<div id="app" class="min-h-screen flex flex-col">
  <header class="px-4 md:px-8 py-4 flex items-center justify-between border-b border-slate-800/80 bg-black/40 backdrop-blur z-20">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/40 border border-white/10">
        <span class="text-xl">â˜€ï¸</span>
      </div>
      <div>
        <div class="text-xs uppercase tracking-widest text-cyan-300/80 font-semibold">Solar Pathfinder</div>
        <h1 class="text-sm md:text-base font-bold text-white">íƒœì–‘ê´‘ ì…ì§€/ì‚¬ì—…ì„± Pathfinder</h1>
      </div>
    </div>
    <div class="flex items-center gap-3 text-[10px] md:text-xs text-slate-300/80">
      <div class="hidden sm:flex flex-col items-end">
        <div class="flex items-center gap-1">
          <span class="px-1.5 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-400/40 text-[10px]">BETA</span>
          <span>AI ê¸°ë°˜ 8ëŒ€ ì²´í¬ &amp; ìˆ˜ìµì„± ìŠ¤ìºë„ˆ</span>
        </div>
        <div class="text-[10px] text-slate-400">â€» ì‹¤ì œ ì¸í—ˆê°€/ì„¤ê³„/í•œì „ í˜‘ì˜ ê²°ê³¼ì™€ëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>
      <button id="btnSettings" class="ml-3 flex items-center gap-1 px-3 py-1.5 rounded-full bg-slate-800/80 hover:bg-slate-700 text-[10px] border border-slate-600/70 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <span class="hidden sm:inline">ì„¤ì •</span>
      </button>
    </div>
  </header>

  <main class="flex-1 flex flex-col md:flex-row">
    <section class="md:w-1/2 lg:w-[45%] xl:w-[40%] p-4 md:p-6 space-y-4 overflow-y-auto">
      <div class="glass rounded-2xl p-4 md:p-5 border border-slate-700/80">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[10px] uppercase tracking-[0.2em] text-cyan-300/80 font-semibold mb-1">STEP 1</div>
            <div class="text-xs md:text-sm font-bold text-white">ì…ì§€/ì£¼ì†Œ ì„¤ì •</div>
            <div class="text-[10px] text-slate-400 mt-1">ì§€ë„ë¥¼ ì›€ì§ì´ê±°ë‚˜ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ë¶„ì„ ëŒ€ìƒ ìœ„ì¹˜ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.</div>
          </div>
          <div class="flex flex-col items-end gap-1 text-[10px]">
            <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-400/50 text-emerald-200">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
              <span>API ì—°ê²°</span>
            </div>
            <button id="btnLocate" class="px-2 py-1 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-[10px] flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 6v6l4 2"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9z"/>
              </svg>
              <span>í˜„ ìœ„ì¹˜</span>
            </button>
          </div>
        </div>

        <div class="mt-4 space-y-3">
          <div>
            <label for="addressInput" class="text-[11px] text-slate-300">ì£¼ì†Œ ê²€ìƒ‰</label>
            <div class="mt-1 flex gap-2">
              <input id="addressInput" type="text" placeholder="ë„ë¡œëª…/ì§€ë²ˆ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="flex-1 px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700 text-xs focus:outline-none focus:ring-1 focus:ring-cyan-400 focus:border-cyan-400 placeholder-slate-500">
              <button id="btnSearchAddress" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs border border-slate-600 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"/>
                </svg>
                <span>ê²€ìƒ‰</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2 text-[10px]">
            <button id="btnModeRoof" class="mode-btn px-2 py-1.5 rounded-lg bg-slate-900 border border-cyan-500/60 text-cyan-200 flex items-center justify-center gap-1">
              <span>ì§€ë¶•í˜•</span>
            </button>
            <button id="btnModeLand" class="mode-btn px-2 py-1.5 rounded-lg bg-slate-900 border border-slate-600/70 text-slate-300 flex items-center justify-center gap-1">
              <span>í† ì§€í˜•</span>
            </button>
            <button id="btnModeGround" class="mode-btn px-2 py-1.5 rounded-lg bg-slate-900 border border-slate-600/70 text-slate-300 flex items-center justify-center gap-1">
              <span>ë³µí•©</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ... (ì¤‘ê°„ì˜ ì£¼ì†Œ/ì§€ë„/íŒ¨ë„/ì¬ë¬´ ì…ë ¥ UIëŠ” ê¸°ì¡´ê³¼ ë™ì¼, ìƒëµ ì—†ì´ ì‹¤ì œ ì½”ë“œì—ëŠ” ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤) ... -->

      <!-- ë¦¬í¬íŠ¸ ì „ì†¡ìš© íˆë“  í¼ -->
      <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="mode" id="form_mode">
        <input type="hidden" name="lat" id="form_lat">
        <input type="hidden" name="lng" id="form_lng">
        <input type="hidden" name="pnu" id="form_pnu">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="solar_opt" id="form_solar">
        <input type="hidden" name="setback_m" id="form_setback">
        <input type="hidden" name="land_estimate" id="form_land">
        <input type="hidden" name="land_price" id="form_price">
      </form>

    </section>

    <section class="md:flex-1 p-4 md:p-6 space-y-4">
      <div class="glass rounded-2xl p-3 md:p-4 border border-slate-700/80 relative overflow-hidden">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-[10px] uppercase tracking-[0.2em] text-cyan-300/80 font-semibold mb-1">STEP 2</div>
            <div class="text-xs md:text-sm font-bold text-white">ì§€ë„ì—ì„œ ë¶€ì§€/ì§€ë¶• ì„ íƒ</div>
            <div class="text-[10px] text-slate-400 mt-1">D-Pad ë˜ëŠ” ë§ˆìš°ìŠ¤ë¡œ ì´ë™/ì¤Œì„ ì¡°ì ˆí•˜ê³ , ë‹¤ê°í˜•ì„ ê·¸ë ¤ íŒ¨ë„ ë°°ì¹˜ ì˜ì—­ì„ ì§€ì •í•©ë‹ˆë‹¤.</div>
          </div>
          <div class="hidden md:flex flex-col items-end gap-1 text-[10px]">
            <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/80 border border-slate-600/70">
              <span class="w-1 h-1 rounded-full bg-cyan-400 animate-pulse"></span>
              <span>ì§€ë„ ì—”ì§„ ì—°ê²°</span>
            </div>
            <div class="text-[10px] text-slate-500">VWORLD / Kakao / OSM í˜¼í•© ì‚¬ìš©</div>
          </div>
        </div>

        <div class="relative mt-2">
          <div id="map" class="w-full h-[320px] md:h-[420px] rounded-xl overflow-hidden border border-slate-700/80 shadow-lg">
            <div id="kakaoMap" class="kakao-map-layer" style="display:none;"></div>
          </div>

          <!-- ... ì§€ë„ ê´€ë ¨ ë²„íŠ¼/ì¤Œ ì¸ë””ì¼€ì´í„° ë“±ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ ... -->

        </div>
      </div>

      <div class="glass rounded-2xl p-4 md:p-5 border border-slate-700/80 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-[10px] uppercase tracking-[0.2em] text-cyan-300/80 font-semibold mb-1">STEP 3</div>
            <div class="text-xs md:text-sm font-bold text-white">ì •ë°€ ë¶„ì„ &amp; ë¦¬í¬íŠ¸</div>
            <div class="text-[10px] text-slate-400 mt-1">íŒ¨ë„ ìˆ˜Â·ì¼ì‚¬ëŸ‰Â·í† ì§€/ì„ëŒ€ë¹„ ë“±ì„ ê¸°ë°˜ìœ¼ë¡œ í†µí•© ì‚¬ì—…ì„±/ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnAnalyze" class="btn-primary text-xs px-3 py-1.5 rounded-lg flex items-center gap-1 shadow-lg shadow-cyan-500/30">
              <span>AI ë¶„ì„</span>
            </button>
            <button onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-xs font-bold border border-blue-500 transition px-3 py-1.5 rounded-lg">
              ìƒì„¸ ë¦¬í¬íŠ¸
            </button>
          </div>
        </div>

        <div class="mt-3 space-y-3">
          <div id="tab-buttons" class="flex gap-1 text-[10px] border-b border-slate-700 pb-1">
            <button data-tab="panel-scan" class="px-2 py-1 rounded-t-md bg-slate-800 text-cyan-300 border border-slate-700 border-b-0 text-[10px]">ì „ìˆ˜ ìŠ¤ìº”</button>
            <button data-tab="panel-finance" class="px-2 py-1 rounded-t-md bg-slate-900 text-slate-300 border border-transparent text-[10px]">ì •ë°€ ë¶„ì„</button>
            <button data-tab="panel-report" class="px-2 py-1 rounded-t-md bg-slate-900 text-slate-300 border border-transparent text-[10px]">ì¢…í•© ë¦¬í¬íŠ¸</button>
            <button data-tab="panel-history" class="px-2 py-1 rounded-t-md bg-slate-900 text-slate-300 border border-transparent text-[10px]">ê¸°ë¡</button>
          </div>

          <div class="mt-2">
            <div id="panel-scan" class="space-y-3">
              <!-- ... ê¸°ì¡´ ì „ìˆ˜ ìŠ¤ìº” íŒ¨ë„ ë‚´ìš© ... -->
            </div>

            <div id="panel-finance" class="hidden space-y-4">
              <!-- ... PF/ì •ë°€ ë¶„ì„ ì¹´ë“œë“¤ ... -->

              <!-- í†µí•© ë¶„ì„ ê²°ê³¼ ì¹´ë“œ -->
              <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                <div class="space-y-2 text-xs">
                  <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right truncate w-40">-</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰(AC/DC):</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                  <div class="flex justify-between"><span class="text-slate-400">ì´ê²©ê±°ë¦¬:</span><span id="analysisSetback" class="text-right">-</span></div>
                  <!-- [F-25] í•œì „ìš©ëŸ‰ í™•ì¸í•„ìš” í‘œì‹œ -->
                  <div class="flex justify-between items-center border-t border-slate-700 pt-2">
                    <span class="text-slate-400">ê³„í†µì—°ê³„(í•œì „ ì—¬ìœ ìš©ëŸ‰)</span>
                    <span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">í™•ì¸ í•„ìš”</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">ì¡°ë¡€/í–‰ìœ„ì œí•œ(ìš”ì•½)</span>
                    <span id="ordinanceSummary" class="font-bold text-yellow-300 font-mono">í™•ì¸ í•„ìš”</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">AI ì¢…í•©ì˜ê²¬</span>
                    <span id="aiSummaryBrief" class="font-bold text-amber-300 font-mono">í™•ì¸ í•„ìš”</span>
                  </div>
                </div>
              </div>

              <!-- ... DSCR, í˜„ê¸ˆíë¦„ í…Œì´ë¸” ë“±ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ ... -->
            </div>

            <div id="panel-report" class="hidden space-y-4">
              <!-- ... ì¢…í•© ë¦¬í¬íŠ¸ íƒ­ ë‚´ìš© (8ëŒ€ ì²´í¬, AI ì´í‰, ë‹¤ì‹œ ë¶„ì„ ë²„íŠ¼ ë“±) ... -->
            </div>

            <div id="panel-history" class="hidden space-y-2">
              <!-- ... ë¶„ì„ ê¸°ë¡ íƒ­ ... -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- í† ìŠ¤íŠ¸ / ëª¨ë‹¬ / ê¸°íƒ€ UI ìš”ì†Œë“¤ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€) -->

  <script>
    const el = (id) => document.getElementById(id);

    let currentAnalysisData = {};
    window.currentAnalysisData = currentAnalysisData;
    let selectedFeatures = new Map();
    let currentAnalysisFeature = null;
    let map = null;
    let panelGroup = null;
    let analysisMarkerGroup = null;
    let selectableGroup = null;
    let scanTarget = "roof";
    let BACKEND_URL = window.BACKEND_URL || "";
    let KAKAO_JS_KEY = null;
    let VWORLD_TILE_KEY = null;

    function showToast(msg) {
      try {
        const box = el("toastBox");
        if (!box) return;
        const div = document.createElement("div");
        div.className = "toast px-3 py-2 rounded-lg bg-slate-900/95 border border-slate-600/80 text-[11px] text-slate-100 flex items-center gap-2 shadow-lg";
        div.innerHTML = `<span>${msg}</span>`;
        box.appendChild(div);
        setTimeout(() => {
          div.classList.add("opacity-0", "translate-y-[-4px]");
          setTimeout(() => div.remove(), 200);
        }, 3000);
      } catch (e) {
        console.log(msg);
      }
    }

    function clearAnalysisOnly() {
      try { if (panelGroup) panelGroup.clearLayers(); } catch (e) {}
      try { if (analysisMarkerGroup) analysisMarkerGroup.clearLayers(); } catch (e) {}
      try { if (selectedFeatures && selectedFeatures.clear) selectedFeatures.clear(); } catch (e) {}
      try { currentAnalysisFeature = null; } catch (e) {}
      try { currentAnalysisData = {}; window.currentAnalysisData = currentAnalysisData; } catch (e) {}
      try { resetCalibrationInternal(false); } catch (e) {}
      try { if (el("analysisAddress")) el("analysisAddress").innerText = "-"; } catch (e) {}
      try { if (el("analysisCount")) el("analysisCount").innerText = "0 ì¥"; } catch (e) {}
      try { if (el("analysisCapacity")) el("analysisCapacity").innerText = "0 kW"; } catch (e) {}
      try { if (el("analysisSetback")) el("analysisSetback").innerText = "-"; } catch (e) {}
      try { if (el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”"; } catch (e) {}
      try { if (el("ordinanceSummary")) el("ordinanceSummary").innerText = "í™•ì¸ í•„ìš”"; } catch (e) {}
      try { if (el("aiSummaryBrief")) el("aiSummaryBrief").innerText = "í™•ì¸ í•„ìš”"; } catch (e) {}
    }

    function clearResults(clearToasts) {
      try { selectableGroup.clearLayers(); } catch (e) {}
      try { panelGroup.clearLayers(); } catch (e) {}
      try { analysisMarkerGroup.clearLayers(); } catch (e) {}
      try { selectedFeatures.clear(); } catch (e) {}
      currentAnalysisFeature = null;
      currentAnalysisData = {};
      window.currentAnalysisData = currentAnalysisData;
      resetCalibrationInternal(false);
      try {
        if (clearToasts) {
          const box = el("toastBox");
          if (box) box.innerHTML = "";
        }
      } catch (e) {}
    }

    // ... (ì§€ë„ ì´ˆê¸°í™”, ìŠ¤ìº”/íŒ¨ë„ ê³„ì‚°, PF ê³„ì‚° ë“± ê¸°ì¡´ JS ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...

    function updateResultCard(addr, panelCount) {
      const rc = el("resultCard");
      if (rc) rc.classList.remove("hidden");

      if (el("analysisAddress")) el("analysisAddress").innerText = (addr || "").trim() || "-";
      if (el("analysisCount")) el("analysisCount").innerText = `${panelCount} ì¥`;

      const modPower = parseFloat(el("modPower")?.value || "640") || 640;
      const dcKw = (panelCount * modPower) / 1000;
      const acKw = dcKw / 1.15;
      if (el("analysisCapacity")) el("analysisCapacity").innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;
      // setback (ì´ê²©ê±°ë¦¬)
      if (el("analysisSetback")) {
        const sbEl = el("setbackDist");
        let sbVal = 0;
        if (sbEl) {
          sbVal = parseFloat(sbEl.value || "0") || 0;
        }
        el("analysisSetback").innerText = sbVal ? `${sbVal} m` : "-";
      }

      try {
        if (typeof window.updateKepcoCapacity === "function") {
          window.updateKepcoCapacity(addr, currentAnalysisData?.pnu);
        }
      } catch (e) {
        if (el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”";
      }
    }

    window.openFullReport = function () {
      try { ensureFinanceComputed(); } catch (e) {}
      const form = el("reportForm");
      if (!form) {
        showToast("reportForm not found");
        return;
      }
      if (!BACKEND_URL) {
        showToast("backend ë¯¸ì„¤ì •");
        return;
      }
      if (el("form_address")) el("form_address").value = (currentAnalysisData.address || "").trim();
      if (el("form_capacity")) el("form_capacity").value = (el("analysisCapacity")?.innerText || "").trim();
      if (el("form_kepco")) el("form_kepco").value = (el("kepcoCapacity")?.innerText || "í™•ì¸ í•„ìš”").trim();
      if (el("form_date")) el("form_date").value = new Date().toLocaleString();
      if (el("form_mode")) el("form_mode").value = (scanTarget === "land") ? "land" : "roof";
      if (el("form_lat")) el("form_lat").value = String(currentAnalysisData?.lat ?? currentAnalysisData?.center?.lat ?? "");
      if (el("form_lng")) el("form_lng").value = String(currentAnalysisData?.lng ?? currentAnalysisData?.center?.lng ?? "");
      if (el("form_pnu")) el("form_pnu").value = String(currentAnalysisData?.pnu ?? "");
      if (el("form_setback")) {
        const sbEl = el("setbackDist");
        let sbVal = 0;
        if (sbEl) {
          sbVal = parseFloat(sbEl.value || "0") || 0;
        }
        el("form_setback").value = String(sbVal);
      }
      if (el("form_finance")) el("form_finance").value = JSON.stringify(currentAnalysisData.finance || {});
      if (el("form_ai")) el("form_ai").value = JSON.stringify(currentAnalysisData.ai_analysis || {});
      if (el("form_solar")) el("form_solar").value = JSON.stringify(currentAnalysisData.solar_opt || {});
      if (el("form_land")) el("form_land").value = JSON.stringify(currentAnalysisData.land_estimate || {});
      if (el("form_score")) el("form_score").value = JSON.stringify(currentAnalysisData.ai_analysis?.attractiveness_score || 0);
      if (el("form_price")) el("form_price").value = "";

      form.action = `${BACKEND_URL}/report`;
      form.submit();
    };

    window.retryAIAnalysis = async function () {
      try {
        if (!BACKEND_URL) {
          showToast("BACKEND_URLì´ ì—†ì–´ AI ì¬ê²€í† ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }
        const addr = (window.currentAnalysisData && window.currentAnalysisData.address)
          ? window.currentAnalysisData.address
          : (el("addressInput")?.value || "");
        let _hasCoordForRetry = false;
        try {
          if (typeof getAnalysisLatLng === "function") {
            const _tmp = getAnalysisLatLng() || {};
            if (_tmp.lat != null && _tmp.lng != null) { _hasCoordForRetry = true; }
          }
        } catch (e) { }
        if (!addr && !_hasCoordForRetry) {
          showToast("ì£¼ì†Œê°€ ì—†ì–´ AI ì¬ê²€í† ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        try { window.calculateFinance(getTotalPanelCount()); } catch (e) { }

        const btn = el("btnAiRetry");
        if (btn) {
          btn.disabled = true;
          btn.innerText = "AI ì¬ë¶„ì„ ì¤‘...";
        }
        try {
          const ll = getAnalysisLatLng();
          const payload = {
            address: addr,
            mode: (scanTarget === "land") ? "land" : "roof",
            lat: ll.lat,
            lng: ll.lng,
            pnu: currentAnalysisData.pnu || null,
            panel_count: getTotalPanelCount(),
            sun_hours: currentAnalysisData.sun_hours || null,
            ori_factor: currentAnalysisData.ori_factor || null,
            setback_m: parseFloat(el("setbackDist")?.value || "0") || 0,
          };
          let r = await postJson(`${BACKEND_URL}/api/ai/review`, payload);
          if (!r.ok) {
            r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
          }
          if (!r.ok) throw new Error(`AI HTTP ${r.status}`);
          window.currentAnalysisData.ai_analysis = r.data;
          try {
            renderAIResult(r.data);
            renderAiFinal(r.data);
          } catch (e) { }
        } catch (e) {
          console.error(e);
          showToast("AI ì¬ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerText = "AI ì¬ë¶„ì„";
          }
        }
      } catch (e) {
        console.error(e);
        showToast("AI ì¬ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      }
    };

    // ... ì´ ì™¸ì˜ ë‚˜ë¨¸ì§€ JS (ì§€ë„ ì´ˆê¸°í™”, fetch, 8ëŒ€ ì²´í¬, ì¹´ì¹´ì˜¤ ë§µ ë¡œë”© ë“±)ë„ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤ ...
  </script>
</div>
</body>
</html>
