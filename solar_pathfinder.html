<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: radial-gradient(circle at top, #0f172a, #020617 55%);
            color: #e5e7eb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* ìƒë‹¨ í—¤ë” ì˜ì—­ */
        header {
            flex: 0 0 auto;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(30,64,175,0.85));
            border-bottom: 1px solid rgba(148,163,184,0.3);
            box-shadow: 0 12px 30px rgba(15,23,42,0.6);
            z-index: 100;
        }

        header .title-block {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header .title-block .logo {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: conic-gradient(from 220deg, #f97316, #facc15, #22c55e, #0ea5e9, #f97316);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(15,23,42,0.9);
        }

        header .title-block .logo-inner {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #facc15, #f97316 40%, #b91c1c 80%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0f172a;
            font-size: 18px;
            font-weight: 900;
            text-shadow: 0 0 8px rgba(250,250,250,0.8);
        }

        header h1 {
            margin: 0;
            font-size: 17px;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: #e5edff;
            text-shadow: 0 8px 20px rgba(15,23,42,0.6);
        }

        header .subtitle {
            font-size: 11px;
            color: #cbd5f5;
            opacity: 0.92;
        }

        header .right-block {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ: ì§€ë„ + ìš°ì¸¡ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .app-shell {
            flex: 1 1 auto;
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(360px, 420px);
            max-height: calc(100vh - 58px);
        }

        #map {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1e293b, #020617);
            position: relative;
        }

        #map .leaflet-control-attribution {
            font-size: 9px;
        }

        /* ìš°ì¸¡ íŒ¨ë„ */
        .sidebar {
            position: relative;
            z-index: 10;
            background: radial-gradient(circle at top left, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
            border-left: 1px solid rgba(30,64,175,0.7);
            box-shadow: -18px 0 40px rgba(15,23,42,0.9);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .sidebar-inner {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            padding: 10px 12px 6px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(51,65,85,0.9);
            background: linear-gradient(to bottom, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
        }

        .sidebar-header-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-header-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #e5edff;
        }

        .sidebar-header-title span.icon {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #38bdf8, #6366f1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 5px rgba(96,165,250,0.8);
        }

        .sidebar-header-title span.icon i {
            font-size: 11px;
            color: #0b1120;
        }

        .sidebar-header-sub {
            font-size: 10px;
            color: #9ca3af;
        }

        .sidebar-header-buttons {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sidebar-header-buttons button {
            font-size: 10px;
            padding: 4px 6px;
        }

        .sidebar-body {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 8px 10px 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(148,163,184,0.8) transparent;
        }

        .sidebar-body::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-body::-webkit-scrollbar-thumb {
            background-color: rgba(148,163,184,0.7);
            border-radius: 999px;
        }

        .sidebar-body::-webkit-scrollbar-track {
            background-color: transparent;
        }

        .sidebar-tabs {
            display: flex;
            align-items: center;
            gap: 4px;
            border-bottom: 1px solid rgba(51,65,85,0.9);
            margin-bottom: 8px;
        }

        .tab-btn {
            flex: 1 1 0;
            padding: 6px 8px;
            font-size: 11px;
            font-weight: 500;
            color: #9ca3af;
            border-radius: 0.5rem 0.5rem 0 0;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.18s ease;
        }

        .tab-btn i {
            font-size: 13px;
        }

        .tab-btn.active {
            color: #e5edff;
            border-bottom-color: #38bdf8;
            background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(17,24,39,0.98));
        }

        .tab-btn:hover:not(.active) {
            background: rgba(15,23,42,0.8);
        }

        .tab-badge {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
        }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            background: linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
            border-radius: 0.75rem;
            padding: 10px 10px 10px;
            border: 1px solid rgba(30,64,175,0.6);
            box-shadow: 0 8px 28px rgba(15,23,42,0.9);
            margin-bottom: 8px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            color: #e5edff;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-title i {
            font-size: 12px;
        }

        .card-subtitle {
            font-size: 10px;
            color: #9ca3af;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            border: 1px solid rgba(148,163,184,0.7);
            color: #cbd5f5;
        }

        .pill i {
            font-size: 12px;
        }

        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }

        .input-row label {
            font-size: 10px;
            color: #9ca3af;
            min-width: 68px;
        }

        .input-row input[type="text"],
        .input-row input[type="number"],
        .input-row select {
            flex: 1;
            background: rgba(15,23,42,0.95);
            border-radius: 0.5rem;
            padding: 4px 6px;
            border: 1px solid rgba(51,65,85,1);
            color: #e5e7eb;
            font-size: 11px;
        }

        .input-row input:focus,
        .input-row select:focus {
            outline: none;
            border-color: rgba(59,130,246,0.9);
            box-shadow: 0 0 0 1px rgba(37,99,235,0.6);
        }

        .input-row small {
            font-size: 9px;
            color: #6b7280;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border-radius: 999px;
            font-size: 11px;
            padding: 4px 8px;
            border-width: 1px;
            border-style: solid;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-outline {
            background: transparent;
            border-color: rgba(148,163,184,0.7);
            color: #e5e7eb;
        }

        .btn-outline:hover {
            background: rgba(30,64,175,0.25);
            border-color: rgba(96,165,250,0.9);
            box-shadow: 0 0 0 1px rgba(96,165,250,0.7);
        }

        .btn-primary {
            background: linear-gradient(to right, #38bdf8, #6366f1);
            border-color: transparent;
            color: #0b1120;
            font-weight: 600;
        }

        .btn-primary:hover {
            box-shadow: 0 0 0 1px rgba(129,140,248,0.9), 0 0 20px rgba(56,189,248,0.8);
            transform: translateY(-0.5px);
        }

        .badge {
            display: inline-flex;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            border: 1px solid rgba(148,163,184,0.7);
            color: #cbd5f5;
        }

        .badge.badge-green {
            border-color: rgba(34,197,94,0.8);
            color: #bbf7d0;
        }

        .badge.badge-amber {
            border-color: rgba(245,158,11,0.8);
            color: #fed7aa;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
        }

        /* ì§€ë„ ì˜¤ë¥¸ìª½ ì•„ë˜ í€µ ì•¡ì…˜ */
        .map-quick-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 800;
        }

        .map-quick-actions button {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
            background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.95));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 14px;
            box-shadow: 0 10px 22px rgba(15,23,42,0.9);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .map-quick-actions button:hover {
            transform: translateY(-1px) scale(1.03);
            box-shadow: 0 14px 32px rgba(15,23,42,0.95);
            border-color: rgba(96,165,250,0.95);
            color: #bfdbfe;
        }

        /* ì§€ë„ ì¢Œìƒë‹¨ íˆ´ë°” */
        .map-toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 800;
        }

        .map-toolbar-row {
            display: inline-flex;
            gap: 6px;
        }

        .map-toolbar button {
            border-radius: 999px;
            padding: 4px 9px;
            border-width: 1px;
            border-style: solid;
            border-color: rgba(148,163,184,0.7);
            background: radial-gradient(circle at top, rgba(15,23,42,0.97), rgba(15,23,42,0.94));
            color: #e5e7eb;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 8px 22px rgba(15,23,42,0.95);
            transition: all 0.15s ease;
        }

        .map-toolbar button i {
            font-size: 12px;
        }

        .map-toolbar button:hover {
            border-color: rgba(96,165,250,0.9);
            box-shadow: 0 0 0 1px rgba(96,165,250,0.8), 0 12px 24px rgba(15,23,42,0.9);
            transform: translateY(-0.5px);
        }

        .map-toolbar button.active {
            background: linear-gradient(to right, #38bdf8, #6366f1);
            color: #0b1120;
            border-color: transparent;
        }

        .map-fade-bottom {
            position: absolute;
            pointer-events: none;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, transparent, rgba(15,23,42,0.85));
            z-index: 10;
        }

        /* ì§€ë„ ì˜¤ë¥¸ìª½ ìƒë‹¨ ì¤Œ ë ˆì´ë¸” */
        #zoomLabel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 800;
            background: rgba(15,23,42,0.95);
            border-radius: 999px;
            font-size: 10px;
            padding: 3px 8px;
            border: 1px solid rgba(148,163,184,0.7);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 10px 24px rgba(15,23,42,0.9);
        }

        #zoomLabel span.key {
            padding: 0 6px;
            border-radius: 999px;
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(31,41,55,1);
            font-size: 9px;
        }

        /* íŒ¨ë„ ë“œë˜ê·¸ í•¸ë“¤ */
        .drag-handle {
            position: absolute;
            top: 50%;
            left: -10px;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            border-radius: 999px;
            background: radial-gradient(circle at left, rgba(148,163,184,0.5), rgba(15,23,42,0.98));
            border: 1px solid rgba(148,163,184,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: ew-resize;
            box-shadow: -6px 0 18px rgba(15,23,42,0.9);
        }

        .drag-handle::before {
            content: "";
            width: 3px;
            height: 22px;
            border-radius: 999px;
            background: linear-gradient(to bottom, rgba(148,163,184,0.8), rgba(148,163,184,0.3));
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        #toast {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(15,23,42,0.96);
            color: #e5e7eb;
            font-size: 11px;
            border: 1px solid rgba(56,189,248,0.8);
            box-shadow: 0 12px 28px rgba(15,23,42,0.95);
            display: none;
            z-index: 2000;
        }

        /* ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .modal-panel {
            background: radial-gradient(circle at top left, #020617, #020617 40%, #0b1120 80%);
            border-radius: 1rem;
            border: 1px solid rgba(56,189,248,0.35);
            max-width: 540px;
            width: min(540px, 100% - 24px);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 22px 60px rgba(15,23,42,0.95);
            overflow: hidden;
        }

        .modal-header {
            padding: 10px 12px 8px;
            border-bottom: 1px solid rgba(30,64,175,0.8);
            background: linear-gradient(to bottom, rgba(15,23,42,1), rgba(15,23,42,0.95));
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .modal-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .modal-title-main {
            font-size: 13px;
            font-weight: 700;
            color: #e5edff;
        }

        .modal-title-sub {
            font-size: 10px;
            color: #9ca3af;
        }

        .modal-body {
            padding: 10px 12px;
            overflow-y: auto;
            max-height: calc(85vh - 90px);
        }

        .modal-footer {
            padding: 8px 12px 10px;
            border-top: 1px solid rgba(30,64,175,0.7);
            background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.99));
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }

        .modal-footer-left {
            font-size: 10px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .modal-footer-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pill-key {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
            color: #cbd5f5;
        }

        .pill-key span.key {
            padding: 0 4px;
            border-radius: 4px;
            background: rgba(15,23,42,0.9);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 9px;
        }

        /* ì‹œìŠ¤í…œ ìƒíƒœ í•˜ë‹¨ íŒ¨ë„ */
        #systemStatusBar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1200;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        #systemStatusInner {
            pointer-events: auto;
            margin-bottom: 8px;
            max-width: 980px;
            width: calc(100% - 16px);
            border-radius: 999px;
            border: 1px solid rgba(30,64,175,0.8);
            background: radial-gradient(circle at top, rgba(15,23,42,0.97), rgba(15,23,42,0.96));
            box-shadow: 0 12px 32px rgba(15,23,42,0.95);
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: #e5e7eb;
        }

        #systemStatusInner .left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #systemStatusInner .right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 9px;
            height: 9px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #22c55e, #15803d);
            box-shadow: 0 0 8px rgba(34,197,94,0.9);
        }

        .status-tag {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
            color: #cbd5f5;
        }

        .status-link {
            font-size: 10px;
            color: #93c5fd;
            text-decoration: underline;
            cursor: pointer;
        }

        .status-link:hover {
            color: #bfdbfe;
        }

        /* ë°˜ì‘í˜•: ì‘ì€ í™”ë©´ì—ì„œ ìš°ì¸¡ íŒ¨ë„ ì ‘ê¸° */
        @media (max-width: 960px) {
          .app-shell {
            grid-template-columns: minmax(0, 1fr);
          }
          .sidebar {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: min(420px, 85%);
            max-width: 420px;
            transform: translateX(0);
          }
        }

        @media (max-width: 640px) {
          header {
            padding: 8px 10px;
          }
          header h1 {
            font-size: 15px;
          }
          .sidebar {
            width: 100%;
            max-width: none;
          }
          .sidebar-header {
            padding: 8px 10px 6px;
          }
        }

        /* [F-2] íŒ¨ë„ ê·¸ë¦¬ê¸° ì¤‘ ì•ˆë‚´ íˆ´íŒ */
        #drawTooltip {
          position: absolute;
          pointer-events: none;
          background: rgba(15,23,42,0.95);
          color: #e5e7eb;
          font-size: 10px;
          padding: 4px 8px;
          border-radius: 999px;
          border: 1px solid rgba(96,165,250,0.8);
          box-shadow: 0 12px 30px rgba(15,23,42,0.95);
          z-index: 900;
          display: none;
          white-space: nowrap;
        }

        /* [F-27/28] í† ì§€ ë‹¨ê°€ ì¹´ë“œ */
        #landPriceCard {
          background: radial-gradient(circle at top left, rgba(8,47,73,0.95), rgba(15,23,42,0.98));
          border-radius: 0.75rem;
          padding: 8px 9px;
          border: 1px solid rgba(56,189,248,0.7);
          box-shadow: 0 10px 26px rgba(15,23,42,0.95);
          margin-bottom: 8px;
          font-size: 10px;
        }

        #landPriceValue {
          font-size: 13px;
          font-weight: 700;
          color: #bfdbfe;
        }

        #landPriceSub {
          font-size: 9px;
          color: #9ca3af;
        }

        /* í™•ëŒ€ ì‹œ ë§ˆì»¤ ë‚œì¡° ë°©ì§€: í° ì¶•ì²™ì—ì„œë§Œ ë¼ë²¨ ë…¸ì¶œ */
        .zoom-label-hidden {
          display: none !important;
        }

        /* ì¢Œì¸¡ ìƒë‹¨ GIS ì†ŒìŠ¤ í† ê¸€ */
        #basemapToggle {
          font-size: 10px;
        }

        .basemap-option {
          padding: 2px 6px;
          border-radius: 999px;
          border: 1px solid transparent;
          cursor: pointer;
        }

        .basemap-option.active {
          border-color: rgba(56,189,248,0.9);
          background: rgba(15,23,42,0.95);
        }

        .basemap-option:not(.active):hover {
          border-color: rgba(148,163,184,0.9);
        }

        /* [F-11] íŒ¨ë„ êµ¬íš ê°ê° ì¹´ë“œë¡œ êµ¬ë¶„ */
        .section-label {
          font-size: 10px;
          font-weight: 600;
          color: #94a3b8;
          text-transform: uppercase;
          letter-spacing: 0.08em;
          margin-bottom: 4px;
        }

        /* ì‹œìŠ¤í…œ ë¡œê·¸ ì½˜ì†” */
        #systemLog {
          max-height: 60px;
          overflow-y: auto;
          font-size: 9px;
          color: #9ca3af;
          border-radius: 0.5rem;
          background: rgba(15,23,42,0.9);
          border: 1px solid rgba(51,65,85,1);
          padding: 4px 6px;
        }

        #systemLog::-webkit-scrollbar {
          width: 4px;
        }

        #systemLog::-webkit-scrollbar-thumb {
          background-color: rgba(148,163,184,0.8);
          border-radius: 999px;
        }

        /* [F-4] ì£¼ì†Œê²€ìƒ‰ AutoComplete ê°„ê²© */
        #addressSuggestions {
          max-height: 140px;
          overflow-y: auto;
          font-size: 11px;
        }

        #addressSuggestions .item {
          padding: 4px 8px;
          cursor: pointer;
        }

        #addressSuggestions .item:hover {
          background: rgba(30,64,175,0.5);
        }

        /* ì„¤ì • ëª¨ë‹¬ ë‚´ìš© ìŠ¤í¬ë¡¤ ì˜ì—­ */
        #setupModalBody {
          max-height: calc(85vh - 90px);
          overflow-y: auto;
        }

        /* ì‘ì€ í™”ë©´ì—ì„œ ëª¨ë‹¬ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ëŠ” ê²ƒ ë°©ì§€ */
        @media (max-height: 720px) {
          .modal-panel {
            max-height: 85vh;
          }
        }

        /* íŒ¨ë„ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ */
        .preview-card {
          background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.99));
          border-radius: 0.75rem;
          border: 1px solid rgba(30,64,175,0.7);
          padding: 8px 9px;
          font-size: 10px;
        }

        .preview-card .row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 3px;
        }

        .preview-card .label {
          color: #9ca3af;
        }

        .preview-card .value {
          color: #e5e7eb;
        }

        /* VWorld ë¡œê³  ë¸”ë Œë”© */
        .leaflet-control-attribution {
          mix-blend-mode: screen;
        }

        .shadow-soft {
          box-shadow: 0 18px 40px rgba(15,23,42,0.9);
        }
        .glow-box {
          box-shadow: 0 24px 80px rgba(56,189,248,0.45);
        }
        .glass-card {
          background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
          border-radius: 0.75rem;
          border: 1px solid rgba(30,64,175,0.7);
          box-shadow: 0 14px 40px rgba(15,23,42,0.95);
        }

        .crystal-dpad {
          position: relative;
          width: 110px;
          height: 110px;
          background:
            radial-gradient(circle at 20% 0%, rgba(248,250,252,0.2), transparent 40%),
            radial-gradient(circle at 80% 100%, rgba(96,165,250,0.25), transparent 50%),
            conic-gradient(from 225deg, rgba(15,23,42,1), rgba(30,64,175,1), rgba(30,64,175,0.4), rgba(15,23,42,1));
          border-radius: 1.75rem;
          border: 1px solid rgba(148,163,184,0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 18px 40px rgba(15,23,42,0.9);
        }
        .crystal-dpad::before {
          content: "";
          position: absolute;
          inset: 0;
          border-radius: inherit;
          background: radial-gradient(circle at top left, rgba(255,255,255,0.14), transparent 55%);
          opacity: 0.9;
          pointer-events: none;
          mix-blend-mode: screen;
        }

        /* 8ëŒ€ ì²´í¬ì‚¬í•­ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        #aiChecksContainer {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }
        .checkRow {
          display: flex;
          flex-direction: column;
          padding: 6px 8px;
          border-radius: 0.5rem;
          border: 1px solid rgba(30,64,175,0.7);
          background-color: rgba(15,23,42,0.85);
          font-size: 11px;
        }
        .checkRow.pass {
          border-color: rgba(34,197,94,0.9);
          background-color: rgba(22,163,74,0.16);
        }
        .checkRow.fail {
          border-color: rgba(239,68,68,0.9);
          background-color: rgba(185,28,28,0.18);
        }
        .checkRow.warn {
          border-color: rgba(249,115,22,0.9);
          background-color: rgba(194,65,12,0.16);
        }
        .checkRow .checkTitle {
          font-weight: 600;
          color: #e5e7eb;
          margin-bottom: 2px;
        }
        .checkRow .checkValue {
          font-weight: 500;
          color: #facc15;
          margin-bottom: 1px;
        }
        .checkRow .checkMsg {
          font-size: 10px;
          color: #9ca3af;
        }

    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <header>
        <div class="title-block">
            <div class="logo">
                <div class="logo-inner">
                    â˜€ï¸
                </div>
            </div>
            <div>
                <h1>SCEnergy íƒœì–‘ê´‘ Pathfinder</h1>
                <div class="subtitle">
                    V-World ì§€ë„ ê¸°ë°˜ ì§€ë¶•/í† ì§€ íƒœì–‘ê´‘ ìˆ˜ìµì„± Â· ì¸í—ˆê°€ ë¦¬ìŠ¤í¬ í†µí•© ë¶„ì„ ë„êµ¬
                </div>
            </div>
        </div>
        <div class="right-block">
            <div class="hidden md:flex items-center gap-2 pr-2">
                <span class="text-[11px] text-slate-300 flex items-center gap-1">
                    <span class="inline-flex w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                    <span id="licenseStatusLabel">ë¼ì´ì„ ìŠ¤ í™•ì¸ ì¤‘...</span>
                </span>
                <span class="text-[10px] text-slate-400" id="licenseDeviceLabel"></span>
            </div>
            <button type="button"
                    onclick="openSetupModal()"
                    class="hidden md:inline-flex items-center gap-1 rounded-full border border-sky-400/70 bg-slate-900/50 px-3 py-1 text-[11px] text-sky-100 hover:bg-slate-800 hover:border-sky-300 shadow-soft">
                <i class="ph ph-sliders-horizontal text-[13px]"></i>
                <span>âš™ï¸ íƒœì–‘ê´‘ íŒ¨ë„ ì¡°ì •</span>
            </button>
            <button type="button"
                    onclick="openSetupModal()"
                    class="md:hidden inline-flex items-center gap-1 rounded-full border border-sky-400/70 bg-slate-900/50 px-2.5 py-1 text-[11px] text-sky-100 hover:bg-slate-800 hover:border-sky-300 shadow-soft">
                <i class="ph ph-sliders-horizontal text-[14px]"></i>
                <span>Panel</span>
            </button>
        </div>
    </header>

    <main class="app-shell">
        <!-- ì§€ë„ ì˜ì—­ -->
        <section class="relative">
            <div id="map"></div>
            <div id="zoomLabel">
                <span class="key">Zoom</span>
                <span id="zoomLevelText">-</span>
            </div>

            <!-- ì¢Œì¸¡ ìƒë‹¨ íˆ´ë°” -->
            <div class="map-toolbar">
                <div class="map-toolbar-row">
                    <button type="button" onclick="setScanMode('roof')" id="btnModeRoof">
                        <i class="ph ph-building"></i>
                        <span>ì§€ë¶• ëª¨ë“œ</span>
                    </button>
                    <button type="button" onclick="setScanMode('land')" id="btnModeLand">
                        <i class="ph ph-mountains"></i>
                        <span>í† ì§€ ëª¨ë“œ</span>
                    </button>
                </div>
                <div class="map-toolbar-row mt-1">
                    <button type="button" onclick="startDrawPanel()">
                        <i class="ph ph-vector-square"></i>
                        <span>íŒ¨ë„ ì§ì ‘ ê·¸ë¦¬ê¸°</span>
                    </button>
                    <button type="button" onclick="resetAllPanels()">
                        <i class="ph ph-eraser"></i>
                        <span>ë¦¬ì…‹</span>
                    </button>
                </div>
                <div class="map-toolbar-row mt-1 items-center gap-1">
                    <div id="basemapToggle" class="flex items-center gap-1 rounded-full border border-slate-600/80 bg-slate-900/90 px-2 py-1 shadow-soft">
                        <span class="text-[10px] text-slate-400 mr-1">ì§€ë„</span>
                        <button type="button" class="basemap-option active" data-map="vworld">V-World</button>
                        <button type="button" class="basemap-option" data-map="osm">OSM</button>
                        <button type="button" class="basemap-option" data-map="google">ìœ„ì„±</button>
                    </div>
                </div>
            </div>

            <!-- ì§€ë„ ìš°ì¸¡ í•˜ë‹¨ í€µ ì•¡ì…˜ -->
            <div class="map-quick-actions">
                <button type="button" onclick="locateUser()">
                    <i class="ph ph-navigation-arrow"></i>
                </button>
                <button type="button" onclick="scanCurrentView()">
                    <i class="ph ph-radar"></i>
                </button>
                <button type="button" onclick="toggleSidebar()" id="sidebarToggleMini">
                    <i class="ph ph-sidebar-simple"></i>
                </button>
            </div>

            <div id="drawTooltip"></div>
            <div class="map-fade-bottom"></div>
        </section>

        <!-- ìš°ì¸¡ íŒ¨ë„ -->
        <aside class="sidebar" id="sidebar">
            <div class="drag-handle" id="sidebarDragHandle"></div>
            <div class="sidebar-inner">
                <div class="sidebar-header">
                    <div class="sidebar-header-left">
                        <div class="sidebar-header-title">
                            <span class="icon">
                                <i class="ph ph-sun-dim"></i>
                            </span>
                            <span>í”„ë¡œì íŠ¸ ìš”ì•½</span>
                        </div>
                        <div class="sidebar-header-sub">
                            ì£¼ì†Œ ê¸°ë°˜ ì„¤ì¹˜ ê°€ëŠ¥ ìš©ëŸ‰ Â· ìˆ˜ìµì„± Â· ì¸í—ˆê°€ ë¦¬ìŠ¤í¬ í•œë²ˆì— ë³´ê¸°
                        </div>
                    </div>
                    <div class="sidebar-header-buttons">
                        <button type="button"
                                onclick="window.openFullReport()"
                                class="btn btn-outline text-[10px] px-2">
                            <i class="ph ph-file-text"></i>
                            <span>PDF ë¦¬í¬íŠ¸</span>
                        </button>
                    </div>
                </div>

                <div class="sidebar-body">
                    <!-- íƒ­ -->
                    <div class="sidebar-tabs">
                        <button type="button" class="tab-btn active" data-tab="design">
                            <i class="ph ph-seal-percent"></i>
                            <span>1. ê¸°ë³¸ ì„¤ê³„</span>
                        </button>
                        <button type="button" class="tab-btn" data-tab="analysis">
                            <i class="ph ph-chart-pie-slice"></i>
                            <span>2. ê²½ì œì„±Â·ë¦¬ìŠ¤í¬</span>
                            <span class="tab-badge text-emerald-200 border-emerald-400/80">AI</span>
                        </button>
                    </div>

                    <!-- 1) ê¸°ë³¸ ì„¤ê³„ íƒ­ -->
                    <div id="tab-design" class="space-y-3">
                        <!-- [F-3] ì£¼ì†Œ ì…ë ¥ / ê²€ìƒ‰ -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="ph ph-magnifying-glass"></i>
                                        <span>ìœ„ì¹˜ ê²€ìƒ‰</span>
                                    </div>
                                    <div class="card-subtitle">
                                        ì£¼ì†Œ/ê±´ë¬¼ëª… ì…ë ¥ í›„ Enter ë˜ëŠ” ğŸ” ê²€ìƒ‰
                                    </div>
                                </div>
                                <span class="badge">
                                    <span class="badge-dot"></span>
                                    <span>êµ­í† ë¶€ ë„ë¡œëª…/ì§€ë²ˆ DB</span>
                                </span>
                            </div>
                            <div class="space-y-2">
                                <div class="relative">
                                    <input type="text" id="addressInput" placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 152"
                                           class="w-full bg-slate-900/90 border border-slate-600 rounded-lg px-2.5 py-1.5 text-[11px] focus:outline-none focus:ring focus:ring-sky-500/60 focus:border-sky-400"
                                           onkeydown="if(event.key==='Enter'){ searchAddress(); }" />
                                    <button type="button"
                                            onclick="searchAddress()"
                                            class="absolute right-1.5 top-1/2 -translate-y-1/2 inline-flex items-center justify-center rounded-full bg-sky-500 hover:bg-sky-400 text-slate-950 border border-sky-300 px-2 py-1 text-[10px] shadow-soft">
                                        <i class="ph ph-magnifying-glass text-[12px]"></i>
                                        <span>ê²€ìƒ‰</span>
                                    </button>
                                </div>
                                <div id="addressSuggestions"
                                     class="mt-1 border border-slate-700 rounded-lg bg-slate-900/95 hidden text-[11px] divide-y divide-slate-800 shadow-soft"></div>
                                <div class="text-[9px] text-slate-500">
                                    â€» ìœ„ì¹˜ ì„ íƒ í›„, ì§€ë¶• ë˜ëŠ” í† ì§€ ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  ì§€ë„ì—ì„œ ì„¤ì¹˜ ê°€ëŠ¥ ì˜ì—­ì„ í´ë¦­í•˜ì„¸ìš”.
                                </div>
                            </div>
                        </div>

                        <!-- [F-10] ì„ íƒëœ í›„ë³´ì§€ ìš”ì•½ -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="ph ph-map-pin-line"></i>
                                        <span>ì„ íƒí•œ ìœ„ì¹˜ / ê¸°ë³¸ ì •ë³´</span>
                                    </div>
                                    <div class="card-subtitle">
                                        ì§€ë²ˆ Â· ìš©ë„ì§€ì—­ Â· ëŒ€ëµ ë©´ì 
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-1 text-[11px]" id="selectedInfo">
                                <div class="text-slate-400 text-[10px]">
                                    â€» ì§€ë„ì—ì„œ ì„¤ì¹˜ í›„ë³´ì§€ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>

                        <!-- [F-11] ê¸°ìì¬Â·ì„¤ì¹˜ ì˜µì…˜ ì¹´ë“œ -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="ph ph-solar-panel"></i>
                                        <span>íƒœì–‘ê´‘ íŒ¨ë„ Â· ì¸ë²„í„° ì„ íƒ</span>
                                    </div>
                                    <div class="card-subtitle">
                                        ëª¨ë“ˆ/ì¸ë²„í„° ì¡°í•©ê³¼ ì„¤ì¹˜ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”.
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-amber">
                                        <i class="ph ph-sparkle"></i>
                                        <span>2026 ê¸°ìì¬ DB</span>
                                    </span>
                                </div>
                            </div>

                            <div class="space-y-2 text-[11px]">
                                <div class="section-label">
                                    MODULE / INVERTER
                                </div>

                                <!-- ëª¨ë“ˆ ì„ íƒ -->
                                <div class="input-row">
                                    <label for="moduleSelect">ëª¨ë“ˆ</label>
                                    <select id="moduleSelect"
                                            class="bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px] w-full">
                                        <option value="">ë¡œë”© ì¤‘...</option>
                                    </select>
                                </div>

                                <!-- ì¸ë²„í„° ì„ íƒ -->
                                <div class="input-row">
                                    <label for="inverterSelect">ì¸ë²„í„°</label>
                                    <select id="inverterSelect"
                                            class="bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px] w-full">
                                        <option value="">ë¡œë”© ì¤‘...</option>
                                    </select>
                                </div>

                                <!-- ì„¤ì¹˜ íƒ€ì… -->
                                <div class="section-label mt-2">
                                    INSTALL TYPE
                                </div>
                                <div class="flex items-center gap-2 flex-wrap text-[10px]">
                                    <label class="inline-flex items-center gap-1">
                                        <input type="radio" name="installType" value="roof" checked
                                               class="w-3 h-3 text-sky-400 bg-slate-900 border-slate-500">
                                        <span>ì§€ë¶•í˜•(ê²½ëŸ‰êµ¬ì¡°)</span>
                                    </label>
                                    <label class="inline-flex items-center gap-1">
                                        <input type="radio" name="installType" value="carport"
                                               class="w-3 h-3 text-sky-400 bg-slate-900 border-slate-500">
                                        <span>ì¹´í¬íŠ¸í˜•</span>
                                    </label>
                                    <label class="inline-flex items-center gap-1">
                                        <input type="radio" name="installType" value="ground"
                                               class="w-3 h-3 text-sky-400 bg-slate-900 border-slate-500">
                                        <span>ì§€ìƒí˜•</span>
                                    </label>
                                </div>

                                <!-- ì„¤ì¹˜ ê°ë„ / ê°„ê²© -->
                                <div class="section-label mt-2">
                                    TILT / SPACING
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="input-row">
                                        <label for="tiltAngle" class="min-w-[60px]">ê²½ì‚¬ê°(Â°)</label>
                                        <input type="number" id="tiltAngle" value="20" min="0" max="50" step="1"
                                               class="bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]">
                                    </div>
                                    <div class="input-row">
                                        <label for="rowSpacing" class="min-w-[60px]">ì—´ ê°„ê²©(m)</label>
                                        <input type="number" id="rowSpacing" value="1.2" min="0.3" max="5" step="0.1"
                                               class="bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]">
                                    </div>
                                </div>

                                <!-- [F-5] íŒ¨ë„ ìë™/ìˆ˜ë™ ë°°ì¹˜ ì˜µì…˜ -->
                                <div class="section-label mt-2">
                                    PANEL LAYOUT
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-[10px]">
                                    <label class="inline-flex items-center gap-1">
                                        <input type="radio" name="layoutMode" value="auto" checked
                                               class="w-3 h-3 text-sky-400 bg-slate-900 border-slate-500">
                                        <span>ìë™ ë°°ì¹˜</span>
                                    </label>
                                    <label class="inline-flex items-center gap-1">
                                        <input type="radio" name="layoutMode" value="manual"
                                               class="w-3 h-3 text-sky-400 bg-slate-900 border-slate-500">
                                        <span>ìˆ˜ë™ ë°°ì¹˜(ì§ì ‘ ê·¸ë¦¬ê¸°)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- [F-6] íŒ¨ë„ ìˆ˜ëŸ‰/ìš©ëŸ‰ ìš”ì•½ ì¹´ë“œ -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="ph ph-calculator"></i>
                                        <span>íŒ¨ë„ ìˆ˜ëŸ‰ Â· ìš©ëŸ‰ ìš”ì•½</span>
                                    </div>
                                    <div class="card-subtitle">
                                        íŒ¨ë„ ë°°ì¹˜ ê²°ê³¼ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìš”ì•½í•©ë‹ˆë‹¤.
                                    </div>
                                </div>
                                <button type="button" onclick="recalcFromLayout()" class="btn btn-outline text-[10px]">
                                    <i class="ph ph-arrows-clockwise"></i>
                                    <span>ì¬ê³„ì‚°</span>
                                </button>
                            </div>
                            <div id="panelSummary" class="preview-card text-[11px]">
                                <div class="row">
                                    <div class="label">ì´ íŒ¨ë„ ìˆ˜</div>
                                    <div class="value"><span id="summaryPanelCount">0</span> ì¥</div>
                                </div>
                                <div class="row">
                                    <div class="label">ì„¤ì¹˜ ê°€ëŠ¥ DC ìš©ëŸ‰</div>
                                    <div class="value"><span id="summaryDcCapacity">0</span> kW</div>
                                </div>
                                <div class="row">
                                    <div class="label">ì˜ˆìƒ ì—°ê°„ ë°œì „ëŸ‰</div>
                                    <div class="value"><span id="summaryAnnualEnergy">-</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- [F-8, F-9] ê°„ë‹¨ ê¸ˆìœµ íŒŒë¼ë¯¸í„° -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="ph ph-coins"></i>
                                        <span>ê¸ˆìœµ íŒŒë¼ë¯¸í„°(ë‹¨ìˆœ)</span>
                                    </div>
                                    <div class="card-subtitle">
                                        ì›ë¦¬ê¸ˆ ê· ë“± ë°©ì‹ ROI / DSCR ì¶”ì •ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[11px]">
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1">ì´ íˆ¬ìë¹„ìš©(ì–µì›)</label>
                                    <input type="number" id="financeTotalCapex" value="3.0" step="0.1" min="0"
                                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1">ìê¸°ìë³¸ ë¹„ìœ¨(%)</label>
                                    <input type="number" id="financeEquityRatio" value="30" step="1" min="0" max="100"
                                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1">ëŒ€ì¶œê¸ˆë¦¬(%)</label>
                                    <input type="number" id="financeInterestRate" value="6.5" step="0.1" min="0"
                                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1">ëŒ€ì¶œë§Œê¸°(ë…„)</label>
                                    <input type="number" id="financeLoanYears" value="15" step="1" min="1" max="25"
                                           class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2) ê²½ì œì„±/ë¦¬ìŠ¤í¬ íƒ­ -->
                    <div id="tab-analysis" class="hidden space-y-3">
                        <!-- [F-12] ì„¤ì¹˜ ìœ„ì¹˜/ê¸°ë³¸ ìŠ¤ì½”ì–´ ìš”ì•½ -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">
                                        <i class="ph ph-graph"></i>
                                        <span>ê¸°ë³¸ ê²½ì œì„± ìš”ì•½</span>
                                    </div>
                                    <div class="card-subtitle">
                                        ë°œì „ëŸ‰ Â· ë§¤ì¶œ Â· ë‹¨ìˆœ ROI
                                    </div>
                                </div>
                            </div>
                            <div id="resultCard" class="preview-card text-[11px] hidden">
                                <div class="row">
                                    <div class="label">ì—°ê°„ ì˜ˆìƒ ë°œì „ëŸ‰</div>
                                    <div class="value"><span id="resultAnnualEnergy">-</span> kWh</div>
                                </div>
                                <div class="row">
                                    <div class="label">ì—°ê°„ ë§¤ì¶œ(ê³„ì•½ ë‹¨ê°€ ê¸°ì¤€)</div>
                                    <div class="value"><span id="resultAnnualRevenue">-</span></div>
                                </div>
                                <div class="row">
                                    <div class="label">íˆ¬ìë¹„ íšŒìˆ˜ê¸°ê°„(ë‹¨ìˆœ)</div>
                                    <div class="value"><span id="resultPaybackSimple">-</span></div>
                                </div>
                                <div class="row">
                                    <div class="label">LCOE(ì¶”ì •)</div>
                                    <div class="value"><span id="resultLCOE">-</span></div>
                                </div>
                            </div>
                            <div id="resultPlaceholder" class="text-[10px] text-slate-500">
                                â€» íŒ¨ë„ ë°°ì¹˜ ë° AI ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.
                            </div>
                        </div>

                        <!-- [F-27/28] í† ì§€ê°€ê²© ì¹´ë“œ -->
                        <div id="landPriceCard" class="hidden">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-currency-krw text-sky-300 text-[13px]"></i>
                                    <span class="text-[11px] font-semibold text-sky-50">í† ì§€ê°€ê²©(ì¶”ì •)</span>
                                </div>
                                <span class="text-[9px] text-sky-200/80">AI+ê³µì‹œì§€ê°€ ê¸°ë°˜</span>
                            </div>
                            <div class="flex items-baseline justify-between">
                                <div>
                                    <div id="landPriceValue">-</div>
                                    <div id="landPriceSub" class="mt-0.5">ã¡ë‹¹ í† ì§€ê°€ê²©</div>
                                </div>
                                <div class="text-right text-[10px] text-slate-300">
                                    <div>ì´ ë©´ì  <span id="landAreaValue">-</span> ã¡</div>
                                    <div>ì´ í† ì§€ê°€ê²© <span id="landTotalPrice">-</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- [F-15, F-16] AI ë¶„ì„ íŒ¨ë„ -->
                        <div id="panel-legal" class="hidden space-y-4">
                            <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                                <h3 class="text-sm font-bold mb-2 flex items-center gap-2">
                                    <i class="ph ph-files"></i>
                                    <span>8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­ & ì ìˆ˜</span>
                                </h3>

                                <div id="aiScorePanel" class="hidden mb-4 bg-transparent0 p-3 rounded border border-slate-600 mt-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-slate-300 font-bold">êµ¬ë§¤ë§¤ë ¥ë„ (AI Score)</span>
                                        <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                                    </div>
                                    <div class="w-full bg-slate-700 rounded-full h-2.5 mb-2 overflow-hidden">
                                        <div id="scoreBar" class="bg-gradient-to-r from-yellow-400 via-amber-400 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                                </div>
                                <div class="flex items-center justify-end mb-1">
                                  <button type="button"
                                          onclick="window.retryAIAnalysis()"
                                          class="inline-flex items-center gap-1 rounded-full bg-slate-900/60 px-2 py-1 text-[10px] text-cyan-200 border border-cyan-500/60 hover:bg-slate-800">
                                    <i class="ph ph-brain text-[12px]"></i>
                                    <span>AI ì¬ë¶„ì„</span>
                                  </button>
                                </div>

                                <div id="aiAnalysisResult" class="space-y-1 text-[10px]"></div>

                                <div class="mt-4 border-t border-slate-700 pt-2">
                                    <div class="flex items-center justify-between mb-1">
                                      <div class="flex items-center gap-1">
                                        <span class="text-xs text-slate-300 font-bold">AI ì¢…í•© ì´í‰ (ë²•/ì¡°ë¡€ ê¸°ë°˜)</span>
                                        <span class="text-[10px] text-slate-400">â€» ì¶”ì •/í™•ì¸ í•„ìš” í¬í•¨</span>
                                      </div>
                                      <div id="aiSummaryText" class="text-[11px] leading-relaxed text-slate-200 whitespace-pre-wrap"></div>
                                    </div>

                                    <!-- 8ëŒ€ ì²´í¬ì‚¬í•­ íŒ¨ë„ -->
                                    <div id="aiChecksContainer" class="space-y-1 mb-3 text-[11px]"></div>



                                    <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                                        <i class="ph ph-brain text-[20px] mb-2 text-purple-300"></i><br>ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ 8ëŒ€ í•­ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                                    </div>

                                    <div id="legalLoading" class="hidden text-center py-10">
                                        <i class="ph ph-spinner-gap text-[20px] animate-spin text-sky-300"></i>
                                        <div class="mt-2 text-[11px] text-slate-300">
                                            AIê°€ ë²•/ì¡°ë¡€ ë° ì¸í—ˆê°€ ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...
                                        </div>
                                    </div>

                                    <div id="legalContent" class="hidden mt-2 text-[11px] text-slate-200 space-y-2">
                                        <!-- ê¸°ì¡´ ìƒì„¸ í•­ëª©ì€ ìœ ì§€ -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì‹œìŠ¤í…œ ë¡œê·¸ ì¹´ë“œ -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="ph ph-terminal-window"></i>
                                    <span>ì‹œìŠ¤í…œ ë¡œê·¸</span>
                                </div>
                                <div class="card-subtitle">
                                    ë””ë²„ê¹… ë° V-World í˜¸ì¶œ íšŸìˆ˜ í™•ì¸
                                </div>
                            </div>
                            <div class="text-[10px] text-slate-400 flex items-center justify-between mb-1">
                                <div>V-World ì§€ì˜¤ë©”íŠ¸ë¦¬ ì¡°íšŒ (ì¼ê°„ ëˆ„ì )</div>
                                <div><span id="vworldCountToday">0</span> / 1,000</div>
                            </div>
                            <div id="systemLog"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- ì‹œìŠ¤í…œ ìƒíƒœ ë°” -->
    <div id="systemStatusBar">
        <div id="systemStatusInner">
            <div class="left">
                <div class="status-dot"></div>
                <span class="text-[10px]" id="systemStatusText">
                    ì´ˆê¸°í™” ì¤‘...
                </span>
            </div>
            <div class="right">
                <span class="status-tag">Beta</span>
                <span class="status-link" onclick="openSetupModal()">
                    íŒ¨ë„/ì¸ë²„í„° ì˜µì…˜ ì—´ê¸°
                </span>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="setupModal" class="modal-backdrop">
        <div class="modal-panel">
            <div class="modal-header">
                <div class="modal-title">
                    <div class="modal-title-main flex items-center gap-2">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-sky-600/90 text-slate-950 shadow-soft">
                            <i class="ph ph-sun-dim text-[14px]"></i>
                        </span>
                        <span>íƒœì–‘ê´‘ íŒ¨ë„Â·ì¸ë²„í„° ìƒì„¸ ì¡°ì •</span>
                    </div>
                    <div class="modal-title-sub">
                        ì§€ë¶•/í† ì§€ íƒ€ì…, íŒ¨ë„ íš¨ìœ¨, ì¼€ì´ë¸” ê¸¸ì´ ë“± í”„ë¡œì íŠ¸ ì˜µì…˜ì„ ì¡°ì •í•˜ì„¸ìš”.
                    </div>
                </div>
                <button type="button"
                        onclick="closeSetupModal()"
                        class="inline-flex items-center justify-center w-7 h-7 rounded-full border border-slate-600 bg-slate-900/90 hover:bg-slate-800 text-slate-300">
                    <i class="ph ph-x text-[14px]"></i>
                </button>
            </div>
            <div class="modal-body" id="setupModalBody">
                <!-- ê¸°ì¡´ ì‚¬ì´ë“œë°” ì…ë ¥ í•„ë“œë“¤ì„ ì´ ì•ˆì— ë°°ì¹˜ -->
                <div class="space-y-4 text-[11px]">

                    <!-- í”„ë¡œì íŠ¸ ë©”íƒ€ -->
                    <div>
                        <div class="section-label">PROJECT META</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">í”„ë¡œì íŠ¸ ì´ë¦„</label>
                                <input type="text" id="projectName" placeholder="ì˜ˆ: ê¹€í¬ì°½ê³  ì§€ë¶• íƒœì–‘ê´‘"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ë‹´ë‹¹ì</label>
                                <input type="text" id="projectOwner" placeholder="ì˜ˆ: í™ê¸¸ë™"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                        </div>
                    </div>

                    <!-- ê¸°ìì¬ ì„ íƒ / ì™€ì´ì–´ë§ -->
                    <div>
                        <div class="section-label mb-1">HARDWARE / WIRING</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">DC ì¼€ì´ë¸” ê¸¸ì´(1P ê¸°ì¤€, m)</label>
                                <input type="number" id="dcCableLength" value="50" min="0" step="1"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">AC ì¼€ì´ë¸” ê¸¸ì´(m)</label>
                                <input type="number" id="acCableLength" value="30" min="0" step="1"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                        </div>
                        <p class="mt-1 text-[9px] text-slate-500">
                            â€» ì¸ë²„í„° ìœ„ì¹˜ê°€ ì „ì£¼/ìˆ˜ë³€ì „ì‹¤ì—ì„œ ë©€ì–´ì§ˆìˆ˜ë¡ AC ì¼€ì´ë¸” ë¹„ìš©ì´ ì¦ê°€í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ê¸ˆìœµ ìƒì„¸ ì˜µì…˜ -->
                    <div>
                        <div class="section-label mb-1">FINANCE DETAIL</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ì „ë ¥íŒë§¤ ë‹¨ê°€(ì›/kWh)</label>
                                <input type="number" id="pricePerKwh" value="120" min="0" step="1"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ì—°ê°„ O&M ë¹„ìš©(ë°±ë§Œì›)</label>
                                <input type="number" id="omCostPerYear" value="50" min="0" step="1"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ìš´ì˜ê¸°ê°„(ë…„)</label>
                                <input type="number" id="operationYears" value="20" min="1" max="30" step="1"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ì„¸ìœ¨(%)</label>
                                <input type="number" id="taxRate" value="22" min="0" max="50" step="1"
                                       class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]" />
                            </div>
                        </div>
                        <p class="mt-1 text-[9px] text-slate-500">
                            â€» PF ê¸ˆìœµë¡œì§ì€ ì›ë¦¬ê¸ˆ ê· ë“±ë¶„í• (ì›ë¦¬ê¸ˆ ê· ë“±ìƒí™˜) ë°©ì‹ìœ¼ë¡œ DSCR ê¸°ì¤€ì„ ê²€ì¦í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ì§€ë¶•/í† ì§€ êµ¬ì¡° ì˜µì…˜ -->
                    <div>
                        <div class="section-label mb-1">STRUCTURE</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ì§€ë¶• í˜•íƒœ</label>
                                <select id="roofType" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]">
                                    <option value="flat">í‰ì§€ë¶•</option>
                                    <option value="gable">ë°•ê³µì§€ë¶•</option>
                                    <option value="sawtooth">í†±ë‹ˆí˜•</option>
                                    <option value="etc">ê¸°íƒ€</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ì§€ë¶• ë§ˆê°ì¬</label>
                                <select id="roofMaterial" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]">
                                    <option value="sandwich">ìƒŒë“œìœ„ì¹˜íŒë„¬</option>
                                    <option value="deckplate">ë°í¬í”Œë ˆì´íŠ¸</option>
                                    <option value="rc">RC ìŠ¬ë˜ë¸Œ</option>
                                    <option value="etc">ê¸°íƒ€</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ê¸°íƒ€ ì˜µì…˜ -->
                    <div>
                        <div class="section-label mb-1">MISC</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">ëˆˆ/í­ì„¤ ì§€ì—­ ì—¬ë¶€</label>
                                <select id="snowRegion" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]">
                                    <option value="normal">ì¼ë°˜ì§€ì—­</option>
                                    <option value="heavy">ì ì„¤/í•œë­ì§€ì—­</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1">íƒœí’/ê°•í’ ì˜í–¥</label>
                                <select id="windRegion" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-[11px]">
                                    <option value="normal">ë³´í†µ</option>
                                    <option value="high">ë†’ìŒ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <span class="pill-key">
                        <span class="key">Esc</span>
                        <span>ë‹«ê¸°</span>
                    </span>
                    <span class="pill-key">
                        <span class="key">Enter</span>
                        <span>ì €ì¥ í›„ ë‹«ê¸°</span>
                    </span>
                </div>
                <div class="modal-footer-right">
                    <button type="button"
                            onclick="resetSetupModal()"
                            class="btn btn-outline text-[10px]">
                        <i class="ph ph-arrow-counter-clockwise"></i>
                        <span>ì´ˆê¸°ê°’</span>
                    </button>
                    <button type="button"
                            onclick="saveSetupModal()"
                            class="btn btn-primary text-[10px] px-3">
                        <i class="ph ph-check-circle"></i>
                        <span>ì„¤ì • ì €ì¥</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- íˆë“  í¼ (ë¦¬í¬íŠ¸/ì´ë©”ì¼ìš©) -->
    <form id="reportForm" action="" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="pnu" id="form_pnu">
        <input type="hidden" name="lat" id="form_lat">
        <input type="hidden" name="lng" id="form_lng">
        <input type="hidden" name="payload" id="form_payload">
    </form>

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast"></div>

    <script>
        // ---------------------------------
        // ì „ì—­ ìƒíƒœ
        // ---------------------------------
        let map;
        let vworldTile, osmTile, googleTile;
        let selectableGroup = L.layerGroup();
        let panelGroup = L.layerGroup();
        let analysisMarkerGroup = L.layerGroup();
        let scanLock = false;
        let drawMode = null;
        let drawPolygon = null;
        let drawVertices = [];
        let drawTooltipEl;
        let currentAnalysisFeature = null;
        let currentAnalysisData = {
          address: "",
          pnu: "",
          lat: null,
          lng: null,
          area_m2: null,
          land_price_won_per_m2: null,
          ai_analysis: null
        };
        let vworldDailyCount = 0;
        let scanTarget = "roof";

        const FEATURE_LEVEL = 5;

        // BACKEND URL (ì˜ˆ: ?backend=https://my-backend.cloudtype.app)
        const urlParams = new URLSearchParams(location.search);
        const BACKEND_URL = (function(){
          const p = urlParams.get("backend");
          if(p) return p.replace(/\/$/,"");
          const fromMeta = document.querySelector("meta[name='backend-url']")?.getAttribute("content") || "";
          if(fromMeta) return fromMeta.replace(/\/$/,"");
          return "";
        })();

        // ---------------------------------
        // ìœ í‹¸
        // ---------------------------------
        function el(id){ return document.getElementById(id); }

        function showToast(msg, timeout=2500){
          const t = el("toast");
          if(!t) return;
          t.textContent = msg;
          t.style.display = "block";
          clearTimeout(showToast._timer);
          showToast._timer = setTimeout(()=>{ t.style.display = "none"; }, timeout);
        }

        function logSystem(msg){
          const box = el("systemLog");
          if(!box) return;
          const now = new Date();
          const line = `[${now.toLocaleTimeString("ko-KR",{hour12:false})}] ${msg}`;
          const div = document.createElement("div");
          div.textContent = line;
          box.prepend(div);
        }

        function getBackendBase(){
          if(!BACKEND_URL){
            showToast("backend ë¯¸ì„¤ì • (?backend=...)");
            return "";
          }
          return BACKEND_URL.replace(/\/$/,"");
        }

        function postJson(url, body){
          return fetch(url, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(body || {}),
            credentials: "include"
          }).then(r => r.json().catch(()=>({ok:false,msg:"invalid json"})));
        }

        function safeText(v, fallback="-"){
          if(v === null || v === undefined) return fallback;
          return String(v);
        }

        // ---------------------------------
        // ì§€ë„ ì´ˆê¸°í™”
        // ---------------------------------
        function initMap(){
          map = L.map("map", {
            center: [37.5665, 126.9780],
            zoom: 17,
            zoomControl: false
          });

          vworldTile = L.tileLayer("https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; VWorld"
          }).addTo(map);

          osmTile = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap"
          });

          googleTile = L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
            maxZoom: 19,
            attribution: "Imagery &copy; Google"
          });

          selectableGroup.addTo(map);
          panelGroup.addTo(map);
          analysisMarkerGroup.addTo(map);

          L.control.zoom({
            position: "bottomright"
          }).addTo(map);

          map.on("zoomend", updateZoomLabel);
          updateZoomLabel();

          map.on("click", onMapClick);
        }

        function updateZoomLabel(){
          const z = map.getZoom();
          const label = el("zoomLevelText");
          if(label) label.textContent = z;
        }

        // ---------------------------------
        // ë² ì´ìŠ¤ë§µ í† ê¸€
        // ---------------------------------
        function setBasemap(name){
          if(!map) return;
          map.removeLayer(vworldTile);
          map.removeLayer(osmTile);
          map.removeLayer(googleTile);

          if(name === "osm"){
            osmTile.addTo(map);
          } else if(name === "google"){
            googleTile.addTo(map);
          } else {
            vworldTile.addTo(map);
          }

          document.querySelectorAll(".basemap-option").forEach(btn=>{
            btn.classList.toggle("active", btn.dataset.map === name);
          });
        }

        document.addEventListener("click", (e)=>{
          if(e.target.closest(".basemap-option")){
            const name = e.target.closest(".basemap-option").dataset.map;
            setBasemap(name);
          }
        });

        // ---------------------------------
        // ì‚¬ì´ë“œë°” í† ê¸€
        // ---------------------------------
        function toggleSidebar(){
          const sidebar = el("sidebar");
          if(!sidebar) return;
          const collapsed = sidebar.classList.toggle("collapsed");
          const btnMini = el("sidebarToggleMini");
          if(btnMini){
            btnMini.classList.toggle("bg-sky-500", collapsed);
          }
          logSystem(collapsed ? "ìš°ì¸¡ íŒ¨ë„ ì ‘í˜" : "ìš°ì¸¡ íŒ¨ë„ í¼ì¹¨");
        }

        function initSidebarDrag(){
          const handle = el("sidebarDragHandle");
          const sidebar = el("sidebar");
          if(!handle || !sidebar) return;

          let drag = false;
          let startX = 0;
          let startWidth = 0;

          handle.addEventListener("mousedown", (e)=>{
            drag = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            document.body.style.userSelect = "none";
          });

          document.addEventListener("mousemove", (e)=>{
            if(!drag) return;
            const dx = startX - e.clientX;
            let newWidth = startWidth + dx;
            newWidth = Math.max(320, Math.min(520, newWidth));
            sidebar.style.width = `${newWidth}px`;
          });

          document.addEventListener("mouseup", ()=>{
            drag = false;
            document.body.style.userSelect = "";
          });
        }

        // ---------------------------------
        // íƒ­ ì „í™˜
        // ---------------------------------
        function initTabs(){
          const tabBtns = document.querySelectorAll(".tab-btn");
          tabBtns.forEach(btn=>{
            btn.addEventListener("click", ()=>{
              const target = btn.dataset.tab;
              tabBtns.forEach(b=>b.classList.remove("active"));
              btn.classList.add("active");
              document.querySelectorAll("#tab-design,#tab-analysis").forEach(sec=>{
                sec.classList.add("hidden");
              });
              const pane = el("tab-" + target);
              if(pane) pane.classList.remove("hidden");
            });
          });
        }

        // ---------------------------------
        // ì„¤ì • ëª¨ë‹¬
        // ---------------------------------
        function openSetupModal(){
          const m = el("setupModal");
          if(!m) return;
          m.style.display = "flex";
        }

        function closeSetupModal(){
          const m = el("setupModal");
          if(!m) return;
          m.style.display = "none";
        }

        function resetSetupModal(){
          showToast("ì•„ì§ ìƒì„¸ ì´ˆê¸°í™” ë¡œì§ì€ ë‹¨ìˆœí™” ìƒíƒœì…ë‹ˆë‹¤.");
        }

        function saveSetupModal(){
          closeSetupModal();
          showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì„¸ì…˜ ê¸°ì¤€)");
        }

        document.addEventListener("keydown", (e)=>{
          const m = el("setupModal");
          if(!m || m.style.display !== "flex") return;
          if(e.key === "Escape"){
            e.preventDefault();
            closeSetupModal();
          } else if(e.key === "Enter"){
            e.preventDefault();
            saveSetupModal();
          }
        });

        // ---------------------------------
        // ëª¨ë“œ ì „í™˜ (ì§€ë¶• / í† ì§€)
        // ---------------------------------
        function setScanMode(mode){
          scanTarget = mode;
          const isRoof = (mode === "roof");
          const btnRoof = el("btnModeRoof");
          const btnLand = el("btnModeLand");
          if(btnRoof) btnRoof.classList.toggle("active", isRoof);
          if(btnLand) btnLand.classList.toggle("active", !isRoof);
          logSystem(`ìŠ¤ìº” ëª¨ë“œ: ${mode === "roof" ? "ì§€ë¶•" : "í† ì§€"}`);
        }

        // ---------------------------------
        // ì£¼ì†Œ ê²€ìƒ‰
        // ---------------------------------
        async function searchAddress(){
          const input = el("addressInput");
          if(!input || !map) return;
          const q = input.value.trim();
          if(!q){
            showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }
          logSystem(`ì£¼ì†Œ ê²€ìƒ‰: ${q}`);

          // TODO: ì‹¤ì œ API ì—°ë™ (ì§€ê¸ˆì€ ë‹¨ìˆœ dummy)
          try{
            const center = map.getCenter();
            map.setView(center, 18);
            showToast("ì£¼ì†Œ ê²€ìƒ‰ APIëŠ” ì•„ì§ ë”ë¯¸ ëª¨ë“œì…ë‹ˆë‹¤. (ì„¼í„° ìœ ì§€)");
          }catch(e){
            logSystem(`ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}`);
          }
        }

        // ---------------------------------
        // ìœ ì € ìœ„ì¹˜ ì°¾ê¸°
        // ---------------------------------
        function locateUser(){
          if(!navigator.geolocation){
            showToast("ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }
          navigator.geolocation.getCurrentPosition(pos=>{
            const {latitude, longitude} = pos.coords;
            if(map){
              map.setView([latitude, longitude], 18);
              logSystem(`í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™: (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`);
            }
          }, err=>{
            showToast("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            logSystem(`ìœ„ì¹˜ ì˜¤ë¥˜: ${err.message}`);
          });
        }

        // ---------------------------------
        // ì§€ë„ í´ë¦­ í•¸ë“¤ëŸ¬
        // ---------------------------------
        function onMapClick(e){
          if(drawMode === "panel"){
            addDrawVertex(e.latlng);
            return;
          }

          // í´ë¦­ ìœ„ì¹˜ ê¸°ë°˜ í›„ë³´ì§€ ìŠ¤ìº”
          const {lat, lng} = e.latlng;
          scanBuildings(lat, lng);
        }

        // ---------------------------------
        // íŒ¨ë„ ê·¸ë¦¬ê¸°
        // ---------------------------------
        function startDrawPanel(){
          drawMode = "panel";
          drawVertices = [];
          if(drawPolygon){
            map.removeLayer(drawPolygon);
            drawPolygon = null;
          }
          if(!drawTooltipEl){
            drawTooltipEl = el("drawTooltip");
          }
          if(drawTooltipEl){
            drawTooltipEl.style.display = "block";
            drawTooltipEl.textContent = "íŒ¨ë„ ì˜ì—­ì„ í´ë¦­í•˜ì—¬ ë‹¤ê°í˜•ì„ ê·¸ë¦½ë‹ˆë‹¤. (ë”ë¸”í´ë¦­ or Enterë¡œ ì¢…ë£Œ)";
          }
          map.getContainer().style.cursor = "crosshair";
          logSystem("íŒ¨ë„ ì§ì ‘ ê·¸ë¦¬ê¸° ëª¨ë“œ ì‹œì‘");
        }

        function finishDrawPanel(){
          drawMode = null;
          if(drawTooltipEl){
            drawTooltipEl.style.display = "none";
          }
          map.getContainer().style.cursor = "";
          if(drawVertices.length >= 3){
            if(drawPolygon){
              map.removeLayer(drawPolygon);
            }
            drawPolygon = L.polygon(drawVertices, {color:"#f97316", weight:2, fillOpacity:0.2}).addTo(panelGroup);
            logSystem(`ìˆ˜ë™ íŒ¨ë„ ì˜ì—­ ë“±ë¡ (ë²„í…ìŠ¤ ${drawVertices.length}ê°œ)`);
          }else{
            if(drawPolygon){
              map.removeLayer(drawPolygon);
              drawPolygon = null;
            }
            logSystem("ë²„í…ìŠ¤ê°€ ë¶€ì¡±í•˜ì—¬ íŒ¨ë„ ì˜ì—­ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          }
        }

        function addDrawVertex(latlng){
          drawVertices.push(latlng);
          if(drawPolygon){
            map.removeLayer(drawPolygon);
          }
          drawPolygon = L.polygon(drawVertices, {color:"#f97316", weight:2, fillOpacity:0.2}).addTo(panelGroup);
        }

        document.addEventListener("keydown", (e)=>{
          if(drawMode === "panel" && (e.key === "Enter" || e.key === "Escape")){
            finishDrawPanel();
          }
        });

        // ---------------------------------
        // íŒ¨ë„ ì´ˆê¸°í™”
        // ---------------------------------
        function resetAllPanels(){
          panelGroup.clearLayers();
          drawVertices = [];
          if(drawPolygon){
            map.removeLayer(drawPolygon);
            drawPolygon = null;
          }
          logSystem("íŒ¨ë„/ë¶„ì„ ì˜ì—­ ì´ˆê¸°í™” ì™„ë£Œ");
        }

        // ---------------------------------
        // í† ì§€ ë‹¨ê°€ API (F-27, F-28)
        // ---------------------------------
        window.fetchLandEstimate = async function(address, lat, lng){
          try{
            const backend = getBackendBase();
            if(!backend) return null;

            // âœ… area_m2ê°€ ì—†ìœ¼ë©´: íŒ¨ë„ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œë¼ë„ ë©´ì  ì¶”ì •(ë„ ë°©ì§€)
            let area_m2 = currentAnalysisData.area_m2;
            if(!area_m2 || area_m2 <= 0){
              const pc = (typeof getTotalPanelCount === "function") ? getTotalPanelCount() : 0;
              // íŒ¨ë„ 1ì¥ ì ìœ ë©´ì (ëŒ€ëµ) 2.2ã¡ + í†µë¡œ/ê°„ê²© ì—¬ìœ  1.25ë°°
              if(pc && pc > 0) area_m2 = pc * 2.2 * 1.25;
            }

            const payload = {
              address: address||"",
              pnu: currentAnalysisData.pnu || null,
              area_m2: area_m2 || null,
              area_pyeong: (area_m2 ? (area_m2/3.305785) : null),
              lat, lng,
            };
            const r = await fetch(`${backend}/api/land/estimate`, {
              method:"POST",
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(payload),
              credentials:"include"
            });
            const j = await r.json().catch(()=>null);
            if(!j || !j.ok) throw new Error(j?.msg || "LAND API error");
            return j.data;
          }catch(e){
            logSystem(`í† ì§€ë‹¨ê°€ ì¡°íšŒ ì‹¤íŒ¨: ${e.message}`);
            console.error("fetchLandEstimate failed", e);
            return null;
          }
        };

        // ---------------------------------
        // í›„ë³´ì§€ ìŠ¤ìº” (V-World ì§€ë¶•/í† ì§€)
        // ---------------------------------
        async function scanBuildings(lat, lng, force=false){
          if(!map) return null;
          if(scanLock && !force) return null;
          scanLock = true;

          let fetchedFeatures = [];
          try{
            if(!isMultiSelectMode){
              selectableGroup.clearLayers();
              panelGroup.clearLayers();
              selectedFeatures.clear();
              currentAnalysisFeature = null;
              resetCalibrationInternal(false);
              // reset UI cards
              const rc = el("resultCard");
              if(rc) rc.classList.add("hidden");
              const lp = el("legalPlaceholder");
              const lc = el("legalContent");
              const sp = el("aiScorePanel");
              const ac = el("aiChecksContainer");
              if(lp) lp.classList.remove("hidden");
              if(lc) lc.classList.add("hidden");
              if(sp) sp.classList.add("hidden");
              if(ac) ac.innerHTML = "";
            }

            analysisMarkerGroup.clearLayers();
            L.marker([lat,lng],{
              icon: L.divIcon({
                className:"analysis-marker",
                html:`<div style="width:16px;height:16px;border-radius:999px;background:#f97316;border:2px solid white;box-shadow:0 0 10px rgba(248,250,252,0.9);"></div>`
              })
            }).addTo(analysisMarkerGroup);

            // TODO: V-World ê±´ë¬¼ í´ë¦¬ê³¤ ì¡°íšŒ ì‹¤ì œ ì—°ë™
            fetchedFeatures = []; // ë”ë¯¸

            logSystem("ì„¤ì¹˜ í›„ë³´ì§€ ìŠ¤ìº”(ë”ë¯¸ ëª¨ë“œ) ì™„ë£Œ - ì‹¤ì œ V-World ì—°ë™ í•„ìš”");
          }catch(e){
            logSystem(`í›„ë³´ì§€ ìŠ¤ìº” ì‹¤íŒ¨: ${e.message}`);
          }finally{
            scanLock = false;
          }
        }

        // ---------------------------------
        // AI ë¶„ì„ ë Œë”ë§
        // ---------------------------------
        function __deriveCheckLink(title){
          const t = String(title||"");
          if(t.includes("ê³„í†µ") || t.includes("í•œì „")) return "https://cyber.kepco.co.kr/";
          if(t.includes("ì¼ì‚¬") || t.includes("ê¸°ìƒ")) return "https://www.data.go.kr/";
          if(t.includes("ìš©ë„ì§€ì—­") || t.includes("ë„ì‹œê³„íš")) return "https://www.eum.go.kr/";
          if(t.includes("ë¯¼ì›") || t.includes("ì†ŒìŒ")) return "https://www.epeople.go.kr/";
          if(t.includes("ë¬¸í™”ì¬") || t.includes("ê²½ê´€")) return "https://www.cha.go.kr/";
          if(t.includes("ê²½ì‚¬ë„") || t.includes("ì§€í˜•")) return "https://map.ngii.go.kr/";
          if(t.includes("ë²•ë ¹") || t.includes("ì¡°ë¡€")) return "https://www.law.go.kr/";
          if(t.includes("ì§€ìì²´") || t.includes("ë„ì‹œ") || t.includes("êµ°")) return "https://www.elis.go.kr/";
          return "";
        }

        function renderAIResult(payload){
          // Expected: checks[], attractiveness_score or ai_score
          const container = el("aiAnalysisResult");
          if(container){
            const checks = Array.isArray(payload.checks) ? payload.checks : [];
            const summary = payload.ai_summary || payload.summary || "";
            const sumPanel = el("aiSummaryPanel");
            const sumText = el("aiSummaryText");
            if(sumPanel && sumText){
              if(summary){ sumPanel.classList.remove("hidden"); sumText.textContent = String(summary); }
              else { sumPanel.classList.add("hidden"); sumText.textContent = ""; }
            }
            container.innerHTML = checks.map(item => {
              const title = safeText(item.title || item.category, "");
              const result = safeText(item.message || item.result || item.status || "", "í™•ì¸ í•„ìš”");
              const link = (item.link || item.url || __deriveCheckLink(title) || "");
              const needs = item.needs_confirm || item.confirm_needed || (String(result).includes("í™•ì¸") && String(result).includes("í•„ìš”"));
              return `
                <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]">
                  <div class="flex items-center gap-2">
                    <div class="text-cyan-400">âœ“</div>
                    <div>
                      <div class="text-slate-300 font-bold">${title}</div>
                      <div class="${needs ? "text-yellow-300" : "text-white"} truncate w-60">${result}</div>
                    </div>
                  </div>
                  ${link ? `<a href="${link}" target="_blank" class="bg-slate-600 px-2 py-1 rounded hover:bg-slate-500">ë§í¬</a>` : ""}
                </div>
              `;
            }).join("") || `<div class="text-slate-300 text-xs">AI ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          }

          // Score
          const scorePanel = el("aiScorePanel");
          const scoreValue = el("scoreValue");
          const scoreBar = el("scoreBar");
          const confidenceValue = el("confidenceValue");

          // Score priority: payload.attractiveness_score or payload.ai_score.score
          let score = null;
          let confidence = null;
          if(typeof payload.attractiveness_score === "number") score = payload.attractiveness_score;
          else if(payload.ai_score && typeof payload.ai_score.score === "number") score = payload.ai_score.score;

          if(payload.ai_score && typeof payload.ai_score.confidence === "number") confidence = payload.ai_score.confidence;
          if(typeof payload.confidence === "number") confidence = payload.confidence;

          if(scorePanel && scoreValue && scoreBar){
            if(score === null) {
              scorePanel.classList.add("hidden");
            } else {
              scorePanel.classList.remove("hidden");
              const s = Math.max(0, Math.min(100, Math.round(score)));
              scoreValue.innerText = `${s}ì `;
              scoreBar.style.width = `${s}%`;
              if(confidenceValue) confidenceValue.innerText = (confidence !== null) ? `ì‹ ë¢°ë„: ${confidence}%` : "";
            }
          }

          // Kepco capacity field if present
          if(el("kepcoCapacity")){
            const kc = payload.kepco_capacity || payload.kepco || null;
            if(kc) el("kepcoCapacity").innerText = safeText(kc);
          }

          // sun hours if present
          if(typeof payload.sun_hours === "number"){
            currentAnalysisData.ai_analysis = currentAnalysisData.ai_analysis || {};
            currentAnalysisData.ai_analysis.sun_hours = payload.sun_hours;
          }
        }

        /* === 8ëŒ€ ì²´í¬ì‚¬í•­ íŒ¨ë„ ===
         * - currentAnalysisData, BACKEND_URL, postJson, el()ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
         */
        async function fetchEightChecks() {
          try {
            if (!BACKEND_URL) {
              console.warn("BACKEND_URL not set, skip 8-checks");
              return;
            }
            if (!window.currentAnalysisData) {
              console.warn("currentAnalysisData not ready for eight-checks");
              return;
            }

            const cad = window.currentAnalysisData || {};
            const mode = cad.mode || (window.scanTarget === "land" ? "land" : "roof");

            const payload = {
              address: cad.address || null,
              lat: cad.lat,
              lng: cad.lng,
              pnu: cad.pnu || null,
              capacity_kw: cad.ac_kw || cad.acKW || null,
              slope_deg: cad.slope_deg || cad.slopeDeg || null,
              sun_hours: cad.sun_hours || null,
              land_price_won_per_m2: cad.land_price_won_per_m2 || null,
              dist_road_m: cad.dist_road_m || null,
              dist_residential_m: cad.dist_residential_m || null,
              area_m2: cad.area_m2 || null,
              mode: mode,
            };

            const res = await postJson(`${BACKEND_URL}/api/checks/analyze`, payload);
            if (!res || !res.ok) {
              console.error("8-checks API error", res);
              return;
            }

            renderEightChecks(res.data || {});
          } catch (e) {
            console.error("fetchEightChecks failed", e);
          }
        }

        function renderEightChecks(data) {
          const container = document.getElementById("aiChecksContainer");
          if (!container) return;

          const list = (data && data.check_list) || {};

          const items = [
            { key: "zoning",     label: "1. ìš©ë„ì§€ì—­" },
            { key: "ecology",    label: "2. ìƒíƒœÂ·ë³´ì „ / ì¸í—ˆê°€" },
            { key: "heritage",   label: "3. ë¬¸í™”ì¬Â·ê²½ê´€Â·ë¯¼ì›" },
            { key: "setback",    label: "4. ì´ê²©ê±°ë¦¬" },
            { key: "grid",       label: "5. í•œì „ ìš©ëŸ‰(ê³„í†µì—°ê³„)" },
            { key: "slope",      label: "6. ê²½ì‚¬ë„" },
            { key: "insolation", label: "7. ì¼ì‚¬ëŸ‰ / ê·¸ëŠ˜" },
            { key: "land_price", label: "8. í† ì§€ê°€ê²© / ì‚¬ì—…ì„±" },
          ];

          const statusToClass = (s) => {
            if (!s) return "warn";
            s = String(s).toUpperCase();
            if (s === "PASS") return "pass";
            if (s === "FAIL") return "fail";
            return "warn";
          };

          const html = items.map((it) => {
            const raw = list[it.key] || {};
            const status = raw.status || "WARNING";
            const cls = statusToClass(status);
            const value = raw.value || "";
            const msg = raw.msg || "";

            return `
              <div class="checkRow ${cls}">
                <div class="checkTitle">
                  ${escapeHtml(it.label)}
                  <span class="text-[9px] opacity-70">(${escapeHtml(status)})</span>
                </div>
                <div class="checkValue">${escapeHtml(value)}</div>
                <div class="checkMsg">${escapeHtml(msg)}</div>
              </div>
            `;
          }).join("");

          container.innerHTML = html || '<div class="text-[11px] text-slate-400">ì²´í¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        // ì•„ì£¼ ë‹¨ìˆœí•œ escape
        function escapeHtml(s) {
          return String(s).replace(/[&<>"']/g, function (m) {
            return ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[m];
          });
        }

        window.fetchAIData = async function(lat, lng, addr){
          if(FEATURE_LEVEL < 5) return;
          if(!BACKEND_URL){
            logSystem("AI skipped: BACKEND_URL not set (use ?backend=...)");
            return;
          }

          const placeholder = el("legalPlaceholder");
          const loading = el("legalLoading");
          const content = el("legalContent");

          if(placeholder) placeholder.classList.add("hidden");
          if(loading) loading.classList.remove("hidden");
          if(content) content.classList.add("hidden");

          try{
            const payload = {
              address: addr || currentAnalysisData.address || "",
              pnu: currentAnalysisData.pnu || "",
              lat, lng,
              scan_target: scanTarget,
              dc_kw: currentAnalysisData.dc_kw || null,
              ac_kw: currentAnalysisData.ac_kw || null,
              panel_count: getTotalPanelCount(),
              area_m2: currentAnalysisData.area_m2 || null,
              area_pyeong: currentAnalysisData.area_m2 ? currentAnalysisData.area_m2/3.305785 : null
            };

            let r;
            if(FEATURE_LEVEL >= 5){
              r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
            }else{
              r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
            }
            if(!r.ok){
              throw new Error(`AI HTTP ${r.status}`);
            }

            currentAnalysisData.ai_analysis = r.data;

            if(loading) loading.classList.add("hidden");
            if(content) content.classList.remove("hidden");

            renderAIResult(r.data);

            // 8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­ íŒ¨ë„ ê°±ì‹ 
            try {
              if (typeof fetchEightChecks === "function") {
                fetchEightChecks();
              }
            } catch (e) {
              console.error("fetchEightChecks failed", e);
            }

            // F-27/28 refresh (API-first)
            try{ window.refreshSolarLandEstimates(); }catch(e){}

            // Recalc finance with sun hours if present
            if(typeof r.data.sun_hours === "number"){
              window.calculateFinance(getTotalPanelCount(), r.data.sun_hours);
            }
          } catch(e){
            if(loading) loading.classList.add("hidden");
            if(placeholder) {
              placeholder.classList.remove("hidden");
              placeholder.innerHTML = `<div class="text-center py-10 text-slate-300 text-xs"><div class="mb-2">AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div><span class="text-[10px]">${safeText(e.message,"")}</span></div>`;
            }
            logSystem(`AI error: ${e.message}`);
          }
        };
        // -----------------------------
        // Report / History (minimal, keeps UI)
        // -----------------------------
        window.openFullReport = function(){
          const form = el("reportForm");
          if(!form){
            showToast("reportForm not found");
            return;
          }
          if(!BACKEND_URL){
            showToast("backend ë¯¸ì„¤ì •");
            return;
          }
          // Fill hidden fields if exist
          if(el("form_address")) el("form_address").value = currentAnalysisData.address || "";
          if(el("form_pnu")) el("form_pnu").value = currentAnalysisData.pnu || "";
          if(el("form_lat")) el("form_lat").value = currentAnalysisData.lat || "";
          if(el("form_lng")) el("form_lng").value = currentAnalysisData.lng || "";
          if(el("form_payload")) el("form_payload").value = JSON.stringify(currentAnalysisData || {}, null, 2);

          form.action = `${BACKEND_URL}/api/report/pdf`;
          form.submit();
        };

        window.retryAIAnalysis = function(){
          if(!currentAnalysisData.lat || !currentAnalysisData.lng){
            showToast("ë¨¼ì € ì§€ë„ì—ì„œ ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }
          fetchAIData(currentAnalysisData.lat, currentAnalysisData.lng, currentAnalysisData.address);
        };

        // -----------------------------
        // License / Auth (ê°„ë‹¨)
        // -----------------------------
        async function checkLicense(){
          if(!BACKEND_URL){
            el("licenseStatusLabel").textContent = "ì„œë²„ ë¯¸ì„¤ì • (?backend=...)";
            return;
          }
          try{
            const r = await fetch(`${BACKEND_URL}/api/auth/whoami`, {credentials:"include"});
            const j = await r.json().catch(()=>null);
            if(!j || !j.ok){
              el("licenseStatusLabel").textContent = "ë¼ì´ì„ ìŠ¤ ë¯¸ì¸ì¦";
              el("licenseDeviceLabel").textContent = "";
              logSystem("ë¼ì´ì„ ìŠ¤ ì¸ì¦ í•„ìš” (admin í˜ì´ì§€ì—ì„œ ë°œê¸‰)");
              return;
            }
            el("licenseStatusLabel").textContent = "ë¼ì´ì„ ìŠ¤ í™œì„±";
            el("licenseDeviceLabel").textContent = j.data?.device_name || "";
            logSystem("ë¼ì´ì„ ìŠ¤ ì •ìƒ ì¸ì¦ë¨");
          }catch(e){
            el("licenseStatusLabel").textContent = "ë¼ì´ì„ ìŠ¤ í™•ì¸ ì‹¤íŒ¨";
            el("licenseDeviceLabel").textContent = "";
            logSystem(`ë¼ì´ì„ ìŠ¤ í™•ì¸ ì‹¤íŒ¨: ${e.message}`);
          }
        }

        // -----------------------------
        // íŒ¨ë„ ìˆ˜ëŸ‰ / ìš©ëŸ‰ ê³„ì‚° (ë”ë¯¸)
        // -----------------------------
        function getTotalPanelCount(){
          // TODO: ì‹¤ì œ panelGroup ë ˆì´ì–´ ê¸°ë°˜ ê³„ì‚°. ì§€ê¸ˆì€ ë”ë¯¸ 100ì¥.
          return 100;
        }

        function recalcFromLayout(){
          const pc = getTotalPanelCount();
          const moduleSelect = el("moduleSelect");
          const selectedOption = moduleSelect ? moduleSelect.selectedOptions[0] : null;
          const powerW = selectedOption ? Number(selectedOption.dataset.powerW || 0) : 0;
          const dcKw = pc * powerW / 1000;

          el("summaryPanelCount").textContent = pc;
          el("summaryDcCapacity").textContent = dcKw.toFixed(1);

          // AI ë¶„ì„ì´ sun_hoursë¥¼ ì£¼ì§€ ì•Šì€ ìƒíƒœì—ì„œëŠ” ë°œì „ëŸ‰ì€ "-"ë¡œ ìœ ì§€
          const aiSun = currentAnalysisData?.ai_analysis?.sun_hours;
          if(typeof aiSun === "number" && dcKw > 0){
            const annualKwh = dcKw * aiSun * 365;
            el("summaryAnnualEnergy").textContent = annualKwh.toLocaleString("ko-KR");
          }else{
            el("summaryAnnualEnergy").textContent = "-";
          }

          logSystem(`íŒ¨ë„ ìˆ˜ëŸ‰/ìš©ëŸ‰ ì¬ê³„ì‚°: ${pc}ì¥, ì•½ ${dcKw.toFixed(1)}kW`);
        }

        // -----------------------------
        // ê¸ˆìœµ ê³„ì‚° (ì›ë¦¬ê¸ˆ ê· ë“± ìƒí™˜)
        // -----------------------------
        function calculateFinance(panelCount, sunHours){
          // íŒ¨ë„/ìš©ëŸ‰
          const moduleSelect = el("moduleSelect");
          const selectedOption = moduleSelect ? moduleSelect.selectedOptions[0] : null;
          const powerW = selectedOption ? Number(selectedOption.dataset.powerW || 0) : 0;
          const dcKw = panelCount * powerW / 1000;

          // ë°œì „ëŸ‰
          if(dcKw > 0 && typeof sunHours === "number"){
            const annualKwh = dcKw * sunHours * 365;
            el("summaryAnnualEnergy").textContent = annualKwh.toLocaleString("ko-KR");

            // ë‹¨ìˆœ ë§¤ì¶œ
            const pricePerKwh = Number(el("pricePerKwh")?.value || 120);
            const annualRevenue = annualKwh * pricePerKwh;
            el("resultAnnualRevenue").textContent = `${Math.round(annualRevenue).toLocaleString("ko-KR")}ì›`;

            // ì´ CAPEX
            const totalCapexEok = Number(el("financeTotalCapex")?.value || 3.0);
            const totalCapex = totalCapexEok * 100_000_000;

            // ë‹¨ìˆœ Payback
            if(annualRevenue > 0){
              const simplePayback = totalCapex / annualRevenue;
              el("resultPaybackSimple").textContent = `${simplePayback.toFixed(1)}ë…„`;
            }else{
              el("resultPaybackSimple").textContent = "-";
            }

            // LCOE (ë§¤ìš° ë‹¨ìˆœí™”: ì´ë¹„ìš© / ì´ë°œì „ëŸ‰)
            const operationYears = Number(el("operationYears")?.value || 20);
            const totalEnergy = annualKwh * operationYears;
            if(totalEnergy > 0){
              const omCost = Number(el("omCostPerYear")?.value || 50) * 1_000_000;
              const totalCost = totalCapex + omCost * operationYears;
              const lcoe = totalCost / totalEnergy;
              el("resultLCOE").textContent = `${Math.round(lcoe)}ì›/kWh`;
            }else{
              el("resultLCOE").textContent = "-";
            }

            // PFìš© DSCR ë“±ì€ ì„œë²„ì¸¡ì—ì„œ ì •êµí•˜ê²Œ ê³„ì‚°í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í‘œì‹œë§Œ ìœ ì§€
            logSystem("ë‹¨ìˆœ ê¸ˆìœµ/ROI ê³„ì‚° ì™„ë£Œ (í´ë¼ì´ì–¸íŠ¸)");
          }
        }

        window.calculateFinance = calculateFinance;

        // -----------------------------
        // í† ì§€ ë‹¨ê°€ í‘œì‹œ ê°±ì‹ 
        // -----------------------------
        window.refreshSolarLandEstimates = async function(){
          if(!currentAnalysisData.address || !currentAnalysisData.lat || !currentAnalysisData.lng) return;
          const info = await window.fetchLandEstimate(currentAnalysisData.address, currentAnalysisData.lat, currentAnalysisData.lng);
          if(!info) return;

          currentAnalysisData.land_price_won_per_m2 = info.land_price_won_per_m2;
          currentAnalysisData.area_m2 = info.area_m2;

          const card = el("landPriceCard");
          if(card) card.classList.remove("hidden");

          if(el("landPriceValue")) el("landPriceValue").textContent = info.land_price_won_per_m2
            ? `${Math.round(info.land_price_won_per_m2).toLocaleString("ko-KR")}ì›/ã¡`
            : "í™•ì¸ í•„ìš”";
          if(el("landAreaValue")) el("landAreaValue").textContent = info.area_m2
            ? info.area_m2.toLocaleString("ko-KR")
            : "-";
          if(el("landTotalPrice")){
            if(info.total_land_price_won){
              el("landTotalPrice").textContent = `${Math.round(info.total_land_price_won).toLocaleString("ko-KR")}ì›`;
            }else{
              el("landTotalPrice").textContent = "-";
            }
          }
        };

        // -----------------------------
        // ì´ˆê¸°í™”
        // -----------------------------
        function initHardwareOptions(){
          if(!BACKEND_URL){
            logSystem("hardware DB ë¡œë”© ìŠ¤í‚µ: BACKEND_URL ì—†ìŒ");
            return;
          }

          // ëª¨ë“ˆ
          fetch(`${BACKEND_URL}/api/hardware/modules`, {credentials:"include"})
            .then(r=>r.json().catch(()=>null))
            .then(j=>{
              const sel = el("moduleSelect");
              if(!sel || !j || !j.ok) return;
              sel.innerHTML = "";
              (j.data.items || []).forEach(m=>{
                const opt = document.createElement("option");
                opt.value = m.no;
                opt.dataset.powerW = m.power_w || 0;
                opt.textContent = `${m.brand} / ${m.model} (${m.power_w || "-"}W, íš¨ìœ¨ ${m.efficiency_pct || "-"}%)`;
                sel.appendChild(opt);
              });
            })
            .catch(e=>{
              logSystem(`ëª¨ë“ˆ DB ë¡œë”© ì‹¤íŒ¨: ${e.message}`);
            });

          // ì¸ë²„í„°
          fetch(`${BACKEND_URL}/api/hardware/inverters`, {credentials:"include"})
            .then(r=>r.json().catch(()=>null))
            .then(j=>{
              const sel = el("inverterSelect");
              if(!sel || !j || !j.ok) return;
              sel.innerHTML = "";
              (j.data.items || []).forEach(inv=>{
                const opt = document.createElement("option");
                opt.value = inv.no;
                opt.textContent = `${inv.brand} / ${inv.model} (${inv.capacity_kw || "-"}kW)`;
                sel.appendChild(opt);
              });
            })
            .catch(e=>{
              logSystem(`ì¸ë²„í„° DB ë¡œë”© ì‹¤íŒ¨: ${e.message}`);
            });
        }

        // -----------------------------
        // ì‹œìŠ¤í…œ ìƒíƒœë°” í…ìŠ¤íŠ¸
        // -----------------------------
        function initSystemStatus(){
          const t = el("systemStatusText");
          if(t){
            const backendShort = BACKEND_URL || "ë¯¸ì„¤ì •";
            t.textContent = `Backend: ${backendShort} Â· V-World ê¸°ë°˜ í›„ë³´ì§€ ìŠ¤ìº” Â· AI ë²•/ì¡°ë¡€ ì²´í¬`;
          }
        }

        // -----------------------------
        // ì´ˆê¸° ì‹¤í–‰
        // -----------------------------
        window.addEventListener("load", ()=>{
          initMap();
          initSidebarDrag();
          initTabs();
          initSystemStatus();
          checkLicense();
          initHardwareOptions();
          logSystem("Solar Pathfinder ì´ˆê¸°í™” ì™„ë£Œ");
        });
    </script>
</body>
</html>
