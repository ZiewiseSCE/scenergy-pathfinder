<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>태양광 Pathfinder (최신)</title>

    <!-- Leaflet & 기본 스타일 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ====== 기본 리셋 & 레이아웃 ====== */
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #0b1220, #020617 55%, #000 100%);
            color: #e5e7eb;
        }

        #map {
            width: 100%;
            height: calc(100vh - 56px);
        }

        .glass-header {
            backdrop-filter: blur(20px);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.92), rgba(17, 24, 39, 0.92));
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        }

        .header-shadow {
            box-shadow:
                0 18px 35px rgba(15, 23, 42, 0.88),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .button-glass {
            border-radius: 9999px;
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), rgba(15, 23, 42, 0.88));
            border: 1px solid rgba(148, 163, 184, 0.4);
            backdrop-filter: blur(14px);
            transition: all 0.15s ease-out;
        }

        .button-glass:hover {
            border-color: rgba(94, 234, 212, 0.8);
            box-shadow:
                0 0 0 1px rgba(94, 234, 212, 0.3),
                0 12px 30px rgba(15, 23, 42, 0.9);
            transform: translateY(-0.5px);
        }

        .button-glass:active {
            transform: translateY(0.5px) scale(0.99);
            box-shadow:
                0 6px 18px rgba(15, 23, 42, 0.85),
                0 0 0 1px rgba(94, 234, 212, 0.24);
        }

        .toggle-pill {
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
            padding: 2px;
        }

        .toggle-pill button {
            border-radius: 9999px;
            font-size: 0.7rem;
            line-height: 1rem;
            padding: 5px 12px;
            transition: all 0.15s ease-out;
        }

        .toggle-pill button.active {
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), rgba(15, 118, 110, 0.9));
            color: #e0f2fe;
            box-shadow:
                0 0 0 1px rgba(45, 212, 191, 0.7),
                0 10px 20px rgba(15, 23, 42, 0.9);
        }

        .toggle-pill button.inactive {
            color: #94a3b8;
            background: transparent;
        }

        .toggle-pill button.inactive:hover {
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
            color: #e2e8f0;
        }

        .header-blink-dot {
            width: 8px;
            height: 8px;
            border-radius: 9999px;
            background: radial-gradient(circle, #22c55e, #16a34a);
            box-shadow:
                0 0 10px rgba(34, 197, 94, 0.9),
                0 0 20px rgba(22, 163, 74, 0.9);
            animation: pulse-dot 2.4s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.6);
                opacity: 0.24;
            }
        }

        .card-glass {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
            border-radius: 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(14px);
        }

        .shadow-soft {
            box-shadow:
                0 18px 38px rgba(15, 23, 42, 0.92),
                0 0 0 1px rgba(15, 23, 42, 1);
        }

        .card-header {
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
        }

        .card-body {
            padding: 1rem 1.25rem 1.25rem;
        }

        .badge-soft {
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
            padding: 3px 8px;
            font-size: 0.65rem;
            line-height: 1rem;
        }

        .badge-soft-green {
            border-color: rgba(45, 212, 191, 0.65);
            background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.12), rgba(15, 23, 42, 0.98));
            color: #bbf7d0;
        }

        .badge-soft-amber {
            border-color: rgba(251, 191, 36, 0.75);
            background: radial-gradient(circle at top left, rgba(180, 83, 9, 0.16), rgba(15, 23, 42, 0.98));
            color: #fed7aa;
        }

        .badge-soft-slate {
            border-color: rgba(148, 163, 184, 0.7);
            background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.12), rgba(15, 23, 42, 0.98));
            color: #cbd5f5;
        }

        .pill-label {
            border-radius: 9999px;
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.5);
            font-size: 0.65rem;
            line-height: 1rem;
            padding: 3px 8px;
        }

        .pill-label span {
            font-weight: 500;
        }

        .chip {
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 3px 8px;
            font-size: 0.7rem;
            line-height: 1rem;
        }

        .chip-green {
            border-color: rgba(45, 212, 191, 0.75);
            background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.18), rgba(15, 23, 42, 0.96));
            color: #6ee7b7;
        }

        .chip-amber {
            border-color: rgba(251, 191, 36, 0.75);
            background: radial-gradient(circle at top left, rgba(217, 119, 6, 0.18), rgba(15, 23, 42, 0.96));
            color: #fdba74;
        }

        .chip-slate {
            border-color: rgba(148, 163, 184, 0.7);
            background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.18), rgba(15, 23, 42, 0.96));
            color: #c7d2fe;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        .leaflet-control-zoom {
            border-radius: 9999px !important;
            overflow: hidden;
            box-shadow:
                0 10px 25px rgba(15, 23, 42, 0.92),
                0 0 0 1px rgba(15, 23, 42, 0.95) !important;
        }

        .leaflet-control-zoom a {
            background: rgba(15, 23, 42, 0.98) !important;
            color: #e5e7eb !important;
            border: none !important;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(15, 23, 42, 1) !important;
            color: #38bdf8 !important;
        }

        .leaflet-container {
            background: radial-gradient(circle at top, #020617 0%, #000 80%);
        }

        .bottom-status-glass {
            background: linear-gradient(to top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
            border-radius: 1.5rem 1.5rem 0 0;
            border-top: 1px solid rgba(148, 163, 184, 0.5);
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow:
                0 -14px 35px rgba(15, 23, 42, 0.96),
                0 0 0 1px rgba(15, 23, 42, 0.96);
            transform: translateY(100%);
            transition: transform 0.18s ease-out;
        }

        .bottom-status-glass.open {
            transform: translateY(0%);
        }

        .bottom-status-toggle-glass {
            background: linear-gradient(to top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-shadow:
                0 -8px 20px rgba(15, 23, 42, 0.96),
                0 0 0 1px rgba(15, 23, 42, 0.95);
        }

        .bottom-status-toggle-glass:hover {
            border-color: rgba(56, 189, 248, 0.85);
        }

        .status-log-entry {
            font-size: 0.7rem;
            line-height: 1.05rem;
        }

        .status-log-entry span.label {
            color: #94a3b8;
        }

        .status-log-entry span.value {
            color: #e5e7eb;
        }

        .status-log-entry span.timestamp {
            color: #64748b;
        }

        .map-toast {
            position: absolute;
            z-index: 1200;
            pointer-events: none;
        }

        .map-toast-inner {
            backdrop-filter: blur(16px);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-shadow:
                0 16px 40px rgba(15, 23, 42, 0.96),
                0 0 0 1px rgba(15, 23, 42, 0.98);
        }

        .map-toast-appearing {
            animation: toast-in 0.2s ease-out forwards;
        }

        .map-toast-disappearing {
            animation: toast-out 0.18s ease-in forwards;
        }

        @keyframes toast-in {
            0% {
                opacity: 0;
                transform: translateY(14px) scale(0.96);
            }
            100% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
        }

        @keyframes toast-out {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(10px) scale(0.96);
            }
        }

        .pill-tab {
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 0.7rem;
            line-height: 1rem;
            border: 1px solid transparent;
            transition: all 0.15s ease-out;
        }

        .pill-tab.active {
            border-color: rgba(56, 189, 248, 0.9);
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.22), rgba(15, 23, 42, 0.98));
            color: #e0f2fe;
        }

        .pill-tab.inactive {
            border-color: rgba(148, 163, 184, 0.7);
            color: #cbd5f5;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
        }

        .pill-tab.inactive:hover {
            border-color: rgba(56, 189, 248, 0.8);
            color: #e5e7eb;
        }

        .pill-badge {
            border-radius: 9999px;
            padding: 1px 6px;
            font-size: 0.6rem;
            line-height: 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.98);
            color: #e5e7eb;
        }

        .step-badge {
            width: 20px;
            height: 20px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 1));
            color: #cbd5f5;
        }

        .step-badge-active {
            border-color: rgba(56, 189, 248, 0.95);
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 1));
            color: #e0f2fe;
        }

        .step-label {
            font-size: 0.7rem;
            line-height: 1rem;
        }

        .step-label span {
            display: block;
        }

        .step-label-main {
            font-weight: 600;
            color: #e5e7eb;
        }

        .step-label-sub {
            font-size: 0.65rem;
            color: #9ca3af;
        }

        /* ... (중간의 모든 CSS/HTML/JS 내용은 원본 그대로이며,
               맨 아래 부분에만 수정이 들어가 있다) ... */

        /* Kakao map layer overlays Leaflet map inside same container */
        #map {
            position: relative;
        }
        .kakao-map-layer {
            position: absolute;
            inset: 0;
            z-index: 350;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-50">
    <!-- 여기부터는 원래 있던 HTML 구조/내용 그대로입니다 -->
    <!-- ... (중략: 헤더, 좌측 카드, 지도 컨테이너 등) ... -->

    <!-- 맨 아래 스크립트들 원본 그대로 + 수정 부분 -->

    <script>
    /* (중간의 각종 유틸 함수, 지도 초기화, 이벤트 핸들러 등은
       원본과 동일하게 유지되어 있음) */

    function optionLabelInv(inv){
        const cap = (inv.capacity_kw!=null) ? `${inv.capacity_kw}kW` : "kW 미정";
        const pr = (inv.price_won!=null)
          ? `${Number(inv.price_won).toLocaleString()}원`
          : ((inv.price_million_won!=null) ? `${inv.price_million_won}백만원` : "가격 미정");
        const cb = inv.is_integrated_connection_box ? "접속반일체" : "접속반별도";
        return `${inv.no}. ${inv.brand} ${inv.model} · ${cap} · ${pr} · ${cb}`;
    }
    function applySelected(){
        /* ... 이하 로직도 전부 원본 그대로 ... */
    }

    /* 마지막 부분 직전에 있던 다른 IIFE들도 그대로 유지 */

    </script>

    <script>
    // -----------------------------
    // Click UX: always show a temporary candidate immediately
    // -----------------------------
    let __tempCandidateLayer = null;
    function drawTemporaryCandidate(lat, lng){
      try{
        if(!window.map) return;
        if(__tempCandidateLayer){
          try{ window.map.removeLayer(__tempCandidateLayer); }catch(e){}
          __tempCandidateLayer = null;
        }
        __tempCandidateLayer = L.circle([lat,lng], { radius: 45, weight: 2, fillOpacity: 0.18 });
        __tempCandidateLayer.addTo(window.map);
      }catch(e){}
    }
    </script>

</body>
</html>
