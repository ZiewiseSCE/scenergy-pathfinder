<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>íƒœì–‘ê´‘ Pathfinder - í†µí•© ë¶„ì„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="íƒœì–‘ê´‘ ë°œì „ ì‚¬ì—… ë¶€ì§€ ë¶„ì„ ë° PF ìˆ˜ì§€ ê²€í†  ë„êµ¬" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Turf.js for geometry operations -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf.min.js"></script>

    <!-- Kakao Maps SDKëŠ” JS í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë”© (autoload=false) -->

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #020617;
        color: #e5e7eb;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      #map { height: 100%; }
      .leaflet-container {
        background: #020617;
      }
      .leaflet-control-attribution {
        display: none;
      }
      .leaflet-control-zoom {
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.6);
        box-shadow: 0 10px 30px rgba(15,23,42,0.8);
      }
      .leaflet-control-zoom a {
        background-color: rgba(15,23,42,0.98);
        color: #e5e7eb;
      }
      .leaflet-control-zoom a:hover {
        background-color: rgba(30,64,175,0.9);
      }
      .leaflet-popup-content-wrapper {
        background: rgba(15,23,42,0.98);
        color: #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 10px 40px rgba(15,23,42,0.9);
        border: 1px solid rgba(148, 163, 184, 0.6);
      }
      .leaflet-popup-tip {
        background: rgba(15,23,42,0.98);
      }
      .leaflet-popup-content {
        margin: 8px 10px;
      }
      .leaflet-container a.leaflet-popup-close-button {
        color: #9ca3af;
      }
      .leaflet-container a.leaflet-popup-close-button:hover {
        color: #e5e7eb;
      }

      .map-floating-panel {
        box-shadow: 0 20px 60px rgba(15,23,42,0.90);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      .toast-enter {
        opacity: 0;
        transform: translateY(4px);
      }
      .toast-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 150ms ease-out, transform 150ms ease-out;
      }
      .toast-exit {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-exit-active {
        opacity: 0;
        transform: translateY(4px);
        transition: opacity 200ms ease-in, transform 200ms ease-in;
      }

      .slide-fade-enter {
        opacity: 0;
        transform: translateY(8px);
      }
      .slide-fade-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 200ms ease-out, transform 200ms ease-out;
      }
      .slide-fade-exit {
        opacity: 1;
        transform: translateY(0);
      }
      .slide-fade-exit-active {
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 200ms ease-in, transform 200ms ease-in;
      }

      .map-pill-tab {
        position: relative;
      }
      .map-pill-tab input[type="radio"] + span {
        transition: all 150ms ease-out;
      }
      .map-pill-tab input[type="radio"]:checked + span {
        background: radial-gradient(circle at 10% 20%, rgba(56,189,248,0.15) 0, rgba(37,99,235,0.16) 40%, rgba(15,23,42,0.9) 100%);
        color: #e5e7eb;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.9), 0 0 20px rgba(59, 130, 246, 0.6);
      }

      .target-toggle-btn {
        transition: all 150ms ease-out;
      }
      .target-toggle-btn.active {
        background: radial-gradient(circle at 10% 20%, rgba(251,191,36,0.2) 0, rgba(245,158,11,0.3) 20%, rgba(30,64,175,0.8) 100%);
        color: #f9fafb;
        box-shadow: 0 0 0 1px rgba(251,191,36,0.8), 0 0 25px rgba(245,158,11,0.85);
      }

      .kakao-map-layer {
        position: absolute;
        inset: 0;
        z-index: 210;
        pointer-events: none;
      }
      .kakao-map-layer.ready {
        pointer-events: auto;
      }

      .ai-bar {
        position: relative;
        overflow: hidden;
      }
      .ai-bar::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 0 0, rgba(96,165,250,0.25), transparent 50%),
                    radial-gradient(circle at 100% 0, rgba(52,211,153,0.25), transparent 55%),
                    radial-gradient(circle at 0 100%, rgba(244,114,182,0.22), transparent 50%);
        opacity: 0.18;
        pointer-events: none;
      }

      .ai-bar-inner {
        position: relative;
        z-index: 1;
      }

      .ai-pulse-dot {
        box-shadow: 0 0 0 0 rgba(96,165,250,0.9);
        animation: ai-pulse 1.4s infinite;
      }

      @keyframes ai-pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(96,165,250,0.7);
        }
        70% {
          transform: scale(1.12);
          box-shadow: 0 0 0 10px rgba(96,165,250,0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(96,165,250,0);
        }
      }

      .ai-shimmer {
        position: relative;
        overflow: hidden;
      }
      .ai-shimmer::after {
        content: "";
        position: absolute;
        top: 0;
        left: -150%;
        width: 150%;
        height: 100%;
        background: linear-gradient(120deg, transparent 0%, rgba(148,163,184,0.03) 35%, rgba(148,163,184,0.06) 50%, rgba(148,163,184,0.03) 65%, transparent 100%);
        transform: skewX(-12deg);
        animation: shimmer-move 2.4s infinite;
      }
      @keyframes shimmer-move {
        0% { left: -150%; }
        100% { left: 150%; }
      }

      .map-main-panel {
      }
      .map-main-panel-header {
      }
      .map-main-panel-content {
      }

      .modal-backdrop {
        background: radial-gradient(circle at 10% 10%, rgba(251,191,36,0.14) 0, transparent 55%),
                    radial-gradient(circle at 90% 10%, rgba(56,189,248,0.12) 0, transparent 55%),
                    radial-gradient(circle at 10% 90%, rgba(52,211,153,0.12) 0, transparent 55%),
                    rgba(15,23,42,0.92);
      }

      .bottom-status {
        transition: max-height 200ms ease-out, opacity 200ms ease-out;
        max-height: 0;
        opacity: 0;
      }
      .bottom-status.open {
        max-height: 240px;
        opacity: 1;
      }

      .map-badge {
        border-radius: 9999px;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        padding-top: 0.125rem;
        padding-bottom: 0.125rem;
        font-size: 0.75rem;
      }

      .map-badge-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
      }

      .map-slider-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 9999px;
        background: #4ade80;
        border: 2px solid #0f172a;
        box-shadow: 0 0 0 1px rgba(52,211,153,0.7);
        margin-top: -6px;
      }
      .map-slider-input::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 9999px;
        background: #4ade80;
        border: 2px solid #0f172a;
        box-shadow: 0 0 0 1px rgba(52,211,153,0.7);
      }

      .map-slider-input::-webkit-slider-runnable-track {
        height: 2px;
        border-radius: 9999px;
        background: linear-gradient(to right, rgba(34,197,94,0.8), rgba(59,130,246,0.8));
      }
      .map-slider-input::-moz-range-track {
        height: 2px;
        border-radius: 9999px;
        background: linear-gradient(to right, rgba(34,197,94,0.8), rgba(59,130,246,0.8));
      }

      .roof-gradient {
        background: linear-gradient(145deg, rgba(56,189,248,0.2), rgba(59,130,246,0.4), rgba(17,24,39,0.95));
      }

      .land-gradient {
        background: linear-gradient(145deg, rgba(251,191,36,0.25), rgba(22,163,74,0.38), rgba(15,23,42,0.96));
      }

      .map-tag-pill {
        border-radius: 9999px;
        font-size: 0.7rem;
        padding: 0.1rem 0.45rem;
      }

      .map-tag-pill-strong {
        border-radius: 9999px;
        font-size: 0.7rem;
        padding: 0.1rem 0.5rem;
        box-shadow: 0 0 0 1px rgba(251,191,36,0.8), 0 0 20px rgba(245,158,11,0.6);
      }

      .ai-check-pill {
        border-radius: 9999px;
        padding: 0.1rem 0.4rem;
        font-size: 0.7rem;
      }

      .ai-check-pill strong {
        font-weight: 700;
      }

      .panel-shadow-soft {
        box-shadow: 0 18px 50px rgba(15,23,42,0.9);
      }

      .map-outline-glow {
        box-shadow: 0 0 0 1px rgba(148,163,184,0.6), 0 0 0 3px rgba(15,23,42,1);
      }

      .map-target-btn {
        transition: all 150ms ease-out;
      }

      .map-target-btn.active {
        background: radial-gradient(circle at 10% 20%, rgba(251,191,36,0.18) 0, rgba(245,158,11,0.28) 15%, rgba(30,64,175,0.92) 100%);
        color: #f9fafb;
        box-shadow: 0 0 0 1px rgba(251,191,36,0.9), 0 0 25px rgba(245,158,11,0.95);
      }

      .map-target-btn span {
        position: relative;
        z-index: 1;
      }

      .settings-range-value {
        min-width: 3.4rem;
        text-align: right;
      }

      .settings-pill-count {
        min-width: 3.0rem;
        text-align: right;
      }

      .settings-expandable {
        transition: max-height 200ms ease-out, opacity 200ms ease-out, transform 200ms ease-out;
        max-height: 0;
        opacity: 0;
        transform: translateY(-4px);
        overflow: hidden;
      }
      .settings-expandable.open {
        max-height: 240px;
        opacity: 1;
        transform: translateY(0);
      }

      .kpx-grade-pill {
        border-radius: 9999px;
        padding: 0.125rem 0.5rem;
        font-size: 0.7rem;
      }

      .status-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
      }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased">
  <div id="toastContainer" class="fixed inset-x-0 top-4 z-[9999] flex flex-col items-center space-y-2 px-4 pointer-events-none"></div>

  <div class="flex flex-col md:flex-row h-screen overflow-hidden">
    <div class="w-full md:w-2/3 lg:w-[70%] h-[45vh] md:h-full relative bg-slate-950">
      <div id="map" class="w-full h-full"></div>

      <div id="kakaoMapLayer" class="kakao-map-layer hidden"></div>

      <div class="absolute top-3 left-3 right-3 md:left-6 md:right-auto flex flex-col gap-2 z-[500]">
        <div class="map-main-panel map-main-panel-header map-floating-panel rounded-2xl bg-slate-900/90 border border-slate-700/80 p-3 md:p-4 shadow-2xl">
          <div class="flex flex-wrap items-center gap-2 md:gap-3 mb-2 md:mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-amber-400/80 via-amber-500/70 to-rose-500/70 flex items-center justify-center shadow-lg shadow-amber-500/40 border border-amber-100/80">
                <div class="w-6 h-6 rounded-lg bg-slate-900/90 flex items-center justify-center text-xl">â˜€ï¸</div>
              </div>
              <div class="flex flex-col">
                <div class="flex items-center gap-2">
                  <h1 class="text-sm md:text-base font-semibold text-slate-50 tracking-tight">íƒœì–‘ê´‘ Pathfinder</h1>
                  <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/70 bg-emerald-500/10 px-2 py-[2px] text-[10px] font-medium text-emerald-200">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                    v2026 ì¸ì‚¬ì´íŠ¸+
                  </span>
                </div>
                <p class="text-[11px] md:text-[11px] text-slate-300/90 leading-tight mt-0.5">
                  ì£¼ì†Œë§Œ ì…ë ¥í•˜ë©´ <span class="font-semibold text-emerald-300">ì…ì§€Â·ê·œì œÂ·PF ìˆ˜ì§€</span>ê¹Œì§€ í•œ ë²ˆì— ê²€í† 
                </p>
              </div>
            </div>

            <div class="flex-1"></div>

            <div class="hidden md:flex items-center gap-1 text-[11px] text-slate-300 bg-slate-900/80 border border-slate-700/80 rounded-full px-2 py-1">
              <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-800/80 border border-slate-500/80 text-[10px] font-semibold text-emerald-300">AI</span>
              <span class="text-slate-300">ê·œì œÂ·PFÂ·ê³„í†µÂ·ë¦¬ìŠ¤í¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤</span>
            </div>
          </div>

          <div class="flex flex-col md:flex-row gap-2 md:gap-3">
            <div class="flex-1 min-w-0">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <span class="text-slate-400 text-base">ğŸ“</span>
                </div>
                <input
                  id="addressInput"
                  type="text"
                  placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  Enter ë˜ëŠ” ğŸ” ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš” (ì˜ˆ: ì „ë‚¨ í•´ë‚¨êµ° â€¦)"
                  class="w-full pl-8 pr-28 py-1.5 md:py-2 rounded-xl bg-slate-900/80 border border-slate-700/70 focus:border-emerald-400/70 focus:ring-1 focus:ring-emerald-400/50 text-[12px] md:text-[13px] placeholder-slate-500 outline-none"
                  autocomplete="off"
                />
                <div class="absolute inset-y-0 right-1 flex items-center gap-1">
                  <button
                    id="btnUseCurrentLocation"
                    type="button"
                    class="px-2 py-1 rounded-lg text-[10px] md:text-[11px] bg-slate-800/80 hover:bg-slate-700/90 border border-slate-600/80 text-slate-100 flex items-center gap-1"
                    onclick="tryGeolocate()"
                  >
                    <span>ğŸ“¡</span><span>ë‚´ ìœ„ì¹˜</span>
                  </button>
                  <button
                    id="btnSearchAddress"
                    type="button"
                    class="px-2.5 py-1 rounded-lg text-[11px] bg-emerald-500/90 hover:bg-emerald-400 text-slate-900 font-semibold flex items-center gap-1 shadow-sm"
                    onclick="searchAddress()"
                  >
                    <span>ğŸ”</span><span>ê²€ìƒ‰</span>
                  </button>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-1 md:gap-2">
              <div class="inline-flex rounded-full bg-slate-900/90 border border-slate-700/80 p-[2px] map-outline-glow">
                <label class="map-target-btn flex items-center gap-1 px-2 py-1 rounded-full text-[11px] cursor-pointer"
                       id="targetLandBtn">
                  <input type="radio" name="scanTarget" value="land" class="hidden" checked onchange="setScanTargetMode('land')" />
                  <span>ğŸï¸ í† ì§€ ê¸°ì¤€</span>
                </label>
                <label class="map-target-btn flex items-center gap-1 px-2 py-1 rounded-full text-[11px] cursor-pointer"
                       id="targetRoofBtn">
                  <input type="radio" name="scanTarget" value="roof" class="hidden" onchange="setScanTargetMode('roof')" />
                  <span>ğŸ¢ ì§€ë¶• ê¸°ì¤€</span>
                </label>
              </div>

              <button
                type="button"
                class="hidden md:inline-flex items-center gap-1 px-2.5 py-1 rounded-xl bg-slate-900/90 border border-slate-700/80 text-[11px] text-slate-100 hover:border-emerald-400/80 hover:text-emerald-100 transition"
                onclick="openSettingsModal()"
              >
                <span>âš™ï¸</span>
                <span>ìƒì„¸ ì„¤ì •</span>
              </button>
            </div>
          </div>
        </div>

        <div class="map-main-panel map-main-panel-header map-floating-panel rounded-2xl bg-slate-900/90 border border-slate-700/80 p-2 md:p-2.5 shadow-xl flex flex-wrap items-center gap-1.5 justify-between">
          <div class="flex items-center gap-1 text-[11px] text-slate-300">
            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 border border-slate-500 text-[10px]">â‘ </span>
            <span>ì§€ë„ì—ì„œ <span class="font-semibold text-emerald-300">ë¶€ì§€ ìœ¤ê³½(í´ë¦¬ê³¤)</span>ì„ ëŒ€ëµ ê·¸ë ¤ì£¼ì„¸ìš”.</span>
          </div>
          <div class="flex items-center gap-1 text-[11px] text-slate-300">
            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 border border-slate-500 text-[10px]">â‘¡</span>
            <span>ì£¼ì†Œ ê²€ìƒ‰ í›„ <span class="font-semibold text-emerald-300">í†µí•© ë¶„ì„</span>ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</span>
          </div>
          <div class="flex items-center gap-1 text-[11px] text-slate-300">
            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 border border-slate-500 text-[10px]">â‘¢</span>
            <span>ì•„ë˜ íŒ¨ë„ì—ì„œ <span class="font-semibold text-emerald-300">ì…ì§€Â·ê·œì œÂ·PF</span> ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span>
          </div>
        </div>
      </div>

      <div class="absolute bottom-3 left-3 right-3 md:left-6 md:right-auto flex flex-col gap-2 z-[500] pointer-events-none">
        <div class="map-floating-panel rounded-2xl bg-slate-900/95 border border-slate-700/80 shadow-2xl pointer-events-auto">
          <div class="flex items-center justify-between px-3 py-2 border-b border-slate-800/80">
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-slate-800/80 flex items-center justify-center text-sm">ğŸ“¡</div>
              <div class="flex flex-col">
                <div class="text-[11px] font-semibold text-slate-100 flex items-center gap-1">
                  <span>í˜„ì¬ ìœ„ì¹˜/ëŒ€ìƒ ë¶€ì§€</span>
                  <span id="mapTargetBadge" class="map-badge inline-flex items-center gap-1 bg-slate-800/80 border border-slate-600/80 text-[10px] text-slate-200">
                    <span class="map-badge-dot bg-emerald-400/90"></span>
                    <span>í† ì§€ ê¸°ì¤€</span>
                  </span>
                </div>
                <div class="text-[11px] text-slate-400">
                  <span id="currentCenterCoords" class="font-mono">-</span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="hidden md:flex items-center gap-1 text-[11px] text-slate-300 bg-slate-900/90 border border-slate-700/80 rounded-full px-2 py-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                <span id="mapStatusText">ì§€ë„ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í™•ëŒ€/ì¶•ì†Œí•´ì„œ ë¶€ì§€ë¥¼ ì°¾ìœ¼ì„¸ìš”</span>
              </div>
              <button
                type="button"
                class="inline-flex items-center gap-1 rounded-full bg-slate-900/90 border border-slate-700/80 px-2 py-1 text-[11px] text-slate-100 hover:border-emerald-400/80 transition"
                onclick="toggleBottomStatus()"
              >
                <span id="bottomStatusToggleIcon">â–½</span>
              </button>
            </div>
          </div>
          <div id="bottomStatusInner" class="bottom-status px-3 pb-3">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2 text-[11px]">
              <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                <div class="flex items-center justify-between">
                  <div class="text-slate-400 mb-0.5">ì¢Œí‘œ ê¸°ì¤€</div>
                  <div class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full bg-slate-800/80 border border-slate-600/80 text-[10px] text-slate-200">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                    <span>WGS84</span>
                  </div>
                </div>
                <div class="font-mono text-[11px] text-slate-100">
                  <div>ìœ„ë„: <span id="centerLat">-</span></div>
                  <div>ê²½ë„: <span id="centerLng">-</span></div>
                </div>
              </div>
              <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                <div class="text-slate-400 mb-0.5">í˜„ì¬ ë°°ê²½ì§€ë„</div>
                <div id="mapProviderLabel" class="text-[11px] font-semibold text-slate-100">VWorld ê¸°ë³¸</div>
                <div class="mt-1 flex items-center gap-1">
                  <button type="button" onclick="setMap('vworld')" class="px-2 py-0.5 text-[10px] rounded-full bg-slate-800/80 border border-slate-600/80 hover:border-emerald-400/80">ê¸°ë³¸</button>
                  <button type="button" onclick="setMap('satellite')" class="px-2 py-0.5 text-[10px] rounded-full bg-slate-800/80 border border-slate-600/80 hover:border-emerald-400/80">ìœ„ì„±</button>
                  <button type="button" onclick="setMap('kakao')" class="px-2 py-0.5 text-[10px] rounded-full bg-slate-800/80 border border-slate-600/80 hover:border-emerald-400/80">ì¹´ì¹´ì˜¤</button>
                </div>
              </div>
              <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                <div class="text-slate-400 mb-0.5">í´ë¦¬ê³¤ ë©´ì  ì¶”ì •</div>
                <div class="text-[11px] text-slate-100">
                  <div>ë©´ì : <span id="polyAreaM2">-</span> ã¡</div>
                  <div>ê·œëª¨: <span id="polyAreaP">-</span> í‰</div>
                  <div>DC ì¶”ì •: <span id="polyDcKw">-</span> kW</div>
                </div>
              </div>
              <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                <div class="text-slate-400 mb-0.5">ì§€ë„ ê·¸ë¦¬ê¸° ìƒíƒœ</div>
                <div class="text-[11px] text-slate-100">
                  <div>ëª¨ë“œ: <span id="drawingModeLabel">ëŒ€ê¸°</span></div>
                  <div>ê¼­ì§€ì : <span id="vertexCountLabel">0</span>ê°œ</div>
                </div>
                <div class="mt-1 flex items-center gap-1">
                  <button type="button" onclick="startPolygonDraw()" class="flex-1 px-2 py-0.5 text-[10px] rounded-full bg-emerald-500/90 text-slate-900 font-semibold hover:bg-emerald-400">ë¶€ì§€ ê·¸ë¦¬ê¸°</button>
                  <button type="button" onclick="resetPolygon()" class="px-2 py-0.5 text-[10px] rounded-full bg-slate-800/80 border border-slate-600/80 text-slate-200 hover:border-rose-400/80">ì´ˆê¸°í™”</button>
                </div>
              </div>
            </div>

            <div class="mt-2 text-[10px] text-slate-500 flex items-center justify-between">
              <div>â€» ë¶€ì§€ ìœ¤ê³½ì€ ëŒ€ëµì ìœ¼ë¡œë§Œ ê·¸ë¦¬ë©´ ë©ë‹ˆë‹¤. (ì¶”í›„ ì§€ì ë„ ì—°ë™ ì˜ˆì •)</div>
              <div class="flex items-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                <span id="bottomStatusHint">ì¢Œì¸¡ ìƒë‹¨ì—ì„œ ê²€ìƒ‰Â·ìƒì„¸ ì„¤ì •ì„ ì¡°ì •í•˜ì„¸ìš”.</span>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2 pointer-events-auto">
          <button
            type="button"
            class="inline-flex md:hidden items-center gap-1 px-2.5 py-1 rounded-xl bg-slate-900/90 border border-slate-700/80 text-[11px] text-slate-100 hover:border-emerald-400/80 transition"
            onclick="openSettingsModal()"
          >
            <span>âš™ï¸</span>
            <span>ìƒì„¸ ì„¤ì •</span>
          </button>

          <button
            type="button"
            class="inline-flex items-center gap-1 px-2.5 py-1 rounded-xl bg-slate-900/95 border border-emerald-500/80 text-[11px] text-emerald-100 hover:bg-emerald-500/10 hover:text-emerald-100 transition"
            onclick="toggleLayerMenu()"
          >
            <span>ğŸ—ºï¸</span>
            <span>ë ˆì´ì–´</span>
          </button>
        </div>

        <div id="layerMenuPanel" class="pointer-events-auto hidden">
          <div class="map-floating-panel rounded-2xl bg-slate-900/95 border border-slate-700/80 p-3 shadow-2xl">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-sm">ğŸ—ºï¸</span>
                <span class="text-[12px] font-semibold">ë ˆì´ì–´ / ë¶„ì„ ì˜µì…˜</span>
              </div>
              <button type="button" class="text-[11px] text-slate-400 hover:text-slate-200" onclick="toggleLayerMenu()">ë‹«ê¸°</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-[11px]">
              <label class="flex items-center gap-2 rounded-xl bg-slate-900/90 border border-slate-700/80 px-2 py-1.5 cursor-pointer">
                <input type="checkbox" id="chkShowCadastre" class="w-3 h-3 text-emerald-500 border-slate-600 rounded" onchange="toggleCadastreLayer()" />
                <div class="flex flex-col">
                  <span class="font-semibold">ì§€ì ë„(í† ì§€ ê²½ê³„)</span>
                  <span class="text-[10px] text-slate-400">í† ì§€ ê²½ê³„Â·ì§€ë²ˆì„ í™•ì¸í•©ë‹ˆë‹¤</span>
                </div>
              </label>
              <label class="flex items-center gap-2 rounded-xl bg-slate-900/90 border border-slate-700/80 px-2 py-1.5 cursor-pointer">
                <input type="checkbox" id="chkShowSlope" class="w-3 h-3 text-emerald-500 border-slate-600 rounded" onchange="toggleSlopeLayer()" />
                <div class="flex flex-col">
                  <span class="font-semibold">ê²½ì‚¬ë„</span>
                  <span class="text-[10px] text-slate-400">ê²½ì‚¬ë„ê°€ í° ì§€ì—­ì€ ë¶€ì í•©</span>
                </div>
              </label>
              <label class="flex items-center gap-2 rounded-xl bg-slate-900/90 border border-slate-700/80 px-2 py-1.5 cursor-pointer">
                <input type="checkbox" id="chkShowEnv" class="w-3 h-3 text-emerald-500 border-slate-600 rounded" onchange="toggleEnvLayer()" />
                <div class="flex flex-col">
                  <span class="font-semibold">í™˜ê²½Â·ë³´í˜¸êµ¬ì—­</span>
                  <span class="text-[10px] text-slate-400">ë³´í˜¸êµ¬ì—­Â·í™˜ê²½ ê·œì œ ê²¹ì¹¨ ì—¬ë¶€</span>
                </div>
              </label>
              <label class="flex items-center gap-2 rounded-xl bg-slate-900/90 border border-slate-700/80 px-2 py-1.5 cursor-pointer">
                <input type="checkbox" id="chkShowDistance" class="w-3 h-3 text-emerald-500 border-slate-600 rounded" onchange="toggleDistanceLayer()" />
                <div class="flex flex-col">
                  <span class="font-semibold">ì´ê²©ê±°ë¦¬</span>
                  <span class="text-[10px] text-slate-400">ì£¼ìš” ì´ê²©ê±°ë¦¬ ê·œì œ ê±°ë¦¬</span>
                </div>
              </label>
              <label class="flex items-center gap-2 rounded-xl bg-slate-900/90 border border-slate-700/80 px-2 py-1.5 cursor-pointer">
                <input type="checkbox" id="chkShowInfra" class="w-3 h-3 text-emerald-500 border-slate-600 rounded" onchange="toggleInfraLayer()" />
                <div class="flex flex-col">
                  <span class="font-semibold">í•œì „Â·ê³„í†µ</span>
                  <span class="text-[10px] text-slate-400">ì£¼ë³€ í•œì „ì„ ë¡œÂ·ë³€ì „ì†Œ</span>
                </div>
              </label>
              <label class="flex items-center gap-2 rounded-xl bg-slate-900/90 border border-slate-700/80 px-2 py-1.5 cursor-pointer">
                <input type="checkbox" id="chkShowShadow" class="w-3 h-3 text-emerald-500 border-slate-600 rounded" onchange="toggleShadowLayer()" />
                <div class="flex flex-col">
                  <span class="font-semibold">ìŒì˜Â·ì°¨í</span>
                  <span class="text-[10px] text-slate-400">ì£¼ë³€ ì‚°ë¦¼/ê±´ë¬¼ ìŒì˜ ìœ„í—˜</span>
                </div>
              </label>
            </div>

            <div class="mt-3 text-[10px] text-slate-500">
              â€» ë ˆì´ì–´ëŠ” ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ ì¸í—ˆê°€Â·ê°œë°œí–‰ìœ„ëŠ” ë°˜ë“œì‹œ ë³„ë„ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="w-full md:w-1/3 lg:w-[30%] h-[55vh] md:h-full bg-slate-950 border-t md:border-t-0 md:border-l border-slate-800/80 flex flex-col">
      <div class="px-3 py-2 md:px-4 md:py-3 border-b border-slate-800/80 bg-slate-950/95">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-lg bg-slate-900 flex items-center justify-center text-sm">ğŸ“Š</div>
            <div class="flex flex-col">
              <div class="text-[12px] font-semibold text-slate-100">í†µí•© ë¶„ì„ ê²°ê³¼</div>
              <div class="text-[10px] text-slate-400">
                ì£¼ì†ŒÂ·ë¶€ì§€ ìŠ¤ì¼€ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì…ì§€Â·ê·œì œÂ·PFë¥¼ ì¢…í•© ê²€í† í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
          <div class="flex items-center gap-1 text-[10px]">
            <button
              type="button"
              class="inline-flex items-center gap-1 rounded-full bg-slate-900 border border-slate-700 px-2 py-[3px] text-slate-200 hover:border-emerald-400/80"
              onclick="retryFullAnalysis()"
            >
              <span>ğŸ”</span>
              <span>ë‹¤ì‹œ ë¶„ì„</span>
            </button>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto bg-gradient-to-b from-slate-950 via-slate-950 to-slate-950/95">
        <div class="px-3 pt-3 pb-32 md:px-4 md:pt-4 md:pb-6 space-y-3 md:space-y-4">
          <div class="rounded-2xl bg-slate-900/90 border border-slate-800/90 panel-shadow-soft">
            <div class="ai-bar rounded-2xl overflow-hidden">
              <div class="ai-bar-inner px-3 py-2.5 md:px-4 md:py-3">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-gradient-to-br from-sky-400/80 via-emerald-400/80 to-blue-600/80 flex items-center justify-center shadow-lg shadow-blue-500/40 border border-sky-100/80">
                      <div class="w-5 h-5 rounded-full bg-slate-950 flex items-center justify-center text-[13px] text-sky-300">AI</div>
                    </div>
                    <div class="flex flex-col">
                      <div class="text-[11px] md:text-[12px] font-semibold text-slate-50 flex items-center gap-1">
                        <span>AI í†µí•© ì¸ì‚¬ì´íŠ¸</span>
                        <span id="aiAttractBadge" class="hidden map-tag-pill-strong bg-emerald-500/15 border border-emerald-400/70 text-emerald-100">
                          <span class="status-dot bg-emerald-400/90"></span>
                          <span id="aiAttractLabel">ë§¤ë ¥ë„ -</span>
                        </span>
                      </div>
                      <div class="text-[10px] text-slate-300/90">
                        ì…ì§€Â·ê·œì œÂ·PFÂ·ê³„í†µ ì •ë³´ë¥¼ ì¢…í•©í•œ í•œ ì¤„ ì½”ë©˜íŠ¸
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-1 text-[11px] text-slate-200">
                      <span class="text-[10px] text-slate-400">êµ¬ë§¤ë§¤ë ¥ë„</span>
                      <span id="finalScoreValue" class="text-[12px] font-semibold text-emerald-300">-</span>
                    </div>
                    <button
                      type="button"
                      class="inline-flex items-center gap-1 rounded-full bg-slate-900/90 border border-slate-700/80 px-2 py-[3px] text-[10px] text-slate-200 hover:border-emerald-400/80"
                      onclick="retryAIAnalysis()"
                    >
                      <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 ai-pulse-dot"></span>
                      <span>AI ì¬ë¶„ì„</span>
                    </button>
                  </div>
                </div>

                <div id="aiFinalPanel" class="mt-1 space-y-1.5">
                  <div class="text-[11px] text-slate-200">
                    <span id="aiFinalSummary" class="whitespace-pre-line leading-relaxed text-[11px]">
                      ë¶„ì„ ê²°ê³¼ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </span>
                  </div>
                  <div class="text-[10px] text-slate-300 leading-relaxed">
                    <span id="aiBusinessComment"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
            <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">ğŸ“</div>
                <div class="flex flex-col">
                  <div class="text-[11px] font-semibold text-slate-100">ê¸°ë³¸ ì •ë³´</div>
                  <div class="text-[10px] text-slate-400">ì£¼ì†ŒÂ·ìš©ë„Â·ì¼ì‚¬ëŸ‰Â·ê²½ì‚¬ ë“±</div>
                </div>
              </div>
              <div class="flex items-center gap-1 text-[10px] text-slate-400">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                <span>ì£¼ì†Œ ê¸°ì¤€ ìë™ ì±„ì›€</span>
              </div>
            </div>
            <div class="px-3 pb-3 md:px-4 md:pb-4 text-[11px] space-y-2.5">
              <div class="space-y-1">
                <div class="text-[10px] text-slate-400">ì£¼ì†Œ</div>
                <div id="basicAddress" class="text-[11px] text-slate-100 font-medium">-</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-[10px] text-slate-400">ìš©ë„ì§€ì—­ / ì§€ëª©</div>
                  <div id="basicZoning" class="text-[11px] text-slate-100">-</div>
                </div>
                <div>
                  <div class="text-[10px] text-slate-400">ê³ ë„Â·ê²½ì‚¬ë„(ì°¸ê³ )</div>
                  <div id="basicElevation" class="text-[11px] text-slate-100">-</div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <div class="text-[10px] text-slate-400">ì¼ì‚¬ëŸ‰/ê²½ì‚¬ê° ê¸°ì¤€</div>
                  <div id="basicSolar" class="text-[11px] text-slate-100">-</div>
                </div>
                <div>
                  <div class="text-[10px] text-slate-400">ì¶”ì • ë°œì „ìš©ëŸ‰(DC)</div>
                  <div id="basicCapacity" class="text-[11px] text-slate-100">-</div>
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
            <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">âš ï¸</div>
                <div class="flex flex-col">
                  <div class="text-[11px] font-semibold text-slate-100">8ëŒ€ í•µì‹¬ ì²´í¬</div>
                  <div class="text-[10px] text-slate-400">ìš©ë„Â·ì´ê²©Â·ì¡°ë¡€Â·ê²½ê´€Â·ì…ì§€Â·í™˜ê²½Â·ê²½ì‚¬Â·í•œì „</div>
                </div>
              </div>
              <div class="flex items-center gap-1 text-[10px] text-slate-400">
                <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
                <span>ë²•ë ¹Â·ì¡°ë¡€ ìë™ ìš”ì•½</span>
              </div>
            </div>
            <div id="checklistContainer" class="px-3 pb-3 md:px-4 md:pb-4 text-[11px] space-y-2.5">
              <div class="text-[10px] text-slate-400">
                ì£¼ì†Œì™€ í´ë¦¬ê³¤ì„ ê¸°ë°˜ìœ¼ë¡œ 8ëŒ€ í•µì‹¬ ë¦¬ìŠ¤í¬ë¥¼ ì ê²€í•©ë‹ˆë‹¤.
              </div>
              <div id="checklistItems" class="space-y-1.5"></div>
            </div>
          </div>

          <div class="rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
            <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">âš–ï¸</div>
                <div class="flex flex-col">
                  <div class="text-[11px] font-semibold text-slate-100">ë²•Â·ì¡°ë¡€ ì¸í—ˆê°€ ì‹œê·¸ë„</div>
                  <div class="text-[10px] text-slate-400">ê°œë°œí–‰ìœ„Â·ì…ì§€ ê°€ëŠ¥ì„±Â·ì¶”ê°€ ê²€í†  í¬ì¸íŠ¸</div>
                </div>
              </div>
              <div class="flex items-center gap-1 text-[10px] text-slate-400">
                <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                <span>ë²•ë ¹ API + AI</span>
              </div>
            </div>
            <div id="legalContainer" class="px-3 pb-3 md:px-4 md:pb-4 text-[11px] space-y-2.5">
              <div id="legalLoading" class="flex items-center gap-2 text-[10px] text-slate-400">
                <span class="inline-flex w-4 h-4 rounded-full border-2 border-slate-600 border-t-emerald-400 animate-spin"></span>
                <span>ì£¼ì†Œ ê¸°ì¤€ ê´€ë ¨ ë²•Â·ì¡°ë¡€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
              </div>
              <div id="legalContent" class="hidden space-y-2.5">
                <div class="text-[10px] text-slate-400">
                  ì¸í—ˆê°€ ê°€ëŠ¥ì„±, í—ˆìš© ì—¬ë¶€, ì¶”ê°€ í˜‘ì˜ í•„ìš” ì‚¬í•­ ë“±ì„ ìš”ì•½í•©ë‹ˆë‹¤.
                </div>
                <div id="legalSummary" class="text-[11px] text-slate-100 leading-relaxed whitespace-pre-line"></div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
            <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">ğŸ“ˆ</div>
                <div class="flex flex-col">
                  <div class="text-[11px] font-semibold text-slate-100">PF ìˆ˜ì§€ / í˜„ê¸ˆ íë¦„</div>
                  <div class="text-[10px] text-slate-400">í‘œì™€ ê·¸ë˜í”„ ê¸°ì¤€ìœ¼ë¡œ ì€í–‰ PF ê´€ì  ìˆ˜ì¹˜ ì •ë¦¬</div>
                </div>
              </div>
              <div class="flex items-center gap-1 text-[10px] text-slate-400">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                <span>ì‹¤ì‹œê°„ ê³„ì‚°</span>
              </div>
            </div>
            <div class="px-3 pb-3 md:px-4 md:pb-4 text-[11px] space-y-2.5">
              <div class="flex flex-wrap items-center justify-between gap-1">
                <div class="text-[10px] text-slate-400">
                  <span class="mr-2">â€» ê¸ˆì•¡ ë‹¨ìœ„: <span class="text-slate-200 font-semibold">ì²œì›</span> (KRW)</span>
                  <span class="text-slate-500">ì‹¤ì œ PF í˜‘ì˜ ì‹œ ì¡°ê±´ì€ ë³„ë„ ì¡°ìœ¨ í•„ìš”</span>
                </div>
                <button
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full bg-slate-900/90 border border-slate-700/80 px-2 py-[3px] text-[10px] text-slate-200 hover:border-emerald-400/80"
                  onclick="openSettingsModal()"
                >
                  <span>âš™ï¸</span>
                  <span>PF ê°€ì •ê°’ ì¡°ì •</span>
                </button>
              </div>

              <div class="overflow-x-auto">
    
    <table class="w-full text-[11px] border border-slate-700/60 table-fixed">
      <colgroup>
        <col style="width:12%">
        <col style="width:13%">
        <col style="width:14%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:11%">
        <col style="width:7%">
        <col style="width:7%">
      </colgroup>
      <thead>
        <tr>
          <th colspan="2" class="px-2 py-1 text-left font-bold border border-slate-700/60 bg-emerald-500/25">ì‚¬ì—…ë¹„</th>
          <th colspan="5" class="px-2 py-1 text-left font-bold border border-slate-700/60 bg-amber-300/25">ì†ìµ</th>
          <th colspan="3" class="px-2 py-1 text-left font-bold border border-slate-700/60 bg-emerald-500/25">í˜„ê¸ˆíë¦„</th>
        </tr>
        <tr class="text-slate-200">
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30">í•­ëª©</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">ê¸ˆì•¡</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30">í•­ëª©</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">25ë…„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">15ë…„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">ì—°ê°„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">ì›”ê°„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30">í•­ëª©</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">15ë…„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">25ë…„</th>
        </tr>
      </thead>
      
<tbody class="text-slate-100">
        <tr>
          <td class="px-2 py-1 border border-slate-700/60">í† ì§€ê°€ê²©</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_land_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ë§¤ì¶œì•¡(ì´ì•¡)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_rev_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_rev_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_rev_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_rev_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold">ì˜ì—…í™œë™</td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_op_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_op_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ëª¨ë“ˆ ì´ì•¡ (a)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_module_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê´€ë¦¬ë¹„ìš©1(ìœ ì§€ë³´ìˆ˜)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om1_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om1_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om1_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om1_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì˜ì—…ì´ìµ</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_op_profit_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_op_profit_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ì‹œê³µë¹„ ì´ì•¡ (b)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_const_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê´€ë¦¬ë¹„ìš©2(ê¸°íƒ€ìš´ì˜)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om2_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om2_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om2_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_om2_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê°ê°€ìƒê°ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_depr_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_depr_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60 font-semibold text-amber-100">ì„¤ë¹„ë¹„ ì´í•©ê³„ (a+b)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold text-amber-100"><span id="pf_capex_total_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê°ê°€ìƒê°ë¹„(ì¶”ì •)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_depr_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_depr_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_depr_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_depr_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60 text-rose-300 font-semibold">ì´ìë¹„ìš©</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-rose-300 font-semibold"><span id="cf_tbl_interest_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-rose-300 font-semibold"><span id="cf_tbl_interest_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ê¸°íƒ€ ê³µì‚¬ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_misc_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì˜ì—…ì´ìµ</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_op_profit_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_op_profit_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_op_profit_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pl_tbl_op_profit_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold">íˆ¬ìí™œë™</td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_inv_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_inv_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60 font-semibold text-amber-100">ì´ ì‚¬ì—…ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold text-amber-100"><span id="pf_capex_all_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60 text-emerald-100 font-semibold">ì´ìë¹„ìš©</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_interest_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_interest_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_interest_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_interest_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">í† ì§€êµ¬ì…</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_land_buy_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_land_buy_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60 font-semibold text-emerald-100">ëŒ€ì¶œê°€ëŠ¥ê¸ˆì•¡</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold text-emerald-100"><span id="pf_loan_amount_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60 text-emerald-100 font-semibold">ë²•ì¸ì„¸ì „ ì´ìµ</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_profit_bt_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_profit_bt_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_profit_bt_y_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right text-emerald-100 font-semibold"><span id="pl_tbl_profit_bt_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ëª¨ë“ˆêµ¬ì…</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_module_buy_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_module_buy_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60">ì‹œê³µë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_const_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_const_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60">ê¸°íƒ€ ìì‚°</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_misc_asset_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_misc_asset_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold">ì¬ë¬´í™œë™</td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_fin_pf_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold">ìˆœí˜„ê¸ˆíë¦„</td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_net_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_net_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ëŒ€ì¶œ ì‹¤í–‰(ì°¨ì…)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_loan_draw_pf_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60">í† ì§€</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_land_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_land_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ëŒ€ì¶œ ìƒí™˜</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_loan_repay_pf_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold">í† ì§€ì œì™¸ í˜„ê¸ˆíë¦„</td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_net_exland_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 bg-yellow-300/95 text-slate-900 font-bold text-right"><span id="cf_tbl_net_exland_25_k">0</span></td>
        </tr>
      </tbody>

    </table>

  </div>

  
  <div class="mt-3 rounded-2xl bg-emerald-900/70 border border-emerald-400/70 text-[11px] text-emerald-50 p-3 shadow-inner">
    <div class="flex items-center gap-2 mb-1">
      <span class="text-base">ğŸ“„</span>
      <span class="font-bold text-emerald-100">ì‚¬ì—… ìˆ˜ì§€ ë¶„ì„ ê²°ê³¼ ìš”ì•½</span>
    </div>
    <div id="pfAiSummary" class="text-[11px] leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto"></div>
  </div>

  
  <!-- legacy containers (kept for compatibility) -->
  <div id="resPfCapexSummary" class="hidden">0</div>
  <div id="resPfProfitSummary" class="hidden">0</div>
  <div id="resPfCashflowSummary" class="hidden">0</div>
</div>
</div>


                                        <div class="flex justify-between items-center mt-1">
                                          <span class="text-xs text-slate-400">â€» PF ê²°ê³¼ëŠ” ê°€ì •ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì‹¤ì œ ê¸ˆìœµ í˜‘ì˜ì™€ëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                                          <button
                                            type="button"
                                            class="ml-2 inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-900 border border-slate-700 text-[10px] text-slate-200 hover:border-emerald-400/80"
                                            onclick="openSettingsModal()"
                                          >
                                            <span>âš™ï¸</span>
                                            <span>PF ê°€ì •ê°’ ìˆ˜ì •</span>
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="mt-3 rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
                                    <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
                                      <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">ğŸ’°</div>
                                        <div class="flex flex-col">
                                          <div class="text-[11px] font-semibold text-slate-100">PF ì£¼ìš” ì§€í‘œ</div>
                                          <div class="text-[10px] text-slate-400">DSCR, íšŒìˆ˜ê¸°ê°„, LTV, í† ì§€ ë¹„ì¤‘ ë“±</div>
                                        </div>
                                      </div>
                                      <div class="flex items-center gap-1 text-[10px] text-slate-400">
                                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                                        <span>PF ê´€ì  í•µì‹¬ ìˆ˜ì¹˜</span>
                                      </div>
                                    </div>
                                    <div class="px-3 pb-3 md:px-4 md:pb-4 text-[11px] space-y-2.5">
                                      <div class="grid grid-cols-2 gap-2">
                                        <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                                          <div class="flex items-center justify-between mb-1">
                                            <div class="text-[10px] text-slate-400">DSCR(í‰ê· )</div>
                                            <div id="pfDscrBadge" class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">
                                              -
                                            </div>
                                          </div>
                                          <div class="text-[13px] font-semibold text-slate-100">
                                            <span id="pfDscrValue">-</span>
                                          </div>
                                          <div class="text-[10px] text-slate-400 mt-0.5">
                                            1.2 ì´ìƒì´ë©´ ì€í–‰ì‹¬ì‚¬ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì„ í˜¸
                                          </div>
                                        </div>
                                        <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                                          <div class="flex items-center justify-between mb-1">
                                            <div class="text-[10px] text-slate-400">íˆ¬ì íšŒìˆ˜ê¸°ê°„(ë‹¨ìˆœ)</div>
                                            <div class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">
                                              <span id="pfPaybackBadge">-</span>
                                            </div>
                                          </div>
                                          <div class="text-[13px] font-semibold text-slate-100">
                                            <span id="pfPaybackValue">-</span>
                                          </div>
                                          <div class="text-[10px] text-slate-400 mt-0.5">
                                            ëŒ€ëµ 10ë…„ ì´í•˜ë©´ ë¹„êµì  ì–‘í˜¸í•œ ìˆ˜ì¤€ìœ¼ë¡œ íŒë‹¨
                                          </div>
                                        </div>
                                      </div>

                                      <div class="grid grid-cols-2 gap-2">
                                        <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                                          <div class="flex items-center justify-between mb-1">
                                            <div class="text-[10px] text-slate-400">LTV(ëŒ€ì¶œ ë¹„ìœ¨)</div>
                                            <div id="pfLtvBadge" class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">
                                              -
                                            </div>
                                          </div>
                                          <div class="text-[13px] font-semibold text-slate-100">
                                            <span id="pfLtvValue">-</span>
                                          </div>
                                          <div class="text-[10px] text-slate-400 mt-0.5">
                                            60~80% êµ¬ê°„ì—ì„œ ì£¼ë¡œ í˜‘ì˜, ì‚¬ì—…Â·ë‹´ë³´ ì—¬ê±´ì— ë”°ë¼ ë‹¬ë¼ì§
                                          </div>
                                        </div>
                                        <div class="rounded-xl bg-slate-900 border border-slate-700/80 p-2">
                                          <div class="flex items-center justify-between mb-1">
                                            <div class="text-[10px] text-slate-400">í† ì§€ë¹„ ë¹„ì¤‘</div>
                                            <div id="pfLandShareBadge" class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">
                                              -
                                            </div>
                                          </div>
                                          <div class="text-[13px] font-semibold text-slate-100">
                                            <span id="pfLandShareValue">-</span>
                                          </div>
                                          <div class="text-[10px] text-slate-400 mt-0.5">
                                            í† ì§€ë¹„ê°€ ì´ ì‚¬ì—…ë¹„ì˜ 40% ì´í•˜ì´ë©´ ìƒëŒ€ì ìœ¼ë¡œ ë¶€ë‹´ì´ ëœí•¨
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="mt-3 rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
                                    <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
                                      <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">ğŸ”Œ</div>
                                        <div class="flex flex-col">
                                          <div class="text-[11px] font-semibold text-slate-100">í•œì „Â·ê³„í†µ ì¸í”„ë¼</div>
                                          <div class="text-[10px] text-slate-400">ì£¼ë³€ ì„ ë¡œÂ·ë³€ì „ì†ŒÂ·ìˆ˜ìš© ê°€ëŠ¥ì„±</div>
                                        </div>
                                      </div>
                                      <div class="flex items-center gap-1 text-[10px] text-slate-400">
                                        <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
                                        <span>KEPCO + AI ìš”ì•½</span>
                                      </div>
                                    </div>
                                    <div class="px-3 pb-3 md:px-4 md:pb-4 text-[11px] space-y-2.5">
                                      <div class="grid grid-cols-2 gap-2">
                                        <div>
                                          <div class="text-[10px] text-slate-400">ìµœê·¼ ì¡°íšŒ ê²°ê³¼</div>
                                          <div id="kepcoCapacity" class="text-[11px] text-slate-100">-</div>
                                        </div>
                                        <div>
                                          <div class="text-[10px] text-slate-400">ë¹„ê³ </div>
                                          <div id="kepcoNote" class="text-[11px] text-slate-100">-</div>
                                        </div>
                                      </div>
                                      <div>
                                        <div class="text-[10px] text-slate-400 mb-1">AI í•´ì„</div>
                                        <div id="kepcoAnalysis" class="text-[11px] text-slate-100 whitespace-pre-line leading-relaxed">
                                          -
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="mt-3 rounded-2xl bg-slate-900/95 border border-slate-800/90 panel-shadow-soft">
                                    <div class="px-3 py-2.5 md:px-4 md:py-3 border-b border-slate-800/80 flex items-center justify-between">
                                      <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center text-sm">ğŸ“</div>
                                        <div class="flex flex-col">
                                          <div class="text-[11px] font-semibold text-slate-100">ê°„ë‹¨ ë©”ëª¨</div>
                                          <div class="text-[10px] text-slate-400">í˜„ì¥ íŠ¹ì´ì‚¬í•­Â·í˜‘ì˜ ë©”ëª¨ ë“±ì„ ì ì–´ë‘ì„¸ìš”.</div>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="px-3 pb-3 md:px-4 md:pb-4 text-[11px]">
                                      <textarea
                                        id="userMemo"
                                        rows="3"
                                        class="w-full rounded-xl bg-slate-950/90 border border-slate-800/90 focus:border-emerald-400/80 focus:ring-1 focus:ring-emerald-400/60 text-[11px] text-slate-100 placeholder-slate-500 px-2.5 py-1.5"
                                        placeholder="ì˜ˆ) ë„ë¡œ ì ‘ê·¼ì„±ì€ ì–‘í˜¸í•˜ë‚˜, ì¼ë¶€ ê·¸ëŠ˜ ì˜ì—­ì´ ìˆì–´ ì¶”ê°€ ìŒì˜ ë¶„ì„ í•„ìš”. ì¸ê·¼ ì£¼ë¯¼ ë™ì˜ ì—¬ë¶€ í™•ì¸ ì˜ˆì •."
                                      ></textarea>
                                    </div>
                                  </div>
        </div>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="fixed inset-0 z-[600] hidden items-center justify-center">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative z-10 max-w-3xl w-full mx-3 md:mx-4 lg:mx-auto rounded-2xl bg-slate-950/95 border border-slate-800/90 shadow-2xl">
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800/80">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-xl bg-slate-800 flex items-center justify-center text-sm">âš™ï¸</div>
          <div class="flex flex-col">
            <div class="text-[13px] font-semibold text-slate-100">í†µí•© ë¶„ì„ ìƒì„¸ ì„¤ì •</div>
            <div class="text-[10px] text-slate-400">ë°œì „ì†Œ ê·œëª¨Â·ë‹¨ê°€Â·PF ì¡°ê±´ì„ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
        <button type="button" class="text-[11px] text-slate-400 hover:text-slate-100" onclick="closeSettingsModal()">âœ•</button>
      </div>
      <div class="px-4 pt-3 pb-4 max-h-[75vh] overflow-y-auto text-[11px] space-y-3">
        <div class="flex flex-wrap items-center justify-between gap-1">
          <div class="flex items-center gap-2">
            <span class="text-[11px] font-semibold text-slate-100">ê¸°ë³¸ ì‚¬ì—… ì„¤ì •</span>
            <span id="settingsTargetBadge" class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">
              -
            </span>
          </div>
          <button
            type="button"
            class="inline-flex items-center gap-1 rounded-full bg-slate-900/90 border border-slate-700/80 px-2 py-[3px] text-[10px] text-slate-200 hover:border-emerald-400/80"
            onclick="resetSettingsToDefault()"
          >
            <span>â†º</span>
            <span>ê¸°ë³¸ê°’ìœ¼ë¡œ</span>
          </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <div class="space-y-1">
            <div class="text-[10px] text-slate-400">ëª¨ë“ˆ ìš©ëŸ‰(DC)</div>
            <div class="flex items-center gap-2">
              <input
                id="projectDcKw"
                type="number"
                class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                step="1"
                min="0"
              />
              <span class="text-[10px] text-slate-400">kW</span>
            </div>
          </div>
          <div class="space-y-1">
            <div class="text-[10px] text-slate-400">ëª¨ë“ˆ ë‹¨ê°€(DC ê¸°ì¤€)</div>
            <div class="flex items-center gap-2">
              <input
                id="moduleUnitPrice"
                type="number"
                class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                step="10"
                min="0"
              />
              <span class="text-[10px] text-slate-400">ë§Œì›/kW</span>
            </div>
          </div>
          <div class="space-y-1">
            <div class="text-[10px] text-slate-400">ì‹œê³µ ë‹¨ê°€</div>
            <div class="flex items-center gap-2">
              <input
                id="constructionUnitPrice"
                type="number"
                class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                step="10"
                min="0"
              />
              <span class="text-[10px] text-slate-400">ë§Œì›/kW</span>
            </div>
          </div>
          <div class="space-y-1">
            <div class="text-[10px] text-slate-400">ê¸°íƒ€ ê³µì‚¬ë¹„(ì´ì•¡)</div>
            <div class="flex items-center gap-2">
              <input
                id="miscCapexTotal"
                type="number"
                class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                step="100"
                min="0"
              />
              <span class="text-[10px] text-slate-400">ë§Œì›</span>
            </div>
          </div>
          <div class="space-y-1">
            <div class="text-[10px] text-slate-400">ì˜ˆìƒ SMP+REC ë‹¨ê°€</div>
            <div class="flex items-center gap-2">
              <input
                id="electricityPrice"
                type="number"
                class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                step="1"
                min="0"
              />
              <span class="text-[10px] text-slate-400">ì›/kWh</span>
            </div>
          </div>
          <div class="space-y-1">
            <div class="text-[10px] text-slate-400">ì—°ê°„ ë°œì „ì‹œê°„(ë“±ê°€)</div>
            <div class="flex items-center gap-2">
              <input
                id="fullLoadHours"
                type="number"
                class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                step="10"
                min="0"
              />
              <span class="text-[10px] text-slate-400">ì‹œê°„/ë…„</span>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-800/80 pt-3 mt-1">
          <div class="flex flex-wrap items-center justify-between gap-1 mb-2">
            <div class="flex items-center gap-2">
              <span class="text-[11px] font-semibold text-slate-100">PF/ëŒ€ì¶œ ê°€ì •</span>
              <span class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">ì€í–‰ PF í˜‘ì˜ ì°¸ê³ ìš©</span>
            </div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ëŒ€ì¶œ ë¹„ìœ¨(LTV)</div>
              <div class="flex items-center gap-2">
                <input
                  id="loanToValuePct"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="1"
                  min="0"
                  max="100"
                />
                <span class="text-[10px] text-slate-400">%</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ëŒ€ì¶œ ê¸°ê°„</div>
              <div class="flex items-center gap-2">
                <input
                  id="pfTenorYears"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="1"
                  min="1"
                  max="25"
                />
                <span class="text-[10px] text-slate-400">ë…„</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ëŒ€ì¶œ ê¸ˆë¦¬</div>
              <div class="flex items-center gap-2">
                <input
                  id="pfInterestRate"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="0.1"
                  min="0"
                />
                <span class="text-[10px] text-slate-400">%/ë…„</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ìœ ì§€ë³´ìˆ˜ë¹„(ì—°)</div>
              <div class="flex items-center gap-2">
                <input
                  id="annualOandM"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="10"
                  min="0"
                />
                <span class="text-[10px] text-slate-400">ë§Œì›/ë…„</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ê¸°íƒ€ ê³ ì •ë¹„(ì—°)</div>
              <div class="flex items-center gap-2">
                <input
                  id="annualFixedCost"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="10"
                  min="0"
                />
                <span class="text-[10px] text-slate-400">ë§Œì›/ë…„</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ë²•ì¸ì„¸ìœ¨(ì°¸ê³ )</div>
              <div class="flex items-center gap-2">
                <input
                  id="corpTaxRate"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="1"
                  min="0"
                  max="50"
                />
                <span class="text-[10px] text-slate-400">%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-800/80 pt-3 mt-1">
          <div class="flex flex-wrap items-center justify-between gap-1 mb-2">
            <div class="flex items-center gap-2">
              <span class="text-[11px] font-semibold text-slate-100">í† ì§€Â·ì§€ë¶• ì˜µì…˜</span>
              <span class="map-tag-pill bg-slate-800/90 border border-slate-600/80 text-[10px] text-slate-200">ìê¸°ìë³¸Â·í† ì§€ë¹„ ê°€ì •</span>
            </div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">í† ì§€ ê°€ê²©(ì´ì•¡)</div>
              <div class="flex items-center gap-2">
                <input
                  id="landPriceTotal"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="100"
                  min="0"
                />
                <span class="text-[10px] text-slate-400">ë§Œì›</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ìê¸°ìë³¸(í† ì§€ ì™¸)</div>
              <div class="flex items-center gap-2">
                <input
                  id="equityAmount"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="100"
                  min="0"
                />
                <span class="text-[10px] text-slate-400">ë§Œì›</span>
              </div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-400">ê±´ë¬¼ ì„ëŒ€ë£Œ(ì§€ë¶•)</div>
              <div class="flex items-center gap-2">
                <input
                  id="roofRent"
                  type="number"
                  class="w-full rounded-lg bg-slate-950/90 border border-slate-800/90 px-2 py-1 text-[11px] text-slate-100"
                  step="10"
                  min="0"
                />
                <span class="text-[10px] text-slate-400">ë§Œì›/ë…„</span>
              </div>
            </div>
          </div>
        </div>

        <div class="pt-3 mt-1">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-1 text-[10px] text-slate-400">
              <span>ì„¤ì •ì„ ë³€ê²½í•˜ë©´ PF ìˆ˜ì§€Â·í˜„ê¸ˆ íë¦„ì´ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.</span>
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                class="inline-flex items-center gap-1 rounded-full bg-slate-900/90 border border-slate-700/80 px-2.5 py-[3px] text-[10px] text-slate-200 hover:border-emerald-400/80"
                onclick="closeSettingsModal()"
              >
                <span>ë‹«ê¸°</span>
              </button>
              <button
                type="button"
                class="inline-flex items-center gap-1 rounded-full bg-emerald-500/95 text-slate-900 px-3 py-[4px] text-[10px] font-semibold hover:bg-emerald-400"
                onclick="applySettingsAndRecalc()"
              >
                <span>ì ìš© ë° ì¬ê³„ì‚°</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
const BACKEND_URL = window.location.origin;
const backendBase = BACKEND_URL;

const FEATURE_LEVEL = "2026q1-plus";

  </script>

  <script>
    
let MAP;
let polygonsLayer;
let currentPolygon = null;
let currentMode = "land";

let kakaoMap = null;
let kakaoMapLoaded = false;
let kakaoMapsReady = false;

let vworldTileLayer;
let vworldSatelliteLayer;
let cadastreLayer;
let slopeLayer;
let envLayer;
let distanceLayer;
let infraLayer;
let shadowLayer;

let currentMapProvider = "vworld";

let kakaoJsKey = null;

let currentAnalysisData = {
  basic: null,
  checks: null,
  law: null,
  finance: null,
  ai_analysis: null,
};

let toastIdCounter = 0;
let bottomStatusOpen = false;

let _aiBarBusyCount = 0;

let hardwareMaster = null;


function el(id){
  return document.getElementById(id);
}

function showToast(message, options){
  try{
    const container = el("toastContainer");
    if(!container) return;

    const id = `toast-${++toastIdCounter}`;
    const div = document.createElement("div");
    div.id = id;
    div.className = "toast-enter pointer-events-auto max-w-md w-full bg-slate-900/95 border border-slate-700/80 rounded-xl px-3 py-2 text-[11px] shadow-xl";
    if(options && options.type === "error"){
      div.className += " border-rose-500/70";
    }else if(options && options.type === "success"){
      div.className += " border-emerald-500/70";
    }

    const icon = options && options.icon ? options.icon : (options && options.type === "error" ? "âš ï¸" : "ğŸ””");
    div.innerHTML = `
      <div class="flex items-start gap-2">
        <div class="mt-0.5">${icon}</div>
        <div class="flex-1 text-slate-100">${message}</div>
      </div>
    `;

    container.appendChild(div);

    requestAnimationFrame(()=>{
      div.classList.remove("toast-enter");
      div.classList.add("toast-enter-active");
    });

    const duration = (options && options.duration) || 2600;
    setTimeout(()=>{
      try{
        div.classList.remove("toast-enter-active");
        div.classList.add("toast-exit-active");
        setTimeout(()=>{
          try{
            if(div.parentNode){
              div.parentNode.removeChild(div);
            }
          }catch(e){}
        }, 220);
      }catch(e){}
    }, duration);
  }catch(e){
    console.error("showToast failed", e);
  }
}

function toggleLayerMenu(){
  try{
    const panel = el("layerMenuPanel");
    if(!panel) return;
    const willShow = panel.classList.contains("hidden");
    if(willShow){
      panel.classList.remove("hidden");
    }else{
      panel.classList.add("hidden");
    }
  }catch(e){
    console.error("toggleLayerMenu failed", e);
  }
}

document.addEventListener("click", function(evt){
  try{
    const panel = el("layerMenuPanel");
    if(!panel || panel.classList.contains("hidden")) return;
    const toggleButtons = evt.target.closest("button[onclick*='toggleLayerMenu']");
    if(toggleButtons) return;

    if(!panel.contains(evt.target)){
      panel.classList.add("hidden");
    }
  }catch(e){}
});

function toggleBottomStatus(){
  try{
    const inner = el("bottomStatusInner");
    const icon = el("bottomStatusToggleIcon");
    if(!inner || !icon) return;
    bottomStatusOpen = !bottomStatusOpen;
    if(bottomStatusOpen){
      inner.classList.add("open");
      icon.textContent = "â–³";
    }else{
      inner.classList.remove("open");
      icon.textContent = "â–½";
    }
  }catch(e){
    console.error("toggleBottomStatus failed", e);
  }
}

function setScanTargetMode(mode){
  try{
    if(mode !== "land" && mode !== "roof") mode = "land";
    currentMode = mode;

    const landRadio = document.querySelector("input[name='scanTarget'][value='land']");
    const roofRadio = document.querySelector("input[name='scanTarget'][value='roof']");
    if(landRadio) landRadio.checked = (mode === "land");
    if(roofRadio) roofRadio.checked = (mode === "roof");

    const landBtn = el("targetLandBtn");
    const roofBtn = el("targetRoofBtn");
    if(landBtn){
      if(mode === "land") landBtn.classList.add("active");
      else landBtn.classList.remove("active");
    }
    if(roofBtn){
      if(mode === "roof") roofBtn.classList.add("active");
      else roofBtn.classList.remove("active");
    }

    const badge = el("mapTargetBadge");
    if(badge){
      badge.innerHTML = "";
      const dot = document.createElement("span");
      dot.className = "map-badge-dot " + (mode === "land" ? "bg-emerald-400/90" : "bg-sky-400/90");
      const txt = document.createElement("span");
      txt.textContent = mode === "land" ? "í† ì§€ ê¸°ì¤€" : "ì§€ë¶• ê¸°ì¤€";
      badge.appendChild(dot);
      badge.appendChild(txt);
    }

    const settingsBadge = el("settingsTargetBadge");
    if(settingsBadge){
      settingsBadge.textContent = mode === "land" ? "í† ì§€ ê¸°ì¤€ ì„¤ì •" : "ì§€ë¶• ê¸°ì¤€ ì„¤ì •";
    }

    try{
      if(typeof window.toggleTarget === "function"){
        window.toggleTarget(mode);
      }
    }catch(e){}

    if(mode === "roof"){
      const roofRentInput = el("roofRent");
      if(roofRentInput && !roofRentInput.dataset._hintShown){
        roofRentInput.dataset._hintShown = "1";
        showToast("ì§€ë¶• ëª¨ë“œì—ì„œëŠ” í† ì§€ ê°€ê²© ëŒ€ì‹  ê±´ë¬¼ ì„ëŒ€ë£Œ ê°€ì •ì´ ë” ì¤‘ìš”í•©ë‹ˆë‹¤.", {type: "info", icon: "ğŸ¢"});
      }
    }
  }catch(e){
    console.error("setScanTargetMode failed", e);
  }
}

function openSettingsModal(){
  try{
    const modal = el("settingsModal");
    if(!modal) return;
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    _enforceNonNegativeSettingsInputs();
  }catch(e){
    console.error("openSettingsModal failed", e);
  }
}

function closeSettingsModal(){
  try{
    const modal = el("settingsModal");
    if(!modal) return;
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }catch(e){
    console.error("closeSettingsModal failed", e);
  }
}

function _enforceNonNegativeSettingsInputs(){
  try{
    const ids = [
      "projectDcKw", "moduleUnitPrice", "constructionUnitPrice", "miscCapexTotal",
      "electricityPrice", "fullLoadHours",
      "loanToValuePct", "pfTenorYears", "pfInterestRate",
      "annualOandM", "annualFixedCost", "corpTaxRate",
      "landPriceTotal", "equityAmount", "roofRent",
    ];
    ids.forEach((id)=>{
      const inp = el(id);
      if(!inp) return;
      inp.addEventListener("input", ()=>{
        try{
          if(inp.value === "" || inp.value === null) return;
          let v = Number(inp.value);
          if(isNaN(v) || v < 0){
            inp.value = "";
          }
        }catch(e){}
      }, {passive:true});
    });
  }catch(e){
    console.error("_enforceNonNegativeSettingsInputs failed", e);
  }
}

document.addEventListener("DOMContentLoaded", function(){
  try{
    _enforceNonNegativeSettingsInputs();
  }catch(e){}
});


async function loadClientConfig(){
  try{
    const res = await fetch(`${BACKEND_URL}/api/config/client`, {credentials: "same-origin"});
    if(!res.ok) throw new Error(`config HTTP ${res.status}`);
    const j = await res.json();
    if(j && j.ok){
      kakaoJsKey = j.kakao_js_key || null;
      if(kakaoJsKey){
        const s = document.createElement("script");
        s.src = "//dapi.kakao.com/v2/maps/sdk.js?appkey=" + encodeURIComponent(kakaoJsKey) + "&libraries=services&autoload=false";
        s.async = true;
        s.onerror = function(){
          console.error("Kakao SDK load error");
          showToast("ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", {type:"error"});
        };
        document.head.appendChild(s);
      }
    }
  }catch(e){
    console.error("loadClientConfig failed", e);
  }
}

function setMap(provider){
  try{
    if(!MAP) return;

    if(provider === currentMapProvider){
      return;
    }

    if(provider === "vworld"){
      if(kakaoMap){
        try{
          const center = kakaoMap.getCenter();
          const level = kakaoMap.getLevel();
          const lat = center.getLat();
          const lng = center.getLng();
          const leafletZoom = 18 - level;

          MAP.setView([lat, lng], leafletZoom);
        }catch(e){}
      }
      const layerDiv = el("kakaoMapLayer");
      if(layerDiv){
        layerDiv.classList.add("hidden");
        layerDiv.classList.remove("ready");
      }
      if(kakaoMap){
        kakaoMap = null;
      }
      if(!vworldTileLayer){
        vworldTileLayer = L.tileLayer(
          "https://api.vworld.kr/req/wmts/1.0.0/{key}/Base/{z}/{y}/{x}.png".replace("{key}", "Base"),
          {
            maxZoom: 19,
            minZoom: 7,
          }
        );
      }
      if(!MAP.hasLayer(vworldTileLayer)){
        MAP.addLayer(vworldTileLayer);
      }
      currentMapProvider = "vworld";
      const label = el("mapProviderLabel");
      if(label) label.textContent = "VWorld ê¸°ë³¸";
      showToast("VWorld ê¸°ë³¸ ì§€ë„ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.", {type:"info", icon:"ğŸ—ºï¸"});
      return;
    }

    if(provider === "satellite"){
      if(kakaoMap){
        try{
          const center = kakaoMap.getCenter();
          const level = kakaoMap.getLevel();
          const lat = center.getLat();
          const lng = center.getLng();
          const leafletZoom = 18 - level;
          MAP.setView([lat, lng], leafletZoom);
        }catch(e){}
      }
      const layerDiv = el("kakaoMapLayer");
      if(layerDiv){
        layerDiv.classList.add("hidden");
        layerDiv.classList.remove("ready");
      }
      if(kakaoMap){
        kakaoMap = null;
      }
      if(vworldTileLayer && MAP.hasLayer(vworldTileLayer)){
        MAP.removeLayer(vworldTileLayer);
      }
      if(!vworldSatelliteLayer){
        vworldSatelliteLayer = L.tileLayer(
          "https://map.pstatic.net/nrb/styles/satellite/256/{z}/{x}/{y}@2x?mt=bg.ol.ts.ar.lko",
          {
            maxZoom: 19,
            minZoom: 7,
          }
        );
      }
      if(!MAP.hasLayer(vworldSatelliteLayer)){
        MAP.addLayer(vworldSatelliteLayer);
      }
      currentMapProvider = "satellite";
      const label = el("mapProviderLabel");
      if(label) label.textContent = "ìœ„ì„±(ì°¸ê³ )";
      showToast("ìœ„ì„± ì§€ë„(ì°¸ê³ ìš©)ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.", {type:"info", icon:"ğŸ›°ï¸"});
      return;
    }

    if(provider === "kakao"){
      if(!window.kakao || !kakao.maps){
        showToast("ì¹´ì¹´ì˜¤ ì§€ë„ SDKê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", {type:"error"});
        return;
      }
      const layerDiv = el("kakaoMapLayer");
      if(!layerDiv){
        showToast("ì¹´ì¹´ì˜¤ ì§€ë„ ë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", {type:"error"});
        return;
      }

      if(!kakaoMapLoaded){
        kakao.maps.load(function(){
          kakaoMapLoaded = true;
          kakaoMapsReady = true;
          setTimeout(()=>{
            setMap("kakao");
          }, 10);
        });
        showToast("ì¹´ì¹´ì˜¤ ì§€ë„ ì—”ì§„ì„ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤...", {type:"info"});
        return;
      }

      if(typeof kakao.maps.Map !== "function" || typeof kakao.maps.LatLng !== "function"){
        showToast("ì¹´ì¹´ì˜¤ ì§€ë„ ì—”ì§„ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", {type:"error"});
        return;
      }

      if(vworldTileLayer && MAP.hasLayer(vworldTileLayer)){
        MAP.removeLayer(vworldTileLayer);
      }
      if(vworldSatelliteLayer && MAP.hasLayer(vworldSatelliteLayer)){
        MAP.removeLayer(vworldSatelliteLayer);
      }

      const center = MAP.getCenter();
      const zoom = MAP.getZoom();
      const level = Math.max(1, 18 - zoom);

      const kakaoCenter = new kakao.maps.LatLng(center.lat, center.lng);

      const mapContainer = el("kakaoMapLayer");
      const mapOption = {
        center: kakaoCenter,
        level: level,
      };

      kakaoMap = new kakao.maps.Map(mapContainer, mapOption);

      kakao.maps.event.addListener(kakaoMap, "idle", function(){
        try{
          const kc = kakaoMap.getCenter();
          const level = kakaoMap.getLevel();
          const leafletZoom = 18 - level;
          const lat = kc.getLat();
          const lng = kc.getLng();
          MAP.setView([lat, lng], leafletZoom, {animate:false});
        }catch(e){}
      });

      const mapDiv = document.getElementById("map");
      if(mapDiv){
        const z = parseInt(window.getComputedStyle(mapDiv).zIndex || "0", 10);
        mapDiv.style.zIndex = 200;
      }
      mapContainer.classList.remove("hidden");
      mapContainer.classList.add("ready");

      currentMapProvider = "kakao";
      const label = el("mapProviderLabel");
      if(label) label.textContent = "ì¹´ì¹´ì˜¤ ì§€ë„(ìœ„ì„±/ìŠ¤ì¹´ì´ë·°)";
      showToast("ì¹´ì¹´ì˜¤ ì§€ë„(ìœ„ì„±/ìŠ¤ì¹´ì´ë·°)ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.", {type:"info", icon:"ğŸ›°ï¸"});
      return;
    }

    showToast("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì§€ë„ íƒ€ì…ì…ë‹ˆë‹¤.", {type:"error"});
  }catch(e){
    console.error("setMap failed", e);
  }
}

function toggleCadastreLayer(){
  showToast("ì§€ì ë„ ë ˆì´ì–´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", {type:"info"});
}
function toggleSlopeLayer(){
  showToast("ê²½ì‚¬ë„ ë ˆì´ì–´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", {type:"info"});
}
function toggleEnvLayer(){
  showToast("í™˜ê²½Â·ë³´í˜¸êµ¬ì—­ ë ˆì´ì–´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", {type:"info"});
}
function toggleDistanceLayer(){
  showToast("ì´ê²©ê±°ë¦¬ ë ˆì´ì–´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", {type:"info"});
}
function toggleInfraLayer(){
  showToast("í•œì „Â·ê³„í†µ ë ˆì´ì–´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", {type:"info"});
}
function toggleShadowLayer(){
  showToast("ìŒì˜Â·ì°¨í ë ˆì´ì–´ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.", {type:"info"});
}

async function initHardwareDropdown(){
  try{
    if(hardwareMaster){
      return;
    }
    const res = await fetch(`${BACKEND_URL}/api/hardware/list`, {credentials:"same-origin"});
    if(!res.ok) throw new Error(`hardware HTTP ${res.status}`);
    const j = await res.json();
    if(j && j.ok){
      hardwareMaster = j.data || null;
    }
  }catch(e){
    console.error("initHardwareDropdown failed", e);
  }
}

document.addEventListener("DOMContentLoaded", function(){
  try{
    initHardwareDropdown();
  }catch(e){}
});

function updateMapStatusText(text){
  try{
    const elStatus = el("mapStatusText");
    if(!elStatus) return;
    elStatus.textContent = text;
  }catch(e){}
}

function updateBottomStatusCoords(lat, lng){
  try{
    const latEl = el("centerLat");
    const lngEl = el("centerLng");
    const coordEl = el("currentCenterCoords");
    if(latEl) latEl.textContent = (lat||0).toFixed(6);
    if(lngEl) lngEl.textContent = (lng||0).toFixed(6);
    if(coordEl) coordEl.textContent = `${(lat||0).toFixed(6)}, ${(lng||0).toFixed(6)}`;
  }catch(e){}
}

function startPolygonDraw(){
  showToast("í´ë¦¬ê³¤ ê·¸ë¦¬ê¸° ê¸°ëŠ¥ì€ ì¶”í›„ ë²„ì „ì—ì„œ ì œê³µë©ë‹ˆë‹¤. í˜„ì¬ëŠ” ëŒ€ëµì ì¸ ë©´ì ë§Œ í‘œì‹œë©ë‹ˆë‹¤.", {type:"info"});
}

function resetPolygon(){
  showToast("í´ë¦¬ê³¤ ì´ˆê¸°í™” ê¸°ëŠ¥ì€ ì¶”í›„ ë²„ì „ì—ì„œ ì œê³µë©ë‹ˆë‹¤.", {type:"info"});
}

function tryGeolocate(){
  try{
    if(!navigator.geolocation){
      showToast("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ì‚¬ìš©ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", {type:"error"});
      return;
    }
    navigator.geolocation.getCurrentPosition(function(pos){
      try{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        if(MAP){
          MAP.setView([lat, lng], 15);
        }
        updateBottomStatusCoords(lat, lng);
        showToast("í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.", {type:"success", icon:"ğŸ“¡"});
      }catch(e){}
    }, function(err){
      console.error("geolocation error", err);
      showToast("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", {type:"error"});
    });
  }catch(e){
    console.error("tryGeolocate failed", e);
  }
}

function searchAddress(){
  try{
    const inp = el("addressInput");
    if(!inp || !inp.value.trim()){
      showToast("ê²€ìƒ‰í•  ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", {type:"error"});
      return;
    }
    showToast("ì£¼ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥ì€ ì¶”í›„ ë²„ì „ì—ì„œ ìƒì„¸ ì œê³µ ì˜ˆì •ì…ë‹ˆë‹¤.", {type:"info"});
  }catch(e){
    console.error("searchAddress failed", e);
  }
}

function retryFullAnalysis(){
  showToast("í†µí•© ë¶„ì„ ì¬ì‹¤í–‰ ê¸°ëŠ¥ì€ ì¶”í›„ ë²„ì „ì—ì„œ ì •ì‹ ì œê³µë©ë‹ˆë‹¤.", {type:"info"});
}

function retryAIAnalysis(){
  showToast("AI ì¬ë¶„ì„ ê¸°ëŠ¥ì€ ì¶”í›„ ë²„ì „ì—ì„œ ìƒì„¸ ì œê³µë©ë‹ˆë‹¤.", {type:"info"});
}

function calculateFinance(){
  showToast("PF ìˆ˜ì§€ ê³„ì‚° ê¸°ëŠ¥ì€ ì¶”í›„ ë²„ì „ì—ì„œ ì •êµí•˜ê²Œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.", {type:"info"});
}

function applySettingsAndRecalc(){
  try{
    closeSettingsModal();
    calculateFinance();
  }catch(e){
    console.error("applySettingsAndRecalc failed", e);
  }
}

function resetSettingsToDefault(){
  try{
    const defaults = {
      projectDcKw: 1000,
      moduleUnitPrice: 70,
      constructionUnitPrice: 60,
      miscCapexTotal: 500,
      electricityPrice: 140,
      fullLoadHours: 1300,
      loanToValuePct: 70,
      pfTenorYears: 15,
      pfInterestRate: 6.5,
      annualOandM: 2000,
      annualFixedCost: 1000,
      corpTaxRate: 22,
      landPriceTotal: 30000,
      equityAmount: 20000,
      roofRent: 0,
    };
    for(const k in defaults){
      const input = el(k);
      if(input){
        input.value = defaults[k];
      }
    }
  }catch(e){
    console.error("resetSettingsToDefault failed", e);
  }
}

function _aiBarBusy(){
  try{
    _aiBarBusyCount++;
    const btn = document.querySelector("button[onclick='retryAIAnalysis()']");
    if(btn){
      btn.disabled = true;
      btn.classList.add("opacity-60");
      btn.textContent = "AI ë¶„ì„ ì¤‘...";
    }
  }catch(e){}
}

function _aiBarDone(){
  try{
    _aiBarBusyCount = Math.max(0, _aiBarBusyCount - 1);
    if(_aiBarBusyCount === 0){
      const btn = document.querySelector("button[onclick='retryAIAnalysis()']");
      if(btn){
        btn.disabled = false;
        btn.classList.remove("opacity-60");
        btn.textContent = "AI ì¬ë¶„ì„";
      }
    }
  }catch(e){}
}

function renderAiFinal(payload){
  try{
    const panel = el("aiFinalPanel");
    if(!panel) return;

    const sEl = el("finalScoreValue");
    const cEl = el("finalConfidence");
    const bEl = el("aiBusinessComment");
    const sumEl = el("aiFinalSummary");
    const pfSumEl = el("pfAiSummary");

    let summary = "";
    if(payload){
      summary = payload.ai_summary || payload.summary || "";
    }
    if(typeof summary === "string"){
      summary = summary.trim();
      if(summary.length > 800){
        summary = summary.slice(0, 800) + " ...";
      }
    }else{
      summary = "";
    }

    const score = (payload && typeof payload.attractiveness_score==="number") ? payload.attractiveness_score : null;
    const confidence = (payload && typeof payload.confidence==="number") ? payload.confidence : null;

    const comment = buildBusinessComment(payload || {});

    const shouldShow = !!summary || !!comment || (score !== null);
    if(!shouldShow){
      panel.classList.add("hidden");
      return;
    }
    panel.classList.remove("hidden");

    if(sEl){
      if(score===null){
        sEl.textContent = "-";
      }else{
        sEl.textContent = `${Math.max(0, Math.min(100, Math.round(score)))}ì `;
      }
    }
    if(cEl){
      cEl.textContent = "";
    }
    if(bEl){
      bEl.textContent = comment || "";
    }
    if(sumEl){
      sumEl.textContent = summary || "";
    }
    if(pfSumEl && summary){
      pfSumEl.textContent = summary;
    }
  }catch(e){
    console.error("renderAiFinal failed", e);
  }
}

function renderAIResult(payload){
}

function buildBusinessComment(payload){
  try{
    if(!payload) return "";
    let parts = [];
    if(typeof payload.pf_core_score === "number"){
      if(payload.pf_core_score >= 80) parts.push("PF ìˆ˜ì§€ ê´€ì ì—ì„œ ìƒë‹¹íˆ ì–‘í˜¸í•œ í¸ìœ¼ë¡œ, ê¸°ë³¸ì ì¸ ì‚¬ì—…ì„±ì€ ìš°ìˆ˜í•œ í¸ì…ë‹ˆë‹¤.");
      else if(payload.pf_core_score >= 60) parts.push("PF ìˆ˜ì§€ëŠ” ë³´í†µ ìˆ˜ì¤€ìœ¼ë¡œ, ì¡°ê±´ ì¡°ì •ì— ë”°ë¼ ì¶©ë¶„íˆ ê²€í†  ê°€ëŠ¥í•œ ì‚¬ì—…ì…ë‹ˆë‹¤.");
      else if(payload.pf_core_score >= 40) parts.push("PF ìˆ˜ì§€ëŠ” ë‹¤ì†Œ ì•„ì‰¬ìš´ í¸ìœ¼ë¡œ, ì‚¬ì—… êµ¬ì¡° ë˜ëŠ” ì¡°ê±´ ì¬ì¡°ì •ì´ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤.");
      else parts.push("PF ìˆ˜ì§€ ì¸¡ë©´ì—ì„œ ë¦¬ìŠ¤í¬ê°€ ìƒë‹¹íˆ ë†’ì€ í¸ì´ë¯€ë¡œ, êµ¬ì¡° ì¬ê²€í†  ë˜ëŠ” ë³´ìˆ˜ì  ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    }
    if(typeof payload.risk_regulation_adj === "number"){
      if(payload.risk_regulation_adj <= -8) parts.push("ê·œì œÂ·ì…ì§€Â·8ëŒ€ ì²´í¬ ê²°ê³¼, ì¸í—ˆê°€ ë° ì‚¬ì—… ì¶”ì§„ì— ì¤‘ìš”í•œ ì œì•½ ìš”ì¸ì´ ë‹¤ìˆ˜ ì¡´ì¬í•©ë‹ˆë‹¤.");
      else if(payload.risk_regulation_adj <= -4) parts.push("ê·œì œÂ·ì…ì§€ ì¸¡ë©´ì—ì„œ ëª‡ ê°€ì§€ ì£¼ì˜/ë³´ì™„ì´ í•„ìš”í•œ ìš”ì†Œê°€ ìˆìŠµë‹ˆë‹¤.");
      else if(payload.risk_regulation_adj >= 4) parts.push("ê·œì œÂ·ì…ì§€ ì¸¡ë©´ì—ì„œëŠ” ë¹„êµì  ìš°í˜¸ì ì¸ í¸ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.");
    }
    if(typeof payload.risk_kepco_adj === "number"){
      if(payload.risk_kepco_adj <= -8) parts.push("í•œì „Â·ê³„í†µ ì¸¡ë©´ì—ì„œëŠ” ìˆ˜ìš© ì—¬ë ¥ì´ ë§¤ìš° ì œí•œì ì´ê±°ë‚˜ ì‹ ê·œì„ ë¡œ ë“± ì¶”ê°€ ë¹„ìš© ì´ìŠˆê°€ ì˜ˆìƒë©ë‹ˆë‹¤.");
      else if(payload.risk_kepco_adj <= -4) parts.push("í•œì „Â·ê³„í†µ ì¸¡ë©´ì—ì„œ ì¼ë¶€ ì œì•½ ë˜ëŠ” ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•œ ì‹ í˜¸ê°€ ìˆìŠµë‹ˆë‹¤.");
    }
    return parts.join(" ");
  }catch(e){
    console.error("buildBusinessComment failed", e);
    return "";
  }
}

function initMap(){
  try{
    MAP = L.map("map", {
      center: [37.5665, 126.9780],
      zoom: 13,
      zoomControl: true,
      attributionControl: false,
    });

    vworldTileLayer = L.tileLayer(
      "https://map.pstatic.net/nrb/styles/basic/256/{z}/{x}/{y}@2x?mt=bg.ol.ts.ar.lko",
      {
        maxZoom: 19,
        minZoom: 7,
      }
    ).addTo(MAP);

    polygonsLayer = L.layerGroup().addTo(MAP);

    MAP.on("moveend", function(){
      try{
        const c = MAP.getCenter();
        updateBottomStatusCoords(c.lat, c.lng);
      }catch(e){}
    });

    const c = MAP.getCenter();
    updateBottomStatusCoords(c.lat, c.lng);
    updateMapStatusText("ë¶€ì§€ ì£¼ë³€ì„ í™•ì¸í•˜ë©´ì„œ ëŒ€ëµì ì¸ ìœ¤ê³½ì„ ìƒê°í•´ë³´ì„¸ìš”.");
  }catch(e){
    console.error("initMap failed", e);
  }
}

window.onload = function(){
  try{
    initMap();
  }catch(e){
    console.error("window.onload initMap failed", e);
  }
  try{
    loadClientConfig();
  }catch(e){
    console.error("window.onload loadClientConfig failed", e);
  }
};

  </script>
</body>
</html>
