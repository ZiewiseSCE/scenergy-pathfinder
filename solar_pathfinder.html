<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ Pathfinder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        
        /* ì„¤ì • ëª¨ë‹¬ ë’¤ ì–´ë‘ìš´ ë§‰ì„ ê±°ì˜ ì œê±°í•´ì„œ ì§€ë„ê°€ ë” ì˜ ë³´ì´ë„ë¡ */
        #settingsOverlay > .absolute.inset-0 {
          background-color: rgba(0,0,0,0.02) !important;
          backdrop-filter: blur(4px);
          -webkit-backdrop-filter: blur(4px);
        }

        /* Body ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ì„¤ì •í•´ì„œ ì§€ë„(Leaflet)ê°€ ë’¤ì—ì„œ ë³´ì´ë„ë¡ */
        body.bg-gray-100 {
          background-color: transparent !important;
        }

        #map { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; background: #0b1220; }
        
        /* ëª¨ë‹¬ ì•ˆì—ì„œ ì‚¬ì´ë“œë°”ë¥¼ ì •ìƒ ë¸”ë¡ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•œ override */
        #settingsOverlay #sidebar {
          position: relative;
          top: auto; left: auto; right: auto; bottom: auto;
          height: auto; max-height: none; width: 100%;
        }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: rgba(15, 23, 42, 0.05); }
        
        /* ìŠ¤í”¼ë„ˆ */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.8); }

        /* í•˜ë‹¨ ìƒíƒœ íŒ¨ë„ ì• ë‹ˆë©”ì´ì…˜ */
        #bottomStatusInner {
          transform: translateY(calc(100% - 32px));
          transition: transform 0.3s ease-out;
        }
        #bottomStatusInner.open {
          transform: translateY(0);
        }

        /* === Crystal Glass UI Styles === */
        /* ë©”ì¸ íŒ¨ë„ (ìœ ë¦¬ íš¨ê³¼) */
        .glass-main-panel {
          position: relative;
          background:
            radial-gradient(circle at 0% 0%, rgba(56,189,248,0.02), transparent 70%),
            radial-gradient(circle at 100% 100%, rgba(129,140,248,0.02), transparent 65%),
            linear-gradient(135deg, rgba(15,23,42,0.08), rgba(15,23,42,0.03));
          backdrop-filter: blur(22px) saturate(160%);
          -webkit-backdrop-filter: blur(22px) saturate(160%);
          border-radius: 1.2rem;
          border: 1px solid rgba(148,163,184,0.55);
          box-shadow: 0 18px 45px rgba(15,23,42,0.78), 0 0 0 1px rgba(15,23,42,0.72);
          overflow: hidden;
          color: #e9f2ff;
        }

        /* í—¤ë” (ìœ ë¦¬ íš¨ê³¼) */
        .glass-header {
          background:
            radial-gradient(circle at 0% 0%, rgba(56,189,248,0.35), transparent 55%),
            radial-gradient(circle at 100% 100%, rgba(236,72,153,0.32), transparent 55%),
            linear-gradient(135deg, rgba(15,23,42,0.45), rgba(15,23,42,0.08));
          backdrop-filter: blur(26px) saturate(160%);
          -webkit-backdrop-filter: blur(26px) saturate(160%);
          border-bottom: 1px solid rgba(148,163,184,0.80);
        }

        /* íƒ­ (ìœ ë¦¬ íš¨ê³¼) */
        .glass-tabs {
          background: linear-gradient(90deg, rgba(56,189,248,0.22), rgba(129,140,248,0.45), rgba(15,23,42,0.75));
          backdrop-filter: blur(18px);
          border-bottom: 1px solid rgba(148,163,184,0.65);
        }

        /* ë‚´ë¶€ ìš”ì†Œ ìœ ë¦¬ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
        .glass-main-panel .bg-white, .glass-main-panel .bg-slate-50, .glass-main-panel .bg-gray-50 {
          background-color: rgba(15,23,42,0.03) !important;
          color: #e9f2ff !important;
        }
        .glass-main-panel input, .glass-main-panel select {
          background-color: rgba(15,23,42,0.78) !important;
          border-color: rgba(148,163,184,0.75) !important;
          color: #e5f0ff !important;
        }
        .glass-main-panel label, .glass-main-panel .text-slate-700, .glass-main-panel .text-gray-700 {
          color: #e5edff !important;
        }

        /* 8ëŒ€ ì²´í¬ ìƒíƒœ ì»¬ëŸ¬ (ì¶”ê°€ë¨) */
        .checkRow { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; }
        .checkRow.pass .checkValue { color: #4ade80; font-weight: bold; }
        .checkRow.warn .checkValue { color: #facc15; font-weight: bold; }
        .checkRow.fail .checkValue { color: #f87171; font-weight: bold; }
        .checkTitle { color: #cbd5e1; font-weight: 600; width: 80px; }
        .checkValue { flex: 1; text-align: right; margin-right: 8px; }
        .checkMsg { display: none; } /* ê³µê°„ ì ˆì•½ ìœ„í•´ ë©”ì‹œì§€ëŠ” ìˆ¨ê¹€ */

        /* D-Pad Style */
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:active { transform: translateY(2px); box-shadow: none; }
        .crystal-dpad { background-color: rgba(15,23,42,0.6); backdrop-filter: blur(6px); border: 1px solid rgba(148,163,184,0.3); border-radius: 12px; }
    </style>
</head>
<body class="bg-gray-100">

    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="mode" id="form_mode">
        <input type="hidden" name="lat" id="form_lat">
        <input type="hidden" name="lng" id="form_lng">
        <input type="hidden" name="pnu" id="form_pnu">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="solar_opt" id="form_solar">
        <input type="hidden" name="land_estimate" id="form_land">
        <input type="hidden" name="land_price" id="form_price">
    </form>

    <div id="settingsOverlay" class="fixed inset-0 z-[1900] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/10 backdrop-blur-sm" onclick="window.closeSettingsModal()"></div>
        <div class="relative w-[96%] max-w-5xl max-h-[90vh] flex flex-col items-stretch overflow-y-auto pt-4 pb-4">
            <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200 glass-main-panel">
                <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0 glass-header">
                    <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ Pathfinder</h1>
                </div>
                <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm glass-tabs">
                    <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
                    <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
                    <button type="button" onclick="window.switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
                    <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
                </div>

                <div class="flex-1 overflow-y-auto bg-slate-50 glass-scroll p-4">
                    <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4 crystal-accordion">
                        <summary class="p-3 text-xs font-bold text-slate-800 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg">
                            <span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="p-3 space-y-3 border-t border-white text-xs param-body">
                            <div class="bg-white/60 p-2 rounded border border-slate-200">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆ ì„ íƒ</label>
                                        <select id="moduleSelect" class="w-full border p-1 rounded"></select>
                                        <div class="text-[10px] text-slate-400 mt-1" id="moduleMeta"></div>
                                    </div>
                                    <div>
                                        <label class="block mb-0.5 text-[10px] font-bold">ì¸ë²„í„° ì„ íƒ</label>
                                        <select id="inverterSelect" class="w-full border p-1 rounded"></select>
                                        <div class="text-[10px] text-slate-400 mt-1" id="inverterMeta"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px] text-red-400 font-bold">ì´ê²©ê±°ë¦¬(m)</label><input type="number" id="setbackDist" value="0.0" step="0.5" class="w-full border p-1 rounded text-center text-red-300 font-bold" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="mt-2">
                                    <label class="block mb-0.5 text-[10px] font-bold">íŒ¨ë„ ê°„ê²©(Row, m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()">
                                </div>
                                <input type="hidden" id="modPower" value="640"> </div>
                            <div class="bg-green-50 p-2 rounded border border-green-200">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆë‹¨ê°€(ì›/W)</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px]">ì‹œê³µë¹„(ë§Œ/kW)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2">
                                    <div><label class="block mb-0.5 text-[10px] text-blue-400 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px] text-red-400 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="pt-2">
                                    <label class="block mb-0.5 text-[10px] font-bold">PF ì›ê¸ˆ(ì›) (0=ìë™)</label>
                                    <input type="number" id="pfPrincipal" value="0" step="1000000" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()">
                                    <input type="checkbox" id="pfAutoPrincipal" checked class="hidden">
                                </div>
                            </div>
                        </div>
                    </details>

                    <div id="panel-scan" class="space-y-4">
                        <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500 scan-panel-crystal">
                            <h3 class="text-xs font-bold text-cyan-300">ì§€ì—­ ìë™ ìŠ¤ìº”</h3>
                            <div class="flex justify-between items-end">
                                <div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400 scan-timer">00:00:00</div>
                                <div class="text-right">
                                    <div id="progressCount" class="text-[10px] text-gray-300 font-mono">0 / 20</div>
                                </div>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden scan-progress-outer">
                                <div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500 scan-progress-inner" style="width: 0%"></div>
                            </div>
                            <div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div>
                            <div class="flex items-center gap-2 mb-2 mt-2">
                                 <input type="checkbox" id="autoFollow" class="w-4 h-4 rounded border-gray-600 bg-gray-700" checked>
                                 <label for="autoFollow" class="text-[10px] text-slate-300 cursor-pointer">ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</label>
                            </div>
                            <div class="grid grid-cols-2 gap-2 pt-1">
                                <button type="button" onclick="window.startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                                <button type="button" onclick="window.cancelMission(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ë¦¬ì…‹</button>
                            </div>
                        </div>
                    </div>

                    <div id="panel-analysis" class="hidden space-y-4">
                        <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                            <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right truncate w-40">-</span></div>
                                <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                                <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰(AC/DC):</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                                <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">í™•ì¸ í•„ìš”</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400">â˜€ï¸ ì¼ì‚¬ëŸ‰/ê°ë„:</span><span id="solarOpt" class="font-bold text-yellow-300 font-mono">í™•ì¸ í•„ìš”</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400">ğŸï¸ í† ì§€ê°€ê²©:</span><span id="landPrice" class="font-bold text-amber-300 font-mono">í™•ì¸ í•„ìš”</span></div>
                            </div>
                            <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600 text-xs">
                                <div class="flex justify-between"><span>ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                                <div class="flex justify-between"><span>ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                            </div>
                            <div class="bg-indigo-900/40 p-2 rounded border border-indigo-500/30 text-[10px] space-y-1">
                                <div class="flex justify-between"><span class="text-indigo-200">ğŸ¦ ì›” ìƒí™˜ì•¡:</span><span id="resMonthlyDebt" class="text-white font-bold">0 ì›</span></div>
                                <div class="flex justify-between"><span class="text-indigo-200">ğŸ’³ ì´ ì´ìë¹„ìš©:</span><span id="resTotalInterest" class="text-white font-bold">0 ì›</span></div>
                                <div class="flex justify-between items-center mt-2"><span class="text-slate-200">DSCR(1ë…„ì°¨):</span><span id="resDscr" class="text-white font-semibold">-</span></div>
                                <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span></div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                 <button type="button" onclick="window.saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition">ì €ì¥</button>
                                 <button type="button" onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition">ìƒì„¸ ë¦¬í¬íŠ¸</button>
                            </div>
                        </div>
                    </div>

                    <div id="panel-legal" class="hidden space-y-4">
                        <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                            <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> 8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­</h3>
                            
                            <div id="aiScorePanel" class="hidden mb-4 bg-transparent p-3 rounded border border-slate-600 mt-2">
                                 <div class="flex items-center justify-between mb-2">
                                     <span class="text-xs text-slate-300 font-bold">êµ¬ë§¤ë§¤ë ¥ë„ (AI Score)</span>
                                     <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                                 </div>
                                 <div class="w-full bg-slate-700 rounded-full h-2.5 mb-2 overflow-hidden">
                                     <div id="scoreBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                 </div>
                                 <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                            </div>

                            <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                                <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ 8ëŒ€ í•­ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                            </div>
                            <div id="legalLoading" class="hidden text-center py-10">
                                <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                                <p class="text-xs text-purple-300 animate-pulse">ìƒì„¸ ê·œì œ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                            </div>
                            <div id="aiChecksContainer" class="grid grid-cols-1 gap-2 mt-2"></div>
                            
                            <div id="legalContent" class="hidden space-y-2 mt-2">
                                 <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-history" class="hidden space-y-4">
                        <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-2 border-b pb-1">
                                <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                                <div class="flex gap-2">
                                    <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV ë‹¤ìš´</button>
                                    <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header class="absolute top-0 left-0 right-0 z-[1500] flex items-center justify-between px-4 py-3 pointer-events-none">
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="flex items-center gap-2 bg-transparent px-3 py-2 rounded-xl shadow-lg border border-slate-700/60 title-gradient">
                <img src="data:image/png;base64,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" alt="SC Energy Solution" class="h-7 w-auto rounded-sm shadow-sm" />
                <div class="leading-tight">
                    <div class="text-sm md:text-base font-bold text-slate-50 tracking-tight">SCEnergy íƒœì–‘ê´‘ Pathfinder</div>
                    <div class="text-[10px] md:text-[11px] text-slate-300">ì£¼ì†Œë¥¼ ì„ íƒí•˜ê³  íŒ¨ë„ì„ ë°°ì¹˜í•´ ë³´ì„¸ìš”.</div>
                </div>
            </div>
            <button type="button" onclick="window.openSettingsModal()" class="inline-flex items-center gap-2 rounded-full bg-slate-900/90 text-slate-50 text-xs md:text-sm px-3 py-2 shadow-lg border border-cyan-500/60 hover:bg-slate-800">
                <i class="ph ph-gear-six text-base md:text-lg text-cyan-300"></i><span class="font-semibold">ìƒì„¸ ì„¤ì •</span>
            </button>
        </div>

        <div class="pointer-events-auto flex-1 flex justify-center">
            <div class="inline-flex items-center gap-1 bg-slate-900/90 border border-slate-700/80 rounded-full px-1 py-1 shadow-lg">
                <button type="button" id="btnModeLand" onclick="window.setScanTargetMode('land')" class="px-3 py-1 text-[11px] md:text-xs rounded-full font-semibold flex items-center gap-1 bg-amber-500/10 text-amber-300 border border-transparent hover:bg-amber-400/20">
                    <i class="ph ph-tree"></i><span>í† ì§€</span>
                </button>
                <button type="button" id="btnModeRoof" onclick="window.setScanTargetMode('building')" class="px-3 py-1 text-[11px] md:text-xs rounded-full font-semibold flex items-center gap-1 text-slate-200 bg-slate-800/60 hover:bg-slate-700/80 border border-slate-600/60">
                    <i class="ph ph-building"></i><span>ì§€ë¶•</span>
                </button>
            </div>
        </div>

        <div class="pointer-events-auto flex items-center gap-3">
            <div class="bg-white/95 rounded-xl shadow-lg border border-slate-200 flex items-center px-2 py-1 w-[220px] md:w-[260px]">
                <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" class="flex-1 text-xs md:text-sm px-2 py-1 outline-none bg-transparent text-slate-700 font-medium" onkeypress="if(event.key==='Enter') window.searchAddress()">
                <button type="button" onclick="window.searchAddress()" class="px-2 py-1 rounded-lg bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800" aria-label="ì£¼ì†Œ ê²€ìƒ‰" title="ì£¼ì†Œ ê²€ìƒ‰">
                    <i class="ph ph-magnifying-glass font-bold"></i>
                </button>
            </div>
            <div class="relative">
                <button type="button" onclick="window.toggleLayerMenu(event)" class="h-10 w-10 rounded-full bg-slate-900/95 text-slate-100 flex items-center justify-center shadow-lg border border-slate-700 hover:bg-slate-800">
                    <i class="ph ph-stack text-xl"></i>
                </button>
                <div id="layerMenuPanel" class="hidden absolute right-0 mt-2 z-[1600]">
                    <div class="bg-white p-2 rounded-lg shadow-xl border border-gray-200 text-xs w-56">
                        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1"><i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •</div>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 rounded text-indigo-700 font-bold border border-indigo-200">
                            <input type="checkbox" id="multiSelectToggle" onchange="window.toggleMultiSelect()"><span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="autoScanToggle" onchange="window.toggleAutoScan()"><span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”(ì´ë™ì‹œ)</span>
                        </label>
                        <hr class="my-2 border-gray-200">
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="existingPlantToggle" onchange="window.toggleLayer('existing')" checked><span>ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘(ê°€ìƒ)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="substationToggle" onchange="window.toggleLayer('substation')" checked><span>ë³€ì „ì†Œ/ì„ ë¡œ(ì¤Œ 15~16)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="cadastralToggle" onchange="window.toggleLayer('cadastral')" checked><span>ì§€ì ë„ (VWorld)</span>
                        </label>
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="sat" checked onchange="window.setMap('sat')"><span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span></label>
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="base" onchange="window.setMap('base')"><span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="bottomStatusPanel" class="absolute left-0 right-0 bottom-0 z-[1450] pointer-events-none">
        <div id="bottomStatusInner" class="max-w-5xl mx-auto pb-2 pointer-events-auto">
            <div class="flex justify-center mb-1">
                <button type="button" onclick="window.toggleBottomStatus()" class="px-3 py-1 rounded-full bg-slate-900/80 border border-slate-600/80 shadow-lg text-[11px] text-slate-200 flex items-center gap-1">
                    <i id="bottomStatusHandleIcon" class="ph ph-caret-up text-xs"></i><span>ìƒíƒœ / ë¡œê·¸</span>
                </button>
            </div>
            <div class="bg-slate-900/95 text-slate-50 border-t border-slate-700 shadow-2xl rounded-t-2xl px-4 pt-2 pb-2 space-y-2">
                <div class="flex justify-between items-center text-[10px] text-slate-300">
                    <span class="font-semibold text-xs">Public Access</span>
                    <div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span><span class="text-[10px] text-emerald-300">System Ready</span></div>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-3 text-center text-[10px]">
                    <div class="bg-slate-900 rounded p-1 border border-slate-700"><div class="text-slate-500">Backend</div><div id="cnt-vworld" class="font-mono font-bold text-cyan-400 text-xs">0</div></div>
                    <div class="bg-slate-900 rounded p-1 border border-slate-700"><div class="text-slate-500">DB Sync (public)</div><div id="cnt-public" class="font-mono font-bold text-yellow-400 text-xs">0</div></div>
                    <div class="bg-slate-900 rounded p-1 border border-slate-700"><div class="text-slate-500">AI Analysis</div><div id="cnt-ai" class="font-mono font-bold text-purple-400 text-xs">0</div></div>
                </div>
                <div class="h-24 bg-slate-900 border-t border-slate-700 mt-2 flex flex-col text-[11px]">
                    <div class="px-3 py-1 flex items-center justify-between text-slate-300">
                        <div class="flex items-center gap-2"><i class="ph ph-activity"></i><span class="font-semibold text-[11px]">System Log</span></div>
                        <button type="button" onclick="window.clearLog && window.clearLog()" class="text-[10px] px-2 py-0.5 rounded bg-slate-800 border border-slate-600 hover:bg-slate-700">Clear</button>
                    </div>
                    <div class="flex-1 overflow-y-auto px-3 pb-2" id="logWindow"><div class="text-green-500">&gt; System Ready.</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText"></span></div>
    <div id="map">
        <div id="zoomIndicator" style="position:absolute; right:64px; bottom:34px; z-index:1200; background:rgba(0,0,0,0.7); color:#fff; padding:4px 10px; border-radius:10px; font-size:12px; pointer-events:none;">ğŸ” Zoom: -</div>
    </div>

    <div id="floatingDpadWrapper" class="absolute right-6 top-1/2 -translate-y-1/2 z-[1400] pointer-events-none">
        <div class="pointer-events-auto">
            <div class="crystal-dpad p-2 mb-2 text-slate-50">
                <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ë¯¸ì„¸ì¡°ì • (D-Pad)</span><button type="button" onclick="window.resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                    <div class="grid grid-cols-3 gap-2">
                        <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('up')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('up')" ontouchend="window.dpadHoldStop()">â–²</button><div></div>
                        <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('left')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('left')" ontouchend="window.dpadHoldStop()">â—€</button>
                        <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                        <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('right')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('right')" ontouchend="window.dpadHoldStop()">â–¶</button>
                        <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('down')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('down')" ontouchend="window.dpadHoldStop()">â–¼</button><div></div>
                    </div>
                    <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                        <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotL')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotL')" ontouchend="window.dpadHoldStop()">â†º íšŒì „</button>
                        <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotR')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotR')" ontouchend="window.dpadHoldStop()">â†» íšŒì „</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    /* =========================================================
       íƒœì–‘ê´‘ Pathfinder Upgrade (Features 1~5) - JS ONLY
       ========================================================= */
    const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";

    (function(){
      try{
        const qs = new URLSearchParams(window.location.search || "");
        const b = qs.get("backend");
        if (b) {
          let decoded = b;
          try { decoded = decodeURIComponent(b); } catch(e) {}
          window.BACKEND_URL = decoded.replace(/\/$/, "");
        }
      } catch(e) {}
      if (typeof window.BACKEND_URL !== "string") window.BACKEND_URL = "";
      window.BACKEND_URL = window.BACKEND_URL.replace(/\/$/, "");
    })();
    const BACKEND_URL = window.BACKEND_URL || "";
    const FEATURE_LEVEL = parseInt(new URLSearchParams(location.search).get("feat") || "5", 10);
    window.FEATURE_LEVEL = FEATURE_LEVEL;

    /* === 8ëŒ€ ì²´í¬ì‚¬í•­ í†µí•© ë¡œì§ === */
    async function fetchEightChecks() {
      try {
        if(!window.currentAnalysisData) return;
        const payload = {
          address: currentAnalysisData.address || null,
          lat: currentAnalysisData.lat,
          lng: currentAnalysisData.lng,
          pnu: currentAnalysisData.pnu || null,
          capacity_kw: currentAnalysisData.ac_kw || currentAnalysisData.acKW || null,
          slope_deg: currentAnalysisData.slope_deg || currentAnalysisData.slopeDeg || null,
          sun_hours: currentAnalysisData.sun_hours || currentAnalysisData.sunHours || null,
          dist_road_m: currentAnalysisData.dist_road_m || null,
          dist_residential_m: currentAnalysisData.dist_residential_m || null,
          area_m2: currentAnalysisData.area_m2 || currentAnalysisData.areaM2 || null
        };

        const res = await fetch(`${BACKEND_URL}/api/checks/analyze`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderEightChecks(data);
        if(document.getElementById("aiScore")) document.getElementById("aiScore").innerText = data.total_score;
        if(document.getElementById("aiConfidence")) document.getElementById("aiConfidence").innerText = data.confidence;
      } catch(e) {
        console.error(e);
        const el = document.getElementById("aiChecksContainer");
        if(el) el.innerHTML = `<div style="padding:14px;color:#ffcc66;font-size:11px;">8ëŒ€ ì²´í¬ ë¶„ì„ ì‹¤íŒ¨ (ì¶”ê°€ í™•ì¸ í•„ìš”)</div>`;
      }
    }

    function statusToClass(st){
      if(st==="PASS") return "pass";
      if(st==="FAIL") return "fail";
      return "warn";
    }

    function renderEightChecks(resp){
      const el = document.getElementById("aiChecksContainer");
      if(!el) return;
      const order = [
        ["zoning","ìš©ë„ì§€ì—­"],
        ["ecology","ìƒíƒœìì—°ë„"],
        ["heritage","ë¬¸í™”ì¬ ê·œì œ"],
        ["setback","ì´ê²©ê±°ë¦¬"],
        ["grid","í•œì „ ì—¬ìœ ìš©ëŸ‰"],
        ["slope","ê²½ì‚¬ë„"],
        ["insolation","ì¼ì‚¬ëŸ‰"],
        ["land_price","í† ì§€ê°€ê²©"],
      ];
      const list = resp.check_list || {};
      el.innerHTML = order.map(([k,title])=>{
        const it = list[k] || {status:"WARNING", value:"í™•ì¸ í•„ìš”", msg:""};
        return `
          <div class="checkRow ${statusToClass(it.status)}">
            <div class="checkTitle">${title}</div>
            <div class="checkValue">${escapeHtml(it.value || "")}</div>
            <div class="checkMsg">${escapeHtml(it.msg || "")}</div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* === Click UX: temporary candidate visual === */
    let __tempCandidateLayer = null;
    function drawTemporaryCandidate(lat, lng){
      try{
        if(!window.map) return;
        if(__tempCandidateLayer){
          try{ window.map.removeLayer(__tempCandidateLayer); }catch(e){}
          __tempCandidateLayer = null;
        }
        __tempCandidateLayer = L.circle([lat,lng], { radius: 45, weight: 2, fillOpacity: 0.18 });
        __tempCandidateLayer.addTo(window.map);
      }catch(e){}
    }

    /* === Main Logic continued... === */
    let map, layers, selectableGroup, panelGroup, analysisMarkerGroup, cadastralLayer, existingGroup, substationGroup;
    let scanTarget = "building";
    let autoScanMode = true;
    let isMultiSelectMode = false;
    let currentAnalysisFeature = null;
    let currentAnalysisData = {};
    let selectedFeatures = new Map();
    let calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 };
    let dpadHoldTimer = null;
    let panelDragHandle = null;
    let _dragStartLatLng = null;
    let scanLock = false;
    let missionRunning = false;
    let missionPaused = false;
    let missionStop = false;
    let missionTotalSteps = 20;
    let missionDoneSteps = 0;
    let missionDelayMs = 6000;
    let missionTotalMs = 0;
    let missionRemainingMs = 0;
    let missionLastTick = 0;
    let missionTimerInterval = null;
    let autoScanBox = null;
    let autoScanDebounce = null;

    function el(id){ return document.getElementById(id); }

    window.toggleAutoScan = function(){
      try{
        const cb = document.getElementById('autoScanToggle');
        autoScanMode = !!(cb && cb.checked);
        updateAutoScanBox();
        if(autoScanMode && window.map){
          const c = window.map.getCenter();
          scanBuildings(c.lat, c.lng, true);
        }
      }catch(e){ console.warn('toggleAutoScan failed', e); }
    };

    function getAnalysisLatLng(){
      if(typeof currentAnalysisData.lat === "number" && typeof currentAnalysisData.lng === "number"){
        return {lat: currentAnalysisData.lat, lng: currentAnalysisData.lng};
      }
      if(map){
        const c = map.getCenter();
        return {lat: c.lat, lng: c.lng};
      }
      return {lat: null, lng: null};
    }

    function polygonAreaM2(geo){
      try{
        if(!geo || geo.type !== "Polygon" || !Array.isArray(geo.coordinates)) return 0;
        const ring = geo.coordinates[0];
        if(!Array.isArray(ring) || ring.length < 3) return 0;
        let lat0 = 0;
        for(const p of ring){ lat0 += p[1]; }
        lat0 /= ring.length;
        const cos = Math.cos(lat0 * Math.PI/180);
        const sx = 111320 * cos;
        const sy = 110540;
        let area = 0;
        for(let i=0;i<ring.length-1;i++){
          const x1 = ring[i][0] * sx;
          const y1 = ring[i][1] * sy;
          const x2 = ring[i+1][0] * sx;
          const y2 = ring[i+1][1] * sy;
          area += (x1*y2 - x2*y1);
        }
        return Math.abs(area) / 2;
      }catch(e){ return 0; }
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function deg2rad(d){ return d * Math.PI / 180; }
    function cosd(d){ return Math.cos(deg2rad(d)); }

    function estimateSunHoursHeuristic(lat){
      if(typeof lat !== "number" || !isFinite(lat)) return 3.6;
      const t = clamp((lat - 33) / (38.5 - 33), 0, 1);
      return 3.9 - 0.5 * t;
    }

    function orientationFactor(lat, azimuthDeg, tiltDeg){
      if(typeof azimuthDeg !== "number" || !isFinite(azimuthDeg)) azimuthDeg = 180;
      if(typeof tiltDeg !== "number" || !isFinite(tiltDeg)) tiltDeg = 20;
      const optAz = 180;
      const optTilt = clamp((typeof lat === "number" && isFinite(lat)) ? (lat - 10) : 20, 10, 35);
      let azErr = Math.abs(azimuthDeg - optAz);
      azErr = azErr > 180 ? 360 - azErr : azErr;
      const tiltErr = Math.abs(tiltDeg - optTilt);
      const fAz = clamp(cosd(azErr), 0.7, 1.0);
      const fTilt = clamp(cosd(tiltErr * 0.7), 0.8, 1.0);
      return clamp(fAz * fTilt, 0.75, 1.0);
    }

    function fmtWon(v){
      if(typeof v !== "number" || !isFinite(v)) return "í™•ì¸ í•„ìš”";
      return Math.round(v).toLocaleString() + " ì›";
    }
    function formatWon(v){ return fmtWon(v); }

    function updateSolarOptUI(data){
      const elOpt = el("solarOpt");
      if(!elOpt) return;
      if(!data){ elOpt.innerText = "í™•ì¸ í•„ìš”"; return; }
      const sun = (typeof data.sun_hours === "number") ? data.sun_hours.toFixed(2) : null;
      const az  = (typeof data.azimuth_deg === "number") ? Math.round(data.azimuth_deg) : null;
      const tilt= (typeof data.tilt_deg === "number") ? Math.round(data.tilt_deg) : null;
      if(sun || az || tilt){
        const parts = [];
        if(sun) parts.push(`ì¼ì‚¬ ${sun}h`);
        if(az !== null) parts.push(`ë°©ìœ„ ${az}Â°`);
        if(tilt !== null) parts.push(`ê²½ì‚¬ ${tilt}Â°`);
        elOpt.innerText = parts.join(" / ");
      }else{ elOpt.innerText = "í™•ì¸ í•„ìš”"; }
    }

    function updateLandPriceUI(won){
      const elLP = el("landPrice");
      if(!elLP) return;
      elLP.innerText = fmtWon(won);
    }

    window.refreshSolarLandEstimates = async function(){
      if(!BACKEND_URL) return;
      const {lat, lng} = getAnalysisLatLng();
      if(typeof lat !== "number" || typeof lng !== "number") return;
      const address = currentAnalysisData.address || "í™•ì¸ í•„ìš”";
      const mode = currentAnalysisData.mode || "roof";
      try{
        const r = await postJson(`${BACKEND_URL}/api/solar/optimize`, {lat, lng, address, mode});
        if(r.ok && r.data && r.data.ok){
          currentAnalysisData.solar_opt = r.data;
          updateSolarOptUI(r.data);
          if(typeof r.data.sun_hours === "number"){
            window.calculateFinance(getTotalPanelCount(), r.data.sun_hours);
          }
        }
      }catch(e){}
      try{
        const areaM2 = (typeof currentAnalysisData.area_m2 === "number") ? currentAnalysisData.area_m2 : null;
        const areaPyeong = (areaM2 && areaM2 > 0) ? (areaM2 / 3.3058) : null;
        const payload = { address, pnu: currentAnalysisData.pnu || null, area_m2: areaM2, area_pyeong: areaPyeong };
        const r2 = await postJson(`${BACKEND_URL}/api/land/estimate`, payload);
        if(r2.ok && r2.data && r2.data.ok){
          currentAnalysisData.land_estimate = r2.data;
          const landWon = (typeof r2.data.land_price_won === "number") ? r2.data.land_price_won : null;
          updateLandPriceUI(landWon);
          if(currentAnalysisData.finance?.roi25y){
            currentAnalysisData.finance.roi25y.land_price_won = landWon;
          }
        }
      }catch(e){}
    };

    function showToast(msg){
      const t = el("toastMsg");
      const txt = el("toastText");
      if(!t || !txt) return;
      txt.innerText = msg;
      t.classList.remove("hidden");
      t.classList.add("flex");
      setTimeout(()=>{ t.classList.add("hidden"); t.classList.remove("flex"); }, 2800);
    }

    function logSystem(msg){
      const w = el("logWindow");
      if(!w) return;
      const p = document.createElement("div");
      p.innerText = `> ${msg}`;
      w.appendChild(p);
      w.scrollTop = w.scrollHeight;
    }

    function fmtHHMMSS(ms){
      ms = Math.max(0, Math.floor(ms));
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function safeText(v, fallback="í™•ì¸ í•„ìš”"){
      if(v === undefined || v === null) return fallback;
      const s = String(v).trim();
      return s ? s : fallback;
    }

    async function jsonpRequest(url){
      return new Promise((resolve, reject) => {
        const callbackName = `jsonp_${Date.now()}_${Math.floor(Math.random()*1e9)}`;
        window[callbackName] = (data) => {
          try { delete window[callbackName]; } catch(e) {}
          const script = document.getElementById(callbackName);
          if(script) script.remove();
          resolve(data);
        };
        const script = document.createElement("script");
        script.id = callbackName;
        script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
        script.onerror = () => {
          try { delete window[callbackName]; } catch(e) {}
          script.remove();
          reject(new Error("JSONP failed"));
        };
        document.body.appendChild(script);
      });
    }

    window.initMap = function(){
      if(map) return;
      map = L.map("map", { zoomControl: false }).setView([36.5, 127.5], 7);
      L.control.zoom({ position: "bottomright" }).addTo(map);

      function updateZoomIndicator(){
        try{
          const z = map.getZoom();
          const elz = document.getElementById("zoomIndicator");
          if(elz) elz.innerText = `ğŸ” Zoom: ${z}`;
        }catch(e){}
      }
      map.on("zoomend", updateZoomIndicator);
      map.on("moveend", updateZoomIndicator);
      updateZoomIndicator();

      layers = {
        base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`),
        sat:  L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
      };
      layers.sat.addTo(map);

      selectableGroup = L.layerGroup().addTo(map);
      panelGroup = L.layerGroup().addTo(map);
      analysisMarkerGroup = L.layerGroup().addTo(map);
      existingGroup = L.layerGroup().addTo(map);
      substationGroup = L.layerGroup().addTo(map);

      cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', {
        layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
        styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
        format: 'image/png',
        transparent: true,
        opacity: 0.7,
        key: VWORLD_TILE_KEY
      });
      map.addLayer(cadastralLayer);

      let _lastMapClickTs = 0;
      map.on("click", (e) => {
        if(FEATURE_LEVEL < 3) return;
        if(map.dragging && map.dragging._draggable && map.dragging._draggable._moving) return;
        const now = Date.now();
        if(now - _lastMapClickTs < 250) return;
        _lastMapClickTs = now;
        try{ drawTemporaryCandidate(e.latlng.lat, e.latlng.lng); }catch(_e){}
        setTimeout(()=>{
          try{ scanBuildings(e.latlng.lat, e.latlng.lng, true); }catch(err){ console.warn(err); }
        }, 60);
      });

      map.on("moveend", () => {
        try { updateAutoScanBox(); } catch(e) {}
        if(FEATURE_LEVEL < 4) return;
        if(!autoScanMode) return;
        const autoFollow = el("autoFollow");
        if(autoFollow && autoFollow.checked) return;
        if(autoScanDebounce) clearTimeout(autoScanDebounce);
        autoScanDebounce = setTimeout(() => {
          const c = map.getCenter();
          scanBuildings(c.lat, c.lng, true);
        }, 450);
      });

      try{
        const chk = document.getElementById("autoScanToggle");
        if(chk) chk.checked = true;
        if(typeof window.toggleAutoScan === "function") window.toggleAutoScan(true);
      }catch(e){}
    };

    window.setMap = function(t){
      if(!map) return;
      if(t === "base"){ map.addLayer(layers.base); map.removeLayer(layers.sat); }
      else { map.addLayer(layers.sat); map.removeLayer(layers.base); }
    };

    window.toggleLayer = function(type){
      if(!map) return;
      if(type === "cadastral"){
        const chk = el("cadastralToggle");
        if(chk.checked) map.addLayer(cadastralLayer);
        else map.removeLayer(cadastralLayer);
      }
    };

    window.switchTab = function(tab){
      const tabs = ["scan","analysis","legal","history"];
      for(const t of tabs){
        const tb = el(`tab-${t}`);
        const pn = el(`panel-${t}`);
        if(tb) tb.classList.remove("active");
        if(pn) pn.classList.add("hidden");
      }
      const tb = el(`tab-${tab}`);
      const pn = el(`panel-${tab}`);
      if(tb) tb.classList.add("active");
      if(pn) pn.classList.remove("hidden");
    };

    window.toggleSidebar = function(){
      const sb = el("sidebar");
      const btn = el("sidebar-toggle-btn");
      if(sb) sb.classList.toggle("collapsed");
      if(btn) btn.classList.toggle("collapsed");
    };

    window.toggleTarget = function(){
      if(FEATURE_LEVEL < 2){ showToast("feat<2: ëª¨ë“œ ì „í™˜ ë¹„í™œì„±"); return; }
      const radios = document.getElementsByName("scanTarget");
      for(const r of radios){
        if(r.checked){ scanTarget = (r.value === "land") ? "land" : "building"; break; }
      }
      clearResults(true);
      showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === "land" ? "í† ì§€" : "ì§€ë¶•"}`);
    };

    window.searchAddress = async function(){
      if(FEATURE_LEVEL < 1){ showToast("feat<1: ì£¼ì†Œê²€ìƒ‰ ë¹„í™œì„±"); return; }
      const input = el("addrInput");
      const q = (input ? input.value : "").trim();
      if(!q){ showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
      try{
        const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(q)}&refine=true&simple=false&type=road&key=${VWORLD_TILE_KEY}`;
        const data = await jsonpRequest(url);
        if(data?.response?.status === "OK"){
          const {x,y} = data.response.result.point;
          const lat = parseFloat(y), lng = parseFloat(x);
          map.setView([lat,lng], 18);
          showToast("ì£¼ì†Œ ì´ë™ ì™„ë£Œ");
          if(FEATURE_LEVEL >= 3){
            await new Promise(r=>setTimeout(r, 350));
            const res = await scanBuildings(lat, lng, true);
            if(res?.features?.length){ analyzeFeature(res.features[0], true); }
          }
        } else { showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"); }
      } catch(e){ showToast("ì£¼ì†Œê²€ìƒ‰ ì˜¤ë¥˜"); }
    };

    window.toggleMultiSelect = function(){
      const chk = el("multiSelectToggle");
      isMultiSelectMode = !!(chk && chk.checked);
      clearResults(true);
    };

    window.toggleAutoScan = function(){
      const chk = el("autoScanToggle");
      if(FEATURE_LEVEL < 4){
        if(chk) chk.checked = false;
        autoScanMode = false;
        showToast("feat<4: ìë™ ìŠ¤ìº” ë¹„í™œì„±");
        updateAutoScanBox();
        return;
      }
      autoScanMode = !!(chk && chk.checked);
      showToast(autoScanMode ? "ìë™ ìŠ¤ìº” ON" : "ìë™ ìŠ¤ìº” OFF");
      updateAutoScanBox();
    };

    function ensurePanelDragHandle(feature){
      try{
        if(!window.map || !feature?.geometry) return;
        if(panelDragHandle){ try{ window.map.removeLayer(panelDragHandle); }catch(e){} panelDragHandle = null; }
        const center = turf.center(feature).geometry.coordinates;
        const latlng = L.latLng(center[1], center[0]);
        const icon = L.divIcon({
          className:"",
          html:`<div style="width:28px;height:28px;border-radius:999px;background:rgba(34,211,238,0.95);border:2px solid rgba(15,23,42,0.9);box-shadow:0 6px 18px rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0f172a;">â†”</div>`,
          iconSize:[28,28],
          iconAnchor:[14,14]
        });
        panelDragHandle = L.marker(latlng, { icon, draggable:true });
        panelDragHandle.addTo(window.map);
        panelDragHandle.on("dragstart", (e)=>{ _dragStartLatLng = e.target.getLatLng(); try{ window.map.dragging.disable(); }catch(_e){} });
        panelDragHandle.on("dragend", (e)=>{
          try{ window.map.dragging.enable(); }catch(_e){}
          const end = e.target.getLatLng();
          const start = _dragStartLatLng || end;
          const eastRef = L.latLng(start.lat, end.lng);
          const northRef = L.latLng(end.lat, start.lng);
          const dx = window.map.distance(start, eastRef) * (end.lng >= start.lng ? 1 : -1);
          const dy = window.map.distance(start, northRef) * (end.lat >= start.lat ? 1 : -1);
          calibration.dx_m += dx;
          calibration.dy_m += dy;
          try{ if(typeof window.reCalculate === "function") window.reCalculate(); }catch(_e){}
          try{ const c = turf.center(currentAnalysisFeature).geometry.coordinates; e.target.setLatLng([c[1], c[0]]); }catch(_e){}
        });
      }catch(e){}
    }

    async function scanBuildings(lat, lng, force=false){
      if(!map) return null;
      if(scanLock && !force) return null;
      scanLock = true;
      let fetchedFeatures = [];
      try{
        if(!isMultiSelectMode){
          selectableGroup.clearLayers();
          panelGroup.clearLayers();
          selectedFeatures.clear();
          currentAnalysisFeature = null;
          resetCalibrationInternal(false);
          const rc = el("resultCard"); if(rc) rc.classList.add("hidden");
          const lp = el("legalPlaceholder"); const lc = el("legalContent"); const sp = el("aiScorePanel");
          if(lp) lp.classList.remove("hidden"); if(lc) lc.classList.add("hidden"); if(sp) sp.classList.add("hidden");
        }
        analysisMarkerGroup.clearLayers();
        L.marker([lat,lng]).addTo(analysisMarkerGroup);
        const z = map.getZoom();
        const d = (z >= 17) ? 0.0016 : (z >= 16 ? 0.0028 : 0.0042);
        const box = `${lng - d},${lat - d},${lng + d},${lat + d}`;
        const dataName = (scanTarget === "land") ? "LP_PA_CBND_BUBUN" : "LT_C_SPBD";
        const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${dataName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=${(z>=17)?80:(z>=16?120:180)}`;
        const data = await jsonpRequest(url);
        const fc = data?.response?.result?.featureCollection;
        fetchedFeatures = fc?.features || [];
        L.geoJSON(fetchedFeatures, {
          style: (scanTarget === "land") ? { color:"#8d6e63", weight:2, fillColor:"#8d6e63", fillOpacity:0.25 } : { color:"#3b82f6", weight:2, fillOpacity:0.20 },
          onEachFeature: (feature, layer) => { layer.on("click", (e) => { L.DomEvent.stopPropagation(e); analyzeFeature(feature, true); }); }
        }).addTo(selectableGroup);
        const found = el("foundCount"); if(found) found.innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${selectableGroup.getLayers().length}ê°œ`;
        return { features: fetchedFeatures, count: fetchedFeatures.length };
      } catch(e){ return null; } finally { setTimeout(()=>{ scanLock = false; }, 500); }
    }

    function metersToKm(m){ return (m || 0) / 1000; }
    function applyCalibrationToFC(fc){
      if(!window.turf || !fc) return fc;
      let out = turf.clone(fc);
      if(calibration.rot_deg){ try { out = turf.transformRotate(out, calibration.rot_deg); } catch(e) {} }
      if(calibration.dx_m){ try { out = turf.transformTranslate(out, metersToKm(calibration.dx_m), 90, {units:"kilometers"}); } catch(e) {} }
      if(calibration.dy_m){ try { out = turf.transformTranslate(out, metersToKm(calibration.dy_m), 0, {units:"kilometers"}); } catch(e) {} }
      return out;
    }

    function buildPanelsFCFromGeometry(geo){
      const fallback = () => {
        let bbox = null; try { bbox = turf.bbox(turf.feature(geo)); } catch(e) {}
        if(!bbox){ const c = map.getCenter(); bbox = [c.lng-0.0004, c.lat-0.0004, c.lng+0.0004, c.lat+0.0004]; }
        const lat = (bbox[1] + bbox[3]) / 2; const mpdLng = 111320 * Math.cos(lat * Math.PI / 180); const mpdLat = 111000;
        const w = 1.13 / mpdLng; const h = 2.2 / mpdLat;
        const feats = [];
        for(let i=0;i<3;i++){ for(let j=0;j<3;j++){ const x = bbox[0] + i*w*1.3; const y = bbox[1] + j*h*1.3; feats.push(turf.bboxPolygon([x,y,x+w,y+h])); } }
        return { type:"FeatureCollection", features: feats };
      };
      if(!window.turf) return fallback();
      const isPoly = geo && (geo.type === "Polygon" || geo.type === "MultiPolygon");
      if(!isPoly) return fallback();
      let poly = turf.feature(geo);
      let setback = 0; const sb = el("setbackDist"); if(sb) setback = parseFloat(sb.value || "0") || 0;
      if(setback > 0){ try{ const shrunk = turf.buffer(poly, -setback, {units:"meters"}); if(shrunk && shrunk.geometry) poly = shrunk; else return fallback(); } catch(e){ return fallback(); } }
      const modW = parseFloat(el("modWidth")?.value || "1.13") || 1.13;
      const modH = parseFloat(el("modHeight")?.value || "2.4") || 2.4;
      const angle = parseFloat(el("installAngle")?.value || "20") || 20;
      const rowSpacing = parseFloat(el("rowSpacing")?.value || "1.2") || 1.2;
      const projectedH = modH * Math.cos(angle * Math.PI / 180);
      const bbox = turf.bbox(poly);
      const centerLat = (bbox[1] + bbox[3]) / 2;
      const mpdLng = 111320 * Math.cos(centerLat * Math.PI / 180);
      const mpdLat = 111000;
      const dLng = (modW + 0.10) / mpdLng;
      const dLat = (projectedH + rowSpacing) / mpdLat;
      const feats = []; let guard = 0; const MAX = 45000;
      for(let x=bbox[0]; x<bbox[2]; x+=dLng){ for(let y=bbox[1]; y<bbox[3]; y+=dLat){ if(guard++ > MAX) break; const pt = turf.point([x + dLng/2, y + dLat/2]); try{ if(turf.booleanPointInPolygon(pt, poly)){ const w = modW / mpdLng; const h = projectedH / mpdLat; feats.push(turf.bboxPolygon([x, y, x+w, y+h])); } } catch(e) {} } }
      if(!feats.length) return fallback();
      return { type:"FeatureCollection", features: feats };
    }

    function renderPanelsFC(fc){
      const style = { color: "#0f172a", weight: 1, fillColor: "#0b3a8a", fillOpacity: 0.80 };
      return L.geoJSON(fc, { style });
    }

    function getFeatureId(feature){
      const props = feature?.properties || {};
      if(props.pnu) return `pnu:${props.pnu}`;
      try{ const c = turf.center(feature).geometry.coordinates; return `c:${c[1].toFixed(6)}:${c[0].toFixed(6)}`; } catch(e){ return `t:${Math.random()}`; }
    }

    function updateResultCardBasics(addr, panelCount){
      const rc = el("resultCard"); if(rc) rc.classList.remove("hidden");
      if(el("analysisAddress")) el("analysisAddress").innerText = safeText(addr);
      if(el("analysisCount")) el("analysisCount").innerText = `${panelCount} ì¥`;
      const modPower = parseFloat(el("modPower")?.value || "640") || 640;
      const dcKw = (panelCount * modPower) / 1000;
      const acKw = dcKw / 1.15;
      if(el("analysisCapacity")) el("analysisCapacity").innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;
      try{ if(typeof window.updateKepcoCapacity==="function") window.updateKepcoCapacity(addr, currentAnalysisData?.pnu); }catch(e){ if(el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”"; }
    }

    window.calculateFinance = function(panelCount, sunHoursOverride){
      try{
        const totalPanels = Math.max(0, parseInt(panelCount || 0, 10));
        const {lat} = getAnalysisLatLng();
        const solar = currentAnalysisData.solar_opt || {};
        const sun = (typeof sunHoursOverride === "number" && sunHoursOverride > 0) ? sunHoursOverride : estimateSunHoursHeuristic(lat);
        const modPowerW = (parseFloat(el("modPower")?.value || "640") || 640);
        const dcKw = (totalPanels * modPowerW) / 1000.0;
        const acKw = dcKw / 1.15;
        const PR = 0.90;
        const annualKwhY1 = dcKw * sun * 365 * PR;
        const smp = (parseFloat(el("smp")?.value || "140") || 140);
        const rec = (parseFloat(el("rec")?.value || "70") || 70);
        const effectivePrice = smp + rec;
        const costPerKw = (parseFloat(el("costPerKw")?.value || "90") || 90) * 10000;
        const totalCost = dcKw * costPerKw;
        const annualRevenueWon = annualKwhY1 * effectivePrice;
        
        // PF Calculation
        const annualRatePct = (parseFloat(el("pfInterestRate")?.value || "5.5") || 5.5);
        const years = 15;
        const loanRatioPct = (parseFloat(el("pfLoanRatio")?.value || "90") || 90);
        let principal = (parseFloat(el("pfPrincipal")?.value || "0") || 0);
        const autoPrincipal = !!(el("pfAutoPrincipal") && el("pfAutoPrincipal").checked);
        if(autoPrincipal){ principal = Math.round(totalCost * (loanRatioPct/100)); try{ el("pfPrincipal").value = principal; }catch(e){} }
        
        const r = (annualRatePct/100)/12;
        const n = years*12;
        const monthly = (principal * r * Math.pow(1+r, n)) / (Math.pow(1+r, n)-1);
        const totalInterest = (monthly * n) - principal;
        const payback = (totalCost / annualRevenueWon);

        if(el("resTotalCost")) el("resTotalCost").innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
        if(el("resAnnualRev")) el("resAnnualRev").innerText = `${Math.round(annualRevenueWon).toLocaleString()} ì›`;
        if(el("resMonthlyDebt")) el("resMonthlyDebt").innerText = `${Math.round(monthly).toLocaleString()} ì›`;
        if(el("resTotalInterest")) el("resTotalInterest").innerText = `${Math.round(totalInterest).toLocaleString()} ì›`;
        if(el("resPfPayback")) el("resPfPayback").innerText = `${payback.toFixed(1)} ë…„`;

        currentAnalysisData.finance = { totalPanels, dcKw, acKw, annualKwhY1, annualRevenueWon, totalCostWon: totalCost, monthlyDebtWon: monthly, totalInterestWon: totalInterest, paybackYears: payback, roi25y: { land_price_won: null } };
      }catch(e){}
    };

    window.analyzeFeature = function(feature, focusTab){
      if(FEATURE_LEVEL < 3){ showToast("feat<3: íŒ¨ë„ ìƒì„± ë¹„í™œì„±"); return; }
      if(!feature?.geometry){ showToast("ì§€ì˜¤ë©”íŠ¸ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"); return; }
      if(focusTab) window.switchTab("analysis");
      const props = feature.properties || {};
      const addr = props.road_nm_ad || props.jibun_addr || props.addr || (props.pnu ? `PNU:${props.pnu}` : "") || "í™•ì¸ í•„ìš”";
      currentAnalysisData.pnu = props.pnu || null;
      const featureId = getFeatureId(feature);
      if(isMultiSelectMode && selectedFeatures.has(featureId)){
        const stored = selectedFeatures.get(featureId);
        if(stored?.layer) panelGroup.removeLayer(stored.layer);
        selectedFeatures.delete(featureId);
        recomputeTotalsAfterSelectionChange();
        return;
      }
      if(!isMultiSelectMode){
        panelGroup.clearLayers();
        selectedFeatures.clear();
        resetCalibrationInternal(false);
      }
      currentAnalysisFeature = feature;
      const baseFC = buildPanelsFCFromGeometry(feature.geometry);
      const fc = applyCalibrationToFC(baseFC);
      const layer = renderPanelsFC(fc);
      layer.addTo(panelGroup);
      const count = fc.features.length;
      selectedFeatures.set(featureId, { feature, layer, count, panelsFC: fc, basePanelsFC: baseFC, address: addr });
      try{ const c = L.geoJSON(feature).getBounds().getCenter(); currentAnalysisData.lat = c.lat; currentAnalysisData.lng = c.lng; }catch(e){ const c2 = map.getCenter(); currentAnalysisData.lat = c2.lat; currentAnalysisData.lng = c2.lng; }
      currentAnalysisData.area_m2 = polygonAreaM2(feature.geometry);
      const pc = getTotalPanelCount();
      updateResultCardBasics(addr, pc);
      setTimeout(()=>window.calculateFinance(pc, currentAnalysisData.solar_opt?.sun_hours),0);
      try{ window.refreshSolarLandEstimates(); }catch(e){}
      try{ ensurePanelDragHandle(feature); }catch(e){}
      currentAnalysisData.address = addr;
      currentAnalysisData.mode = (scanTarget === "land") ? "land" : "roof";
      if(FEATURE_LEVEL >= 5){ try{ const center = turf.center(feature).geometry.coordinates; fetchAIData(center[1], center[0], addr); }catch(e){ fetchAIData(null, null, addr); } }
    };

    function getTotalPanelCount(){
      let sum = 0;
      for(const v of selectedFeatures.values()) sum += (v.count || 0);
      return sum;
    }

    function recomputeTotalsAfterSelectionChange(){
      const total = getTotalPanelCount();
      if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
      window.calculateFinance(total, currentAnalysisData.solar_opt?.sun_hours);
      showToast(`ì„ íƒ: ${selectedFeatures.size}ê°œ / íŒ¨ë„ ${total}ì¥`);
    }

    window.reCalculate = function(){
      if(FEATURE_LEVEL < 3) return;
      if(!selectedFeatures.size){ showToast("ì„ íƒëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
      panelGroup.clearLayers();
      const updated = new Map();
      for(const [id, v] of selectedFeatures.entries()){
        const baseFC = buildPanelsFCFromGeometry(v.feature.geometry);
        const fc = (currentAnalysisFeature && id === getFeatureId(currentAnalysisFeature)) ? applyCalibrationToFC(baseFC) : baseFC;
        const layer = renderPanelsFC(fc);
        layer.addTo(panelGroup);
        updated.set(id, { ...v, layer, count: fc.features.length, panelsFC: fc, basePanelsFC: baseFC });
      }
      selectedFeatures = updated;
      const total = getTotalPanelCount();
      if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
      window.calculateFinance(total, currentAnalysisData.solar_opt?.sun_hours);
      showToast("ì¬ê³„ì‚° ì™„ë£Œ");
    };

    function resetCalibrationInternal(recalc=true){ calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 }; if(recalc) window.reCalculate(); }
    window.resetCalibration = function(){ resetCalibrationInternal(true); };
    window.applyCalibration = function(dx, dy, drot=0){ if(FEATURE_LEVEL < 3) return; calibration.dx_m += (dx || 0); calibration.dy_m += (dy || 0); calibration.rot_deg += (drot || 0); window.reCalculate(); };
    window.dpadHoldStart = function(dir){ if(FEATURE_LEVEL < 3) return; window.dpadHoldStop(); const step = 0.2; const tick = () => { if(dir === "up") window.applyCalibration(0, step); if(dir === "down") window.applyCalibration(0, -step); if(dir === "left") window.applyCalibration(-step, 0); if(dir === "right") window.applyCalibration(step, 0); if(dir === "rotL") window.applyCalibration(0, 0, -2); if(dir === "rotR") window.applyCalibration(0, 0, 2); }; tick(); dpadHoldTimer = setInterval(tick, 120); };
    window.dpadHoldStop = function(){ if(dpadHoldTimer){ clearInterval(dpadHoldTimer); dpadHoldTimer = null; } };

    async function postJson(url, body){
      const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body||{}), credentials:"include"});
      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
      return { ok: res.ok, status: res.status, data };
    }

    function renderAIResult(payload){
      const container = el("aiAnalysisResult");
      if(container){
        const checks = Array.isArray(payload.checks) ? payload.checks : [];
        container.innerHTML = checks.map(item => {
          const title = safeText(item.title || item.category, "");
          const result = safeText(item.message || item.result || item.status || "", "í™•ì¸ í•„ìš”");
          const needs = item.needs_confirm || (String(result).includes("í™•ì¸") && String(result).includes("í•„ìš”"));
          return `<div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]"><div class="flex items-center gap-2"><div class="text-cyan-400">âœ“</div><div><div class="text-slate-300 font-bold">${title}</div><div class="${needs ? "text-yellow-300" : "text-white"} truncate w-60">${result}</div></div></div></div>`;
        }).join("") || `<div class="text-slate-300 text-xs">AI ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }
      const scorePanel = el("aiScorePanel");
      if(scorePanel){
        let score = null;
        if(typeof payload.attractiveness_score === "number") score = payload.attractiveness_score;
        else if(payload.ai_score && typeof payload.ai_score.score === "number") score = payload.ai_score.score;
        if(score === null) { scorePanel.classList.add("hidden"); }
        else {
          scorePanel.classList.remove("hidden");
          const s = Math.max(0, Math.min(100, Math.round(score)));
          if(el("scoreValue")) el("scoreValue").innerText = `${s}ì `;
          if(el("scoreBar")) el("scoreBar").style.width = `${s}%`;
        }
      }
    }

    window.fetchAIData = async function(lat, lng, addr){
      if(FEATURE_LEVEL < 5) return;
      if(!BACKEND_URL) return;
      const placeholder = el("legalPlaceholder");
      const loading = el("legalLoading");
      const content = el("legalContent");
      if(placeholder) placeholder.classList.add("hidden");
      if(content) content.classList.add("hidden");
      if(loading) loading.classList.remove("hidden");
      const ll = getAnalysisLatLng();
      const payload = { address: addr, mode: (scanTarget === "land") ? "land" : "roof", lat: lat||ll.lat, lng: lng||ll.lng, panel_count: getTotalPanelCount(), setback_m: parseFloat(el("setbackDist")?.value || "0") || 0 };
      try{
        let r = await postJson(`${BACKEND_URL}/api/analyze/basic`, payload);
        if(!r.ok) r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
        currentAnalysisData.ai_analysis = r.data;
        if(loading) loading.classList.add("hidden");
        if(content) content.classList.remove("hidden");
        renderAIResult(r.data);
        
        // [í†µí•©] 8ëŒ€ ì²´í¬ì‚¬í•­ ì¶”ê°€ ë¡œë”© (AI ë¶„ì„ í›„ ì‹¤í–‰)
        await fetchEightChecks();

        try{ window.refreshSolarLandEstimates(); }catch(e){}
      } catch(e){
        if(loading) loading.classList.add("hidden");
        if(placeholder) { placeholder.classList.remove("hidden"); placeholder.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs">ê¸°ë³¸ ë¶„ì„ ì‹¤íŒ¨</div>`; }
      }
    };

    window.openFullReport = function(){
      const form = el("reportForm");
      if(!form || !BACKEND_URL) return;
      if(el("form_address")) el("form_address").value = safeText(currentAnalysisData.address, "");
      if(el("form_capacity")) el("form_capacity").value = safeText(el("analysisCapacity")?.innerText, "");
      if(el("form_kepco")) el("form_kepco").value = safeText(el("kepcoCapacity")?.innerText, "í™•ì¸ í•„ìš”");
      if(el("form_date")) el("form_date").value = new Date().toLocaleString();
      if(el("form_mode")) el("form_mode").value = (scanTarget === "land") ? "land" : "roof";
      if(el("form_finance")) el("form_finance").value = JSON.stringify(currentAnalysisData.finance || {});
      if(el("form_ai")) el("form_ai").value = JSON.stringify(currentAnalysisData.ai_analysis || {});
      if(el("form_solar")) el("form_solar").value = JSON.stringify(currentAnalysisData.solar_opt || {});
      if(el("form_land")) el("form_land").value = JSON.stringify(currentAnalysisData.land_estimate || {});
      form.action = `${BACKEND_URL}/report`;
      form.submit();
    };

    window.onload = function(){
      window.addEventListener("blur", window.dpadHoldStop);
      window.initMap();
      if(el("analysisAddress")) el("analysisAddress").innerText = "í™•ì¸ í•„ìš”";
      autoScanMode = !!(el("autoScanToggle")?.checked);
      isMultiSelectMode = !!(el("multiSelectToggle")?.checked);
    };
    

// === Settings modal open/close (ìƒì„¸ ì„¤ì • ë²„íŠ¼) ===
window.openSettingsModal = function() {
  try {
    var overlay = document.getElementById("settingsOverlay");
    if (!overlay) return;
    overlay.classList.remove("hidden");
  } catch (e) {
    console.warn("openSettingsModal failed", e);
  }
};

window.closeSettingsModal = function() {
  try {
    var overlay = document.getElementById("settingsOverlay");
    if (!overlay) return;
    overlay.classList.add("hidden");
  } catch (e) {
    console.warn("closeSettingsModal failed", e);
  }
};

// === Bottom status / log panel í† ê¸€ ===
window.toggleBottomPanel = function() {
  try {
    var inner = document.getElementById("bottomStatusInner");
    if (!inner) return;
    inner.classList.toggle("open");
    var icon = document.getElementById("bottomStatusHandleIcon");
    if (icon) {
      if (inner.classList.contains("open")) {
        icon.classList.remove("ph-caret-up");
        icon.classList.add("ph-caret-down");
      } else {
        icon.classList.remove("ph-caret-down");
        icon.classList.add("ph-caret-up");
      }
    }
  } catch (e) {
    console.warn("toggleBottomPanel failed", e);
  }
};

</script>
</body>
</html>
