<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #1a1a1a; }
.sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { transform: translateX(-100%); }
        #sidebar-toggle-btn { left: 420px; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2001; }
        #sidebar-toggle-btn.collapsed { left: 0; }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: #f8fafc; }
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .login-input { background: rgba(30, 41, 59, 0.5); border: 1px solid #475569; color: white; transition: all 0.3s; }
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; color: white; font-size: 16px; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:active { background: #1e293b; transform: translateY(2px); box-shadow: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="land_price" id="form_price">
    </form>

    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
        <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
            <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</h1>
            <div class="flex justify-between items-center text-[10px] text-slate-400 mt-2 border-t border-slate-700 pt-2"><span id="currentUserDisplay">Public Access</span></div>
            <div class="grid grid-cols-3 gap-1 mt-3 text-center">
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">Backend</div><div id="cnt-vworld" class="font-mono font-bold text-cyan-400">0</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">DB Sync</div><div id="cnt-public" class="font-mono font-bold text-yellow-400">0</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">AI Analysis</div><div id="cnt-ai" class="font-mono font-bold text-purple-400">0</div></div>
            </div>
        </div>
        <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
            <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
            <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
            <button type="button" onclick="window.switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
            <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50">
            <!-- ì„¤ì • íŒ¨ë„ -->
            <div class="p-4 pb-0">
                <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4" open>
                    <summary class="p-3 text-xs font-bold text-slate-600 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg"><span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i></summary>
                    <div class="p-3 space-y-3 border-t border-gray-200 text-xs">
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ìµœëŒ€ë†’ì´(m)</label><input type="number" id="installHeight" value="0.5" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" value="640" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì´ê²©(m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                        </div>
                        <div class="bg-green-50 p-2 rounded border border-green-200">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center font-bold text-emerald-700" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œ)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2"><div><label class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center text-blue-600 font-bold" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center text-red-600 font-bold" onchange="window.reCalculate()"></div></div>
                        </div>
                    </div>
                </details>
                <div class="flex gap-2 text-xs mb-4">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="window.toggleTarget()" aria-label="í† ì§€"><div class="text-center py-2 border rounded bg-white peer-checked:bg-amber-900 peer-checked:text-white hover:bg-gray-50 transition shadow-sm"><i class="ph ph-tree"></i> í† ì§€ (Land)</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="window.toggleTarget()" checked aria-label="ì§€ë¶•"><div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm"><i class="ph ph-factory"></i> ì§€ë¶• (Roof)</div></label>
                </div>
            </div>

            <div class="px-4 pb-4">
                <!-- 1. ìŠ¤ìº” íŒ¨ë„ -->
                <div id="panel-scan" class="space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <label for="regionSelect" class="text-xs font-bold text-gray-700 mb-2 block">ğŸ“ ì§€ì—­ ì„ íƒ</label>
                        <select id="regionSelect" onchange="window.setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none">
                            <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <optgroup label="ğŸ­ ìˆ˜ë„ê¶Œ/ê²½ê¸° ì£¼ìš” ì‚°ë‹¨">
                                <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                                <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                                <option value="hwaseong_ind">í™”ì„± ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="pyeongtaek_ind">í‰íƒ í¬ìŠ¹ê³µë‹¨</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì¶©ì²­ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="cheonan_ind">ì²œì•ˆ ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="osan_ind">ì˜¤ì°½ ê³¼í•™ì‚°ì—…ë‹¨ì§€</option>
                                <option value="daejeon_ind">ëŒ€ì „ ëŒ€ë•í…Œí¬ë…¸ë°¸ë¦¬</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì˜ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="gumi_ind">êµ¬ë¯¸ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="ulsan_ind">ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚° ì‚°ë‹¨</option>
                                <option value="daegu_ind">ëŒ€êµ¬ ì„±ì„œê³µë‹¨</option>
                                <option value="pohang_ind">í¬í•­ ì² ê°•ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸ­ í˜¸ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="gwangju_ind">ê´‘ì£¼ í•˜ë‚¨/ì²¨ë‹¨ ì‚°ë‹¨</option>
                                <option value="yeosu_ind">ì—¬ìˆ˜ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="daebul_ind">ì˜ì•” ëŒ€ë¶ˆì‚°ë‹¨</option>
                                <option value="gunsan_ind">êµ°ì‚° êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸŒ² ëŒ€í•œë¯¼êµ­ ê´‘ì—­ ì§€ìì²´">
                                <option value="seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                <option value="gyeonggi">ê²½ê¸°ë„</option>
                                <option value="incheon">ì¸ì²œê´‘ì—­ì‹œ</option>
                                <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                                <option value="jeonbuk">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                                <option value="gyeongnam">ê²½ìƒë‚¨ë„</option>
                                <option value="gyeongbuk">ê²½ìƒë¶ë„</option>
                                <option value="chungnam">ì¶©ì²­ë‚¨ë„</option>
                                <option value="chungbuk">ì¶©ì²­ë¶ë„</option>
                                <option value="gangwon">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
                                <option value="jeju">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500">
                        <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                            <label for="scanDelay" class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</label>
                            <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="window.updateEstimatedTime()">
                                <option value="6000" selected>6ì´ˆ (ê¶Œì¥)</option>
                                <option value="10000">10ì´ˆ (ì €ì†)</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-end"><div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">00:00:00</div><div id="progressCount" class="text-[10px] text-gray-500 font-mono">0 / 20</div></div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden"><div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                        <div class="flex justify-between items-end mt-1 px-1"><div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div></div>
                        <div class="flex items-center gap-2 mb-2 mt-2">
                             <input type="checkbox" id="autoFollow" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" checked>
                             <label for="autoFollow" class="text-[10px] text-slate-300 cursor-pointer select-none">ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <button type="button" onclick="window.startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                            <button type="button" onclick="window.cancelMission(true)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â–  ì·¨ì†Œ(ìœ ì§€)</button>
                            <button type="button" onclick="window.downloadScanResults('geojson')" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â¬‡ ê²°ê³¼ë‹¤ìš´</button>
                            <button type="button" onclick="window.cancelMission(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ë¦¬ì…‹</button>
                        </div>
                    </div>
                </div>

                <!-- 2. ì •ë°€ ë¶„ì„ íŒ¨ë„ -->
                <div id="panel-analysis" class="hidden space-y-4">
                    <div class="bg-slate-800 p-2 rounded-lg border border-indigo-500/50 shadow-lg mb-2">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ì¡°ì • (D-Pad)</span><button type="button" onclick="window.resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                        <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                             <div class="grid grid-cols-3 gap-2">
                                <div></div><button type="button" class="d-pad-btn" onclick="window.applyCalibration(0, 0.2)">â–²</button><div></div>
                                <button type="button" class="d-pad-btn" onclick="window.applyCalibration(-0.2, 0)">â—€</button>
                                <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                                <button type="button" class="d-pad-btn" onclick="window.applyCalibration(0.2, 0)">â–¶</button>
                                <div></div><button type="button" class="d-pad-btn" onclick="window.applyCalibration(0, -0.2)">â–¼</button><div></div>
                             </div>
                             <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                                <button type="button" class="d-pad-btn flex-1 text-[10px]" onclick="window.applyCalibration(0, 0, -2)">â†º íšŒì „</button>
                                <button type="button" class="d-pad-btn flex-1 text-[10px]" onclick="window.applyCalibration(0, 0, 2)">â†» íšŒì „</button>
                            </div>
                        </div>
                    </div>

                    <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                        <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right">-</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰:</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">-</span></div>
                        </div>
                        <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600 text-xs">
                            <div class="flex justify-between"><span>ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                            <div class="flex justify-between"><span>ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                        </div>
                        <div class="bg-indigo-900/40 p-2 rounded border border-indigo-500/30 text-[10px]">
                            <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button type="button" onclick="window.saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition">ì €ì¥</button>
                             <button type="button" onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition">ìƒì„¸ ë¦¬í¬íŠ¸</button>
                        </div>
                    </div>
                </div>

                <div id="panel-legal" class="hidden space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                        <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> AI ì¸í—ˆê°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h3>
                        
                        <div id="aiScorePanel" class="hidden mb-4 bg-slate-900/50 p-3 rounded border border-slate-600">
                             <div class="flex items-center justify-between mb-2">
                                 <span class="text-xs text-slate-300 font-bold">ë•… êµ¬ë§¤ ë§¤ë ¥ë„ (AI Score)</span>
                                 <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                                 <span id="confidenceValue" class="text-[10px] text-slate-400 ml-1"></span>
                             </div>
                             <div class="w-full bg-slate-700 rounded-full h-2.5 mb-3 overflow-hidden">
                                 <div id="scoreBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                             </div>
                             <div class="flex items-center justify-between border-t border-slate-600 pt-2">
                                 <span class="text-[10px] text-slate-400">ì¶”ì • ë•…ê°’ (AI ì˜ˆì¸¡)</span>
                                 <span id="priceValue" class="text-xs font-bold text-yellow-300">ë¶„ì„ ì¤‘...</span>
                             </div>
                        </div>

                        <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                            <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>ê±´ë¬¼ì„ ì„ íƒí•˜ë©´ SolarAI ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.
                        </div>

                        <div id="legalLoading" class="hidden text-center py-10">
                            <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                            <p class="text-xs text-purple-300 animate-pulse">ìƒì„¸ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        </div>

                        <div id="legalContent" class="hidden space-y-4 mt-2">
                             <div class="bg-purple-900/30 p-2 rounded border border-purple-500/30 text-xs text-purple-200 mb-2">
                                <strong class="block mb-1 text-purple-300">ğŸ¤– SolarAI ì¢…í•© ì˜ê²¬</strong>
                                <div id="aiCommentBox" class="whitespace-pre-wrap leading-relaxed">ë¶„ì„ ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
                            </div>
                            <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-history" class="hidden space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-2 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                            <div class="flex gap-2">
                                <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV ë‹¤ìš´</button>
                                <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
                
                <div id="loading" class="hidden flex flex-col items-center justify-center py-4"><div class="spinner mb-2"></div><p class="text-xs text-slate-500">ì²˜ë¦¬ ì¤‘...</p></div>
            </div>
        </div>
        
        <div class="h-24 bg-slate-900 border-t border-slate-700 p-3 font-mono text-[10px] overflow-y-auto text-slate-400" id="logWindow"><div class="text-green-500">> System Ready.</div></div>
    </div>
    
    <div id="sidebar-toggle-btn" onclick="window.toggleSidebar()" class="absolute top-1/2 transform -translate-y-1/2 bg-white w-6 h-12 rounded-r-lg shadow-md cursor-pointer flex items-center justify-center border border-l-0 border-gray-300 text-gray-400 hover:text-cyan-600"><i class="ph ph-caret-left font-bold transition-transform"></i></div>
    
    <div class="absolute top-5 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col items-center gap-2">
        <div class="bg-white p-1 rounded-lg shadow-xl border border-slate-200 flex items-center">
            <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" class="w-64 px-3 py-2 text-sm outline-none text-slate-700 font-medium" onkeypress="if(event.key==='Enter') window.searchAddress()">
            <button type="button" onclick="window.searchAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition shadow-md"><i class="ph ph-magnifying-glass font-bold"></i></button>
        </div>
    </div>
    
    <div class="absolute top-5 right-5 z-[1000] bg-white p-2 rounded-lg shadow-lg border border-gray-200 text-xs w-44">
        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1"><i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •</div>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 rounded text-indigo-700 font-bold border border-indigo-200"><input type="checkbox" id="multiSelectToggle" onchange="window.toggleMultiSelect()"><span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
            <input type="checkbox" id="autoScanToggle" onchange="window.toggleAutoScan()">
            <span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”</span>
        </label>
        <hr class="my-2 border-gray-200">
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="existingPlantToggle" onchange="window.toggleLayer('existing')" checked><span>ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="substationToggle" onchange="window.toggleLayer('substation')" checked><span>ë³€ì „ì†Œ/ì„ ë¡œ</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="cadastralToggle" onchange="window.toggleLayer('cadastral')" checked><span>ì§€ì ë„ (ON)</span></label>
        <div class="space-y-1 mt-2">
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="sat" checked onchange="window.setMap('sat')"> <span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span></label>
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="base" onchange="window.setMap('base')"> <span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span></label>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText"></span></div>
    <div id="map"></div>

    <script>
        const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";
        // --- Safety: avoid hard crashes from accidental stray references ---
        window.sData = window.sData ?? null;

        // Some server configurations may require a client token header.
        // Keep defined to prevent ReferenceError even if unused.
        const CLIENT_TOKEN = window.CLIENT_TOKEN || "";

 
        const BACKEND_URL = "";
        let map, layers, selectableGroup, panelGroup, cadastralLayer, analysisMarker, analysisMarkerGroup, existingGroup, substationGroup;
        let scanTarget='building', currentAnalysisFeature=null, currentGeoState={x:0,y:0,rot:0}, autoScanMode=false, isMultiSelectMode=false, accumulatedPanelsCount=0, isLoggedIn=true, currentUser="public";
        let selectedFeatures = new Map();

        // currentAnalysisData ì „ì—­ ì¤€ë¹„(ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê³ , ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
        let currentAnalysisData = window.currentAnalysisData || {};

        // (ì›ë˜ ì˜ë„: ì´ˆê¸°í™”/ë¦¬ì…‹)
        for (const k in currentAnalysisData) { try { delete currentAnalysisData[k]; } catch (e) {} }
        window.currentAnalysisData = currentAnalysisData;

        // keep alignment marker
        // (removed) stray sData reference
        window.currentAnalysisData = currentAnalysisData;
        // âœ… íŒ¨ë„ êµì •(ìº˜ë¦¬ë¸Œë ˆì´ì…˜)ìš©: ìµœì´ˆ ê³„ì‚°ëœ íŒ¨ë„(ê¸°ì¤€) í”¼ì²˜ì»¬ë ‰ì…˜ ì €ì¥
        let _basePanelsFC = null;
        let _currentPanelsLayer = null;
        let _multiPanelsLayers = [];
 
        let stopScan = false;
        let missionPaused = false;
        let missionRunning = false;
        let _missionTimer = null;
        let _missionEndAt = null;
        let scanLock = false; 
        
        let _memoryUsers = [{id:"admin", pw:"1234"}]; 

        function safeGetItem(key) {
            try { return localStorage.getItem(key); } catch(e) { return null; }
        }
        function safeSetItem(key, val) {
            try { localStorage.setItem(key, val); } 
catch(e) { console.warn("Storage restricted"); }
        }

        // âœ… expose storage helpers to window (used by login/admin)
        window.safeGetItem = safeGetItem;
        window.safeSetItem = safeSetItem;


        window.trackApi = function(type) { 
            const el = document.getElementById(`cnt-${type}`); 
            if(el) {
                const newCnt = parseInt(el.innerText || "0") + 1;
                el.innerText = newCnt;
                safeSetItem(`api_count_${type}`, newCnt);
            }
        };

        window.showToast = function(m) { 
            const t = document.getElementById('toastMsg'); 
            const text = document.getElementById('toastText');
            if(t && text) {
                t.classList.remove('hidden'); 
                t.classList.add('flex'); 
                text.innerText = m; 
                setTimeout(() => t.classList.add('hidden'), 3000); 
            }
        };
        
        window.logSystem = function(msg) { 
            const w = document.getElementById('logWindow'); 
            if(w) { 
                const p = document.createElement('div'); 
                p.innerText = `> ${msg}`; 
                w.appendChild(p); 
                w.scrollTop = w.scrollHeight; 
            } 
        };

        // -------------------------
        // Scan helpers (must NOT be inside HTML attributes)
        // -------------------------
        window.downloadScanResults = function(format = "geojson") {
            try {
                const feats = [];
                if (selectableGroup) {
                    selectableGroup.eachLayer(l => {
                        if (l && typeof l.toGeoJSON === "function") {
                            const gj = l.toGeoJSON();
                            if (gj && gj.type === "Feature") feats.push(gj);
                            else if (gj && gj.type === "FeatureCollection") feats.push(...(gj.features || []));
                        }
                    });
                }
                const fc = { type: "FeatureCollection", features: feats };
                const ts = new Date().toISOString().replace(/[:.]/g, '-');

                if (format === "csv") {
                    const rows = [["id", "geom_type", "lat", "lng"]];
                    fc.features.forEach((f, idx) => {
                        let lng = "", lat = "";
                        if (f?.geometry?.type === "Point" && Array.isArray(f.geometry.coordinates)) {
                            lng = f.geometry.coordinates[0];
                            lat = f.geometry.coordinates[1];
                        }
                        rows.push([String(f.id ?? idx), String(f?.geometry?.type ?? ""), String(lat ?? ""), String(lng ?? "")]);
                    });
                    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
                    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = `scan-results-${ts}.csv`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    return;
                }

                const blob = new Blob([JSON.stringify(fc, null, 2)], { type: "application/geo+json" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `scan-results-${ts}.geojson`;
                a.click();
                URL.revokeObjectURL(a.href);
            } catch (e) {
                console.error(e);
                window.showToast?.("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
            }
        };

        window.cancelMission = function(resetProgressOnly = true) {
            stopScan = true;
            missionPaused = false;
            missionRunning = false;

            if (_missionTimer) { try { clearInterval(_missionTimer); } catch(e) {} }
            _missionTimer = null;

            const timerEl = document.getElementById('timerRemaining');
            if (timerEl) timerEl.innerText = "00:00:00";

            const btn = document.getElementById('startBtn');
            if (btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";

            if (!resetProgressOnly) window.clearResults?.();

            window.showToast?.(resetProgressOnly ? "ìŠ¤ìº” ì·¨ì†Œ(ê²°ê³¼ ìœ ì§€)" : "ìŠ¤ìº” ë¦¬ì…‹(ê²°ê³¼ ì‚­ì œ)");
        };



        window.getUsers = function() {
            try { 
                const stored = safeGetItem('scenergy_users');
                return stored ? JSON.parse(stored) : _memoryUsers; 
            } catch(e) { return _memoryUsers; }
        }

        window.initMap = function() {
            if (map) return;
            if (typeof L === 'undefined') {
                window.logSystem("Error: Leaflet library not loaded.");
                return;
            }

            try {
                map = L.map('map', { zoomControl: false }).setView([36.5, 127.5], 7);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                
                layers = { 
                    base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`), 
                    sat: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
                    hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`) 
                };
                layers.sat.addTo(map);
                
                selectableGroup = L.layerGroup().addTo(map); 
                panelGroup = L.layerGroup().addTo(map); 
                analysisMarkerGroup = L.layerGroup().addTo(map);
                existingGroup = L.layerGroup().addTo(map); 
                substationGroup = L.layerGroup().addTo(map);
                
                cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', { 
                    layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun', 
                    styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun', 
                    format: 'image/png', 
                    transparent: true, 
                    opacity: 0.7, 
                    key: VWORLD_TILE_KEY 
                });
                
                map.addLayer(cadastralLayer);
                map.on('click', (e) => window.scanBuildings(e.latlng.lat, e.latlng.lng));
                map.on('moveend', () => { 
                    if(autoScanMode && isLoggedIn) { 
                        if(document.getElementById('autoFollow')?.checked) return;
                        const c = map.getCenter(); 
                        window.scanBuildings(c.lat, c.lng); 
                    } 
                
                     try{ _updateAutoScanBox(); }catch(e){}
                     try{ window.refreshInfraMarkers?.(); }catch(e){}
                 });
                
                if(document.getElementById('existingPlantToggle').checked) window.toggleLayer('existing');
                if(document.getElementById('substationToggle').checked) window.toggleLayer('substation');

                ['vworld', 'public', 'ai'].forEach(k => {
                    let cnt = safeGetItem(`api_count_${k}`) || "0";
                    const el = document.getElementById(`cnt-${k}`);
                    if(el) el.innerText = cnt;
                });
                window.updateEstimatedTime?.();
                 try{ _updateAutoScanBox(); }catch(e){}
                 try{ window.refreshInfraMarkers?.(); }catch(e){}
                 window.logSystem("Map Initialized.");
            } catch (e) {
                console.error("Map Init Error:", e);
                window.logSystem("Map Init Failed.");
            }
        };

        window.toggleLayer = function(type) {
            if(!map) return;
            if(type === 'cadastral') {
                if(document.getElementById('cadastralToggle').checked) map.addLayer(cadastralLayer);
                else map.removeLayer(cadastralLayer);
            } else if(type === 'existing') {
                if(document.getElementById('existingPlantToggle').checked) { 
                    if(existingGroup.getLayers().length === 0) window.createMockMarkers(map.getCenter(), 'plant'); 
                    map.addLayer(existingGroup); 
                } else { existingGroup.clearLayers(); map.removeLayer(existingGroup); }
            } else if(type === 'substation') {
                if(document.getElementById('substationToggle').checked) { 
                    if(substationGroup.getLayers().length === 0) window.createMockMarkers(map.getCenter(), 'substation'); 
                    map.addLayer(substationGroup); 
                } else { substationGroup.clearLayers(); map.removeLayer(substationGroup); }
            }
        };

        window.createMockMarkers = function(center, type) {
            const group = type === 'plant' ? existingGroup : substationGroup;
            if(group.getLayers().length > 0) return;

            for(let i=0; i<3; i++) {
                const lat = center.lat + (Math.random() * 0.01 - 0.005);
                const lng = center.lng + (Math.random() * 0.01 - 0.005);
                const iconHtml = type === 'plant' ? `<div class="plant-marker w-6 h-6"><i class="ph ph-lightning text-white text-[10px]"></i></div>` : `<div class="substation-marker w-8 h-8"><i class="ph ph-circuitry text-white"></i></div>`;
                const icon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [24, 24] });
                L.marker([lat, lng], { icon: icon, title: type }).bindPopup(type === 'plant' ? "ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘" : "ë³€ì „ì†Œ").addTo(group);
            }
        };

        window.setMap = function(t) { 
            if(!map) return;
            if(t==='base') { map.addLayer(layers.base); map.removeLayer(layers.sat); } 
            else { map.addLayer(layers.sat); map.removeLayer(layers.base); } 
        };

        async function jsonpRequest(url) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                window[callbackName] = (data) => { 
                    delete window[callbackName]; 
                    const script = document.getElementById(callbackName);
                    if(script) document.body.removeChild(script); 
                    resolve(data); 
                };
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
                script.onerror = () => { 
                    delete window[callbackName]; 
                    document.body.removeChild(script); 
                    reject(new Error('JSONP failed')); 
                };
                document.body.appendChild(script);
            });
        }

        window.searchAddress = async function() {
            window.trackApi('vworld');
            const query = document.getElementById('addrInput').value;
            if(!query) return window.showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            const loading = document.getElementById('loading');
            if(loading) loading.classList.remove('hidden');
            try {
                const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(query)}&refine=true&simple=false&type=road&key=${VWORLD_TILE_KEY}`;
                const data = await jsonpRequest(url);
                if(data.response?.status === 'OK') {
                    const { x, y } = data.response.result.point;
                    map.setView([parseFloat(y), parseFloat(x)], 18);
                    setTimeout(() => window.scanBuildings(parseFloat(y), parseFloat(x)), 800);
                } else window.showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            } catch(e) { console.error(e); } finally { if(loading) loading.classList.add('hidden'); }
        };

        window.scanBuildings = async function(lat, lng, force=false) {
            if (!map || (scanLock && !force)) return;
            scanLock = true;
            try {
                window.trackApi('vworld');
                // [ìˆ˜ì •] ë©€í‹° ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ê¸°ì¡´ ì„ íƒ ë ˆì´ì–´ ì‚­ì œ (ì„ íƒëœê±´ panelGroupì— ë³´ì¡´)
                if (!isMultiSelectMode) {
                    if (selectableGroup) selectableGroup.clearLayers();
                    window.clearResults();
                } else {
                     if (selectableGroup) selectableGroup.clearLayers();
                }

                if (analysisMarkerGroup) analysisMarkerGroup.clearLayers();
                L.marker([lat, lng]).addTo(analysisMarkerGroup);

                const box = `${lng - 0.001},${lat - 0.001},${lng + 0.001},${lat + 0.001}`;
                const layerName = scanTarget === 'land' ? 'LP_PA_CBND_BUBUN' : 'LT_C_SPBD';
                const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${layerName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=1000`;
                const data = await jsonpRequest(url);
                
                if(data.response?.status === 'OK') {
                    L.geoJSON(data.response.result.featureCollection.features, {
                        // [ìˆ˜ì •] í† ì§€: ë°ì€ ë¸Œë¼ìš´(#8d6e63) í…Œë‘ë¦¬ + íˆ¬ëª…ë„ 0.4
                        style: scanTarget === 'land' 
                            ? { color: '#8d6e63', weight: 3, fillColor: '#8d6e63', fillOpacity: 0.4 } 
                            : { color: '#3b82f6', weight: 2, fillOpacity: 0.2 },
                        onEachFeature: (feature, layer) => {
                        layer.on('click', (e) => {
                            // ì¤‘ìš”: í´ë¦¬ê³¤ í´ë¦­ ì‹œ ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì „íŒŒë˜ë©´ scanBuildingsê°€ ë‹¤ì‹œ ì‹¤í–‰ë˜ë©° íŒ¨ë„ì´ ì¦‰ì‹œ ì§€ì›Œì§ˆ ìˆ˜ ìˆìŒ
                            if (e && e.originalEvent) L.DomEvent.stopPropagation(e);
                            window.analyzeFeature(feature);
                        });
                    }}).addTo(selectableGroup);
                }
            } catch(e) { console.error(e); }
            finally { setTimeout(() => { scanLock = false; }, 800); }
        };

        window.analyzeFeature = async function(feature) {
            // [ìˆ˜ì •] ì¢Œí‘œ ê¸°ë°˜ ID ìƒì„±ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€
            const center = turf.center(feature).geometry.coordinates;
            const featureId = feature.properties.pnu || `${center[1].toFixed(6)}_${center[0].toFixed(6)}`;
            
            if (selectedFeatures.has(featureId)) {
                if (isMultiSelectMode) {
                    const stored = selectedFeatures.get(featureId);
                    panelGroup.removeLayer(stored.layer);
                    selectedFeatures.delete(featureId);
                    
                    let total = 0; selectedFeatures.forEach(v => total += v.count);
                    accumulatedPanelsCount = total;
                    if (total === 0) window.clearResults(); else window.calculateFinance(total);
                    window.showToast("ì„ íƒ í•´ì œ");
                } else {
                    window.clearResults();
                }
                return;
            }

            if (!isMultiSelectMode) window.clearResults();

            window.switchTab('analysis');
            document.getElementById('resultCard').classList.remove('hidden');
            const props = feature.properties;
            const addr = props.road_nm_ad || props.jibun_addr || props.addr || (props.pnu ? `PNU:${props.pnu}` : '') || "ì£¼ì†Œ ë¯¸ìƒ";
            document.getElementById('analysisAddress').innerText = addr;
            
            const drawResult = window.drawPanels(feature.geometry); 
            if (drawResult) {
                selectedFeatures.set(featureId, { layer: drawResult.layer, count: drawResult.count, address: addr });
                let total = 0; selectedFeatures.forEach(v => total += v.count);
                accumulatedPanelsCount = total;
                window.calculateFinance(total);
            }

            Object.assign(currentAnalysisData, { address: addr, date: new Date().toLocaleDateString() });
            window.currentAnalysisData = currentAnalysisData;
            currentAnalysisFeature = feature;
            
            window.fetchAIData(center[1], center[0], addr);
        };

        window.fetchAIData = async function(lat, lng, addr) {
            const loadingEl = document.getElementById('legalLoading');
            const contentEl = document.getElementById('legalContent');
            const placeholderEl = document.getElementById('legalPlaceholder');
            const scorePanel = document.getElementById('aiScorePanel');
            
            if(placeholderEl) placeholderEl.classList.add('hidden');
            if(loadingEl) loadingEl.classList.remove('hidden');
            if(contentEl) contentEl.classList.add('hidden');
            if(scorePanel) scorePanel.classList.add('hidden');

            try {
                window.trackApi('ai');
                const res = await fetch(`${BACKEND_URL}/api/analyze/comprehensive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CLIENT-TOKEN': CLIENT_TOKEN
                    },
                    body: JSON.stringify({lat, lng, address: addr})
                });
                const data = await res.json();
                
                if(loadingEl) loadingEl.classList.add('hidden');
                if(contentEl) contentEl.classList.remove('hidden');

                if(data.status === 'OK') {
                     currentAnalysisData.ai_analysis = data;
                     // [ìˆ˜ì •] ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
                     if(data.kepco_capacity) currentAnalysisData.ai_analysis.kepco_capacity = data.kepco_capacity;

                     if(data.sun_hours) window.calculateFinance(accumulatedPanelsCount, data.sun_hours);
                     const cb = document.getElementById('aiCommentBox');
                     if(cb) cb.innerText = data.ai_comment || "ë¶„ì„ ì™„ë£Œ";

                     if(data.ai_score && data.ai_score.confidence) {
                        document.getElementById('confidenceValue').innerText = `(ì‹ ë¢°ë„: ${data.ai_score.confidence}%)`;
                     }

                     if(scorePanel) {
                         scorePanel.classList.remove('hidden');
                         const score = data.ai_score?.score || 50;
                         document.getElementById('scoreValue').innerText = score + "ì ";
                         document.getElementById('scoreBar').style.width = score + "%";
                         document.getElementById('priceValue').innerText = data.price_estimate || "ë¶„ì„ ì¤‘...";
                     }

                     const resultContainer = document.getElementById('aiAnalysisResult');
                     const items = [
                        {icon: 'ph-buildings', title: 'ìš©ë„ì§€ì—­', val: data.zoning, link: data.links.eum},
                        {icon: 'ph-map-trifold', title: 'ì§€ëª©', val: data.jimok || 'ë¯¸í™•ì¸', link: data.links.eum},
                        {icon: 'ph-plant', title: 'ìƒíƒœë“±ê¸‰', val: data.eco_grade, link: data.links.heritage},
                        {icon: 'ph-lightning', title: 'í•œì „ìš©ëŸ‰', val: data.kepco_capacity, link: data.links.kepco},
                        {icon: 'ph-sun', title: 'ì¼ì‚¬ëŸ‰', val: `${data.sun_hours}ì‹œê°„/ì¼`, link: '#'}
                     ];
                     resultContainer.innerHTML = items.map(item => `
                        <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]">
                            <div class="flex items-center gap-2"><div class="text-cyan-400"><i class="ph ${item.icon}"></i></div><div><div class="text-slate-400 font-bold">${item.title}</div><div class="text-white truncate w-32">${item.val}</div></div></div>
                            <a href="${item.link}" target="_blank" class="bg-slate-600 px-1.5 py-0.5 rounded transition hover:bg-slate-500">ì´ë™</a>
                        </div>
                     `).join('');
                }
            } catch(e) { console.error(e); }
        }

        
        window.calculateFinance = function(count, sunHoursOverride) { 
            const countEl = document.getElementById('analysisCount');
            if(countEl) countEl.innerText = `${count} ì¥`; 

            const modPowerW = parseFloat(document.getElementById('modPower').value) || 640;
            const dcKw = (count * modPowerW) / 1000;
            const acKw = dcKw / 1.15; // ì¸ë²„í„°/ê³„í†µ ê¸°ì¤€ ë³´ì •(ê°„ë‹¨)
            const capEl = document.getElementById('analysisCapacity');
            if(capEl) capEl.innerText = `${acKw.toFixed(1)} kW`;

            // ---- Inputs
            const costPerKw = (parseFloat(document.getElementById('costPerKw').value) || 90) * 10000; // ì›/kW
            const modPrice = parseFloat(document.getElementById('modPrice').value) || 350;            // ì›/W (ê°€ì •)
            const smp = parseFloat(document.getElementById('smp').value) || 140;                      // ì›/kWh
            const rec = parseFloat(document.getElementById('rec').value) || 70;                       // ì›/kWh (ë‹¨ìˆœ)
            const pfRatio = parseFloat(document.getElementById('pfLoanRatio').value) || 90;           // %
            const pfRate = parseFloat(document.getElementById('pfInterestRate').value) || 5.5;        // %
            const sunHours = (sunHoursOverride ?? null);
            const sun = (typeof sunHours === 'number' && !isNaN(sunHours)) ? sunHours : 3.6;

            // ---- í˜„ì‹¤ ë³´ì • íŒŒë¼ë¯¸í„°
            const PR = 0.80;                // ì„±ëŠ¥ë¹„(ì†ì‹¤ í¬í•¨) 0.75~0.82
            const YEARS = 25;               // ìš´ì˜ê¸°ê°„
            const DEGR = 0.005;             // ì—°ê°„ ì—´í™”ìœ¨ 0.5%
            const OPEX_PER_KW_Y = 20000;    // ì—° OPEX(ë³´í—˜/ì •ë¹„ ë“±) 2ë§Œì›/kWÂ·ë…„ (ê°€ì •)
            const LOAN_YEARS = 10;          // PF ë§Œê¸°(ê°€ì •)

            // ---- ì—ë„ˆì§€/ìˆ˜ìµ
            const annualKwh = acKw * sun * 365 * PR; // kWh/yr
            const pricePerKwh = smp + rec;           // ë‹¨ìˆœ í•©ì‚°(ì¶”í›„ REC ê°€ì¤‘ì¹˜ ë¶„ë¦¬ ê°€ëŠ¥)
            const annualRev = annualKwh * pricePerKwh;

            // 25ë…„ ì´ë§¤ì¶œ(ì—´í™” ë°˜ì˜)
            let totalRev25 = 0;
            for (let y=0; y<YEARS; y++) totalRev25 += annualRev * Math.pow(1 - DEGR, y);

            // ---- CAPEX
            // ëª¨ë“ˆë¹„ = (W) * (ì›/W)
            const moduleCost = (count * modPowerW) * modPrice;
            const bosCost = (acKw * costPerKw);
            const totalCost = moduleCost + bosCost;

            // ---- PF (ì›ë¦¬ê¸ˆ ê· ë“±, ê°„ë‹¨)
            const loan = totalCost * (pfRatio/100);
            const equity = totalCost - loan;
            const r = (pfRate/100);
            const n = LOAN_YEARS;

            let annualDebt = 0;
            if (loan > 0 && r > 0) {
              const rr = r;
              const pow = Math.pow(1+rr, n);
              annualDebt = loan * (rr * pow) / (pow - 1);
            } else {
              annualDebt = loan / n;
            }

            // ---- ìˆœí˜„ê¸ˆíë¦„(ë‹¨ìˆœ): ë§¤ì¶œ - OPEX - (ëŒ€ì¶œìƒí™˜(ë§Œê¸°ê¸°ê°„ë§Œ))
            const annualOpex = acKw * OPEX_PER_KW_Y;
            const annualNetYr1 = annualRev - annualOpex - annualDebt; // 1ë…„ì°¨

            // íšŒìˆ˜ê¸°ê°„(Equity ê¸°ì¤€) : 25ë…„ê¹Œì§€ë§Œ
            let cum = -equity;
            let payback = null;
            for (let y=0; y<YEARS; y++) {
              const revY = annualRev * Math.pow(1 - DEGR, y);
              const debtY = (y < LOAN_YEARS) ? annualDebt : 0;
              const netY = revY - annualOpex - debtY;
              cum += netY;
              if (cum >= 0 && payback === null) payback = (y+1);
            }
            const paybackText = (payback === null) ? `> ${YEARS} ë…„` : `${payback} ë…„`;

            // ---- UI output
            const tcEl = document.getElementById('resTotalCost');
            if(tcEl) tcEl.innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
            const arEl = document.getElementById('resAnnualRev');
            if(arEl) arEl.innerText = `${Math.round(annualRev).toLocaleString()} ì›/ë…„`;
            const pbEl = document.getElementById('resPfPayback');
            if(pbEl) pbEl.innerText = paybackText;

            document.getElementById('resultCard')?.classList.remove('hidden');

            // ---- Store for report
            currentAnalysisData.finance = {
                capacity: `${acKw.toFixed(1)} kW`,
                acCapacity: `${acKw.toFixed(1)} kW`,
                dcCapacity: `${dcKw.toFixed(1)} kW`,
                annualKwh: `${Math.round(annualKwh).toLocaleString()} kWh`,
                annualRev: `${Math.round(annualRev).toLocaleString()} ì›`,
                totalRev25: `${Math.round(totalRev25).toLocaleString()} ì›`,
                totalCost: `${Math.round(totalCost).toLocaleString()} ì›`,
                moduleCost: `${Math.round(moduleCost).toLocaleString()} ì›`,
                bosCost: `${Math.round(bosCost).toLocaleString()} ì›`,
                loan: `${Math.round(loan).toLocaleString()} ì›`,
                equity: `${Math.round(equity).toLocaleString()} ì›`,
                annualDebt: `${Math.round(annualDebt).toLocaleString()} ì›`,
                annualOpex: `${Math.round(annualOpex).toLocaleString()} ì›`,
                payback: paybackText,
                assumptions: { PR, YEARS, DEGR, OPEX_PER_KW_Y, LOAN_YEARS, pricePerKwh }
            };

        };

        
        // âœ… íŒ¨ë„ ìƒì„±(ê·¸ë¦¬ë“œ) / ë Œë” / êµì •ìš© ë³€í™˜ì„ ë¶„ë¦¬í•´ì„œ "ì‹¤ì‹œê°„ ì´ë™" ì²´ê° ê°œì„ 
        function _buildPanelsGrid(geo) {
            let poly = turf.feature(geo);

            const modW = parseFloat(document.getElementById('modWidth').value) || 1.13;
            const modH = parseFloat(document.getElementById('modHeight').value) || 2.4;
            const angle = parseFloat(document.getElementById('installAngle').value) || 20;
            const projectedH = modH * Math.cos(angle * Math.PI / 180);

            // (ê°„ë‹¨) íŒ¨ë„ ê°„ ê°„ê²©: rowSpacing ë°˜ì˜ (m)
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 1.2;

            // ìœ„/ê²½ë„ í™˜ì‚°(ê·¼ì‚¬) â€” ì´ ê°’ì€ ì§€ì—­ë³„ë¡œ ì˜¤ì°¨ê°€ ìˆì§€ë§Œ UI ëª©ì ìœ¼ë¡  ì¶©ë¶„
            const centerLat = turf.center(poly).geometry.coordinates[1];
            const metersPerDegLng = 111320 * Math.cos(centerLat * Math.PI / 180);
            const dLng = (modW + 0.10) / Math.max(60000, metersPerDegLng);
            const dLat = (projectedH + rowSpacing) / 111000;

            const bbox = turf.bbox(poly);
            let tempPanels = [], count = 0, loopGuard = 0;
            const MAX_LOOP = 50000;

            for(let x = bbox[0]; x < bbox[2]; x += dLng) {
                for(let y = bbox[1]; y < bbox[3]; y += dLat) {
                    if(loopGuard++ > MAX_LOOP) break;
                    if(turf.booleanPointInPolygon(turf.point([x + dLng/2, y + dLat/2]), poly)) {
                        tempPanels.push(turf.bboxPolygon([x, y, x + dLng*0.9, y + dLat*0.9]));
                        count++;
                    }
                }
                if(loopGuard > MAX_LOOP) break;
            }

            if (tempPanels.length === 0) {
                const center = turf.center(poly);
                const [cx, cy] = center.geometry.coordinates;
                tempPanels = [turf.bboxPolygon([cx, cy, cx+dLng, cy+dLat])];
                count = 1;
                window.showToast("ì˜ì—­ì´ ì‘ì•„ ìµœì†Œ íŒ¨ë„ 1ê°œë¥¼ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤.");
            }

            return { fc: { type:"FeatureCollection", features: tempPanels }, count };
        }

        function _renderPanels(fc) {
            const style = { color: '#1e40af', weight: 1, fillColor: '#3b82f6', fillOpacity: (scanTarget === 'land' ? 0.22 : 0.30) };

            const layer = L.geoJSON(fc, { style });
            layer.addTo(panelGroup);
            return layer;
        }

        function _applyCalibrationToFC(baseFC) {
            // baseFCëŠ” ì´ë¯¸ "ê¸°ì¤€ ê·¸ë¦¬ë“œ"ì´ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë³€í™˜ë§Œ ì ìš©(ë¹ ë¦„)
            let fc = turf.clone(baseFC);

            if (currentGeoState.x !== 0 || currentGeoState.y !== 0 || currentGeoState.rot !== 0) {
                // turf.transformTranslate: ê±°ë¦¬ ë‹¨ìœ„ëŠ” ê¸°ë³¸ kilometers
                // currentGeoStateëŠ” meterë¡œ ëˆ„ì í•˜ë¯€ë¡œ kmë¡œ ë³€í™˜
                if (currentGeoState.rot) fc = turf.transformRotate(fc, currentGeoState.rot);
                if (currentGeoState.x) fc = turf.transformTranslate(fc, currentGeoState.x / 1000, 90);
                if (currentGeoState.y) fc = turf.transformTranslate(fc, currentGeoState.y / 1000, 0);
            }
            return fc;
        }

        window.drawPanels = function(geo) {
            try {
                // 1) ìµœì´ˆ í´ë¦­ ì‹œì—ëŠ” ê·¸ë¦¬ë“œ ê³„ì‚°
                const built = _buildPanelsGrid(geo);
                _basePanelsFC = built.fc;

                // 2) ì¦‰ì‹œ ë Œë”(ê¸°ì¤€ ìƒíƒœ)
                if (!isMultiSelectMode) {
                    if (_currentPanelsLayer) { panelGroup.removeLayer(_currentPanelsLayer); }
                    _currentPanelsLayer = _renderPanels(_basePanelsFC);
                } else {
                    const lyr = _renderPanels(_basePanelsFC);
                    _multiPanelsLayers.push(lyr);
                    _currentPanelsLayer = lyr;
                }

                return { layer: _currentPanelsLayer, count: built.count, fc: _basePanelsFC };
            } catch(e) { console.error("Panel Draw Error:", e); return null; } 
        };

        // ì €ì¥ ë° ë¦¬í¬íŠ¸ ê´€ë ¨
        window.saveResult = function() {
            const addr = document.getElementById('analysisAddress').innerText;
            if(addr === '-' || addr === 'ì£¼ì†Œ ë¯¸ìƒ') return window.showToast("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const ai = currentAnalysisData.ai_analysis || {};
            const fn = currentAnalysisData.finance || {};
            let history = [];
            try { history = JSON.parse(safeGetItem('scenergy_history') || "[]"); } catch(e){}
            history.push({ 
                date: new Date().toLocaleString(), address: addr, capacity: fn.capacity, revenue: fn.annualRev,
                zoning: ai.zoning, jimok: ai.jimok, eco: ai.eco_grade, kepco: ai.kepco_capacity, sun: ai.sun_hours, score: ai.ai_score?.score, price: ai.price_estimate
            });
            safeSetItem('scenergy_history', JSON.stringify(history));
            window.updateHistoryList(); window.showToast("ìƒì„¸ ì •ë³´ ì €ì¥ ì™„ë£Œ");
        };

        window.downloadCSV = function() {
            let history = [];
            try { history = JSON.parse(safeGetItem('scenergy_history') || "[]"); } catch(e){}
            if(history.length === 0) return window.showToast("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const headers = ["ë‚ ì§œ", "ì£¼ì†Œ", "ìš©ëŸ‰", "ì—°ìˆ˜ìµ", "ìš©ë„ì§€ì—­", "ì§€ëª©", "ìƒíƒœë“±ê¸‰", "í•œì „ìš©ëŸ‰", "ì¼ì‚¬ëŸ‰", "AIì ìˆ˜", "ì¶”ì •ë•…ê°’"];
            const csvRows = [headers.join(",")];
            history.forEach(h => {
                csvRows.push([h.date, `"${h.address}"`, h.capacity, `"${h.revenue}"`, `"${h.zoning}"`, h.jimok, h.eco, `"${h.kepco}"`, h.sun, h.score, `"${h.price}"`].join(","));
            });
            const blob = new Blob(["\ufeff" + csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `SCEnergy_Scan_${new Date().getTime()}.csv`; link.click();
        };

        window.updateHistoryList = function() {
            const listEl = document.getElementById('historyList');
            if(!listEl) return;
            let history = [];
            try { history = JSON.parse(safeGetItem('scenergy_history') || "[]"); } catch(e){}
            if(history.length === 0) { listEl.innerHTML = '<p class="text-center py-4">ê¸°ë¡ ì—†ìŒ</p>'; return; }
            listEl.innerHTML = history.slice().reverse().map(h => `
                <div class="bg-slate-50 p-2 rounded border border-slate-200 text-xs mb-1">
                    <div class="font-bold truncate">${h.address}</div>
                    <div class="flex justify-between mt-1"><span class="text-blue-600 font-bold">${h.score || '-'}ì </span><span>${h.capacity}</span></div>
                </div>
            `).join('');
        };

        window.clearHistory = function() { if(confirm("ì „ì²´ ì‚­ì œ?")) { safeSetItem('scenergy_history', "[]"); window.updateHistoryList(); } };
        
        window.clearResults = function() { 
            if(panelGroup) panelGroup.clearLayers(); 
            if(selectableGroup) selectableGroup.clearLayers(); 
            if(analysisMarkerGroup) analysisMarkerGroup.clearLayers();
            selectedFeatures.clear(); 
            accumulatedPanelsCount=0; 
            _multiPanelsLayers = []; 
            
            document.getElementById('analysisAddress').innerText = "-";
            document.getElementById('analysisCount').innerText = "0 ì¥";
            document.getElementById('analysisCapacity').innerText = "0 kW";
            document.getElementById('resultCard').classList.add('hidden'); 
            document.getElementById('legalContent').classList.add('hidden');
            document.getElementById('aiScorePanel').classList.add('hidden');
            document.getElementById('legalPlaceholder').classList.remove('hidden');

            for (const k in currentAnalysisData) { try { delete currentAnalysisData[k]; } catch(e){} }
            window.currentAnalysisData = currentAnalysisData;
        };

        window.resetCalibration = function() { 
            currentGeoState = { x: 0, y: 0, rot: 0 }; 
            if(!currentAnalysisFeature || !_basePanelsFC) return;

            // âœ… ê¸°ì¤€ íŒ¨ë„(_basePanelsFC)ì„ ê·¸ëŒ€ë¡œ ë Œë” â†’ ì‹¤ì‹œê°„ í‘œì‹œ
            if (_currentPanelsLayer) { try { panelGroup.removeLayer(_currentPanelsLayer); } catch(e){} }
            _currentPanelsLayer = _renderPanels(_basePanelsFC);

            // ë‹¨ì¼ ëª¨ë“œ ì‹¤ì‹œê°„ ì¬ê³„ì‚°
            if (!isMultiSelectMode && typeof window.calculateFinance === 'function') {
                const cnt = (_basePanelsFC?.features?.length) || (window.accumulatedPanelsCount || 0);
                window.calculateFinance(cnt, window.currentAnalysisData?.ai_analysis?.sun_hours);
            }
        };
        
        window.applyCalibration = function(dx, dy, drot = 0) { 
            currentGeoState.x += dx; // meter
            currentGeoState.y += dy; 
            currentGeoState.rot += drot; 
            if(!currentAnalysisFeature || !_basePanelsFC) return;

            // âœ… "ê·¸ë¦¬ë“œ ì¬ê³„ì‚°"ì´ ì•„ë‹ˆë¼ "ê¸°ì¡´ íŒ¨ë„(ê¸°ì¤€)ì„ ë³€í™˜"ë§Œ í•´ì„œ ì¦‰ì‹œ ë°˜ì˜
            const movedFC = _applyCalibrationToFC(_basePanelsFC);

            if (_currentPanelsLayer) { try { panelGroup.removeLayer(_currentPanelsLayer); } catch(e){} }
            _currentPanelsLayer = _renderPanels(movedFC);

            // ë‹¨ì¼ ëª¨ë“œì¼ ë•Œë§Œ ì‹¤ì‹œê°„ ì¬ê³„ì‚°
            if (!isMultiSelectMode && typeof window.calculateFinance === 'function') {
                const cnt = movedFC?.features?.length || 0;
                window.calculateFinance(cnt, window.currentAnalysisData?.ai_analysis?.sun_hours);
            }
        };

        window.toggleMultiSelect = function() { 
            isMultiSelectMode = document.getElementById('multiSelectToggle').checked; 
            window.clearResults(); 
        };
        
        window.toggleAutoScan = function() { 
            autoScanMode = document.getElementById('autoScanToggle').checked; 
        };
        
        window.switchTab = function(m) { 
            const tabs = ['scan','analysis','legal','history'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const panel = document.getElementById(`panel-${t}`);
                if(btn) btn.classList.remove('active');
                if(panel) panel.classList.add('hidden');
            });
            const activeBtn = document.getElementById(`tab-${m}`);
            const activePanel = document.getElementById(`panel-${m}`);
            if(activeBtn) activeBtn.classList.add('active');
            if(activePanel) activePanel.classList.remove('hidden');
        }

        window.toggleTarget = function() { 
            const els = document.getElementsByName('scanTarget'); 
            els.forEach(e => { if(e.checked) scanTarget = e.value; }); 
            window.clearResults(); 
            window.showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === 'land' ? 'í† ì§€' : 'ì§€ë¶•'}`);
            if(map) { const c = map.getCenter(); window.scanBuildings(c.lat, c.lng, true); }
        };

        window.updateEstimatedTime = function() { 
            const d = parseInt(document.getElementById('scanDelay').value || "6000"); 
            const totalSteps = 20;
            const totalMs = totalSteps * d;
            window._missionTotalMs = totalMs;
            const tr = document.getElementById('timerRemaining');
            if (tr && !missionRunning) {
                const s = Math.floor(totalMs/1000);
                const mm = Math.floor(s/60);
                const ss = s % 60;
                tr.innerText = `ì˜ˆìƒ ì´ ${mm}ë¶„ ${ss}ì´ˆ`;
            }
        };

        window.startMission = async function() {
            if(!map) return;

            // Toggle behavior: start -> pause -> resume
            const btn = document.getElementById('startBtn');
            if (missionRunning) {
                // toggle pause/resume
                missionPaused = !missionPaused;
                 if (missionPaused) {
                     window._missionPausedLeftMs = Math.max(0, (_missionEndAt || Date.now()) - Date.now());
                 } else {
                     _missionEndAt = Date.now() + Math.max(0, window._missionPausedLeftMs || 0);
                     window._missionPausedLeftMs = 0;
                 }
                if (missionPaused) {
                    if (btn) btn.innerText = "â–¶ ì¬ê°œ";
                    window.showToast?.("ì¼ì‹œì •ì§€");
                } else {
                    if (btn) btn.innerText = "â¸ ì¼ì‹œì •ì§€";
                    window.showToast?.("ì¬ê°œ");
                }
                return;
            }

            // Fresh start
            const bounds = map.getBounds();
            const latStep = (bounds.getNorth()-bounds.getSouth())/4, lngStep = (bounds.getEast()-bounds.getWest())/5;
            const delay = parseInt(document.getElementById('scanDelay').value || "6000");

            stopScan = false;
            missionPaused = false;
            missionRunning = true;

            // countdown (best-effort)
            const totalSteps = 20;
            _missionEndAt = Date.now() + (totalSteps * delay);
            const timerEl = document.getElementById('timerRemaining');
            if (_missionTimer) { try { clearInterval(_missionTimer); } catch(e){} }
            _missionTimer = setInterval(() => {
                if (!timerEl) return;
                if (!missionRunning) { timerEl.innerText = "00:00:00"; return; }
                const msLeft = missionPaused ? Math.max(0, window._missionPausedLeftMs || 0) : Math.max(0, (_missionEndAt || Date.now()) - Date.now());
                const s = Math.floor(msLeft/1000);
                const hh = String(Math.floor(s/3600)).padStart(2,'0');
                const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
                const ss = String(s%60).padStart(2,'0');
                timerEl.innerText = `${hh}:${mm}:${ss}`;
            }, 250);

            if (btn) {
                btn.innerText = "â¸ ì¼ì‹œì •ì§€";
            }

            window.showToast?.("ìˆœì°¨ì  ìŠ¤ìº” ì‹œì‘");

            for (let i = 0; i < totalSteps; i++) {
                if(stopScan) { window.showToast?.("ìŠ¤ìº” ì·¨ì†Œë¨"); break; }

                // pause loop
                while (missionPaused && !stopScan) {
                    await new Promise(r => setTimeout(r, 200));
                }
                if(stopScan) break;

                const r = Math.floor(i/5), c = i%5;
                const lat = bounds.getSouth() + latStep*(r+0.5);
                const lng = bounds.getWest() + lngStep*(c+0.5);

                // follow map if enabled
                try {
                    const follow = document.getElementById('autoFollow')?.checked;
                    if (follow) map.setView([lat,lng], Math.max(map.getZoom(), 18), { animate: true });
                } catch(e){}

                await window.scanBuildings(lat, lng, true);

                const fc = document.getElementById('foundCount');
                if(fc) fc.innerText = String(selectableGroup ? selectableGroup.getLayers().length : 0);

                await new Promise(r => setTimeout(r, delay));
            }

            // finish
            missionRunning = false;
            missionPaused = false;
            stopScan = false;
            if (_missionTimer) { try { clearInterval(_missionTimer); } catch(e){} _missionTimer=null; }
            const timerEl2 = document.getElementById('timerRemaining');
            if (timerEl2) timerEl2.innerText = "00:00:00";

            if (btn) {
                btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";
            }
        };

        window.setRegion = function() { 
            if(!map) return;
            const val = document.getElementById('regionSelect').value; 
            const REGIONS = {
                'ansan_ind': [[37.31, 126.78], [37.31, 126.78]], 
                'hwaseong_ind': [[37.20, 126.77], [37.20, 126.77]],
                'cheonan_ind': [[36.85, 127.12], [36.85, 127.12]],
                'gumi_ind': [[36.11, 128.39], [36.11, 128.39]],
                'seoul': [[37.5665, 126.9780], [37.5665, 126.9780]],
                'jeju': [[33.4996, 126.5312], [33.4996, 126.5312]]
            };
            const bounds = REGIONS[val]; 
            if(bounds) { 
                map.setView(bounds[0], 15); 
                window.scanBuildings(bounds[0][0], bounds[0][1]); 
                window.updateEstimatedTime?.();
             window.showToast("ì§€ì—­ ì´ë™"); 
            }
        };
        
        window.toggleSidebar = function() { 
            document.getElementById('sidebar').classList.toggle('collapsed'); 
            document.getElementById('sidebar-toggle-btn').classList.toggle('collapsed'); 
        };

        window.onload = function() {
            window.updateEstimatedTime();
            try {
                let u = safeGetItem('scenergy_users');
                if(!u) safeSetItem('scenergy_users', JSON.stringify([{id:"admin", pw:"1234"}]));
            } catch(e){}
            window.logSystem("System Ready.");
        };
    

/* =========================
   SCEnergy Front Patch Pack
   - login/admin functions
   - openFullReport
   - reCalculate (finance refresh)
   - user list render
   ========================= */

window._sc_patch_loaded = true;

// Storage helpers fallback (in case removed)
window.safeGetItem = window.safeGetItem || function(key){ try { return localStorage.getItem(key); } catch(e){ return null; } };
window.safeSetItem = window.safeSetItem || function(key,val){ try { localStorage.setItem(key,val); } catch(e){ console.warn("Storage restricted"); } };

// --- Login / Logout ---
window.attemptLogin = async function() {
            const id = (document.getElementById('userId')?.value || '').trim();
            const pw = (document.getElementById('userPw')?.value || '').trim();
            if(!id || !pw) return window.showToast("ID/PWë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                // âœ… ì„œë²„ ì„¸ì…˜ ë¡œê·¸ì¸ (localStorage ì‚¬ìš© ì•ˆí•¨)
                const res = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ id, pw })
                });

                const data = await res.json().catch(() => ({}));
                if (res.ok && (data.ok === true || data.status === "OK")) {
                    isLoggedIn = true;
                    currentUser = data.user || id;

                    const overlay = document.getElementById('login-overlay');
                    if(overlay) overlay.classList.add('hidden-overlay');

                    const udisp = document.getElementById('currentUserDisplay');
                    if(udisp) udisp.innerText = currentUser;

                    window.initMap();
                    window.updateHistoryList();
                    window.showToast("ë¡œê·¸ì¸ ì™„ë£Œ");
                } else {
                    window.showToast("ë¡œê·¸ì¸ ì‹¤íŒ¨ (ID/PW í™•ì¸)");
                }
            } catch (e) {
                console.error(e);
                window.showToast("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
            }
        };

window.logout = async function(reason) {
            try {
                await fetch(`${BACKEND_URL}/api/auth/logout`, {
                    method: "POST",
                    credentials: "include"
                });
            } catch(e) {}
            window.location.reload();
        };

// --- Admin UI flow ---
window.showAdminLogin = function() {
  document.getElementById('step-user-login')?.classList.add('hidden');
  document.getElementById('step-admin-login')?.classList.remove('hidden');
};

window.exitAdminMode = function() {
  document.getElementById('step-admin-login')?.classList.add('hidden');
  document.getElementById('step-admin-dashboard')?.classList.add('hidden');
  document.getElementById('step-user-login')?.classList.remove('hidden');
};

window.verifyAdmin = async function () {

                const pw = (document.getElementById('adminPw')?.value || '').trim();
                if(!pw) return window.showToast("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                try{
                    const res = await fetch(`${BACKEND_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({id: 'admin', pw})
                    });
                    const data = await res.json().catch(()=>({}));
                    if(res.ok && data.status === 'OK' && data.role === 'admin'){
                        // show dashboard
                        document.getElementById('step-admin-login')?.classList.add('hidden');
                        document.getElementById('step-admin-dashboard')?.classList.remove('hidden');
                        document.getElementById('exit-admin-btn')?.classList.remove('hidden');
                        // load users
                        await window.refreshAdminUsers();
                        window.showToast("ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ");
                    }else{
                        window.showToast(data.msg || "ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨");
                    }
                }catch(e){
                    window.showToast("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
                }

}

// --- Users CRUD (localStorage) ---
window.renderUserList = async function () {
  const box = document.getElementById("user-list-container");
  const cnt = document.getElementById("user-count");
  if (!box) return;

  box.innerHTML = `<div class="text-[10px] text-slate-400 text-center py-3">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
  try {
    const res = await fetch(`${BACKEND_URL}/api/admin/users`, { method: "GET", credentials: "include" });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || (data.ok !== true && data.status !== "OK")) {
      box.innerHTML = `<div class="text-[10px] text-red-300 text-center py-3">${data.msg || "ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨"}</div>`;
      if (cnt) cnt.innerText = `-`;
      return;
    }

    const users = Array.isArray(data.users) ? data.users : [];
    if (cnt) cnt.innerText = `${users.length}ëª…`;

    if (users.length === 0) {
      box.innerHTML = `<div class="text-[10px] text-slate-400 text-center py-3">ë“±ë¡ëœ ìœ ì € ì—†ìŒ</div>`;
      return;
    }

    box.innerHTML = users.map(u => `
      <div class="flex items-center justify-between bg-slate-900/30 border border-slate-700 rounded px-2 py-1">
        <div class="text-[10px] text-slate-200 font-mono truncate">${u.id}</div>
        <button type="button" class="text-[10px] text-red-300 hover:text-red-200" onclick="window.removeUser('${String(u.id).replace(/'/g, "\'")}')">ì‚­ì œ</button>
      </div>
    `).join("");
  } catch (e) {
    console.error(e);
    box.innerHTML = `<div class="text-[10px] text-red-300 text-center py-3">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</div>`;
    if (cnt) cnt.innerText = `-`;
  }
};

window.addUser = async function () {
  const idEl = document.getElementById("newUserId");
  const pwEl = document.getElementById("newUserPw");
  const id = (idEl?.value || "").trim();
  const pw = (pwEl?.value || "").trim();
  if (!id || !pw) return window.showToast?.("ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  try {
    const res = await fetch(`${BACKEND_URL}/api/admin/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ id, pw })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || (data.ok !== true && data.status !== "OK")) {
      window.showToast?.(data.msg || "ìœ ì € ì¶”ê°€ ì‹¤íŒ¨");
      return;
    }
    if (idEl) idEl.value = "";
    if (pwEl) pwEl.value = "";
    window.showToast?.("ìœ ì € ì¶”ê°€ ì™„ë£Œ");
    window.renderUserList?.();
  } catch (e) {
    console.error(e);
    window.showToast?.("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
  }
};

window.removeUser = async function (id) {
  if (!id) return;
  if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;

  try {
    const res = await fetch(`${BACKEND_URL}/api/admin/users/${encodeURIComponent(id)}`, {
      method: "DELETE",
      credentials: "include"
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || (data.ok !== true && data.status !== "OK")) {
      window.showToast?.(data.msg || "ì‚­ì œ ì‹¤íŒ¨");
      return;
    }
    window.showToast?.("ì‚­ì œ ì™„ë£Œ");
    window.renderUserList?.();
  } catch (e) {
    console.error(e);
    window.showToast?.("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
  }
};

// --- Finance re-calc hook (parameter changes) ---
window.reCalculate = function() {
  try {
    // 1) íŒ¨ë„ íŒŒë¼ë¯¸í„°(ì´ê²©/ëª¨ë“ˆí¬ê¸°/ê°ë„ ë“±) ë³€ê²½ ì‹œ: ë‹¨ì¼ ëª¨ë“œì—ì„œëŠ” íŒ¨ë„ ê·¸ë¦¬ë“œë¥¼ ë‹¤ì‹œ ê³„ì‚°í•´ ë°˜ì˜
    if (!isMultiSelectMode && currentAnalysisFeature) {
      const prevState = { ...currentGeoState };
      if (panelGroup) panelGroup.clearLayers();

      const built = _buildPanelsGrid(currentAnalysisFeature.geometry);
      _basePanelsFC = built.fc;

      currentGeoState = prevState;
      const movedFC = _applyCalibrationToFC(_basePanelsFC);

      _currentPanelsLayer = _renderPanels(movedFC);
      accumulatedPanelsCount = movedFC?.features?.length || built.count || 0;

      window.calculateFinance?.(accumulatedPanelsCount, window.currentAnalysisData?.ai_analysis?.sun_hours);
      window.showToast?.("íŒ¨ë„/ì´ê²© ì¬ê³„ì‚° ì™„ë£Œ");
      return;
    }

    // 2) ë©€í‹° ëª¨ë“œ: ì¬ë¬´ë§Œ ì¬ê³„ì‚°
    const cnt = window.accumulatedPanelsCount || 0;
    if (cnt > 0 && typeof window.calculateFinance === 'function') {
      const sun = window.currentAnalysisData?.ai_analysis?.sun_hours;
      window.calculateFinance(cnt, sun);
      window.showToast?.("ì¬ê³„ì‚° ì™„ë£Œ");
    }
  } catch(e) {
    console.warn("reCalculate failed", e);
  }
};

// --- Full report submit ---
window.openFullReport = function() {
  if (!window.currentAnalysisData?.finance) return window.showToast?.("ë¨¼ì € ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.");

  const form = document.getElementById('reportForm');
  if (!form) return window.showToast?.("ë¦¬í¬íŠ¸ í¼ì´ ì—†ìŠµë‹ˆë‹¤.");

  document.getElementById('form_address').value = window.currentAnalysisData.address || '';
  document.getElementById('form_capacity').value = (window.currentAnalysisData.finance.capacity || window.currentAnalysisData.finance.acCapacity || '');
  document.getElementById('form_kepco').value = window.currentAnalysisData?.ai_analysis?.kepco_capacity || 'ì •ë³´ ì—†ìŒ';
  document.getElementById('form_date').value = window.currentAnalysisData.date || new Date().toLocaleDateString();
  document.getElementById('form_finance').value = JSON.stringify(window.currentAnalysisData.finance || {});
  document.getElementById('form_ai').value = JSON.stringify(window.currentAnalysisData.ai_analysis || {});
  document.getElementById('form_score').value = JSON.stringify(window.currentAnalysisData?.ai_analysis?.ai_score || {});
  document.getElementById('form_price').value = String(window.currentAnalysisData?.ai_analysis?.price_estimate || window.currentAnalysisData?.ai_analysis?.land_price || '');

  // BACKEND_URL should exist
  if (typeof window.BACKEND_URL !== 'undefined') {
    form.action = window.BACKEND_URL + "/report";
  }
  form.submit();
};

// Ensure admin list shows when dashboard opens (if user navigates directly)
document.addEventListener('click', function(e){
  const target = e.target;
  if (!target) return;
  if (target.closest && target.closest('#step-admin-dashboard')) {
    if (typeof window.renderUserList === 'function') window.renderUserList();
  }
});



    // -------------------------
// Auto-scan visualization (yellow dashed box)
// -------------------------
let _autoScanBox = null;
function _updateAutoScanBox() {
  try {
    if (!map) return;
    if (!autoScanMode) {
      if (_autoScanBox) { map.removeLayer(_autoScanBox); _autoScanBox = null; }
      return;
    }
    const c = map.getCenter();
    const zoom = map.getZoom();
    // about 200m box at high zoom, otherwise larger
    const meters = zoom >= 18 ? 220 : (zoom >= 16 ? 380 : 650);
    const dLat = meters / 111000;
    const dLng = meters / (111320 * Math.cos(c.lat * Math.PI / 180));
    const bounds = [[c.lat - dLat, c.lng - dLng],[c.lat + dLat, c.lng + dLng]];
    if (!_autoScanBox) {
      _autoScanBox = L.rectangle(bounds, { color: '#fbbf24', weight: 2, fillOpacity: 0, dashArray: '6 6' });
      _autoScanBox.addTo(map);
    } else {
      _autoScanBox.setBounds(bounds);
    }
  } catch(e){}
}

// -------------------------
// Infra markers (substations / existing plants)
// - lightweight mock + zoom gating
// -------------------------
window.refreshInfraMarkers = function(){
  if(!map) return;
  const z = map.getZoom();
  const show = z >= 13;

  try {
    if (!document.getElementById('substationToggle')?.checked) {
      substationGroup?.clearLayers();
      map.removeLayer(substationGroup);
    } else {
      map.addLayer(substationGroup);
      if (show) substationGroup?.clearLayers();
    }
  } catch(e){}

  try {
    if (!document.getElementById('existingPlantToggle')?.checked) {
      existingGroup?.clearLayers();
      map.removeLayer(existingGroup);
    } else {
      map.addLayer(existingGroup);
      if (show) existingGroup?.clearLayers();
    }
  } catch(e){}

  if(!show) return;

  const b = map.getBounds();
  const mk = (lat,lng, type)=>{
    const iconHtml = type === 'plant'
      ? `<div class="custom-div-icon" title="ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘"><div style="width:18px;height:12px;background:#ef4444;border:1px solid #991b1b;transform:skewX(-18deg);border-radius:2px;box-shadow:0 2px 6px rgba(0,0,0,.35)"></div></div>`
      : `<div class="substation-marker w-8 h-8" title="ë³€ì „ì†Œ"><i class="ph ph-circuitry text-white"></i></div>`;
    const icon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: type==='plant'?[20,16]:[24,24] });
    const marker = L.marker([lat,lng], { icon, title: type });
    marker.bindPopup(type === 'plant' ? "ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘(ì¶”ì •)" : "ë³€ì „ì†Œ/ì„ ë¡œ(ì¶”ì •) - í´ë¦­ í›„ ìƒì„¸ í™•ì¸");
    return marker;
  };

  const n = 4;
  for(let i=0;i<n;i++){
    const lat = b.getSouth() + Math.random() * (b.getNorth()-b.getSouth());
    const lng = b.getWest() + Math.random() * (b.getEast()-b.getWest());
    if (document.getElementById('substationToggle')?.checked) mk(lat,lng,'substation').addTo(substationGroup);
    if (document.getElementById('existingPlantToggle')?.checked) mk(lat+0.001*(Math.random()-0.5), lng+0.001*(Math.random()-0.5),'plant').addTo(existingGroup);
  }
};

// -------------------------
// D-Pad press-and-hold fine tune
// -------------------------
(function bindDpadHold(){
  function setup(btn, dx, dy, drot){
    if(!btn) return;
    let t=null;
    const stepMove = 0.10; // meters per tick
    const stepRot = 0.4;   // degrees per tick
    const tick = () => window.applyCalibration(dx? dx*stepMove:0, dy? dy*stepMove:0, drot? drot*stepRot:0);
    const start = (e)=>{
      if(e) e.preventDefault();
      tick();
      t = setInterval(tick, 60);
    };
    const stop = ()=>{ if(t){ clearInterval(t); t=null; } };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start, {passive:false});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => btn.addEventListener(ev, stop));
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const btns = Array.from(document.querySelectorAll('.d-pad-btn'));
    btns.forEach(b=>{
      const t = (b.innerText||'').trim();
      if(t==='â–²') setup(b, 0, 1, 0);
      else if(t==='â–¼') setup(b, 0, -1, 0);
      else if(t==='â—€') setup(b, -1, 0, 0);
      else if(t==='â–¶') setup(b, 1, 0, 0);
      else if(t.includes('â†º')) setup(b, 0, 0, -1);
      else if(t.includes('â†»')) setup(b, 0, 0, 1);
    });
  });
})();

// =========================
    // UX ë³´í˜¸ìš©: ìš°í´ë¦­/ì¼ë¶€ ë‹¨ì¶•í‚¤ ì°¨ë‹¨ (ì™„ì „ ë³´ì•ˆ ëª©ì  ì•„ë‹˜)
    // =========================
    document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
        return false;
    }, { capture: true });

    document.addEventListener('keydown', function (e) {
        // F12
        if (e.key === 'F12') { e.preventDefault(); return false; }
        // Ctrl+Shift+I / J / C
        if (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(String(e.key).toUpperCase())) {
            e.preventDefault(); return false;
        }
        // Ctrl+U (ì†ŒìŠ¤ë³´ê¸°)
        if (e.ctrlKey && String(e.key).toLowerCase() === 'u') { e.preventDefault(); return false; }
    }, { capture: true });

        // -------------------------------------------------
        // Public mode bootstrap (no login)
        // -------------------------------------------------
        document.addEventListener("DOMContentLoaded", () => {
            try {
                // mark logged in for any guards in code
                isLoggedIn = true;
                currentUser = "public";
                const u = document.getElementById("currentUserDisplay");
                if (u) u.innerText = "Public Access";

                // initialize map immediately
                if (typeof window.initMap === "function") window.initMap();
            } catch (e) {
                console.error(e);
            }
        });

</script>
</body>
</html>
