<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ Pathfinder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Kakao Maps JS SDK -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ea4222b65d3c25740e8da76864c686c4&libraries=services"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        

/* ì„¤ì • ëª¨ë‹¬ ë’¤ ì–´ë‘ìš´ ë§‰ì„ ê±°ì˜ ì œê±°í•´ì„œ ì§€ë„ê°€ ë” ì˜ ë³´ì´ë„ë¡ */
#settingsOverlay > .absolute.inset-0 {
  background-color: rgba(0,0,0,0.02) !important;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

/* Body ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ì„¤ì •í•´ì„œ ì§€ë„(Leaflet)ê°€ ë’¤ì—ì„œ ë³´ì´ë„ë¡ */
body.bg-gray-100 {
  background-color: transparent !important;
}

#map { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; background: #000; }
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        /* ëª¨ë‹¬ ì•ˆì—ì„œ ì‚¬ì´ë“œë°”ë¥¼ ì •ìƒ ë¸”ë¡ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•œ override */
        #settingsOverlay #sidebar {

        #sidebar [data-role="scan-target-sidebar"] {
          display: none;
        }
          position: relative;
          top: auto;
          left: auto;
          right: auto;
          bottom: auto;
          height: auto;
          max-height: none;
          width: 100%;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        #sidebar-toggle-btn { left: 420px; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2001; }
        #sidebar-toggle-btn.collapsed { left: 0; }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: #f8fafc; }
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; color: white; font-size: 16px; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:active { background: #1e293b; transform: translateY(2px); box-shadow: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
#map { background: #0b1220; }

/* Step34b: Finance panel label contrast fix */
.bg-green-50 label.text-slate-200{ color:#334155 !important; } /* slate-700 */

#bottomStatusInner {
  transform: translateY(calc(100% - 32px));
  transition: transform 0.3s ease-out;
}
#bottomStatusInner.open {
  transform: translateY(0);
}

/* í—¤ë” íƒ€ì´í‹€ ê·¸ë¼ë°ì´ì…˜ ëª¨ì…˜ */
.title-gradient {
  background-image: none;
  background-size: 200% 200%;
  animation: none;
}

@keyframes titleGradientMotion {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

        /* í—¤ë” íƒ€ì´í‹€ ìƒ¤ì´ë‹ˆ íš¨ê³¼ (ë” ì–‡ì€ ìœ ë¦¬ ë°°ê²½) override */
        .title-gradient {
          position: relative;
          overflow: hidden;
          background-color: rgba(15,23,42,0.06); /* ì‚´ì§ë§Œ ì–´ë‘¡ê²Œ, ê±°ì˜ íˆ¬ëª… */
          backdrop-filter: blur(18px) saturate(190%);
          -webkit-backdrop-filter: blur(18px) saturate(190%);
        }
        .title-gradient * {
          position: relative;
          z-index: 1;
        }
        .title-gradient::before {
          content: "";
          position: absolute;
          inset: -40%;
          background-image: linear-gradient(120deg, transparent, rgba(255,255,255,0.9), transparent);
          opacity: 0.55;
          transform: translateX(-120%);
          animation: titleShine 3.2s ease-in-out infinite;
          pointer-events: none;
        }
        @keyframes titleShine {
          0%   { transform: translateX(-120%); }
          45%  { transform: translateX(120%); }
          100% { transform: translateX(120%); }
        }

        /* D-Pad í¬ë¦¬ìŠ¤íƒˆ HUD ìŠ¤íƒ€ì¼ */
        
/* ìƒë‹¨ ëª¨ë“œ í† ê¸€ ë°”ë¥¼ í¬ë¦¬ìŠ¤íƒˆ ëŠë‚Œìœ¼ë¡œ */
.glass-toolbar {
  position: relative;
  /* ê·¹ë‹¨ì ìœ¼ë¡œ ì–‡ì€ ìœ ë¦¬ ëŠë‚Œ */
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.10), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(14,165,233,0.08), transparent 65%),
    linear-gradient(120deg, rgba(15,23,42,0.28), rgba(15,23,42,0.14));
  backdrop-filter: blur(22px) saturate(200%);
  -webkit-backdrop-filter: blur(22px) saturate(200%);
  border: 1px solid rgba(148,163,184,0.45);
  box-shadow:
    0 8px 20px rgba(15,23,42,0.45),
    0 0 0 1px rgba(148,163,184,0.45);
}

/* ìƒë‹¨ í† ì§€/ì§€ë¶• í† ê¸€ ë˜í¼ë¥¼ í—¤ë” ê¸°ì¤€ ì¢Œìš° ì •ì¤‘ì•™ì— ê³ ì • */
.header-mode-toggle-wrap {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}


/* ìƒë‹¨ 'ìƒì„¸ ì„¤ì •' ë²„íŠ¼ë„ íˆ¬ëª… ìœ ë¦¬ ëŠë‚Œìœ¼ë¡œ */
.settings-button-glass {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.16), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(34,211,238,0.14), transparent 70%),
    linear-gradient(135deg, rgba(15,23,42,0.55), rgba(15,23,42,0.30));
  backdrop-filter: blur(18px) saturate(190%);
  -webkit-backdrop-filter: blur(18px) saturate(190%);
  border: 1px solid rgba(34,211,238,0.7);
  box-shadow:
    0 10px 24px rgba(15,23,42,0.7),
    0 0 0 1px rgba(8,47,73,0.9);
  transition: background 0.18s ease-out, box-shadow 0.18s ease-out, transform 0.18s ease-out;
}

/* í•˜ë‹¨ 'ìƒíƒœ / ë¡œê·¸' í† ê¸€ ë²„íŠ¼ë„ ìœ ë¦¬ ìŠ¤íƒ€ì¼ë¡œ */
.bottom-status-toggle-glass {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.18), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(37,99,235,0.16), transparent 70%),
    linear-gradient(135deg, rgba(15,23,42,0.60), rgba(15,23,42,0.34));
  backdrop-filter: blur(18px) saturate(190%);
  -webkit-backdrop-filter: blur(18px) saturate(190%);
  border: 1px solid rgba(148,163,184,0.7);
  box-shadow:
    0 10px 22px rgba(15,23,42,0.75),
    0 0 0 1px rgba(15,23,42,0.7);
  transition: background 0.18s ease-out, box-shadow 0.18s ease-out, transform 0.18s ease-out;
}
.bottom-status-toggle-glass:hover {
  transform: translateY(-1px);
  box-shadow:
    0 14px 28px rgba(15,23,42,0.85),
    0 0 0 1px rgba(56,189,248,0.85);
}

.settings-button-glass:hover {
  transform: translateY(-1px);
  box-shadow:
    0 14px 28px rgba(15,23,42,0.85),
    0 0 0 1px rgba(56,189,248,0.9);
}


/* ì£¼ì†Œ ì…ë ¥ì°½ë„ íˆ¬ëª… ìœ ë¦¬ ëŠë‚Œìœ¼ë¡œ */
.address-glass {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.12), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(59,130,246,0.10), transparent 70%),
    linear-gradient(135deg, rgba(15,23,42,0.50), rgba(15,23,42,0.26));
  backdrop-filter: blur(18px) saturate(190%);
  -webkit-backdrop-filter: blur(18px) saturate(190%);
  border-color: rgba(148,163,184,0.6);
}


/* ìš°ì¸¡ í•˜ë‹¨ Zoom í‘œì‹œ ë°” í¬ë¦¬ìŠ¤íƒˆ ìŠ¤íƒ€ì¼ */
.zoom-indicator-glass {
  position: absolute;
  right: 64px;
  bottom: 34px;
  z-index: 1200;
  padding: 4px 12px;
  font-size: 12px;
  border-radius: 10px;
  color: #e5edff;
  /* ì•„ì£¼ ì–‡ì€ í¬ë¦¬ìŠ¤íƒˆ íƒœê·¸ ëŠë‚Œ */
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.12), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(59,130,246,0.10), transparent 70%),
    linear-gradient(135deg, rgba(15,23,42,0.46), rgba(15,23,42,0.24));
  backdrop-filter: blur(20px) saturate(200%);
  -webkit-backdrop-filter: blur(20px) saturate(200%);
  border: 1px solid rgba(148,163,184,0.45);
  box-shadow:
    0 8px 20px rgba(15,23,42,0.55),
    0 0 0 1px rgba(148,163,184,0.45);
  pointer-events: none;
}

        /* Kakao map layer overlays Leaflet map inside same container */
        #map {
          position: relative;
        }
        .kakao-map-layer {
          position: absolute;
          inset: 0;
          z-index: 0;
        }



/* í•˜ë‹¨ ìƒíƒœ/ë¡œê·¸ íŒ¨ë„ í‹€ì„ í¬ë¦¬ìŠ¤íƒˆ í´ë¦¬ì–´ ìŠ¤íƒ€ì¼ë¡œ */

/* ë ˆì´ì–´ ë²„íŠ¼ (ë™ê·¸ë€ ìŠ¤íƒ ì•„ì´ì½˜)ë„ ìœ ë¦¬ ëŠë‚Œìœ¼ë¡œ */
.layer-button-glass {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.18), transparent 75%),
    radial-gradient(circle at 100% 100%, rgba(129,140,248,0.18), transparent 70%),
    linear-gradient(145deg, rgba(15,23,42,0.60), rgba(15,23,42,0.32));
  backdrop-filter: blur(18px) saturate(200%);
  -webkit-backdrop-filter: blur(18px) saturate(200%);
  border: 1px solid rgba(148,163,184,0.6);
  box-shadow:
    0 9px 22px rgba(15,23,42,0.65),
    0 0 0 1px rgba(148,163,184,0.55);
  transition: background 0.18s ease-out, box-shadow 0.18s ease-out, transform 0.18s ease-out;
}
.layer-button-glass:hover {
  transform: translateY(-1px);
  box-shadow:
    0 13px 28px rgba(15,23,42,0.8),
    0 0 0 1px rgba(56,189,248,0.85);
}
.layer-button-glass:hover {
  transform: translateY(-1px);
  box-shadow:
    0 14px 30px rgba(15,23,42,0.85),
    0 0 0 1px rgba(56,189,248,0.75);
}

/* ë ˆì´ì–´/ì§€ë„ ì„¤ì • ì¹´ë“œë„ ë°˜íˆ¬ëª… í¬ë¦¬ìŠ¤íƒˆ ì¹´ë“œë¡œ */
.layer-menu-glass {
  /* ì§€ë„ ì„¤ì • ì¹´ë“œë„ ë§¤ìš° ì–‡ì€ ìœ ë¦¬ ëŠë‚Œ */
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.10), transparent 75%),
    radial-gradient(circle at 100% 100%, rgba(129,140,248,0.10), transparent 75%),
    linear-gradient(135deg, rgba(15,23,42,0.64), rgba(15,23,42,0.40));
  color: #e5edff;
  backdrop-filter: blur(22px) saturate(200%);
  -webkit-backdrop-filter: blur(22px) saturate(200%);
  border: 1px solid rgba(148,163,184,0.55);
  box-shadow:
    0 16px 32px rgba(15,23,42,0.75),
    0 0 0 1px rgba(148,163,184,0.55);
}
.layer-menu-glass .text-slate-600 { color: #d0ddff; }
.layer-menu-glass .text-slate-500 { color: #b4c4ff; }
.layer-menu-glass .hover\:bg-slate-50:hover { background-color: rgba(248,250,252,0.04); }
.layer-menu-glass .text-slate-600 { color: #cbd5ff; }
.layer-menu-glass .text-slate-500 { color: #a5b4ff; }
.layer-menu-glass .hover\:bg-slate-50:hover { background-color: rgba(248,250,252,0.06); }

.bottom-status-glass {
  position: relative;
  /* ê·¹ë‹¨ì ìœ¼ë¡œ íˆ¬ëª…í•˜ê³  ê°€ë²¼ìš´ ìœ ë¦¬ íŒ¨ë„ */
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.10), transparent 80%),
    radial-gradient(circle at 100% 100%, rgba(37,99,235,0.10), transparent 75%),
    linear-gradient(135deg, rgba(15,23,42,0.52), rgba(15,23,42,0.30));
  backdrop-filter: blur(24px) saturate(200%);
  -webkit-backdrop-filter: blur(24px) saturate(200%);
  border-top: 1px solid rgba(148,163,184,0.5);
  box-shadow:
    0 -10px 24px rgba(15,23,42,0.55),
    0 0 0 1px rgba(148,163,184,0.5);
}

.crystal-dpad {
          position: relative;
          border-radius: 0.75rem;
          background-color: rgba(15,23,42,0.14);
          border: 1px solid rgba(148,163,184,0.7);
          backdrop-filter: blur(6px);
          box-shadow: 0 18px 40px rgba(15,23,42,0.9);
        }
        .crystal-dpad::before {
          content: "";
          position: absolute;
          inset: 0;
          border-radius: inherit;
          background: radial-gradient(circle at top left, rgba(255,255,255,0.14), transparent 55%);
          opacity: 0.9;
          pointer-events: none;
          mix-blend-mode: screen;
        }

/* === Crystal sidebar & ë¶„ì„ íŒŒë¼ë¯¸í„° ì•„ì½”ë””ì–¸ === */
#sidebar {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.03), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(129,140,248,0.035), transparent 70%),
    linear-gradient(135deg, rgba(15,23,42,0.16), rgba(15,23,42,0.06));
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  animation: sidebarCrystalGradient 18s ease-in-out infinite;
  background-size: 220% 220%;
}

@keyframes sidebarCrystalGradient {
  0% { background-position: 0% 0%; }
  50% { background-position: 100% 100%; }
  100% { background-position: 0% 0%; }
}

/* ë¶„ì„ íŒŒë¼ë¯¸í„° ì•„ì½”ë””ì–¸ ì‹œê° íš¨ê³¼ + ì—´ë¦´ ë•Œ ì‚´ì§ ëœ¨ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
details.crystal-accordion > summary {
  cursor: pointer;
  transition: color .2s ease,
              background-color .2s ease,
              box-shadow .2s ease,
              transform .2s ease;
}

details.crystal-accordion[open] > summary {
  box-shadow: 0 0 0 1px rgba(129,140,248,0.5),
              0 14px 40px rgba(15,23,42,0.9);
}

details.crystal-accordion .param-body {
  overflow: hidden;
  animation: crystalAccordionDown .22s ease-out;
}

@keyframes crystalAccordionDown {
  0%   { opacity: 0; transform: translateY(-6px); }
  100% { opacity: 1; transform: translateY(0); }
}


/* === ì „ìˆ˜ ìŠ¤ìº” íŒ¨ë„ í¬ë¦¬ìŠ¤íƒˆ ìƒ¤ì´ë‹ˆ íš¨ê³¼ === */
.scan-panel-crystal {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.04), transparent 60%),
    radial-gradient(circle at 100% 100%, rgba(129,140,248,0.06), transparent 60%),
    linear-gradient(135deg, rgba(15,23,42,0.18), rgba(15,23,42,0.08));
  backdrop-filter: blur(20px) saturate(170%);
  -webkit-backdrop-filter: blur(20px) saturate(170%);
  border-radius: 0.9rem;
  border: 1px solid rgba(148,163,184,0.7);
  box-shadow:
    0 22px 55px rgba(15,23,42,0.88),
    0 0 0 1px rgba(15,23,42,0.85);
  position: relative;
  overflow: hidden;
}

.scan-panel-crystal::before {
  content: "";
  position: absolute;
  inset: -120%;
  background: conic-gradient(
    from 0deg,
    rgba(56,189,248,0.0),
    rgba(56,189,248,0.45),
    rgba(236,72,153,0.40),
    rgba(56,189,248,0.0)
  );
  opacity: 0.25;
  transform: translate3d(-50%, -50%, 0) rotate(0deg);
  animation: scanCrystalSweep 18s linear infinite;
  pointer-events: none;
}

.scan-panel-crystal::after {
  content: "";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at 0% 0%, rgba(255,255,255,0.16), transparent 55%),
    radial-gradient(circle at 100% 0%, rgba(255,255,255,0.10), transparent 45%);
  opacity: 0.40;
  pointer-events: none;
}

.scan-panel-crystal > * {
  position: relative;
  z-index: 1;
}

@keyframes scanCrystalSweep {
  0% {
    transform: translate3d(-60%, -60%, 0) rotate(0deg);
  }
  50% {
    transform: translate3d(0%, 0%, 0) rotate(180deg);
  }
  100% {
    transform: translate3d(60%, 60%, 0) rotate(360deg);
  }
}

/* íƒ€ì´ë¨¸/í”„ë¡œê·¸ë ˆìŠ¤ë°” ìƒ¤ì´ë‹ˆ íš¨ê³¼ */
.scan-panel-crystal .scan-timer {
  font-variant-numeric: tabular-nums;
  text-shadow:
    0 0 8px rgba(34,211,238,0.9),
    0 0 20px rgba(34,211,238,0.7);
}

.scan-panel-crystal .scan-progress-outer {
  background: linear-gradient(to right,
    rgba(15,23,42,0.9),
    rgba(15,23,42,0.98)
  );
  border-radius: 999px;
  overflow: hidden;
  box-shadow:
    0 0 0 1px rgba(8,47,73,0.9),
    0 0 26px rgba(56,189,248,0.7);
}

.scan-panel-crystal .scan-progress-inner {
  background: linear-gradient(90deg,
    #22d3ee,
    #a855f7,
    #fb7185
  );
  box-shadow:
    0 0 8px rgba(34,211,238,0.9),
    0 0 18px rgba(56,189,248,0.9);
}


/* === Global Crystal Glass UI for Main SCEnergy Panel === */
.glass-main-panel {
  position: relative;
  /* ë” íˆ¬ëª…í•œ í¬ë¦¬ìŠ¤íƒˆ ëŠë‚Œìœ¼ë¡œ: ë°°ê²½ ì–´ë‘¡ê¸°ì™€ ê·¸ë¦¼ì ê°•ë„ ê°ì†Œ */
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.03), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(129,140,248,0.03), transparent 65%),
    linear-gradient(135deg, rgba(15,23,42,0.05), rgba(15,23,42,0.015));
  backdrop-filter: blur(22px) saturate(180%);
  -webkit-backdrop-filter: blur(22px) saturate(180%);
  border-radius: 1.2rem;
  border: 1px solid rgba(148,163,184,0.38);
  box-shadow:
    0 12px 32px rgba(15,23,42,0.55),
    0 0 0 1px rgba(15,23,42,0.35);
  overflow: hidden;
}

.glass-main-panel::before {
  content: "";
  position: absolute;
  inset: -120%;
  background: conic-gradient(
    from 0deg,
    rgba(56,189,248,0.0),
    rgba(56,189,248,0.55),
    rgba(236,72,153,0.45),
    rgba(129,140,248,0.65),
    rgba(56,189,248,0.0)
  );
  opacity: 0.25;
  transform: translate3d(-50%, -50%, 0) rotate(0deg);
  animation: mainCrystalSweep 28s linear infinite;
  pointer-events: none;
}

.glass-main-panel::after {
  content: "";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at 0% 0%, rgba(255,255,255,0.10), transparent 55%),
    radial-gradient(circle at 100% 0%, rgba(255,255,255,0.06), transparent 45%);
  opacity: 0.15;
  pointer-events: none;
}

/* ìƒë‹¨ SCEnergy í—¤ë”ë¥¼ ìœ ë¦¬ + ì»¬ëŸ¬ ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ */

/* ì§€ì—­ ì„ íƒ ë“œë¡­ë‹¤ìš´ ê°€ë…ì„± í–¥ìƒì„ ìœ„í•´ ê¸€ììƒ‰ì„ ì§„í•˜ê²Œ */
#regionSelect,
#regionSelect option {
  color: #020617 !important; /* near-black */
}

.glass-header {
  background:
    radial-gradient(circle at 0% 0%, rgba(56,189,248,0.35), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(236,72,153,0.32), transparent 55%),
    linear-gradient(135deg, rgba(15,23,42,0.45), rgba(15,23,42,0.08));
  backdrop-filter: blur(26px) saturate(160%);
  -webkit-backdrop-filter: blur(26px) saturate(160%);
  border-radius: 1.2rem 1.2rem 0.9rem 0.9rem;
  border-bottom: 1px solid rgba(148,163,184,0.80);
  box-shadow:
    0 22px 55px rgba(15,23,42,0.88),
    0 0 0 1px rgba(15,23,42,0.85);
}

/* í—¤ë” ì•ˆì˜ íƒ€ì´í‹€ê³¼ ì•„ì´ì½˜ì€ ë” ë˜ë ·í•˜ê²Œ */
.glass-header h1 {
  color: #f9fbff;
  text-shadow:
    0 1px 3px rgba(15,23,42,0.95),
    0 0 18px rgba(59,130,246,0.95);
}

.glass-header i {
  filter: drop-shadow(0 0 8px rgba(250,250,210,0.9));
}

.glass-main-panel > * {
  position: relative;
  z-index: 1;
}

@keyframes mainCrystalSweep {
  0% {
    transform: translate3d(-65%, -65%, 0) rotate(0deg);
  }
  50% {
    transform: translate3d(0%, 0%, 0) rotate(180deg);
  }
  100% {
    transform: translate3d(65%, 65%, 0) rotate(360deg);
  }
}

/* íƒ­ ë°” ìœ ë¦¬ ëŠë‚Œ */
.glass-tabs {
  background:
    linear-gradient(90deg,
      rgba(56,189,248,0.22),
      rgba(129,140,248,0.45),
      rgba(15,23,42,0.75)
    );
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-bottom: 1px solid rgba(148,163,184,0.65);
  box-shadow: 0 12px 30px rgba(15,23,42,0.85);
}

/* íƒ­ ë²„íŠ¼ hover/active ì‹œ ì‚´ì§ ë– ì˜¤ë¥´ëŠ” ëŠë‚Œ */
.glass-tabs button {
  position: relative;
  overflow: hidden;
}

.glass-tabs button::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 50% 0%, rgba(56,189,248,0.22), transparent 65%);
  opacity: 0;
  transition: opacity .2s ease-out;
}

.glass-tabs button:hover::before,
.glass-tabs button[aria-current="true"]::before {
  opacity: 1;
}

/* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì˜ì—­ ì „ì²´ ë°°ê²½ */

/* í¬ë¦¬ìŠ¤íƒˆ íŒ¨ë„ ë‚´ë¶€ì˜ ì—°í•œ ë°°ê²½(í™”ì´íŠ¸/ë¼ì´íŠ¸ ê·¸ë ˆì´)ì„ ëª¨ë‘ ì–‡ì€ ìœ ë¦¬ë§‰ìœ¼ë¡œ í†µì¼ */
.glass-main-panel .bg-white,
.glass-main-panel .bg-slate-50,
.glass-main-panel .bg-slate-100,
.glass-main-panel .bg-gray-50,
.glass-main-panel .bg-gray-100 {
  background-color: rgba(15,23,42,0.03) !important;
}
.glass-scroll {
  background:
    radial-gradient(circle at 0% 0%, rgba(30,64,175,0.02), transparent 70%),
    radial-gradient(circle at 100% 100%, rgba(8,47,73,0.02), transparent 70%),
    linear-gradient(180deg, rgba(15,23,42,0.06), rgba(15,23,42,0.02));
}

/* ì•„ì½”ë””ì–¸ ë° ì¹´ë“œë“¤ì„ ìœ ë¦¬ íŒ¨ë„ë¡œ */


/* ì—°ë…¹/ì—°ë³´ë¼ ì˜ì—­ë„ íˆ¬ëª…ë„ ìˆê²Œ */
.glass-main-panel .bg-indigo-50,
.glass-main-panel .bg-green-50 {
  background-color: rgba(15,23,42,0.24) !important;
}

/* ì…ë ¥ í•„ë“œ / ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìœ ë¦¬í†¤ */
.glass-main-panel input[type="text"],
.glass-main-panel input[type="number"],
.glass-main-panel input[type="email"],
.glass-main-panel input[type="password"],
.glass-main-panel select,
.glass-main-panel textarea {
  background-color: rgba(15,23,42,0.78) !important;
  border-color: rgba(148,163,184,0.75) !important;
  color: #e5f0ff !important;
}

.glass-main-panel input::placeholder,
.glass-main-panel textarea::placeholder {
  color: rgba(148,163,184,0.85) !important;
}

/* PF ìš”ì•½/ì§€í‘œ ë°•ìŠ¤ ëŠë‚Œ ì •ë¦¬ */
.glass-main-panel .border-green-200,
.glass-main-panel .border-indigo-200 {
  border-color: rgba(74,222,128,0.55) !important;
}


/* ì „ì²´ ê¸€ì ëŒ€ë¹„ë¥¼ ë” ì˜¬ë ¤ì„œ ì§€ë„ ìœ„ì—ì„œë„ ë˜ë ·í•˜ê²Œ ë³´ì´ë„ë¡ */
.glass-main-panel,
.glass-main-panel .text-slate-400,
.glass-main-panel .text-slate-500,
.glass-main-panel .text-slate-600,
.glass-main-panel .text-gray-500,
.glass-main-panel .text-gray-600 {
  color: #e9f2ff !important;
}

.glass-main-panel .text-slate-300,
.glass-main-panel .text-gray-400 {
  color: #f5f7ff !important;
}

/* ê²½ê³ /ê°•ì¡° ìƒ‰ìƒì€ ìœ ì§€ */
.glass-main-panel .text-red-500,
.glass-main-panel .text-red-600,
.glass-main-panel .text-emerald-500,
.glass-main-panel .text-emerald-600,
.glass-main-panel .text-yellow-500 {
  color: inherit;
}
/* ë¼ë²¨ ë° ì†Œì œëª© í…ìŠ¤íŠ¸ëŠ” ì¡°ê¸ˆ ë” ë°ê²Œ */
.glass-main-panel label,
.glass-main-panel .text-gray-700,
.glass-main-panel .text-slate-700 {
  color: #e5edff !important;
}


#addrInput {
  color: #f97316;
}
#addrInput::placeholder {
  color: rgba(148,163,184,0.85);
}

/* option-fix */
select option{color:#0f172a;background:#ffffff;}
</style>
</head>
<body class="bg-gray-100">
<!-- Public Access Key Modal -->
<div id="publicAuthModal" class="fixed inset-0 z-[9999] hidden items-center justify-center">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="relative w-[92%] max-w-md rounded-2xl border border-white/10 bg-slate-900/90 p-6 shadow-2xl">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-cyan-500/20 flex items-center justify-center text-cyan-300 font-bold">SP</div>
      <div>
        <div class="text-white text-lg font-semibold">ì ‘ê·¼ ì¸ì¦í‚¤ ë“±ë¡</div>
        <div class="text-slate-300 text-sm">ìµœì´ˆ 1íšŒë§Œ ë“±ë¡í•˜ë©´ ìë™ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="mt-5">
      <label for="publicKeyInput" class="block text-slate-200 text-sm mb-2">ì¸ì¦í‚¤</label>
      <input id="publicKeyInput" type="password" autocomplete="off"
        class="w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500"
        placeholder="ë°œê¸‰ë°›ì€ ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <div id="publicKeyHint" class="mt-2 text-xs text-slate-400">í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì§€ ì•Šê³ , ì„œë²„ê°€ ì¿ í‚¤ë¡œ ì„¸ì…˜ë§Œ ë°œê¸‰í•©ë‹ˆë‹¤.</div>
      <div id="publicKeyErr" class="mt-2 hidden text-sm text-rose-300"></div>
    </div>

    <div class="mt-6 flex gap-3">
      <button id="publicKeySubmit"
        class="flex-1 rounded-xl bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 transition shadow-lg">í™•ì¸</button>
      <button id="publicKeyReset"
        class="rounded-xl bg-white/5 hover:bg-white/10 text-slate-200 py-3 px-4 transition">ì´ˆê¸°í™”</button>
    </div>

    <div class="mt-4 text-xs text-slate-500">
      * ë™ì¼ í‚¤ì˜ ì¬ë“±ë¡ì„ ì°¨ë‹¨í•˜ì—¬ ë„ìš©ì„ ì¤„ì…ë‹ˆë‹¤(ìµœì„ ì˜ ë°©ì–´, 100% ë³´ì¥ì€ ì•„ë‹˜).
    </div>
  </div>
</div>

    <!-- ë¦¬í¬íŠ¸ ì „ì†¡ìš© íˆë“  í¼ -->
    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="mode" id="form_mode">
        <input type="hidden" name="lat" id="form_lat">
        <input type="hidden" name="lng" id="form_lng">
        <input type="hidden" name="pnu" id="form_pnu">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="solar_opt" id="form_solar">
        <input type="hidden" name="land_estimate" id="form_land">
        <input type="hidden" name="land_price" id="form_price">
    </form>

    
    <!-- ì„¤ì • ëª¨ë‹¬: ê¸°ì¡´ ì‚¬ì´ë“œë°”ë¥¼ ì¤‘ì•™ íŒì—…ìœ¼ë¡œ ê°ì‹¸ê¸° (ë‚´ë¶€ ì½”ë“œëŠ” ê±°ì˜ ê·¸ëŒ€ë¡œ, D-Padë§Œ ì™¸ë¶€ë¡œ ì´ë™) -->
    <div id="settingsOverlay" class="fixed inset-0 z-[1900] hidden items-center justify-center">
        <!-- ì–´ë‘ìš´ ë°°ê²½ (í´ë¦­ ì‹œ ë‹«í˜) -->
        <div class="absolute inset-0 bg-black/10 backdrop-blur-sm" onclick="window.closeSettingsModal()"></div>

        <!-- ì‹¤ì œ ì„¤ì • íŒ¨ë„ ì»¨í…Œì´ë„ˆ -->
        <div class="relative w-[96%] max-w-5xl max-h-[90vh] flex flex-col items-stretch overflow-y-auto pt-4 pb-4">
            <!-- ì‚¬ì´ë“œë°” -->
                <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200 glass-main-panel">
                    <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0 glass-header">
                        <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ Pathfinder</h1>






                    </div>
                    <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm glass-tabs">
                        <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
                        <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
                        <button type="button" onclick="window.switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
                        <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-slate-50 glass-scroll">
                        <!-- ì„¤ì • íŒ¨ë„ (ì•„ì½”ë””ì–¸) -->
                        <div class="p-4 pb-0">
                            <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4 crystal-accordion">
                                <summary class="p-3 text-xs font-bold text-white cursor-pointer flex items-center justify-between bg-slate-900/70 rounded-t-lg"><span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i></summary>
                                <div class="p-3 space-y-3 border-t border-white/40 text-[11px] text-slate-50 param-body">
                                    <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                                         <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" aria-label="ëª¨ë“ˆ ê°€ë¡œ(m)" title="ëª¨ë“ˆ ê°€ë¡œ(m)" value="1.13" step="0.01" placeholder="ëª¨ë“ˆ ê°€ë¡œ(m)" class="w-full border p-1 rounded text-center bg-white text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" aria-label="ëª¨ë“ˆ ì„¸ë¡œ(m)" title="ëª¨ë“ˆ ì„¸ë¡œ(m)" value="2.4" step="0.01" placeholder="ëª¨ë“ˆ ì„¸ë¡œ(m)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div></div>
                                         <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ì„¤ì¹˜ ìµœëŒ€ë†’ì´(m)</label><input type="number" id="installHeight" aria-label="ì„¤ì¹˜ ë†’ì´(m)" title="ì„¤ì¹˜ ë†’ì´(m)" value="0.5" step="0.1" placeholder="ì„¤ì¹˜ ë†’ì´(m)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" aria-label="ì„¤ì¹˜ ê°ë„(Â°)" title="ì„¤ì¹˜ ê°ë„(Â°)" value="20" placeholder="ì„¤ì¹˜ ê°ë„(Â°)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div></div>
                                         <!-- [F-8] ì´ê²©ê±°ë¦¬(Setback) ì¶”ê°€ -->
                                         <div class="grid grid-cols-2 gap-2">
                                
                                    <!-- âœ… ê¸°ìì¬ ì„ íƒ (DB ì—°ë™) -->
                                    <div class="bg-white/60 p-2 rounded border border-slate-200">
                                      <div class="grid grid-cols-2 gap-2">
                                        <div>
                                          <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ëª¨ë“ˆ ì„ íƒ</label>
                                          <select id="moduleSelect" class="w-full border p-1 rounded text-[11px] text-slate-900"></select>
                                          <div class="text-[10px] text-slate-500 mt-1" id="moduleMeta"></div>
                                        </div>
                                        <div>
                                          <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ì¸ë²„í„° ì„ íƒ</label>
                                          <select id="inverterSelect" class="w-full border p-1 rounded text-[11px] text-slate-900"></select>
                                          <div class="text-[10px] text-slate-500 mt-1" id="inverterMeta"></div>
                                        </div>
                                      </div>
                                      <!-- ê¸°ì¡´ ê³„ì‚° ë¡œì§ í˜¸í™˜ìš©(ìˆ¨ê¹€) -->
                                      <input type="hidden" id="invCap" value="">
                                      <input type="hidden" id="invPrice" value="">
                                    </div>

                                        <div><label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" aria-label="ëª¨ë“ˆ ì¶œë ¥(W)" title="ëª¨ë“ˆ ì¶œë ¥(W)" value="640" placeholder="ëª¨ë“ˆ ì¶œë ¥(W)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" readonly onchange="window.reCalculate()"></div>
                                            <div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">ì´ê²©ê±°ë¦¬(Setback, m)</label><input type="number" id="setbackDist" aria-label="ì„¸íŠ¸ë°± ê±°ë¦¬(m)" title="ì„¸íŠ¸ë°± ê±°ë¦¬(m)" value="0.0" step="0.5" placeholder="ì„¸íŠ¸ë°± ê±°ë¦¬(m)" class="w-full border p-1 rounded text-center font-bold text-red-600 text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div>
                                         </div>
                                         <div class="grid grid-cols-2 gap-2 mt-2">
                                            <div><label class="block mb-0.5 text-[10px] text-slate-700 font-bold">íŒ¨ë„ ê°„ê²©(Row, m)</label><input type="number" id="rowSpacing" aria-label="ì—´ ê°„ê²©(m)" title="ì—´ ê°„ê²©(m)" value="1.2" step="0.1" placeholder="ì—´ ê°„ê²©(m)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div>
                                         </div>
                                    </div>
                                    <div class="bg-green-50 p-2 rounded border border-green-200">
                                         <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€</label><input type="number" id="modPrice" aria-label="ëª¨ë“ˆ ë‹¨ê°€(ì›/W)" title="ëª¨ë“ˆ ë‹¨ê°€(ì›/W)" value="350" placeholder="ëª¨ë“ˆ ë‹¨ê°€(ì›/W)" class="w-full border p-1 rounded text-center font-bold text-emerald-700 text-slate-900 placeholder-slate-400" readonly onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œ/kW)</label><input type="number" id="costPerKw" aria-label="ì„¤ì¹˜ë¹„(ë§Œì›/kW)" title="ì„¤ì¹˜ë¹„(ë§Œì›/kW)" value="90" placeholder="ì„¤ì¹˜ë¹„(ë§Œì›/kW)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div></div>
                                         <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" aria-label="SMP(ì›/kWh)" title="SMP(ì›/kWh)" value="140" placeholder="SMP(ì›/kWh)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" aria-label="REC(ì›/kWh)" title="REC(ì›/kWh)" value="70" placeholder="REC(ì›/kWh)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div></div>
                                         <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2"><div><label class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" aria-label="PF ëŒ€ì¶œë¹„ìœ¨(%)" title="PF ëŒ€ì¶œë¹„ìœ¨(%)" value="90" placeholder="PF ëŒ€ì¶œë¹„ìœ¨(%)" class="w-full border p-1 rounded text-center text-blue-600 font-bold text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" aria-label="PF ê¸ˆë¦¬(%)" title="PF ê¸ˆë¦¬(%)" value="5.5" step="0.1" placeholder="PF ê¸ˆë¦¬(%)" class="w-full border p-1 rounded text-center text-red-600 font-bold text-slate-900 placeholder-slate-400" onchange="window.reCalculate()"></div></div>
                                        <div class="grid grid-cols-2 gap-2 pt-2">
                                          <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">PF ê¸°ê°„(ë…„)</label>
                                            <input type="number" id="pfTenorYears" value="15" min="1" step="1" placeholder="PF ê¸°ê°„(ë…„)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                          </div>
                                          <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">DSCR ëª©í‘œ</label>
                                            <input type="number" id="pfDscrTarget" value="1.20" step="0.05" placeholder="DSCR ëª©í‘œ" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                          </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 pt-2">
                                          <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">CAPEX LTV(%)</label>
                                            <input type="number" id="pfLtvPct" value="70" min="0" max="100" step="1" placeholder="CAPEX LTV(%)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                            <div class="mt-1 text-[10px] text-slate-500">ì˜ˆìƒ ì´ ëŒ€ì¶œê¸ˆì•¡: <span id="pfLoanAmountHint" class="font-bold text-slate-700">0</span> <span class="text-slate-500">ì²œì›</span></div>
                                          </div>
                                          <div class="flex items-end gap-2">
                                            <label class="inline-flex items-center gap-2 text-[10px] text-slate-200 font-bold mb-1">
                                              <input type="checkbox" id="pfAutoPrincipal" checked class="accent-cyan-500">
                                              ì›ê¸ˆ ìë™
                                            </label>
                                          </div>
                                        </div>
                                        <div class="pt-2">
                                          <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">PF ì›ê¸ˆ(ì›) (ìˆ˜ë™ ì…ë ¥ ì‹œ ìë™ OFF)</label>
                                          <input type="text" inputmode="numeric" pattern="[0-9,]*" id="pfPrincipal" value="0" step="1000000" placeholder="PF ì›ê¸ˆ(ì›)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                        </div>


                                        <div class="grid grid-cols-2 gap-2 pt-2">
                                          <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">í† ì§€/ì„ëŒ€ ë°©ì‹</label>
                                            <select id="landTenureMode" class="w-full border p-1 rounded text-center text-slate-900" onchange="window.reCalculate(); window.updateTenureUi && window.updateTenureUi();">
                                              <option value="BUY" selected>í† ì§€êµ¬ë§¤</option>
                                              <option value="OWN">í† ì§€ë³´ìœ </option>
                                              <option value="LAND_LEASE">í† ì§€ì„ëŒ€</option>
                                              <option value="ROOF_LEASE">ì§€ë¶•ì„ëŒ€</option>
                                            </select>
                                          </div>
                                          <div id="landBuyWrap" class="hidden">
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">í† ì§€ êµ¬ë§¤ê°€(ì´ì•¡, ì›)</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9,]*" id="pfLandBuyPrice" value="0" placeholder="í† ì§€ êµ¬ë§¤ê°€(ì›)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                            <div class="text-[10px] text-slate-500 mt-1">â€» 0ì´ë©´ ìë™ ì¶”ì •ê°’(í† ì§€ê°€ê²©)ì„ ì‚¬ìš©</div>
                                          </div>
                                          <div id="landRentWrap" class="hidden">
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ì›” ì„ëŒ€ë£Œ(ì›)</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9,]*" id="landRentMonthly" value="0" placeholder="ì›” ì„ëŒ€ë£Œ(ì›)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                          </div>
                                        </div>


                                        <div class="grid grid-cols-2 gap-2 pt-2">
                                          <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ê´€ë¦¬ë¹„ìš© 1(ìœ ì§€ë³´ìˆ˜/ë…„, ì›)</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9,]*" id="pfMaintOpexAnnual" value="0" min="0" step="10000" placeholder="ìœ ì§€ë³´ìˆ˜(ì—°, ì›)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                          </div>
                                          <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">ê´€ë¦¬ë¹„ìš© 2(ê¸°íƒ€ë¹„ìš©/ë…„, ì›)</label>
                                            <input type="text" inputmode="numeric" pattern="[0-9,]*" id="pfOtherOpexAnnual" value="0" min="0" step="10000" placeholder="ê¸°íƒ€ë¹„ìš©(ì—°, ì›)" class="w-full border p-1 rounded text-center text-slate-900 placeholder-slate-400" onchange="window.reCalculate()">
                                          </div>
                                        </div>
                                        <div class="pt-1 text-[10px] text-slate-500">â€» 0ì´ë©´ ë¯¸ë°˜ì˜ (ì› ë‹¨ìœ„ ì…ë ¥ / ì½¤ë§ˆ ìë™ í‘œì‹œ)</div>

                                    </div>
                                </div>
                            </details>
                            <!-- [F-5] ì§€ë¶•/í† ì§€ ëª¨ë“œ ì „í™˜ -->
                            <div class="flex gap-2 text-xs mb-4 hidden" data-role="scan-target-sidebar" style="display:none;">
                                <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="window.toggleTarget()" aria-label="í† ì§€"><div class="text-center py-2 border rounded bg-white peer-checked:bg-amber-800 peer-checked:text-white hover:bg-gray-50 transition shadow-sm"><i class="ph ph-tree"></i> í† ì§€ (Land)</div></label>
                                <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="window.toggleTarget()" checked aria-label="ì§€ë¶•"><div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm"><i class="ph ph-factory"></i> ì§€ë¶• (Roof)</div></label>
                            </div>
                        </div>

                        <div class="px-4 pb-4">
                            <!-- 1. ìŠ¤ìº” íŒ¨ë„ -->
                            <div id="panel-scan" class="space-y-4">
                                <div class="bg-gray p-3 rounded border border-gray-200 shadow-sm">
                                    <label for="regionSelect" class="text-xs font-bold text-gray-700 mb-2 block">ğŸ“ ì§€ì—­ ì„ íƒ (ì „ìˆ˜ì¡°ì‚¬)</label>
                                    <select id="regionSelect" onchange="window.setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none">
                                        <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                                        <optgroup label="ğŸ­ ìˆ˜ë„ê¶Œ/ê²½ê¸° ì£¼ìš” ì‚°ë‹¨">
                                            <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                                            <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                                            <option value="hwaseong_ind">í™”ì„± ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                            <option value="pyeongtaek_ind">í‰íƒ í¬ìŠ¹ê³µë‹¨</option>
                                        </optgroup>
                                        <optgroup label="ğŸ­ ì¶©ì²­ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                            <option value="cheonan_ind">ì²œì•ˆ ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                            <option value="osan_ind">ì˜¤ì°½ ê³¼í•™ì‚°ì—…ë‹¨ì§€</option>
                                            <option value="daejeon_ind">ëŒ€ì „ ëŒ€ë•í…Œí¬ë…¸ë°¸ë¦¬</option>
                                        </optgroup>
                                        <optgroup label="ğŸ­ ì˜ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                            <option value="gumi_ind">êµ¬ë¯¸ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                            <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                            <option value="ulsan_ind">ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚° ì‚°ë‹¨</option>
                                            <option value="daegu_ind">ëŒ€êµ¬ ì„±ì„œê³µë‹¨</option>
                                            <option value="pohang_ind">í¬í•­ ì² ê°•ì‚°ì—…ë‹¨ì§€</option>
                                        </optgroup>
                                        <optgroup label="ğŸŒ² ëŒ€í•œë¯¼êµ­ ê´‘ì—­ ì§€ìì²´">
                                            <option value="seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                            <option value="gyeonggi">ê²½ê¸°ë„</option>
                                            <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                                            <option value="jeonbuk">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                                            <option value="gyeongnam">ê²½ìƒë‚¨ë„</option>
                                            <option value="jeju">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <!-- [F-12] ìŠ¤ìº” íƒ€ì´ë¨¸ ë° ìƒíƒœì°½ -->
                                <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500 scan-panel-crystal">
                                    <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                                        <label for="scanDelay" class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</label>
                                        <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="window.updateEstimatedTime()">
                                            <option value="6000" selected>6ì´ˆ (ê¶Œì¥)</option>
                                            <option value="3000">3ì´ˆ (ë¹ ë¦„/ì°¨ë‹¨ìœ„í—˜)</option>
                                        </select>
                                    </div>
                                    <div class="flex justify-between items-end"><div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400 scan-timer">00:00:00</div><div class="text-right"><div id="progressCount" class="text-[10px] text-gray-300 font-mono">0 / 20</div><div id="timerTotal" class="text-[9px] text-cyan-300 font-mono">ì´ 00:00:00</div></div></div>
                                    <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden scan-progress-outer"><div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500 scan-progress-inner" style="width: 0%"></div></div>
                                    <div class="flex justify-between items-end mt-1 px-1"><div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div></div>
                                    <div class="flex items-center gap-2 mb-2 mt-2">
                                         <input type="checkbox" id="autoFollow" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" checked>
                                         <label for="autoFollow" class="text-[10px] text-slate-300 cursor-pointer select-none">ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</label>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 pt-1">
                                        <button type="button" onclick="window.startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                                        <button type="button" onclick="window.cancelMission(true)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â–  ì·¨ì†Œ(ìœ ì§€)</button>
                                        <button type="button" onclick="window.downloadScanResults('geojson')" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â¬‡ ê²°ê³¼ë‹¤ìš´</button>
                                        <button type="button" onclick="window.cancelMission(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ë¦¬ì…‹</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. ì •ë°€ ë¶„ì„ íŒ¨ë„ -->
                            <div id="panel-analysis" class="hidden space-y-4">
                                <!-- [F-10] D-Pad (moved to floating control) -->
            <!-- [F-17] ìƒì„¸ PF ê²°ê³¼ í‘œì‹œ -->
                                <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                                    <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right truncate w-40">-</span></div>
                                        <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                                        <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰(AC/DC):</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                                        <!-- [F-25] í•œì „ìš©ëŸ‰ í™•ì¸í•„ìš” í‘œì‹œ -->
                                        <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">í™•ì¸ í•„ìš”</span></div>
                                        <div class="flex justify-between items-center"><span class="text-slate-400">â˜€ï¸ ì¼ì‚¬ëŸ‰/ê°ë„:</span><span id="solarOpt" class="font-bold text-yellow-300 font-mono">í™•ì¸ í•„ìš”</span></div>
                                        <div class="flex justify-between items-center"><span class="text-slate-400">ğŸï¸ í† ì§€ê°€ê²©:</span><span id="landPrice" class="font-bold text-amber-300 font-mono">í™•ì¸ í•„ìš”</span></div>
                                        <div class="flex justify-between items-center"><span class="text-slate-400">ğŸ“ ì˜ˆìƒ LTV(ê°€ì´ë“œ):</span><span id="ltvRemark" class="font-bold text-emerald-300 font-mono">-</span></div>
                                    </div>
<!-- PF ìƒì„¸ -->
                                    <div class="bg-indigo-900/40 p-2 rounded border border-indigo-500/30 text-[11px] space-y-1">
                                        <div class="mt-2">
  <div class="text-[11px] text-slate-400 mb-1">â€» ê¸ˆì•¡ ë‹¨ìœ„: <span class="text-slate-200 font-semibold">ì²œì›</span> (KRW)</div>
  <div class="overflow-x-auto">
    
    <table class="w-full text-[11px] border border-slate-700/60 table-fixed">
      <colgroup>
        <col style="width:12%">
        <col style="width:13%">
        <col style="width:14%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:9%">
        <col style="width:11%">
        <col style="width:7%">
        <col style="width:7%">
      </colgroup>
      <thead>
        <tr>
          <th colspan="2" class="px-2 py-1 text-left font-bold border border-slate-700/60 bg-emerald-500/25">ì‚¬ì—…ë¹„</th>
          <th colspan="5" class="px-2 py-1 text-left font-bold border border-slate-700/60 bg-amber-300/25">ì†ìµ</th>
          <th colspan="3" class="px-2 py-1 text-left font-bold border border-slate-700/60 bg-emerald-500/25">í˜„ê¸ˆíë¦„</th>
        </tr>
        <tr class="text-slate-200">
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30">í•­ëª©</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">ê¸ˆì•¡</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30">í•­ëª©</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">25ë…„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">15ë…„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">ì—°ê°„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">ì›”ê°„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30">í•­ëª©</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">15ë…„</th>
          <th class="px-2 py-1 border border-slate-700/60 bg-slate-900/30 text-right">25ë…„</th>
        </tr>
      </thead>
      <tbody class="text-slate-100">
        <tr>
          <td class="px-2 py-1 border border-slate-700/60">í† ì§€ê°€ê²©</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_land_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ë§¤ì¶œì•¡(ì´ì•¡)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_rev_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_rev_t_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_rev_a_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_rev_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì˜ì—…í™œë™</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_op_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_op_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ì„¤ë¹„ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_epc_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê´€ë¦¬ë¹„ìš©1(ìœ ì§€ë³´ìˆ˜)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_maint_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_maint_t_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_maint_a_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_maint_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì˜ì—…ì´ìµ</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_ebit_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_ebit_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ê¸°íƒ€ ê³µì‚¬ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_capex_other_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê´€ë¦¬ë¹„ìš©2(ê¸°íƒ€ìš´ì˜)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_otheropex_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_otheropex_t_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_otheropex_a_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_otheropex_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê°ê°€ìƒê°ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_depr_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_depr_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60 font-semibold">ì´ì‚¬ì—…ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_capex_total_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ê°ê°€ìƒê°ë¹„(ì¶”ì •)</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_depr_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_depr_t_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_depr_a_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_depr_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì´ìë¹„ìš©</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_int_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_int_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ëŒ€ì¶œê°€ëŠ¥ê¸ˆì•¡</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_loan_possible_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60 font-semibold">ì˜ì—…ì´ìµ</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_ebit_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_ebit_t_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_ebit_a_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_ebit_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">íˆ¬ìí™œë™</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_inv_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_inv_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60">ëŒ€ì¶œê¸ˆì•¡</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_loan_amount_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì´ìë¹„ìš©</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_int_25_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_int_t_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_int_a_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="pf_int_m_k">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì´ì‚¬ì—…ë¹„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_capex_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_capex_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60 font-semibold"><span class="text-yellow-300 font-bold">ì„¸ì „ì´ìµ</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_pbt_25_k" class="text-yellow-300 font-bold">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_pbt_t_k" class="text-yellow-300 font-bold">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_pbt_a_k" class="text-yellow-300 font-bold">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right font-semibold"><span id="pf_pbt_m_k" class="text-yellow-300 font-bold">0</span></td>

          <td class="px-2 py-1 border border-slate-700/60">ì¬ë¬´í™œë™</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_fin_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_fin_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60">ëŒ€ì¶œì‹¤í–‰</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_loan_draw_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_loan_draw_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60">ëŒ€ì¶œìƒí™˜</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_loan_repay_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_loan_repay_25_k">0</span></td>
        </tr>

        <tr>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>
          <td class="px-2 py-1 border border-slate-700/60"></td>

          <td class="px-2 py-1 border border-slate-700/60">ìˆœí˜„ê¸ˆíë¦„</td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_net_pf_k">0</span></td>
          <td class="px-2 py-1 border border-slate-700/60 text-right"><span id="cf_tbl_net_25_k">0</span></td>
        </tr>
      </tbody>
    </table>

  </div>

  
  <!-- âœ… Cashflow activity summary (PFê¸°ê°„ / 25ë…„) -->
  <div class="mt-2 flex justify-end">
    <div class="min-w-[360px] max-w-[520px] w-full sm:w-auto">
      <div class="grid grid-cols-3 text-[11px] rounded-md overflow-hidden border border-slate-700/60">
        <div class="col-span-1 bg-slate-900/40 px-2 py-1 text-slate-200 font-semibold">í˜„ê¸ˆíë¦„</div>
        <div class="bg-slate-900/40 px-2 py-1 text-right text-slate-200 font-semibold">PFê¸°ê°„</div>
        <div class="bg-slate-900/40 px-2 py-1 text-right text-slate-200 font-semibold">25ë…„</div>

        <div class="col-span-1 bg-yellow-300/95 px-2 py-1 text-slate-900 font-bold">ì˜ì—…í™œë™</div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-slate-900 font-bold"><span id="cf_op_pf_k">0</span></div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-slate-900 font-bold"><span id="cf_op_25_k">0</span></div>

        <div class="col-span-1 bg-yellow-300/95 px-2 py-1 text-slate-900 font-bold">íˆ¬ìí™œë™</div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-rose-700 font-bold"><span id="cf_inv_pf_k">0</span></div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-rose-700 font-bold"><span id="cf_inv_25_k">0</span></div>

        <div class="col-span-1 bg-yellow-300/95 px-2 py-1 text-slate-900 font-bold">ì¬ë¬´í™œë™</div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-slate-900 font-bold"><span id="cf_fin_pf_k">0</span></div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-slate-900 font-bold"><span id="cf_fin_25_k">0</span></div>

        <div class="col-span-1 bg-yellow-300/95 px-2 py-1 text-slate-900 font-bold">ìˆœí˜„ê¸ˆíë¦„</div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-slate-900 font-bold"><span id="cf_net_pf_k">0</span></div>
        <div class="bg-yellow-300/95 px-2 py-1 text-right text-slate-900 font-bold"><span id="cf_net_25_k">0</span></div>
      </div>
    </div>
  </div>

<!-- legacy containers (kept for compatibility) -->
  <div id="resPfCapexSummary" class="hidden">0</div>
  <div id="resPfProfitSummary" class="hidden">0</div>
  <div id="resPfCashflowSummary" class="hidden">0</div>
</div>
</div>


                                        <div class="flex justify-between items-center mt-1">
                                          <span class="flex items-center gap-2 text-slate-200"><i class="ph ph-chart-line-up"></i> PFê¸°ê°„ ìˆœí˜„ê¸ˆ(ëˆ„ì ):</span>
                                          <span id="resCfPfTerm" class="text-emerald-200 font-semibold">-</span>
                                        </div>
                                        <div class="flex justify-between items-center mt-1">
                                          <span class="flex items-center gap-2 text-slate-200"><i class="ph ph-trend-up"></i> 25ë…„ ìˆœí˜„ê¸ˆ(ëˆ„ì ):</span>
                                          <span id="resCf25Y" class="text-emerald-200 font-semibold">-</span>
                                        </div>
                          <div class="flex justify-between items-center mt-2">
                            <span class="flex items-center gap-2 text-slate-200"><i class="ph ph-shield-check"></i> DSCR(1ë…„ì°¨):</span>
                            <span id="resDscr" class="text-white font-semibold">-</span>
                          </div>
                          <div class="flex justify-between items-center mt-1">
                            <span class="flex items-center gap-2 text-slate-200"><i class="ph ph-compass"></i> ê¶Œì¥ ëŒ€ì¶œê¸ˆ:</span>
                            <span id="resRecLoan" class="text-cyan-200 font-semibold">-</span>
                          </div>

                                        <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold">0.0 ë…„</span></div>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                         <button type="button" onclick="window.saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition">ì €ì¥</button>
                                         <!-- [F-20] ìƒì„¸ ë¦¬í¬íŠ¸ ì´ë™ -->
                                         <button type="button" onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition">ìƒì„¸ ë¦¬í¬íŠ¸</button>
                                    </div>
                                </div>
                            </div>

                            <!-- [F-15, F-16] AI ë¶„ì„ íŒ¨ë„ -->
                            <div id="panel-legal" class="hidden space-y-4">
                                <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                                    <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> 8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­ & ì ìˆ˜</h3>
                        
                                    <div id="aiScorePanel" class="hidden mb-4 bg-transparent0 p-3 rounded border border-slate-600 mt-2">
                                         <div class="flex items-center justify-between mb-2">
                                             <span class="text-xs text-slate-300 font-bold">êµ¬ë§¤ë§¤ë ¥ë„ (AI Score)</span>
                                             <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                                         </div>
                                         <div class="w-full bg-slate-700 rounded-full h-2.5 mb-2 overflow-hidden">
                                             <div id="scoreBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                         </div>
                                         <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                                    </div>
                                    <div class="flex items-center justify-end mb-1">
                                      <button type="button"
                                              onclick="window.retryAIAnalysis()"
                                              class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 text-[10px] text-cyan-200 border border-cyan-500/60 hover:bg-slate-800">
                                        <i class="ph ph-arrows-clockwise text-xs"></i>
                                        <span>AI ì¬ë¶„ì„</span>
                                      </button>
                                    </div>
                                    <div id="aiSummaryPanel" class="hidden mb-4 bg-slate-900/40 p-3 rounded border border-slate-600">
                                      <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs text-slate-300 font-bold">AI ì¢…í•© ì´í‰ (ë²•/ì¡°ë¡€ ê¸°ë°˜)</span>
                                        <span class="text-[10px] text-slate-400">â€» ì¶”ì •/í™•ì¸ í•„ìš” í¬í•¨</span>
                                      </div>
                                      <div id="aiSummaryText" class="text-[11px] leading-relaxed text-slate-200 whitespace-pre-wrap"></div>
                                    </div>


                                    <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                                        <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ 8ëŒ€ í•­ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                                    </div>

                                    <div id="legalLoading" class="hidden text-center py-10">
                                        <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                                        <p class="text-xs text-purple-300 animate-pulse">ìƒì„¸ ê·œì œ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                                    </div>

                                    <div id="legalContent" class="hidden space-y-4 mt-2">
                                         <!-- [F-15] 8ëŒ€ ì²´í¬í•­ëª© ë¦¬ìŠ¤íŠ¸ -->
                                         <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2">
                                    <!-- âœ… ì¢…í•© ë¦¬í¬íŠ¸(ë§ˆì§€ë§‰) : êµ¬ë§¤ë§¤ë ¥ë„ + ì‚¬ì—…ì„± ì½”ë©˜íŠ¸ + AI ì¬ê²€í†  -->
                                    <div id="aiFinalPanel" class="hidden mt-4 bg-slate-900/40 p-3 rounded border border-slate-600">
                                      <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-slate-300 font-bold flex items-center gap-1">
                                          <i class="ph ph-sparkle text-[12px] text-purple-300"></i> ì¢…í•© ë¦¬í¬íŠ¸ (AI ì½”ë©˜íŠ¸)
                                        </span>
                                        <button type="button"
                                                onclick="window.retryAIAnalysis()"
                                                class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 text-[10px] text-cyan-200 border border-cyan-500/60 hover:bg-slate-800">
                                          <i class="ph ph-arrows-clockwise text-xs"></i>
                                          <span>AI ì¬ê²€í† </span>
                                        </button>
                                      </div>

                                      <div id="aiRecheckBarWrap" class="hidden w-full bg-slate-700/70 rounded-full h-2 overflow-hidden mb-3">
                                        <div id="aiRecheckBar" class="h-2 bg-gradient-to-r from-purple-400 via-cyan-400 to-emerald-400 w-0 transition-all duration-300"></div>
                                      </div>

                                      <div class="flex items-start gap-3">
                                        <div class="min-w-[120px]">
                                          <div class="text-[10px] text-slate-400">êµ¬ë§¤ë§¤ë ¥ë„</div>
                                          <div id="finalScoreValue" class="text-2xl font-extrabold text-green-400 leading-none">-</div>
                                          <div id="finalConfidence" class="text-[10px] text-slate-400 mt-1"></div>
                                        </div>

                                        <div class="flex-1">
                                          <div id="aiBusinessComment" class="text-[11px] leading-relaxed text-slate-200 whitespace-pre-wrap"></div>
                                          <div class="mt-2 border-t border-slate-600 pt-2">
                                            <div class="text-[10px] text-slate-400 mb-1">AI/ë²•Â·ì¡°ë¡€ ìš”ì•½</div>
                                            <div id="aiFinalSummary" class="text-[11px] leading-relaxed text-slate-200 whitespace-pre-wrap"></div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
</div>
                                    </div>
                                </div>
                            </div>

                            <div id="panel-history" class="hidden space-y-4">
                                <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                                    <div class="flex justify-between items-center mb-2 border-b pb-1">
                                        <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV ë‹¤ìš´</button>
                                            <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">ì‚­ì œ</button>
                                        </div>
                                    </div>
                                    <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                                </div>
                            </div>
                
                            <div id="loading" class="hidden flex flex-col items-center justify-center py-4"><div class="spinner mb-2"></div><p class="text-xs text-slate-500">ì²˜ë¦¬ ì¤‘...</p></div>
                        </div>
                    </div>
        

                </div>
    
    
        </div>
    </div>


    <!-- ìƒë‹¨ í—¤ë” & ì§€ë„ ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ -->
    <header class="absolute top-0 left-0 right-0 z-[1500] flex items-center justify-between px-4 py-3 pointer-events-none">
        <!-- ì¢Œì¸¡: í° íƒ€ì´í‹€ + ìƒì„¸ ì„¤ì • ë²„íŠ¼ -->
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="flex items-center gap-2 bg-transparent px-3 py-2 rounded-xl shadow-lg border border-slate-200/40 title-gradient">
                <img src="data:image/png;base64,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" alt="SC Energy Solution" class="h-7 w-auto rounded-sm shadow-sm" />
                <div class="leading-tight">
                    <div class="text-sm md:text-base font-bold text-slate-50 tracking-tight">
                        SCEnergy íƒœì–‘ê´‘ Pathfinder
                    </div>
                    <div class="text-[10px] md:text-[11px] text-slate-300">
                        ì£¼ì†Œë¥¼ ì„ íƒí•˜ê³  íŒ¨ë„ì„ ë°°ì¹˜í•´ ë³´ì„¸ìš”.
                    </div>
                    <div class="text-[9px] text-slate-400 mt-0.5">
                        Â© 2026 SC Energy Solution. All rights reserved.
                    </div>
                </div>
            </div>
            <button type="button"
                    onclick="window.openSettingsModal()"
                    class="inline-flex items-center gap-2 rounded-full settings-button-glass text-slate-50 text-xs md:text-sm px-3 py-2 shadow-lg">
                <i class="ph ph-gear-six text-base md:text-lg text-cyan-300"></i>
                <span class="font-semibold">ìƒì„¸ ì„¤ì •</span>
            </button>
        </div>

        <!-- ì¤‘ì•™: ì§€ë¶•/í† ì§€ ëª¨ë“œ ì „í™˜ í† ê¸€ -->
        <div class="pointer-events-auto flex justify-center header-mode-toggle-wrap">
            <div class="inline-flex items-center gap-1 glass-toolbar rounded-full px-1 py-1 shadow-lg">
                <button type="button" id="btnModeLand"
                        onclick="window.setScanTargetMode('land')"
                        class="px-3 py-1 text-[11px] md:text-xs rounded-full font-semibold flex items-center gap-1 bg-amber-500/10 text-amber-300 border border-transparent hover:bg-amber-400/20">
                    <i class="ph ph-tree"></i>
                    <span>í† ì§€</span>
                </button>
                <button type="button" id="btnModeRoof"
                        onclick="window.setScanTargetMode('building')"
                        class="px-3 py-1 text-[11px] md:text-xs rounded-full font-semibold flex items-center gap-1 text-slate-200 bg-slate-800/60 hover:bg-slate-700/80 border border-slate-600/60">
                    <i class="ph ph-building"></i>
                    <span>ì§€ë¶•</span>
                </button>
            </div>
        </div>

        <!-- ìš°ì¸¡: ì£¼ì†Œ ê²€ìƒ‰ + ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ -->
        <div class="pointer-events-auto flex items-center gap-3">
            <!-- ì£¼ì†Œ ê²€ìƒ‰ì°½ (ê¸°ì¡´ addrInput ìœ ì§€) -->
            <div class="address-glass rounded-xl shadow-lg border flex items-center px-2 py-1 w-[220px] md:w-[260px]">
                <input type="text" id="addrInput"
                       placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)"
                       class="flex-1 text-xs md:text-sm px-2 py-1 outline-none bg-transparent text-slate-700 font-medium"
                       onkeypress="if(event.key==='Enter') window.searchAddress()">
                <button type="button"
                        onclick="window.searchAddress()"
                        class="px-2 py-1 rounded-lg bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800"
                        aria-label="ì£¼ì†Œ ê²€ìƒ‰" title="ì£¼ì†Œ ê²€ìƒ‰">
                    <i class="ph ph-magnifying-glass font-bold"></i>
                </button>
            </div>

            <!-- ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ (í´ë¦­ìœ¼ë¡œ ì—¬ë‹«ê¸°) -->
            <div class="relative">
                <button type="button"
                        onclick="window.toggleLayerMenu(event)"
                        class="h-10 w-10 rounded-full layer-button-glass text-slate-100 flex items-center justify-center shadow-lg">
                    <i class="ph ph-stack text-xl"></i>
                </button>

                <!-- ìš°ì¸¡ ì„¤ì • ì¹´ë“œ (ë ˆì´ì–´/ì§€ë„ ì„¤ì •) -->
                <div id="layerMenuPanel" class="hidden absolute right-0 mt-2 z-[1600]">
                    <div class="layer-menu-glass p-2 rounded-lg text-xs w-56">
                        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1">
                            <i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •
                        </div>

                        <!-- ê²°ê³¼ ëˆ„ì  ëª¨ë“œ -->
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 rounded text-indigo-700 font-bold border border-indigo-200">
                            <input type="checkbox" id="multiSelectToggle" onchange="window.toggleMultiSelect()">
                            <span class="flex items-center gap-1">
                                <i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ
                            </span>
                        </label>

                        <!-- ìë™ ìŠ¤ìº” (ì´ë™ì‹œ) -->
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="autoScanToggle" onchange="window.toggleAutoScan()">
                            <span class="flex items-center gap-1">
                                <i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”(ì´ë™ì‹œ)
                            </span>
                        </label>

                        <hr class="my-2 border-gray-200">

                        <!-- ë ˆì´ì–´ í† ê¸€ -->
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="existingPlantToggle" onchange="window.toggleLayer('existing')" checked>
                            <span>ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘(ê°€ìƒ)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="substationToggle" onchange="window.toggleLayer('substation')" checked>
                            <span>ë³€ì „ì†Œ/ì„ ë¡œ(ì¤Œ 15~16)</span>
                        </label>
                        <div class="text-[10px] text-slate-500 pl-6 -mt-1 mb-1">
                            â€» ë³€ì „ì†Œ/ì„ ë¡œëŠ” ì¤Œ ë ˆë²¨ 15~16ì—ì„œ í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="cadastralToggle" onchange="window.toggleLayer('cadastral')" checked>
                            <span>ì§€ì ë„ (VWorld)</span>
                        </label>

                        <!-- ê¸°ë³¸/ìœ„ì„± ì§€ë„ ì„ íƒ -->
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                                <input type="radio" name="mapL" value="sat" checked onchange="window.setMap('sat')">
                                <span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                                <input type="radio" name="mapL" value="base" onchange="window.setMap('base')">
                                <span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded">
                                <input type="radio" name="mapL" value="kakao" onchange="window.setMap('kakao')">
                                <span>ğŸŸ¡ ì¹´ì¹´ì˜¤ ì§€ë„</span>
                            </label>
                            <div class="pt-1">
                                <button type="button"
                                        class="w-full text-[11px] px-2 py-1 rounded-lg border border-slate-600/60 bg-slate-900/50 hover:bg-slate-800 flex items-center justify-center gap-1"
                                        onclick="window.openKakaoRoadview()">
                                    <span>ì¹´ì¹´ì˜¤ ë¡œë“œë·° (ìƒˆì°½)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    
<!-- í•˜ë‹¨ ìƒíƒœ + ì‹œìŠ¤í…œ ë¡œê·¸ íŒ¨ë„ (ì§€ë„ ì•„ë˜ ê³ ì •) -->
<div id="bottomStatusPanel" class="absolute left-0 right-0 bottom-0 z-[1450] pointer-events-none">
  <div id="bottomStatusInner" class="max-w-5xl mx-auto pb-2 pointer-events-auto">
    <div class="flex justify-center mb-1">
      <button type="button"
              onclick="window.toggleBottomStatus()"
              class="px-3 py-1 rounded-full bottom-status-toggle-glass text-[11px] text-slate-100 flex items-center gap-1">
        <i id="bottomStatusHandleIcon" class="ph ph-caret-up text-xs"></i>
        <span>ìƒíƒœ / ë¡œê·¸</span>
      </button>
    </div>
    <div class="bottom-status-glass text-slate-50 rounded-t-2xl px-4 pt-2 pb-2 space-y-2">
      <div class="flex justify-between items-center text-[10px] text-slate-300">
        <span class="font-semibold text-xs">Public Access</span>
        <div class="flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
          <span class="text-[10px] text-emerald-300">System Ready</span>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-1 mt-3 text-center text-[10px]">
        <div class="bg-slate-900 rounded p-1 border border-slate-700">
          <div class="text-slate-500">Backend</div>
          <div id="cnt-vworld" class="font-mono font-bold text-cyan-400 text-xs">0</div>
        </div>
        <div class="bg-slate-900 rounded p-1 border border-slate-700">
          <div class="text-slate-500">DB Sync (public)</div>
          <div id="cnt-public" class="font-mono font-bold text-yellow-400 text-xs">0</div>
        </div>
        <div class="bg-slate-900 rounded p-1 border border-slate-700">
          <div class="text-slate-500">AI Analysis</div>
          <div id="cnt-ai" class="font-mono font-bold text-purple-400 text-xs">0</div>
        </div>
      </div>
      <!-- System Log (ì›ë³¸ logWindow ì´ë™) -->
      <div class="h-24 bg-slate-900 border-t border-slate-700 mt-2 flex flex-col text-[11px]">
        <div class="px-3 py-1 flex items-center justify-between text-slate-300">
          <div class="flex items-center gap-2">
            <i class="ph ph-activity"></i>
            <span class="font-semibold text-[11px]">System Log</span>
          </div>
          <button type="button"
                  onclick="window.clearLog && window.clearLog()"
                  class="text-[10px] px-2 py-0.5 rounded bg-slate-800 border border-slate-600 hover:bg-slate-700">
            Clear
          </button>
        </div>
        <div class="flex-1 overflow-y-auto px-3 pb-2" id="logWindow">
          <div class="text-green-500">&gt; System Ready.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText"></span></div>
    <div id="map">
  <div id="kakaoMap" class="kakao-map-layer" style="display:none;"></div>
  <div id="zoomIndicator" class="zoom-indicator-glass">
    ğŸ” Zoom: -
  </div>
</div>
    <!-- í”Œë¡œíŒ… D-Pad: ì§€ë„ ìš°ì¸¡ ì¤‘ì•™ -->
    <div id="floatingDpadWrapper" class="absolute right-6 top-1/2 -translate-y-1/2 z-[1400] pointer-events-none">
        <div class="pointer-events-auto">
            <!-- [F-10] D-Pad -->
                                <div class="crystal-dpad p-2 mb-2 text-slate-50">
                                    <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ë¯¸ì„¸ì¡°ì • (D-Pad)</span><button type="button" onclick="window.resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                                    <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                                         <div class="grid grid-cols-3 gap-2">
                                            <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('up')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('up')" ontouchend="window.dpadHoldStop()">â–²</button><div></div>
                                            <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('left')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('left')" ontouchend="window.dpadHoldStop()">â—€</button>
                                            <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                                            <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('right')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('right')" ontouchend="window.dpadHoldStop()">â–¶</button>
                                            <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('down')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('down')" ontouchend="window.dpadHoldStop()">â–¼</button><div></div>
                                         </div>
                                         <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                                            <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotL')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotL')" ontouchend="window.dpadHoldStop()">â†º íšŒì „</button>
                                            <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotR')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotR')" ontouchend="window.dpadHoldStop()">â†» íšŒì „</button>
                                        </div>
                                    </div>
                                </div>

                    
        </div>
    </div>



    <script>
/* =========================================================
   íƒœì–‘ê´‘ Pathfinder Upgrade (Features 1~5) - JS ONLY
   - Keeps original HTML/CSS design intact.
   - Implements:
     F-4 address search + map move
     F-5 roof/land mode toggle
     F-6 click feature -> auto panel generation
     F-7 land panels also blue
     F-8/9 setback + instant recalculation
     F-10 D-pad press & hold micro adjust
     F-11~14 scan mission + auto scan + dashed box
     F-15~16 AI checklist + conservative score
   ========================================================= */

// -----------------------------
// Config
// -----------------------------
const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";

// Backend URL discovery (optional): ?backend=https://....
(function(){
  try{
    const qs = new URLSearchParams(window.location.search || "");
    const b = qs.get("backend");
    if (b) {
      let decoded = b;
      try { decoded = decodeURIComponent(b); } catch(e) {}
      window.BACKEND_URL = decoded.replace(/\/$/, "");
    }
  } catch(e) {}
  if (typeof window.BACKEND_URL !== "string") window.BACKEND_URL = "";
  window.BACKEND_URL = window.BACKEND_URL.replace(/\/$/, "");
})();
const BACKEND_URL = window.BACKEND_URL || "";

// Public auth & admin ê³µìš© backend base (ì¿¼ë¦¬ìŠ¤íŠ¸ë§ backendê°€ ì—†ìœ¼ë©´ í˜„ì¬ origin ì‚¬ìš©)
const backendBase = (window.BACKEND_URL && window.BACKEND_URL.length)
  ? window.BACKEND_URL
  : (window.location.origin || "");

// ê³µê°œ ì ‘ê·¼í‚¤ ê¸°ëŠ¥ í† ê¸€ (ê¸°ë³¸ê°’: ë¹„í™œì„±í™” â†’ API í˜¸ì¶œë„ ì•ˆ í•¨)
window.PUBLIC_AUTH_ENABLED = window.PUBLIC_AUTH_ENABLED === true; // ì™¸ë¶€ì—ì„œ trueë¡œ ì„¤ì •í•œ ê²½ìš°ì—ë§Œ í™œì„±


// Feature level (optional): ?feat=1..5 (default 5)
const FEATURE_LEVEL = parseInt(new URLSearchParams(location.search).get("feat") || "5", 10);
window.FEATURE_LEVEL = FEATURE_LEVEL;

// -----------------------------
// State
// -----------------------------
let map, layers, selectableGroup, panelGroup, analysisMarkerGroup, cadastralLayer;
let existingGroup, substationGroup;

let kakaoMapInstance = null;
let kakaoActive = false;

let scanTarget = "building"; // "building" (roof) | "land"
let autoScanMode = true;
let isMultiSelectMode = false;

let currentAnalysisFeature = null;
let landPriceEstInFlight = false;   // last selected feature
let currentAnalysisData = {};        // for report/history/AI
let selectedFeatures = new Map();    // featureId -> {feature, layer, count, panelsFC}

let calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 }; // applied to CURRENT feature panels only
let dpadHoldTimer = null;

// âœ… íŒ¨ë„ ìœ„ì¹˜ ë¯¸ì„¸ë³´ì •(ë“œë˜ê·¸) í•¸ë“¤
let panelDragHandle = null;
let _dragStartLatLng = null;

function ensurePanelDragHandle(feature){
  // ì‚¬ìš©ì ìš”ì²­: íŒ¨ë„ ë“œë˜ê·¸ í•¸ë“¤(íŒŒë€ ì›í˜• â†” ë§ˆì»¤) ë¹„í™œì„±í™”
  try{
    if(panelDragHandle){
      try{ window.map.removeLayer(panelDragHandle); }catch(e){}
      panelDragHandle = null;
    }
  }catch(e){}
  return;
}


let scanLock = false;

// Mission (F-11~12)
let missionRunning = false;
let missionPaused = false;
let missionStop = false;
let missionTotalSteps = 20;
let missionDoneSteps = 0;
let missionDelayMs = 6000;
let missionTotalMs = 0;
let missionRemainingMs = 0;
let missionLastTick = 0;
let missionTimerInterval = null;

// Auto scan box (F-14)
let autoScanBox = null;
let autoScanDebounce = null;

// -----------------------------
// Helpers: UI / Logging
// -----------------------------
function el(id){ return document.getElementById(id); }

// Auto scan toggle (moveend)
window.toggleAutoScan = function(){
  try{
    const cb = document.getElementById('autoScanToggle');
    autoScanMode = !!(cb && cb.checked);
    updateAutoScanBox();
    // If turning on, run one scan immediately at current center
    if(autoScanMode && window.map){
      const c = window.map.getCenter();
      scanBuildings(c.lat, c.lng, true);
    }
  }catch(e){
    console.warn('toggleAutoScan failed', e);
  }
};

// -----------------------------
// Geo helpers (F-27/28 input prep)
// -----------------------------
function getAnalysisLatLng(){
  if(typeof currentAnalysisData.lat === "number" && typeof currentAnalysisData.lng === "number"){
    return {lat: currentAnalysisData.lat, lng: currentAnalysisData.lng};
  }
  if(map){
    const c = map.getCenter();
    return {lat: c.lat, lng: c.lng};
  }
  return {lat: null, lng: null};
}

// GeoJSON Polygon area (m2) - equirectangular approximation (good enough for estimation/UI)
function polygonAreaM2(geo){
  try{
    if(!geo || geo.type !== "Polygon" || !Array.isArray(geo.coordinates)) return 0;
    const ring = geo.coordinates[0];
    if(!Array.isArray(ring) || ring.length < 3) return 0;
    // lat0 for scaling
    let lat0 = 0;
    for(const p of ring){ lat0 += p[1]; }
    lat0 /= ring.length;
    const cos = Math.cos(lat0 * Math.PI/180);
    const sx = 111320 * cos;
    const sy = 110540;
    let area = 0;
    for(let i=0;i<ring.length-1;i++){
      const x1 = ring[i][0] * sx;
      const y1 = ring[i][1] * sy;
      const x2 = ring[i+1][0] * sx;
      const y2 = ring[i+1][1] * sy;
      area += (x1*y2 - x2*y1);
    }
    return Math.abs(area) / 2;
  }catch(e){
    return 0;
  }
}

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function _enforceNonNegativeSettingsInputs(){
  try{
    var root = document.getElementById("settingsOverlay");
    if(!root) return;
    var inputs = root.querySelectorAll('input[type="number"]');
    inputs.forEach(function(inp){
      try{
        var minAttr = inp.getAttribute("min");
        var minVal = 0;
        if(minAttr !== null && minAttr !== "" && isFinite(parseFloat(minAttr))){
          minVal = parseFloat(minAttr);
          if(minVal < 0) minVal = 0;
        }else{
          inp.setAttribute("min","0");
          minVal = 0;
        }
        var clampFn = function(){
          var v = parseFloat(inp.value);
          if(isFinite(v) && v < minVal){
            inp.value = String(minVal);
          }
        };
        inp.addEventListener("input", clampFn);
        inp.addEventListener("change", clampFn);
      }catch(e){}
    });
  }catch(e){}
}


function deg2rad(d){ return d * Math.PI / 180; }
function cosd(d){ return Math.cos(deg2rad(d)); }

// Data-source-free heuristics (F-27 fallback)
// - Korea lat ~33~38.5: annual average "sun hours/day" typically ~3.2~4.0 range (site/season vary).
// - This is a conservative heuristic for early-stage estimates. Marked as needs_confirm in UI.
function estimateSunHoursHeuristic(lat){
  if(typeof lat !== "number" || !isFinite(lat)) return 3.6;
  // map lat 33 -> 3.9, 38.5 -> 3.4 (north slightly lower)
  const t = clamp((lat - 33) / (38.5 - 33), 0, 1);
  return 3.9 - 0.5 * t;
}

// Orientation/tilt loss factor (very simplified):
// - If no detailed weather/irradiance, approximate mismatch penalty by azimuth and tilt errors.
// - Keep conservative floor so we don't overestimate.
function orientationFactor(lat, azimuthDeg, tiltDeg){
  if(typeof azimuthDeg !== "number" || !isFinite(azimuthDeg)) azimuthDeg = 180;
  if(typeof tiltDeg !== "number" || !isFinite(tiltDeg)) tiltDeg = 20;

  const optAz = 180; // south
  const optTilt = clamp((typeof lat === "number" && isFinite(lat)) ? (lat - 10) : 20, 10, 35);

  let azErr = Math.abs(azimuthDeg - optAz);
  azErr = azErr > 180 ? 360 - azErr : azErr;

  const tiltErr = Math.abs(tiltDeg - optTilt);

  // azimuth penalty dominates; tilt penalty softer
  const fAz = clamp(cosd(azErr), 0.7, 1.0);
  const fTilt = clamp(cosd(tiltErr * 0.7), 0.8, 1.0);

  // Conservative floor
  return clamp(fAz * fTilt, 0.75, 1.0);
}

function formatMillionWon(v){
  // NOTE: UI í‘œê¸° ë‹¨ìœ„ëŠ” "ì²œì›" (KRW)ë¡œ ì‚¬ìš© (ìš”ì²­ ë°˜ì˜)
  const n = (typeof v === "number" && isFinite(v)) ? v : 0;
  const m = Math.round(n / 1000);
  return m.toLocaleString();
}

function fmtWon(v){
  if(typeof v !== "number" || !isFinite(v)) return "í™•ì¸ í•„ìš”";
  return Math.round(v).toLocaleString() + " ì›";
}
function formatWon(v){ return fmtWon(v); }

function updateSolarOptUI(data){
  const elOpt = el("solarOpt");
  if(!elOpt) return;
  if(!data){
    elOpt.innerText = "í™•ì¸ í•„ìš”";
    return;
  }
  const sun = (typeof data.sun_hours === "number") ? data.sun_hours.toFixed(2) : null;
  const az  = (typeof data.azimuth_deg === "number") ? Math.round(data.azimuth_deg) : null;
  const tilt= (typeof data.tilt_deg === "number") ? Math.round(data.tilt_deg) : null;

  if(sun || az || tilt){
    const parts = [];
    if(sun) parts.push(`ì¼ì‚¬ ${sun}h`);
    if(az !== null) parts.push(`ë°©ìœ„ ${az}Â°`);
    if(tilt !== null) parts.push(`ê²½ì‚¬ ${tilt}Â°`);
    elOpt.innerText = parts.join(" / ");
  }else{
    elOpt.innerText = "í™•ì¸ í•„ìš”";
  }
}

function updateLandPriceUI(won){
  const elLP = el("landPrice");
  if(!elLP) return;
  elLP.innerText = fmtWon(won);
}

// F-27/28: API-first refresh
window.refreshSolarLandEstimates = async function(){
  if(!BACKEND_URL) return; // optional
  const {lat, lng} = getAnalysisLatLng();
  if(typeof lat !== "number" || typeof lng !== "number") return;

  const address = currentAnalysisData.address || "í™•ì¸ í•„ìš”";
  const mode = currentAnalysisData.mode || "roof";

  // F-27 solar optimize
  try{
    const r = await postJson(`${BACKEND_URL}/api/solar/optimize`, {lat, lng, address, mode});
    if(r.ok && r.data && r.data.ok){
      currentAnalysisData.solar_opt = r.data;
      updateSolarOptUI(r.data);

      // Finance recalculation with sun hours (highest priority)
      if(typeof r.data.sun_hours === "number"){
        
function attachCommaInput(inputId){
  const inp = document.getElementById(inputId);
  if(!inp) return;

  const fmt = ()=>{
    const raw = (inp.value||"").toString().replace(/[^0-9]/g,"");
    if(raw.length===0){ inp.value="0"; return; }
    inp.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };

  const fmtInput = ()=>{
    const start = inp.selectionStart ?? null;
    const end = inp.selectionEnd ?? null;
    const hadSel = (start!==null && end!==null);

    const before = (inp.value||"").toString();
    const digits = before.replace(/[^0-9]/g,"");
    if(digits.length===0){
      inp.value = "0";
      if(hadSel) inp.setSelectionRange(inp.value.length, inp.value.length);
      return;
    }
    const withComma = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    inp.value = withComma;

    // caret: keep at end (safe, avoids weird mid-typing jumps)
    if(hadSel){
      const pos = inp.value.length;
      try{ inp.setSelectionRange(pos, pos); }catch(e){}
    }
  };

  inp.addEventListener("blur", fmt);
  inp.addEventListener("change", fmt);
  inp.addEventListener("input", fmtInput);
}

function computeRecommendedLtv(opts){
  try{
    const landMode = (opts.landMode||"BUY").toString();
    const landShare = Math.max(0, Math.min(1, Number(opts.landShare||0)));
    const isLease = (landMode === "LAND_LEASE" || landMode === "ROOF_LEASE");
    let base = isLease ? 55 : 70;
    if(landShare >= 0.40) base -= 15;
    else if(landShare >= 0.25) base -= 8;
    else if(landShare <= 0.10) base += 3;
    base = Math.max(40, Math.min(75, base));
    let reason = isLease ? "ì„ëŒ€í˜•(ë‹´ë³´ ì•½í•¨)" : "êµ¬ë§¤í˜•";
    if(landShare >= 0.40) reason += " / í† ì§€ë¹„ ë¹„ì¤‘â†‘";
    else if(landShare <= 0.10) reason += " / í† ì§€ë¹„ ë¹„ì¤‘â†“";
    return { pct: base, reason };
  }catch(e){
    return { pct: 60, reason: "ê¸°ë³¸ê°’" };
  }
}
window.calculateFinance(getTotalPanelCount(), r.data.sun_hours);
      }
    }
  }catch(e){ /* ignore */ }

  // F-28 land price estimate (land mode only OR if user wants)
  try{
    const areaM2 = (typeof currentAnalysisData.area_m2 === "number") ? currentAnalysisData.area_m2 : null;
    const areaPyeong = (areaM2 && areaM2 > 0) ? (areaM2 / 3.3058) : null;
    const payload = { address, pnu: currentAnalysisData.pnu || null, area_m2: areaM2, area_pyeong: areaPyeong, project_dc_kw: (Number(currentAnalysisData.dc_kw||currentAnalysisData.dcKw||0)||0) };
    const r2 = await postJson(`${BACKEND_URL}/api/land/estimate`, payload);
    if(r2.ok && r2.data && r2.data.ok){
      currentAnalysisData.land_estimate = r2.data;
      const landWon = (typeof r2.data.land_price_won === "number") ? r2.data.land_price_won : null;
      updateLandPriceUI(landWon);

      // Save into finance ROI skeleton (F-19) if already computed
      if(currentAnalysisData.finance?.roi25y){
        currentAnalysisData.finance.roi25y.land_price_won = landWon;
      }
    }
  }catch(e){ /* ignore */ }
};


function formatNumber(n){
  try{
    const x = Math.round(Number(n||0));
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }catch(e){ return "0"; }
}
function showToast(msg){
  const t = el("toastMsg");
  const txt = el("toastText");
  if(!t || !txt) return;
  txt.innerText = msg;
  t.classList.remove("hidden");
  t.classList.add("flex");
  setTimeout(()=>{ t.classList.add("hidden"); t.classList.remove("flex"); }, 2800);
}

function logSystem(msg){
  const w = el("logWindow");
  if(!w) return;
  const p = document.createElement("div");
  p.innerText = `> ${msg}`;
  w.appendChild(p);
  w.scrollTop = w.scrollHeight;
}

function fmtHHMMSS(ms){
  ms = Math.max(0, Math.floor(ms));
  const s = Math.floor(ms/1000);
  const hh = String(Math.floor(s/3600)).padStart(2,'0');
  const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}

function safeText(v, fallback="í™•ì¸ í•„ìš”"){
  if(v === undefined || v === null) return fallback;
  const s = String(v).trim();
  return s ? s : fallback;
}

// -----------------------------
// JSONP (VWorld)
// -----------------------------
async function jsonpRequest(url){
  return new Promise((resolve, reject) => {
    const callbackName = `jsonp_${Date.now()}_${_hashSeed(String(Date.now()))}`;
    window[callbackName] = (data) => {
      try { delete window[callbackName]; } catch(e) {}
      const script = document.getElementById(callbackName);
      if(script) script.remove();
      resolve(data);
    };
    const script = document.createElement("script");
    script.id = callbackName;
    script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
    script.onerror = () => {
      try { delete window[callbackName]; } catch(e) {}
      script.remove();
      reject(new Error("JSONP failed"));
    };
    document.body.appendChild(script);
  });
}

// -----------------------------
// Map init / layers
// -----------------------------
window.initMap = function(){
  if(map) return;

  map = L.map("map", { zoomControl: false }).setView([36.5, 127.5], 7);
  window.map = map;
  L.control.zoom({ position: "bottomright" }).addTo(map);

  // âœ… Zoom Level í‘œì‹œê¸°
  function zoomLabel(z){
    if(z >= 17) return "ì§€ë¶•/êµ¬ì¡°ë¬¼";
    if(z >= 16) return "ê±´ë¬¼/í•„ì§€";
    if(z >= 14) return "ë¸”ë¡/ë„ë¡œ";
    if(z >= 12) return "ë™/ìë©´";
    return "ê´‘ì—­";
  }
  function updateZoomIndicator(){
    try{
      const z = map.getZoom();
      const elz = document.getElementById("zoomIndicator");
      if(elz) elz.innerText = `ğŸ” Zoom: ${z} (${zoomLabel(z)})`;
    }catch(e){}
  }
  map.on("zoomend", updateZoomIndicator);
  map.on("moveend", updateZoomIndicator);
  updateZoomIndicator();


  layers = {
    base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`),
    sat:  L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
    hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`),
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }),
  };
  layers.sat.addTo(map);

  // VWORLD_TILE_KEY missing/placeholder â†’ fallback to OSM
  try{
    const keyStr = String(VWORLD_TILE_KEY||"");
    if(!keyStr || keyStr.toLowerCase().includes("your_") || keyStr.includes("undefined")){
      showToast("VWorld í‚¤ ë¯¸ì„¤ì • â†’ OSMìœ¼ë¡œ ì„ì‹œ ì „í™˜í•©ë‹ˆë‹¤(í‚¤/ë„ë©”ì¸ í—ˆìš© ì„¤ì • í•„ìš”)");
      try{ map.removeLayer(layers.sat);}catch(e){}
      try{ map.removeLayer(layers.base);}catch(e){}
      try{ map.removeLayer(layers.hybrid);}catch(e){}
      if(layers.osm && !map.hasLayer(layers.osm)) layers.osm.addTo(map);
    }
  }catch(e){}

  // VWorld tile fallback: if Satellite tiles fail, switch to Base so map doesn't look "black"
  try{
    layers.sat.on("tileerror", () => {
      try{
        showToast("VWorld ìœ„ì„± íƒ€ì¼ ë¡œë”© ì‹¤íŒ¨ â†’ ì¼ë°˜ì§€ë„ë¡œ ì „í™˜(í‚¤/ë„ë©”ì¸/ì¿¼í„° í™•ì¸ í•„ìš”)");
        if(map && layers.base){
          try{ map.removeLayer(layers.sat); }catch(e){}
          if(!map.hasLayer(layers.base)) layers.base.addTo(map);
          // update radio UI
          const radios = document.querySelectorAll('input[name="mapL"]');
          radios.forEach(r=>{ if(r.value==="base") r.checked=true; });
        }
      }catch(e){}
    });
  }catch(e){}

  // VWorld base tile fallback â†’ OSM
  try{
    layers.base.on("tileerror", () => {
      try{
        showToast("VWorld ì¼ë°˜ì§€ë„ íƒ€ì¼ ë¡œë”© ì‹¤íŒ¨ â†’ OSMìœ¼ë¡œ ì „í™˜");
        if(map && layers.osm){
          try{ map.removeLayer(layers.base);}catch(e){}
          if(!map.hasLayer(layers.osm)) layers.osm.addTo(map);
        }
      }catch(e){}
    });
  }catch(e){}

  selectableGroup = L.layerGroup().addTo(map);
  panelGroup = L.layerGroup().addTo(map);
  window.panelGroup = panelGroup;
  analysisMarkerGroup = L.layerGroup().addTo(map);
  existingGroup = L.layerGroup().addTo(map);
  substationGroup = L.layerGroup().addTo(map);

  // cadastral WMS (optional)
  cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms', {
    layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
    styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
    format: 'image/png',
    transparent: true,
    opacity: 0.7,
    key: VWORLD_TILE_KEY
  });
  map.addLayer(cadastralLayer);

  // VWorld ì§€ì ë„ WMS ì˜¤ë¥˜ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ (ì˜ˆ: 404, í‚¤ ë¬¸ì œ, ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ë“±)
  try{
    let _vwCadastralErrCount = 0;
    cadastralLayer.on('tileerror', function(e){
      _vwCadastralErrCount++;
      if(_vwCadastralErrCount === 1){
        console.warn("VWorld cadastral WMS tileerror", e);
        try{ logSystem("VWorld ì§€ì ë„ ë ˆì´ì–´ ë¡œë”© ì‹¤íŒ¨ (íƒ€ì¼ ì˜¤ë¥˜). VWorld í‚¤ ë˜ëŠ” ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."); }catch(_){}
        try{ showToast("ì§€ì ë„(VWorld) í‘œì‹œê°€ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ì§€ë„ë¥¼ ìš°ì„  í™•ì¸í•´ ì£¼ì„¸ìš”."); }catch(_){}
      }
    });
  }catch(_){}

  // click -> scan around (F-6 entrypoint)
  // Improve reliability: ignore click after drag, throttle, and slightly delay to let Leaflet finish internal state.
  let _lastMapClickTs = 0;
  
  // Pan guard (prevents click being ignored due to internal draggable flags)
  let __isPanning = false;
  map.on("movestart", ()=>{ __isPanning = true; });
  map.on("moveend", ()=>{ setTimeout(()=>{ __isPanning = false; }, 180); });
map.on("click", (e) => {
    if(FEATURE_LEVEL < 3) return;
    if(map.dragging && map.dragging._draggable && map.dragging._draggable._moving) return;
    const now = Date.now();
    if(now - _lastMapClickTs < 250) return;
    _lastMapClickTs = now;
    try{ drawTemporaryCandidate(e.latlng.lat, e.latlng.lng); }catch(_e){}
    setTimeout(()=>{ 
      try{ scanBuildings(e.latlng.lat, e.latlng.lng, true); }catch(err){ console.warn(err); }
    }, 60);
  });

  // moveend -> auto scan (F-13)
  map.on("moveend", () => {
    try { updateAutoScanBox(); } catch(e) {}
    if(FEATURE_LEVEL < 4) return;
    if(!autoScanMode) return;
    const autoFollow = el("autoFollow");
    if(autoFollow && autoFollow.checked) return; // mission auto-follow ì¤‘ì—” ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

    // F-13: í™”ë©´ ì´ë™/í™•ëŒ€ ê¸°ë°˜ ìë™ ìŠ¤ìº” (ë””ë°”ìš´ìŠ¤)
    if(autoScanDebounce) clearTimeout(autoScanDebounce);
    autoScanDebounce = setTimeout(() => {
      const c = map.getCenter();
      scanBuildings(c.lat, c.lng, true);
    }, 450);
  
    // Infra layers (F-25/26): debounce reload on moveend as well (prevents jitter / excessive redraw)
    try{
      if(infraDebounce) clearTimeout(infraDebounce);
      infraDebounce = setTimeout(()=>{ refreshInfraIfNeeded(); }, 650);
    }catch(e){}

  });


  // zoomend -> infra reload (F-25/26)
  map.on("zoomend", () => {
    try { refreshInfraIfNeeded(); } catch(e) {}
  });

    try { refreshInfraIfNeeded(); } catch(e) {}

  logSystem(`System ready. feat=${FEATURE_LEVEL}`);


// [PATCH] AutoScan default ON
try{
  const chk = document.getElementById("autoScanToggle");
  if(chk) chk.checked = true;
  if(typeof window.toggleAutoScan === "function") window.toggleAutoScan(true);
}catch(e){}
};

// Kakao ì§€ë„ì—ì„œ ì¤Œ/ì„¼í„° ë³€ê²½ ì‹œ Zoom ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
window.updateZoomIndicatorFromKakao = function(level){
  try{
    const elz = document.getElementById("zoomIndicator");
    if(!elz) return;
    // Leaflet zoomê³¼ Kakao levelì„ ëŒ€ëµ ë§¤í•‘ (levelì´ ì‘ì„ìˆ˜ë¡ í™•ëŒ€)
    const approxZoom = 18 - level;
    let label = "ê´‘ì—­";
    if(approxZoom >= 17) label = "ì§€ë¶•/êµ¬ì¡°ë¬¼";
    else if(approxZoom >= 16) label = "ê±´ë¬¼/í•„ì§€";
    else if(approxZoom >= 14) label = "ë¸”ë¡/ë„ë¡œ";
    else if(approxZoom >= 12) label = "ë™/ìë©´";
    elz.innerText = `ğŸ” Kakao Lv.${level} (${label})`;
  }catch(e){}
};



// Map layer switch (existing UI uses setMap)
window.setMap = function(t){
  if(!map) return;
  const kakaoLayer = document.getElementById("kakaoMap");

  if(t === "kakao"){
    try{
      if(!window.kakao || !kakao.maps){
        showToast("ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨: í‚¤/ë„ë©”ì¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        return;
      }
      if(kakaoLayer) kakaoLayer.style.display = "block";

      // Leaflet ê¸°ë³¸/ìœ„ì„± ë ˆì´ì–´ëŠ” ëª¨ë‘ ìˆ¨ê¹€
      try{ layers.sat && map.removeLayer(layers.sat); }catch(e){}
      try{ layers.base && map.removeLayer(layers.base); }catch(e){}
      try{ layers.osm && map.removeLayer(layers.osm); }catch(e){}

      // ìµœì´ˆ ì§„ì… ì‹œ Kakao ì§€ë„ ìƒì„±
      if(!kakaoMapInstance){
        const c = map.getCenter();
        const opt = {
          center: new kakao.maps.LatLng(c.lat, c.lng),
          level: 4
        };
        kakaoMapInstance = new kakao.maps.Map(kakaoLayer, opt);
        try {
          kakaoMapInstance.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
        } catch(e) {}

        // Kakao ë§µ ì¤Œ/ì„¼í„° ë³€ê²½ ì‹œ ì¸ë””ì¼€ì´í„° ê°±ì‹ 
        kakao.maps.event.addListener(kakaoMapInstance, "zoom_changed", function(){
          try{
            const lv = kakaoMapInstance.getLevel();
            if(window.updateZoomIndicatorFromKakao) window.updateZoomIndicatorFromKakao(lv);
          }catch(e){}
        });
        kakao.maps.event.addListener(kakaoMapInstance, "center_changed", function(){
          try{
            const lv = kakaoMapInstance.getLevel();
            if(window.updateZoomIndicatorFromKakao) window.updateZoomIndicatorFromKakao(lv);
          }catch(e){}
        });
      } else {
        // Leaflet ì¤‘ì‹¬ ì¢Œí‘œë¥¼ Kakaoë¡œ ë™ê¸°í™”
        const c = map.getCenter();
        kakaoMapInstance.setCenter(new kakao.maps.LatLng(c.lat, c.lng));
        try {
          kakaoMapInstance.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
        } catch(e) {}
      }
      kakaoActive = true;
    }catch(e){
      console.error(e);
      showToast("ì¹´ì¹´ì˜¤ ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  } else {
    // Kakao â†’ Leaflet ëª¨ë“œë¡œ ë³µê·€
    kakaoActive = false;
    if(kakaoLayer) kakaoLayer.style.display = "none";

    // Kakao ì¤‘ì‹¬ â†’ Leafletìœ¼ë¡œ ì—­ë™ê¸°í™”
    try{
      if(kakaoMapInstance){
        const kc = kakaoMapInstance.getCenter();
        map.setView([kc.getLat(), kc.getLng()], map.getZoom());
      }
    }catch(e){}

    if(t === "base"){
      try{ map.addLayer(layers.base); }catch(e){}
      try{ layers.sat && map.removeLayer(layers.sat); }catch(e){}
    } else if(t === "sat"){
      try{ map.addLayer(layers.sat); }catch(e){}
      try{ layers.base && map.removeLayer(layers.base); }catch(e){}
    }

    // í•˜ë‚˜ë„ í™œì„±í™” ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ OSMì´ë¼ë„ ë¶™ì—¬ì¤Œ
    try{
      const hasBase = layers.base && map.hasLayer(layers.base);
      const hasSat = layers.sat && map.hasLayer(layers.sat);
      if(!hasBase && !hasSat && layers.osm){
        if(!map.hasLayer(layers.osm)) map.addLayer(layers.osm);
      }
    }catch(e){}
  }
};


// í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ìœ¼ë¡œ ì¹´ì¹´ì˜¤ ë¡œë“œë·° ìƒˆì°½ ì—´ê¸°
window.openKakaoRoadview = function(){
  try{
    let lat = null, lng = null;
    if(kakaoActive && kakaoMapInstance){
      const c = kakaoMapInstance.getCenter();
      lat = c.getLat();
      lng = c.getLng();
    } else if(map){
      const c = map.getCenter();
      lat = c.lat;
      lng = c.lng;
    }
    if(lat == null || lng == null){
      showToast("ë¡œë“œë·° ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const url = `https://map.kakao.com/link/roadview/${lat},${lng}`;
    window.open(url, "_blank", "noopener");
  }catch(e){
    console.error(e);
    showToast("ì¹´ì¹´ì˜¤ ë¡œë“œë·°ë¥¼ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
};


// Existing toggles for layers
window.toggleLayer = function(type){
  if(!map) return;

  if(type === "cadastral"){
    const chk = el("cadastralToggle");
    if(!chk) return;
    if(chk.checked) map.addLayer(cadastralLayer);
    else map.removeLayer(cadastralLayer);
    return;
  }

  if(type === "existing"){
    const chk = el("existingPlantToggle");
    if(!chk) return;
    if(chk.checked){
      if(!map.hasLayer(existingGroup)) map.addLayer(existingGroup);
      refreshInfraIfNeeded(true);
    }else{
      // hide only (keep cache)
      try{ existingGroup.clearLayers(); }catch(e){}
      try{ map.removeLayer(existingGroup); }catch(e){}
      infraLastKey.plant = null;
    }
    return;
  }

  // Virtual substation/line layer (mock, deterministic & zoom-gated)
  if(type === "substation" || type === "line"){
    const chk = el(type === "line" ? "lineToggle" : "substationToggle");
    if(!chk) return;

    if(chk.checked){
      // show
      if(window.virtualInfraLayer && !map.hasLayer(window.virtualInfraLayer)) map.addLayer(window.virtualInfraLayer);
      refreshInfraLayerStable(true);
    }else{
      // hide
      try{
        if(window.virtualInfraLayer){
          window.virtualInfraLayer.clearLayers();
          map.removeLayer(window.virtualInfraLayer);
        }
      }catch(e){}
    }
    return;
  }
};

// -----------------------------
// F-25/26 Infra layers (API-first, fallback mock)
//  - F-25: KEPCO line/substation capacity layer (ready-to-connect)
//  - F-26: Existing solar plants layer (red panels)
// -----------------------------
const INFRA_MIN_ZOOM = 15;
const INFRA_MAX_ZOOM = 18; // hide beyond this zoom (prevents visual noise/jitter)
// -----------------------------
// F-25 (Card): KEPCO capacity (best-effort)
// - If backend returns value: use it
// - Else: deterministic simulated capacity from (pnu/address) so UI never stays null
// -----------------------------
function _stableSeedFromText(s){
  s = String(s||"");
  let h = 2166136261;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  return (h>>>0);
}
function check_kepco_capacity_sim(pnu, address){
  const seed = _stableSeedFromText((pnu||"") + "|" + (address||""));
  const r = seed % 1000;
  // Bucket into realistic-looking ranges (MW)
  if(r < 220) return "4MW ì´ìƒ";
  if(r < 520) return "2~4MW";
  if(r < 820) return "1~2MW";
  return "1MW ë¯¸ë§Œ";
}
window.updateKepcoCapacity = async function(address, pnu){
  try{
    const elc = el("kepcoCapacity");
    if(elc) elc.innerText = "ì¡°íšŒ ì¤‘...";
    // Prefer backend if configured
    if(window.BACKEND_URL){
      const qs = new URLSearchParams();
      if(pnu) qs.set("pnu", String(pnu));
      if(address) qs.set("address", String(address));
      const r = await fetch(`${window.BACKEND_URL}/api/infra/kepco?`+qs.toString(), {credentials:"include"});
      const j = await r.json().catch(()=>null);
      const cap = j?.kepco_capacity || j?.kepcoCapacity || null;
      const explained = j?.kepco_capacity_interpreted || j?.kepco_capacity_explained || null;
      if(cap){
        if(elc){
          if(explained){
            elc.innerText = String(cap) + "\n" + String(explained);
          }else{
            elc.innerText = String(cap);
          }
        }
        return;
      }
    }
    // Fallback sim (never null)
    const sim = check_kepco_capacity_sim(pnu, address);
    if(elc) elc.innerText = sim;
  }catch(e){
    const sim = check_kepco_capacity_sim(pnu, address);
    try{ if(el("kepcoCapacity")) el("kepcoCapacity").innerText = sim; }catch(_){}
  }
};

let infraDebounce = null;

// Deterministic pseudo-random for stable mock rendering
function _hashSeed(s){
  try{
    let h = 2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }catch(e){
    return Math.floor(Math.random()*1e9);
  }
}
function _rand(seed){
  // xorshift32
  let x = seed >>> 0;
  return function(){
    x ^= (x << 13); x >>>= 0;
    x ^= (x >>> 17); x >>>= 0;
    x ^= (x << 5); x >>>= 0;
    return (x >>> 0) / 4294967296;
  }
}
function getMapBBox(){
  const b = map.getBounds();
  return {
    minLat: b.getSouth(),
    minLng: b.getWest(),
    maxLat: b.getNorth(),
    maxLng: b.getEast()
  };
}
function bboxKey(b, z, kind){
  // Stabilize bbox key so mock/loaded infra layers do not "jump" while panning slightly.
  // Quantize bbox to a grid depending on zoom.
  const step = (z >= 18) ? 0.001 : (z >= 17) ? 0.002 : (z >= 16) ? 0.005 : 0.01;
  const q = (v)=> (Math.floor(v/step)*step).toFixed(3);
  return `${kind}:${z}:${q(b.minLat)},${q(b.minLng)},${q(b.maxLat)},${q(b.maxLng)}`;
}
let infraLastKey = { plant:null, sub:null };

async function loadInfra(kind, force=false){
  if(!map) return;
  const z = map.getZoom();
  if(z < INFRA_MIN_ZOOM) return;

  const b = getMapBBox();
  const key = bboxKey(b, z, kind);
  if(!force){
    if(kind === "plant" && infraLastKey.plant === key) return;
    if(kind === "substation" && infraLastKey.sub === key) return;
  }

  if(kind === "plant") infraLastKey.plant = key;
  else infraLastKey.sub = key;

  const group = (kind === "plant") ? existingGroup : substationGroup;
  group.clearLayers();

  // 1) Try backend API
  if(BACKEND_URL){
    try{
      const url = (kind === "plant")
        ? `${BACKEND_URL}/api/infra/existing?bbox=${encodeURIComponent(`${b.minLng},${b.minLat},${b.maxLng},${b.maxLat}`)}&z=${z}`
        : `${BACKEND_URL}/api/infra/kepco?bbox=${encodeURIComponent(`${b.minLng},${b.minLat},${b.maxLng},${b.maxLat}`)}&z=${z}`;
      const r = await fetch(url, {credentials:"include"});
      const data = await r.json();
      if(data && data.ok){
        const items = data.items || [];
        const lines = data.lines || [];
        if(items.length || lines.length){
          renderInfra(kind, items, lines);
          return;
        }
        // no real data yet
        showToast((kind==="plant" ? "ê¸° ì„¤ì¹˜ íƒœì–‘ê´‘" : "í•œì „ ìš©ëŸ‰") + ": ë°ì´í„° ì†ŒìŠ¤ ë¯¸í™•ì • â†’ í™•ì¸ í•„ìš”(ëª¨ì˜ í‘œì‹œ)");
      }
    }catch(e){
      // fallback to mock
    }
  }else{
    // no backend configured
    showToast((kind==="plant" ? "ê¸° ì„¤ì¹˜ íƒœì–‘ê´‘" : "í•œì „ ìš©ëŸ‰") + ": backend ë¯¸ì„¤ì • â†’ í™•ì¸ í•„ìš”(ëª¨ì˜ í‘œì‹œ)");
  }

  // 2) Fallback mock (stable)
  const seed = _hashSeed(key);
  const rnd = _rand(seed);
  const count = (kind==="plant") ? 16 : 10;

    const items = [];
  // Grid-based deterministic mock: markers are anchored to world grid cells,
  // so they do not "jump" when panning/zooming slightly.
  const cellStep = (z >= 17) ? 0.005 : 0.01; // ~500m / ~1km
  const minI = Math.floor(b.minLat / cellStep);
  const maxI = Math.floor(b.maxLat / cellStep);
  const minJ = Math.floor(b.minLng / cellStep);
  const maxJ = Math.floor(b.maxLng / cellStep);

  // density controls how many cells emit a marker
  const emitEvery = (kind === "plant") ? 6 : 10;

  for(let i=minI; i<=maxI; i++){
    for(let j=minJ; j<=maxJ; j++){
      const cellSeed = _hashSeed(`${kind}:cell:${i}:${j}`);
      // decide whether this cell emits a marker
      if((cellSeed % emitEvery) !== 0) continue;

      const rcell = _rand(cellSeed);
      const lat = (i * cellStep) + (cellStep * (0.2 + 0.6*rcell()));
      const lng = (j * cellStep) + (cellStep * (0.2 + 0.6*rcell()));

      if(kind === "plant"){
        items.push({
          id: `mock-plant-${i}-${j}`,
          lat, lng,
          capacity_kw: Math.round(30 + 970*rcell()),
          status: "í™•ì¸ í•„ìš”"
        });
      }else{
        items.push({
          id: `mock-sub-${i}-${j}`,
          lat, lng,
          name: `ë³€ì „ì†Œ(ê°€ìƒ) ${Math.abs(cellSeed % 999) + 1}`,
          remaining_mw: Math.round(5 + 8*rcell()),
          status: "í™•ì¸ í•„ìš”"
        });
      }

      // hard cap to keep UI responsive
      if(items.length >= count) break;
    }
    if(items.length >= count) break;
  }
const lines = [];
  if(kind === "substation"){
    // draw some mock lines
    for(let i=0;i<6;i++){
      const a = items[Math.floor(rnd()*items.length)];
      const b2 = items[Math.floor(rnd()*items.length)];
      if(!a || !b2) continue;
      lines.push({
        id: `mock-line-${i}`,
        coords: [[a.lat,a.lng],[b2.lat,b2.lng]],
        remaining_mw: Math.min(a.remaining_mw, b2.remaining_mw),
        status: "í™•ì¸ í•„ìš”"
      });
    }
  }

  renderInfra(kind, items, lines);
}

async function getRoadRouteCoords(aLatLng, bLatLng){
  try{
    if(!window.BACKEND_URL) return null;
    const qs = new URLSearchParams({
      slat: String(aLatLng[0]), slng: String(aLatLng[1]),
      elat: String(bLatLng[0]), elng: String(bLatLng[1]),
    });
    const res = await fetch(`${window.BACKEND_URL}/api/route?`+qs.toString(), {credentials:"include"});
    const j = await res.json().catch(()=>null);
    if(!j || !j.ok) return null;
    const coords = j.coords;
    if(Array.isArray(coords) && coords.length>=2) return coords;
  }catch(e){}
  return null;
}

function renderInfra(kind, items, lines){
  const z = map?.getZoom?.() ?? 0;
  if(kind === "substation"){
    if(z < 15 || z > 16){
      try{ substationGroup.clearLayers(); }catch(e){}
      return;
    }
  }
  const group = (kind === "plant") ? existingGroup : substationGroup;

  if(kind === "substation" && Array.isArray(lines)){
    lines.forEach(ln=>{
      if(!ln || !Array.isArray(ln.coords) || ln.coords.length < 2) return;
      const pl = L.polyline(ln.coords, {weight:3, opacity:0.8, dashArray:'6 6'});
      // âœ… ë„ë¡œ ê¸°ë°˜ ìµœë‹¨ê²½ë¡œ(ê°€ëŠ¥í•œ ê²½ìš°): V-World route â†’ ì„±ê³µ ì‹œ ê²½ë¡œë¡œ êµì²´
      (async ()=>{
        if(!Array.isArray(ln.coords) || ln.coords.length!==2) return;
        const a = ln.coords[0], b = ln.coords[1];
        const route = await getRoadRouteCoords(a, b);
        if(route){ pl.setLatLngs(route); pl.setStyle({dashArray:null}); }
      })();
      pl.on("click", ()=>{
        const txt = `í•œì „ ì„ ë¡œ(í™•ì¸ í•„ìš”)<br/>ì”ì—¬ìš©ëŸ‰: ${(ln.remaining_mw ?? "í™•ì¸ í•„ìš”")} MW<br/>ê°€ìš©ì—°ë„: ${(ln.available_year ?? "í™•ì¸ í•„ìš”")}`;
        pl.bindPopup(txt).openPopup();
      });
      pl.addTo(group);
    });
  }

  items.forEach(it=>{
    const lat = it.lat, lng = it.lng;
    if(typeof lat !== "number" || typeof lng !== "number") return;

    if(kind === "plant"){
      const iconHtml = `<div class="w-6 h-3 bg-red-500 border border-red-800 transform -skew-x-12 shadow"></div>`;
      const icon = L.divIcon({ className:"", html: iconHtml, iconSize:[26,14] });
      const mk = L.marker([lat,lng], {icon});
      mk.on("click", ()=>{
        const txt = `ê¸° ì„¤ì¹˜ íƒœì–‘ê´‘(í™•ì¸ í•„ìš”)<br/>ìš©ëŸ‰: ${(it.capacity_kw ?? "í™•ì¸ í•„ìš”")} kW`;
        mk.bindPopup(txt).openPopup();
      });
      mk.addTo(group);
    }else{
      const iconHtml = `<div class="w-7 h-7 flex items-center justify-center bg-yellow-500 rounded-full text-white shadow border border-yellow-700"><span style="font-weight:900">âš¡</span></div>`;
      const icon = L.divIcon({ className:"", html: iconHtml, iconSize:[28,28] });
      const mk = L.marker([lat,lng], {icon});
      mk.on("click", ()=>{
        const txt = `${it.name || "ë³€ì „ì†Œ"}<br/>ì”ì—¬ìš©ëŸ‰: ${(it.remaining_mw ?? "í™•ì¸ í•„ìš”")} MW<br/>ê°€ìš©ì—°ë„: ${(it.available_year ?? "í™•ì¸ í•„ìš”")}<br/><span style="color:#f59e0b;font-weight:700">í™•ì¸ í•„ìš”</span>`;
        mk.bindPopup(txt).openPopup();
      });
      mk.addTo(group);
    }
  });
}

// Called when layer toggles ON or map moves
function refreshInfraIfNeeded(force=false){
  if(!map) return;
  const z = map.getZoom();
  if(z < INFRA_MIN_ZOOM || z > INFRA_MAX_ZOOM){
    try{ map.removeLayer(existingGroup); }catch(e){}
    try{ map.removeLayer(substationGroup); }catch(e){}
    try{ window.virtualInfraLayer && window.virtualInfraLayer.clearLayers(); }catch(e){}
    return;
  }

  if(el("existingPlantToggle")?.checked){
    if(!map.hasLayer(existingGroup)) map.addLayer(existingGroup);
    loadInfra("plant", force);
  }
  if(el("substationToggle")?.checked){
    if(!map.hasLayer(substationGroup)) map.addLayer(substationGroup);
    loadInfra("substation", force);
  }
}


// -----------------------------
// Tab / Sidebar (existing UI callbacks)
// -----------------------------
window.switchTab = function(tab){
  const tabs = ["scan","analysis","legal","history"];
  for(const t of tabs){
    const tb = el(`tab-${t}`);
    const pn = el(`panel-${t}`);
    if(tb) tb.classList.remove("active");
    if(pn) pn.classList.add("hidden");
  }
  const tb = el(`tab-${tab}`);
  const pn = el(`panel-${tab}`);
  if(tb) tb.classList.add("active");
  if(pn) pn.classList.remove("hidden");
};

window.toggleSidebar = function(){
  const sb = el("sidebar");
  const btn = el("sidebar-toggle-btn");
  if(sb) sb.classList.toggle("collapsed");
  if(btn) btn.classList.toggle("collapsed");
};

// -----------------------------
// Feature 2: Mode toggle (F-5)
// -----------------------------
window.toggleTarget = function(){
  if(FEATURE_LEVEL < 2){
    showToast("feat<2: ëª¨ë“œ ì „í™˜ ë¹„í™œì„±");
    return;
  }
  const radios = document.getElementsByName("scanTarget");
  for(const r of radios){
    if(r.checked){
      scanTarget = (r.value === "land") ? "land" : "building";
      break;
    }
  }
  clearResults(true);
  showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === "land" ? "í† ì§€" : "ì§€ë¶•"}`);
  logSystem(`mode=${scanTarget}`);
};

// -----------------------------
// Feature 1: Address search (F-4)
// -----------------------------
window.searchAddress = async function(){
  if(FEATURE_LEVEL < 1){
    showToast("feat<1: ì£¼ì†Œê²€ìƒ‰ ë¹„í™œì„±");
    return;
  }
  const input = el("addrInput");
  const q = (input ? input.value : "").trim();
  if(!q){
    showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const loading = el("loading");
  if(loading) loading.classList.remove("hidden");
  _aiBarStart();

  try{
    const vworldGet = async (type) => {
      const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(q)}&refine=true&simple=false&type=${type}&key=${VWORLD_TILE_KEY}`;
      return await jsonpRequest(url);
    };

    // 1) VWorld ë„ë¡œëª…(road) ìš°ì„  â†’ 2) ì§€ë²ˆ(parcel) fallback
    let data = await vworldGet("road");
    if(!(data?.response?.status === "OK")) data = await vworldGet("parcel");

    if(data?.response?.status === "OK"){
      const {x,y} = data.response.result.point;
      const lat = parseFloat(y), lng = parseFloat(x);
      map.setView([lat,lng], 18);
      showToast("ì£¼ì†Œ ì´ë™ ì™„ë£Œ");
      logSystem(`address -> ${lat},${lng}`);
      // auto scan around the location
      if(FEATURE_LEVEL >= 3){
        try{ if(typeof showSmartClickLoading==='function') showSmartClickLoading(true); }catch(_){}
        await new Promise(r=>setTimeout(r, 350));
        const res = await scanBuildings(lat, lng, true);
        if(res?.features?.length){
          analyzeFeature(res.features[0], true);
        }
        try{ if(typeof showSmartClickLoading==='function') showSmartClickLoading(false); }catch(_){}
      }
    } else {
      // 3) Kakao geocoder fallback (if SDK loaded)
      try{
        if(window.kakao && kakao.maps && kakao.maps.services){
          const geocoder = new kakao.maps.services.Geocoder();
          const kakaoRes = await new Promise((resolve) => {
            geocoder.addressSearch(q, (result, status) => {
              if(status === kakao.maps.services.Status.OK && result && result[0]){
                resolve(result[0]);
              }else{
                resolve(null);
              }
            });
          });
          if(kakaoRes){
            const lat = parseFloat(kakaoRes.y), lng = parseFloat(kakaoRes.x);
            map.setView([lat,lng], 18);
            showToast("ì£¼ì†Œ ì´ë™ ì™„ë£Œ");
            logSystem(`address(kakao) -> ${lat},${lng}`);
            // auto scan around the location
            if(FEATURE_LEVEL >= 3){
              try{ if(typeof showSmartClickLoading==='function') showSmartClickLoading(true); }catch(_){}
              await new Promise(r=>setTimeout(r, 350));
              const res = await scanBuildings(lat, lng, true);
              if(res?.features?.length){
                analyzeFeature(res.features[0], true);
              }
              try{ if(typeof showSmartClickLoading==='function') showSmartClickLoading(false); }catch(_){}
            }
            if(loading) loading.classList.add("hidden");
            return;
          }
        }
      }catch(_e){ /* ignore */ }
      showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    }
  } catch(e){
    console.error(e);
    showToast("ì£¼ì†Œê²€ìƒ‰ ì˜¤ë¥˜");
    logSystem(`address error: ${e.message}`);
  } finally {
    if(loading) loading.classList.add("hidden");
    try{ if(typeof showSmartClickLoading==='function') showSmartClickLoading(false); }catch(_){}
  }
};

// -----------------------------
// Multi-select mode (existing toggle)
// -----------------------------
window.toggleMultiSelect = function(){
  const chk = el("multiSelectToggle");
  isMultiSelectMode = !!(chk && chk.checked);
  clearResults(true);
};

// -----------------------------
// Auto scan toggle (F-13/14)
// -----------------------------
window.toggleAutoScan = function(){
  const chk = el("autoScanToggle");
  if(FEATURE_LEVEL < 4){
    if(chk) chk.checked = false;
    autoScanMode = false;
    showToast("feat<4: ìë™ ìŠ¤ìº” ë¹„í™œì„±");
    updateAutoScanBox();
    return;
  }
  autoScanMode = !!(chk && chk.checked);
  showToast(autoScanMode ? "ìë™ ìŠ¤ìº” ON" : "ìë™ ìŠ¤ìº” OFF");
  updateAutoScanBox();
};

// -----------------------------
// Core: scan buildings/land from VWorld
// -----------------------------
window.scanBuildings = scanBuildings;
// -----------------------------
// Land price estimate (F-28 readiness) - API-first (backend), fallback "í™•ì¸ í•„ìš”"
// -----------------------------

// Try to fetch PNU(19-digit) for a clicked point using VWORLD parcel WMS GetFeatureInfo.
// Returns string like "4118100000101230000" or null.
async function getPnuAtLatLng(lat, lng){
  try{
    if(!window.map || !window.PUBLIC_VWORLD_KEY) return null;

    const size = window.map.getSize();
    const bounds = window.map.getBounds();

    // Project to EPSG:3857
    const crs = window.map.options.crs;
    const sw = crs.project(bounds.getSouthWest());
    const ne = crs.project(bounds.getNorthEast());
    const p = crs.project(L.latLng(lat, lng));

    const bbox = `${sw.x},${sw.y},${ne.x},${ne.y}`;
    const i = Math.round((p.x - sw.x) / (ne.x - sw.x) * size.x);
    const j = Math.round((ne.y - p.y) / (ne.y - sw.y) * size.y);

    const layers = "lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun";
    const styles = "lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun";

    const url = "https://api.vworld.kr/req/wms"
      + `?service=WMS&request=GetFeatureInfo&version=1.1.1`
      + `&layers=${encodeURIComponent(layers)}&query_layers=${encodeURIComponent(layers)}`
      + `&styles=${encodeURIComponent(styles)}&format=image/png&transparent=true`
      + `&feature_count=5&info_format=text/xml`
      + `&srs=EPSG:3857&bbox=${encodeURIComponent(bbox)}`
      + `&width=${size.x}&height=${size.y}&x=${i}&y=${j}`
      + `&key=${encodeURIComponent(window.PUBLIC_VWORLD_KEY)}`;

    const r = await fetch(url, { method: "GET" });
    if(!r.ok) return null;
    const txt = await r.text();

    // PNU is typically a 19-digit number. Grab the first one we find.
    const m = txt.match(/\b\d{19}\b/);
    return m ? m[0] : null;
  }catch(e){
    return null;
  }
}

function updateLandPriceUI(landWon){
  const elLand = document.getElementById("landPrice");
  if(!elLand) return;

  // ì§€ë¶•í˜• ëª¨ë“œì—ì„œëŠ” í† ì§€ê°€ê²©ì€ "í•´ë‹¹ì‚¬í•­ ì—†ìŒ"ìœ¼ë¡œ í‘œì‹œ
  const mode =
    (window.currentAnalysisData && currentAnalysisData.mode) ||
    (typeof scanTarget !== "undefined" && scanTarget === "land" ? "land" : "roof");

  if(mode === "roof"){
    elLand.innerText = "í•´ë‹¹ì‚¬í•­ ì—†ìŒ";
    elLand.classList.remove("text-emerald-300");
    elLand.classList.add("text-yellow-300");
    elLand.title = "";
    return;
  }

  // ì¶”ì • í† ì§€ê°€ê²©(ì„œë²„/AI/ê³µì‹œì§€ê°€ ì¶”ì • ë“±)
  const estWon = (currentAnalysisData?.land_estimate && typeof currentAnalysisData.land_estimate.land_price_won === "number")
    ? currentAnalysisData.land_estimate.land_price_won
    : (typeof landWon === "number" ? landWon : 0);

  // ì‚¬ìš©ì ì„ íƒ(í† ì§€ ë³´ìœ /êµ¬ë§¤/ì„ëŒ€)
  const tenure = (document.getElementById("landTenureMode")?.value || "BUY").toString();
  const manualStr = (document.getElementById("pfLandBuyPrice")?.value ?? "").toString().replace(/,/g,"").trim();
  const manualWon = (manualStr ? Number(manualStr) : 0);

  // í™”ë©´ì— í‘œì‹œí•  "ì ìš© í† ì§€ê°€ê²©"(PF ê³„ì‚°ì— ì‚¬ìš©ë˜ëŠ” ê°’)
  let appliedWon = 0;
  let tag = "";
  if(tenure === "BUY"){
    if(isFinite(manualWon) && manualWon > 0){
      appliedWon = manualWon;
      tag = " (ìˆ˜ë™)";
    }else if(isFinite(estWon) && estWon > 0){
      appliedWon = estWon;
      tag = " (ì¶”ì •)";
    }
  }else{
    // ì„ëŒ€(í† ì§€/ì§€ë¶•)ì—ì„œëŠ” í† ì§€ê°€ê²©ì€ CAPEXì— ë°˜ì˜í•˜ì§€ ì•ŠìŒ
    appliedWon = 0;
    tag = " (ì„ëŒ€)";
  }

  // í‘œì‹œ/ìƒ‰ìƒ
  if(isFinite(appliedWon) && appliedWon > 0){
    elLand.innerText = `${formatWon(appliedWon)}${tag}`;
    elLand.classList.remove("text-yellow-300");
    elLand.classList.add("text-emerald-300");
  }else{
    // ì„ëŒ€ ëª¨ë“œë©´ 0ì„ ëª…ì‹œì ìœ¼ë¡œ ë³´ì—¬ì£¼ë˜, ì¶”ì •ê°€ëŠ” íˆ´íŒìœ¼ë¡œ ì œê³µ
    if(tenure === "LAND_LEASE" || tenure === "ROOF_LEASE"){
      elLand.innerText = `0 ì›${tag}`;
      elLand.classList.remove("text-emerald-300");
      elLand.classList.add("text-yellow-300");
    }else{
      elLand.innerText = "í™•ì¸ í•„ìš”";
      elLand.classList.remove("text-emerald-300");
      elLand.classList.add("text-yellow-300");
    }
  }

  // íˆ´íŒ(ì¶”ì •/ìˆ˜ë™/ì ìš© ê´€ê³„ ëª…í™•í™”)
  const estTxt = (isFinite(estWon) && estWon > 0) ? formatWon(estWon) : "ì—†ìŒ";
  const manTxt = (isFinite(manualWon) && manualWon > 0) ? formatWon(manualWon) : "ì—†ìŒ";
  const appTxt = (isFinite(appliedWon) && appliedWon > 0) ? formatWon(appliedWon) : "0";
  elLand.title = `ì¶”ì • í† ì§€ê°€ê²©: ${estTxt}
ìˆ˜ë™ ì…ë ¥: ${manTxt}
PF ì ìš©: ${appTxt}`;
}

window.fetchLandPriceEstimate = async function(address, lat, lng){
  try{
    const backend = getBackendBase();
    if(!backend) return null;

    // âœ… area_m2ê°€ ì—†ìœ¼ë©´: íŒ¨ë„ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œë¼ë„ ë©´ì  ì¶”ì •(ë„ ë°©ì§€)
    let area_m2 = currentAnalysisData.area_m2;
    if(!area_m2 || area_m2 <= 0){
      const pc = (typeof getTotalPanelCount === "function") ? getTotalPanelCount() : 0;
      // íŒ¨ë„ 1ì¥ ì ìœ ë©´ì (ëŒ€ëµ) 2.2ã¡ + í†µë¡œ/ê°„ê²© ì—¬ìœ  1.25ë°°
      if(pc && pc > 0) area_m2 = pc * 2.2 * 1.25;
    }

    const payload = {
      address: address||"",
      pnu: currentAnalysisData.pnu || null,
      area_m2: area_m2 || null,
      area_pyeong: (area_m2 ? (area_m2/3.305785) : null),
      lat, lng,
    };
    const r = await fetch(`${backend}/api/land/estimate`, {
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload),
      credentials:"include"
    });
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) return null;
    return j;
  }catch(e){
    console.warn("land price fetch failed", e);
    return null;
  }
};

async function scanBuildings(lat, lng, force=false){
  if(!map) return null;
  if(scanLock && !force) return null;
  scanLock = true;

  let fetchedFeatures = [];
  try{
    if(!isMultiSelectMode){
      selectableGroup.clearLayers();
      panelGroup.clearLayers();
      selectedFeatures.clear();
      currentAnalysisFeature = null;
      resetCalibrationInternal(false);
      // reset UI cards
      const rc = el("resultCard");
      if(rc) rc.classList.add("hidden");
      const lp = el("legalPlaceholder");
      const lc = el("legalContent");
      const sp = el("aiScorePanel");
      if(lp) lp.classList.remove("hidden");
      if(lc) lc.classList.add("hidden");
      if(sp) sp.classList.add("hidden");
    }

    analysisMarkerGroup.clearLayers();
    // ì§€ë„ ì¤‘ì‹¬ ë§ˆì»¤(ì„ íƒ ìœ„ì¹˜ í‘œì‹œ)ëŠ” ìœ ì§€ (íŒ¨ë„ ë“œë˜ê·¸ í•¸ë“¤ì€ ë³„ë„ ë¹„í™œì„±í™”ë¨)
    try{
      const mk = L.marker([lat, lng], { keyboard:false, interactive:false });
      mk.addTo(analysisMarkerGroup);
    }catch(e){}
    const z = map.getZoom();
    const d = (z >= 17) ? 0.0016 : (z >= 16 ? 0.0028 : 0.0042);
    const box = `${lng - d},${lat - d},${lng + d},${lat + d}`;
    const dataName = (scanTarget === "land") ? "LP_PA_CBND_BUBUN" : "LT_C_SPBD";

    const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${dataName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=${(z>=17)?80:(z>=16?120:180)}`;
    const data = await jsonpRequest(url);

    const fc = data?.response?.result?.featureCollection;
    fetchedFeatures = fc?.features || [];
    window.lastScanCandidates = fetchedFeatures;

    L.geoJSON(fetchedFeatures, {
      style: (scanTarget === "land")
        ? { color:"#8d6e63", weight:2, fillColor:"#8d6e63", fillOpacity:0.25 }
        : { color:"#3b82f6", weight:2, fillOpacity:0.20 },
      onEachFeature: (feature, layer) => {
        layer.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          analyzeFeature(feature, true);
        });
      }
    }).addTo(selectableGroup);

    const found = el("foundCount");
    if(found) found.innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${selectableGroup.getLayers().length}ê°œ`;

    return { features: fetchedFeatures, count: fetchedFeatures.length };
  } catch(e){
    console.error(e);
    logSystem(`scan error: ${e.message}`);
    return null;
  } finally {
    setTimeout(()=>{ scanLock = false; }, 500);
  }
}

// -----------------------------
// Panel generation (F-6~F-9)
// -----------------------------
function metersToKm(m){ return (m || 0) / 1000; }

function applyCalibrationToFC(fc){
  if(!window.turf || !fc) return fc;
  let out = turf.clone(fc);

  // rotate first around centroid
  if(calibration.rot_deg){
    try { out = turf.transformRotate(out, calibration.rot_deg); } catch(e) {}
  }

  // translate (east-west then north-south)
  if(calibration.dx_m){
    try { out = turf.transformTranslate(out, metersToKm(calibration.dx_m), 90, {units:"kilometers"}); } catch(e) {}
  }
  if(calibration.dy_m){
    try { out = turf.transformTranslate(out, metersToKm(calibration.dy_m), 0, {units:"kilometers"}); } catch(e) {}
  }

  return out;
}

function buildPanelsFCFromGeometry(geo){
  // Safety: fallback grid always visible
  const fallback = () => {
    let bbox = null;
    try { bbox = turf.bbox(turf.feature(geo)); } catch(e) {}
    if(!bbox){
      const c = map.getCenter();
      bbox = [c.lng-0.0004, c.lat-0.0004, c.lng+0.0004, c.lat+0.0004];
    }
    const lat = (bbox[1] + bbox[3]) / 2;
    const mpdLng = 111320 * Math.cos(lat * Math.PI / 180);
    const mpdLat = 111000;

    const modW = 1.13;
    const modH = 2.2;

    const w = modW / mpdLng;
    const h = modH / mpdLat;

    const feats = [];
    for(let i=0;i<3;i++){
      for(let j=0;j<3;j++){
        const x = bbox[0] + i*w*1.3;
        const y = bbox[1] + j*h*1.3;
        feats.push(turf.bboxPolygon([x,y,x+w,y+h]));
      }
    }
    return { type:"FeatureCollection", features: feats };
  };

  if(!window.turf) return fallback();

  const isPoly = geo && (geo.type === "Polygon" || geo.type === "MultiPolygon");
  if(!isPoly) return fallback();

  let poly = turf.feature(geo);

  // setback
  let setback = 0;
  const sb = el("setbackDist");
  if(sb) setback = parseFloat(sb.value || "0") || 0;

  if(setback > 0){
    try{
      const shrunk = turf.buffer(poly, -setback, {units:"meters"});
      if(shrunk && shrunk.geometry) poly = shrunk;
      else return fallback();
    } catch(e){
      return fallback();
    }
  }

  // parameters from UI (if present)
  const modW = parseFloat(el("modWidth")?.value || "1.13") || 1.13;
  const modH = parseFloat(el("modHeight")?.value || "2.4") || 2.4;
  const angle = parseFloat(el("installAngle")?.value || "20") || 20;
  const rowSpacing = parseFloat(el("rowSpacing")?.value || "1.2") || 1.2;

  const projectedH = modH * Math.cos(angle * Math.PI / 180);
  const bbox = turf.bbox(poly);
  const centerLat = (bbox[1] + bbox[3]) / 2;
  const mpdLng = 111320 * Math.cos(centerLat * Math.PI / 180);
  const mpdLat = 111000;

  const dLng = (modW + 0.10) / mpdLng;
  const dLat = (projectedH + rowSpacing) / mpdLat;

  const feats = [];
  let guard = 0;
  const MAX = 45000;

  for(let x=bbox[0]; x<bbox[2]; x+=dLng){
    for(let y=bbox[1]; y<bbox[3]; y+=dLat){
      if(guard++ > MAX) break;
      const pt = turf.point([x + dLng/2, y + dLat/2]);
      try{
        if(turf.booleanPointInPolygon(pt, poly)){
          const w = modW / mpdLng;
          const h = projectedH / mpdLat;
          feats.push(turf.bboxPolygon([x, y, x+w, y+h]));
        }
      } catch(e) {}
    }
  }

  if(!feats.length) return fallback();
  return { type:"FeatureCollection", features: feats };
}

function ensureSolarTexture(){
  try{
    if(!window.map) return;
    const pane = map.getPanes()?.overlayPane;
    if(!pane) return;
    const svg = pane.querySelector("svg");
    if(!svg) return;
    if(svg.querySelector("#sp-solar-pattern")) return;

    const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
    const pattern = document.createElementNS("http://www.w3.org/2000/svg","pattern");
    pattern.setAttribute("id","sp-solar-pattern");
    pattern.setAttribute("patternUnits","userSpaceOnUse");
    pattern.setAttribute("width","12");
    pattern.setAttribute("height","12");

    const bg = document.createElementNS("http://www.w3.org/2000/svg","rect");
    bg.setAttribute("x","0"); bg.setAttribute("y","0");
    bg.setAttribute("width","12"); bg.setAttribute("height","12");
    bg.setAttribute("fill","#0b3a8a");
    bg.setAttribute("opacity","0.85");

    const line1 = document.createElementNS("http://www.w3.org/2000/svg","path");
    line1.setAttribute("d","M0 4 H12 M0 8 H12");
    line1.setAttribute("stroke","#93c5fd");
    line1.setAttribute("stroke-width","0.8");
    line1.setAttribute("opacity","0.35");

    const line2 = document.createElementNS("http://www.w3.org/2000/svg","path");
    line2.setAttribute("d","M4 0 V12 M8 0 V12");
    line2.setAttribute("stroke","#93c5fd");
    line2.setAttribute("stroke-width","0.8");
    line2.setAttribute("opacity","0.22");

    pattern.appendChild(bg);
    pattern.appendChild(line1);
    pattern.appendChild(line2);
    defs.appendChild(pattern);
    svg.insertBefore(defs, svg.firstChild);
  }catch(e){}
}

function applySolarTextureToLayer(layer){
  try{
    ensureSolarTexture();
    if(layer && layer._path){
      layer._path.setAttribute("fill", "url(#sp-solar-pattern)");
      layer._path.setAttribute("fill-opacity", "0.80");
      layer._path.setAttribute("stroke", "#0f172a");
      layer._path.setAttribute("stroke-opacity", "0.55");
    }
  }catch(e){}
}

function renderPanelsFC(fc){
  const style = {
    color: "#0f172a",
    weight: 1,
    fillColor: "#0b3a8a",
    fillOpacity: 0.80
  };
  return L.geoJSON(fc, {
    style,
    onEachFeature: (feature, layer)=>{
      // ì‹¤ì‚¬ ëŠë‚Œ(í…ìŠ¤ì²˜) ì ìš©
      setTimeout(()=>applySolarTextureToLayer(layer), 0);
    }
  });
}

function getFeatureId(feature){
  const props = feature?.properties || {};
  // Prefer PNU if exists
  if(props.pnu) return `pnu:${props.pnu}`;
  // else stable center-based id
  try{
    const c = turf.center(feature).geometry.coordinates;
    return `c:${c[1].toFixed(6)}:${c[0].toFixed(6)}`;
  } catch(e){
    return `t:${_hashSeed(JSON.stringify(props||{}))}`;
  }
}

window.drawPanels = function(geo){
  // public wrapper for debug; not used directly in UI
  const fc = applyCalibrationToFC(buildPanelsFCFromGeometry(geo));
  panelGroup.clearLayers();
  renderPanelsFC(fc).addTo(panelGroup);
  return fc.features.length;
};

function updateResultCardBasics(addr, panelCount){
  const rc = el("resultCard");
  if(rc) rc.classList.remove("hidden");

  if(el("analysisAddress")) el("analysisAddress").innerText = safeText(addr);
  if(el("analysisCount")) el("analysisCount").innerText = `${panelCount} ì¥`;

  // capacity
  const modPower = parseFloat(el("modPower")?.value || "640") || 640;
  const dcKw = (panelCount * modPower) / 1000;
  const acKw = dcKw / 1.15;
  if(el("analysisCapacity")) el("analysisCapacity").innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;

  // kepco (best-effort: backend if available, else deterministic sim)
  try{ if(typeof window.updateKepcoCapacity==="function") window.updateKepcoCapacity(addr, currentAnalysisData?.pnu); }catch(e){
    if(el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”";
  }
}

// Finance summary (kept simple; uses existing UI fields)
window.calculateFinance = function(panelCount, sunHoursOverride){
  try{

  const readNumber = (id, def=0) => {
    try{
      const v = (document.getElementById(id)?.value ?? "").toString().replace(/,/g,"").trim();
      const n = parseFloat(v);
      return (typeof n==="number" && isFinite(n)) ? n : def;
    }catch(e){ return def; }
  };

  const totalPanels = Math.max(0, parseInt(panelCount || 0, 10));
  const {lat} = getAnalysisLatLng();
  const solar = currentAnalysisData.solar_opt || {};

  // --- Assumptions (editable later) ---
  const degradation = 0.0055; // 0.55%/yr
  const opexInflation = 0.02; // 2%/yr
  const inverterReplaceYear = 13;
  const inverterReplacePct = 0.08; // of EPC

  // Priority: explicit override > solar_opt.sun_hours > heuristic
  const sun = (typeof sunHoursOverride === "number" && sunHoursOverride > 0)
    ? sunHoursOverride
    : ((typeof solar.sun_hours === "number" && solar.sun_hours > 0) ? solar.sun_hours : estimateSunHoursHeuristic(lat));

  // Orientation factor (data-source-free improvement)
  const oriFactor = orientationFactor(lat, solar.azimuth_deg, solar.tilt_deg);

  // --- System sizing ---
  // Use *DC capacity* as the base (module total), consistent with UI "ëª¨ë“ˆ W" ì…ë ¥ê°’
  const modPowerW = (parseFloat(el("modPower")?.value || "640") || 640); // W
  let dcKw = (totalPanels * modPowerW) / 1000.0;
  // If no panels drawn (land mode ë“±) but analysis already has capacity, use it
  try{
    if((!dcKw || dcKw<=0) && window.currentAnalysisData){
      const dcFrom = Number(currentAnalysisData.dc_kw || currentAnalysisData.dcKw || currentAnalysisData.capacity_dc_kw || 0);
      if(isFinite(dcFrom) && dcFrom>0){
        dcKw = dcFrom;
      }
    }
  }catch(e){}

  // If still empty, parse from UI text (e.g., '7.8 kW (DC: 9.0)')
  try{
    if((!dcKw || dcKw<=0) && document.getElementById('analysisCapacity')){
      const t = document.getElementById('analysisCapacity').textContent || '';
      const m = t.match(/DC\s*:\s*([0-9\.]+)/i);
      if(m && m[1]){
        const v = parseFloat(m[1]);
        if(isFinite(v) && v>0) dcKw = v;
      }
    }
  }catch(e){}

  // Keep AC for display only (common DC/AC ratio ~1.15)
  const acKw = dcKw / 1.15;

  // Energy model (Year1)
  // âœ… Fix: avoid double-derating. Standard: DCkW * sunHours * 365 * PR(0.90)
  const PR = 0.90; // ì¢…í•© íš¨ìœ¨(ì„±ëŠ¥ë¹„) - í•„ìš”ì‹œ UIë¡œ ë…¸ì¶œ ê°€ëŠ¥
  const annualKwhY1 = dcKw * sun * 365 * PR * oriFactor;

  // Prices (placeholders; can be set from UI later)
  const smp = (parseFloat(el("smpPrice")?.value || "120") || 120); // KRW/kWh
  const rec = (parseFloat(el("recPrice")?.value || "60") || 60);   // KRW/kWh-equivalent
  const effectivePrice = smp + rec;

  // CAPEX / OPEX
  const epcWonPerKw = (parseFloat(el("epcPerKw")?.value || "1400000") || 1400000); // won/kW
  const totalCost = dcKw * epcWonPerKw;

  // Depreciation (straight-line, configurable)
  const deprRateIn = readNumber("pfDeprRatePct", 0);
  const deprRatePct = (deprRateIn && deprRateIn > 0) ? deprRateIn : 6.25; // default ~16 years
  const depreciationAnnual = (totalCost > 0) ? (totalCost * (deprRatePct/100.0)) : 0;

  // If PF principal not provided (0), assume LTV 70% of CAPEX for convenience
    let principalInput = Math.max(0, readNumber("pfPrincipal", 0));
    const ltvPct = readNumber("pfLtvPct", 70);
  if(principalInput <= 0 && totalCost > 0){
    principalInput = totalCost * (ltvPct/100);
    try{ if(el("pfPrincipal")) el("pfPrincipal").value = formatNumber(Math.round(principalInput)); }catch(e){}
  }

// í† ì§€ ë³´ìœ /ì„ëŒ€ ë°©ì‹
const landPrice = (currentAnalysisData.land_estimate && typeof currentAnalysisData.land_estimate.land_price_won === "number")
  ? currentAnalysisData.land_estimate.land_price_won
  : 0;

const landMode = (el("landTenureMode")?.value || "BUY").toString();
const rentMonthly = Math.max(0, readNumber("landRentMonthly", 0));
const rentAnnual = rentMonthly * 12;

// í† ì§€ë¹„ ì ìš© ë°©ì‹
let landCapexEffective = (landMode === "BUY") ? landPrice : 0;
// í† ì§€êµ¬ë§¤ëŠ” ì‚¬ìš©ìê°€ ì´ì•¡ì„ ìˆ˜ë™ ì…ë ¥í•˜ë©´(>0) ê·¸ ê°’ì„ ìš°ì„  ì ìš©
const landBuyManual = readNumber("pfLandBuyPrice", 0);
if(landMode === "BUY" && landBuyManual && landBuyManual > 0){
  landCapexEffective = landBuyManual;
}
// í† ì§€êµ¬ë§¤(ìˆ˜ë™ 0)ì¼ ë•ŒëŠ” ìë™ ì¶”ì • í† ì§€ê°€ê²©ì„ ìš°ì„  ë°˜ì˜
if(landMode === "BUY" && (!landBuyManual || landBuyManual<=0)){
  try{
    const est = Number((currentAnalysisData?.land_estimate?.land_price_won ?? currentAnalysisData?.landEstimate?.land_price_won ?? currentAnalysisData?.landPriceWon ?? 0) || 0);
    if(isFinite(est) && est>0){
      landCapexEffective = est;
    }
  }catch(e){}
}
// ì„ëŒ€(í† ì§€/ì§€ë¶•)ë©´ ì„ëŒ€ë£Œë¥¼ ê¸°íƒ€ìš´ì˜ë¹„ì— ê°€ì‚°
const rentOpex = (landMode === "LAND_LEASE" || landMode === "ROOF_LEASE") ? rentAnnual : 0;

// OPEX(ìš´ì˜ë¹„): ê´€ë¦¬ë¹„ìš© 1/2 (ìˆ˜ë™ ì…ë ¥, 0ì´ë©´ ë¯¸ë°˜ì˜)
const maintIn = readNumber("pfMaintOpexAnnual", 0);
const otherIn = readNumber("pfOtherOpexAnnual", 0);
const maintOpex = Math.max(0, (typeof maintIn === "number" && isFinite(maintIn)) ? maintIn : 0);
const otherOpex = Math.max(0, (typeof otherIn === "number" && isFinite(otherIn)) ? otherIn : 0);
const baseOpex = maintOpex + otherOpex + rentOpex;


  // PF
    let principal = Math.max(0, readNumber("pfPrincipal", 0));
  const annualRatePct = (parseFloat(el("pfInterestRate")?.value || "6.5") || 6.5);
  const years = (parseInt(el("pfTenorYears")?.value || "10", 10) || 10);
  const dscrTarget = (parseFloat(el("pfDscrTarget")?.value || "1.20") || 1.20);
  const loanRatioPct = (parseFloat(el("pfLoanRatio")?.value || "90") || 90);
  const autoPrincipal = !!(el("pfAutoPrincipal") && el("pfAutoPrincipal").checked);
  const principalCap = totalCost * (loanRatioPct/100);

// âœ… PF ì›ê¸ˆ ìë™ì€ LTV(%)ê°€ ê¸°ì¤€, loanRatioPct(%)ëŠ” "ìµœëŒ€ ìº¡"ë§Œ
if(totalCost > 0){
  const byLtv = totalCost * (ltvPct/100);
  const capped = Math.min(byLtv, principalCap);

  if(autoPrincipal){
    principal = Math.round(capped);
    try{ el("pfPrincipal").value = formatNumber(Math.round(principal)); }catch(e){}
  }else{
    if(principal <= 0){
      principal = Math.round(byLtv);
      try{ el("pfPrincipal").value = formatNumber(Math.round(principal)); }catch(e){}
    }
  }
}
  // If user typed principal manually, turn off auto (UX)
  try{ if(el("pfPrincipal") && !autoPrincipal && principal<=0 && totalCost>0){} }catch(e){}

  // Local amortization (equal payment) -> yearly schedule
  function buildDebtSchedule(principalWon, annualRate, yearsTerm){
    const P = Math.max(0, principalWon);
    const PF_DAYCOUNT_FACTOR = (365/360); // ì‹œì¥ í‘œì¤€(ì€í–‰ ì‹¤ë¬´ì—ì„œ 365/360 ì‚¬ìš© ì¼€ì´ìŠ¤ ë°˜ì˜)
    const r = Math.max(0, (annualRate/100) * PF_DAYCOUNT_FACTOR / 12);
    const n = Math.max(1, yearsTerm*12);
    let monthly = 0;
    if(P > 0 && yearsTerm > 0){
      if(r <= 0) monthly = P / n;
      else monthly = P * r * Math.pow(1+r, n) / (Math.pow(1+r, n)-1);
    }

    let bal = P;
    const yearly = [];
    let totalInterest = 0;
    let totalPayment = 0;

    for(let y=1; y<=yearsTerm; y++){
      let yInterest=0, yPrincipal=0, yPay=0;
      for(let m=0; m<12; m++){
        if(bal <= 0) break;
        const interest = bal * r;
        let prin = monthly - interest;
        if(prin > bal) prin = bal;
        bal -= prin;
        yInterest += interest;
        yPrincipal += prin;
        yPay += (interest + prin);
      }
      totalInterest += yInterest;
      totalPayment += yPay;
      yearly.push({
        year: y,
        payment: yPay,
        interest: yInterest,
        principal: yPrincipal,
        balance: bal
      });
    }
    return {
      monthly,
      totalInterest,
      totalPayment,
      yearly
    };
  }

  const debt = buildDebtSchedule(principal, annualRatePct, years);


    const yearsHorizon = 25;

  // Cashflow series (year0 includes equity outflow)
  const equity0 = Math.max(0, Math.round(totalCost - principal));
  const cashflows_no_land = [-equity0];
  const cashflows_with_land = [-equity0];

  for(let y=1; y<=yearsHorizon; y++){
    // Degradation
    const kwh = annualKwhY1 * Math.pow(1 - degradation, (y-1));
    const revenue = kwh * effectivePrice;

    // OPEX inflation
    const opex = baseOpex * Math.pow(1 + opexInflation, (y-1));

    // Debt (only during PF term)
    const debtService = (y <= years && debt.yearly[y-1]) ? debt.yearly[y-1].payment : 0;

    // Inverter replacement CAPEX (one-off)
    const invReplace = (y === inverterReplaceYear) ? (totalCost * inverterReplacePct) : 0;

    // Cashflow
    const cf = revenue - opex - debtService - invReplace;

    cashflows_no_land.push(Math.round(cf));

    let cfLand = cf;
    if(y === 1 && typeof landPrice === "number" && landPrice > 0){
      // í† ì§€ êµ¬ë§¤ upfrontë¥¼ 1ë…„ì°¨ì— ë°˜ì˜(ë¦¬í¬íŠ¸ì—ì„œë„ ë™ì¼ ê°€ì •)
      cfLand -= landPrice;
    }
    cashflows_with_land.push(Math.round(cfLand));
  // 25ë…„ ë° PFê¸°ê°„ ëˆ„ì  ìˆœí˜„ê¸ˆ (í† ì§€ ì œì™¸/í¬í•¨)
  var totalCf25NoLand = 0;
  var totalCf25WithLand = 0;
  var totalCfPfNoLand = 0;
  for(let yy=1; yy<=yearsHorizon; yy++){
    const cfNoLand = (typeof cashflows_no_land[yy] === "number") ? cashflows_no_land[yy] : 0;
    const cfWithLand = (typeof cashflows_with_land[yy] === "number") ? cashflows_with_land[yy] : 0;
    totalCf25NoLand += cfNoLand;
    totalCf25WithLand += cfWithLand;
    if(yy <= years){
      totalCfPfNoLand += cfNoLand;
    }
  }

  }

  
  // DSCR (Debt Service Coverage Ratio) for PF term
  // CADS ~ revenue - opex (before debt service and capex)
  const dscr_years = [];
  const cads_years = [];
  const debt_service_years = [];

  for(let y=1; y<=yearsHorizon; y++){
    const kwh = annualKwhY1 * Math.pow(1 - degradation, (y-1));
    const revenue = kwh * effectivePrice;
    const opex = baseOpex * Math.pow(1 + opexInflation, (y-1));
    const invReplace = (y === inverterReplaceYear) ? (totalCost * inverterReplacePct) : 0;

    const cads = revenue - opex - invReplace; // before debt service
    const ds = (y <= years && debt.yearly[y-1]) ? debt.yearly[y-1].payment : 0;
    const dscr = (ds > 0) ? (cads / ds) : null;

    cads_years.push(Math.round(cads));
    debt_service_years.push(Math.round(ds));
    dscr_years.push((dscr === null || !isFinite(dscr)) ? null : +dscr.toFixed(3));
  }

  function dscrStats(arr){
    const v = arr.filter(x => typeof x === "number" && isFinite(x));
    if(!v.length) return {min:null, avg:null};
    const min = Math.min(...v);
    const avg = v.reduce((a,b)=>a+b,0)/v.length;
    return {min:+min.toFixed(3), avg:+avg.toFixed(3)};
  }
  
  // ---- Max Loan Sizing by Target DSCR (bisection) ----
  function maxLoanByDSCR(target){
    // Solve for principal such that min DSCR >= target
    let lo = 0, hi = Math.max(0, totalCost*0.9); // cap at 90% of CAPEX
    let best = 0;
    for(let it=0; it<30; it++){
      const mid = (lo+hi)/2;
      const debtMid = buildDebtSchedule(mid, annualRatePct, years);
      let minD = Infinity;
      for(let y=1; y<=years; y++){
        const kwh = annualKwhY1 * Math.pow(1 - degradation, (y-1));
        const revenue = kwh * effectivePrice;
        const opex = baseOpex * Math.pow(1 + opexInflation, (y-1));
        const invReplace = (y === inverterReplaceYear) ? (totalCost * inverterReplacePct) : 0;
        const cads = revenue - opex - invReplace;
        const ds = debtMid.yearly[y-1] ? debtMid.yearly[y-1].payment : 0;
        if(ds>0) minD = Math.min(minD, cads/ds);
      }
      if(minD >= target){
        best = mid; lo = mid;
      }else{
        hi = mid;
      }
    }
    return Math.round(best);
  }
const dscrStat = dscrStats(dscr_years);
  const dscr1 = (dscr_years && dscr_years.length>0) ? dscr_years[0] : null;
  const recLoanRaw = maxLoanByDSCR(dscrTarget);
  const recLoan = Math.round(Math.min(principalCap || Infinity, recLoanRaw || 0));

// Payback (Equity payback, simple cumulative, no discount)
// cashflows_no_land = [-equity0, year1..] (Equity CF)
function paybackYearsEquity(cfs, equity0){
  const eq0 = Math.max(0, equity0 || 0);
  if(eq0 <= 0) return 0;
  let cum = -eq0;
  for(let i=1;i<cfs.length;i++){
    cum += (cfs[i] || 0);
    if(cum >= 0) return i; // i=ë…„ì°¨
  }
  return null;
}
const payback = paybackYearsEquity(cashflows_no_land, equity0);

  // Update UI
  const annualRevenueWon = annualKwhY1 * effectivePrice;

  const opexYear1 = baseOpex;
  const ebitYear1 = annualRevenueWon - opexYear1;
  const interestYear1 = (debt.yearly && debt.yearly[0] && typeof debt.yearly[0].interest === "number") ? debt.yearly[0].interest : 0;
  const profitBeforeTaxYear1 = ebitYear1 - interestYear1;

    const totalProjectCost = totalCost + (typeof landCapexEffective === "number" ? landCapexEffective : 0);
  // -------------------------------
// PF ìš”ì•½(í™”ë©´ í‘œì‹œ): ê¸ˆì•¡ì€ "ë°±ë§Œì›" ë‹¨ìœ„ë¡œ í‘œê¸°
// -------------------------------
const capex_total_won = (typeof totalProjectCost === "number" && isFinite(totalProjectCost)) ? totalProjectCost : ((typeof totalCost === "number" && isFinite(totalCost)) ? totalCost : 0);
const capex_land_won  = (typeof landCapexEffective === "number" && isFinite(landCapexEffective)) ? landCapexEffective : 0;
const capex_epc_won   = Math.max(0, capex_total_won - capex_land_won);

// LTV ê°€ì´ë“œ(ê°„ë‹¨): êµ¬ì¡°/í† ì§€ë¹„ ë¹„ì¤‘ ê¸°ë°˜ ê¶Œì¥ì¹˜
let suggestedLtv = 70;
if(landMode === "OWN") suggestedLtv = 75;
if(landMode === "LAND_LEASE" || landMode === "ROOF_LEASE") suggestedLtv = 55;
if(landMode === "BUY"){
  const denom = Math.max(1, capex_total_won);
  const landRatio = capex_land_won / denom;
  if(landRatio >= 0.40) suggestedLtv -= 15;
  else if(landRatio >= 0.25) suggestedLtv -= 8;
  else if(landRatio <= 0.10) suggestedLtv += 5;
}
if(dscrTarget >= 1.30) suggestedLtv -= 5;
suggestedLtv = Math.max(35, Math.min(85, Math.round(suggestedLtv)));
try{
  if(document.getElementById("ltvRemark")){
    const modeLabel = (landMode==="OWN")?"í† ì§€ë³´ìœ ":(landMode==="BUY")?"í† ì§€êµ¬ë§¤":(landMode==="LAND_LEASE")?"í† ì§€ì„ëŒ€":"ì§€ë¶•ì„ëŒ€";
    document.getElementById("ltvRemark").textContent = `ì˜ˆìƒ ${suggestedLtv}% (${modeLabel})`;
  }
}catch(e){}

const capexSummary =
  `ì´ì‚¬ì—…ë¹„: ${formatMillionWon(capex_total_won)}
`+
  `- í† ì§€: ${formatMillionWon(capex_land_won)}
`+
  `- ì„¤ë¹„: ${formatMillionWon(capex_epc_won)}`;

const profitSummary =
  `ë§¤ì¶œ: ${formatMillionWon(annualRevenueWon)}
`+
  `ì˜ì—…ì´ìµ: ${formatMillionWon(ebitYear1)}
`+
  `ìœ ì§€ë³´ìˆ˜(ì—°): ${formatMillionWon(maintOpex)}
`+
  `ê¸°íƒ€ìš´ì˜ë¹„(ì—°): ${formatMillionWon(otherOpex)}`;

const cashflowSummary =
  `ì´ˆê¸°íˆ¬ì: ${formatMillionWon(equity0)}
`+
  `PFê¸°ê°„ CF: ${formatMillionWon(totalCfPfNoLand)}
`+
  `25ë…„ CF: ${formatMillionWon(totalCf25NoLand)}`;
  if(el("resCapacity")) el("resCapacity").innerText = `${dcKw.toFixed(1)} kW`;
  if(el("resAnnualKwh")) el("resAnnualKwh").innerText = `${Math.round(annualKwhY1).toLocaleString()} kWh`;
  if(el("resAnnualKwh2")) el("resAnnualKwh2").innerText = `${Math.round(annualKwhY1).toLocaleString()} kWh`;
  if(el("resAnnualRev")) el("resAnnualRev").innerText = `${Math.round(annualRevenueWon).toLocaleString()} ì›`;
  if(el("resAnnualRevenue")) el("resAnnualRevenue").innerText = `${Math.round(annualRevenueWon).toLocaleString()} ì›`;
  if(el("resTotalCost")) el("resTotalCost").innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
  if(el("resDebugFinance")) el("resDebugFinance").innerText = `dc=${dcKw.toFixed(1)}kW, sun=${sun.toFixed(2)}h, price=${effectivePrice.toLocaleString()}ì›/kWh`;
  if(el("resMonthlyDebt")) el("resMonthlyDebt").innerText = `${Math.round(debt.monthly).toLocaleString()} ì›`;
  if(el("resPfMonthly")) el("resPfMonthly").innerText = `${Math.round(debt.monthly).toLocaleString()} ì›`;
  if(el("resTotalInterest")) el("resTotalInterest").innerText = `${Math.round(debt.totalInterest).toLocaleString()} ì›`;
  if(el("resDscr")) el("resDscr").innerText = (dscr1===null||!isFinite(dscr1)) ? "-" : dscr1.toFixed(2);
  if(el("resRecLoan")) el("resRecLoan").innerText = recLoan>0 ? `${recLoan.toLocaleString()} ì›` : "-";
  if(el("resPfTotalInterest")) el("resPfTotalInterest").innerText = `${Math.round(debt.totalInterest).toLocaleString()} ì›`;
  if(el("resPfPayback")) el("resPfPayback").innerText = (payback===null) ? "> 25ë…„" : `${Number(payback).toFixed(1)} ë…„`;
  if(el("resCfPfTerm")) el("resCfPfTerm").innerText = `${Math.round(totalCfPfNoLand).toLocaleString()} ì›`;
  if(el("resCf25Y")) el("resCf25Y").innerText = `${Math.round(totalCf25NoLand).toLocaleString()} ì›`;

  // --- PF í‘œ(ì…€) ì±„ìš°ê¸°: ì²œì› ë‹¨ìœ„ ---
  const LIFE_YEARS = 15; // ë‚´ìš©ì—°ìˆ˜(í‘œê¸°ìš©)
  const setK = (id, won)=>{
    try{
      const node = document.getElementById(id);
      if(!node) return;
      node.textContent = formatMillionWon((typeof won==="number" && isFinite(won)) ? won : 0);
    }catch(e){}
  };

  // ì‚¬ì—…ë¹„
  setK("pf_capex_land_k", capex_land_won);
  setK("pf_capex_epc_k", capex_epc_won);
  setK("pf_capex_other_k", 0);
  setK("pf_capex_total_k", capex_total_won);

  // ëŒ€ì¶œ(í‘œê¸°ìš©)
  setK("pf_loan_possible_k", (typeof recLoan==="number" && isFinite(recLoan)) ? recLoan : 0);
  setK("pf_loan_amount_k", (typeof principal==="number" && isFinite(principal)) ? principal : 0);
  try {
    var hintEl = el("pfLoanAmountHint");
    if (hintEl) hintEl.textContent = formatMillionWon((typeof principal==="number" && isFinite(principal)) ? principal : 0);
  } catch(e) {}


  
  // ì†ìµ(1ë…„ì°¨): 25ë…„ / 15ë…„ / ì—°ê°„ / ì›”ê°„ (ì²¨ë¶€ ì—‘ì…€ í‘œ êµ¬ì¡°ì™€ ë™ì¼)
  const YEARS_25 = 25;
  const safeAnnual = (v)=> (typeof v === "number" && isFinite(v)) ? v : 0;

  const fillProfitRow = (prefix, annualVal)=>{
    const a = safeAnnual(annualVal);
    // 25ë…„ ëˆ„ì 
    setK(prefix + "_25_k", a * YEARS_25);
    // 15ë…„ ëˆ„ì  (ê¸°ì¡´ ì´(15ë…„)ê³¼ ë™ì¼)
    setK(prefix + "_t_k", a * LIFE_YEARS);
    // ì—°ê°„ / ì›”ê°„
    setK(prefix + "_a_k", a);
    setK(prefix + "_m_k", a / 12);
  };

  // ë§¤ì¶œ / ë¹„ìš© / ì´ìµ í•­ëª©
  fillProfitRow("pf_rev", annualRevenueWon);
  fillProfitRow("pf_maint", maintOpex);
  fillProfitRow("pf_otheropex", otherOpex);

  // ê°ê°€ìƒê°ë¹„(ì¶”ì •): ì„¤ë¹„ë¹„/15ë…„ (í‘œê¸°ìš©)
  const deprA = (capex_epc_won>0) ? (capex_epc_won / LIFE_YEARS) : 0;
  fillProfitRow("pf_depr", deprA);

  // ì˜ì—…ì´ìµ/ì´ì/ì„¸ì „ì´ìµ: ê¸°ì¡´ ë¡œì§ ê°’ ê¸°ë°˜(í‘œê¸°ìš©)
  fillProfitRow("pf_ebit", ebitYear1);
  fillProfitRow("pf_int", interestYear1);
  fillProfitRow("pf_pbt", profitBeforeTaxYear1);
// --- í˜„ê¸ˆíë¦„(í™œë™) ìš”ì•½ ë°•ìŠ¤: PFê¸°ê°„/25ë…„ (ì²œì› ë‹¨ìœ„ í‘œê¸°) ---
  // âœ… ì²¨ë¶€ Excel/ìº¡ì²˜ ë¡œì§ê³¼ ë™ì¼:
  //  - íˆ¬ìí™œë™: ì„¤ë¹„ë¹„(EPC) 1íšŒ(-)  (PFê¸°ê°„/25ë…„ ë™ì¼)
  //  - ì¬ë¬´í™œë™: 0 (í‘œê¸°ìš©)
  //  - ìˆœí˜„ê¸ˆíë¦„: (PFëª¨ë¸ì—ì„œ ê³„ì‚°ëœ) ëˆ„ì  ìˆœí˜„ê¸ˆíë¦„ í•©ê³„
  //      * PFê¸°ê°„(15ë…„): finance.roi25y.total_cf_pfterm_no_land
  //      * 25ë…„: finance.roi25y.total_cf_25y_no_land
  //  - ì˜ì—…í™œë™: ìˆœí˜„ê¸ˆíë¦„ - íˆ¬ìí™œë™ - ì¬ë¬´í™œë™  (= ìˆœí˜„ê¸ˆ + ì„¤ë¹„ë¹„)
  const pfYears = 15; // í‘œì˜ ì´(15ë…„) ê¸°ì¤€(ê¸°ì¡´ UIì™€ ë™ì¼)

  const finObj = currentAnalysisData?.finance || {};
  const roi = finObj?.roi25y || {};

  // ëˆ„ì  ìˆœí˜„ê¸ˆíë¦„(=Net CF) (ì—†ìœ¼ë©´ ê¸°ì¡´ ì¶”ì •ì¹˜ë¡œ fallback)
  const net_pf_won = (typeof roi.total_cf_pfterm_no_land === "number" && isFinite(roi.total_cf_pfterm_no_land))
    ? roi.total_cf_pfterm_no_land
    : ((isFinite(profitBeforeTaxYear1) ? profitBeforeTaxYear1 : 0) * pfYears + (-Math.max(0,(isFinite(capex_epc_won)?capex_epc_won:0))));

  const net_25_won = (typeof roi.total_cf_25y_no_land === "number" && isFinite(roi.total_cf_25y_no_land))
    ? roi.total_cf_25y_no_land
    : ((isFinite(profitBeforeTaxYear1) ? profitBeforeTaxYear1 : 0) * 25 + (-Math.max(0,(isFinite(capex_epc_won)?capex_epc_won:0))));

  // íˆ¬ìí™œë™: ì„¤ë¹„ë¹„ 1íšŒ(-)
  const inv_once_won = -Math.max(0, (isFinite(capex_epc_won) ? capex_epc_won : 0));
  const inv_pf_won = inv_once_won;
  const inv_25_won = inv_once_won;

  // ì¬ë¬´í™œë™: 0 (í‘œê¸°ìš©)
  const fin_pf_won = 0;
  const fin_25_won = 0;

  // ì˜ì—…í™œë™: ìˆœí˜„ê¸ˆíë¦„ì—ì„œ íˆ¬ì/ì¬ë¬´ë¥¼ ì—­ì‚°
  const op_pf_won = net_pf_won - inv_pf_won - fin_pf_won;
  const op_25_won = net_25_won - inv_25_won - fin_25_won;

  const setK2 = (id, won)=>{
    try{
      const node = document.getElementById(id);
      if(!node) return;
      node.textContent = formatMillionWon((typeof won==="number" && isFinite(won)) ? won : 0);
    }catch(e){}
  };
  setK2("cf_op_pf_k", op_pf_won);
  setK2("cf_op_25_k", op_25_won);
  setK2("cf_inv_pf_k", inv_pf_won);
  setK2("cf_inv_25_k", inv_25_won);
  setK2("cf_fin_pf_k", fin_pf_won);
  setK2("cf_fin_25_k", fin_25_won);
  setK2("cf_net_pf_k", net_pf_won);
  setK2("cf_net_25_k", net_25_won);

  
  // ì²¨ë¶€ ì—‘ì…€ í‘œ êµ¬ì¡°ìš©: í˜„ê¸ˆíë¦„(15ë…„/25ë…„) ìƒì„¸ í–‰
  const Y15 = pfYears;
  const Y25 = 25;
  const safeNum2 = (v)=> (typeof v === "number" && isFinite(v)) ? v : 0;
  const ebitAnnual = safeNum2(ebitYear1);
  const deprAnnual = safeNum2(typeof deprA === "number" ? deprA : ((capex_epc_won>0 && LIFE_YEARS>0) ? (capex_epc_won / LIFE_YEARS) : 0));
  const intAnnual = safeNum2(interestYear1);
  const capexEpcSafe = Math.max(0, safeNum2(capex_epc_won));
  const principalSafe = safeNum2(principal);

  // ì˜ì—…í™œë™ / ìˆœí˜„ê¸ˆíë¦„
  setK2("cf_tbl_op_pf_k", op_pf_won);
  setK2("cf_tbl_op_25_k", op_25_won);

  // ì˜ì—…ì´ìµ / ê°ê°€ìƒê° / ì´ìë¹„ìš©
  setK2("cf_tbl_ebit_pf_k", ebitAnnual * Y15);
  setK2("cf_tbl_ebit_25_k", ebitAnnual * Y25);
  setK2("cf_tbl_depr_pf_k", deprAnnual * Y15);
  setK2("cf_tbl_depr_25_k", deprAnnual * Y25);
  setK2("cf_tbl_int_pf_k", intAnnual * Y15);
  setK2("cf_tbl_int_25_k", intAnnual * Y25);

  // íˆ¬ì / ì´ì‚¬ì—…ë¹„ / ì¬ë¬´í™œë™
  setK2("cf_tbl_inv_pf_k", inv_pf_won);
  setK2("cf_tbl_inv_25_k", inv_25_won);
  setK2("cf_tbl_capex_pf_k", capexEpcSafe);
  setK2("cf_tbl_capex_25_k", capexEpcSafe);
  setK2("cf_tbl_fin_pf_k", fin_pf_won);
  setK2("cf_tbl_fin_25_k", fin_25_won);

  // ëŒ€ì¶œ ì‹¤í–‰/ìƒí™˜
  setK2("cf_tbl_loan_draw_pf_k", principalSafe);
  setK2("cf_tbl_loan_draw_25_k", principalSafe);
  setK2("cf_tbl_loan_repay_pf_k", principalSafe);
  setK2("cf_tbl_loan_repay_25_k", principalSafe);

  // ìˆœí˜„ê¸ˆíë¦„ (PFê¸°ê°„ / 25ë…„)
  setK2("cf_tbl_net_pf_k", net_pf_won);
  setK2("cf_tbl_net_25_k", net_25_won);

// legacy(ìˆ¨ê¹€) í…ìŠ¤íŠ¸ë„ ìœ ì§€(ë””ë²„ê¹…/í˜¸í™˜)
  if(el("resPfCapexSummary")) el("resPfCapexSummary").innerText = capexSummary;
  if(el("resPfProfitSummary")) el("resPfProfitSummary").innerText = profitSummary;
  if(el("resPfCashflowSummary")) el("resPfCashflowSummary").innerText = cashflowSummary;

  try{ if(typeof updateLandPriceUI==='function') updateLandPriceUI(landPrice); }catch(e){}
  try{ if(typeof updateSolarOptUI==='function') updateSolarOptUI(currentAnalysisData.solar_opt); }catch(e){}

  // Store for report
  currentAnalysisData.finance = {
    totalPanels,
    dcKw,
    acKw,
    annualKwhY1,
    annualRevenueWon: Math.round(annualRevenueWon),
    totalCostWon: Math.round(totalCost),
    monthlyDebtWon: Math.round(debt.monthly),
    totalInterestWon: Math.round(debt.totalInterest),
    paybackYears: payback,
    summary: {
      capex_total_won: Math.round(capex_total_won),
      capex_land_won: Math.round(typeof landPrice === "number" ? landPrice : 0),
      capex_epc_won: Math.round(capex_epc_won),
      annual_revenue_y1_won: Math.round(annualRevenueWon),
      annual_ebit_y1_won: Math.round(ebitYear1),
      annual_maint_opex_won: Math.round(maintOpex),
      annual_other_opex_won: Math.round(otherOpex),
      annual_opex_total_won: Math.round(baseOpex),
      annual_profit_before_tax_y1_won: Math.round(profitBeforeTaxYear1),
      equity0_won: equity0,
      cf_pfterm_total_won: Math.round(totalCfPfNoLand),
      cf_25y_total_won: Math.round(totalCf25NoLand)
    },
    assumptions: {
      sunHours: sun,
      maintOpexWonPerYear: Math.round(maintOpex),
      otherOpexWonPerYear: Math.round(otherOpex),
      oriFactor: +oriFactor.toFixed(3),
      azimuthDeg: solar.azimuth_deg ?? null,
      tiltDeg: solar.tilt_deg ?? null,
      degradation,
      opexInflation,
      inverterReplaceYear,
      inverterReplacePct,
      smp,
      rec,
      epcWonPerKw
    },
    roi25y: {
      max_loan_by_dscr_120: maxLoanByDSCR(1.20),
      max_loan_by_dscr_130: maxLoanByDSCR(1.30),
      cashflows_no_land,
      cashflows_with_land,
      land_price_won: landPrice,
      dscr_years,
      cads_years,
      debt_service_years,
      dscr_min: dscrStat.min,
      dscr_avg: dscrStat.avg,
      total_cf_25y_no_land: Math.round(totalCf25NoLand),
      total_cf_25y_with_land: Math.round(totalCf25WithLand),
      total_cf_pfterm_no_land: Math.round(totalCfPfNoLand)
    }
  };

  }catch(e){
    console.error('calculateFinance failed', e);
    try{ showToast('ì¬ê³„ì‚° ì˜¤ë¥˜: ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”'); }catch(_){ }
  }
}// Finance recalculation helper (robust against timing issues)

window.requestFinanceRecalc = function(){
  try{
    const txt = (document.getElementById("resPanels")?.innerText || "").replace(/[^0-9]/g,"");
    const fallback = txt ? parseInt(txt,10) : 0;
    const pc0 = getTotalPanelCount();
    const pc = (pc0 && pc0>0) ? pc0 : fallback;
    if(pc<=0) return;
    window._lastNonZeroPanelCount = pc;
    updateResultCardBasics(currentAnalysisData?.address || "í™•ì¸ í•„ìš”", pc);
    window.calculateFinance(pc);
  }catch(e){}
};


// Auto-recalc when panel count changes (lightweight)
;;;

// Analyze feature (F-6)
window.analyzeFeature = analyzeFeature;
function analyzeFeature(feature, focusTab){
  if(FEATURE_LEVEL < 3){
    showToast("feat<3: íŒ¨ë„ ìƒì„± ë¹„í™œì„±");
    return;
  }
  if(!feature?.geometry){
    showToast("ì§€ì˜¤ë©”íŠ¸ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  if(focusTab) window.switchTab("analysis");

  // Determine address string (F-23 safe)
  const props = feature.properties || {};
  const addr = props.road_nm_ad || props.jibun_addr || props.addr || (props.pnu ? `PNU:${props.pnu}` : "") || "í™•ì¸ í•„ìš”";
  currentAnalysisData.pnu = props.pnu || null;

  const featureId = getFeatureId(feature);

  // (UI ìš”ì²­) í† ê¸€: ë‹¨ì¼ ì„ íƒ ëª¨ë“œì—ì„œ ê°™ì€ êµ¬ì—­ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ íŒ¨ë„/ê²°ê³¼ë§Œ ì§€ì›€
  if(!isMultiSelectMode){
    try{
      if(selectedFeatures && selectedFeatures.size === 1 && window.map && typeof window.map.distance === "function"){
        const only = selectedFeatures.values().next().value;
        if(only && only.feature){
          const cPrev = L.geoJSON(only.feature).getBounds().getCenter();
          const cCur  = L.geoJSON(feature).getBounds().getCenter();
          const distM = window.map.distance(cPrev, cCur);
          if(distM <= 2){
            clearAnalysisOnly();
            return;
          }
        }
      }
    }catch(_e){}
  }

  // In multi-select: toggle remove
  if(isMultiSelectMode && selectedFeatures.has(featureId)){
    const stored = selectedFeatures.get(featureId);
    if(stored?.layer) panelGroup.removeLayer(stored.layer);
    selectedFeatures.delete(featureId);
    // recompute totals
    recomputeTotalsAfterSelectionChange();
    return;
  }

  // If not multi-select, reset selection and calibration
  if(!isMultiSelectMode){
    panelGroup.clearLayers();
    selectedFeatures.clear();
    resetCalibrationInternal(false);
  }

  currentAnalysisFeature = feature;

  // Build panels (base -> apply calibration)
  const baseFC = buildPanelsFCFromGeometry(feature.geometry);
  const fc = applyCalibrationToFC(baseFC);

  const layer = renderPanelsFC(fc);
  layer.addTo(panelGroup);

  const count = fc.features.length;

  selectedFeatures.set(featureId, { feature, layer, count, panelsFC: fc, basePanelsFC: baseFC, address: addr });

  // Save lat/lng + area for F-27/28
  try{
    const c = L.geoJSON(feature).getBounds().getCenter();
    currentAnalysisData.lat = c.lat;
    currentAnalysisData.lng = c.lng;
  }catch(e){
    try{
      const c2 = map.getCenter();
      currentAnalysisData.lat = c2.lat;
      currentAnalysisData.lng = c2.lng;
    }catch(e2){}
  }

  try{
    const g = feature?.geometry;
    if(g && g.type === "Polygon"){
      currentAnalysisData.area_m2 = polygonAreaM2(g);
    }else{
      currentAnalysisData.area_m2 = null;
    }
  }catch(e){
    currentAnalysisData.area_m2 = null;
  }

    const pc = getTotalPanelCount();
  updateResultCardBasics(addr, pc);
    // âœ… PF ê³„ì‚°ì€ ê²°ê³¼ í‘œì‹œ ì§í›„ ë°˜ë“œì‹œ 1íšŒ ì‹¤í–‰ (ìµœê·¼ setTimeout ê²½ë¡œì—ì„œ ëˆ„ë½ë˜ëŠ” ì¼€ì´ìŠ¤ ë°©ì§€)
  try{
    const sunH = (currentAnalysisData.solar_opt?.sun_hours ?? currentAnalysisData.ai_analysis?.sun_hours);
    window.calculateFinance(pc, (typeof sunH === "number" && isFinite(sunH) && sunH > 0) ? sunH : undefined);
  }catch(e){
    try{ if(el("resDebugFinance")) el("resDebugFinance").innerText = `PF ê³„ì‚° ì‹¤íŒ¨: ${safeText(e.message,"")}`; }catch(_e){}
    console.warn("calculateFinance invoke failed", e);
  }
  try{ window.refreshSolarLandEstimates(); }catch(e){}

// âœ… í•œì „ ìš©ëŸ‰(ì¹´ë“œìš©) ì¡°íšŒ: PNU ê¸°ë°˜
(async ()=>{
  try{
    if(!BACKEND_URL) return;
    const pnu = currentAnalysisData.pnu || "";
    if(!pnu) return;
    const r = await fetch(`${BACKEND_URL}/api/infra/kepco?pnu=${encodeURIComponent(pnu)}`, {credentials:"include"});
    const j = await r.json().catch(()=>null);
    const kcEl = el("kepcoCapacity");
      if(!kcEl) return;
      const cap = (j && j.ok) ? j.kepco_capacity : null;
      if(!cap || String(cap).includes("ì¡°íšŒ ë¶ˆê°€")){
        kcEl.innerText = "ì¡°íšŒ ë¶ˆê°€ (í•œì „ ë¬¸ì˜ ìš”ë§)";
        kcEl.classList.add("text-red-400");
      }else{
        kcEl.innerText = String(cap);
        kcEl.classList.remove("text-red-400");
      }
  }catch(e){}
})();


  // âœ… ì‚¬ìš©ì ë¯¸ì„¸ë³´ì • í•¸ë“¤ í‘œì‹œ
  try{ ensurePanelDragHandle(feature); }catch(e){}

  // Save analysis data basics
  currentAnalysisData.address = addr;
  currentAnalysisData.mode = (scanTarget === "land") ? "land" : "roof";
  currentAnalysisData.updated_at = new Date().toISOString();

  // AI analysis (F-15/16)
  if(FEATURE_LEVEL >= 5){
    try{
      const center = turf.center(feature).geometry.coordinates;
      fetchAIData(center[1], center[0], addr);
    }catch(e){
      fetchAIData(null, null, addr);
    }
  }
}

function getTotalPanelCount(){
  let sum = 0;
  for(const v of selectedFeatures.values()) sum += (v.count || 0);
  return sum;
}

function recomputeTotalsAfterSelectionChange(){
  const total = getTotalPanelCount();
  if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
  window.calculateFinance(total, (currentAnalysisData.solar_opt?.sun_hours ?? currentAnalysisData.ai_analysis?.sun_hours));
  showToast(`ì„ íƒ: ${selectedFeatures.size}ê°œ / íŒ¨ë„ ${total}ì¥`);
}

// Recalculate panels after parameter changes (F-9)

// -------------------------------
// ì…ë ¥ ì½¤ë§ˆ í¬ë§·(ì› ë‹¨ìœ„) & í† ì§€/ì„ëŒ€ UI
// -------------------------------
(function(){
  function fmtComma(n){
    const x = Math.round(Number(n)||0);
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function uncomma(s){ return (s||"").toString().replace(/,/g,"").trim(); }
  function bindCommaInput(id){
    const el = document.getElementById(id);
    if(!el) return;
    const normalize = (v) => {
      const s = String(v ?? "").replace(/[^0-9]/g, "");
      return s === "" ? "0" : s;
    };
    const formatNow = () => {
      const raw = normalize(el.value);
      el.value = fmtComma(raw);
      try{ el.setSelectionRange(el.value.length, el.value.length); }catch(e){}
    };
    el.addEventListener("focus", ()=>{ el.value = normalize(el.value); });
    el.addEventListener("input", ()=>{ formatNow(); });
    el.addEventListener("blur", ()=>{ formatNow(); });
    // initial
    formatNow();
  }
  window.updateTenureUi = function(){
    const mode = (document.getElementById("landTenureMode")?.value || "BUY").toString();
    const rentWrap = document.getElementById("landRentWrap");
    const buyWrap = document.getElementById("landBuyWrap");
    if(rentWrap){
      const showRent = (mode==="LAND_LEASE" || mode==="ROOF_LEASE");
      rentWrap.classList.toggle("hidden", !showRent);
    }
    if(buyWrap){
      const showBuy = (mode==="BUY");
      buyWrap.classList.toggle("hidden", !showBuy);
    }
  };
  window.addEventListener("DOMContentLoaded", ()=>{
    // 0 ì•„ë˜ ì…ë ¥ ë°©ì§€(í˜„ì‹¤ê°’)
    document.querySelectorAll('input[type="number"]').forEach(inp=>{
      if(!inp.hasAttribute("min")) inp.setAttribute("min","0");
      inp.addEventListener("input", ()=>{
        const v = parseFloat(inp.value);
        if(isFinite(v) && v < 0){ inp.value = "0"; }
      });
    });

    ["pfPrincipal","pfMaintOpexAnnual","pfOtherOpexAnnual","landRentMonthly","pfLandBuyPrice"].forEach(bindCommaInput);
    window.updateTenureUi && window.updateTenureUi();
  });
})();

window.reCalculate = function(){
  if(FEATURE_LEVEL < 3) return;

  if(!selectedFeatures.size){
    showToast("ì„ íƒëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  // For simplicity: recompute all selected features with current parameters.
  panelGroup.clearLayers();

  const updated = new Map();
  for(const [id, v] of selectedFeatures.entries()){
    const baseFC = buildPanelsFCFromGeometry(v.feature.geometry);
    // Only apply calibration to the currently focused feature
    const fc = (currentAnalysisFeature && id === getFeatureId(currentAnalysisFeature))
      ? applyCalibrationToFC(baseFC)
      : baseFC;

    const layer = renderPanelsFC(fc);
    layer.addTo(panelGroup);

    updated.set(id, { ...v, layer, count: fc.features.length, panelsFC: fc, basePanelsFC: baseFC });
  }
  selectedFeatures = updated;

  const total = getTotalPanelCount();
  if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
  window.calculateFinance(total, (currentAnalysisData.solar_opt?.sun_hours ?? currentAnalysisData.ai_analysis?.sun_hours));
  showToast("ì¬ê³„ì‚° ì™„ë£Œ");
};

// -----------------------------
// D-pad calibration (F-10)
// -----------------------------
function resetCalibrationInternal(recalc=true){
  calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 };
  if(recalc) window.reCalculate();
}

window.resetCalibration = function(){
  resetCalibrationInternal(true);
};

window.applyCalibration = function(dx, dy, drot=0){
  if(FEATURE_LEVEL < 3) return;
  calibration.dx_m += (dx || 0);
  calibration.dy_m += (dy || 0);
  calibration.rot_deg += (drot || 0);
  window.reCalculate();
};

window.dpadHoldStart = function(dir){
  if(FEATURE_LEVEL < 3) return;
  window.dpadHoldStop();

  const step = 0.2; // meters
  const tick = () => {
    if(dir === "up") window.applyCalibration(0,  step);
    if(dir === "down") window.applyCalibration(0, -step);
    if(dir === "left") window.applyCalibration(-step, 0);
    if(dir === "right") window.applyCalibration(step, 0);
    if(dir === "rotL") window.applyCalibration(0, 0, -2);
    if(dir === "rotR") window.applyCalibration(0, 0,  2);
  };

  tick();
  dpadHoldTimer = setInterval(tick, 120);
};

window.dpadHoldStop = function(){
  if(dpadHoldTimer){
    clearInterval(dpadHoldTimer);
    dpadHoldTimer = null;
  }
};

// -----------------------------
// F-11~F-14: Scan mission + auto scan box
// -----------------------------
const REGION_PLANS = {
  "ansan_ind":     { name:"ì•ˆì‚° ë°˜ì›”/ì‹œí™”", steps: 120 },
  "incheon_ind":   { name:"ì¸ì²œ ë‚¨ë™ê³µë‹¨", steps: 120 },
  "hwaseong_ind":  { name:"í™”ì„± ì¼ë°˜ì‚°ë‹¨", steps: 140 },
  "pyeongtaek_ind":{ name:"í‰íƒ í¬ìŠ¹ê³µë‹¨", steps: 140 },
  "cheonan_ind":   { name:"ì²œì•ˆ ì¼ë°˜ì‚°ë‹¨", steps: 140 },
  "osan_ind":      { name:"ì˜¤ì°½ ê³¼í•™ì‚°ë‹¨", steps: 140 },
  "daejeon_ind":   { name:"ëŒ€ì „ ëŒ€ë•", steps: 140 },
  "gumi_ind":      { name:"êµ¬ë¯¸ êµ­ê°€ì‚°ë‹¨", steps: 160 },
  "changwon_ind":  { name:"ì°½ì› êµ­ê°€ì‚°ë‹¨", steps: 160 },
  "ulsan_ind":     { name:"ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚°", steps: 160 },
  "daegu_ind":     { name:"ëŒ€êµ¬ ì„±ì„œ", steps: 160 },
  "pohang_ind":    { name:"í¬í•­ ì² ê°•", steps: 160 },
  "seoul":         { name:"ì„œìš¸", steps: 260 },
  "gyeonggi":      { name:"ê²½ê¸°", steps: 420 },
  "jeonnam":       { name:"ì „ë‚¨", steps: 360 },
  "jeonbuk":       { name:"ì „ë¶", steps: 320 },
  "gyeongnam":     { name:"ê²½ë‚¨", steps: 360 },
  "jeju":          { name:"ì œì£¼", steps: 240 },
};

let selectedRegionKey = "";

window.setRegion = function(){
  const sel = el("regionSelect");
  selectedRegionKey = (sel && sel.value) ? sel.value : "";
  window.updateEstimatedTime();
};

window.updateEstimatedTime = function(){
  const delaySel = el("scanDelay");
  missionDelayMs = parseInt(delaySel?.value || "6000", 10);

  const plan = REGION_PLANS[selectedRegionKey];
  missionTotalSteps = plan ? plan.steps : 20;

  // F-11: ì˜ˆìƒ ì´ ì†Œìš”ì‹œê°„ = steps * delay (ì¶”í›„ region bbox ê¸°ë°˜ ì •ë°€í™” ê°€ëŠ¥)
  missionTotalMs = missionTotalSteps * missionDelayMs;
  missionRemainingMs = missionTotalMs;

  if(el("timerRemaining")) el("timerRemaining").innerText = fmtHHMMSS(missionRemainingMs);
  if(el("timerTotal")) el("timerTotal").innerText = `ì´ ${fmtHHMMSS(missionTotalMs)}`;
  if(el("progressCount")) el("progressCount").innerText = `0 / ${missionTotalSteps}`;
  if(el("totalProgressBar")) el("totalProgressBar").style.width = "0%";
};

function stopMissionTimer(){
  if(missionTimerInterval){
    clearInterval(missionTimerInterval);
    missionTimerInterval = null;
  }
}

function startMissionTimer(){
  stopMissionTimer();
  missionLastTick = Date.now();

  missionTimerInterval = setInterval(()=>{
    if(!missionRunning){ stopMissionTimer(); return; }

    const now = Date.now();

    // F-12: ì¼ì‹œì •ì§€ ì‹œ ì‹œê°„ ê°ì†Œ X (resume ì‹œ ê¸°ì¤€ ì¬ì„¤ì •)
    if(missionPaused){
      missionLastTick = now;
      return;
    }

    const dt = Math.max(0, now - missionLastTick);
    missionLastTick = now;

    missionRemainingMs = Math.max(0, missionRemainingMs - dt);

    if(el("timerRemaining")) el("timerRemaining").innerText = fmtHHMMSS(missionRemainingMs);
    if(el("timerTotal")) el("timerTotal").innerText = `ì´ ${fmtHHMMSS(missionTotalMs)}`;

    if(missionTotalMs > 0 && el("totalProgressBar")){
      const done = Math.min(1, (missionTotalMs - missionRemainingMs) / missionTotalMs);
      // Progress barëŠ” "ì „ìˆ˜ ìŠ¤ìº” ì§„í–‰ë¥ "ë¡œ ìœ ì§€í•˜ë˜, step ê¸°ë°˜ ì—…ë°ì´íŠ¸ê°€ ìš°ì„ 
      // ì—¬ê¸°ì„œëŠ” ìµœì†Œí•œ ë‚¨ì€ì‹œê°„ ê¸°ë°˜ìœ¼ë¡œë„ ìì—°ìŠ¤ëŸ½ê²Œ ì›€ì§ì´ë„ë¡ ë³´ì •
      const w = (done * 100);
      const cur = parseFloat(el("totalProgressBar").style.width || "0");
      if(!isNaN(cur) && w > cur){
        el("totalProgressBar").style.width = `${w}%`;
      }
    }

    if(missionRemainingMs <= 0) stopMissionTimer();
  }, 250);
}

window.startMission = async function(){
  if(FEATURE_LEVEL < 4){
    showToast("feat<4: ì „ìˆ˜ ìŠ¤ìº” ë¹„í™œì„±");
    return;
  }
  if(!map) return;

  // Toggle pause/resume
  if(missionRunning){
    missionPaused = !missionPaused;
    const btn = el("startBtn");
    if(btn) btn.innerText = missionPaused ? "â–¶ ì¬ê°œ" : "â¸ ì¼ì‹œì •ì§€";
    showToast(missionPaused ? "ì¼ì‹œì •ì§€" : "ì¬ê°œ");
    return;
  }

  // Start mission
  missionRunning = true;
  missionPaused = false;
  missionStop = false;
  missionDoneSteps = 0;

  window.updateEstimatedTime();
  // Timer uses missionRemainingMs (pause-aware)
  startMissionTimer();

  const btn = el("startBtn");
  if(btn) btn.innerText = "â¸ ì¼ì‹œì •ì§€";

  const autoFollow = !!(el("autoFollow")?.checked);
  const bounds = map.getBounds();

  for(let i=0;i<missionTotalSteps;i++){
    if(missionStop) break;
    while(missionPaused){
      await new Promise(r=>setTimeout(r, 200));
      if(missionStop) break;
    }
    if(missionStop) break;

    const t = (missionTotalSteps <= 1) ? 0 : (i / (missionTotalSteps-1));
    const lat = bounds.getSouth() + (bounds.getNorth()-bounds.getSouth()) * t;
    const lng = bounds.getWest()  + (bounds.getEast()-bounds.getWest()) * (((i*7) % missionTotalSteps) / missionTotalSteps);

    if(autoFollow) map.panTo([lat,lng], {animate:false});

    await scanBuildings(lat, lng, true);

    missionDoneSteps = i+1;

    if(el("progressCount")) el("progressCount").innerText = `${missionDoneSteps} / ${missionTotalSteps}`;
    if(el("totalProgressBar")) el("totalProgressBar").style.width = `${(missionDoneSteps/missionTotalSteps)*100}%`;

    // ë‚¨ì€ì‹œê°„ ë³´ì •: step ê¸°ë°˜ ì˜ˆìƒê°’ë³´ë‹¤ í¬ê²Œ ë‚¨ì•„ìˆìœ¼ë©´ ì¤„ì—¬ì¤Œ(ìŠ¤ìº”ì´ ë¹ ë¥¼ ë•Œ)
    const expectedLeft = Math.max(0, (missionTotalSteps - missionDoneSteps) * missionDelayMs);
    if(missionRemainingMs > expectedLeft) missionRemainingMs = expectedLeft;

    await new Promise(r=>setTimeout(r, missionDelayMs));
  }

  missionRunning = false;
  missionPaused = false;
  stopMissionTimer();

  if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";
  showToast(missionStop ? "ìŠ¤ìº” ì·¨ì†Œ" : "ìŠ¤ìº” ì™„ë£Œ");
};

window.cancelMission = function(keepResults){
  missionStop = true;
  missionPaused = false;
  missionRunning = false;
  stopMissionTimer();

  const btn = el("startBtn");
  if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";

  if(!keepResults){
    clearResults(true);
  }
  window.updateEstimatedTime();
};

window.downloadScanResults = function(fmt){
  // Export current selectable polygons
  try{
    const geojson = selectableGroup.toGeoJSON();
    const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `scan_results.${fmt === "geojson" ? "geojson" : "json"}`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(e){
    showToast("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
  }
};

function updateAutoScanBox(){
  if(!map){
    if(autoScanBox){ try{ autoScanBox.remove(); }catch(e){} autoScanBox=null; }
    return;
  }
  if(!(FEATURE_LEVEL >= 4 && autoScanMode)){
    if(autoScanBox){ try{ autoScanBox.remove(); }catch(e){} autoScanBox=null; }
    return;
  }

  // F-14: ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ìë™ ìŠ¤ìº” ë²”ìœ„(ë…¸ë€ ì ì„  ë°•ìŠ¤)
  // - ì¤Œ ë ˆë²¨ì— ë¬´ê´€í•˜ê²Œ "ëŒ€ëµ ì¼ì • ê±°ë¦¬(m)"ë¡œ ìœ ì§€ (ë³´ìˆ˜ì )
  const c = map.getCenter();
  const halfMeters = 250; // í•œ ë³€ ì•½ 500m (ì¶”í›„ ì„¤ì •ê°’ìœ¼ë¡œ ë…¸ì¶œ ê°€ëŠ¥)

  const dLat = halfMeters / 111320; // meters -> deg
  const dLng = halfMeters / (111320 * Math.max(0.2, Math.cos(c.lat * Math.PI / 180)));

  const bounds = [[c.lat - dLat, c.lng - dLng], [c.lat + dLat, c.lng + dLng]];

  if(!autoScanBox){
    autoScanBox = L.rectangle(bounds, {color:"#fbbf24", weight:2, fillOpacity:0, dashArray:"5,5"}).addTo(map);
  }else{
    autoScanBox.setBounds(bounds);
  }
}

// -----------------------------
// AI analysis (F-15/16)
// -----------------------------
async function postJson(url, body){
  const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body||{}), credentials:"include"});
  // Let caller handle non-OK for fallback
  const text = await res.text();
  let data = null;
  try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
  return { ok: res.ok, status: res.status, data };
}

const __CHECK_LINKS = {
  "ì¡°ë¡€": "https://www.elis.go.kr/",
  "ìš©ë„ì§€ì—­": "https://www.eum.go.kr/web/am/amMain.jsp",
  "ìƒìœ„ë²•": "https://law.go.kr/main.html",
  "ìƒíƒœ": "https://aid.mcee.go.kr/",
  "ë¬¸í™”ì¬": "https://www.nie-ecobank.kr/cmmn/Index.do",
  "ê²½ì‚¬": "https://webgis.neins.go.kr/map.do",
  "ê³„í†µ": "https://online.kepco.co.kr/",
  "ë³€ì „ì†Œ": "https://online.kepco.co.kr/",
  "ì„ ë¡œ": "https://online.kepco.co.kr/",
  "í•œì „": "https://online.kepco.co.kr/",
};
function __deriveCheckLink(title){
  const t = String(title||"");
  for(const k in __CHECK_LINKS){
    if(t.includes(k)) return __CHECK_LINKS[k];
  }
  // ë„ì‹œ/êµ° ì¡°ë¡€ë„ ì¡°ë¡€ ì‹œìŠ¤í…œìœ¼ë¡œ
  if(t.includes("ë„ì‹œ") || t.includes("êµ°") || t.includes("ì§€ìì²´")) return "https://www.elis.go.kr/";
  return "";
}


// ----------------------------
// âœ… AI ì¢…í•© ì½”ë©˜íŠ¸(êµ¬ë§¤ë§¤ë ¥ë„) ìœ í‹¸
// ----------------------------
let __aiBarTimer = null;
function _aiBarStart(){
  const wrap = el("aiRecheckBarWrap");
  const bar = el("aiRecheckBar");
  if(!wrap || !bar) return;
  wrap.classList.remove("hidden");
  bar.style.width = "8%";
  let p = 8;
  if(__aiBarTimer) clearInterval(__aiBarTimer);
  __aiBarTimer = setInterval(()=>{
    // 8% -> 92% slowly
    p = Math.min(92, p + (p < 40 ? 6 : (p < 70 ? 3 : 1)));
    bar.style.width = p + "%";
  }, 220);
}
function _aiBarDone(){
  const wrap = el("aiRecheckBarWrap");
  const bar = el("aiRecheckBar");
  if(!wrap || !bar) return;
  if(__aiBarTimer){ clearInterval(__aiBarTimer); __aiBarTimer = null; }
  bar.style.width = "100%";
  setTimeout(()=>{ wrap.classList.add("hidden"); bar.style.width="0%"; }, 450);
}

function buildBusinessComment(payload){
  try{
    const score = (typeof payload.attractiveness_score==="number") ? payload.attractiveness_score : null;
    const conf  = (typeof payload.confidence==="number") ? payload.confidence : null;
    const checks = Array.isArray(payload.checks) ? payload.checks : [];
    const needsCnt = checks.filter(x=>x && (x.needs_confirm || x.confirm_needed || (String(x.message||x.result||"").includes("í™•ì¸") && String(x.message||x.result||"").includes("í•„ìš”")))).length;
    const totalCnt = checks.length || 1;
    const confirmRatio = 1 - (needsCnt / totalCnt);

    const fin = (window.currentAnalysisData && window.currentAnalysisData.finance && window.currentAnalysisData.finance.summary) ? window.currentAnalysisData.finance.summary : {};
    const capex = Number(fin.capex_total_won||0);
    const revY1 = Number(fin.annual_revenue_y1_won||0);
    const pbtY1 = Number(fin.annual_profit_before_tax_y1_won||0);
    const dscr = (window.currentAnalysisData && window.currentAnalysisData.finance && window.currentAnalysisData.finance.dscr_y1) ? Number(window.currentAnalysisData.finance.dscr_y1) : null;
    const payback = (window.currentAnalysisData && window.currentAnalysisData.finance && window.currentAnalysisData.finance.payback_years) ? Number(window.currentAnalysisData.finance.payback_years) : null;

    const mode = (document.getElementById("landTenureMode")?.value || "BUY").toString();
    const modeLabel = (mode==="OWN")?"í† ì§€ë³´ìœ ":(mode==="BUY")?"í† ì§€êµ¬ë§¤":(mode==="LAND_LEASE")?"í† ì§€ì„ëŒ€":"ì§€ë¶•ì„ëŒ€";

    const fmt = (n)=> (Math.round(Number(n||0)/1000)).toLocaleString(); // ì²œì›ë‹¨ìœ„
    const lines = [];

    // 1) Overall tone
    if(score === null){
      lines.push("í˜„ì¬ëŠ” êµ¬ë§¤ë§¤ë ¥ë„(ì ìˆ˜)ë¥¼ ê³„ì‚°í•  ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì•„ë˜ â€˜AI ì¬ê²€í† â€™ë¥¼ ëˆŒëŸ¬ ê·œì œ/ì…ì§€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
    }else{
      const s = Math.max(0, Math.min(100, Math.round(score)));
      const grade = (s>=80)?"ìš°ìˆ˜":(s>=65)?"ì–‘í˜¸":(s>=50)?"ë³´í†µ":(s>=35)?"ì£¼ì˜":"ìœ„í—˜";
      lines.push(`êµ¬ë§¤ë§¤ë ¥ë„ ${s}ì (${grade}) Â· ì‹ ë¢°ë„ ${(conf!==null?Math.round(conf):"-")}% Â· í† ì§€/ì„ëŒ€ ë°©ì‹: ${modeLabel}`);
    }

    // 2) Financial snapshot (only if present)
    if(capex>0 || revY1>0 || pbtY1>0){
      lines.push(`ì¬ë¬´ ìš”ì•½(ì²œì›): CAPEX ${fmt(capex)} / 1ë…„ì°¨ ë§¤ì¶œ ${fmt(revY1)} / 1ë…„ì°¨ ì„¸ì „ì´ìµ ${fmt(pbtY1)}.`);
    }

    if(isFinite(dscr) && dscr>0){
      const dscrTxt = dscr>=1.30 ? "ìƒí™˜ì—¬ë ¥ ì—¬ìœ " : (dscr>=1.10 ? "ìƒí™˜ì—¬ë ¥ ê²½ê³„" : "ìƒí™˜ì—¬ë ¥ ë¶€ì¡±");
      lines.push(`DSCR(1ë…„ì°¨) ${dscr.toFixed(2)} â†’ ${dscrTxt}.`);
    }

    if(isFinite(payback) && payback>0){
      lines.push(`ìë³¸íšŒìˆ˜ê¸°ê°„(ì¶”ì •): ${payback.toFixed(1)}ë…„.`);
    }

    // 3) Uncertainty handling
    if(confirmRatio < 0.70){
      lines.push("í™•ì¸ í•„ìš” í•­ëª©ì´ ë§ì•„(ê·œì œ/ê³„í†µ/ë¶€ì§€ ê²½ê³„ ë“±) ì ìˆ˜ ë³€ë™ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤. ë¨¼ì €: (1) í•œì „ ê³„í†µì—¬ìœ /ì ‘ì†ê°€ëŠ¥ í™•ì¸, (2) ì§€ëª©/ìš©ë„ì§€ì—­/ê±´ì¶•ë¬¼ëŒ€ì¥, (3) ì§€ë¶• êµ¬ì¡°Â·ë©´ì  ì‹¤ì¸¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤.");
    }else{
      lines.push("í•µì‹¬ ì²´í¬ í•­ëª©ì˜ í™•ì¸ ë¹„ì¤‘ì´ ë¹„êµì  ë†’ìŠµë‹ˆë‹¤. ì´ì œëŠ” ê²¬ì (EPC/ëª¨ë“ˆ/ì¸ë²„í„°)ê³¼ ì„ëŒ€/ì‚¬ìš©ê¶Œ ì¡°ê±´ì„ í˜„ì‹¤ ê°’ìœ¼ë¡œ ë„£ì–´ PFë¥¼ ê³ ë„í™”í•˜ëŠ” ë‹¨ê³„ê°€ ì í•©í•©ë‹ˆë‹¤.");
    }

    // 4) Soft guidance (no hard rejection)
    if(score !== null && score < 40){
      lines.push("ì ìˆ˜ê°€ ë‚®ë”ë¼ë„ â€˜ë¶ˆê°€â€™ ì˜ë¯¸ëŠ” ì•„ë‹™ë‹ˆë‹¤. ëŒ€ì²´ë¡œ **ê³„í†µ/ê·œì œ ë¶ˆí™•ì‹¤ì„±** ë˜ëŠ” **ìˆ˜ìµ ëŒ€ë¹„ CAPEX ê³¼ë‹¤**ì—ì„œ ì ìˆ˜ê°€ ë–¨ì–´ì§‘ë‹ˆë‹¤. í™•ì¸ í•­ëª©ì„ ì±„ìš°ë©´ ê°œì„  ì—¬ì§€ê°€ ìˆëŠ”ì§€ ë¨¼ì € íŒë‹¨í•˜ì„¸ìš”.");
    }

    return lines.join("\n");
  }catch(e){
    return "";
  }
}

function renderAiFinal(payload){
  try{
    const panel = el("aiFinalPanel");
    if(!panel) return;

    const sEl = el("finalScoreValue");
    const cEl = el("finalConfidence");
    const bEl = el("aiBusinessComment");
    const sumEl = el("aiFinalSummary");

    const summary = payload.ai_summary || payload.summary || "";
    const score = (typeof payload.attractiveness_score==="number") ? payload.attractiveness_score : null;
    const confidence = (typeof payload.confidence==="number") ? payload.confidence : null;

    const comment = buildBusinessComment(payload);

    // decide visibility
    const shouldShow = !!summary || !!comment || (score !== null);
    if(!shouldShow){
      panel.classList.add("hidden");
      return;
    }
    panel.classList.remove("hidden");

    if(sEl){
      if(score===null) sEl.textContent = "-";
      else sEl.textContent = `${Math.max(0, Math.min(100, Math.round(score)))}ì `;
    }
    if(cEl){
      cEl.textContent = (confidence!==null) ? `ì‹ ë¢°ë„: ${Math.max(0, Math.min(100, Math.round(confidence)))}%` : "";
    }
    if(bEl) bEl.textContent = comment || "";
    if(sumEl) sumEl.textContent = summary ? String(summary) : "";
  }catch(e){
    console.error("renderAiFinal failed", e);
  }
}

function renderAIResult(payload){
  // Expected: checks[], attractiveness_score or ai_score
  const container = el("aiAnalysisResult");
  if(container){
    const checks = Array.isArray(payload.checks) ? payload.checks : [];
    const summary = payload.ai_summary || payload.summary || "";
    const sumPanel = el("aiSummaryPanel");
    const sumText = el("aiSummaryText");
    if(sumPanel && sumText){
      if(summary){ sumPanel.classList.remove("hidden"); sumText.textContent = String(summary); }
      else { sumPanel.classList.add("hidden"); sumText.textContent = ""; }
    }
    container.innerHTML = checks.map(item => {
      const title = safeText(item.title || item.category, "");
      const result = safeText(item.message || item.result || item.status || "", "í™•ì¸ í•„ìš”");
      const link = (item.link || item.url || __deriveCheckLink(title) || "");
      const needs = item.needs_confirm || item.confirm_needed || (String(result).includes("í™•ì¸") && String(result).includes("í•„ìš”"));
      return `
        <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]">
          <div class="flex items-center gap-2">
            <div class="text-cyan-400">âœ“</div>
            <div>
              <div class="text-slate-300 font-bold">${title}</div>
              <div class="${needs ? "text-yellow-300" : "text-white"} truncate w-60">${result}</div>
            </div>
          </div>
          ${link ? `<a href="${link}" target="_blank" class="bg-slate-600 px-2 py-1 rounded hover:bg-slate-500">ë§í¬</a>` : ""}
        </div>
      `;
    }).join("") || `<div class="text-slate-300 text-xs">AI ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  // Score
  const scorePanel = el("aiScorePanel");
  const scoreValue = el("scoreValue");
  const scoreBar = el("scoreBar");
  const confidenceValue = el("confidenceValue");

  // Score priority: payload.attractiveness_score or payload.ai_score.score
  let score = null;
  let confidence = null;
  if(typeof payload.attractiveness_score === "number") score = payload.attractiveness_score;
  else if(payload.ai_score && typeof payload.ai_score.score === "number") score = payload.ai_score.score;

  if(payload.ai_score && typeof payload.ai_score.confidence === "number") confidence = payload.ai_score.confidence;
  if(typeof payload.confidence === "number") confidence = payload.confidence;

  if(scorePanel && scoreValue && scoreBar){
    if(score === null) {
      scorePanel.classList.add("hidden");
    } else {
      scorePanel.classList.remove("hidden");
      const s = Math.max(0, Math.min(100, Math.round(score)));
      scoreValue.innerText = `${s}ì `;
      scoreBar.style.width = `${s}%`;
      if(confidenceValue) confidenceValue.innerText = (confidence !== null) ? `ì‹ ë¢°ë„: ${confidence}%` : "";
    }
  }

  // Kepco capacity field if present
  if(el("kepcoCapacity")){
    const kc = payload.kepco_capacity || payload.kepco || null;
    if(kc) el("kepcoCapacity").innerText = safeText(kc);
  }

  // sun hours if present
  if(typeof payload.sun_hours === "number"){
    currentAnalysisData.ai_analysis = currentAnalysisData.ai_analysis || {};
    currentAnalysisData.ai_analysis.sun_hours = payload.sun_hours;
  }
}

window.fetchAIData = async function(lat, lng, addr){
  if(FEATURE_LEVEL < 5) return;
  if(!BACKEND_URL){
    logSystem("AI skipped: BACKEND_URL not set (use ?backend=...)");
    return;
  }

  const placeholder = el("legalPlaceholder");
  const loading = el("legalLoading");
  const content = el("legalContent");

  if(placeholder) placeholder.classList.add("hidden");
  if(content) content.classList.add("hidden");
  if(loading) loading.classList.remove("hidden");
  _aiBarStart();
  const ll = getAnalysisLatLng();
  const lat0 = (typeof lat === "number" && isFinite(lat)) ? lat : ll.lat;
  const lng0 = (typeof lng === "number" && isFinite(lng)) ? lng : ll.lng;

  const payload = {
    address: addr,
    mode: (scanTarget === "land") ? "land" : "roof",
    lat: lat0, lng: lng0,
    panel_count: getTotalPanelCount(),
    setback_m: parseFloat(el("setbackDist")?.value || "0") || 0,
  };

  try{
    // Spec says: POST /api/analyze/basic (Fast)
    let r = await postJson(`${BACKEND_URL}/api/analyze/basic`, payload);
    if(!r.ok){
      // fallback to existing path used previously in drafts
      r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
    }
    if(!r.ok){
      throw new Error(`AI HTTP ${r.status}`);
    }

    currentAnalysisData.ai_analysis = r.data;

    if(loading) loading.classList.add("hidden");
    if(content) content.classList.remove("hidden");

    renderAIResult(r.data);
    renderAiFinal(r.data);
    _aiBarDone();

    // F-27/28 refresh (API-first)
    try{ window.refreshSolarLandEstimates(); }catch(e){}

    // Recalc finance with sun hours if present
    if(typeof r.data.sun_hours === "number"){
      window.calculateFinance(getTotalPanelCount(), r.data.sun_hours);
    }
  } catch(e){
    _aiBarDone();
    if(loading) loading.classList.add("hidden");
    if(placeholder) {
      placeholder.classList.remove("hidden");
      placeholder.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs">ê¸°ë³¸ ë¶„ì„ ì‹¤íŒ¨<br><span class="text-[10px]">${safeText(e.message,"")}</span></div>`;
    }
    logSystem(`AI error: ${e.message}`);
  }
};

// -----------------------------
// Report / History (minimal, keeps UI)
// -----------------------------
function ensureFinanceComputed(){
  try{
    const pc = getTotalPanelCount();
    const fin = currentAnalysisData.finance || null;
    const hasSummary = !!(fin && fin.summary && typeof fin.summary.capex_total_won === "number");
    if(pc > 0 && !hasSummary){
      const sunH = (currentAnalysisData.solar_opt?.sun_hours ?? currentAnalysisData.ai_analysis?.sun_hours);
      if(typeof window.calculateFinance === "function"){
        window.calculateFinance(pc, (typeof sunH === "number" && isFinite(sunH) && sunH > 0) ? sunH : undefined);
      }
    }
  }catch(e){
    try{ if(el("resDebugFinance")) el("resDebugFinance").innerText = `PF ê³„ì‚° ì‹¤íŒ¨: ${safeText(e.message,"")}`; }catch(_e){}
    console.warn("ensureFinanceComputed failed", e);
  }
}

window.openFullReport = function(){
  try{ ensureFinanceComputed(); }catch(e){}
  const form = el("reportForm");
  if(!form){
    showToast("reportForm not found");
    return;
  }
  if(!BACKEND_URL){
    showToast("backend ë¯¸ì„¤ì •");
    return;
  }
  // Fill hidden fields if exist
  if(el("form_address")) el("form_address").value = safeText(currentAnalysisData.address, "");
  if(el("form_capacity")) el("form_capacity").value = safeText(el("analysisCapacity")?.innerText, "");
  if(el("form_kepco")) el("form_kepco").value = safeText(el("kepcoCapacity")?.innerText, "í™•ì¸ í•„ìš”");
  if(el("form_date")) el("form_date").value = new Date().toLocaleString();
  if(el("form_mode")) el("form_mode").value = (scanTarget === "land") ? "land" : "roof";
  if(el("form_lat")) el("form_lat").value = String(currentAnalysisData?.lat ?? currentAnalysisData?.center?.lat ?? "");
  if(el("form_lng")) el("form_lng").value = String(currentAnalysisData?.lng ?? currentAnalysisData?.center?.lng ?? "");
  if(el("form_pnu")) el("form_pnu").value = String(currentAnalysisData?.pnu ?? "");
  if(el("form_finance")) el("form_finance").value = JSON.stringify(currentAnalysisData.finance || {});
  if(el("form_ai")) el("form_ai").value = JSON.stringify(currentAnalysisData.ai_analysis || {});
  if(el("form_solar")) el("form_solar").value = JSON.stringify(currentAnalysisData.solar_opt || {});
  if(el("form_land")) el("form_land").value = JSON.stringify(currentAnalysisData.land_estimate || {});
  if(el("form_score")) el("form_score").value = JSON.stringify(currentAnalysisData.ai_analysis?.attractiveness_score || 0);
  if(el("form_price")) el("form_price").value = ""; // placeholder

  form.action = `${BACKEND_URL}/report`;
  form.submit();
};

function historyKey(){ return "sp_history_v1"; }

function loadHistory(){
  try{
    const raw = localStorage.getItem(historyKey());
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveHistory(items){
  try{ localStorage.setItem(historyKey(), JSON.stringify(items)); }catch(e){}
}
function renderHistory(){
  const list = el("historyList");
  if(!list) return;
  const items = loadHistory();
  if(!items.length){
    list.innerHTML = `<div class="text-xs text-slate-400">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  // ë§¤ë ¥ë„ ì ìˆ˜ ê³„ì‚° (AI ë¶„ì„ ê¸°ë°˜)
  const scored = items.map((it, idx) => {
    const ai = it.ai || {};
    let score = null;
    if (typeof ai.attractiveness_score === "number") {
      score = ai.attractiveness_score;
    } else if (ai.ai_score && typeof ai.ai_score.score === "number") {
      score = ai.ai_score.score;
    }
    return { it, idx, score };
  });

  // ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬, ì ìˆ˜ ì—†ëŠ” í•­ëª©ì€ ë§¨ ë’¤
  scored.sort((a, b) => {
    const sa = (typeof a.score === "number") ? a.score : -1;
    const sb = (typeof b.score === "number") ? b.score : -1;
    return sb - sa;
  });

  // ìƒìœ„ 10ê°œë§Œ ì‚¬ìš©
  const top = scored.slice(0, 10);

  
list.innerHTML = top.map(({ it, score, idx }, rank)=>`
    <div class="bg-white border border-slate-200 rounded p-2 text-xs shadow-sm flex justify-between items-center gap-2">
      <div>
        <div class="flex items-center gap-1">
          <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 text-white font-bold">${rank+1}</span>
          <span class="font-bold text-slate-700 truncate max-w-[180px]" title="${escapeHtml(it.address || "í™•ì¸ í•„ìš”")}">
            ${escapeHtml(it.address || "í™•ì¸ í•„ìš”")}
          </span>
        </div>
        <div class="text-[10px] text-slate-500">
          ${escapeHtml(it.time || "")}
        </div>
        <div class="text-[10px] text-slate-600">
          íŒ¨ë„ ${it.panelCount || 0}ì¥ Â· ëª¨ë“œ ${escapeHtml(it.mode || "")} Â· ì ìˆ˜ ${ (typeof score === "number") ? Math.round(score) + "ì " : "-" }
        </div>
      </div>
      <div class="flex items-center gap-1">
        <button type="button"
                class="inline-flex items-center justify-center w-6 h-6 rounded-full border border-slate-300 text-[10px] text-slate-600 bg-slate-50"
                title="ìƒì„¸ ë¦¬í¬íŠ¸ (ì¶”í›„ êµ¬í˜„)">
          <i class="ph ph-magnifying-glass"></i>
        </button>
        <button type="button"
                class="inline-flex items-center justify-center w-6 h-6 rounded-full border border-red-200 text-[10px] text-red-600 bg-red-50 hover:bg-red-100"
                title="ì´ ê¸°ë¡ ì‚­ì œ"
                onclick="window.deleteHistoryEntry(${idx})">
          <i class="ph ph-trash"></i>
        </button>
      </div>
    </div>
  `).join("");

}

window.saveResult = function(){
  try{ ensureFinanceComputed(); }catch(e){}
  const items = loadHistory();
  const entry = {
    time: new Date().toLocaleString(),
    address: safeText(currentAnalysisData.address, "í™•ì¸ í•„ìš”"),
    mode: currentAnalysisData.mode || (scanTarget==="land"?"land":"roof"),
    panelCount: getTotalPanelCount(),
    finance: currentAnalysisData.finance || {},
    ai: currentAnalysisData.ai_analysis || {}
  };
  items.unshift(entry);
  saveHistory(items.slice(0, 100));
  showToast("ì €ì¥ ì™„ë£Œ");
  renderHistory();
  // comma formatting for money inputs
  try{ bindCommaInput("pfPrincipal"); }catch(e){}
  try{ bindCommaInput("pfMaintOpexAnnual"); }catch(e){}
  try{ bindCommaInput("pfOtherOpexAnnual"); }catch(e){}
  try{ bindCommaInput("landRentMonthly"); }catch(e){}

};

window.clearHistory = function(){
  saveHistory([]);
  showToast("ê¸°ë¡ ì‚­ì œ");
  renderHistory();
};

window.downloadCSV = function(){
  const items = loadHistory();
  if(!items.length){
    showToast("ë‹¤ìš´ë¡œë“œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  const rows = [["time","address","mode","panelCount","acCapacityKw","annualRevenueWon","totalCostWon","score"]];
  for(const it of items){
    const fin = it.finance || {};
    const score = (it.ai && (it.ai.attractiveness_score ?? it.ai.ai_score?.score)) ?? "";
    rows.push([
      it.time || "",
      (it.address || "").replaceAll("\n"," ").replaceAll(","," "),
      it.mode || "",
      it.panelCount || 0,
      fin.acCapacityKw ?? "",
      fin.annualRevenueWon ?? "",
      fin.totalCostWon ?? "",
      score
    ]);
  }
  const csv = rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "solar_pathfinder_history.csv";
  a.click();
  URL.revokeObjectURL(url);
};

// -----------------------------
// -----------------------------
// Clear analysis-only helper (keep candidates on map)
// -----------------------------
function clearAnalysisOnly(){
  try{ if(panelGroup) panelGroup.clearLayers(); }catch(e){}
  try{ if(analysisMarkerGroup) analysisMarkerGroup.clearLayers(); }catch(e){}
  try{ if(selectedFeatures && selectedFeatures.clear) selectedFeatures.clear(); }catch(e){}
  try{ currentAnalysisFeature = null; }catch(e){}
  try{ currentAnalysisData = {}; }catch(e){}
  try{ resetCalibrationInternal(false); }catch(e){}

  // Hide result UI (do not touch layout)
  try{
    const rc = document.getElementById("resultCard");
    if(rc) rc.classList.add("hidden");
    const lp = document.getElementById("legalPlaceholder");
    const lc = document.getElementById("legalCard");
    const sp = document.getElementById("aiScorePanel");
    if(lp) lp.classList.remove("hidden");
    if(lc) lc.classList.add("hidden");
    if(sp) sp.classList.add("hidden");
  }catch(e){}
}

// Clear / reset helper
// -----------------------------
function clearResults(clearToasts){
  selectableGroup.clearLayers();
  panelGroup.clearLayers();
  analysisMarkerGroup.clearLayers();
  selectedFeatures.clear();
  currentAnalysisFeature = null;
  currentAnalysisData = {};
  resetCalibrationInternal(false);

  const found = el("foundCount");
  if(found) found.innerText = "ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ";

  if(clearToasts) showToast("ì´ˆê¸°í™”");
}

// -----------------------------
// Boot
// -----------------------------

// ---------- Public access key binding ----------
async function ensurePublicAuth() {
  try {
    if (!window.PUBLIC_AUTH_ENABLED) return;
    const r = await fetch(`${backendBase}/api/auth/status`, { credentials: 'include' });
    const j = await r.json();
    if (!j || !j.ok) return;
    if (!j.enabled) return; // auth disabled
    if (j.authed) return;   // already authed

    const modal = document.getElementById('publicAuthModal');
    const input = document.getElementById('publicKeyInput');
    const err = document.getElementById('publicKeyErr');
    const submit = document.getElementById('publicKeySubmit');
    const reset = document.getElementById('publicKeyReset');

    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // prevent repeat binding attempt in same browser (simple UX safeguard)
    const boundFlag = localStorage.getItem('sp_key_bound') === '1';
    if (boundFlag) {
      err.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì´ë¯¸ ì¸ì¦í‚¤ë¥¼ ë“±ë¡í–ˆìŠµë‹ˆë‹¤. (ì¿ í‚¤ê°€ ì‚­ì œëœ ê²½ìš° ì„œë²„ì—ì„œ ë‹¤ì‹œ ì¸ì¦ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”)";
      err.classList.remove('hidden');
    }

    await new Promise((resolve) => {
      submit.onclick = async () => {
        err.classList.add('hidden');
        const key = (input.value || '').trim();
        if (!key) {
          err.textContent = "ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
          err.classList.remove('hidden');
          return;
        }
        submit.disabled = true;
        submit.textContent = "í™•ì¸ ì¤‘...";
        try {
          const rr = await fetch(`${backendBase}/api/auth/bind`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ key })
          });
          const jj = await rr.json().catch(() => ({}));
          if (!rr.ok || !jj.ok) {
            err.textContent = (jj && jj.msg) ? jj.msg : "ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            err.classList.remove('hidden');
            submit.disabled = false;
            submit.textContent = "í™•ì¸";
            return;
          }
          localStorage.setItem('sp_key_bound', '1');
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          resolve();
        } catch (e) {
          err.textContent = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          err.classList.remove('hidden');
          submit.disabled = false;
          submit.textContent = "í™•ì¸";
        }
      };

      reset.onclick = () => {
        localStorage.removeItem('sp_key_bound');
        location.reload();
      };
    });
  } catch (e) {
    // ignore
  }
}

window.onload = async function(){
    await ensurePublicAuth();

  // stop dpad when focus lost
  window.addEventListener("blur", window.dpadHoldStop);
  window.initMap();
  window.updateEstimatedTime();
  renderHistory();

  // Safety: avoid undefined in UI
  if(el("analysisAddress")) el("analysisAddress").innerText = "í™•ì¸ í•„ìš”";
  if(el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”";

  // If checkboxes exist, initialize
  autoScanMode = !!(el("autoScanToggle")?.checked);
  isMultiSelectMode = !!(el("multiSelectToggle")?.checked);
};
</script>
<script>
// Accessibility patch: label Leaflet interactive markers (for audit tools)
window._a11yLeafletPatch = true;
(function(){
  const apply = () => {
    document.querySelectorAll('.leaflet-marker-icon.leaflet-interactive[role="button"]').forEach((el)=>{
      if(!el.getAttribute('aria-label')) el.setAttribute('aria-label','ì§€ë„ ë§ˆì»¤');
      if(!el.getAttribute('title')) el.setAttribute('title','ì§€ë„ ë§ˆì»¤');
    });
  };
  setInterval(apply, 1500);
})();
</script>

<script>
window._pfAutoWire = true;
(function(){
  function wire(){
    const p = document.getElementById('pfPrincipal');
    const a = document.getElementById('pfAutoPrincipal');
    if(!p || !a) return;
    if(p._wired) return;
    p._wired = true;
    p.addEventListener('input', ()=>{
      const v = parseFloat(p.value||"0")||0;
      if(v>0){ a.checked = false; }
    });
  }
  setInterval(wire, 1200);
})();


/* ============================================================
   UX ê°œì„ : (A) ì¸í”„ë¼(ë³€ì „ì†Œ/ì„ ë¡œ ê°€ìƒ) ë ˆì´ì–´ í”ë“¤ë¦¼ ì™„í™”
          (B) ë¹ˆê³³ í´ë¦­ ì‹œ ì£¼ë³€ ì„¤ì¹˜ê°€ëŠ¥ì§€ì—­ ë¹ ë¥¸ ì„ íƒ
   ============================================================ */

// ---------- (A) Infra jitter fix: cache + grid snapping ----------
window.__infraCache = window.__infraCache || { key: null, layers: null };

function _latLngToTile(lat, lng, z){
  const latRad = lat * Math.PI / 180;
  const n = Math.pow(2, z);
  const x = Math.floor((lng + 180) / 360 * n);
  const y = Math.floor((1 - Math.log(Math.tan(latRad) + 1/Math.cos(latRad)) / Math.PI) / 2 * n);
  return {x, y, z};
}

// âœ… ì¤Œ/ì´ë™ì—ë„ 'ê°™ì€ ì§€ì—­ì´ë©´ ê°™ì€ seed' (ê³ ì • íƒ€ì¼ z=12 ê¸°ì¤€)
function _infraKeyFromView(kind="substation") {
  const c = window.map?.getCenter?.();
  if (!c) return null;
  const zFixed = 12;
  const t = _latLngToTile(c.lat, c.lng, zFixed);
  return `${kind}:t${t.z}:${t.x}:${t.y}`;
}

// If your code already draws virtual infra each move, call this instead.
async function refreshInfraLayerStable(force=false) {
  try{
    if(!window.map) return;

    const z = window.map.getZoom();
    const MINZ = 15, MAXZ = 16; // show only in this zoom range
    const showable = (z >= MINZ && z <= MAXZ);

    // Respect UI toggle
    const chk = el("substationToggle");
    const enabled = chk ? chk.checked : true;

    if(!enabled || !showable){
      try{ window.virtualInfraLayer && window.virtualInfraLayer.clearLayers(); }catch(e){}
      return;
    }

    if(!window.virtualInfraLayer){
      window.virtualInfraLayer = L.layerGroup();
      try{ window.virtualInfraLayer.addTo(window.map); }catch(e){}
    }else{
      if(!window.map.hasLayer(window.virtualInfraLayer)){
        try{ window.virtualInfraLayer.addTo(window.map); }catch(e){}
      }
    }

    // Grid-based deterministic caching (no jitter on pan)
    const bounds = window.map.getBounds();
    const cell = 0.01; // ~1km grid (tune)
    const minLat = bounds.getSouth(), maxLat = bounds.getNorth();
    const minLng = bounds.getWest(),  maxLng = bounds.getEast();

    const iMin = Math.floor(minLat / cell);
    const iMax = Math.floor(maxLat / cell);
    const jMin = Math.floor(minLng / cell);
    const jMax = Math.floor(maxLng / cell);

    window.__virtualInfraCache = window.__virtualInfraCache || { markers: new Map() };

    // Rebuild visible set each refresh (markers are cached, only added/removed)
    window.virtualInfraLayer.clearLayers();

    const capText = (window.currentAnalysisData?.ai_analysis?.kepco_capacity) || null;
    for(let i=iMin; i<=iMax; i++){
      for(let j=jMin; j<=jMax; j++){
        const key = `${i}_${j}`;
        let m = window.__virtualInfraCache.markers.get(key);
        if(!m){
          // deterministic point inside the cell
          const baseLat = (i + 0.5) * cell;
          const baseLng = (j + 0.5) * cell;

          // small deterministic jitter inside cell
          const rand = (function(seedStr){
            let h = 2166136261;
            for (let k=0;k<seedStr.length;k++){ h ^= seedStr.charCodeAt(k); h = Math.imul(h, 16777619); }
            return function(){
              h += 0x6D2B79F5;
              let t = Math.imul(h ^ (h >>> 15), 1 | h);
              t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
              return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
          })(key);

          const lat = baseLat + (rand()-0.5) * cell * 0.35;
          const lng = baseLng + (rand()-0.5) * cell * 0.35;

          m = L.circleMarker([lat,lng], { radius: 6, weight: 2, fillOpacity: 0.35 });
          m.bindTooltip(`ë³€ì „ì†Œ(ê°€ìƒ) [${key}]<br/>ìš©ëŸ‰: ${capText || "í™•ì¸ í•„ìš”"}<br/><span style="font-size:11px;color:#64748b;">â€» ì‹¤ì œ ì„ ë¡œ/ë³€ì „ì†Œê°€ ì•„ë‹Œ ê°œë…ë„(ëª¨ì˜)</span>`, { sticky:true });
          window.__virtualInfraCache.markers.set(key, m);
        }
        window.virtualInfraLayer.addLayer(m);
      }
    }
  }catch(e){
    console.warn("refreshInfraLayerStable failed", e);
  }
}


window.refreshInfraLayer = refreshInfraLayerStable;

// Hook: only update infra on moveend/zoomend (not on every frame)
(function attachInfraStableHooks(){
  try{
    if (!window.map) return;
    if (window.__infraStableHooksAttached) return;
    window.__infraStableHooksAttached = true;
    let t = null;
    const schedule = (force=false) => {
      clearTimeout(t);
      t = setTimeout(()=>refreshInfraLayerStable(force), 120);
    };
    window.map.on("moveend", ()=>schedule(false));
    window.map.on("zoomend", ()=>schedule(true));
  }catch(e){}
})();


// ---------- (B) ë¹ˆê³³ í´ë¦­ ì‹œ ì£¼ë³€ ì„¤ì¹˜ê°€ëŠ¥ì§€ì—­ ë¹ ë¥¸ ì„ íƒ ----------
function _pointFeature(latlng){
  return { type:"Feature", geometry:{ type:"Point", coordinates:[latlng.lng, latlng.lat] }, properties:{} };
}

function _polyCentroid(feature){
  try { return turf.centroid(feature).geometry.coordinates; } catch(e) { return null; }
}

function _distanceMeters(aLngLat, bLngLat){
  try {
    const from = turf.point(aLngLat);
    const to = turf.point(bLngLat);
    return turf.distance(from,to,{units:"kilometers"}) * 1000.0;
  } catch(e) { return 1e18; }
}

function findNearestCandidateAt(latlng, mode, radiusMeters){
  const list = (window.lastScanCandidates || []);
  if (!list.length) return null;

  const z = window.map?.getZoom?.() ?? 16;
  // ê¸°ë³¸ì€ ê¸°ì¡´ ë¡œì§(ì¤Œ ê¸°ë°˜), Mission-1 Smart Clickì—ì„œëŠ” radiusMeters(ì˜ˆ:25m)ë¡œ ê°•ì œ
  const r = (typeof radiusMeters === 'number' && isFinite(radiusMeters))
    ? Math.max(0, radiusMeters)
    : Math.max(120, Math.min(520, 520 - z*18)); // ~120-520m
  const pt = _pointFeature(latlng);

  let best = null;
  let bestD = 1e18;

  for (const f of list) {
    if (!f || !f.geometry) continue;
    if (mode && f.properties && f.properties.mode && f.properties.mode !== mode) continue;

    // 1) ë‚´ë¶€ í´ë¦­ì´ë©´ ì¦‰ì‹œ ì„ íƒ
    try{
      if(turf.booleanPointInPolygon(pt, f)) return f;
    }catch(e){}

    // 2) í´ë¦¬ê³¤ ê²½ê³„ê¹Œì§€ ê±°ë¦¬(ê°€ëŠ¥í•˜ë©´) ì‚¬ìš©
    let d = 1e18;
    try{
      if(typeof turf.pointToPolygonDistance === "function"){
        d = turf.pointToPolygonDistance(pt, f, {units:"kilometers"}) * 1000.0;
      }
    }catch(e){}

    // 3) fallback: centroid ê±°ë¦¬
    if(!isFinite(d) || d === 1e18){
      const c = _polyCentroid(f);
      if(!c) continue;
      d = _distanceMeters([latlng.lng, latlng.lat], c);
    }

    if (d < bestD) { bestD = d; best = f; }
  }

  if (best && bestD <= r) return best;
  return null;
}


/* Mission-1: Smart Click loading indicator (instant feedback) */
function _ensureSmartClickLoader(){
  try{
    const mapEl = document.getElementById("map");
    if(!mapEl) return null;
    let el = document.getElementById("smartClickLoading");
    if(el) return el;
    el = document.createElement("div");
    el.id = "smartClickLoading";
    el.style.cssText = "position:absolute; left:50%; top:14px; transform:translateX(-50%); z-index:3500; background:rgba(2,6,23,0.82); color:#fff; padding:8px 12px; border-radius:999px; font-size:12px; display:none; box-shadow:0 10px 25px rgba(0,0,0,0.35); border:1px solid rgba(56,189,248,0.35);";
    el.innerHTML = "<span style='display:inline-flex;align-items:center;gap:8px'><span class='spn' style='width:10px;height:10px;border-radius:999px;border:2px solid rgba(255,255,255,0.35);border-top-color:rgba(56,189,248,1);display:inline-block;animation:spin 0.8s linear infinite'></span><b>ê²€ìƒ‰ ì¤‘...</b><span style='opacity:.7'>ê·¼ì²˜ ì§€ë¶•/í† ì§€ë¥¼ ìë™ ì„ íƒí•©ë‹ˆë‹¤</span></span>";
    mapEl.appendChild(el);
    // minimal keyframes (once)
    if(!document.getElementById("smartClickSpinStyle")){
      const st=document.createElement("style");
      st.id="smartClickSpinStyle";
      st.innerHTML="@keyframes spin{to{transform:rotate(360deg)}}";
      document.head.appendChild(st);
    }
    return el;
  }catch(e){ return null; }
}
function showSmartClickLoading(on){
  const el = _ensureSmartClickLoader();
  if(!el) return;
  el.style.display = on ? "block" : "none";
}
// When user clicks on map but not on a feature: pick nearest candidate & trigger selection
async function handleBlankMapClick(e){
  const latlng = e?.latlng;
  if (!latlng) return;

  // (UI ìš”ì²­) íŒ¨ë„ í† ê¸€: ê°™ì€ ì§€ì (ê·¼ì ‘) ë‹¤ì‹œ í´ë¦­í•˜ë©´ íŒ¨ë„/ê²°ê³¼ë¥¼ ì§€ì›€
  try{
    const last = window.__lastBlankClickLatLng;
    const hasPanels = (window.panelGroup && typeof window.panelGroup.getLayers === "function" && window.panelGroup.getLayers().length > 0);
    if(last && hasPanels && window.map && typeof window.map.distance === "function"){
      const distM = window.map.distance(last, latlng);
      if(distM <= 3){
        clearResults(false);
        window.__lastBlankClickLatLng = null;
        return;
      }
    }
  }catch(_e){}

  window.__lastBlankClickLatLng = latlng;

  // Mission-1: ì¦‰ê° ë°˜ì‘(ë¡œë”©)
  showSmartClickLoading(true);
  const mode = (window.currentMode || window.analysisMode || "roof");

  try{
    // 1) Smart Click: í´ë¦­ ì§€ì  ê¸°ì¤€ 25m ë°˜ê²½ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ í´ë¦¬ê³¤ ìë™ ì„ íƒ
    const nearest = findNearestCandidateAt(latlng, mode, 25);
    if (nearest) {
      if (typeof window.onCandidateSelected === "function") {
        window.onCandidateSelected(nearest, {source:"smart-click-25m", latlng});
      } else if (typeof window.renderSelectedRoof === "function") {
        window.renderSelectedRoof(nearest);
      } else if (typeof window.renderSelectedLand === "function") {
        window.renderSelectedLand(nearest);
      }
      return;
    }

    // 2) í›„ë³´ê°€ ì—†ë‹¤ë©´: í´ë¦­ ì£¼ë³€ë§Œ ë§ˆì´í¬ë¡œ ìŠ¤ìº”(ê°€ëŠ¥í•œ ê²½ìš°) í›„ ë‹¤ì‹œ 15m íƒìƒ‰
    if (typeof window.scanAtLatLng === "function") {
      await window.scanAtLatLng(latlng);
      const nearest2 = findNearestCandidateAt(latlng, mode, 25);
      if (nearest2) {
        if (typeof window.onCandidateSelected === "function") {
          window.onCandidateSelected(nearest2, {source:"smart-click-after-scan-25m", latlng});
        } else if (typeof window.renderSelectedRoof === "function") {
          window.renderSelectedRoof(nearest2);
        } else if (typeof window.renderSelectedLand === "function") {
          window.renderSelectedLand(nearest2);
        }
        return;
      }
    }

    try{ showToast("ê·¼ì²˜(15m)ì—ì„œ ì„ íƒ ê°€ëŠ¥í•œ ì§€ë¶•/í† ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤"); }catch(_){}
  }catch(err){
    console.warn("handleBlankMapClick failed", err);
  }finally{
    showSmartClickLoading(false);
  }
}

// attach map click handler with guard: don't interfere with existing polygon clicks
(function attachBlankClickHook(){
  try{
    if (!window.map) return;
    if (window.__blankClickAttached) return;
    window.__blankClickAttached = true;
    window.map.on("click", (e)=>{
      // if last click was on feature, skip. Your feature click handler should set this flag.
      if (window.__featureClickLock) { window.__featureClickLock = false; return; }
      handleBlankMapClick(e);
    });
  }catch(e){}
})();

// For feature-click handlers: call this at the start to prevent double-handling
window.markFeatureClicked = function(){ window.__featureClickLock = true; };

</script>


<script>
/* Hardware dropdown binding (Modules/Inverters) */
(function(){
  function el(id){ return document.getElementById(id); }

  const state = { modules: [], inverters: [], selectedModule: null, selectedInverter: null };
  window.spHardware = state; // debug

  async function fetchJson(url){
    const r = await fetch(url, {credentials:"include"});
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) throw new Error("HTTP " + r.status);
    return j;
  }

  function optionLabelModule(m){
    const p = (m.power_w!=null) ? `${m.power_w}W` : "W ë¯¸ì •";
    const pr = (m.price_won_per_w!=null) ? `${m.price_won_per_w}ì›/W` : "ë‹¨ê°€ ë¯¸ì •";
    const eff = (m.efficiency_pct!=null) ? `${m.efficiency_pct}%` : "íš¨ìœ¨ ë¯¸ì •";
    const bi = m.is_bifacial ? "ì–‘ë©´" : "ë‹¨ë©´";
    return `${m.no}. ${m.brand} ${m.model} Â· ${p} Â· ${pr} Â· ${eff} Â· ${bi}`;
  }

  function optionLabelInv(inv){
    const cap = (inv.capacity_kw!=null) ? `${inv.capacity_kw}kW` : "kW ë¯¸ì •";
    const pr = (inv.price_won!=null)
      ? `${Number(inv.price_won).toLocaleString()}ì›`
      : ((inv.price_million_won!=null) ? `${inv.price_million_won}ë°±ë§Œì›` : "ê°€ê²© ë¯¸ì •");
    const cb = inv.is_integrated_connection_box ? "ì ‘ì†ë°˜ì¼ì²´" : "ì ‘ì†ë°˜ë³„ë„";
    return `${inv.no}. ${inv.brand} ${inv.model} Â· ${cap} Â· ${pr} Â· ${cb}`;
  }

  function applySelected(){
    const m = state.selectedModule;
    if(m){
      const mp = el("modPower");
      const pr = el("modPrice");
      if(mp && m.power_w!=null) mp.value = m.power_w;
      if(pr && m.price_won_per_w!=null) pr.value = m.price_won_per_w;

      const meta = el("moduleMeta");
      if(meta){
        const t = [m.module_type, m.features].filter(Boolean).join(" Â· ");
        meta.textContent = t;
      }
    }
    const inv = state.selectedInverter;
    if(inv){
      const cap = el("invCap");
      const price = el("invPrice");
      if(cap && inv.capacity_kw!=null) cap.value = inv.capacity_kw;
      if(price){
        if(inv.price_won!=null) price.value = inv.price_won;
        else if(inv.price_million_won!=null) price.value = Math.round(Number(inv.price_million_won) * 1_000_000);
      }

      const meta = el("inverterMeta");
      if(meta){
        const t = [inv.topology, inv.features].filter(Boolean).join(" Â· ");
        meta.textContent = t;
      }
    }

    try{ if(typeof window.reCalculate === "function") window.reCalculate(); }catch(e){}
  }

  function bindSelect(selectId, items, labelFn, onPick){
    const s = el(selectId);
    if(!s) return;
    s.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "ì„ íƒ...";
    s.appendChild(ph);

    for(const it of items){
      const opt = document.createElement("option");
      opt.value = String(it.no);
      opt.textContent = labelFn(it);
      s.appendChild(opt);
    }

    s.addEventListener("change", ()=>{
      const no = parseInt(s.value || "0", 10);
      const picked = items.find(x => x.no === no) || null;
      onPick(picked);
      applySelected();
    });
  }

  async function initHardwareDropdown(){
    if(!window.BACKEND_URL) return;

    try{
      const mod = await fetchJson(`${BACKEND_URL}/api/hardware/modules`);
      const inv = await fetchJson(`${BACKEND_URL}/api/hardware/inverters`);
      state.modules = Array.isArray(mod.items) ? mod.items : [];
      state.inverters = Array.isArray(inv.items) ? inv.items : [];

      bindSelect("moduleSelect", state.modules, optionLabelModule, (picked)=>{ state.selectedModule = picked; });
      bindSelect("inverterSelect", state.inverters, optionLabelInv, (picked)=>{ state.selectedInverter = picked; });

      // ì´ˆê¸° ì„ íƒ: í˜„ì¬ ì…ë ¥ê°’ê³¼ ê°€ì¥ ê°€ê¹Œìš´ ëª¨ë“ˆ
      const curPower = parseFloat(el("modPower")?.value || "0") || 0;
      const curPrice = parseFloat(el("modPrice")?.value || "0") || 0;

      let best = null, bestScore = Infinity;
      for(const m of state.modules){
        if(m.power_w==null || m.price_won_per_w==null) continue;
        const sc = Math.abs(m.power_w - curPower) + Math.abs(m.price_won_per_w - curPrice);
        if(sc < bestScore){ bestScore = sc; best = m; }
      }
      if(!best){
        best = state.modules.find(m => m.power_w!=null && m.price_won_per_w!=null) || null;
      }
      if(best){
        state.selectedModule = best;
        const sel = el("moduleSelect");
        if(sel) sel.value = String(best.no);
      }

      const bestInv = state.inverters.find(i => i.capacity_kw!=null) || state.inverters[0] || null;
      if(bestInv){
        state.selectedInverter = bestInv;
        const sel2 = el("inverterSelect");
        if(sel2) sel2.value = String(bestInv.no);
      }

      applySelected();
    }catch(e){
      try{ console.warn("hardware dropdown init failed:", e); }catch(_){}
    }
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", initHardwareDropdown);
  }else{
    initHardwareDropdown();
  }
})();

// -----------------------------
// Daily API usage counters (VWorld/KEPCO/LAW)
// -----------------------------
async function refreshApiUsage(){
  try{
    if(!window.BACKEND_URL) return;
    const r = await fetch(`${BACKEND_URL}/api/usage`, {credentials:"include"});
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) return;
    const d = j.data || j;
    if(el("cnt-vworld")) el("cnt-vworld").innerText = String(d.vworld ?? 0);
    if(el("cnt-public")) el("cnt-public").innerText = String(d.kepco ?? 0);
    if(el("cnt-ai")) el("cnt-ai").innerText = String(d.law ?? 0);
  }catch(e){}
}
setInterval(refreshApiUsage, 20000);
setTimeout(refreshApiUsage, 1200);


// ------------------------------
// ì„¤ì • ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° (ì‚¬ì´ë“œë°” -> ëª¨ë‹¬)
// ------------------------------
window.openSettingsModal = function() {
  try {
    var modal = document.getElementById("settingsOverlay");
    if (!modal) return;
    modal.classList.remove("hidden");
    try{ _enforceNonNegativeSettingsInputs(); }catch(e){}
    if (!modal.classList.contains("flex")) {
      modal.classList.add("flex");
    }
  } catch (e) {
    console.error("openSettingsModal failed", e);
  }
};

window.closeSettingsModal = function() {
  try {
    var modal = document.getElementById("settingsOverlay");
    if (!modal) return;
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  } catch (e) {
    console.error("closeSettingsModal failed", e);
  }
};


// ì§€ë¶•/í† ì§€ ëª¨ë“œ ì „í™˜ (í—¤ë” í† ê¸€ì—ì„œ ì‚¬ìš©)

window.setScanTargetMode = function(mode){
  try{
    // ì›ë³¸ ë¼ë””ì˜¤ ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
    var radios = document.querySelectorAll('input[name="scanTarget"]');
    if(radios && radios.length){
      radios.forEach(function(r){
        if(r && r.value === mode){
          r.checked = true;
        }else if(r){
          r.checked = false;
        }
      });
    }

    // í—¤ë” ìƒë‹¨ ëª¨ë“œ í† ê¸€ ë²„íŠ¼ ì‹œê°ì  ìƒíƒœ ë™ê¸°í™”
    var landBtn = document.getElementById("btnModeLand");
    var roofBtn = document.getElementById("btnModeRoof");
    if(landBtn && roofBtn){
      if(mode === "land"){
        landBtn.classList.add("bg-amber-500/20","text-amber-100","border-amber-400");
        landBtn.classList.remove("bg-slate-800/60","text-slate-200","border-slate-600/60");
        roofBtn.classList.add("bg-slate-800/60","text-slate-200","border-slate-600/60");
        roofBtn.classList.remove("bg-amber-500/20","text-amber-100","border-amber-400");
      }else{
        roofBtn.classList.add("bg-amber-500/20","text-amber-100","border-amber-400");
        roofBtn.classList.remove("bg-slate-800/60","text-slate-200","border-slate-600/60");
        landBtn.classList.add("bg-slate-800/60","text-slate-200","border-slate-600/60");
        landBtn.classList.remove("bg-amber-500/20","text-amber-100","border-amber-400");
      }
    }

    // ê¸°ì¡´ í† ê¸€ ë¡œì§ í˜¸ì¶œ
    if(typeof window.toggleTarget === "function"){
      window.toggleTarget();
    }
  }catch(e){
    console.error("setScanTargetMode failed", e);
  }
};


// í•˜ë‹¨ ìƒíƒœ íŒ¨ë„ ìŠ¬ë¼ì´ë“œ í† ê¸€

window.toggleBottomStatus = function(){
  try{
    var inner = document.getElementById("bottomStatusInner");
    var icon = document.getElementById("bottomStatusHandleIcon");
    if(!inner) return;
    var isOpen = inner.classList.contains("open");
    if(isOpen){
      inner.classList.remove("open");
      if(icon){ icon.classList.remove("ph-caret-down"); icon.classList.add("ph-caret-up"); }
    }else{
      inner.classList.add("open");
      if(icon){ icon.classList.remove("ph-caret-up"); icon.classList.add("ph-caret-down"); }
    }
  }catch(e){
    console.error("toggleBottomStatus failed", e);
  }
};


// AI ì¬ë¶„ì„ ì‹¤í–‰ (ì •ë°€ ë¶„ì„ ì„¹ì…˜)

// AI ì¬ë¶„ì„/ì¬ê²€í†  ì‹¤í–‰ (ì •ë°€ ë¶„ì„ ì„¹ì…˜)
// - ê¸°ì¡´ ai_analysis + PF(í† ì§€/ì„ëŒ€/ê°ê°€ìƒê°/ìš´ì˜ë¹„ ë“± ë³€ê²½ê°’)ê¹Œì§€ í•¨ê»˜ ë³´ë‚´ì„œ ì½”ë©˜íŠ¸ ê°±ì‹ 
window.retryAIAnalysis = async function(){
  try{
    if(!BACKEND_URL){
      showToast("BACKEND_URLì´ ì—†ì–´ AI ì¬ê²€í† ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      return;
    }
    const addr = (window.currentAnalysisData && window.currentAnalysisData.address) ? window.currentAnalysisData.address : (el("addressInput")?.value||"");
    if(!addr){
      showToast("ì£¼ì†Œê°€ ì—†ì–´ AI ì¬ê²€í† ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
      return;
    }

    // Ensure PF recalculated with latest UI values
    try{ window.calculateFinance(getTotalPanelCount()); }catch(e){}

    // loading UI
    try{
      const placeholder = el("legalPlaceholder");
      const loading = el("legalLoading");
      const content = el("legalContent");
      if(placeholder) placeholder.classList.add("hidden");
      if(content) content.classList.add("hidden");
      if(loading) loading.classList.remove("hidden");
      _aiBarStart();
    }catch(e){}

    const ll = getAnalysisLatLng();
    const fin = (window.currentAnalysisData && window.currentAnalysisData.finance && window.currentAnalysisData.finance.summary) ? window.currentAnalysisData.finance.summary : {};
    const aiPrev = (window.currentAnalysisData && window.currentAnalysisData.ai_analysis) ? window.currentAnalysisData.ai_analysis : null;

    const payload = {
      address: addr,
      mode: (scanTarget === "land") ? "land" : "roof",
      lat: ll.lat, lng: ll.lng,
      panel_count: getTotalPanelCount(),
      ai_prev: aiPrev,
      finance: fin,
      params: {
        land_mode: (el("landTenureMode")?.value || "BUY"),
        land_rent_monthly_won: (Number((el("landRentMonthly")?.value||"0").toString().replace(/,/g,""))||0),
        maint1_annual_won: (Number((el("pfMaintOpexAnnual")?.value||"0").toString().replace(/,/g,""))||0),
        maint2_annual_won: (Number((el("pfOtherOpexAnnual")?.value||"0").toString().replace(/,/g,""))||0),
        depr_rate_pct: (Number((el("pfDeprRatePct")?.value||"0").toString().replace(/,/g,""))||0),
        pf_principal_won: (Number((el("pfPrincipal")?.value||"0").toString().replace(/,/g,""))||0),
        pf_ltv_pct: (Number((el("pfLtvPct")?.value||"70").toString().replace(/,/g,""))||70),
        pf_loan_ratio_pct: (Number((el("pfLoanRatio")?.value||"70").toString().replace(/,/g,""))||70),
        pf_tenor_years: (Number((el("pfTenorYears")?.value||"15").toString().replace(/,/g,""))||15),
        pf_interest_rate_pct: (Number((el("pfInterestRate")?.value||"6.5").toString().replace(/,/g,""))||6.5),
      }
    };

    let r = await postJson(`${BACKEND_URL}/api/ai/review`, payload);
    if(!r.ok){
      // fallback: ê¸°ì¡´ analyze
      r = await postJson(`${BACKEND_URL}/api/ai/analyze`, {
        address: addr,
        mode: payload.mode,
        lat: payload.lat, lng: payload.lng,
        panel_count: payload.panel_count,
        setback_m: parseFloat(el("setbackDist")?.value || "0") || 0,
      });
    }
    if(!r.ok) throw new Error(`AI HTTP ${r.status}`);

    window.currentAnalysisData.ai_analysis = r.data;

    try{
      const loading = el("legalLoading");
      const content = el("legalContent");
      if(loading) loading.classList.add("hidden");
      if(content) content.classList.remove("hidden");
    }catch(e){}

    try{
      renderAIResult(r.data);
      renderAiFinal(r.data);
    }catch(e){}

    _aiBarDone();
    showToast("AI ì½”ë©˜íŠ¸ë¥¼ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤");
  }catch(e){
    console.error("retryAIAnalysis failed", e);
    try{ _aiBarDone(); }catch(_e){}
    try{ showToast("AI ì¬ê²€í†  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"); }catch(_e){}
  }
};


// ë ˆì´ì–´ ë©”ë‰´ í† ê¸€ (í´ë¦­ìœ¼ë¡œ ì—´ê³  ë‹«ê¸°)
window.toggleLayerMenu = function(ev) {
  try {
    if (ev && ev.stopPropagation) ev.stopPropagation();
    var panel = document.getElementById("layerMenuPanel");
    if (!panel) return;
    if (panel.classList.contains("hidden")) {
      panel.classList.remove("hidden");
    } else {
      panel.classList.add("hidden");
    }
  } catch (e) {
    console.error("toggleLayerMenu failed", e);
  }
};

// ë°”ê¹¥ í´ë¦­ ì‹œ ë ˆì´ì–´ íŒ¨ë„ ë‹«ê¸°
document.addEventListener("click", function (ev) {
  try {
    var panel = document.getElementById("layerMenuPanel");
    if (!panel) return;
    // ë ˆì´ì–´ ë²„íŠ¼ ë‚´ë¶€ í´ë¦­ì€ ë¬´ì‹œ
    var trigger = ev.target.closest && ev.target.closest("button[onclick*='toggleLayerMenu']");
    if (trigger) return;
    if (!panel.classList.contains("hidden")) {
      panel.classList.add("hidden");
    }
  } catch (e) {
    console.error("global click handler for layerMenuPanel failed", e);
  }
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener("keydown", function (ev) {
  try {
    if (ev.key === "Escape") {
      window.closeSettingsModal();
    }
  } catch (e) {
    console.error("ESC close modal failed", e);
  }
});
</script>


<script>
(function(){
  function hideRowByLabelText(label){
    const nodes = Array.from(document.querySelectorAll("*")).filter(n=>{
      const t = (n.textContent||"").trim();
      return t === label || t.startsWith(label);
    });
    for(const n of nodes){
      let row = n.closest("div");
      for(let i=0;i<7 && row; i++){
        const txt = (row.textContent||"").trim();
        if(txt.includes(label) && txt.length < 260){
          row.style.display = "none";
          break;
        }
        row = row.parentElement;
      }
    }
  }
  function apply(){
    hideRowByLabelText("PFê¸°ê°„ ìˆœí˜„ê¸ˆ(ëˆ„ì )");
    hideRowByLabelText("25ë…„ ìˆœí˜„ê¸ˆ(ëˆ„ì )");
    hideRowByLabelText("ê¶Œì¥ ëŒ€ì¶œê¸ˆ");
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", apply);
  else apply();
})();
</script>

</body>
</html
  // -----------------------------
  // Click UX: always show a temporary candidate immediately
  // -----------------------------
  let __tempCandidateLayer = null;
  function drawTemporaryCandidate(lat, lng){
    try{
      if(!window.map) return;
      if(__tempCandidateLayer){
        try{ window.map.removeLayer(__tempCandidateLayer); }catch(e){}
        __tempCandidateLayer = null;
      }
      __tempCandidateLayer = L.circle([lat,lng], { radius: 45, weight: 2, fillOpacity: 0.18 });
      __tempCandidateLayer.addTo(window.map);
    }catch(e){}
  }
>
