<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solar Pathfinder</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  html,body,#map{margin:0;width:100%;height:100%}
  #log{position:absolute;left:0;bottom:0;width:100%;max-height:160px;
    background:#020617;color:#94a3b8;font-family:monospace;
    font-size:11px;overflow:auto;padding:6px;z-index:9999}
</style>
</head>

<body>
<div id="map"></div>

<!-- Top UI -->
<div class="absolute top-4 left-1/2 -translate-x-1/2 z-[3000] w-[680px] max-w-[92vw]">
  <div class="bg-white/95 backdrop-blur shadow-xl border border-slate-200 rounded-xl p-3 flex flex-col gap-2">
    <div class="flex items-center gap-2">
      <input id="addr" class="flex-1 border rounded-lg px-3 py-2 text-sm outline-none"
             placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123) â†’ Enter"
             onkeypress="if(event.key==='Enter') window.searchAddress()"/>
      <button class="bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg px-4 py-2 text-sm font-bold"
              onclick="window.searchAddress()">ê²€ìƒ‰</button>

      <div class="flex items-center gap-1 ml-2">
        <span class="text-xs text-slate-500 font-bold">feat</span>
        <span id="featBadge" class="text-xs font-mono bg-slate-900 text-amber-300 px-2 py-1 rounded">-</span>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <!-- Mode Toggle -->
      <div class="flex items-center gap-2">
        <span class="text-xs font-bold text-slate-600">ëª¨ë“œ</span>
        <label class="cursor-pointer">
          <input type="radio" name="mode" value="roof" class="peer hidden" checked onchange="window.setMode(this.value)">
          <span class="px-3 py-1.5 rounded-lg border bg-white peer-checked:bg-pink-50 peer-checked:border-pink-400 peer-checked:text-pink-700 text-xs font-bold">
            ğŸ­ ì§€ë¶•(Roof)
          </span>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="mode" value="land" class="peer hidden" onchange="window.setMode(this.value)">
          <span class="px-3 py-1.5 rounded-lg border bg-white peer-checked:bg-amber-50 peer-checked:border-amber-400 peer-checked:text-amber-800 text-xs font-bold">
            ğŸŒ² í† ì§€(Land)
          </span>
        </label>
      </div>

      <div class="h-6 w-px bg-slate-200 mx-1"></div>

      <!-- Setback -->
      <div class="flex items-center gap-2">
        <span class="text-xs font-bold text-slate-600">Setback(m)</span>
        <input id="setback" type="number" value="0" step="0.5"
               class="w-24 border rounded-lg px-2 py-1.5 text-sm font-bold text-red-600"
               onchange="window.recalcPanels()"
               oninput="window.recalcPanels()"/>
        <span class="text-[11px] text-slate-500">ê°’ ë³€ê²½ ì¦‰ì‹œ ì¬ê³„ì‚°</span>
      </div>

      <div class="h-6 w-px bg-slate-200 mx-1"></div>

      <!-- Panel Output -->
      <div class="flex items-center gap-3">
        <div class="text-xs">
          <span class="text-slate-500 font-bold">íŒ¨ë„</span>
          <span id="outPanels" class="font-mono font-bold text-slate-900">0</span>
        </div>
        <div class="text-xs">
          <span class="text-slate-500 font-bold">ìš©ëŸ‰(kW)</span>
          <span id="outKw" class="font-mono font-bold text-cyan-700">0.0</span>
        </div>
        <div class="text-xs">
          <span class="text-slate-500 font-bold">ìƒíƒœ</span>
          <span id="outStatus" class="font-mono font-bold text-emerald-700">READY</span>
        </div>
      </div>
    </div>

    <div class="text-[11px] text-slate-500">
      ì§€ë„ í´ë¦­ â†’ ì£¼ë³€ í”¼ì²˜ ê²€ìƒ‰ â†’ í”¼ì²˜ í´ë¦­(ìœ¤ê³½ì„ ) â†’ íŒŒë€ íŒ¨ë„ ìë™ ìƒì„±
    </div>
  </div>
</div>

<div id="log">SYSTEM READY</div>

<script>
/* =================================================
   Solar Pathfinder â€“ Step 2 (F-4, F-5, F-8, F-9)
   - FULL single HTML
   ================================================= */

const VWORLD_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";
const FEATURE_LEVEL = Number(new URLSearchParams(location.search).get("feat")||3);
document.getElementById("featBadge").innerText = String(FEATURE_LEVEL);

// ---- Backend discovery (optional, for later) ----
(function(){
  try{
    const qs=new URLSearchParams(location.search||"");
    const b=qs.get("backend");
    if(b){ window.BACKEND_URL = decodeURIComponent(b).replace(/\/$/,""); }
  }catch(e){}
  if(typeof window.BACKEND_URL!=="string") window.BACKEND_URL="";
})();
const BACKEND_URL = window.BACKEND_URL || "";

// ---- Map ----
let map = L.map("map").setView([36.5,127.5],7);
L.control.zoom({position:"bottomright"}).addTo(map);

let baseSat = L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_KEY}/Satellite/{z}/{y}/{x}.jpeg`);
baseSat.addTo(map);

let selectableLayer = L.layerGroup().addTo(map);
let panelLayer = L.layerGroup().addTo(map);
let clickMarker = null;

let currentMode = "roof"; // roof | land
let lastFeatureGeometry = null; // for setback recalc
let lastDrawSource = "NONE";
let lastPanelCount = 0;

// ---- UI helpers ----
function log(m){
  const el=document.getElementById("log");
  el.innerHTML+=`<div>> ${m}</div>`;
  el.scrollTop=el.scrollHeight;
}
function setStatus(s, kind="ok"){
  const el=document.getElementById("outStatus");
  el.textContent = s;
  el.className = "font-mono font-bold " + (kind==="bad" ? "text-red-700" : kind==="warn" ? "text-amber-700" : "text-emerald-700");
}
function setOut(count){
  document.getElementById("outPanels").textContent = String(count);
  // 640W ê¸°ì¤€ (ì„ì‹œ). ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì…ë ¥ê°’ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥.
  const kw = (count * 640) / 1000;
  document.getElementById("outKw").textContent = kw.toFixed(1);
}

// ---- JSONP ----
function jsonp(url){
  return new Promise((res,rej)=>{
    const cb="cb_"+Date.now()+"_"+Math.random().toString(36).slice(2);
    window[cb]=(d)=>{ res(d); delete window[cb]; script.remove(); };
    const script=document.createElement("script");
    script.src=url+`&format=json&callback=${cb}&domain=${location.hostname}`;
    script.onerror=()=>{ delete window[cb]; script.remove(); rej(new Error("JSONP failed")); };
    document.body.appendChild(script);
  });
}

// ---- F-5 Mode ----
window.setMode = function(v){
  if(FEATURE_LEVEL < 2){
    setStatus("feat<2 ëª¨ë“œì „í™˜ ë¹„í™œì„±","warn");
    return;
  }
  currentMode = (v==="land") ? "land" : "roof";
  selectableLayer.clearLayers();
  panelLayer.clearLayers();
  lastFeatureGeometry = null;
  setOut(0);
  setStatus("MODE: "+currentMode.toUpperCase(),"ok");
  log("Mode switched => "+currentMode);
};

// ---- F-4 Address Search ----
window.searchAddress = async function(){
  if(FEATURE_LEVEL < 1){
    setStatus("feat<1 ì£¼ì†Œê²€ìƒ‰ ë¹„í™œì„±","warn");
    return;
  }
  const q = (document.getElementById("addr").value || "").trim();
  if(!q){ setStatus("ì£¼ì†Œ ì…ë ¥ í•„ìš”","warn"); return; }

  setStatus("ì£¼ì†Œê²€ìƒ‰...","ok");
  try{
    const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(q)}&refine=true&simple=false&type=road&key=${VWORLD_KEY}`;
    const d = await jsonp(url);
    if(d?.response?.status === "OK"){
      const {x,y} = d.response.result.point;
      const lat = parseFloat(y), lng = parseFloat(x);
      map.setView([lat,lng],18);
      setStatus("ì£¼ì†Œ ì´ë™ ì™„ë£Œ","ok");
      log(`Address OK => (${lat},${lng})`);
      // ì£¼ì†Œ ì´ë™ í›„ ìë™ ìŠ¤ìº”(ì›í•˜ë©´)
      await new Promise(r=>setTimeout(r,350));
      await scan(lat,lng);
    }else{
      setStatus("ì£¼ì†Œ ê²°ê³¼ ì—†ìŒ","warn");
      log("Address NOT FOUND");
    }
  }catch(e){
    setStatus("ì£¼ì†Œê²€ìƒ‰ ì˜¤ë¥˜","bad");
    log("Address error: "+e.message);
  }
};

// ---- Scan around point (VWorld feature) ----
async function scan(lat,lng){
  selectableLayer.clearLayers();
  panelLayer.clearLayers();
  setOut(0);
  lastFeatureGeometry = null;

  if(clickMarker) map.removeLayer(clickMarker);
  clickMarker = L.marker([lat,lng]).addTo(map);

  const box=`${lng-0.001},${lat-0.001},${lng+0.001},${lat+0.001}`;
  const dataLayer = (currentMode==="land") ? "LP_PA_CBND_BUBUN" : "LT_C_SPBD";
  const url=`https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${dataLayer}&key=${VWORLD_KEY}&geomFilter=BOX(${box})&size=20`;

  setStatus("ìŠ¤ìº”ì¤‘...","ok");
  try{
    const d = await jsonp(url);
    const fs = d?.response?.result?.featureCollection?.features || [];
    log(`scan(${currentMode}) => ${fs.length} features`);

    if(fs.length===0){
      setStatus("í”¼ì²˜ ì—†ìŒ","warn");
      return;
    }

    // draw selectable outlines
    L.geoJSON(fs,{
      style: currentMode==="land"
        ? {color:"#a16207",weight:2,fillOpacity:.15}
        : {color:"#06b6d4",weight:2,fillOpacity:.15},
      onEachFeature:(f,l)=>{
        l.on("click",()=>{
          // í´ë¦­í•œ í”¼ì²˜ì˜ geometryë¡œ íŒ¨ë„ ìƒì„±
          drawPanelsFromFeature(f);
        });
      }
    }).addTo(selectableLayer);

    setStatus("í”¼ì²˜ í´ë¦­í•´ì„œ íŒ¨ë„ ìƒì„±","ok");
  }catch(e){
    setStatus("ìŠ¤ìº” ì˜¤ë¥˜","bad");
    log("scan error: "+e.message);
  }
}

// ---- Click on map triggers scan (feat>=3 recommended) ----
map.on("click",(e)=>{
  if(FEATURE_LEVEL < 3){
    setStatus("feat<3 ì§€ë„í´ë¦­ ìŠ¤ìº” ë¹„í™œì„±(ê²€ìƒ‰/í”¼ì²˜í´ë¦­ë§Œ)","warn");
    return;
  }
  scan(e.latlng.lat, e.latlng.lng);
});

// ---- F-8 / F-9 Setback + Recalc ----
window.recalcPanels = function(){
  if(FEATURE_LEVEL < 3){
    setStatus("feat<3 setback ì¬ê³„ì‚° ë¹„í™œì„±","warn");
    return;
  }
  if(!lastFeatureGeometry){
    setStatus("ì„ íƒëœ í”¼ì²˜ ì—†ìŒ","warn");
    return;
  }
  drawPanels(lastFeatureGeometry);
};

// ---- Feature -> Panels ----
function drawPanelsFromFeature(feature){
  const geo = feature?.geometry;
  if(!geo){
    setStatus("ì§€ì˜¤ë©”íŠ¸ë¦¬ ì—†ìŒ","bad");
    log("NO GEOMETRY in feature");
    return;
  }
  lastFeatureGeometry = geo;
  drawPanels(geo);
}

// ---- PANEL CORE (robust) ----
function drawPanels(geo){
  panelLayer.clearLayers();

  if(!geo){
    setStatus("ì§€ì˜¤ë©”íŠ¸ë¦¬ ì—†ìŒ","bad");
    log("NO GEOMETRY");
    return;
  }

  let panelsFC;
  try{
    if(geo.type==="Polygon" || geo.type==="MultiPolygon"){
      panelsFC = gridFromPolygonWithSetback(geo);
      lastDrawSource = "POLY";
    } else {
      panelsFC = fallbackPanels(geo);
      lastDrawSource = "FALLBACK-NONPOLY";
    }
  }catch(e){
    panelsFC = fallbackPanels(geo);
    lastDrawSource = "FALLBACK-ERROR";
    log("drawPanels error => fallback: "+e.message);
  }

  L.geoJSON(panelsFC,{
    style:{
      color:"#1e3a8a",
      fillColor:"#3b82f6",
      fillOpacity:0.75,
      weight:1
    }
  }).addTo(panelLayer);

  const n = panelsFC.features.length;
  lastPanelCount = n;
  setOut(n);

  if(lastDrawSource.startsWith("FALLBACK")){
    setStatus(`íŒ¨ë„ ${n} (fallback)`, "warn");
  }else{
    setStatus(`íŒ¨ë„ ${n} (OK)`, "ok");
  }
  log(`PANELS DRAWN: ${n} / source=${lastDrawSource}`);
}

// ---- Polygon Grid + Setback ----
function gridFromPolygonWithSetback(geo){
  const setback = Math.max(0, parseFloat(document.getElementById("setback").value || "0") || 0);

  let poly = turf.feature(geo);

  // F-8: setback shrink
  if(setback > 0){
    try{
      const buf = turf.buffer(poly, -setback, {units:"meters"});
      // ë„ˆë¬´ ì»¤ì„œ ì‚¬ë¼ì§€ëŠ” ì¼€ì´ìŠ¤ -> fallback (íŒ¨ë„ 0 ëŒ€ì‹  í…ŒìŠ¤íŠ¸ íŒ¨ë„)
      if(!buf || !buf.geometry){
        log("Setback too large => polygon vanished");
        throw new Error("Setback too large");
      }
      poly = buf;
    }catch(e){
      // buffer ì‹¤íŒ¨ëŠ” fallbackìœ¼ë¡œ ë³´ì´ê²Œ ì²˜ë¦¬
      throw e;
    }
  }

  const bbox = turf.bbox(poly);
  const lat=(bbox[1]+bbox[3])/2;
  const mpdLng=111320*Math.cos(lat*Math.PI/180);
  const mpdLat=111000;

  // íŒ¨ë„ ê·œê²©(ì„ì‹œ ê³ ì •)
  const modWm = 1.13;
  const modHm = 2.2;

  const w=modWm/mpdLng;
  const h=modHm/mpdLat;

  const features=[];
  let guard=0;
  const MAX=40000;

  for(let x=bbox[0]; x<bbox[2]; x+=w*1.2){
    for(let y=bbox[1]; y<bbox[3]; y+=h*1.2){
      if(guard++>MAX) break;
      const c=turf.point([x+w/2,y+h/2]);
      // polygon ë‚´ë¶€ë§Œ íŒ¨ë„ ìƒì„±
      if(turf.booleanPointInPolygon(c, poly)){
        features.push(turf.bboxPolygon([x,y,x+w,y+h]));
      }
    }
  }

  if(features.length===0){
    // ë‚´ë¶€ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ ì—ëŸ¬ë¡œ ë³´ë‚´ì„œ fallback ìƒì„±
    throw new Error("Grid empty");
  }
  return {type:"FeatureCollection",features};
}

// ---- fallback (always visible) ----
function fallbackPanels(geo){
  let bbox;
  try{
    bbox=turf.bbox(turf.feature(geo));
  }catch{
    const c=map.getCenter();
    bbox=[c.lng-0.0004,c.lat-0.0004,c.lng+0.0004,c.lat+0.0004];
  }

  const lat=(bbox[1]+bbox[3])/2;
  const mpdLng=111320*Math.cos(lat*Math.PI/180);
  const mpdLat=111000;

  const w=1.13/mpdLng;
  const h=2.2/mpdLat;

  const fs=[];
  for(let i=0;i<3;i++){
    for(let j=0;j<3;j++){
      const x=bbox[0]+i*w*1.3;
      const y=bbox[1]+j*h*1.3;
      fs.push(turf.bboxPolygon([x,y,x+w,y+h]));
    }
  }
  return {type:"FeatureCollection",features:fs};
}

// init
setStatus("READY","ok");
log("READY feat="+FEATURE_LEVEL+" mode="+currentMode);
</script>
</body>
</html>
