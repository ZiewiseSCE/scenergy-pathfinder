<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 보안 정책: 외부 리소스 허용 -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy 태양광 채굴기</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☀️</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/proj4@2.9.1/dist/proj4.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.10.0/src/leaflet.geometryutil.js"></script>
    <script src="https://unpkg.com/leaflet-path-drag@0.0.6/src/Path.Drag.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
    <script src="https://unpkg.com/leaflet-fullscreen@3.0.0/Control.FullScreen.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen@3.0.0/Control.FullScreen.css" />
    <script src="https://unpkg.com/leaflet-contextmenu@1.4.0/dist/leaflet.contextmenu.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-contextmenu@1.4.0/dist/leaflet.contextmenu.css" />
    <script src="https://unpkg.com/leaflet-measure-path@1.1.0/leaflet-measure-path.js"></script>
    <script src="https://unpkg.com/leaflet-side-by-side@2.0.0/leaflet-side-by-side.min.js"></script>
    <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>
    <script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css" />
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
        color: #e5e7eb;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .leaflet-container {
        background: #020617;
      }
      .sidebar {
        transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
      }
      .sidebar-hidden {
        transform: translateX(-100%);
        box-shadow: none;
        opacity: 0;
        pointer-events: none;
      }
      .tab-btn.active {
        border-bottom: 2px solid #0f766e;
        color: #0f172a;
        font-weight: 600;
        background-color: #e0f2fe;
      }
      .panel-handle {
        cursor: move;
      }
      .floating-panel {
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        background: linear-gradient(135deg, rgba(15,23,42,0.94), rgba(15,23,42,0.86));
        border-radius: 1.25rem;
        border: 1px solid rgba(148,163,184,0.55);
        box-shadow: 0 22px 60px rgba(15,23,42,0.95);
      }
      .floating-panel-header {
        cursor: move;
        user-select: none;
      }
      .leaflet-control-attribution {
        font-size: 10px;
        background: rgba(15,23,42,0.8);
        color: #cbd5f5;
      }
      .toast {
        position: fixed;
        z-index: 9999;
        bottom: 16px;
        right: 16px;
        background: rgba(15,23,42,0.95);
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #e5e7eb;
        box-shadow: 0 18px 45px rgba(0,0,0,0.55);
        border: 1px solid rgba(148,163,184,0.7);
      }
      .toast i {
        color: #22c55e;
      }
      .marker-label {
        background: rgba(15,23,42,0.92);
        color: #e5e7eb;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 10px;
        box-shadow: 0 0 0 1px rgba(148,163,184,0.7), 0 12px 25px rgba(15,23,42,0.9);
      }
      .zoom-indicator {
        position: absolute;
        bottom: 12px;
        right: 12px;
        font-size: 11px;
        background: rgba(15,23,42,0.82);
        border-radius: 999px;
        padding: 4px 8px;
        color: #cbd5f5;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid rgba(148,163,184,0.7);
        box-shadow: 0 14px 35px rgba(0,0,0,0.75);
        pointer-events: none;
      }
      .zoom-indicator .dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34,197,94,0.45);
      }
      .zoom-indicator .pill {
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(15,23,42,0.9);
        border: 1px solid rgba(148,163,184,0.6);
      }
      .leaflet-control-zoom {
        border-radius: 999px !important;
        overflow: hidden;
        border: 1px solid rgba(148,163,184,0.9) !important;
        box-shadow: 0 18px 45px rgba(15,23,42,0.95);
      }
      .leaflet-control-zoom a {
        background: rgba(15,23,42,0.96);
        color: #e5e7eb;
        border: none !important;
      }
      .leaflet-control-zoom a:hover {
        background: rgba(30,64,175,0.95);
      }
      .leaflet-bar a {
        color: #e5e7eb;
      }
      .leaflet-control-scale-line {
        background: rgba(15,23,42,0.96);
        color: #e5e7eb;
        border-color: rgba(148,163,184,0.7);
      }
      .markercluster-small {
        background-color: rgba(56,189,248,0.2);
      }
      .markercluster-small div {
        background-color: rgba(56,189,248,0.9);
      }
      .markercluster-medium {
        background-color: rgba(52,211,153,0.2);
      }
      .markercluster-medium div {
        background-color: rgba(52,211,153,0.9);
      }
      .markercluster-large {
        background-color: rgba(251,191,36,0.2);
      }
      .markercluster-large div {
        background-color: rgba(251,191,36,0.9);
      }
      .markercluster div {
        color: white;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(15,23,42,0.9);
      }
      .ph {
        vertical-align: middle;
      }
      .pill-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 10px;
        border: 1px solid rgba(148,163,184,0.7);
        background: radial-gradient(circle at top left, rgba(56,189,248,0.35), rgba(15,23,42,0.95));
        box-shadow: 0 12px 30px rgba(15,23,42,0.9);
      }
      .heatmap-legend {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .heatmap-legend-bar {
        width: 96px;
        height: 8px;
        border-radius: 999px;
        background: linear-gradient(to right, #0ea5e9, #22c55e, #facc15, #f97316, #ef4444);
        box-shadow: 0 0 0 1px rgba(15,23,42,0.95), 0 12px 25px rgba(15,23,42,0.9);
      }
      .heatmap-legend-label {
        font-size: 9px;
        color: #e5e7eb;
      }
      .glass {
        background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 1.25rem;
        border: 1px solid rgba(148,163,184,0.8);
        box-shadow: 0 24px 70px rgba(15,23,42,0.98);
      }
      .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #22c55e, #15803d);
      }
      .btn-soft {
        background: rgba(15,23,42,0.9);
        border: 1px solid rgba(148,163,184,0.7);
      }
      .btn-soft:hover {
        background: rgba(30,64,175,0.95);
        border-color: rgba(129,140,248,0.95);
      }
      .shadow-inner-strong {
        box-shadow: inset 0 0 0 1px rgba(148,163,184,0.5), 0 0 0 1px rgba(15,23,42,0.8);
      }
      .title-gradient {
        background: radial-gradient(circle at 0 0, rgba(56,189,248,0.4), transparent), radial-gradient(circle at 100% 100%, rgba(34,197,94,0.4), transparent), linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
        box-shadow: 0 24px 60px rgba(15,23,42,0.95);
      }
      .title-gradient * {
          position: relative;
      }

  /* Crystal glass effect for 상세 설정 사이드바 */
  .crystal-panel {
    background:
      radial-gradient(circle at 0% 0%, rgba(56,189,248,0.16), transparent 55%),
      radial-gradient(circle at 100% 100%, rgba(129,140,248,0.18), transparent 55%),
      linear-gradient(135deg, rgba(15,23,42,0.90), rgba(15,23,42,0.72));
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-right: 1px solid rgba(148,163,184,0.55);
    box-shadow: 0 25px 80px rgba(15,23,42,0.85);
    animation: crystalGradient 18s ease-in-out infinite;
    background-size: 200% 200%;
  }

  @keyframes crystalGradient {
    0%   { background-position: 0% 0%; }
    50%  { background-position: 100% 100%; }
    100% { background-position: 0% 0%; }
  }

  /* 분석 파라미터 아코디언 애니메이션 */
  details.crystal-accordion > summary {
    cursor: pointer;
    transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  }
  details.crystal-accordion[open] > summary {
    box-shadow: 0 0 0 1px rgba(129,140,248,0.5), 0 14px 40px rgba(15,23,42,0.9);
  }
  details.crystal-accordion .param-body {
    overflow: hidden;
    animation: accordionDown 0.22s ease-out;
  }

  @keyframes accordionDown {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
    </style>
</head>
<body class="relative overflow-hidden">
    <div id="app" class="w-screen h-screen relative">
        <!-- 메인 컨테이너 -->
        <div class="w-full h-full flex flex-col md:flex-row bg-gradient-to-b from-slate-900/90 via-slate-950 to-black">
            <!-- 지도 영역 -->
            <div class="relative flex-1 min-h-[320px]">
                <div id="map" class="w-full h-full rounded-none md:rounded-r-[2rem] overflow-hidden"></div>
                <!-- 줌 인디케이터 -->
                <div id="zoomIndicator" class="zoom-indicator hidden">
                    <span class="dot"></span>
                    <span class="pill">
                      <span class="text-[10px] text-slate-300">Zoom</span>
                      <span id="zoomLevel" class="font-semibold text-xs text-sky-200">-</span>
                    </span>
                    <span class="text-[10px] text-slate-400 flex items-center gap-1">
                      <i class="ph ph-magnifying-glass"></i> <span id="zoomHint">위성 확대 추천</span>
                    </span>
                </div>
            </div>

            <!-- 우측 설정/결과 패널 -->
            <div class="relative w-full md:w-[420px] lg:w-[480px] xl:w-[520px] flex items-stretch overflow-y-auto pt-4 pb-4">
            <!-- 사이드바 -->
                <div id="sidebar" class="sidebar crystal-panel absolute top-0 left-0 md:static w-full md:w-full max-w-[520px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
                    <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
                        <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy 태양광 채굴기</h1>






                    </div>
                    <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
                        <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>전수 스캔</button>
                        <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>정밀 분석</button>
                        <button type="button" onclick="window.switchTab('report')" id="tab-report" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>종합 리포트</button>
                        <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>기록</button>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-slate-50">
                        <!-- 설정 패널 (아코디언) -->
                        <div class="p-4 pb-0">
                            <details class="bg-white crystal-accordion rounded-lg border border-slate-200 shadow-sm group mb-4">
                                <summary class="p-3 text-xs font-semibold text-slate-700 flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg">
                                    <span class="flex items-center gap-2">
                                      <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-100 text-sky-600 border border-sky-300">
                                        <i class="ph ph-sliders-horizontal text-[11px]"></i>
                                      </span>
                                      <span>분석 파라미터</span>
                                    </span>
                                    <span class="flex items-center gap-2 text-[11px] text-slate-500">
                                      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50">
                                        <i class="ph ph-magic-wand text-[11px] text-emerald-500"></i>
                                        <span class="text-[10px]">AI 권장</span>
                                      </span>
                                      <i class="ph ph-caret-down group-open:rotate-180 transition"></i>
                                    </span>
                                </summary>
                                <div class="param-body p-3 space-y-3 border-t border-gray-200 text-xs">
                                    <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                                         <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">설치 모드</label>
                                                <select id="scanMode" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 bg-white">
                                                    <option value="roof">지붕(건축물) 모드</option>
                                                    <option value="land">토지 모드</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">스캔 해상도</label>
                                                <select id="scanResolution" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 bg-white">
                                                    <option value="normal">일반 (빠름)</option>
                                                    <option value="high">고해상도 (중간)</option>
                                                    <option value="ultra">초고해상도 (느림)</option>
                                                </select>
                                            </div>
                                          </div>
                                          <p class="mt-1 text-[10px] text-slate-600 flex items-center gap-1">
                                            <i class="ph ph-info text-[11px] text-sky-600"></i>
                                            <span>모드와 해상도는 설치 가능 영역 탐지 정확도에 영향을 줍니다.</span>
                                          </p>
                                    </div>

                                    <!-- 기본 설치 파라미터 -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">패널 간격(가로, m)</label>
                                            <input type="number" id="panelGapX" aria-label="패널 간격 가로(m)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="0.1" step="0.1" value="0.1" onchange="window.reCalculate()">
                                        </div>
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">패널 간격(세로, m)</label>
                                            <input type="number" id="panelGapY" aria-label="패널 간격 세로(m)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="0.1" step="0.1" value="0.1" onchange="window.reCalculate()">
                                        </div>
                                    </div>

                                    <!-- [F-8] 이격거리(Setback) 추가 -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">건물 가장자리 이격거리(m)</label>
                                            <input type="number" id="setbackEdge" aria-label="이격거리(가장자리)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="0.5" step="0.1" value="0.5" onchange="window.reCalculate()">
                                        </div>
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">장애물 이격거리(m)</label>
                                            <input type="number" id="setbackObstacle" aria-label="이격거리(장애물)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="0.3" step="0.1" value="0.3" onchange="window.reCalculate()">
                                        </div>
                                    </div>

                                    <!-- ✅ 기자재 선택 (DB 연동) -->
                                    <div class="bg-white/60 p-2 rounded border border-slate-200">
                                      <div class="grid grid-cols-2 gap-2">
                                        <div>
                                          <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">모듈 선택</label>
                                          <select id="moduleSelect" class="w-full border p-1 rounded text-[11px] text-slate-900"></select>
                                          <div class="text-[10px] text-slate-500 mt-1" id="moduleMeta"></div>
                                        </div>
                                        <div>
                                          <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">인버터 선택</label>
                                          <select id="inverterSelect" class="w-full border p-1 rounded text-[11px] text-slate-900"></select>
                                          <div class="text-[10px] text-slate-500 mt-1" id="inverterMeta"></div>
                                        </div>
                                      </div>
                                      <!-- 기존 계산 로직 호환용(숨김) -->
                                      <input type="hidden" id="invCap" value="">
                                      <input type="hidden" id="invPrice" value="">
                                    </div>

                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">패널 출력(W)</label>
                                            <input type="number" id="modPower" aria-label="모듈 출력(W)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="450" value="450" onchange="window.reCalculate()">
                                        </div>
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">패널 면적(m²)</label>
                                            <input type="number" id="modArea" aria-label="모듈 면적(m²)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="2.2" step="0.01" value="2.2" onchange="window.reCalculate()">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">인버터 효율(%)</label>
                                            <input type="number" id="invEff" aria-label="인버터 효율(%)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="98" value="98" onchange="window.reCalculate()">
                                        </div>
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">시스템 손실(%)</label>
                                            <input type="number" id="lossRate" aria-label="시스템 손실(%)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="10" value="10" onchange="window.reCalculate()">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">연간 일사량(kWh/m²)</label>
                                            <input type="number" id="solarIrradiance" aria-label="연간 일사량(kWh/m²)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="1400" value="1400" onchange="window.reCalculate()">
                                        </div>
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">용량계수(%)</label>
                                            <input type="number" id="capacityFactor" aria-label="용량계수(%)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="15" value="15" onchange="window.reCalculate()">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">경사각(°)</label>
                                            <input type="number" id="tiltAngle" aria-label="경사각(°)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="20" value="20" onchange="window.reCalculate()">
                                        </div>
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-700 font-bold">방위각(° / 남향=180)</label>
                                            <input type="number" id="azimuth" aria-label="방위각(°)" class="w-full border border-slate-300 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="180" value="180" onchange="window.reCalculate()">
                                        </div>
                                    </div>

                                    <!-- 금융 파라미터 -->
                                    <div class="bg-emerald-50/70 p-2 rounded border border-emerald-100">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-1">
                                                <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-emerald-500 text-white text-[10px]">
                                                    <i class="ph ph-coins"></i>
                                                </span>
                                                <span class="text-[11px] font-bold text-emerald-800">PF 금융 파라미터</span>
                                            </div>
                                            <button type="button" onclick="window.applyBankPreset('local_bank')" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full border border-emerald-300 bg-emerald-100 text-[10px] text-emerald-800">
                                                <i class="ph ph-magic-wand text-[11px]"></i>
                                                <span>국내 은행 기준</span>
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-800 font-semibold">대출 비율(%)</label>
                                                <input type="number" id="loanRatio" aria-label="대출 비율(%)" class="w-full border border-emerald-200 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="80" value="80" onchange="window.reCalculateFinance()">
                                            </div>
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-800 font-semibold">대출 금리(연, %)</label>
                                                <input type="number" id="loanRate" aria-label="대출 금리(연, %)" class="w-full border border-emerald-200 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="5.5" step="0.01" value="5.5" onchange="window.reCalculateFinance()">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mt-1">
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-800 font-semibold">대출 기간(년)</label>
                                                <input type="number" id="loanYears" aria-label="대출 기간(년)" class="w-full border border-emerald-200 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="18" value="18" onchange="window.reCalculateFinance()">
                                            </div>
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-800 font-semibold">상환 방식</label>
                                                <select id="repaymentType" class="w-full border border-emerald-200 rounded px-1 py-1 text-[11px] text-slate-900 bg-white" onchange="window.reCalculateFinance()">
                                                    <option value="level">원리금 균등분할상환</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 mt-1">
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-800 font-semibold">기준 SMP (원/kWh)</label>
                                                <input type="number" id="smpPrice" aria-label="SMP (원/kWh)" class="w-full border border-emerald-200 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="110" value="110" onchange="window.reCalculateFinance()">
                                            </div>
                                            <div>
                                                <label class="block mb-0.5 text-[10px] text-slate-800 font-semibold">REC 단가 (원/kWh)</label>
                                                <input type="number" id="recPrice" aria-label="REC 단가 (원/kWh)" class="w-full border border-emerald-200 rounded px-1 py-1 text-[11px] text-slate-900 placeholder-slate-400" placeholder="65" value="65" onchange="window.reCalculateFinance()">
                                            </div>
                                        </div>
                                        <p class="mt-1 text-[10px] text-emerald-700 flex items-center gap-1">
                                            <i class="ph ph-info text-[11px] text-emerald-600"></i>
                                            <span>PF 심사 기준에 맞춰 원리금 균등분할상환 방식으로 계산합니다.</span>
                                        </p>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- 전수 스캔 탭 -->
                        <div id="tabContent-scan" class="tab-content block">
                            <div class="p-4 space-y-3">
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-900 text-amber-300 shadow-inner-strong">
                                                <i class="ph ph-radar text-[15px]"></i>
                                            </span>
                                            <div>
                                                <div class="text-xs font-semibold text-slate-800">설치 가능 영역 전수 스캔</div>
                                                <div class="text-[10px] text-slate-500">지도에서 클릭한 지붕/토지 기준으로 설치 가능 영역을 자동 탐지합니다.</div>
                                            </div>
                                        </div>
                                        <button type="button" onclick="window.runFullScan()" class="btn-primary px-3 py-1.5 rounded-full text-[11px] inline-flex items-center gap-1 shadow-lg">
                                            <i class="ph ph-play-circle text-[14px]"></i>
                                            <span>전수 스캔</span>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 text-[11px] text-slate-700 mt-2">
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">탐지 면적</div>
                                            <div class="text-xs font-semibold text-slate-900" id="scanAreaDisplay">-</div>
                                        </div>
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">설치 패널 수</div>
                                            <div class="text-xs font-semibold text-slate-900" id="scanPanelCount">-</div>
                                        </div>
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">예상 용량(kW)</div>
                                            <div class="text-xs font-semibold text-slate-900" id="scanCapacityKw">-</div>
                                        </div>
                                    </div>
                                    <p class="mt-2 text-[10px] text-slate-500 flex items-center gap-1">
                                        <i class="ph ph-info text-[11px] text-sky-500"></i>
                                        <span>지붕 모드에서는 건물 지붕을 클릭, 토지 모드에서는 빈 토지 영역을 클릭해 주십시오.</span>
                                    </p>
                                </div>

                                <!-- 설치 가능 지붕/토지 선택 안내 -->
                                <div class="bg-slate-900 rounded-xl border border-slate-700 p-3 text-xs text-slate-100 shadow-inner-strong">
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-amber-400 text-slate-900">
                                                <i class="ph ph-lightning text-[12px]"></i>
                                            </span>
                                            <span class="font-semibold text-[11px]">클릭해서 설치 가능 영역 자동 찾기</span>
                                        </div>
                                    </div>
                                    <p class="text-[10px] text-slate-300">
                                        지도에서 설치 후보 지붕 또는 토지를 선택하면, 해당 폴리곤 영역을 기반으로 패널을 자동 배치합니다. 장애물이 있는 복잡한 지붕도 전수 스캔으로 빠르게 검토할 수 있습니다.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 정밀 분석 탭 -->
                        <div id="tabContent-analysis" class="tab-content hidden">
                            <div class="p-4 space-y-3">
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-600 text-white shadow-inner-strong">
                                                <i class="ph ph-magnifying-glass-plus text-[15px]"></i>
                                            </span>
                                            <div>
                                                <div class="text-xs font-semibold text-slate-800">정밀 발전량·수익성 분석</div>
                                                <div class="text-[10px] text-slate-500">선택된 패널 배치를 기준으로 예상 발전량과 수익성을 심층 분석합니다.</div>
                                            </div>
                                        </div>
                                        <button type="button" onclick="window.runPrecisionAnalysis()" class="btn-primary px-3 py-1.5 rounded-full text-[11px] inline-flex items-center gap-1 shadow-lg">
                                            <i class="ph ph-sparkle text-[14px]"></i>
                                            <span>정밀 분석</span>
                                        </button>
                                    </div>

                                    <!-- AI 분석 결과 요약 -->
                                    <div class="mt-2 bg-slate-900 rounded-xl border border-slate-700 p-3 text-xs text-slate-100 shadow-inner-strong">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-400 text-slate-900">
                                                    <i class="ph ph-brain text-[12px]"></i>
                                                </span>
                                                <span class="font-semibold text-[11px]">AI 사업성 요약</span>
                                            </div>
                                            <span class="pill-badge">
                                                <i class="ph ph-barbell text-[12px] text-emerald-300"></i>
                                                <span class="text-[10px]">PF 검토용 요약</span>
                                            </span>
                                        </div>
                                        <p class="text-[10px] text-slate-300 mb-1" id="aiSummary">먼저 지도를 클릭해 설치 후보를 선택한 뒤, 전수 스캔 및 정밀 분석을 실행해 주세요.</p>
                                        <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                                        <div id="aiChecksContainer" class="mt-3 space-y-1 text-[11px] leading-snug"></div>
                                        <div class="mt-2 flex items-center justify-between">
                                            <div class="flex items-center gap-1 text-[10px] text-slate-400">
                                                <i class="ph ph-shield-check text-[11px] text-emerald-400"></i>
                                                <span>법령/조례는 참고용이며, 실제 인허가 검토가 필요합니다.</span>
                                            </div>
                                            <button type="button" onclick="window.toggleLawPanel()" class="inline-flex items-center gap-1 text-[10px] text-sky-300 hover:text-sky-200">
                                                <i class="ph ph-scales text-[11px]"></i>
                                                <span>법령·조례 상세 보기</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 금융 지표 요약 -->
                                    <div class="mt-3 grid grid-cols-3 gap-2 text-[11px] text-slate-700">
                                        <div class="bg-emerald-50 rounded-lg p-2 border border-emerald-100">
                                            <div class="text-[10px] text-emerald-700">연간 현금흐름</div>
                                            <div class="text-xs font-semibold text-emerald-900" id="annualCashFlow">-</div>
                                        </div>
                                        <div class="bg-amber-50 rounded-lg p-2 border border-amber-100">
                                            <div class="text-[10px] text-amber-700">투자 회수(년)</div>
                                            <div class="text-xs font-semibold text-amber-900" id="paybackPeriod">-</div>
                                        </div>
                                        <div class="bg-sky-50 rounded-lg p-2 border border-sky-100">
                                            <div class="text-[10px] text-sky-700">PF 커버리지</div>
                                            <div class="text-xs font-semibold text-sky-900" id="pfCoverage">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 법령/조례 요약 패널 -->
                                <div id="lawPanel" class="bg-slate-900 rounded-xl border border-slate-700 p-3 text-xs text-slate-100 shadow-inner-strong hidden">
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-500 text-slate-900">
                                                <i class="ph ph-scales text-[12px]"></i>
                                            </span>
                                            <span class="font-semibold text-[11px]">법령·조례 규제 요약</span>
                                        </div>
                                        <button type="button" onclick="window.toggleLawPanel()" class="inline-flex items-center justify-center w-5 h-5 rounded-full border border-slate-600 text-[10px] text-slate-300 hover:bg-slate-800">
                                            <i class="ph ph-x"></i>
                                        </button>
                                    </div>
                                    <p class="text-[10px] text-slate-300" id="lawSummary">
                                        각 지자체의 조례 및 관련 법령 분석 결과가 여기에 표시됩니다. 인근 주거지역과의 이격거리, 경사도, 생태자연도, 문화재 규제 등 8대 중대 체크사항을 종합적으로 검토합니다.
                                    </p>
                                    <p class="mt-1 text-[9px] text-slate-500">
                                        ※ 실제 인허가 및 PF 승인에는 전문 설계사·법률 검토가 반드시 필요합니다.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 종합 리포트 탭 -->
                        <div id="tabContent-report" class="tab-content hidden">
                            <div class="p-4 space-y-3">
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-900 text-sky-300 shadow-inner-strong">
                                                <i class="ph ph-sparkle text-[15px]"></i>
                                            </span>
                                            <div>
                                                <div class="text-xs font-semibold text-slate-800">종합 리포트 생성</div>
                                                <div class="text-[10px] text-slate-500">PDF 리포트로 발전량·수익성·법령검토 요약을 한 번에 출력합니다.</div>
                                            </div>
                                        </div>
                                        <button type="button" onclick="window.generateReport()" class="btn-primary px-3 py-1.5 rounded-full text-[11px] inline-flex items-center gap-1 shadow-lg">
                                            <i class="ph ph-file-pdf text-[14px]"></i>
                                            <span>PDF 출력</span>
                                        </button>
                                    </div>

                                    <div class="mt-2 grid grid-cols-2 gap-2 text-[11px] text-slate-700">
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">대상 주소</div>
                                            <div class="text-[11px] font-semibold text-slate-900" id="reportAddress">-</div>
                                        </div>
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">설치 모드</div>
                                            <div class="text-[11px] font-semibold text-slate-900" id="reportMode">-</div>
                                        </div>
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">설치 패널 수</div>
                                            <div class="text-[11px] font-semibold text-slate-900" id="reportPanelCount">-</div>
                                        </div>
                                        <div class="bg-slate-50 rounded-lg p-2 border border-slate-100">
                                            <div class="text-[10px] text-slate-500">예상 용량(kW)</div>
                                            <div class="text-[11px] font-semibold text-slate-900" id="reportCapacityKw">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 이메일 전송 -->
                                <div class="bg-slate-900 rounded-xl border border-slate-700 p-3 text-xs text-slate-100 shadow-inner-strong">
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-500 text-slate-900">
                                                <i class="ph ph-envelope-simple-open text-[12px]"></i>
                                            </span>
                                            <span class="font-semibold text-[11px]">리포트 이메일 발송</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-2 mt-1">
                                        <div>
                                            <label class="block mb-0.5 text-[10px] text-slate-300">수신 이메일</label>
                                            <input type="email" id="reportEmail" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-[11px] text-slate-100 placeholder-slate-500" placeholder="you@example.com">
                                        </div>
                                    </div>
                                    <div class="mt-2 flex items-center justify-between">
                                        <p class="text-[10px] text-slate-400 flex items-center gap-1">
                                            <i class="ph ph-info text-[11px] text-sky-400"></i>
                                            <span>PDF를 생성한 뒤 이메일로 자동 첨부하여 발송합니다.</span>
                                        </p>
                                        <button type="button" onclick="window.sendReportEmail()" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-sky-400 bg-sky-500/10 text-[11px] text-sky-100 hover:bg-sky-500/20">
                                            <i class="ph ph-paper-plane-tilt text-[12px]"></i>
                                            <span>이메일 전송</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 기록 탭 -->
                        <div id="tabContent-history" class="tab-content hidden">
                            <div class="p-4 space-y-3">
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-900 text-amber-300 shadow-inner-strong">
                                                <i class="ph ph-clock-counter-clockwise text-[15px]"></i>
                                            </span>
                                            <div>
                                                <div class="text-xs font-semibold text-slate-800">분석 기록</div>
                                                <div class="text-[10px] text-slate-500">최근 분석한 후보지들의 요약 결과를 다시 확인할 수 있습니다.</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 text-[10px]">
                                            <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV 다운</button>
                                            <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">삭제</button>
                                        </div>
                                    </div>
                                    <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                                </div>
                            </div>
                
                            <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                                <div class="spinner mb-2"></div><p class="text-xs text-slate-500">처리 중...</p></div>
                        </div>
                    </div>
        

                </div>
    
    
        </div>
    </div>


    <!-- 상단 헤더 & 지도 레이어 컨트롤 -->
    <header class="absolute top-0 left-0 right-0 z-[1500] flex items-center justify-between px-4 py-3 pointer-events-none">
        <!-- 좌측: 큰 타이틀 + 상세 설정 버튼 -->
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="flex items-center gap-2 bg-transparent pl-2 pr-4 py-2 rounded-xl shadow-lg border border-slate-700/60 title-gradient">
                <img src="data:image/png;base64,..." alt="SCEnergy Logo" class="w-9 h-9 rounded-xl shadow-inner-strong object-contain bg-slate-950 border border-slate-700/80">
                <div>
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full text-[10px] border border-emerald-400 bg-emerald-500/10 text-emerald-200">
                            <i class="ph ph-shield-check text-[11px]"></i>
                            <span>PF Ready</span>
                        </span>
                        <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full text-[10px] border border-sky-400 bg-sky-500/10 text-sky-200">
                            <i class="ph ph-brain text-[11px]"></i>
                            <span>AI Assisted</span>
                        </span>
                    </div>
                    <div class="text-[13px] font-semibold text-slate-50 mt-0.5">SCEnergy 태양광 채굴기</div>
                    <div class="text-[10px] text-slate-300">지붕·토지 설치 가능 영역 자동 탐지 및 PF 사업성 분석</div>
                </div>
            </div>
        </div>

        <!-- 우측: 지도/레이어 컨트롤 -->
        <div class="flex items-center gap-2 pointer-events-auto">
            <div class="flex items-center gap-1 bg-slate-950/80 border border-slate-700/80 rounded-full px-2 py-1 shadow-lg">
                <button type="button" onclick="window.setBaseLayer('vworld')" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-sky-500/10 border border-sky-400 text-sky-300 text-[12px] hover:bg-sky-500/20" title="V-World 기본 지도">
                    <i class="ph ph-globe-hemisphere-west"></i>
                </button>
                <button type="button" onclick="window.setBaseLayer('vworld_sat')" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 border border-slate-600 text-slate-300 text-[12px] hover:bg-slate-700" title="V-World 항공 위성">
                    <i class="ph ph-image-square"></i>
                </button>
                <button type="button" onclick="window.setBaseLayer('osm')" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 border border-slate-600 text-slate-300 text-[12px] hover:bg-slate-700" title="OpenStreetMap">
                    <i class="ph ph-map-trifold"></i>
                </button>
                <button type="button" onclick="window.setBaseLayer('google')" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 border border-slate-600 text-slate-300 text-[12px] hover:bg-slate-700" title="Google 위성">
                    <i class="ph ph-google-logo"></i>
                </button>
            </div>

            <div class="flex items-center gap-1 bg-slate-950/80 border border-slate-700/80 rounded-full px-2 py-1 shadow-lg">
                <button type="button" onclick="window.toggleRoofLayer()" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 border border-slate-600 text-slate-300 text-[12px] hover:bg-slate-700" title="지붕 후보 표시">
                    <i class="ph ph-building-apartment"></i>
                </button>
                <button type="button" onclick="window.toggleRailLayer()" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 border border-slate-600 text-slate-300 text-[12px] hover:bg-slate-700" title="송전선로/제약요소 표시">
                    <i class="ph ph-transmission-tower"></i>
                </button>
                <button type="button" onclick="window.toggleHeatmap()" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 border border-slate-600 text-slate-300 text-[12px] hover:bg-slate-700" title="일사량 히트맵">
                    <i class="ph ph-sun-dim"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 토스트 컨테이너 -->
    <div id="toastContainer"></div>

    <!-- 스크립트 -->
    <script>
      const BACKEND_URL = (new URLSearchParams(window.location.search)).get("backend")
        || (window.SOLAR_BACKEND_URL || "");

      let map;
      let roofLayer, landLayer, railLayer, heatLayer;
      let panelLayerGroup;
      let currentBaseLayer = "vworld";
      let baseLayers = {};
      let zoomIndicatorTimer = null;
      let scanTarget = "roof";
      let currentAnalysisData = {};
      let tileLoadCount = 0;
      let vworldDailyCount = 0;

      function el(id){ return document.getElementById(id); }

      function showToast(message){
        const container = el("toastContainer");
        if(!container) return;
        const div = document.createElement("div");
        div.className = "toast";
        div.innerHTML = `
          <i class="ph ph-check-circle"></i>
          <span>${escapeHtml(message)}</span>
        `;
        container.appendChild(div);
        setTimeout(()=>{ div.remove(); }, 3200);
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>\"']/g, function(m){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
        });
      }

      function formatNumber(n){
        if(n === null || n === undefined || isNaN(n)) return "-";
        const num = Number(n);
        if(!isFinite(num)) return "-";
        return num.toLocaleString("ko-KR");
      }

      function formatWon(n){
        if(n === null || n === undefined || isNaN(n)) return "-";
        const num = Number(n);
        if(!isFinite(num)) return "-";
        if(Math.abs(num) >= 1_0000_0000){
          return (num/1_0000_0000).toFixed(1).replace(/\.0$/,"") + " 억원";
        }
        if(Math.abs(num) >= 1_0000_000){
          return (num/1_0000_000).toFixed(1).replace(/\.0$/,"") + " 천만원";
        }
        if(Math.abs(num) >= 1_0000){
          return (num/1_0000).toFixed(0) + " 만원";
        }
        return num.toLocaleString("ko-KR") + " 원";
      }

      function switchTab(tab){
        const tabs = ["scan","analysis","report","history"];
        tabs.forEach(t=>{
          const btn = el("tab-"+t);
          const content = el("tabContent-"+t);
          if(btn){
            if(t === tab){
              btn.classList.add("active");
            }else{
              btn.classList.remove("active");
            }
          }
          if(content){
            content.classList.toggle("hidden", t !== tab);
            content.classList.toggle("block", t === tab);
          }
        });
      }
      window.switchTab = switchTab;

      function toggleSidebar(){
        const sidebar = el("sidebar");
        if(!sidebar) return;
        sidebar.classList.toggle("sidebar-hidden");
      }
      window.toggleSidebar = toggleSidebar;

      function initMap(){
        map = L.map("map", {
          center:[36.5,127.8],
          zoom:8,
          zoomControl:true,
          attributionControl:true,
          preferCanvas:true
        });

        baseLayers["vworld"] = L.tileLayer("//api.vworld.kr/req/wmts/1.0.0/{key}/Base/{z}/{y}/{x}.png", {
          key: "YOUR_VWORLD_API_KEY",
          tileSize: 256,
          attribution: "&copy; VWorld"
        }).addTo(map);

        baseLayers["vworld_sat"] = L.tileLayer("//api.vworld.kr/req/wmts/1.0.0/{key}/Satellite/{z}/{y}/{x}.jpeg", {
          key: "YOUR_VWORLD_API_KEY",
          tileSize: 256,
          attribution: "&copy; VWorld Satellite"
        });

        baseLayers["osm"] = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
          maxZoom:19,
          attribution:"&copy; OpenStreetMap"
        });

        baseLayers["google"] = L.tileLayer("http://mt.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{
          maxZoom:20,
          attribution:"&copy; Google"
        });

        panelLayerGroup = L.layerGroup().addTo(map);

        map.on("zoomend", updateZoomIndicator);
        map.on("click", onMapClick);

        updateZoomIndicator();
      }

      function updateZoomIndicator(){
        const z = map ? map.getZoom() : 0;
        const box = el("zoomIndicator");
        const levelSpan = el("zoomLevel");
        const hintSpan = el("zoomHint");
        if(!box || !levelSpan || !hintSpan) return;
        levelSpan.textContent = z;
        let hint = "위성 확대 추천";
        if(z >= 18){
          hint = "지붕 디테일 확인 가능";
        }else if(z >= 16){
          hint = "지붕 윤곽 확인 가능";
        }else if(z >= 14){
          hint = "대략적인 입지 검토";
        }
        hintSpan.textContent = hint;
        box.classList.remove("hidden");
        if(zoomIndicatorTimer){
          clearTimeout(zoomIndicatorTimer);
        }
        zoomIndicatorTimer = setTimeout(()=>{
          box.classList.add("hidden");
        }, 3000);
      }

      function setBaseLayer(name){
        if(!map) return;
        if(baseLayers[currentBaseLayer]){
          map.removeLayer(baseLayers[currentBaseLayer]);
        }
        if(baseLayers[name]){
          map.addLayer(baseLayers[name]);
          currentBaseLayer = name;
        }
      }
      window.setBaseLayer = setBaseLayer;

      function toggleRoofLayer(){ /* TODO: implement or connect to existing */ }
      window.toggleRoofLayer = toggleRoofLayer;
      function toggleRailLayer(){ /* TODO: implement or connect to existing */ }
      window.toggleRailLayer = toggleRailLayer;
      function toggleHeatmap(){ /* TODO: implement or connect to existing */ }
      window.toggleHeatmap = toggleHeatmap;

      function onMapClick(e){
        scanTarget = el("scanMode")?.value || "roof";
        fetchCandidatePolygon(e.latlng);
      }

      function fetchCandidatePolygon(latlng){
        if(!BACKEND_URL){
          showToast("백엔드 주소가 설정되지 않았습니다.");
          return;
        }
        const url = BACKEND_URL + "/api/candidate";
        const payload = {
          lat: latlng.lat,
          lng: latlng.lng,
          mode: scanTarget
        };
        fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        })
        .then(r=>r.json())
        .then(data=>{
          if(!data || !data.ok){
            showToast("후보지를 불러오지 못했습니다.");
            return;
          }
          drawCandidatePolygon(data);
        })
        .catch(err=>{
          console.error(err);
          showToast("후보지 조회 중 오류 발생");
        });
      }

      function drawCandidatePolygon(data){
        if(panelLayerGroup){
          panelLayerGroup.clearLayers();
        }
        if(data && data.polygon){
          const coords = data.polygon.coordinates[0].map(c=>[c[1], c[0]]);
          const poly = L.polygon(coords, {
            color:"#22c55e",
            weight:2,
            fillColor:"#22c55e",
            fillOpacity:0.15
          }).addTo(panelLayerGroup);
          map.fitBounds(poly.getBounds(), { maxZoom:18 });
        }
        currentAnalysisData = currentAnalysisData || {};
        currentAnalysisData.address = data.address || currentAnalysisData.address || "";
        currentAnalysisData.lat = data.lat;
        currentAnalysisData.lng = data.lng;
        currentAnalysisData.mode = scanTarget;
      }

      function reCalculate(){ /* 패널 배치 관련 재계산 로직 (기존 유지) */ }
      window.reCalculate = reCalculate;
      function reCalculateFinance(){ /* 금융 파라미터 변경 시 재계산 로직 (기존 유지) */ }
      window.reCalculateFinance = reCalculateFinance;
      function applyBankPreset(key){ /* 은행 preset 적용 (기존 유지) */ }
      window.applyBankPreset = applyBankPreset;

      function runFullScan(){
        if(!BACKEND_URL){
          showToast("백엔드 주소가 설정되지 않았습니다.");
          return;
        }
        const url = BACKEND_URL + "/api/scan/full";
        const payload = {
          mode: scanTarget,
          panelGapX: Number(el("panelGapX")?.value || 0.1),
          panelGapY: Number(el("panelGapY")?.value || 0.1),
          setbackEdge: Number(el("setbackEdge")?.value || 0.5),
          setbackObstacle: Number(el("setbackObstacle")?.value || 0.3),
          modPower: Number(el("modPower")?.value || 450),
          modArea: Number(el("modArea")?.value || 2.2),
          invEff: Number(el("invEff")?.value || 98),
          lossRate: Number(el("lossRate")?.value || 10),
          tiltAngle: Number(el("tiltAngle")?.value || 20),
          azimuth: Number(el("azimuth")?.value || 180),
          moduleModel: el("moduleSelect")?.value || null,
          inverterModel: el("inverterSelect")?.value || null
        };
        fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        })
        .then(r=>r.json())
        .then(data=>{
          if(!data || !data.ok){
            showToast(data?.msg || "전수 스캔 실패");
            return;
          }
          drawPanels(data);
          updateScanSummary(data);
          currentAnalysisData = currentAnalysisData || {};
          currentAnalysisData.scanResult = data;
          currentAnalysisData.mode = scanTarget;
          currentAnalysisData.panelCount = data.totalPanelCount;
          currentAnalysisData.capacity_kw = data.capacityKw;
        })
        .catch(err=>{
          console.error(err);
          showToast("전수 스캔 중 오류");
        });
      }
      window.runFullScan = runFullScan;

      function drawPanels(data){
        if(panelLayerGroup){
          panelLayerGroup.clearLayers();
        }
        if(!data || !Array.isArray(data.panels)) return;
        data.panels.forEach(p=>{
          const poly = L.polygon(p.latlngs, {
            color: "#38bdf8",
            weight: 1,
            fillColor: "#38bdf8",
            fillOpacity: 0.4
          });
          panelLayerGroup.addLayer(poly);
        });
      }

      function updateScanSummary(data){
        el("scanAreaDisplay").textContent = data?.scanArea ? data.scanArea.toFixed(1) + " m²" : "-";
        el("scanPanelCount").textContent = data?.totalPanelCount || 0;
        el("scanCapacityKw").textContent = data?.capacityKw ? data.capacityKw.toFixed(1) + " kW" : "-";
      }

      function runPrecisionAnalysis(){
        if(!BACKEND_URL){
          showToast("백엔드 주소가 설정되지 않았습니다.");
          return;
        }
        const url = BACKEND_URL + "/api/analyze/pv";
        const payload = {
          mode: currentAnalysisData.mode || scanTarget,
          panelCount: currentAnalysisData.panelCount || 0,
          capacityKw: currentAnalysisData.capacity_kw || 0,
          solarIrradiance: Number(el("solarIrradiance")?.value || 1400),
          capacityFactor: Number(el("capacityFactor")?.value || 15),
          tiltAngle: Number(el("tiltAngle")?.value || 20),
          azimuth: Number(el("azimuth")?.value || 180),
          loanRatio: Number(el("loanRatio")?.value || 80),
          loanRate: Number(el("loanRate")?.value || 5.5),
          loanYears: Number(el("loanYears")?.value || 18),
          repaymentType: el("repaymentType")?.value || "level",
          smpPrice: Number(el("smpPrice")?.value || 110),
          recPrice: Number(el("recPrice")?.value || 65),
          address: currentAnalysisData.address || "",
          lat: currentAnalysisData.lat,
          lng: currentAnalysisData.lng
        };
        fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        })
        .then(r=>r.json())
        .then(r=>{
          if(!r || !r.ok){
            showToast(r?.msg || "정밀 분석 실패");
            return;
          }
          renderAnalysisResult(r.data);
          currentAnalysisData.finance = r.data.finance;
          currentAnalysisData.ai_analysis = r.data.ai_analysis;
          renderAIResult(r.data);

          try { if (typeof fetchEightChecks === "function") { fetchEightChecks(); } } catch (e) { console.error("Eight-checks render failed", e); }

          updateReportSummary();
        })
        .catch(err=>{
          console.error(err);
          showToast("정밀 분석 중 오류");
        });
      }
      window.runPrecisionAnalysis = runPrecisionAnalysis;

      function renderAnalysisResult(data){
        el("annualCashFlow").textContent = formatWon(data.finance?.annualCashFlowWon ?? 0);
        el("paybackPeriod").textContent = (data.finance?.paybackPeriodYears ?? 0).toFixed(1) + " 년";
        el("pfCoverage").textContent = (data.finance?.pfCoverageRatio ?? 0).toFixed(2) + " 배";
      }

      function renderAIResult(data){
        const ai = data.ai_analysis || {};
        el("aiSummary").textContent = ai.summary || "AI 분석 결과가 준비되지 않았습니다.";
        el("confidenceValue").textContent = ai.confidence ? `신뢰도: ${Math.round(ai.confidence*100)}%` : "";
      }

      function toggleLawPanel(){
        const panel = el("lawPanel");
        if(!panel) return;
        panel.classList.toggle("hidden");
      }
      window.toggleLawPanel = toggleLawPanel;

      function updateReportSummary(){
        el("reportAddress").textContent = currentAnalysisData.address || "-";
        el("reportMode").textContent = currentAnalysisData.mode === "land" ? "토지" : "지붕";
        el("reportPanelCount").textContent = currentAnalysisData.panelCount || 0;
        el("reportCapacityKw").textContent = currentAnalysisData.capacity_kw ? currentAnalysisData.capacity_kw.toFixed(1) + " kW" : "-";
      }

      function generateReport(){
        if(!BACKEND_URL){
          showToast("백엔드 주소가 설정되지 않았습니다.");
          return;
        }
        const url = BACKEND_URL + "/api/report/pdf";
        fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(currentAnalysisData || {})
        })
        .then(r=>r.blob())
        .then(blob=>{
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "solar_report.pdf";
          link.click();
          URL.revokeObjectURL(link.href);
          showToast("PDF 리포트가 생성되었습니다.");
        })
        .catch(err=>{
          console.error(err);
          showToast("리포트 생성 중 오류");
        });
      }
      window.generateReport = generateReport;

      function sendReportEmail(){
        if(!BACKEND_URL){
          showToast("백엔드 주소가 설정되지 않았습니다.");
          return;
        }
        const email = el("reportEmail")?.value || "";
        if(!email){
          showToast("수신 이메일을 입력해 주세요.");
          return;
        }
        const url = BACKEND_URL + "/api/report/email";
        const payload = {
          email,
          report: currentAnalysisData || {}
        };
        fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        })
        .then(r=>r.json())
        .then(r=>{
          if(!r || !r.ok){
            showToast(r?.msg || "이메일 전송 실패");
            return;
          }
          showToast("리포트 이메일 발송 완료");
        })
        .catch(err=>{
          console.error(err);
          showToast("이메일 발송 중 오류");
        });
      }
      window.sendReportEmail = sendReportEmail;

      function historyKey(){
        return "solar_pathfinder_history_v1";
      }
      function loadHistory(){
        try{
          const raw = localStorage.getItem(historyKey());
          if(!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        }catch(e){ return []; }
      }
      function saveHistory(items){
        try{ localStorage.setItem(historyKey(), JSON.stringify(items)); }catch(e){}
      }
      function renderHistory(){
        const list = el("historyList");
        if(!list) return;
        const items = loadHistory();
        if(!items.length){
          list.innerHTML = `<div class="text-xs text-slate-400">기록이 없습니다.</div>`;
          return;
        }

        // 매력도 점수 계산 (AI 분석 기반)
        const scored = items.map((it, idx) => {
          const ai = it.ai || {};
          let score = null;
          if (typeof ai.attractiveness_score === "number") {
            score = ai.attractiveness_score;
          } else if (ai.ai_score && typeof ai.ai_score.score === "number") {
            score = ai.ai_score.score;
          }
          return { it, idx, score };
        });

        // 점수 기준 내림차순 정렬, 점수 없는 항목은 맨 뒤
        scored.sort((a, b) => {
          const sa = (typeof a.score === "number") ? a.score : -1;
          const sb = (typeof b.score === "number") ? b.score : -1;
          return sb - sa;
        });

        // 상위 10개만 사용
        const top = scored.slice(0, 10);

        list.innerHTML = top.map(({ it, score, idx }, rank)=>`
    <div class="bg-white border border-slate-200 rounded p-2 text-xs shadow-sm flex justify-between items-center gap-2">
      <div>
        <div class="flex items-center gap-1">
          <span class="inline-flex items-center justify-center w-4 h-4 rounded-full bg-slate-800 text-white font-bold">${rank+1}</span>
          <span class="font-bold text-slate-700 truncate max-w-[180px]" title="${escapeHtml(it.address || "확인 필요")}">${escapeHtml(it.address || "확인 필요")}</span>
        </div>
        <div class="text-[10px] text-slate-500">${escapeHtml(it.time || "")}</div>
        <div class="text-[10px] text-slate-600">
          패널 ${it.panelCount || 0}장 · 모드 ${escapeHtml(it.mode || "")} · 점수 ${ (typeof score === "number") ? Math.round(score) + "점" : "-" }
        </div>
      </div>
      <div class="flex items-center gap-1">
        <button type="button"
                class="inline-flex items-center justify-center w-6 h-6 rounded-full border border-slate-300 text-[10px] text-slate-600 bg-slate-50"
                title="상세 리포트 (추후 구현)">
          <i class="ph ph-magnifying-glass"></i>
        </button>
        <button type="button"
                class="inline-flex items-center justify-center w-6 h-6 rounded-full border border-red-300 text-[10px] text-red-500 bg-red-50"
                title="이 기록 삭제"
                onclick="window.deleteHistoryEntry(${idx})">
          <i class="ph ph-trash"></i>
        </button>
      </div>
    </div>
  `).join("");
      }

      window.saveResult = function(){
        const items = loadHistory();
        const entry = {
          time: new Date().toLocaleString(),
          address: escapeHtml(currentAnalysisData.address || "확인 필요"),
          mode: currentAnalysisData.mode || (scanTarget==="land"?"land":"roof"),
          panelCount: currentAnalysisData.panelCount || 0,
          finance: currentAnalysisData.finance || {},
          ai: currentAnalysisData.ai_analysis || {}
        };
        items.unshift(entry);
        saveHistory(items.slice(0, 100));
        showToast("저장 완료");
        renderHistory();
      };

      window.deleteHistoryEntry = function(index){
        const items = loadHistory();
        if(!Array.isArray(items)) return;
        if(typeof index !== "number") return;
        if(index < 0 || index >= items.length) return;
        items.splice(index, 1);
        saveHistory(items);
        showToast("해당 기록을 삭제했습니다");
        renderHistory();
      };

      window.clearHistory = function(){
        saveHistory([]);
        showToast("기록 삭제");
        renderHistory();
      };

      window.downloadCSV = function(){
        const items = loadHistory();
        if(!items.length){
          showToast("다운로드할 기록이 없습니다");
          return;
        }
        const rows = [["time","address","mode","panelCount","acCapacityKw","annualRevenueWon","totalCostWon","score"]];
        for(const it of items){
          const fin = it.finance || {};
          const ai = it.ai || {};
          const score = (typeof ai.attractiveness_score === "number")
            ? ai.attractiveness_score
            : (ai.ai_score && typeof ai.ai_score.score === "number" ? ai.ai_score.score : "");
          rows.push([
            it.time || "",
            (it.address || "").replaceAll("\n"," ").replaceAll(","," "),
            it.mode || "",
            it.panelCount || 0,
            fin.acCapacityKw ?? "",
            fin.annualRevenueWon ?? "",
            fin.totalCostWon ?? "",
            score
          ]);
        }
        const csv = rows.map(r=>r.join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "solar_history.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      };

      // ------------------------------------------------------------
      // 8대 중대 체크사항 요약 패널 연동
      // ------------------------------------------------------------
      async function fetchEightChecks(){
        try{
          if (typeof currentAnalysisData !== "object" || !currentAnalysisData) return;
          const addr = (currentAnalysisData.address || currentAnalysisData.addr || "").trim();
          const lat = (typeof currentAnalysisData.lat === "number") ? currentAnalysisData.lat : null;
          const lng = (typeof currentAnalysisData.lng === "number") ? currentAnalysisData.lng : null;

          if (!BACKEND_URL) {
            console.warn("8-checks skipped: BACKEND_URL not set");
            return;
          }
          if (!lat || !lng) {
            console.warn("8-checks skipped: lat/lng missing");
            return;
          }

          const payload = {
            address: addr || null,
            lat: lat,
            lng: lng,
            pnu: currentAnalysisData.pnu || null,
            capacity_kw: currentAnalysisData.ac_kw || currentAnalysisData.acKW || null,
            slope_deg: currentAnalysisData.slope_deg || currentAnalysisData.slopeDeg || null,
            sun_hours: currentAnalysisData.sun_hours || currentAnalysisData.sunHours || null,
            dist_road_m: currentAnalysisData.dist_road_m || null,
            dist_substation_m: currentAnalysisData.dist_substation_m || null,
            dist_house_m: currentAnalysisData.dist_house_m || null
          };

          const res = await fetch(`${BACKEND_URL}/api/checks/analyze`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            console.warn("8-checks HTTP error", res && res.status);
            return;
          }
          const json = await res.json();
          if (!json || !json.ok) {
            console.warn("8-checks response not ok", json);
            return;
          }
          renderEightChecks(json);
        } catch (e) {
          console.error("fetchEightChecks failed", e);
        }
      }

      function statusToClass(st){
        if (st === "PASS") return "pass";
        if (st === "FAIL") return "fail";
        return "warn";
      }

      function renderEightChecks(resp){
        const elc = document.getElementById("aiChecksContainer");
        if (!elc) return;
        const order = [
          ["zoning","용도지역"],
          ["ecology","생태자연도"],
          ["heritage","문화재 규제"],
          ["setback","이격거리"],
          ["grid","한전 여유용량"],
          ["slope","경사도"],
          ["insolation","일사량"],
          ["land_price","토지가격"]
        ];
        const list = (resp && resp.check_list) || {};
        elc.innerHTML = order.map(function(item){
          const k = item[0];
          const title = item[1];
          const it = list[k] || {status:"WARNING", value:"확인 필요", msg:""};
          return `
      <div class="flex items-start justify-between border-b border-slate-700/60 py-1 last:border-b-0 ${statusToClass(it.status)}">
        <div class="text-[11px] text-slate-200 font-semibold mr-2">${escapeHtml(title)}</div>
        <div class="flex-1 text-right">
          <div class="text-[11px] text-slate-100">${escapeHtml(it.value || "")}</div>
          <div class="text-[10px] text-slate-400">${escapeHtml(it.msg || "")}</div>
        </div>
      </div>
    `;
        }).join("");
      }

      if (typeof escapeHtml !== "function") {
        function escapeHtml(s){
          return String(s).replace(/[&<>\"']/g, function(m){
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
          });
        }
      }

      document.addEventListener("DOMContentLoaded", ()=>{
        initMap();
        renderHistory();
      });
    </script>
</body>
</html>
