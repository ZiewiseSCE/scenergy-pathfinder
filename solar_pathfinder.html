<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ Pathfinder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Kakao Maps JS SDK: loaded dynamically via loadClientConfig() -->
<script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        

/* ì„¤ì • ëª¨ë‹¬ ë’¤ ì–´ë‘ìš´ ë§‰ì„ ê±°ì˜ ì œê±°í•´ì„œ ì§€ë„ê°€ ë” ì˜ ë³´ì´ë„ë¡ */
#settingsOverlay > .absolute.inset-0 {
  background-color: rgba(0,0,0,0.02) !important;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

/* Body ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ì„¤ì •í•´ì„œ ì§€ë„(Leaflet)ê°€ ë’¤ì—ì„œ ë³´ì´ë„ë¡ */
body.bg-gray-100 {
  background-color: transparent !important;
}

/* ëª¨ë°”ì¼ì—ì„œ zoom in/out í•  ê²½ìš°, floating toolbarê°€ map ìœ„ì— ìì—°ìŠ¤ëŸ½ê²Œ ì˜¬ë¼ì˜¤ë„ë¡ */
#map { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; background: #000; }
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        /* ëª¨ë‹¬ ì•ˆì—ì„œ ì‚¬ì´ë“œë°”ë¥¼ ì •ìƒ ë¸”ë¡ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•œ override */
        #settingsOverlay #sidebar {

        #sidebar [data-role="scan-target-sidebar"] {
          display: none;
        }
          position: relative;
          top: auto;
          left: auto;
          right: auto;
          bottom: auto;
          height: auto
          ;
          transform: none;
          border-radius: 1rem;
          border: 1px solid rgba(148,163,184,0.4);
          box-shadow: 0 24px 60px rgba(15,23,42,0.95);
        }

        #map { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; background: #000; }
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .floating-panel { z-index: 3000; }
        .badge { font-size: 0.7rem; padding: 0.1rem 0.45rem; border-radius: 9999px; border: 1px solid rgba(148,163,184,0.7); }
        .glass-card { background: rgba(15,23,42,0.96); border-radius: 1rem; border: 1px solid rgba(148,163,184,0.6); box-shadow: 0 18px 45px rgba(15,23,42,0.96); }
        .glass-soft { background: rgba(15,23,42,0.94); border-radius: 0.875rem; border: 1px solid rgba(148,163,184,0.45); }
        .btn-primary { background: linear-gradient(to right, #22c55e, #22c55e); color: #ecfdf5; border-radius: 9999px; }
        .btn-primary-ghost { background: rgba(15,23,42,0.9); border: 1px solid rgba(34,197,94,0.6); color: #bbf7d0; border-radius: 9999px; }
        .btn-soft { background: rgba(15,23,42,0.92); border-radius: 9999px; border: 1px solid rgba(148,163,184,0.6); }
        .btn-tab { border-radius: 9999px; padding: 0.35rem 0.9rem; font-size: 0.78rem; }
        .btn-tab-active { background: rgba(15,23,42,1); border: 1px solid rgba(56,189,248,0.8); color: #e0f2fe; }
        .btn-tab-inactive { background: rgba(15,23,42,0.9); border: 1px solid rgba(51,65,85,0.9); color: #cbd5f5; }
        .status-pill { border-radius: 9999px; padding: 0.2rem 0.6rem; font-size: 0.7rem; }
        .status-ok { background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.9); color: #a7f3d0; }
        .status-warn { background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.8); color: #fef3c7; }
        .status-bad { background: rgba(248,113,113,0.12); border: 1px solid rgba(248,113,113,0.9); color: #fecaca; }
        .tag { font-size: 0.65rem; padding: 0.12rem 0.4rem; border-radius: 9999px; border: 1px solid rgba(148,163,184,0.6); background: rgba(15,23,42,0.96); }
        .panel-section-title { font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; color: #9ca3af; }
        .leaflet-control-zoom {
          border-radius: 9999px;
          overflow: hidden;
          border: 1px solid rgba(148,163,184,0.6);
          box-shadow: 0 16px 40px rgba(15,23,42,0.95);
        }
        .leaflet-control-zoom a {
          background: rgba(15,23,42,0.96);
          color: #e5e7eb;
          border-color: rgba(30,64,175,0.7);
        }
        .leaflet-control-zoom a:hover {
          background: rgba(30,64,175,1);
          color: #f9fafb;
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
          background: rgba(15,23,42,0.98);
          color: #e5e7eb;
          border-radius: 12px;
          border: 1px solid rgba(51,65,85,0.9);
          box-shadow: 0 16px 40px rgba(15,23,42,0.95);
        }
        .leaflet-bar {
          border-radius: 9999px;
          border: 1px solid rgba(148,163,184,0.6);
          overflow: hidden;
          box-shadow: 0 16px 40px rgba(15,23,42,0.95);
        }
        .leaflet-bar a {
          background-color: rgba(15,23,42,0.96);
          color: #e5e7eb;
        }
        .leaflet-bar a:hover {
          background-color: rgba(30,64,175,1);
          color: #f9fafb;
        }

        .floating-toolbar {
          z-index: 3500;
          pointer-events: auto;
        }

        .d-pad-btn { width: 32px; height: 32px; border-radius: 9999px; border: 1px solid rgba(148,163,184,0.8); background: #020617; color: #e5e7eb; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 0 #020617; }
        .d-pad-btn:hover { background: #0f172a; }
        .d-pad-btn:active { background: #1e293b; transform: translateY(2px); box-shadow: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
#map { background: #0b1220; }

/* Step34b: Finance panel label contrast fix */
.bg-green-50 label.text-slate-200{ color:#334155 !important; } /* slate-700 */

#bottomStatusInner {
  transform: translateY(calc(100% - 32px));
  transition: transform 0.3s ease-out;
}
#bottomStatusInner.open {
  transform: translateY(0);
}

/* í—¤ë” íƒ€ì´í‹€ ê·¸ë¼ë°ì´ì…˜ ëª¨ì…˜ */
.title-gradient {
  background-image: none;
  background-size: 200% 200%;
  animation: none;
}

@keyframes titleGradientMotion {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}


/* ìƒë‹¨ í—¤ë” ë°°ê²½ì„ ì¢€ ë” ë¸”ë™ì— ê°€ê¹ê²Œ */
header {
  background: linear-gradient(to right, #020617, #020617) !important;
  border-bottom: 1px solid rgba(15,23,42,1) !important;
}

.sidebar {
  background: rgba(15,23,42,0.98) !important;
}

/* ì•„ë˜ìª½ ìƒíƒœë°” */
#bottomStatusBar {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 40;
  pointer-events: none;
}
#bottomStatusInner {
  pointer-events: auto;
  max-width: 960px;
  margin: 0 auto;
  padding: 0.4rem 0.75rem 0.6rem;
  border-radius: 9999px;
  background: radial-gradient(circle at top, rgba(15,118,110,0.7), rgba(15,23,42,0.98));
  box-shadow:
    0 -8px 25px rgba(15,23,42,0.95),
    0 0 0 1px rgba(34,197,94,0.35);
}

/* ëª¨ë“ˆ/ì¸ë²„í„° ì„¹ì…˜ ë‚´ë¶€ ì¹´ë“œ */
#moduleInverterCard {
  background: linear-gradient(to bottom right, #0f172a, #020617);
}

/* ìë™ ìŠ¤ìº” ì„¹ì…˜ ì¹´ë“œ */
#autoScanCard {
  background: linear-gradient(to bottom right, #020617, #020617);
}

    </style>
</head>
<body class="bg-gray-100">
    <!-- Leaflet Map -->
    <div id="map"></div>

    <!-- Header -->
    <header class="absolute top-0 left-0 right-0 z-30 bg-white/70 backdrop-blur shadow-sm border-b border-slate-200">
        <div class="max-w-screen-xl mx-auto px-4 py-2 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 flex items-center justify-center shadow-lg">
                    <span class="text-xl">â˜€ï¸</span>
                </div>
                <div>
                    <h1 class="text-sm md:text-base font-semibold text-slate-900 flex items-center space-x-2">
                        <span class="title-gradient bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 via-sky-400 to-indigo-400 animate-[titleGradientMotion_10s_linear_infinite]">
                          SCEnergy íƒœì–‘ê´‘ Pathfinder
                        </span>
                        <span class="hidden sm:inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-[10px] text-emerald-700">
                            Auto Scan + PF
                        </span>
                    </h1>
                    <p id="statusText" class="text-[11px] text-slate-500 mt-0.5">
                        ì§€ë„ ë¡œë”© ì¤‘...
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnToggleSidebar" class="inline-flex items-center px-3 py-1.5 rounded-full border border-slate-300 text-xs text-slate-700 bg-white shadow-sm hover:bg-slate-50">
                    <i class="ph ph-sidebar mr-1"></i>
                    íŒ¨ë„ ì—´ê¸°/ì ‘ê¸°
                </button>
                <button id="btnHelp" class="inline-flex items-center px-3 py-1.5 rounded-full border border-slate-300 text-xs text-slate-700 bg-white shadow-sm hover:bg-slate-50">
                    <i class="ph ph-question mr-1"></i>
                    ë„ì›€ë§
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-16 bottom-4 right-4 w-full max-w-md bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow-xl transform translate-x-0 overflow-hidden flex flex-col">
        <div class="flex-shrink-0 px-4 pt-4 pb-2 border-b border-slate-200 bg-slate-50/80 flex items-center justify-between">
            <div>
                <div class="flex items-center space-x-2">
                    <span class="panel-section-title">í›„ë³´ ì„¤ì • Â· ë¶„ì„</span>
                    <span class="badge inline-flex items-center space-x-1">
                        <i class="ph ph-radar text-sky-500"></i>
                        <span>ìë™ í›„ë³´ + ë°°ì¹˜ ë¶„ì„</span>
                    </span>
                </div>
                <p class="mt-1 text-[11px] text-slate-600">
                    ì§€ë„ì—ì„œ í›„ë³´ êµ¬ì—­ì„ í´ë¦­í•˜ê±°ë‚˜, ìë™ ìŠ¤ìº”ì„ í†µí•´ ì—¬ëŸ¬ í›„ë³´ë¥¼ í•œ ë²ˆì— ë¶„ì„í•˜ì„¸ìš”.
                </p>
            </div>
            <button id="btnCloseSidebar" class="w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center text-slate-500 hover:bg-slate-100">
                <i class="ph ph-x"></i>
            </button>
        </div>

        <!-- Tabs -->
        <div class="flex-shrink-0 px-4 pt-2 pb-1 bg-slate-50/80 border-b border-slate-200 flex items-center space-x-2">
            <button id="tab-scan" class="btn-tab btn-tab-active flex items-center space-x-1">
                <i class="ph ph-crosshair-simple text-xs"></i>
                <span>ìŠ¤ìº”/ì„¤ì •</span>
            </button>
            <button id="tab-analysis" class="btn-tab btn-tab-inactive flex items-center space-x-1">
                <i class="ph ph-graph text-xs"></i>
                <span>ì •ë°€ ë¶„ì„</span>
            </button>
            <button id="tab-pf" class="btn-tab btn-tab-inactive flex items-center space-x-1">
                <i class="ph ph-currency-circle-dollar text-xs"></i>
                <span>PF/ë¦¬í¬íŠ¸</span>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto px-4 pb-4 pt-2 space-y-3">
            <!-- Scan / Settings Panel -->
            <div id="panel-scan" class="space-y-3">
                <!-- Section 1: ì„¤ì¹˜ ëª¨ë“œ -->
                <div class="glass-soft px-3.5 py-3 space-y-2">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-100">1. ì„¤ì¹˜ ëª¨ë“œ</span>
                                <span class="text-[10px] text-slate-400">ì§€ë¶• vs í† ì§€</span>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-0.5">
                                ê¸°ë³¸ ëª¨ë“œë¥¼ ì„ íƒí•˜ë©´ ìë™ ìŠ¤ìº”ê³¼ PF ê³„ì‚°ì— ë°˜ì˜ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button id="btnModeRoof" class="px-2.5 py-1 rounded-full text-[11px] border border-amber-400 bg-amber-50 text-amber-800 font-medium flex items-center space-x-1">
                                <i class="ph ph-house-simple"></i>
                                <span>ì§€ë¶•</span>
                            </button>
                            <button id="btnModeLand" class="px-2.5 py-1 rounded-full text-[11px] border border-slate-300 bg-slate-50 text-slate-700 flex items-center space-x-1">
                                <i class="ph ph-tree-evergreen"></i>
                                <span>í† ì§€</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 2: ì£¼ì†Œ/ê¸°ë³¸ ìš©ëŸ‰ -->
                <div class="glass-soft px-3.5 py-3 space-y-2">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-100">2. ì£¼ì†Œ Â· ê¸°ë³¸ ìš©ëŸ‰</span>
                                <span class="text-[10px] text-slate-400">PF ê°€ì •ì¹˜ì˜ ê¸°ì¤€</span>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-0.5">
                                ì§€ë²ˆ/ë„ë¡œëª… ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ í›„ë³´ êµ¬ì—­ì„ í´ë¦­í•˜ë©´ ìë™ìœ¼ë¡œ ì£¼ì†Œê°€ ì±„ì›Œì§‘ë‹ˆë‹¤.
                            </p>
                        </div>
                        <button id="btnGeocode" class="btn-soft px-2.5 py-1 text-[11px] flex items-center space-x-1">
                            <i class="ph ph-magnifying-glass"></i>
                            <span>ì£¼ì†Œ ê²€ìƒ‰</span>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="text-[10px] text-slate-400">ì£¼ì†Œ</label>
                            <input id="addressInput" type="text"
                                   class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2.5 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400"
                                   placeholder="ì§€ë²ˆ/ë„ë¡œëª… ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ í´ë¦­" />
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-400">ì‹œë®¬ë ˆì´ì…˜ ìš©ëŸ‰ (DC, kW)</label>
                                <input id="projectDcKw" type="number"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2.5 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400"
                                       placeholder="ì˜ˆ: 99.9" />
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400">ì´ê²©ê±°ë¦¬ ê¸°ì¤€ (m)</label>
                                <input id="setbackDist" type="number"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2.5 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400"
                                       placeholder="ê¸°ë³¸ ì¡°ë¡€ ìƒ ì´ê²©ê±°ë¦¬" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: ëª¨ë“ˆ/ì¸ë²„í„° -->
                <div id="moduleInverterCard" class="glass-soft px-3.5 py-3 space-y-2 bg-gradient-to-br from-slate-900 to-slate-950/90 border border-slate-700/80">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-100">3. ëª¨ë“ˆ Â· ì¸ë²„í„°</span>
                                <span class="text-[10px] text-slate-400">ì‹¤ì œ ì„¤ë¹„ ìŠ¤í™ì— ê°€ê¹ê²Œ</span>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-0.5">
                                íŒ¨ë„/ì¸ë²„í„° ìŠ¤í™ì„ ë§ì¶”ë©´ PFì™€ íŒ¨ë„ ìˆ˜ ê³„ì‚°ì´ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-400">ëª¨ë“ˆ ì„ íƒ</label>
                            <select id="moduleSelect"
                                    class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/90 px-2.5 py-1.5 text-xs text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400">
                                <option value="">ìë™ ì¶”ì²œ</option>
                            </select>
                            <div class="mt-1 text-[10px] text-slate-400" id="moduleInfo">-</div>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400">ì¸ë²„í„° ì„ íƒ</label>
                            <select id="inverterSelect"
                                    class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/90 px-2.5 py-1.5 text-xs text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400">
                                <option value="">ìë™ ì¶”ì²œ</option>
                            </select>
                            <div class="mt-1 text-[10px] text-slate-400" id="inverterInfo">-</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-400">ëª¨ë“ˆ 1ì¥ ìš©ëŸ‰ (W)</label>
                            <input id="modPower" type="number" value="450"
                                   class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/90 px-2.5 py-1.5 text-xs text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400">ì¸ë²„í„° íš¨ìœ¨ (%)</label>
                            <input id="invEff" type="number" value="97"
                                   class="mt-1 w-full rounded-lg border border-slate-700 bg-slate-900/90 px-2.5 py-1.5 text-xs text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                        </div>
                    </div>
                </div>

                <!-- Section 4: ìë™ í›„ë³´ ìŠ¤ìº” (ì „ìˆ˜ ìŠ¤ìº” ì˜µì…˜ í¬í•¨) -->
                <div id="autoScanCard" class="glass-soft px-3.5 py-3 space-y-2 bg-slate-950/95 border border-slate-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-100">4. ìë™ í›„ë³´ ìŠ¤ìº”</span>
                                <span class="text-[10px] text-slate-400">VWorld ê±´ë¬¼/í† ì§€ í´ë¦¬ê³¤ ìë™ ìˆ˜ì§‘</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-slate-300">
                            <label class="inline-flex items-center gap-1">
                                <input id="autoScanToggle" type="checkbox"
                                       class="w-3.5 h-3.5 rounded border-slate-500 bg-slate-900 text-emerald-400 focus:ring-emerald-500"
                                       checked />
                                <span>ì§€ë„ ì´ë™ì‹œ ìë™ ìŠ¤ìº”</span>
                            </label>
                        </div>
                    </div>

                    <!-- ì „ìˆ˜ ìŠ¤ìº” ì˜µì…˜ ë°•ìŠ¤ -->
                    <div class="mt-2 space-y-2">
                        <div class="flex justify-between items-center bg-slate-900/80 border border-slate-700 rounded-xl px-2.5 py-1.5">
                            <div class="flex items-center gap-2">
                                <label for="scanSteps" class="text-[10px] font-semibold text-cyan-300">ìŠ¤ìº” ìŠ¤í… ìˆ˜</label>
                                <select id="scanSteps"
                                        class="bg-slate-950 text-[11px] font-mono border-none outline-none text-emerald-300">
                                    <option value="20" selected>20</option>
                                    <option value="30">30</option>
                                    <option value="40">40</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="scanDelay" class="text-[10px] font-semibold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</label>
                                <select id="scanDelay"
                                        class="bg-slate-950 text-[11px] font-mono border-none outline-none text-yellow-300">
                                    <option value="6000" selected>6ì´ˆ (ê¶Œì¥)</option>
                                    <option value="3000">3ì´ˆ (ë¹ ë¦„/ì°¨ë‹¨ìœ„í—˜)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Timer / Progress -->
                        <div class="flex justify-between items-end mt-1">
                            <div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">00:00:00</div>
                            <div class="text-right">
                                <div id="progressCount" class="text-[10px] text-gray-300 font-mono">0 / 20</div>
                                <div id="timerTotal" class="text-[10px] text-cyan-300 font-mono">ì´ 00:00:00</div>
                            </div>
                        </div>

                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div id="totalProgressBar"
                                 class="bg-cyan-400 h-full transition-all duration-500"
                                 style="width: 0%"></div>
                        </div>

                        <div class="flex justify-between items-center mt-1 px-0.5">
                            <div id="foundCount" class="text-[10px] text-cyan-300 font-semibold">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div>
                            <div class="flex items-center gap-2 text-[10px] text-slate-300">
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" id="autoFollow"
                                           class="w-3.5 h-3.5 rounded border-slate-500 bg-slate-900 text-indigo-400 focus:ring-indigo-500"
                                           checked />
                                    <span>ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</span>
                                </label>
                            </div>
                        </div>

                        <!-- ìŠ¤ìº” ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button type="button"
                                    id="startBtn"
                                    onclick="window.startMission()"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-1.5 rounded-lg flex items-center justify-center">
                                â–¶ ìŠ¤ìº” ì‹œì‘
                            </button>
                            <button type="button"
                                    onclick="window.cancelMission(true)"
                                    class="bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-semibold py-1.5 rounded-lg flex items-center justify-center">
                                â–  ì¤‘ì§€(ê²°ê³¼ ìœ ì§€)
                            </button>
                            <button type="button"
                                    onclick="window.downloadScanResults('geojson')"
                                    class="col-span-2 bg-slate-900 hover:bg-slate-800 text-slate-100 text-xs font-semibold py-1.5 rounded-lg flex items-center justify-center">
                                â¬‡ GeoJSON ë‚´ë³´ë‚´ê¸°
                            </button>
                            <button type="button"
                                    onclick="window.location.href='/lists'"
                                    class="col-span-2 bg-slate-900 hover:bg-slate-800 text-slate-100 text-xs font-semibold py-1.5 rounded-lg flex items-center justify-center">
                                ğŸ“‹ í›„ë³´ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div id="panel-analysis" class="hidden space-y-3">
                <div class="glass-soft px-3.5 py-3 space-y-2">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-100">ì •ë°€ ë¶„ì„ íŒ¨ë„</span>
                                <span class="badge inline-flex items-center space-x-1">
                                    <i class="ph ph-brain text-indigo-400"></i>
                                    <span>AI + PF + 8ëŒ€ ì¤‘ëŒ€</span>
                                </span>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-0.5">
                                ì„ íƒí•œ í›„ë³´ì— ëŒ€í•´ AI/ì¡°ë¡€/í•œì „/8ëŒ€ ì¤‘ëŒ€ ì²´í¬ë¥¼ í¬í•¨í•˜ì—¬ ì‹¬ì¸µ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-300 mt-1">
                        <button id="btnAnalyzeSelected" class="btn-primary px-3 py-1.5 text-xs flex items-center gap-1">
                            <i class="ph ph-magic-wand"></i>
                            <span>ì„ íƒ êµ¬ì—­ ë¶„ì„</span>
                        </button>
                        <button id="btnAnalyzeDeep" class="btn-soft px-2.5 py-1 text-[11px] flex items-center gap-1">
                            <i class="ph ph-brain"></i>
                            <span>AI ì‹¬ì¸µ ë¶„ì„</span>
                        </button>
                        <button id="btnExportPdf" class="btn-soft px-2.5 py-1 text-[11px] flex items-center gap-1">
                            <i class="ph ph-file-pdf"></i>
                            <span>PDF ë¦¬í¬íŠ¸</span>
                        </button>
                    </div>
                </div>

                <div id="resultCard" class="hidden glass-card px-3.5 py-3 space-y-3 bg-slate-950/95">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-bold text-slate-50 flex items-center gap-2">
                            <i class="ph ph-graph"></i>
                            <span>ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</span>
                        </h3>
                        <div class="flex items-center gap-2 text-[10px] text-slate-300">
                            <span class="tag">ì‹¤ì‹œê°„ ì¶”ì •</span>
                            <span class="tag">PF/ì¡°ë¡€/8ëŒ€ ì¤‘ëŒ€ í†µí•©</span>
                        </div>
                    </div>

                    <div class="space-y-1.5 text-xs">
                        <div class="flex justify-between">
                            <span class="text-slate-400">ì£¼ì†Œ:</span>
                            <span id="analysisAddress" class="text-right truncate max-w-[200px] text-slate-100">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">ìˆ˜ëŸ‰:</span>
                            <span id="analysisCount" class="text-slate-100">0 ì¥</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">ì„¤ë¹„ ìš©ëŸ‰(DC):</span>
                            <span id="analysisCapacity" class="text-cyan-300 font-semibold">0 kW</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">ì—°ê°„ ë°œì „ëŸ‰(ì¶”ì •):</span>
                            <span id="analysisGeneration" class="text-emerald-300">- kWh</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">ê°„ë‹¨ ìˆ˜ìµì„±(PF):</span>
                            <span id="analysisPF" class="text-amber-300">-</span>
                        </div>
                    </div>

                    <!-- Detail Tabs -->
                    <div id="detailTabs" class="mt-2">
                        <div class="flex items-center gap-2 border-b border-slate-700 pb-1.5 mb-2">
                            <button data-tab="summary" class="tab-button active text-xs text-slate-100 border-b-2 border-emerald-400 pb-1">
                                ìš”ì•½
                            </button>
                            <button data-tab="checks" class="tab-button text-xs text-slate-400 pb-1">
                                8ëŒ€ ì¤‘ëŒ€ ì²´í¬
                            </button>
                            <button data-tab="ordinance" class="tab-button text-xs text-slate-400 pb-1">
                                ì¡°ë¡€/ì´ê²©ê±°ë¦¬
                            </button>
                            <button data-tab="finance" class="tab-button text-xs text-slate-400 pb-1">
                                PF/ì¬ë¬´
                            </button>
                        </div>

                        <div id="tab-summary" class="space-y-2 text-xs text-slate-200">
                            <div class="flex items-center justify-between">
                                <span>ì¢…í•© ì ìˆ˜</span>
                                <span id="summaryScore" class="text-lg font-bold text-emerald-400">-</span>
                            </div>
                            <div id="summaryText" class="text-slate-300">
                                -
                            </div>
                        </div>

                        <div id="tab-checks" class="hidden space-y-2 text-xs text-slate-200">
                            <div id="checksContent">
                                <div class="text-slate-400">8ëŒ€ ì¤‘ëŒ€ ì²´í¬ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>

                        <div id="tab-ordinance" class="hidden space-y-2 text-xs text-slate-200">
                            <div id="ordinanceContent">
                                <div class="text-slate-400">ì¡°ë¡€/ë²•ë ¹ ë° ì´ê²©ê±°ë¦¬ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>

                        <div id="tab-finance" class="hidden space-y-2 text-xs text-slate-200">
                            <div id="financeContent">
                                <div class="text-slate-400">PF/ì¬ë¬´ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                    <div class="w-5 h-5 border-2 border-slate-500 border-t-sky-400 rounded-full animate-spin mb-2"></div>
                    <p class="text-xs text-slate-400">ì²˜ë¦¬ ì¤‘...</p>
                </div>
            </div>

            <!-- PF / Report Panel (ìš”ì•½ë§Œ, ìƒì„¸ ë¡œì§ì€ JSì—ì„œ) -->
            <div id="panel-pf" class="hidden space-y-3">
                <div class="glass-soft px-3.5 py-3 space-y-2">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-100">PF/ë¦¬í¬íŠ¸</span>
                                <span class="badge inline-flex items-center space-x-1">
                                    <i class="ph ph-file-text text-sky-500"></i>
                                    <span>CAPEX Â· DSCR Â· ë¦¬í¬íŠ¸ ì¶œë ¥</span>
                                </span>
                            </div>
                            <p class="text-[11px] text-slate-400 mt-0.5">
                                ê¸°ë³¸ PF ê°€ì •ìœ¼ë¡œ DSCRì„ ê°€ë³ê²Œ í™•ì¸í•˜ê³ , PDF ë¦¬í¬íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>

                    <div class="space-y-2 text-xs text-slate-200">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-400">CAPEX ë‹¨ê°€ (ì›/kW)</label>
                                <input id="capexPerKw" type="number" value="1300000"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400">O&M ë¹„ìœ¨ (%/ë…„)</label>
                                <input id="omrRatio" type="number" value="2"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-400">ëŒ€ì¶œ ë¹„ìœ¨ (%)</label>
                                <input id="loanRatio" type="number" value="80"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400">ëŒ€ì¶œê¸ˆë¦¬ (%/ë…„)</label>
                                <input id="loanRate" type="number" value="5.5"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-400">ëŒ€ì¶œê¸°ê°„ (ë…„)</label>
                                <input id="loanYears" type="number" value="15"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400">1ë…„ì°¨ ì „ê¸°ìš”ê¸ˆ (ì›/kWh)</label>
                                <input id="tariffFirstYear" type="number" value="130"
                                       class="mt-1 w-full rounded-lg border border-slate-300 bg-white/95 px-2 py-1.5 text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:border-sky-400" />
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button id="btnCalcPF" class="btn-primary w-full py-1.5 text-xs flex items-center justify-center gap-1">
                            <i class="ph ph-calculator"></i>
                            <span>PF/DSCR ê³„ì‚°</span>
                        </button>
                    </div>
                </div>

                <div id="pfResultCard" class="hidden glass-card px-3.5 py-3 space-y-2 bg-slate-950/95">
                    <h3 class="text-sm font-semibold text-slate-50 flex items-center gap-2">
                        <i class="ph ph-presentation-chart"></i>
                        <span>PF ê²°ê³¼ ìš”ì•½</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-200">
                        <div>
                            <div class="text-[10px] text-slate-400">ì´ CAPEX</div>
                            <div id="pfCapexTotal" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400">ìê¸°ìë³¸</div>
                            <div id="pfEquity" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400">ì—°ê°„ ë§¤ì¶œ</div>
                            <div id="pfAnnualRevenue" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400">ì—°ê°„ O&M</div>
                            <div id="pfAnnualOmr" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400">ì—°ê°„ ì›ë¦¬ê¸ˆ</div>
                            <div id="pfAnnualDebtService" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400">DSCR (1ë…„ì°¨)</div>
                            <div id="pfAnnualDscr" class="font-semibold">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom status bar -->
        <div id="bottomStatusBar">
          <div id="bottomStatusInner"
               class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-slate-900/80 border border-emerald-500/60 flex items-center justify-center">
                <span class="text-emerald-400 text-lg">â—</span>
              </div>
              <div>
                <div class="flex items-center gap-1 text-[11px] text-emerald-300">
                  <span id="bottomStatusMain">ìë™ ìŠ¤ìº” ëŒ€ê¸°ì¤‘</span>
                </div>
                <div class="flex items-center gap-2 text-[10px] text-slate-300">
                  <span id="bottomStatusSub">ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ê±°ë‚˜, ìë™ ìŠ¤ìº”ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.</span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button"
                      onclick="window.toggleBottomStatus()"
                      class="btn-soft text-[10px] flex items-center gap-1 px-2 py-1">
                <i id="bottomStatusHandleIcon" class="ph ph-caret-down"></i>
                <span>íŒ¨ë„ ì ‘ê¸°</span>
              </button>
            </div>
          </div>
        </div>
    </aside>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 px-3 py-2 rounded-md bg-black/80 text-white text-xs shadow-lg hidden"></div>

    <!-- Settings Modal -->
    <div id="settingsOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-40">
        <div class="absolute inset-0"></div>
        <div class="relative max-w-4xl w-full mx-4">
            <div class="glass-card bg-slate-950/98 border border-slate-800 p-4 sm:p-5">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-slate-100 flex items-center gap-2">
                        <i class="ph ph-sliders-horizontal"></i>
                        <span>í™˜ê²½ì„¤ì •</span>
                    </h2>
                    <button id="btnCloseSettings" class="w-8 h-8 rounded-full border border-slate-700 flex items-center justify-center text-slate-400 hover:bg-slate-800">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div class="glass-soft px-3 py-2.5 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-semibold text-slate-100">ì§€ë„/ìŠ¤ìº” ì˜µì…˜</span>
                                <span class="badge text-[10px] text-slate-200 border-slate-600">í”„ë¡ íŠ¸ì—”ë“œ</span>
                            </div>
                            <div class="space-y-1.5 text-xs text-slate-200">
                                <div class="flex items-center justify-between">
                                    <span>ê¸°ë³¸ íƒ€ê²Ÿ ë ˆë²¨(feat)</span>
                                    <select id="featLevel"
                                            class="rounded-md border border-slate-600 bg-slate-900 px-2 py-1 text-[11px] text-slate-100">
                                        <option value="3">3 - ë‹¨ì¼ í›„ë³´ í´ë¦­</option>
                                        <option value="4" selected>4 - ìë™ ìŠ¤ìº” + í›„ë³´ ìˆ˜ì§‘</option>
                                        <option value="5">5 - ì‹¤í—˜ ëª¨ë“œ</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>ìë™ ìŠ¤ìº” ë™ì‹œ ë¶„ì„ ìµœëŒ€ ê°œìˆ˜</span>
                                    <input id="maxConcurrency" type="number" value="3"
                                           class="w-16 rounded-md border border-slate-600 bg-slate-900 px-2 py-0.5 text-[11px] text-slate-100" />
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>í•œì „/ì¡°ë¡€ ë“± ì™¸ë¶€ API í˜¸ì¶œ í—ˆìš©</span>
                                    <label class="inline-flex items-center gap-1">
                                        <input id="allowExternalApis" type="checkbox"
                                               class="w-3.5 h-3.5 rounded border-slate-500 bg-slate-900 text-emerald-400 focus:ring-emerald-500"
                                               checked />
                                        <span class="text-[11px] text-slate-200">ê¶Œì¥</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="glass-soft px-3 py-2.5 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-semibold text-slate-100">ë””ìŠ¤í”Œë ˆì´</span>
                            </div>
                            <div class="space-y-1.5 text-xs text-slate-200">
                                <label class="inline-flex items-center gap-2">
                                    <input id="darkMode" type="checkbox" checked
                                           class="w-3.5 h-3.5 rounded border-slate-500 bg-slate-900 text-indigo-400 focus:ring-indigo-500" />
                                    <span>ì–´ë‘ìš´ ëª¨ë“œ ê³ ì •</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="glass-soft px-3 py-2.5 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-semibold text-slate-100">PF/ì¬ë¬´ ê¸°ë³¸ê°’</span>
                            </div>
                            <div class="space-y-1.5 text-xs text-slate-200">
                                <p class="text-[11px] text-slate-300">
                                    PF ê³„ì‚°ì—ì„œ ì‚¬ìš©ë  ê¸°ë³¸ CAPEX/ëŒ€ì¶œ ì¡°ê±´ì…ë‹ˆë‹¤.
                                    í”„ë¡œì íŠ¸ ê·œëª¨/ê¸ˆìœµ ì¡°ê±´ì— ë”°ë¼ ì ì ˆíˆ ì¡°ì •í•´ ì£¼ì„¸ìš”.
                                </p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <div class="text-[10px] text-slate-400">CAPEX ë‹¨ê°€</div>
                                        <div class="font-mono text-xs text-slate-100">1,300,000 ì›/kW</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400">ëŒ€ì¶œ ë¹„ìœ¨</div>
                                        <div class="font-mono text-xs text-slate-100">80 %</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400">ëŒ€ì¶œê¸ˆë¦¬</div>
                                        <div class="font-mono text-xs text-slate-100">5.5 %/ë…„</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400">ëŒ€ì¶œê¸°ê°„</div>
                                        <div class="font-mono text-xs text-slate-100">15 ë…„</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-soft px-3 py-2.5 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-semibold text-slate-100">ë²„ì „ ì •ë³´</span>
                            </div>
                            <div class="space-y-1 text-[11px] text-slate-300">
                                <div>í”„ë¡ íŠ¸ì—”ë“œ: v0.9.x (Auto Scan + PF + 8ëŒ€ ì¤‘ëŒ€)</div>
                                <div>ë°±ì—”ë“œ: Flask API (basic/deep/ai/checks/kepco/report)</div>
                                <div>ë°ì´í„°: VWorld, í•œì „, ì¡°ë¡€(êµ­ê°€ë²•ë ¹/ì§€ìì²´)</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="btnCloseSettings2" class="btn-soft px-3 py-1.5 text-xs flex items-center gap-1">
                        <i class="ph ph-check"></i>
                        <span>ë‹«ê¸°</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Toolbar -->
    <div class="floating-toolbar fixed bottom-20 left-4 z-40">
        <div class="glass-card bg-slate-950/95 border border-slate-800 rounded-2xl p-2 flex flex-col gap-2">
            <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-1.5">
                    <span class="text-[11px] text-slate-200 font-medium">ì§€ë„ ì»¨íŠ¸ë¡¤</span>
                </div>
            </div>
            <div class="flex items-center justify-between gap-3">
                <div class="grid grid-cols-3 gap-1">
                    <button class="d-pad-btn" data-pan="up">
                        <i class="ph ph-caret-up"></i>
                    </button>
                    <button class="d-pad-btn" data-pan="center">
                        <i class="ph ph-crosshair-simple"></i>
                    </button>
                    <button class="d-pad-btn" data-pan="right">
                        <i class="ph ph-caret-right"></i>
                    </button>
                    <button class="d-pad-btn" data-pan="left">
                        <i class="ph ph-caret-left"></i>
                    </button>
                    <button class="d-pad-btn" data-pan="down">
                        <i class="ph ph-caret-down"></i>
                    </button>
                    <button class="d-pad-btn" data-zoom="in">
                        <i class="ph ph-plus"></i>
                    </button>
                    <button class="d-pad-btn" data-zoom="out">
                        <i class="ph ph-minus"></i>
                    </button>
                </div>
                <div class="space-y-1 text-[10px] text-slate-300">
                    <div id="coordDisplay" class="font-mono bg-slate-900/90 rounded-full px-2 py-0.5 border border-slate-700 text-slate-100">
                        37.5665 / 126.9780
                    </div>
                    <div id="bboxText" class="text-[9px] text-slate-400">
                        -
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let BACKEND_URL = "";
(function(){
  try{
    const url = new URL(window.location.href);
    const backend = url.searchParams.get("backend");
    if(backend){
      BACKEND_URL = backend;
    }else{
      BACKEND_URL = "";
    }
  }catch(e){
    BACKEND_URL = "";
  }
  if(BACKEND_URL && BACKEND_URL.endsWith("/")){
    BACKEND_URL = BACKEND_URL.slice(0, -1);
  }
  window.BACKEND_URL = BACKEND_URL;
})();

let VWORLD_TILE_KEY = "";
let KAKAO_JS_KEY = "";
let PUBLIC_VWORLD_KEY = "";

async function loadClientConfig(){
  try{
    const res = await fetch(`${BACKEND_URL || ""}/api/config/client`, {
      method: "GET",
      credentials: "include",
    });
    if(!res.ok) throw new Error("config status " + res.status);
    const j = await res.json();
    const data = j && j.data ? j.data : {};
    VWORLD_TILE_KEY = data.vworld_tile_key || "";
    KAKAO_JS_KEY = data.kakao_js_key || "";
    PUBLIC_VWORLD_KEY = VWORLD_TILE_KEY;

    if(KAKAO_JS_KEY){
      const s = document.createElement("script");
      s.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${encodeURIComponent(KAKAO_JS_KEY)}&libraries=services`;
      s.async = true;
      document.head.appendChild(s);
    }
  }catch(e){
    console.warn("loadClientConfig failed", e);
  }
}
loadClientConfig();

function el(id){ return document.getElementById(id); }

function showToast(msg, ms){
  const t = el("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.remove("hidden");
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=>{
    t.classList.add("hidden");
  }, ms || 3000);
}

function safeText(s){
  if(s == null) return "";
  return String(s);
}

let map;
let selectableGroup;
let panelGroup;
let analysisMarkerGroup;
let scanTarget = "roof";
let scanLock = false;

let FEATURE_LEVEL = parseInt(new URLSearchParams(location.search).get("feat") || "4", 10);

let autoScanMode = true;
let autoScanDebounce = null;
let infraDebounce = null;

let missionRunning = false;
let missionPaused = false;
let missionStop = false;
let missionTotalSteps = 20;
let missionDoneSteps = 0;
let missionDelayMs = 6000;
let missionTotalMs = 0;
let missionRemainingMs = 0;
let missionTimerInterval = null;
let missionLastTick = 0;

function logSystem(msg){
  console.log("[system]", msg);
}

function updateStatus(main, sub){
  const m = el("bottomStatusMain");
  const s = el("bottomStatusSub");
  if(m && main !== undefined) m.textContent = main;
  if(s && sub !== undefined) s.textContent = sub;
}

window.toggleBottomStatus = function(){
  try{
    var inner = document.getElementById("bottomStatusInner");
    var icon = document.getElementById("bottomStatusHandleIcon");
    if(!inner) return;
    var isOpen = inner.classList.contains("open");
    if(isOpen){
      inner.classList.remove("open");
      if(icon){ icon.classList.remove("ph-caret-down"); icon.classList.add("ph-caret-up"); }
    }else{
      inner.classList.add("open");
      if(icon){ icon.classList.remove("ph-caret-up"); icon.classList.add("ph-caret-down"); }
    }
  }catch(e){
    console.error("toggleBottomStatus failed", e);
  }
};

function polygonAreaM2(geo){
  try{
    if(!geo || geo.type !== "Polygon" || !Array.isArray(geo.coordinates)) return 0;
    const ring = geo.coordinates[0];
    if(!Array.isArray(ring) || ring.length < 3) return 0;
    let lat0 = 0;
    for(const p of ring){ lat0 += p[1]; }
    lat0 /= ring.length;
    const cos = Math.cos(lat0 * Math.PI/180);
    const sx = 111320 * cos;
    const sy = 110540;
    let area = 0;
    for(let i=0;i<ring.length;i++){
      const [lng1, lat1] = ring[i];
      const [lng2, lat2] = ring[(i+1)%ring.length];
      const x1 = lng1 * sx; const y1 = lat1 * sy;
      const x2 = lng2 * sx; const y2 = lat2 * sy;
      area += (x1*y2 - x2*y1);
    }
    return Math.abs(area)/2;
  }catch(e){
    return 0;
  }
}

const _hashSeed = (function(){
  function cyrb53(str, seed = 0){
    let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
    for(let i = 0, ch; i < str.length; i++) {
      ch = str.charCodeAt(i);
      h1 = Math.imul(h1 ^ ch, 2654435761);
      h2 = Math.imul(h2 ^ ch, 1597334677);
    }
    h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^
          Math.imul(h2 ^ (h2 >>> 13), 3266489909);
    h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^
          Math.imul(h1 ^ (h1 >>> 13), 3266489909);
    return 4294967296 * (2097151 & h2) + (h1 >>> 0);
  }
  return function(str){ return cyrb53(str, 0); };
})();

let calibration = { rot_deg: 0, dx_m: 0, dy_m: 0 };

function metersToKm(m){ return (m || 0) / 1000; }

function applyCalibrationToFC(fc){
  if(!window.turf || !fc) return fc;
  let out = turf.clone(fc);
  if(calibration.rot_deg){
    try { out = turf.transformRotate(out, calibration.rot_deg); } catch(e) {}
  }
  if(calibration.dx_m){
    try { out = turf.transformTranslate(out, metersToKm(calibration.dx_m), 90, {units:"kilometers"}); } catch(e) {}
  }
  if(calibration.dy_m){
    try { out = turf.transformTranslate(out, metersToKm(calibration.dy_m), 0, {units:"kilometers"}); } catch(e) {}
  }
  return out;
}

function buildPanelsFCFromGeometry(geo){
  return { type: "FeatureCollection", features: [] };
}

function ensureSolarTexture(){
  try{
    const svg = document.querySelector("#map svg");
    if(!svg) return;
    if(svg.querySelector("#sp-solar-pattern")) return;
    const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
    const pattern = document.createElementNS("http://www.w3.org/2000/svg","pattern");
    pattern.setAttribute("id","sp-solar-pattern");
    pattern.setAttribute("patternUnits","userSpaceOnUse");
    pattern.setAttribute("width","12");
    pattern.setAttribute("height","12");
    const bg = document.createElementNS("http://www.w3.org/2000/svg","rect");
    bg.setAttribute("x","0"); bg.setAttribute("y","0");
    bg.setAttribute("width","12"); bg.setAttribute("height","12");
    bg.setAttribute("fill","#0b1120");
    bg.setAttribute("opacity","0.9");
    const line1 = document.createElementNS("http://www.w3.org/2000/svg","path");
    line1.setAttribute("d","M0 4 H12 M0 8 H12");
    line1.setAttribute("stroke","#38bdf8");
    line1.setAttribute("stroke-width","0.8");
    line1.setAttribute("opacity","0.4");
    const line2 = document.createElementNS("http://www.w3.org/2000/svg","path");
    line2.setAttribute("d","M4 0 V12 M8 0 V12");
    line2.setAttribute("stroke","#38bdf8");
    line2.setAttribute("stroke-width","0.8");
    line2.setAttribute("opacity","0.25");
    pattern.appendChild(bg);
    pattern.appendChild(line1);
    pattern.appendChild(line2);
    defs.appendChild(pattern);
    svg.insertBefore(defs, svg.firstChild);
  }catch(e){}
}

function applySolarTextureToLayer(layer){
  try{
    ensureSolarTexture();
    if(layer && layer._path){
      layer._path.setAttribute("fill", "url(#sp-solar-pattern)");
      layer._path.setAttribute("fill-opacity", "0.80");
      layer._path.setAttribute("stroke", "#020617");
      layer._path.setAttribute("stroke-opacity", "0.7");
    }
  }catch(e){}
}

function renderPanelsFC(fc){
  const style = {
    color: "#020617",
    weight: 1,
    fillColor: "#0b1120",
    fillOpacity: 0.80
  };
  return L.geoJSON(fc, {
    style,
    onEachFeature: (feature, layer)=>{
      setTimeout(()=>applySolarTextureToLayer(layer), 0);
    }
  });
}

function getFeatureId(feature){
  const props = feature?.properties || {};
  if(props.pnu) return `pnu:${props.pnu}`;
  try{
    const c = turf.center(feature).geometry.coordinates;
    return `c:${c[1].toFixed(6)}:${c[0].toFixed(6)}`;
  } catch(e){
    return `t:${_hashSeed(JSON.stringify(props||{}))}`;
  }
}

function _spGetCandidateArray(){
  if(!Array.isArray(window.spScanCandidates)){
    window.spScanCandidates = [];
  }
  return window.spScanCandidates;
}

function spBuildCandidateFromFeature(feature, hintCenter, mode){
  if(!feature) return null;
  try{
    const props = feature.properties || {};
    const id = getFeatureId(feature);
    if(!id) return null;

    let centerLat = null;
    let centerLng = null;
    try{
      const center = turf.center(feature);
      if(center && center.geometry && Array.isArray(center.geometry.coordinates)){
        centerLng = Number(center.geometry.coordinates[0]);
        centerLat = Number(center.geometry.coordinates[1]);
      }
    }catch(e){}

    if((centerLat == null || isNaN(centerLat)) && hintCenter){
      centerLat = hintCenter.lat;
      centerLng = hintCenter.lng;
    }

    let area = null;
    try{
      if(feature.geometry){
        area = polygonAreaM2(feature.geometry);
      }
    }catch(e){
      area = null;
    }

    const PANEL_AREA = 1.13 * 2.2;
    const PACKING_RATIO = 0.7;
    let panelCount = null;
    if(area && area > 0 && PANEL_AREA > 0){
      panelCount = Math.floor((area * PACKING_RATIO) / PANEL_AREA);
    }

    let projectDcKw = null;
    try{
      const mpEl = el("modPower");
      const modPower = mpEl ? (parseFloat(mpEl.value || "0") || 0) : 0;
      if(modPower > 0 && panelCount && panelCount > 0){
        projectDcKw = (panelCount * modPower) / 1000;
      }
    }catch(e){}

    const address = props.road_nm_ad
      || props.jibun_addr
      || props.addr
      || props.address
      || (props.pnu ? `PNU:${props.pnu}` : "")
      || "";

    return {
      id,
      address,
      pnu: props.pnu || null,
      lat: centerLat,
      lng: centerLng,
      mode: mode || (props.bld_nm ? "roof" : "land"),
      project_dc_kw: projectDcKw,
      panel_count: panelCount,
      area_m2: area,
      created_at: new Date().toISOString()
    };
  }catch(e){
    console.warn("[sp] spBuildCandidateFromFeature error", e);
    return null;
  }
}

function spAddScanCandidate(cand){
  if(!cand || !cand.id) return;
  const arr = _spGetCandidateArray();
  if(arr.find(x => x.id === cand.id)) return;
  arr.push(cand);
}

function spCollectCandidatesFromFeatures(features, hintCenter, mode){
  try{
    if(!Array.isArray(features)) return;
    for(const f of features){
      const cand = spBuildCandidateFromFeature(f, hintCenter, mode);
      if(cand) spAddScanCandidate(cand);
    }
  }catch(e){
    console.warn("[sp] spCollectCandidatesFromFeatures error", e);
  }
}

window.spCollectCandidatesFromFeatures = spCollectCandidatesFromFeatures;
window.spAddScanCandidate = spAddScanCandidate;

window.drawPanels = function(geo){
  const fc = applyCalibrationToFC(buildPanelsFCFromGeometry(geo));
  panelGroup.clearLayers();
  renderPanelsFC(fc).addTo(panelGroup);
  return fc.features.length;
};

function updateResultCardBasics(addr, panelCount){
  const rc = el("resultCard");
  if(rc) rc.classList.remove("hidden");
  if(el("analysisAddress")) el("analysisAddress").innerText = safeText(addr);
  if(el("analysisCount")) el("analysisCount").innerText = `${panelCount} ì¥`;
  const modPower = parseFloat(el("modPower")?.value || "640") || 640;
  const dcKw = (panelCount * modPower) / 1000;
  const acKw = dcKw / 1.15;
  if(el("analysisCapacity")) el("analysisCapacity").innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;
}

let autoScanBox = null;
function updateAutoScanBox(){
  if(!map){
    if(autoScanBox){ try{ autoScanBox.remove(); }catch(e){} autoScanBox=null; }
    return;
  }
  if(!(FEATURE_LEVEL >= 4 && autoScanMode)){
    if(autoScanBox){ try{ autoScanBox.remove(); }catch(e){} autoScanBox=null; }
    return;
  }
  const c = map.getCenter();
  const halfMeters = 250;
  const dLat = halfMeters / 111320;
  const dLng = halfMeters / (111320 * Math.max(0.2, Math.cos(c.lat * Math.PI / 180)));
  const bounds = [[c.lat - dLat, c.lng - dLng], [c.lat + dLat, c.lng + dLng]];
  if(!autoScanBox){
    autoScanBox = L.rectangle(bounds, {color:"#fbbf24", weight:2, fillOpacity:0, dashArray:"5,5"}).addTo(map);
  }else{
    autoScanBox.setBounds(bounds);
  }
}

async function postJson(url, body){
  const res = await fetch(url, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(body||{}),
    credentials:"include"
  });
  const text = await res.text();
  let data = null;
  try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
  return { ok: res.ok, status: res.status, data };
}

async function analyzeOneCandidate(base){
  const item = Object.assign({}, base || {});
  const backend = BACKEND_URL || "";

  const payload = {
    address: item.address || "",
    mode: item.mode || ((typeof scanTarget !== "undefined" && scanTarget === "land") ? "land" : "roof"),
    lat: item.lat,
    lng: item.lng,
    pnu: item.pnu || null,
    panel_count: item.panel_count ?? null,
    project_dc_kw: item.project_dc_kw ?? null,
    setback_m: (function(){
      try{
        const elSetback = document.getElementById("setbackDist");
        const v = elSetback ? parseFloat(elSetback.value || "0") : 0;
        if(!isNaN(v) && v > 0) return v;
      }catch(e){}
      return item.setback_m ?? null;
    })()
  };

  try{
    const basicUrl = `${backend || ""}/api/analyze/basic`;
    const res = await postJson(basicUrl, payload);
    if(res && res.data){
      const d = res.data;
      item.basic = d;
      if(typeof d.attractiveness_score !== "undefined") item.attractiveness_score = d.attractiveness_score;
      if(typeof d.setback_m !== "undefined" && d.setback_m !== null) item.setback_m = d.setback_m;
      if(d.checks) item.checks = d.checks;
      if(d.check_list) item.check_list = d.check_list;
      if(d.ordinance_ai) item.ordinance_ai = d.ordinance_ai;
      if(d.solar) item.solar = d.solar;
      if(d.finance_basic) item.finance_basic = d.finance_basic;
    }else{
      item.error_basic = `basic analyze failed (status ${res && res.status})`;
    }
  }catch(e){
    console.warn("[sp] basic analyze error", e);
    item.error_basic = (e && e.message) || String(e);
  }

  try{
    const params = new URLSearchParams();
    if(item.pnu) params.set("pnu", item.pnu);
    else if(item.address) params.set("address", item.address);
    const qs = params.toString();
    let url = `${backend || ""}/api/infra/kepco`;
    if(qs) url += `?${qs}`;
    const resp = await fetch(url, { method: "GET", credentials: "include" });
    const j = await resp.json().catch(()=>null);
    if(j){
      item.kepco = j;
      const kc = j.kepco_capacity ?? j.kepcoCapacity ?? j.capacity ?? j.remain_mw ?? j.remain_kw ?? null;
      if(kc != null) item.kepco_capacity = kc;
    }
  }catch(e){
    console.warn("[sp] kepco analyze error", e);
    item.error_kepco = (e && e.message) || String(e);
  }

  return item;
}

async function runBatchAnalysis(candidates, concurrency, onProgress){
  const list = Array.isArray(candidates) ? candidates.slice() : [];
  const total = list.length;
  const limit = Math.max(1, Math.min(5, concurrency || 2));
  const results = new Array(total);
  let done = 0;
  let cursor = 0;

  async function worker(){
    while(true){
      const idx = cursor++;
      if(idx >= total) return;
      const item = list[idx];
      try{
        results[idx] = await analyzeOneCandidate(item);
      }catch(e){
        results[idx] = Object.assign({}, item || {}, {
          error: (e && e.message) || String(e),
        });
      }
      done += 1;
      if(typeof onProgress === "function"){
        try{ onProgress(done, total); }catch(_e){}
      }
    }
  }

  const workers = [];
  for(let i=0;i<limit;i++){
    workers.push(worker());
  }
  await Promise.all(workers);
  return results.filter(Boolean);
}
window.analyzeOneCandidate = analyzeOneCandidate;
window.runBatchAnalysis = runBatchAnalysis;

(function(){
  function ensureAnalysisProgressElements(){
    try{
      if(document.getElementById("analysisProgressBar")) return;
      const found = document.getElementById("foundCount");
      if(!found || !found.parentElement || !found.parentElement.parentElement) return;
      const container = found.parentElement.parentElement;

      const barWrap = document.createElement("div");
      barWrap.className = "w-full bg-slate-700 rounded-full h-1 overflow-hidden mt-1";

      const bar = document.createElement("div");
      bar.id = "analysisProgressBar";
      bar.className = "bg-emerald-400 h-full transition-all duration-500";
      bar.style.width = "0%";
      barWrap.appendChild(bar);

      const text = document.createElement("div");
      text.id = "analysisProgressText";
      text.className = "text-[9px] text-slate-300 mt-1 text-right";

      const parent = container.parentElement;
      parent.insertBefore(barWrap, container.nextSibling);
      parent.insertBefore(text, barWrap.nextSibling);
    }catch(e){
      console.warn("[sp] ensureAnalysisProgressElements error", e);
    }
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ensureAnalysisProgressElements);
  }else{
    ensureAnalysisProgressElements();
  }
})();

const __CHECK_LINKS = {
  "ì¡°ë¡€": "https://www.elis.go.kr/",
  "ìš©ë„ì§€ì—­": "https://www.eum.go.kr/web/am/amMain.jsp",
  "ìƒìœ„ë²•": "https://law.go.kr/main.html",
  "ìƒíƒœ": "https://aid.mcee.go.kr/",
  "ë¬¸í™”ì¬": "https://www.nie-ecobank.kr/cmmn/Index.do",
  "ê²½ì‚¬": "https://webgis.neins.go.kr/map.do",
  "ê³„í†µ": "https://online.kepco.co.kr/",
  "ë³€ì „ì†Œ": "https://online.kepco.co.kr/",
  "ì„ ë¡œ": "https://online.kepco.co.kr/",
  "í•œì „": "https://online.kepco.co.kr/",
};
function __deriveCheckLink(title){
  const t = String(title||"");
  for(const k in __CHECK_LINKS){
    if(t.includes(k)) return __CHECK_LINKS[k];
  }
  if(t.includes("ë„ì‹œ") || t.includes("êµ°") || t.includes("ì§€ìì²´")) return "https://www.elis.go.kr/";
  return "";
}

async function jsonpRequest(url){
  return new Promise((resolve, reject)=>{
    const cbName = "__vworld_cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    s.src = url + "&format=json&callback=" + cbName;
    s.onerror = ()=>{ delete window[cbName]; reject(new Error("jsonp error")); };
    window[cbName] = function(data){
      delete window[cbName];
      document.body.removeChild(s);
      resolve(data);
    };
    document.body.appendChild(s);
  });
}

async function scanBuildings(lat, lng, force=false){
  if(FEATURE_LEVEL < 3) return null;
  if(scanLock && !force) return null;
  scanLock = true;

  try{
    analysisMarkerGroup.clearLayers();
    try{
      const mk = L.marker([lat, lng], { keyboard:false, interactive:false });
      mk.addTo(analysisMarkerGroup);
    }catch(e){}
    const z = map.getZoom();
    const d = (z >= 17) ? 0.0016 : (z >= 16 ? 0.0028 : 0.0042);
    const box = `${lng - d},${lat - d},${lng + d},${lat + d}`;
    const dataName = (scanTarget === "land") ? "LP_PA_CBND_BUBUN" : "LT_C_SPBD";
    const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${dataName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=${(z>=17)?80:(z>=16?120:180)}`;
    const data = await jsonpRequest(url);

    const fc = data?.response?.result?.featureCollection;
    const fetchedFeatures = fc?.features || [];
    window.lastScanCandidates = fetchedFeatures;

    try{
      if(Array.isArray(fetchedFeatures) && fetchedFeatures.length){
        spCollectCandidatesFromFeatures(
          fetchedFeatures,
          { lat, lng },
          (scanTarget === "land" ? "land" : "roof")
        );
      }
    }catch(e){
      console.warn("[sp] candidate collect failed", e);
    }

    selectableGroup.clearLayers();
    L.geoJSON(fetchedFeatures, {
      style: (scanTarget === "land")
        ? { color:"#8d6e63", weight:2, fillColor:"#8d6e63", fillOpacity:0.25 }
        : { color:"#3b82f6", weight:2, fillOpacity:0.20 },
      onEachFeature: (feature, layer) => {
        layer.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          analyzeFeature(feature, true);
        });
      }
    }).addTo(selectableGroup);

    const found = el("foundCount");
    if(found) found.innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${selectableGroup.getLayers().length}ê°œ`;

    return { features: fetchedFeatures, count: fetchedFeatures.length };
  } catch(e){
    console.error(e);
    logSystem(`scan error: ${e.message}`);
    return null;
  } finally {
    setTimeout(()=>{ scanLock = false; }, 500);
  }
}
window.scanBuildings = scanBuildings;

function updateCoordDisplay(latlng){
  const elc = document.getElementById("coordDisplay");
  if(!elc || !latlng) return;
  const lat = latlng.lat.toFixed(6);
  const lng = latlng.lng.toFixed(6);
  elc.textContent = `${lat} / ${lng}`;
}

function refreshInfraIfNeeded(){}

function initMap(){
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 15,
    zoomControl: true,
  });

  const vworldKey = VWORLD_TILE_KEY || "sample";
  const baseLayers = {};
  baseLayers["ìœ„ì„±"] = L.tileLayer(
    `https://api.vworld.kr/req/wmts/1.0.0/${encodeURIComponent(vworldKey)}/Satellite/{z}/{y}/{x}.jpeg`,
    { maxZoom: 19, attribution: "VWorld Satellite" }
  );
  baseLayers["ì§€ë„"] = L.tileLayer(
    `https://api.vworld.kr/req/wmts/1.0.0/${encodeURIComponent(vworldKey)}/Base/{z}/{y}/{x}.png`,
    { maxZoom: 19, attribution: "VWorld Base" }
  );
  baseLayers["ìœ„ì„±"].addTo(map);

  selectableGroup = L.layerGroup().addTo(map);
  panelGroup = L.layerGroup().addTo(map);
  analysisMarkerGroup = L.layerGroup().addTo(map);
  L.control.layers(baseLayers, null, { position: "topleft" }).addTo(map);

  let _lastMapClickTs = 0;
  map.on("click", (e) => {
    if(FEATURE_LEVEL < 3) return;
    if(map.dragging && map.dragging._draggable && map.dragging._draggable._moving) return;
    const now = Date.now();
    if(now - _lastMapClickTs < 250) return;
    _lastMapClickTs = now;
    updateCoordDisplay(e.latlng);
    setTimeout(()=>{ 
      try{ scanBuildings(e.latlng.lat, e.latlng.lng, true); }catch(err){ console.warn(err); }
    }, 60);
  });

  map.on("moveend", () => {
    try { updateAutoScanBox(); } catch(e) {}
    if(FEATURE_LEVEL < 4) return;
    if(!autoScanMode) return;
    const autoFollow = el("autoFollow");
    if(autoFollow && autoFollow.checked) return;
    if(autoScanDebounce) clearTimeout(autoScanDebounce);
    autoScanDebounce = setTimeout(() => {
      const c = map.getCenter();
      scanBuildings(c.lat, c.lng, true);
    }, 450);
    try{
      if(infraDebounce) clearTimeout(infraDebounce);
      infraDebounce = setTimeout(()=>{ refreshInfraIfNeeded(); }, 650);
    }catch(e){}
  });

  map.on("zoomend", () => {
    try { refreshInfraIfNeeded(); } catch(e) {}
  });

  try { refreshInfraIfNeeded(); } catch(e) {}
  logSystem(`System ready. feat=${FEATURE_LEVEL}`);

  try{
    const chk = document.getElementById("autoScanToggle");
    if(chk) chk.checked = true;
    autoScanMode = true;
    updateAutoScanBox();
  }catch(e){}

  const bounds = map.getBounds();
  const text = `${bounds.getSouth().toFixed(4)}, ${bounds.getWest().toFixed(4)} ~ ${bounds.getNorth().toFixed(4)}, ${bounds.getEast().toFixed(4)}`;
  const bboxEl = document.getElementById("bboxText");
  if(bboxEl) bboxEl.textContent = text;

  updateStatus("ì§€ë„ ì¤€ë¹„ ì™„ë£Œ", "ì§€ë„ì—ì„œ í›„ë³´ êµ¬ì—­ì„ ì„ íƒí•˜ê±°ë‚˜, ìë™ ìŠ¤ìº”ì„ ì‹œì‘í•´ ë³´ì„¸ìš”.");
}

function startMissionTimer(){
  stopMissionTimer();
  missionLastTick = Date.now();
  missionTimerInterval = setInterval(()=>{
    if(!missionRunning){ stopMissionTimer(); return; }
    const now = Date.now();
    if(missionPaused){
      missionLastTick = now;
      return;
    }
    const dt = Math.max(0, now - missionLastTick);
    missionLastTick = now;
    missionRemainingMs = Math.max(0, missionRemainingMs - dt);
    const remainingSec = Math.round(missionRemainingMs / 1000);
    const h = String(Math.floor(remainingSec/3600)).padStart(2,"0");
    const m = String(Math.floor((remainingSec%3600)/60)).padStart(2,"0");
    const s = String(remainingSec%60).padStart(2,"0");
    const remEl = el("timerRemaining");
    if(remEl) remEl.textContent = `${h}:${m}:${s}`;
    const totalEl = el("timerTotal");
    if(totalEl){
      const totalSec = Math.round(missionTotalMs / 1000);
      const th = String(Math.floor(totalSec/3600)).padStart(2,"0");
      const tm = String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
      const ts = String(totalSec%60).padStart(2,"0");
      totalEl.textContent = `ì´ ${th}:${tm}:${ts}`;
    }
  }, 500);
}

function stopMissionTimer(){
  if(missionTimerInterval){
    clearInterval(missionTimerInterval);
    missionTimerInterval = null;
  }
}

window.updateEstimatedTime = function(){
  const delaySel = el("scanDelay");
  missionDelayMs = parseInt(delaySel?.value || "6000", 10);
  missionTotalSteps = parseInt(el("scanSteps")?.value || "20", 10) || 20;
  missionTotalMs = missionTotalSteps * missionDelayMs;
  missionRemainingMs = missionTotalMs;
  const summaryEl = el("timerTotal");
  if(summaryEl){
    const totalSec = Math.round(missionTotalMs / 1000);
    const h = String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m = String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s = String(totalSec%60).padStart(2,"0");
    summaryEl.textContent = `ì´ ${h}:${m}:${s}`;
  }
};

function clearResults(keepCandidates){
  selectableGroup.clearLayers();
  panelGroup.clearLayers();
  analysisMarkerGroup.clearLayers();
  if(!keepCandidates){
    window.spScanCandidates = [];
  }
  const found = el("foundCount");
  if(found) found.innerText = "ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ";
  const bar = el("analysisProgressBar");
  if(bar) bar.style.width = "0%";
  const txt = el("analysisProgressText");
  if(txt) txt.innerText = "";
}

window.cancelMission = function(keepResults){
  missionStop = true;
  missionPaused = false;
  missionRunning = false;
  stopMissionTimer();
  const btn = el("startBtn");
  if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";
  if(!keepResults){
    clearResults(true);
  }
  window.updateEstimatedTime();
};

window.startMission = async function(){
  if(FEATURE_LEVEL < 4){
    showToast("feat<4: ì „ìˆ˜ ìŠ¤ìº” ë¹„í™œì„±");
    return;
  }
  if(!map) return;

  if(missionRunning){
    missionPaused = !missionPaused;
    const btn = el("startBtn");
    if(btn) btn.innerText = missionPaused ? "â–¶ ì¬ê°œ" : "â¸ ì¼ì‹œì •ì§€";
    showToast(missionPaused ? "ì¼ì‹œì •ì§€" : "ì¬ê°œ");
    return;
  }

  missionTotalSteps = parseInt(el("scanSteps")?.value || "20", 10) || 20;
  missionRunning = true;
  missionPaused = false;
  missionStop = false;
  missionDoneSteps = 0;

  window.spScanCandidates = [];
  const plan = null;
  window.spLastMissionMeta = {
    region_key: "gyeonggi",
    region_name: plan ? (plan.name || "") : "",
    mission_name: "ìë™ ìŠ¤ìº”",
    mission_delay_ms: missionDelayMs,
    mission_total_steps: missionTotalSteps,
    started_at: new Date().toISOString(),
  };

  const found = el("foundCount");
  if(found) found.innerText = "ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ";

  updateStatus("ìë™ ìŠ¤ìº” ì§„í–‰ ì¤‘", "ì§€ë„ ë²”ìœ„ë¥¼ ë”°ë¼ê°€ë©° í›„ë³´ êµ¬ì—­ì„ íƒìƒ‰í•©ë‹ˆë‹¤.");

  window.updateEstimatedTime();
  missionRemainingMs = missionTotalMs;
  startMissionTimer();

  const btn = el("startBtn");
  if(btn) btn.innerText = "â¸ ì¼ì‹œì •ì§€";

  const autoFollow = !!(el("autoFollow")?.checked);
  const bounds = map.getBounds();

  for(let i=0;i<missionTotalSteps;i++){
    if(missionStop) break;
    while(missionPaused){
      await new Promise(r=>setTimeout(r, 200));
      if(missionStop) break;
    }
    if(missionStop) break;

    const t = (missionTotalSteps <= 1) ? 0 : (i / (missionTotalSteps-1));
    const lat = bounds.getSouth() + (bounds.getNorth()-bounds.getSouth()) * t;
    const lng = bounds.getWest()  + (bounds.getEast()-bounds.getWest()) * (((i*7) % missionTotalSteps) / missionTotalSteps);

    if(autoFollow) map.panTo([lat,lng], {animate:false});

    await scanBuildings(lat, lng, true);

    missionDoneSteps = i+1;
    const pc = el("progressCount");
    if(pc) pc.textContent = `${missionDoneSteps}/${missionTotalSteps}`;

    const bar = el("totalProgressBar");
    if(bar){
      const pct = Math.min(100, Math.max(0, (missionDoneSteps/missionTotalSteps)*100));
      bar.style.width = pct + "%";
    }

    const expectedLeft = Math.max(0, (missionTotalSteps - missionDoneSteps) * missionDelayMs);
    if(missionRemainingMs > expectedLeft) missionRemainingMs = expectedLeft;

    await new Promise(r=>setTimeout(r, missionDelayMs));
  }

  missionRunning = false;
  missionPaused = false;
  stopMissionTimer();

  const btn2 = el("startBtn");
  if(btn2) btn2.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";

  try{
    window.updateEstimatedTime();
  }catch(e){}

  if(!missionStop){
    try{
      const candidates = Array.isArray(window.spScanCandidates)
        ? window.spScanCandidates.slice()
        : [];
      const total = candidates.length;
      if(total > 0){
        showToast(`ìŠ¤ìº” ì™„ë£Œ (${total}ê°œ í›„ë³´) Â· ë°°ì¹˜ ë¶„ì„ ì‹œì‘`);

        const metaBase = window.spLastMissionMeta || {};
        const meta = {
          region_key: metaBase.region_key || "",
          region_name: metaBase.region_name || "",
          mission_name: metaBase.mission_name || "ìë™ ìŠ¤ìº”",
          mission_delay_ms: metaBase.mission_delay_ms ?? missionDelayMs,
          mission_total_steps: metaBase.mission_total_steps ?? missionTotalSteps,
          mission_done_steps: missionTotalSteps,
          started_at: metaBase.started_at || null,
          finished_at: new Date().toISOString(),
        };

        const rows = await runBatchAnalysis(candidates, 3, (done, totalCount)=>{
          try{
            const bar = el("analysisProgressBar");
            if(bar && totalCount > 0){
              const pct = Math.min(100, Math.max(0, (done/totalCount)*100));
              bar.style.width = pct + "%";
            }
            const txt = el("analysisProgressText");
            if(txt){
              txt.innerText = `${done} / ${totalCount}`;
            }
          }catch(_e){}
        });

        const payload = { meta, rows };
        try{
          localStorage.setItem("sp_batch_results_v1", JSON.stringify(payload));
          console.log("[sp] batch results stored", payload);
        }catch(e){
          console.warn("[sp] failed to save batch results", e);
        }

        showToast(`ë°°ì¹˜ ë¶„ì„ ì™„ë£Œ (${rows.length}ê±´ ì €ì¥)`);
      }else{
        showToast("ìŠ¤ìº” ì™„ë£Œ (í›„ë³´ ì—†ìŒ)");
      }
    }catch(e){
      console.error("[sp] batch analysis error", e);
      showToast("ìŠ¤ìº”ì€ ì™„ë£Œí–ˆìœ¼ë‚˜ ë°°ì¹˜ ë¶„ì„ì—ì„œ ì˜¤ë¥˜ ë°œìƒ");
    }
  }else{
    showToast("ìŠ¤ìº” ì·¨ì†Œ");
  }
};

document.getElementById("tab-scan").addEventListener("click", ()=>{
  document.getElementById("panel-scan").classList.remove("hidden");
  document.getElementById("panel-analysis").classList.add("hidden");
  document.getElementById("panel-pf").classList.add("hidden");
  document.getElementById("tab-scan").classList.add("btn-tab-active");
  document.getElementById("tab-scan").classList.remove("btn-tab-inactive");
  document.getElementById("tab-analysis").classList.remove("btn-tab-active");
  document.getElementById("tab-analysis").classList.add("btn-tab-inactive");
  document.getElementById("tab-pf").classList.remove("btn-tab-active");
  document.getElementById("tab-pf").classList.add("btn-tab-inactive");
});
document.getElementById("tab-analysis").addEventListener("click", ()=>{
  document.getElementById("panel-scan").classList.add("hidden");
  document.getElementById("panel-analysis").classList.remove("hidden");
  document.getElementById("panel-pf").classList.add("hidden");
  document.getElementById("tab-analysis").classList.add("btn-tab-active");
  document.getElementById("tab-analysis").classList.remove("btn-tab-inactive");
  document.getElementById("tab-scan").classList.remove("btn-tab-active");
  document.getElementById("tab-scan").classList.add("btn-tab-inactive");
  document.getElementById("tab-pf").classList.remove("btn-tab-active");
  document.getElementById("tab-pf").classList.add("btn-tab-inactive");
});
document.getElementById("tab-pf").addEventListener("click", ()=>{
  document.getElementById("panel-scan").classList.add("hidden");
  document.getElementById("panel-analysis").classList.add("hidden");
  document.getElementById("panel-pf").classList.remove("hidden");
  document.getElementById("tab-pf").classList.add("btn-tab-active");
  document.getElementById("tab-pf").classList.remove("btn-tab-inactive");
  document.getElementById("tab-scan").classList.remove("btn-tab-active");
  document.getElementById("tab-scan").classList.add("btn-tab-inactive");
  document.getElementById("tab-analysis").classList.remove("btn-tab-active");
  document.getElementById("tab-analysis").classList.add("btn-tab-inactive");
});

window.setScanTargetMode = function(mode){
  try{
    var landBtn = document.getElementById("btnModeLand");
    var roofBtn = document.getElementById("btnModeRoof");
    if(landBtn && roofBtn){
      if(mode === "land"){
        landBtn.classList.add("border-amber-400","bg-amber-50","text-amber-800");
        roofBtn.classList.remove("border-amber-400","bg-amber-50","text-amber-800");
        roofBtn.classList.add("border-slate-300","bg-slate-50","text-slate-700");
      }else{
        roofBtn.classList.add("border-amber-400","bg-amber-50","text-amber-800");
        landBtn.classList.remove("border-amber-400","bg-amber-50","text-amber-800");
        landBtn.classList.add("border-slate-300","bg-slate-50","text-slate-700");
      }
    }
    scanTarget = (mode === "land" ? "land" : "roof");
  }catch(e){
    console.error("setScanTargetMode failed", e);
  }
};

document.addEventListener("DOMContentLoaded", function(){
  initMap();
  window.updateEstimatedTime();

  const sidebar = document.getElementById("sidebar");
  const btnToggleSidebar = document.getElementById("btnToggleSidebar");
  const btnCloseSidebar = document.getElementById("btnCloseSidebar");

  function toggleSidebar(){
    if(!sidebar) return;
    if(sidebar.classList.contains("translate-x-full")){
      sidebar.classList.remove("translate-x-full");
    }else{
      sidebar.classList.add("translate-x-full");
    }
  }

  if(btnToggleSidebar) btnToggleSidebar.addEventListener("click", toggleSidebar);
  if(btnCloseSidebar) btnCloseSidebar.addEventListener("click", toggleSidebar);

  document.querySelectorAll(".d-pad-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(!map) return;
      const pan = btn.getAttribute("data-pan");
      const zoom = btn.getAttribute("data-zoom");
      const c = map.getCenter();
      if(pan){
        const step = 0.002;
        if(pan === "up") map.panTo([c.lat + step, c.lng], {animate:true});
        else if(pan === "down") map.panTo([c.lat - step, c.lng], {animate:true});
        else if(pan === "left") map.panTo([c.lat, c.lng - step], {animate:true});
        else if(pan === "right") map.panTo([c.lat, c.lng + step], {animate:true});
        else if(pan === "center") map.panTo([37.5665, 126.9780], {animate:true});
      }
      if(zoom){
        if(zoom === "in") map.zoomIn();
        else if(zoom === "out") map.zoomOut();
      }
    });
  });

  const btnHelp = document.getElementById("btnHelp");
  const settingsOverlay = document.getElementById("settingsOverlay");
  const btnCloseSettings = document.getElementById("btnCloseSettings");
  const btnCloseSettings2 = document.getElementById("btnCloseSettings2");

  function openSettings(){
    if(settingsOverlay){
      settingsOverlay.classList.remove("hidden");
      settingsOverlay.classList.add("flex");
    }
  }
  function closeSettings(){
    if(settingsOverlay){
      settingsOverlay.classList.add("hidden");
      settingsOverlay.classList.remove("flex");
    }
  }

  if(btnHelp) btnHelp.addEventListener("click", openSettings);
  if(btnCloseSettings) btnCloseSettings.addEventListener("click", closeSettings);
  if(btnCloseSettings2) btnCloseSettings2.addEventListener("click", closeSettings);
});
</script>
</body>
</html>
