<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #1a1a1a; }
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { transform: translateX(-100%); }
        #sidebar-toggle-btn { left: 420px; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2001; }
        #sidebar-toggle-btn.collapsed { left: 0; }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: #f8fafc; }
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; color: white; font-size: 16px; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:active { background: #1e293b; transform: translateY(2px); box-shadow: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ë¦¬í¬íŠ¸ ì „ì†¡ìš© íˆë“  í¼ -->
    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="land_price" id="form_price">
    </form>

    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
        <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
            <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</h1>
            <div class="flex justify-between items-center text-[10px] text-slate-400 mt-2 border-t border-slate-700 pt-2"><span id="currentUserDisplay">Public Access</span></div>
            <div class="grid grid-cols-3 gap-1 mt-3 text-center">
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">Backend</div><div id="cnt-vworld" class="font-mono font-bold text-cyan-400">0</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">DB Sync</div><div id="cnt-public" class="font-mono font-bold text-yellow-400">0</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">AI Analysis</div><div id="cnt-ai" class="font-mono font-bold text-purple-400">0</div></div>
            </div>
        </div>
        <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
            <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
            <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
            <button type="button" onclick="window.switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
            <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50">
            <!-- ì„¤ì • íŒ¨ë„ (ì•„ì½”ë””ì–¸) -->
            <div class="p-4 pb-0">
                <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4" open>
                    <summary class="p-3 text-xs font-bold text-slate-600 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg"><span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i></summary>
                    <div class="p-3 space-y-3 border-t border-gray-200 text-xs">
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ìµœëŒ€ë†’ì´(m)</label><input type="number" id="installHeight" value="0.5" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <!-- [F-8] ì´ê²©ê±°ë¦¬(Setback) ì¶”ê°€ -->
                             <div class="grid grid-cols-2 gap-2">
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" value="640" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">ì´ê²©ê±°ë¦¬(Setback, m)</label><input type="number" id="setbackDist" value="0.0" step="0.5" class="w-full border p-1 rounded text-center font-bold text-red-600" onchange="window.reCalculate()"></div>
                             </div>
                             <div class="grid grid-cols-2 gap-2 mt-2">
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">íŒ¨ë„ ê°„ê²©(Row, m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                             </div>
                        </div>
                        <div class="bg-green-50 p-2 rounded border border-green-200">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center font-bold text-emerald-700" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œ/kW)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2"><div><label class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center text-blue-600 font-bold" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center text-red-600 font-bold" onchange="window.reCalculate()"></div></div>
                        </div>
                    </div>
                </details>
                <!-- [F-5] ì§€ë¶•/í† ì§€ ëª¨ë“œ ì „í™˜ -->
                <div class="flex gap-2 text-xs mb-4">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="window.toggleTarget()" aria-label="í† ì§€"><div class="text-center py-2 border rounded bg-white peer-checked:bg-amber-800 peer-checked:text-white hover:bg-gray-50 transition shadow-sm"><i class="ph ph-tree"></i> í† ì§€ (Land)</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="window.toggleTarget()" checked aria-label="ì§€ë¶•"><div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm"><i class="ph ph-factory"></i> ì§€ë¶• (Roof)</div></label>
                </div>
            </div>

            <div class="px-4 pb-4">
                <!-- 1. ìŠ¤ìº” íŒ¨ë„ -->
                <div id="panel-scan" class="space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <label for="regionSelect" class="text-xs font-bold text-gray-700 mb-2 block">ğŸ“ ì§€ì—­ ì„ íƒ (ì „ìˆ˜ì¡°ì‚¬)</label>
                        <select id="regionSelect" onchange="window.setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none">
                            <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <optgroup label="ğŸ­ ìˆ˜ë„ê¶Œ/ê²½ê¸° ì£¼ìš” ì‚°ë‹¨">
                                <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                                <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                                <option value="hwaseong_ind">í™”ì„± ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="pyeongtaek_ind">í‰íƒ í¬ìŠ¹ê³µë‹¨</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì¶©ì²­ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="cheonan_ind">ì²œì•ˆ ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="osan_ind">ì˜¤ì°½ ê³¼í•™ì‚°ì—…ë‹¨ì§€</option>
                                <option value="daejeon_ind">ëŒ€ì „ ëŒ€ë•í…Œí¬ë…¸ë°¸ë¦¬</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì˜ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="gumi_ind">êµ¬ë¯¸ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="ulsan_ind">ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚° ì‚°ë‹¨</option>
                                <option value="daegu_ind">ëŒ€êµ¬ ì„±ì„œê³µë‹¨</option>
                                <option value="pohang_ind">í¬í•­ ì² ê°•ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸŒ² ëŒ€í•œë¯¼êµ­ ê´‘ì—­ ì§€ìì²´">
                                <option value="seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                <option value="gyeonggi">ê²½ê¸°ë„</option>
                                <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                                <option value="jeonbuk">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                                <option value="gyeongnam">ê²½ìƒë‚¨ë„</option>
                                <option value="jeju">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- [F-12] ìŠ¤ìº” íƒ€ì´ë¨¸ ë° ìƒíƒœì°½ -->
                    <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500">
                        <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                            <label for="scanDelay" class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</label>
                            <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="window.updateEstimatedTime()">
                                <option value="6000" selected>6ì´ˆ (ê¶Œì¥)</option>
                                <option value="3000">3ì´ˆ (ë¹ ë¦„/ì°¨ë‹¨ìœ„í—˜)</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-end"><div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">00:00:00</div><div class="text-right"><div id="progressCount" class="text-[10px] text-gray-300 font-mono">0 / 20</div><div id="timerTotal" class="text-[9px] text-cyan-300 font-mono">ì´ 00:00:00</div></div></div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden"><div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                        <div class="flex justify-between items-end mt-1 px-1"><div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div></div>
                        <div class="flex items-center gap-2 mb-2 mt-2">
                             <input type="checkbox" id="autoFollow" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" checked>
                             <label for="autoFollow" class="text-[10px] text-slate-300 cursor-pointer select-none">ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <button type="button" onclick="window.startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                            <button type="button" onclick="window.cancelMission(true)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â–  ì·¨ì†Œ(ìœ ì§€)</button>
                            <button type="button" onclick="window.downloadScanResults('geojson')" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â¬‡ ê²°ê³¼ë‹¤ìš´</button>
                            <button type="button" onclick="window.cancelMission(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ë¦¬ì…‹</button>
                        </div>
                    </div>
                </div>

                <!-- 2. ì •ë°€ ë¶„ì„ íŒ¨ë„ -->
                <div id="panel-analysis" class="hidden space-y-4">
                    <!-- [F-10] D-Pad -->
                    <div class="bg-slate-800 p-2 rounded-lg border border-indigo-500/50 shadow-lg mb-2">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ë¯¸ì„¸ì¡°ì • (D-Pad)</span><button type="button" onclick="window.resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                        <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                             <div class="grid grid-cols-3 gap-2">
                                <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('up')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('up')" ontouchend="window.dpadHoldStop()">â–²</button><div></div>
                                <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('left')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('left')" ontouchend="window.dpadHoldStop()">â—€</button>
                                <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                                <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('right')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('right')" ontouchend="window.dpadHoldStop()">â–¶</button>
                                <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('down')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('down')" ontouchend="window.dpadHoldStop()">â–¼</button><div></div>
                             </div>
                             <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                                <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotL')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotL')" ontouchend="window.dpadHoldStop()">â†º íšŒì „</button>
                                <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotR')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotR')" ontouchend="window.dpadHoldStop()">â†» íšŒì „</button>
                            </div>
                        </div>
                    </div>

                    <!-- [F-17] ìƒì„¸ PF ê²°ê³¼ í‘œì‹œ -->
                    <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                        <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right truncate w-40">-</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰(AC/DC):</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                            <!-- [F-25] í•œì „ìš©ëŸ‰ í™•ì¸í•„ìš” í‘œì‹œ -->
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">í™•ì¸ í•„ìš”</span></div>
                        </div>
                        <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600 text-xs">
                            <div class="flex justify-between"><span>ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                            <div class="flex justify-between"><span>ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                        </div>
                        <!-- PF ìƒì„¸ -->
                        <div class="bg-indigo-900/40 p-2 rounded border border-indigo-500/30 text-[10px] space-y-1">
                            <div class="flex justify-between"><span class="text-indigo-200">ğŸ¦ ì›” ìƒí™˜ì•¡:</span><span id="resMonthlyDebt" class="text-white font-bold">0 ì›</span></div>
                            <div class="flex justify-between"><span class="text-indigo-200">ğŸ’³ ì´ ì´ìë¹„ìš©:</span><span id="resTotalInterest" class="text-white font-bold">0 ì›</span></div>
                            <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button type="button" onclick="window.saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition">ì €ì¥</button>
                             <!-- [F-20] ìƒì„¸ ë¦¬í¬íŠ¸ ì´ë™ -->
                             <button type="button" onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition">ìƒì„¸ ë¦¬í¬íŠ¸</button>
                        </div>
                    </div>
                </div>

                <!-- [F-15, F-16] AI ë¶„ì„ íŒ¨ë„ -->
                <div id="panel-legal" class="hidden space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                        <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> 8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­ & ì ìˆ˜</h3>
                        
                        <div id="aiScorePanel" class="hidden mb-4 bg-slate-900/50 p-3 rounded border border-slate-600 mt-2">
                             <div class="flex items-center justify-between mb-2">
                                 <span class="text-xs text-slate-300 font-bold">êµ¬ë§¤ë§¤ë ¥ë„ (AI Score)</span>
                                 <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                             </div>
                             <div class="w-full bg-slate-700 rounded-full h-2.5 mb-2 overflow-hidden">
                                 <div id="scoreBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                             </div>
                             <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                        </div>

                        <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                            <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ 8ëŒ€ í•­ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                        </div>

                        <div id="legalLoading" class="hidden text-center py-10">
                            <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                            <p class="text-xs text-purple-300 animate-pulse">ìƒì„¸ ê·œì œ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        </div>

                        <div id="legalContent" class="hidden space-y-4 mt-2">
                             <!-- [F-15] 8ëŒ€ ì²´í¬í•­ëª© ë¦¬ìŠ¤íŠ¸ -->
                             <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-history" class="hidden space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-2 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                            <div class="flex gap-2">
                                <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV ë‹¤ìš´</button>
                                <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
                
                <div id="loading" class="hidden flex flex-col items-center justify-center py-4"><div class="spinner mb-2"></div><p class="text-xs text-slate-500">ì²˜ë¦¬ ì¤‘...</p></div>
            </div>
        </div>
        
        <div class="h-24 bg-slate-900 border-t border-slate-700 p-3 font-mono text-[10px] overflow-y-auto text-slate-400" id="logWindow"><div class="text-green-500">> System Ready.</div></div>
    </div>
    
    <div id="sidebar-toggle-btn" onclick="window.toggleSidebar()" class="absolute top-1/2 transform -translate-y-1/2 bg-white w-6 h-12 rounded-r-lg shadow-md cursor-pointer flex items-center justify-center border border-l-0 border-gray-300 text-gray-400 hover:text-cyan-600"><i class="ph ph-caret-left font-bold transition-transform"></i></div>
    
    <!-- [F-4] ì£¼ì†Œ ê²€ìƒ‰ì°½ -->
    <div class="absolute top-5 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col items-center gap-2">
        <div class="bg-white p-1 rounded-lg shadow-xl border border-slate-200 flex items-center">
            <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" class="w-64 px-3 py-2 text-sm outline-none text-slate-700 font-medium" onkeypress="if(event.key==='Enter') window.searchAddress()">
            <button type="button" onclick="window.searchAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition shadow-md"><i class="ph ph-magnifying-glass font-bold"></i></button>
        </div>
    </div>
    
    <!-- ìš°ì¸¡ ì„¤ì • -->
    <div class="absolute top-5 right-5 z-[1000] bg-white p-2 rounded-lg shadow-lg border border-gray-200 text-xs w-44">
        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1"><i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •</div>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 rounded text-indigo-700 font-bold border border-indigo-200"><input type="checkbox" id="multiSelectToggle" onchange="window.toggleMultiSelect()"><span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span></label>
        <!-- [F-13] ìë™ ìŠ¤ìº” -->
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
            <input type="checkbox" id="autoScanToggle" onchange="window.toggleAutoScan()">
            <span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”(ì´ë™ì‹œ)</span>
        </label>
        <hr class="my-2 border-gray-200">
        <!-- [F-26, F-25] ë ˆì´ì–´ í† ê¸€ -->
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="existingPlantToggle" onchange="window.toggleLayer('existing')" checked><span>ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘(ê°€ìƒ)</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="substationToggle" onchange="window.toggleLayer('substation')" checked><span>ë³€ì „ì†Œ/ì„ ë¡œ(ê°€ìƒ)</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="cadastralToggle" onchange="window.toggleLayer('cadastral')" checked><span>ì§€ì ë„ (VWorld)</span></label>
        <div class="space-y-1 mt-2">
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="sat" checked onchange="window.setMap('sat')"> <span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span></label>
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="base" onchange="window.setMap('base')"> <span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span></label>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText"></span></div>
    <div id="map"></div>

    <script>
/* =========================================================
   Solar Pathfinder Upgrade (Features 1~5) - JS ONLY
   - Keeps original HTML/CSS design intact.
   - Implements:
     F-4 address search + map move
     F-5 roof/land mode toggle
     F-6 click feature -> auto panel generation
     F-7 land panels also blue
     F-8/9 setback + instant recalculation
     F-10 D-pad press & hold micro adjust
     F-11~14 scan mission + auto scan + dashed box
     F-15~16 AI checklist + conservative score
   ========================================================= */

// -----------------------------
// Config
// -----------------------------
const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";

// Backend URL discovery (optional): ?backend=https://....
(function(){
  try{
    const qs = new URLSearchParams(window.location.search || "");
    const b = qs.get("backend");
    if (b) {
      let decoded = b;
      try { decoded = decodeURIComponent(b); } catch(e) {}
      window.BACKEND_URL = decoded.replace(/\/$/, "");
    }
  } catch(e) {}
  if (typeof window.BACKEND_URL !== "string") window.BACKEND_URL = "";
  window.BACKEND_URL = window.BACKEND_URL.replace(/\/$/, "");
})();
const BACKEND_URL = window.BACKEND_URL || "";

// Feature level (optional): ?feat=1..5 (default 5)
const FEATURE_LEVEL = parseInt(new URLSearchParams(location.search).get("feat") || "5", 10);
window.FEATURE_LEVEL = FEATURE_LEVEL;

// -----------------------------
// State
// -----------------------------
let map, layers, selectableGroup, panelGroup, analysisMarkerGroup, cadastralLayer;
let existingGroup, substationGroup;

let scanTarget = "building"; // "building" (roof) | "land"
let autoScanMode = false;
let isMultiSelectMode = false;

let currentAnalysisFeature = null;   // last selected feature
let currentAnalysisData = {};        // for report/history/AI
let selectedFeatures = new Map();    // featureId -> {feature, layer, count, panelsFC}

let calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 }; // applied to CURRENT feature panels only
let dpadHoldTimer = null;

let scanLock = false;

// Mission (F-11~12)
let missionRunning = false;
let missionPaused = false;
let missionStop = false;
let missionTotalSteps = 20;
let missionDoneSteps = 0;
let missionDelayMs = 6000;
let missionTotalMs = 0;
let missionRemainingMs = 0;
let missionLastTick = 0;
let missionTimerInterval = null;

// Auto scan box (F-14)
let autoScanBox = null;
let autoScanDebounce = null;

// -----------------------------
// Helpers: UI / Logging
// -----------------------------
function el(id){ return document.getElementById(id); }

function showToast(msg){
  const t = el("toastMsg");
  const txt = el("toastText");
  if(!t || !txt) return;
  txt.innerText = msg;
  t.classList.remove("hidden");
  t.classList.add("flex");
  setTimeout(()=>{ t.classList.add("hidden"); t.classList.remove("flex"); }, 2800);
}

function logSystem(msg){
  const w = el("logWindow");
  if(!w) return;
  const p = document.createElement("div");
  p.innerText = `> ${msg}`;
  w.appendChild(p);
  w.scrollTop = w.scrollHeight;
}

function fmtHHMMSS(ms){
  ms = Math.max(0, Math.floor(ms));
  const s = Math.floor(ms/1000);
  const hh = String(Math.floor(s/3600)).padStart(2,'0');
  const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}

function safeText(v, fallback="í™•ì¸ í•„ìš”"){
  if(v === undefined || v === null) return fallback;
  const s = String(v).trim();
  return s ? s : fallback;
}

// -----------------------------
// JSONP (VWorld)
// -----------------------------
async function jsonpRequest(url){
  return new Promise((resolve, reject) => {
    const callbackName = `jsonp_${Date.now()}_${Math.random().toString(36).slice(2)}`;
    window[callbackName] = (data) => {
      try { delete window[callbackName]; } catch(e) {}
      const script = document.getElementById(callbackName);
      if(script) script.remove();
      resolve(data);
    };
    const script = document.createElement("script");
    script.id = callbackName;
    script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
    script.onerror = () => {
      try { delete window[callbackName]; } catch(e) {}
      script.remove();
      reject(new Error("JSONP failed"));
    };
    document.body.appendChild(script);
  });
}

// -----------------------------
// Map init / layers
// -----------------------------
window.initMap = function(){
  if(map) return;

  map = L.map("map", { zoomControl: false }).setView([36.5, 127.5], 7);
  L.control.zoom({ position: "bottomright" }).addTo(map);

  layers = {
    base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`),
    sat:  L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
    hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`),
  };
  layers.sat.addTo(map);

  selectableGroup = L.layerGroup().addTo(map);
  panelGroup = L.layerGroup().addTo(map);
  analysisMarkerGroup = L.layerGroup().addTo(map);
  existingGroup = L.layerGroup().addTo(map);
  substationGroup = L.layerGroup().addTo(map);

  // cadastral WMS (optional)
  cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', {
    layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
    styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
    format: 'image/png',
    transparent: true,
    opacity: 0.7,
    key: VWORLD_TILE_KEY
  });
  map.addLayer(cadastralLayer);

  // click -> scan around (F-6 entrypoint)
  map.on("click", (e) => {
    if(FEATURE_LEVEL < 3) return;
    scanBuildings(e.latlng.lat, e.latlng.lng, true);
  });

  // moveend -> auto scan (F-13)
  map.on("moveend", () => {
    try { updateAutoScanBox(); } catch(e) {}
    if(FEATURE_LEVEL < 4) return;
    if(!autoScanMode) return;
    const autoFollow = el("autoFollow");
    if(autoFollow && autoFollow.checked) return; // mission auto-follow ì¤‘ì—” ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

    // F-13: í™”ë©´ ì´ë™/í™•ëŒ€ ê¸°ë°˜ ìë™ ìŠ¤ìº” (ë””ë°”ìš´ìŠ¤)
    if(autoScanDebounce) clearTimeout(autoScanDebounce);
    autoScanDebounce = setTimeout(() => {
      const c = map.getCenter();
      scanBuildings(c.lat, c.lng, true);
    }, 450);
  });

  logSystem(`System ready. feat=${FEATURE_LEVEL}`);
};

// Map layer switch (existing UI uses setMap)
window.setMap = function(t){
  if(!map) return;
  if(t === "base"){
    map.addLayer(layers.base);
    map.removeLayer(layers.sat);
  } else {
    map.addLayer(layers.sat);
    map.removeLayer(layers.base);
  }
};

// Existing toggles for layers
window.toggleLayer = function(type){
  if(!map) return;
  if(type === "cadastral"){
    const chk = el("cadastralToggle");
    if(!chk) return;
    if(chk.checked) map.addLayer(cadastralLayer);
    else map.removeLayer(cadastralLayer);
    return;
  }
  if(type === "existing"){
    const chk = el("existingPlantToggle");
    if(!chk) return;
    if(chk.checked){
      if(!map.hasLayer(existingGroup)) map.addLayer(existingGroup);
      if(existingGroup.getLayers().length === 0) createMockInfra("plant");
    }else{
      existingGroup.clearLayers();
      map.removeLayer(existingGroup);
    }
    return;
  }
  if(type === "substation"){
    const chk = el("substationToggle");
    if(!chk) return;
    if(chk.checked){
      if(!map.hasLayer(substationGroup)) map.addLayer(substationGroup);
      if(substationGroup.getLayers().length === 0) createMockInfra("substation");
    }else{
      substationGroup.clearLayers();
      map.removeLayer(substationGroup);
    }
  }
};

function createMockInfra(kind){
  if(!map) return;
  const z = map.getZoom();
  if(z < 13) return;

  const b = map.getBounds();
  const minLat = b.getSouth(), maxLat = b.getNorth();
  const minLng = b.getWest(),  maxLng = b.getEast();

  const n = 6;
  for(let i=0;i<n;i++){
    const lat = minLat + (maxLat-minLat) * Math.random();
    const lng = minLng + (maxLng-minLng) * Math.random();
    const iconHtml = (kind==="plant")
      ? `<div class="w-5 h-3 bg-red-500 border border-red-800 transform -skew-x-12 shadow"></div>`
      : `<div class="w-6 h-6 flex items-center justify-center bg-yellow-500 rounded text-white"><span style="font-weight:800">âš¡</span></div>`;
    const icon = L.divIcon({ className:"", html: iconHtml, iconSize:[24,24] });
    L.marker([lat,lng], {icon}).addTo(kind==="plant" ? existingGroup : substationGroup);
  }
}

// -----------------------------
// Tab / Sidebar (existing UI callbacks)
// -----------------------------
window.switchTab = function(tab){
  const tabs = ["scan","analysis","legal","history"];
  for(const t of tabs){
    const tb = el(`tab-${t}`);
    const pn = el(`panel-${t}`);
    if(tb) tb.classList.remove("active");
    if(pn) pn.classList.add("hidden");
  }
  const tb = el(`tab-${tab}`);
  const pn = el(`panel-${tab}`);
  if(tb) tb.classList.add("active");
  if(pn) pn.classList.remove("hidden");
};

window.toggleSidebar = function(){
  const sb = el("sidebar");
  const btn = el("sidebar-toggle-btn");
  if(sb) sb.classList.toggle("collapsed");
  if(btn) btn.classList.toggle("collapsed");
};

// -----------------------------
// Feature 2: Mode toggle (F-5)
// -----------------------------
window.toggleTarget = function(){
  if(FEATURE_LEVEL < 2){
    showToast("feat<2: ëª¨ë“œ ì „í™˜ ë¹„í™œì„±");
    return;
  }
  const radios = document.getElementsByName("scanTarget");
  for(const r of radios){
    if(r.checked){
      scanTarget = (r.value === "land") ? "land" : "building";
      break;
    }
  }
  clearResults(true);
  showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === "land" ? "í† ì§€" : "ì§€ë¶•"}`);
  logSystem(`mode=${scanTarget}`);
};

// -----------------------------
// Feature 1: Address search (F-4)
// -----------------------------
window.searchAddress = async function(){
  if(FEATURE_LEVEL < 1){
    showToast("feat<1: ì£¼ì†Œê²€ìƒ‰ ë¹„í™œì„±");
    return;
  }
  const input = el("addrInput");
  const q = (input ? input.value : "").trim();
  if(!q){
    showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const loading = el("loading");
  if(loading) loading.classList.remove("hidden");

  try{
    const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(q)}&refine=true&simple=false&type=road&key=${VWORLD_TILE_KEY}`;
    const data = await jsonpRequest(url);
    if(data?.response?.status === "OK"){
      const {x,y} = data.response.result.point;
      const lat = parseFloat(y), lng = parseFloat(x);
      map.setView([lat,lng], 18);
      showToast("ì£¼ì†Œ ì´ë™ ì™„ë£Œ");
      logSystem(`address -> ${lat},${lng}`);
      // auto scan around the location
      if(FEATURE_LEVEL >= 3){
        await new Promise(r=>setTimeout(r, 350));
        const res = await scanBuildings(lat, lng, true);
        if(res?.features?.length){
          analyzeFeature(res.features[0], true);
        }
      }
    } else {
      showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    }
  } catch(e){
    console.error(e);
    showToast("ì£¼ì†Œê²€ìƒ‰ ì˜¤ë¥˜");
    logSystem(`address error: ${e.message}`);
  } finally {
    if(loading) loading.classList.add("hidden");
  }
};

// -----------------------------
// Multi-select mode (existing toggle)
// -----------------------------
window.toggleMultiSelect = function(){
  const chk = el("multiSelectToggle");
  isMultiSelectMode = !!(chk && chk.checked);
  clearResults(true);
};

// -----------------------------
// Auto scan toggle (F-13/14)
// -----------------------------
window.toggleAutoScan = function(){
  const chk = el("autoScanToggle");
  if(FEATURE_LEVEL < 4){
    if(chk) chk.checked = false;
    autoScanMode = false;
    showToast("feat<4: ìë™ ìŠ¤ìº” ë¹„í™œì„±");
    updateAutoScanBox();
    return;
  }
  autoScanMode = !!(chk && chk.checked);
  showToast(autoScanMode ? "ìë™ ìŠ¤ìº” ON" : "ìë™ ìŠ¤ìº” OFF");
  updateAutoScanBox();
};

// -----------------------------
// Core: scan buildings/land from VWorld
// -----------------------------
window.scanBuildings = scanBuildings;
async function scanBuildings(lat, lng, force=false){
  if(!map) return null;
  if(scanLock && !force) return null;
  scanLock = true;

  let fetchedFeatures = [];
  try{
    if(!isMultiSelectMode){
      selectableGroup.clearLayers();
      panelGroup.clearLayers();
      selectedFeatures.clear();
      currentAnalysisFeature = null;
      resetCalibrationInternal(false);
      // reset UI cards
      const rc = el("resultCard");
      if(rc) rc.classList.add("hidden");
      const lp = el("legalPlaceholder");
      const lc = el("legalContent");
      const sp = el("aiScorePanel");
      if(lp) lp.classList.remove("hidden");
      if(lc) lc.classList.add("hidden");
      if(sp) sp.classList.add("hidden");
    }

    analysisMarkerGroup.clearLayers();
    L.marker([lat,lng]).addTo(analysisMarkerGroup);

    const box = `${lng - 0.001},${lat - 0.001},${lng + 0.001},${lat + 0.001}`;
    const dataName = (scanTarget === "land") ? "LP_PA_CBND_BUBUN" : "LT_C_SPBD";

    const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${dataName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=20`;
    const data = await jsonpRequest(url);

    const fc = data?.response?.result?.featureCollection;
    fetchedFeatures = fc?.features || [];

    L.geoJSON(fetchedFeatures, {
      style: (scanTarget === "land")
        ? { color:"#8d6e63", weight:2, fillColor:"#8d6e63", fillOpacity:0.25 }
        : { color:"#3b82f6", weight:2, fillOpacity:0.20 },
      onEachFeature: (feature, layer) => {
        layer.on("click", (e) => {
          L.DomEvent.stopPropagation(e);
          analyzeFeature(feature, true);
        });
      }
    }).addTo(selectableGroup);

    const found = el("foundCount");
    if(found) found.innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${selectableGroup.getLayers().length}ê°œ`;

    return { features: fetchedFeatures, count: fetchedFeatures.length };
  } catch(e){
    console.error(e);
    logSystem(`scan error: ${e.message}`);
    return null;
  } finally {
    setTimeout(()=>{ scanLock = false; }, 500);
  }
}

// -----------------------------
// Panel generation (F-6~F-9)
// -----------------------------
function metersToKm(m){ return (m || 0) / 1000; }

function applyCalibrationToFC(fc){
  if(!window.turf || !fc) return fc;
  let out = turf.clone(fc);

  // rotate first around centroid
  if(calibration.rot_deg){
    try { out = turf.transformRotate(out, calibration.rot_deg); } catch(e) {}
  }

  // translate (east-west then north-south)
  if(calibration.dx_m){
    try { out = turf.transformTranslate(out, metersToKm(calibration.dx_m), 90, {units:"kilometers"}); } catch(e) {}
  }
  if(calibration.dy_m){
    try { out = turf.transformTranslate(out, metersToKm(calibration.dy_m), 0, {units:"kilometers"}); } catch(e) {}
  }

  return out;
}

function buildPanelsFCFromGeometry(geo){
  // Safety: fallback grid always visible
  const fallback = () => {
    let bbox = null;
    try { bbox = turf.bbox(turf.feature(geo)); } catch(e) {}
    if(!bbox){
      const c = map.getCenter();
      bbox = [c.lng-0.0004, c.lat-0.0004, c.lng+0.0004, c.lat+0.0004];
    }
    const lat = (bbox[1] + bbox[3]) / 2;
    const mpdLng = 111320 * Math.cos(lat * Math.PI / 180);
    const mpdLat = 111000;

    const modW = 1.13;
    const modH = 2.2;

    const w = modW / mpdLng;
    const h = modH / mpdLat;

    const feats = [];
    for(let i=0;i<3;i++){
      for(let j=0;j<3;j++){
        const x = bbox[0] + i*w*1.3;
        const y = bbox[1] + j*h*1.3;
        feats.push(turf.bboxPolygon([x,y,x+w,y+h]));
      }
    }
    return { type:"FeatureCollection", features: feats };
  };

  if(!window.turf) return fallback();

  const isPoly = geo && (geo.type === "Polygon" || geo.type === "MultiPolygon");
  if(!isPoly) return fallback();

  let poly = turf.feature(geo);

  // setback
  let setback = 0;
  const sb = el("setbackDist");
  if(sb) setback = parseFloat(sb.value || "0") || 0;

  if(setback > 0){
    try{
      const shrunk = turf.buffer(poly, -setback, {units:"meters"});
      if(shrunk && shrunk.geometry) poly = shrunk;
      else return fallback();
    } catch(e){
      return fallback();
    }
  }

  // parameters from UI (if present)
  const modW = parseFloat(el("modWidth")?.value || "1.13") || 1.13;
  const modH = parseFloat(el("modHeight")?.value || "2.4") || 2.4;
  const angle = parseFloat(el("installAngle")?.value || "20") || 20;
  const rowSpacing = parseFloat(el("rowSpacing")?.value || "1.2") || 1.2;

  const projectedH = modH * Math.cos(angle * Math.PI / 180);
  const bbox = turf.bbox(poly);
  const centerLat = (bbox[1] + bbox[3]) / 2;
  const mpdLng = 111320 * Math.cos(centerLat * Math.PI / 180);
  const mpdLat = 111000;

  const dLng = (modW + 0.10) / mpdLng;
  const dLat = (projectedH + rowSpacing) / mpdLat;

  const feats = [];
  let guard = 0;
  const MAX = 45000;

  for(let x=bbox[0]; x<bbox[2]; x+=dLng){
    for(let y=bbox[1]; y<bbox[3]; y+=dLat){
      if(guard++ > MAX) break;
      const pt = turf.point([x + dLng/2, y + dLat/2]);
      try{
        if(turf.booleanPointInPolygon(pt, poly)){
          const w = modW / mpdLng;
          const h = projectedH / mpdLat;
          feats.push(turf.bboxPolygon([x, y, x+w, y+h]));
        }
      } catch(e) {}
    }
  }

  if(!feats.length) return fallback();
  return { type:"FeatureCollection", features: feats };
}

function renderPanelsFC(fc){
  // Always blue (F-7)
  const style = {
    color: "#1e40af",
    weight: 1,
    fillColor: "#3b82f6",
    fillOpacity: 0.70
  };
  return L.geoJSON(fc, { style });
}

function getFeatureId(feature){
  const props = feature?.properties || {};
  // Prefer PNU if exists
  if(props.pnu) return `pnu:${props.pnu}`;
  // else stable center-based id
  try{
    const c = turf.center(feature).geometry.coordinates;
    return `c:${c[1].toFixed(6)}:${c[0].toFixed(6)}`;
  } catch(e){
    return `t:${Date.now()}:${Math.random().toString(36).slice(2)}`;
  }
}

window.drawPanels = function(geo){
  // public wrapper for debug; not used directly in UI
  const fc = applyCalibrationToFC(buildPanelsFCFromGeometry(geo));
  panelGroup.clearLayers();
  renderPanelsFC(fc).addTo(panelGroup);
  return fc.features.length;
};

function updateResultCardBasics(addr, panelCount){
  const rc = el("resultCard");
  if(rc) rc.classList.remove("hidden");

  if(el("analysisAddress")) el("analysisAddress").innerText = safeText(addr);
  if(el("analysisCount")) el("analysisCount").innerText = `${panelCount} ì¥`;

  // capacity
  const modPower = parseFloat(el("modPower")?.value || "640") || 640;
  const dcKw = (panelCount * modPower) / 1000;
  const acKw = dcKw / 1.15;
  if(el("analysisCapacity")) el("analysisCapacity").innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;

  // kepco
  if(el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”";
}

// Finance summary (kept simple; uses existing UI fields)
window.calculateFinance = function(panelCount, sunHoursOverride){
  // Local summary + (optional) backend PF amortization (F-17) + ROI skeleton (F-18/19)
  const modPower = parseFloat(el("modPower")?.value || "640") || 640;
  const dcKw = (panelCount * modPower) / 1000;
  const acKw = dcKw / 1.15;

  const costPerKw = (parseFloat(el("costPerKw")?.value || "90") || 90) * 10000;
  const modPrice = parseFloat(el("modPrice")?.value || "350") || 350;
  const smp = parseFloat(el("smp")?.value || "140") || 140;
  const rec = parseFloat(el("rec")?.value || "70") || 70;
  const pfRatio = parseFloat(el("pfLoanRatio")?.value || "90") || 90;
  const pfRate = parseFloat(el("pfInterestRate")?.value || "5.5") || 5.5;

  // ì¼ì‚¬ëŸ‰(ì‹œê°„/ì¼): AIê°€ ì£¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ 3.6
  const sun = (typeof sunHoursOverride === "number" && sunHoursOverride > 0) ? sunHoursOverride : 3.6;

  // ë°œì „ëŸ‰(ì—°): ë‹¨ìˆœ ì¶”ì •(ì†ì‹¤ 0.8)
  const annualKwh = acKw * sun * 365 * 0.8;

  // ìˆ˜ìµ(ì—°): SMP+REC
  const annualRev = annualKwh * (smp + rec);

  // CAPEX: ëª¨ë“ˆ + BOS(ë§Œ/kW)
  const moduleCost = (panelCount * modPower) * modPrice;          // (W * ì›/W)
  const bosCost = acKw * costPerKw;                               // (kW * ì›/kW)
  const totalCost = moduleCost + bosCost;

  // PF
  const loanPrincipal = totalCost * (pfRatio/100);
  const equity = totalCost - loanPrincipal;
  const loanYears = 15;

  // Local fallback PF (ì›ë¦¬ê¸ˆê· ë“±)
  const r_m = (pfRate/100)/12;
  const n = loanYears * 12;
  const monthlyDebtLocal = (loanPrincipal > 0 && r_m > 0)
    ? (loanPrincipal * r_m * Math.pow(1+r_m, n)) / (Math.pow(1+r_m, n) - 1)
    : (loanPrincipal > 0 ? (loanPrincipal / n) : 0);
  const totalPayLocal = monthlyDebtLocal * n;
  const totalInterestLocal = Math.max(0, totalPayLocal - loanPrincipal);

  // ROI 25y cashflow (ë³´ìˆ˜ì ): OPEX=2ë§Œì›/kW/ë…„, 0.5%/ë…„ degradation
  const annualOpex = acKw * 20000;
  const cashflows_no_land = [];  // F-19: í† ì§€ë¹„ ì œì™¸
  const cashflows_with_land = []; // F-19: í† ì§€ë¹„ í¬í•¨(í˜„ì¬ placeholder: land_price ì—†ìŒ)
  const landPrice = null; // ë°ì´í„°ì†ŒìŠ¤ í™•ì • ì „ê¹Œì§€ null ìœ ì§€

  let cum = -equity;
  let payback = null;

  // ì¼ë‹¨ PFëŠ” localë¡œ ê³„ì‚°, backend ì‘ë‹µì´ ì˜¤ë©´ ì•„ë˜ì—ì„œ ë®ì–´ì”Œì›€
  let monthlyDebt = monthlyDebtLocal;
  let totalInterest = totalInterestLocal;

  for(let y=1; y<=25; y++){
    const deg = Math.pow(0.995, (y-1)); // 0.5% ê°ì†Œ
    const revY = annualRev * deg;
    const debtY = (y<=loanYears) ? (monthlyDebt * 12) : 0;
    const cf = (revY - annualOpex - debtY);
    cashflows_no_land.push(Math.round(cf));
    cashflows_with_land.push(Math.round(cf)); // landPrice í™•ì • ì‹œ ì²«í•´/0ë…„ì— ë°˜ì˜ ê°€ëŠ¥
    cum += cf;
    if(cum >= 0 && payback === null) payback = y;
  }

  // UI update (always)
  if(el("resTotalCost")) el("resTotalCost").innerText = Math.round(totalCost).toLocaleString() + " ì›";
  if(el("resAnnualRev")) el("resAnnualRev").innerText = Math.round(annualRev).toLocaleString() + " ì›";
  if(el("resMonthlyDebt")) el("resMonthlyDebt").innerText = Math.round(monthlyDebt).toLocaleString() + " ì›";
  if(el("resTotalInterest")) el("resTotalInterest").innerText = Math.round(totalInterest).toLocaleString() + " ì›";
  if(el("resPfPayback")) el("resPfPayback").innerText = payback ? `${payback}ë…„` : "> 25ë…„";

  currentAnalysisData.finance = {
    panelCount,
    acCapacityKw: +acKw.toFixed(1),
    dcCapacityKw: +dcKw.toFixed(1),
    annualKwh: Math.round(annualKwh),
    annualRevenueWon: Math.round(annualRev),
    totalCostWon: Math.round(totalCost),
    loan: {
      principalWon: Math.round(loanPrincipal),
      ratioPct: pfRatio,
      interestRatePct: pfRate,
      years: loanYears,
      method: "equal_payment"
    },
    monthlyDebtWon: Math.round(monthlyDebt),
    totalInterestWon: Math.round(totalInterest),
    paybackYears: payback || null,
    roi25y: {
      cashflows_no_land,
      cashflows_with_land,
      land_price_won: landPrice, // F-19 placeholder
    },
    assumptions: { sunHours: sun, smp, rec, annualOpexWon: Math.round(annualOpex) }
  };

  // Backend PF (F-17) - non-blocking: response overwrites local numbers if success
  if(BACKEND_URL){
    (async ()=>{
      try{
        const r = await postJson(`${BACKEND_URL}/api/finance/pf`, {
          principal: loanPrincipal,
          annual_rate_pct: pfRate,
          years: loanYears,
          method: "equal_payment"
        });
        if(r.ok && r.data && r.data.ok){
          monthlyDebt = r.data.monthly_payment;
          totalInterest = r.data.total_interest;
          if(el("resMonthlyDebt")) el("resMonthlyDebt").innerText = Math.round(monthlyDebt).toLocaleString() + " ì›";
          if(el("resTotalInterest")) el("resTotalInterest").innerText = Math.round(totalInterest).toLocaleString() + " ì›";
          // write back
          currentAnalysisData.finance.monthlyDebtWon = Math.round(monthlyDebt);
          currentAnalysisData.finance.totalInterestWon = Math.round(totalInterest);
          currentAnalysisData.finance.loan.method = r.data.method || "equal_payment";
        }
      }catch(e){
        // ignore: local numbers remain
      }
    })();
  }
};;

// Analyze feature (F-6)
window.analyzeFeature = analyzeFeature;
function analyzeFeature(feature, focusTab){
  if(FEATURE_LEVEL < 3){
    showToast("feat<3: íŒ¨ë„ ìƒì„± ë¹„í™œì„±");
    return;
  }
  if(!feature?.geometry){
    showToast("ì§€ì˜¤ë©”íŠ¸ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  if(focusTab) window.switchTab("analysis");

  // Determine address string (F-23 safe)
  const props = feature.properties || {};
  const addr = props.road_nm_ad || props.jibun_addr || props.addr || (props.pnu ? `PNU:${props.pnu}` : "") || "í™•ì¸ í•„ìš”";

  const featureId = getFeatureId(feature);

  // In multi-select: toggle remove
  if(isMultiSelectMode && selectedFeatures.has(featureId)){
    const stored = selectedFeatures.get(featureId);
    if(stored?.layer) panelGroup.removeLayer(stored.layer);
    selectedFeatures.delete(featureId);
    // recompute totals
    recomputeTotalsAfterSelectionChange();
    return;
  }

  // If not multi-select, reset selection and calibration
  if(!isMultiSelectMode){
    panelGroup.clearLayers();
    selectedFeatures.clear();
    resetCalibrationInternal(false);
  }

  currentAnalysisFeature = feature;

  // Build panels (base -> apply calibration)
  const baseFC = buildPanelsFCFromGeometry(feature.geometry);
  const fc = applyCalibrationToFC(baseFC);

  const layer = renderPanelsFC(fc);
  layer.addTo(panelGroup);

  const count = fc.features.length;

  selectedFeatures.set(featureId, { feature, layer, count, panelsFC: fc, basePanelsFC: baseFC, address: addr });

  updateResultCardBasics(addr, getTotalPanelCount());
  window.calculateFinance(getTotalPanelCount(), currentAnalysisData.ai_analysis?.sun_hours);

  // Save analysis data basics
  currentAnalysisData.address = addr;
  currentAnalysisData.mode = (scanTarget === "land") ? "land" : "roof";
  currentAnalysisData.updated_at = new Date().toISOString();

  // AI analysis (F-15/16)
  if(FEATURE_LEVEL >= 5){
    try{
      const center = turf.center(feature).geometry.coordinates;
      fetchAIData(center[1], center[0], addr);
    }catch(e){
      fetchAIData(null, null, addr);
    }
  }
}

function getTotalPanelCount(){
  let sum = 0;
  for(const v of selectedFeatures.values()) sum += (v.count || 0);
  return sum;
}

function recomputeTotalsAfterSelectionChange(){
  const total = getTotalPanelCount();
  if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
  window.calculateFinance(total, currentAnalysisData.ai_analysis?.sun_hours);
  showToast(`ì„ íƒ: ${selectedFeatures.size}ê°œ / íŒ¨ë„ ${total}ì¥`);
}

// Recalculate panels after parameter changes (F-9)
window.reCalculate = function(){
  if(FEATURE_LEVEL < 3) return;

  if(!selectedFeatures.size){
    showToast("ì„ íƒëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  // For simplicity: recompute all selected features with current parameters.
  panelGroup.clearLayers();

  const updated = new Map();
  for(const [id, v] of selectedFeatures.entries()){
    const baseFC = buildPanelsFCFromGeometry(v.feature.geometry);
    // Only apply calibration to the currently focused feature
    const fc = (currentAnalysisFeature && id === getFeatureId(currentAnalysisFeature))
      ? applyCalibrationToFC(baseFC)
      : baseFC;

    const layer = renderPanelsFC(fc);
    layer.addTo(panelGroup);

    updated.set(id, { ...v, layer, count: fc.features.length, panelsFC: fc, basePanelsFC: baseFC });
  }
  selectedFeatures = updated;

  const total = getTotalPanelCount();
  if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
  window.calculateFinance(total, currentAnalysisData.ai_analysis?.sun_hours);
  showToast("ì¬ê³„ì‚° ì™„ë£Œ");
};

// -----------------------------
// D-pad calibration (F-10)
// -----------------------------
function resetCalibrationInternal(recalc=true){
  calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 };
  if(recalc) window.reCalculate();
}

window.resetCalibration = function(){
  resetCalibrationInternal(true);
};

window.applyCalibration = function(dx, dy, drot=0){
  if(FEATURE_LEVEL < 3) return;
  calibration.dx_m += (dx || 0);
  calibration.dy_m += (dy || 0);
  calibration.rot_deg += (drot || 0);
  window.reCalculate();
};

window.dpadHoldStart = function(dir){
  if(FEATURE_LEVEL < 3) return;
  window.dpadHoldStop();

  const step = 0.2; // meters
  const tick = () => {
    if(dir === "up") window.applyCalibration(0,  step);
    if(dir === "down") window.applyCalibration(0, -step);
    if(dir === "left") window.applyCalibration(-step, 0);
    if(dir === "right") window.applyCalibration(step, 0);
    if(dir === "rotL") window.applyCalibration(0, 0, -2);
    if(dir === "rotR") window.applyCalibration(0, 0,  2);
  };

  tick();
  dpadHoldTimer = setInterval(tick, 120);
};

window.dpadHoldStop = function(){
  if(dpadHoldTimer){
    clearInterval(dpadHoldTimer);
    dpadHoldTimer = null;
  }
};

// -----------------------------
// F-11~F-14: Scan mission + auto scan box
// -----------------------------
const REGION_PLANS = {
  "ansan_ind":     { name:"ì•ˆì‚° ë°˜ì›”/ì‹œí™”", steps: 120 },
  "incheon_ind":   { name:"ì¸ì²œ ë‚¨ë™ê³µë‹¨", steps: 120 },
  "hwaseong_ind":  { name:"í™”ì„± ì¼ë°˜ì‚°ë‹¨", steps: 140 },
  "pyeongtaek_ind":{ name:"í‰íƒ í¬ìŠ¹ê³µë‹¨", steps: 140 },
  "cheonan_ind":   { name:"ì²œì•ˆ ì¼ë°˜ì‚°ë‹¨", steps: 140 },
  "osan_ind":      { name:"ì˜¤ì°½ ê³¼í•™ì‚°ë‹¨", steps: 140 },
  "daejeon_ind":   { name:"ëŒ€ì „ ëŒ€ë•", steps: 140 },
  "gumi_ind":      { name:"êµ¬ë¯¸ êµ­ê°€ì‚°ë‹¨", steps: 160 },
  "changwon_ind":  { name:"ì°½ì› êµ­ê°€ì‚°ë‹¨", steps: 160 },
  "ulsan_ind":     { name:"ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚°", steps: 160 },
  "daegu_ind":     { name:"ëŒ€êµ¬ ì„±ì„œ", steps: 160 },
  "pohang_ind":    { name:"í¬í•­ ì² ê°•", steps: 160 },
  "seoul":         { name:"ì„œìš¸", steps: 260 },
  "gyeonggi":      { name:"ê²½ê¸°", steps: 420 },
  "jeonnam":       { name:"ì „ë‚¨", steps: 360 },
  "jeonbuk":       { name:"ì „ë¶", steps: 320 },
  "gyeongnam":     { name:"ê²½ë‚¨", steps: 360 },
  "jeju":          { name:"ì œì£¼", steps: 240 },
};

let selectedRegionKey = "";

window.setRegion = function(){
  const sel = el("regionSelect");
  selectedRegionKey = (sel && sel.value) ? sel.value : "";
  window.updateEstimatedTime();
};

window.updateEstimatedTime = function(){
  const delaySel = el("scanDelay");
  missionDelayMs = parseInt(delaySel?.value || "6000", 10);

  const plan = REGION_PLANS[selectedRegionKey];
  missionTotalSteps = plan ? plan.steps : 20;

  // F-11: ì˜ˆìƒ ì´ ì†Œìš”ì‹œê°„ = steps * delay (ì¶”í›„ region bbox ê¸°ë°˜ ì •ë°€í™” ê°€ëŠ¥)
  missionTotalMs = missionTotalSteps * missionDelayMs;
  missionRemainingMs = missionTotalMs;

  if(el("timerRemaining")) el("timerRemaining").innerText = fmtHHMMSS(missionRemainingMs);
  if(el("timerTotal")) el("timerTotal").innerText = `ì´ ${fmtHHMMSS(missionTotalMs)}`;
  if(el("progressCount")) el("progressCount").innerText = `0 / ${missionTotalSteps}`;
  if(el("totalProgressBar")) el("totalProgressBar").style.width = "0%";
};

function stopMissionTimer(){
  if(missionTimerInterval){
    clearInterval(missionTimerInterval);
    missionTimerInterval = null;
  }
}

function startMissionTimer(){
  stopMissionTimer();
  missionLastTick = Date.now();

  missionTimerInterval = setInterval(()=>{
    if(!missionRunning){ stopMissionTimer(); return; }

    const now = Date.now();

    // F-12: ì¼ì‹œì •ì§€ ì‹œ ì‹œê°„ ê°ì†Œ X (resume ì‹œ ê¸°ì¤€ ì¬ì„¤ì •)
    if(missionPaused){
      missionLastTick = now;
      return;
    }

    const dt = Math.max(0, now - missionLastTick);
    missionLastTick = now;

    missionRemainingMs = Math.max(0, missionRemainingMs - dt);

    if(el("timerRemaining")) el("timerRemaining").innerText = fmtHHMMSS(missionRemainingMs);
    if(el("timerTotal")) el("timerTotal").innerText = `ì´ ${fmtHHMMSS(missionTotalMs)}`;

    if(missionTotalMs > 0 && el("totalProgressBar")){
      const done = Math.min(1, (missionTotalMs - missionRemainingMs) / missionTotalMs);
      // Progress barëŠ” "ì „ìˆ˜ ìŠ¤ìº” ì§„í–‰ë¥ "ë¡œ ìœ ì§€í•˜ë˜, step ê¸°ë°˜ ì—…ë°ì´íŠ¸ê°€ ìš°ì„ 
      // ì—¬ê¸°ì„œëŠ” ìµœì†Œí•œ ë‚¨ì€ì‹œê°„ ê¸°ë°˜ìœ¼ë¡œë„ ìì—°ìŠ¤ëŸ½ê²Œ ì›€ì§ì´ë„ë¡ ë³´ì •
      const w = (done * 100);
      const cur = parseFloat(el("totalProgressBar").style.width || "0");
      if(!isNaN(cur) && w > cur){
        el("totalProgressBar").style.width = `${w}%`;
      }
    }

    if(missionRemainingMs <= 0) stopMissionTimer();
  }, 250);
}

window.startMission = async function(){
  if(FEATURE_LEVEL < 4){
    showToast("feat<4: ì „ìˆ˜ ìŠ¤ìº” ë¹„í™œì„±");
    return;
  }
  if(!map) return;

  // Toggle pause/resume
  if(missionRunning){
    missionPaused = !missionPaused;
    const btn = el("startBtn");
    if(btn) btn.innerText = missionPaused ? "â–¶ ì¬ê°œ" : "â¸ ì¼ì‹œì •ì§€";
    showToast(missionPaused ? "ì¼ì‹œì •ì§€" : "ì¬ê°œ");
    return;
  }

  // Start mission
  missionRunning = true;
  missionPaused = false;
  missionStop = false;
  missionDoneSteps = 0;

  window.updateEstimatedTime();
  // Timer uses missionRemainingMs (pause-aware)
  startMissionTimer();

  const btn = el("startBtn");
  if(btn) btn.innerText = "â¸ ì¼ì‹œì •ì§€";

  const autoFollow = !!(el("autoFollow")?.checked);
  const bounds = map.getBounds();

  for(let i=0;i<missionTotalSteps;i++){
    if(missionStop) break;
    while(missionPaused){
      await new Promise(r=>setTimeout(r, 200));
      if(missionStop) break;
    }
    if(missionStop) break;

    const t = (missionTotalSteps <= 1) ? 0 : (i / (missionTotalSteps-1));
    const lat = bounds.getSouth() + (bounds.getNorth()-bounds.getSouth()) * t;
    const lng = bounds.getWest()  + (bounds.getEast()-bounds.getWest()) * (((i*7) % missionTotalSteps) / missionTotalSteps);

    if(autoFollow) map.panTo([lat,lng], {animate:false});

    await scanBuildings(lat, lng, true);

    missionDoneSteps = i+1;

    if(el("progressCount")) el("progressCount").innerText = `${missionDoneSteps} / ${missionTotalSteps}`;
    if(el("totalProgressBar")) el("totalProgressBar").style.width = `${(missionDoneSteps/missionTotalSteps)*100}%`;

    // ë‚¨ì€ì‹œê°„ ë³´ì •: step ê¸°ë°˜ ì˜ˆìƒê°’ë³´ë‹¤ í¬ê²Œ ë‚¨ì•„ìˆìœ¼ë©´ ì¤„ì—¬ì¤Œ(ìŠ¤ìº”ì´ ë¹ ë¥¼ ë•Œ)
    const expectedLeft = Math.max(0, (missionTotalSteps - missionDoneSteps) * missionDelayMs);
    if(missionRemainingMs > expectedLeft) missionRemainingMs = expectedLeft;

    await new Promise(r=>setTimeout(r, missionDelayMs));
  }

  missionRunning = false;
  missionPaused = false;
  stopMissionTimer();

  if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";
  showToast(missionStop ? "ìŠ¤ìº” ì·¨ì†Œ" : "ìŠ¤ìº” ì™„ë£Œ");
};

window.cancelMission = function(keepResults){
  missionStop = true;
  missionPaused = false;
  missionRunning = false;
  stopMissionTimer();

  const btn = el("startBtn");
  if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";

  if(!keepResults){
    clearResults(true);
  }
  window.updateEstimatedTime();
};

window.downloadScanResults = function(fmt){
  // Export current selectable polygons
  try{
    const geojson = selectableGroup.toGeoJSON();
    const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `scan_results.${fmt === "geojson" ? "geojson" : "json"}`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(e){
    showToast("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
  }
};

function updateAutoScanBox(){
  if(!map){
    if(autoScanBox){ try{ autoScanBox.remove(); }catch(e){} autoScanBox=null; }
    return;
  }
  if(!(FEATURE_LEVEL >= 4 && autoScanMode)){
    if(autoScanBox){ try{ autoScanBox.remove(); }catch(e){} autoScanBox=null; }
    return;
  }

  // F-14: ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ìë™ ìŠ¤ìº” ë²”ìœ„(ë…¸ë€ ì ì„  ë°•ìŠ¤)
  // - ì¤Œ ë ˆë²¨ì— ë¬´ê´€í•˜ê²Œ "ëŒ€ëµ ì¼ì • ê±°ë¦¬(m)"ë¡œ ìœ ì§€ (ë³´ìˆ˜ì )
  const c = map.getCenter();
  const halfMeters = 250; // í•œ ë³€ ì•½ 500m (ì¶”í›„ ì„¤ì •ê°’ìœ¼ë¡œ ë…¸ì¶œ ê°€ëŠ¥)

  const dLat = halfMeters / 111320; // meters -> deg
  const dLng = halfMeters / (111320 * Math.max(0.2, Math.cos(c.lat * Math.PI / 180)));

  const bounds = [[c.lat - dLat, c.lng - dLng], [c.lat + dLat, c.lng + dLng]];

  if(!autoScanBox){
    autoScanBox = L.rectangle(bounds, {color:"#fbbf24", weight:2, fillOpacity:0, dashArray:"5,5"}).addTo(map);
  }else{
    autoScanBox.setBounds(bounds);
  }
}

// -----------------------------
// AI analysis (F-15/16)
// -----------------------------
async function postJson(url, body){
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body || {})
  });
  // Let caller handle non-OK for fallback
  const text = await res.text();
  let data = null;
  try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
  return { ok: res.ok, status: res.status, data };
}

function renderAIResult(payload){
  // Expected: checks[], attractiveness_score or ai_score
  const container = el("aiAnalysisResult");
  if(container){
    const checks = Array.isArray(payload.checks) ? payload.checks : [];
    container.innerHTML = checks.map(item => {
      const title = safeText(item.title || item.category, "");
      const result = safeText(item.result || item.status || "", "í™•ì¸ í•„ìš”");
      const link = item.link || item.url || "";
      const needs = item.needs_confirm || item.confirm_needed || (String(result).includes("í™•ì¸") && String(result).includes("í•„ìš”"));
      return `
        <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]">
          <div class="flex items-center gap-2">
            <div class="text-cyan-400">âœ“</div>
            <div>
              <div class="text-slate-300 font-bold">${title}</div>
              <div class="${needs ? "text-yellow-300" : "text-white"} truncate w-60">${result}</div>
            </div>
          </div>
          ${link ? `<a href="${link}" target="_blank" class="bg-slate-600 px-2 py-1 rounded hover:bg-slate-500">ë§í¬</a>` : ""}
        </div>
      `;
    }).join("") || `<div class="text-slate-300 text-xs">AI ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  // Score
  const scorePanel = el("aiScorePanel");
  const scoreValue = el("scoreValue");
  const scoreBar = el("scoreBar");
  const confidenceValue = el("confidenceValue");

  // Score priority: payload.attractiveness_score or payload.ai_score.score
  let score = null;
  let confidence = null;
  if(typeof payload.attractiveness_score === "number") score = payload.attractiveness_score;
  else if(payload.ai_score && typeof payload.ai_score.score === "number") score = payload.ai_score.score;

  if(payload.ai_score && typeof payload.ai_score.confidence === "number") confidence = payload.ai_score.confidence;
  if(typeof payload.confidence === "number") confidence = payload.confidence;

  if(scorePanel && scoreValue && scoreBar){
    if(score === null) {
      scorePanel.classList.add("hidden");
    } else {
      scorePanel.classList.remove("hidden");
      const s = Math.max(0, Math.min(100, Math.round(score)));
      scoreValue.innerText = `${s}ì `;
      scoreBar.style.width = `${s}%`;
      if(confidenceValue) confidenceValue.innerText = (confidence !== null) ? `ì‹ ë¢°ë„: ${confidence}%` : "";
    }
  }

  // Kepco capacity field if present
  if(el("kepcoCapacity")){
    const kc = payload.kepco_capacity || payload.kepco || null;
    if(kc) el("kepcoCapacity").innerText = safeText(kc);
  }

  // sun hours if present
  if(typeof payload.sun_hours === "number"){
    currentAnalysisData.ai_analysis = currentAnalysisData.ai_analysis || {};
    currentAnalysisData.ai_analysis.sun_hours = payload.sun_hours;
  }
}

window.fetchAIData = async function(lat, lng, addr){
  if(FEATURE_LEVEL < 5) return;
  if(!BACKEND_URL){
    logSystem("AI skipped: BACKEND_URL not set (use ?backend=...)");
    return;
  }

  const placeholder = el("legalPlaceholder");
  const loading = el("legalLoading");
  const content = el("legalContent");

  if(placeholder) placeholder.classList.add("hidden");
  if(content) content.classList.add("hidden");
  if(loading) loading.classList.remove("hidden");

  const payload = {
    address: addr,
    mode: (scanTarget === "land") ? "land" : "roof",
    lat, lng,
    panel_count: getTotalPanelCount(),
    setback_m: parseFloat(el("setbackDist")?.value || "0") || 0,
  };

  try{
    // Spec says: POST /api/ai/analyze
    let r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
    if(!r.ok){
      // fallback to existing path used previously in drafts
      r = await postJson(`${BACKEND_URL}/api/analyze/comprehensive`, payload);
    }
    if(!r.ok){
      throw new Error(`AI HTTP ${r.status}`);
    }

    currentAnalysisData.ai_analysis = r.data;

    if(loading) loading.classList.add("hidden");
    if(content) content.classList.remove("hidden");

    renderAIResult(r.data);

    // Recalc finance with sun hours if present
    if(typeof r.data.sun_hours === "number"){
      window.calculateFinance(getTotalPanelCount(), r.data.sun_hours);
    }
  } catch(e){
    if(loading) loading.classList.add("hidden");
    if(placeholder) {
      placeholder.classList.remove("hidden");
      placeholder.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs">AI ë¶„ì„ ì‹¤íŒ¨<br><span class="text-[10px]">${safeText(e.message,"")}</span></div>`;
    }
    logSystem(`AI error: ${e.message}`);
  }
};

// -----------------------------
// Report / History (minimal, keeps UI)
// -----------------------------
window.openFullReport = function(){
  const form = el("reportForm");
  if(!form){
    showToast("reportForm not found");
    return;
  }
  if(!BACKEND_URL){
    showToast("backend ë¯¸ì„¤ì •");
    return;
  }
  // Fill hidden fields if exist
  if(el("form_address")) el("form_address").value = safeText(currentAnalysisData.address, "");
  if(el("form_capacity")) el("form_capacity").value = safeText(el("analysisCapacity")?.innerText, "");
  if(el("form_kepco")) el("form_kepco").value = safeText(el("kepcoCapacity")?.innerText, "í™•ì¸ í•„ìš”");
  if(el("form_date")) el("form_date").value = new Date().toLocaleString();
  if(el("form_finance")) el("form_finance").value = JSON.stringify(currentAnalysisData.finance || {});
  if(el("form_ai")) el("form_ai").value = JSON.stringify(currentAnalysisData.ai_analysis || {});
  if(el("form_score")) el("form_score").value = JSON.stringify(currentAnalysisData.ai_analysis?.ai_score || currentAnalysisData.ai_analysis?.attractiveness_score || {});
  if(el("form_price")) el("form_price").value = ""; // placeholder

  form.action = `${BACKEND_URL}/report`;
  form.submit();
};

function historyKey(){ return "sp_history_v1"; }

function loadHistory(){
  try{
    const raw = localStorage.getItem(historyKey());
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveHistory(items){
  try{ localStorage.setItem(historyKey(), JSON.stringify(items)); }catch(e){}
}
function renderHistory(){
  const list = el("historyList");
  if(!list) return;
  const items = loadHistory();
  if(!items.length){
    list.innerHTML = `<div class="text-xs text-slate-400">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  list.innerHTML = items.map((it, idx)=>`
    <div class="bg-white border border-slate-200 rounded p-2 text-xs shadow-sm">
      <div class="font-bold text-slate-700">${safeText(it.address,"í™•ì¸ í•„ìš”")}</div>
      <div class="text-[10px] text-slate-500">${safeText(it.time,"")}</div>
      <div class="text-[10px] text-slate-600">íŒ¨ë„ ${it.panelCount || 0}ì¥ Â· ëª¨ë“œ ${safeText(it.mode,"")}</div>
    </div>
  `).join("");
}

window.saveResult = function(){
  const items = loadHistory();
  const entry = {
    time: new Date().toLocaleString(),
    address: safeText(currentAnalysisData.address, "í™•ì¸ í•„ìš”"),
    mode: currentAnalysisData.mode || (scanTarget==="land"?"land":"roof"),
    panelCount: getTotalPanelCount(),
    finance: currentAnalysisData.finance || {},
    ai: currentAnalysisData.ai_analysis || {}
  };
  items.unshift(entry);
  saveHistory(items.slice(0, 100));
  showToast("ì €ì¥ ì™„ë£Œ");
  renderHistory();
};

window.clearHistory = function(){
  saveHistory([]);
  showToast("ê¸°ë¡ ì‚­ì œ");
  renderHistory();
};

window.downloadCSV = function(){
  const items = loadHistory();
  if(!items.length){
    showToast("ë‹¤ìš´ë¡œë“œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  const rows = [["time","address","mode","panelCount","acCapacityKw","annualRevenueWon","totalCostWon","score"]];
  for(const it of items){
    const fin = it.finance || {};
    const score = (it.ai && (it.ai.attractiveness_score ?? it.ai.ai_score?.score)) ?? "";
    rows.push([
      it.time || "",
      (it.address || "").replaceAll("\n"," ").replaceAll(","," "),
      it.mode || "",
      it.panelCount || 0,
      fin.acCapacityKw ?? "",
      fin.annualRevenueWon ?? "",
      fin.totalCostWon ?? "",
      score
    ]);
  }
  const csv = rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "solar_pathfinder_history.csv";
  a.click();
  URL.revokeObjectURL(url);
};

// -----------------------------
// Clear / reset helper
// -----------------------------
function clearResults(clearToasts){
  selectableGroup.clearLayers();
  panelGroup.clearLayers();
  analysisMarkerGroup.clearLayers();
  selectedFeatures.clear();
  currentAnalysisFeature = null;
  currentAnalysisData = {};
  resetCalibrationInternal(false);

  const found = el("foundCount");
  if(found) found.innerText = "ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ";

  if(clearToasts) showToast("ì´ˆê¸°í™”");
}

// -----------------------------
// Boot
// -----------------------------
window.onload = function(){
  // stop dpad when focus lost
  window.addEventListener("blur", window.dpadHoldStop);
  window.initMap();
  window.updateEstimatedTime();
  renderHistory();

  // Safety: avoid undefined in UI
  if(el("analysisAddress")) el("analysisAddress").innerText = "í™•ì¸ í•„ìš”";
  if(el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”";

  // If checkboxes exist, initialize
  autoScanMode = !!(el("autoScanToggle")?.checked);
  isMultiSelectMode = !!(el("multiSelectToggle")?.checked);
};
</script>
</body>
</html>
