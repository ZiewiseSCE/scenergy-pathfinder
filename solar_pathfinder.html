<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; background: #1a1a1a; }
        .sidebar { z-index: 2000; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.collapsed { transform: translateX(-100%); }
        #sidebar-toggle-btn { left: 420px; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2001; }
        #sidebar-toggle-btn.collapsed { left: 0; }
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: #f8fafc; }
        .result-card { background: rgba(15, 23, 42, 0.95); border-left: 4px solid #06b6d4; backdrop-filter: blur(4px); }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; color: white; font-size: 16px; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:active { background: #1e293b; transform: translateY(2px); box-shadow: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ë¦¬í¬íŠ¸ ì „ì†¡ìš© íˆë“  í¼ -->
    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="land_price" id="form_price">
    </form>

    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200">
        <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0">
            <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ ì±„êµ´ê¸°</h1>
            <div class="flex justify-between items-center text-[10px] text-slate-400 mt-2 border-t border-slate-700 pt-2"><span id="currentUserDisplay">Public Access</span></div>
            <div class="grid grid-cols-3 gap-1 mt-3 text-center">
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">Backend</div><div id="cnt-vworld" class="font-mono font-bold text-cyan-400">0</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">DB Sync</div><div id="cnt-public" class="font-mono font-bold text-yellow-400">0</div></div>
                <div class="bg-slate-900 rounded p-1 border border-slate-700 text-[8px]"><div class="text-slate-500">AI Analysis</div><div id="cnt-ai" class="font-mono font-bold text-purple-400">0</div></div>
            </div>
        </div>
        <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm">
            <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
            <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
            <button type="button" onclick="window.switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
            <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50">
            <!-- ì„¤ì • íŒ¨ë„ (ì•„ì½”ë””ì–¸) -->
            <div class="p-4 pb-0">
                <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4" open>
                    <summary class="p-3 text-xs font-bold text-slate-600 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg"><span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i></summary>
                    <div class="p-3 space-y-3 border-t border-gray-200 text-xs">
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center bg-white" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ìµœëŒ€ë†’ì´(m)</label><input type="number" id="installHeight" value="0.5" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <!-- [F-8] ì´ê²©ê±°ë¦¬(Setback) ì¶”ê°€ -->
                             <div class="grid grid-cols-2 gap-2">
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">ëª¨ë“ˆ ì¶œë ¥(W)</label><input type="number" id="modPower" value="640" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                <div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">ì´ê²©ê±°ë¦¬(Setback, m)</label><input type="number" id="setbackDist" value="0.0" step="0.5" class="w-full border p-1 rounded text-center font-bold text-red-600" onchange="window.reCalculate()"></div>
                             </div>
                             <div class="grid grid-cols-2 gap-2 mt-2">
                                <div><label class="block mb-0.5 text-[10px] text-slate-500 font-bold">íŒ¨ë„ ê°„ê²©(Row, m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                             </div>
                        </div>
                        <div class="bg-green-50 p-2 rounded border border-green-200">
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px] text-emerald-700 font-bold">ëª¨ë“ˆë‹¨ê°€</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center font-bold text-emerald-700" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">ì‹œê³µ(ë§Œ/kW)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 mb-2"><div><label class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div></div>
                             <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2"><div><label class="block mb-0.5 text-[10px] text-blue-600 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center text-blue-600 font-bold" onchange="window.reCalculate()"></div><div><label class="block mb-0.5 text-[10px] text-red-600 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center text-red-600 font-bold" onchange="window.reCalculate()"></div></div>
                        </div>
                    </div>
                </details>
                <!-- [F-5] ì§€ë¶•/í† ì§€ ëª¨ë“œ ì „í™˜ -->
                <div class="flex gap-2 text-xs mb-4">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="land" class="peer hidden" onchange="window.toggleTarget()" aria-label="í† ì§€"><div class="text-center py-2 border rounded bg-white peer-checked:bg-amber-800 peer-checked:text-white hover:bg-gray-50 transition shadow-sm"><i class="ph ph-tree"></i> í† ì§€ (Land)</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="scanTarget" value="building" class="peer hidden" onchange="window.toggleTarget()" checked aria-label="ì§€ë¶•"><div class="text-center py-2 border rounded bg-white peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-gray-50 transition shadow-sm"><i class="ph ph-factory"></i> ì§€ë¶• (Roof)</div></label>
                </div>
            </div>

            <div class="px-4 pb-4">
                <!-- 1. ìŠ¤ìº” íŒ¨ë„ -->
                <div id="panel-scan" class="space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <label for="regionSelect" class="text-xs font-bold text-gray-700 mb-2 block">ğŸ“ ì§€ì—­ ì„ íƒ (ì „ìˆ˜ì¡°ì‚¬)</label>
                        <select id="regionSelect" onchange="window.setRegion()" class="w-full text-sm border rounded p-2 bg-gray-50 font-bold outline-none">
                            <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <optgroup label="ğŸ­ ìˆ˜ë„ê¶Œ/ê²½ê¸° ì£¼ìš” ì‚°ë‹¨">
                                <option value="ansan_ind">ì•ˆì‚° ë°˜ì›”/ì‹œí™” ì‚°ë‹¨</option>
                                <option value="incheon_ind">ì¸ì²œ ë‚¨ë™ê³µë‹¨</option>
                                <option value="hwaseong_ind">í™”ì„± ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="pyeongtaek_ind">í‰íƒ í¬ìŠ¹ê³µë‹¨</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì¶©ì²­ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="cheonan_ind">ì²œì•ˆ ì¼ë°˜ì‚°ì—…ë‹¨ì§€</option>
                                <option value="osan_ind">ì˜¤ì°½ ê³¼í•™ì‚°ì—…ë‹¨ì§€</option>
                                <option value="daejeon_ind">ëŒ€ì „ ëŒ€ë•í…Œí¬ë…¸ë°¸ë¦¬</option>
                            </optgroup>
                            <optgroup label="ğŸ­ ì˜ë‚¨ê¶Œ ì£¼ìš” ì‚°ë‹¨">
                                <option value="gumi_ind">êµ¬ë¯¸ êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="changwon_ind">ì°½ì› êµ­ê°€ì‚°ì—…ë‹¨ì§€</option>
                                <option value="ulsan_ind">ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚° ì‚°ë‹¨</option>
                                <option value="daegu_ind">ëŒ€êµ¬ ì„±ì„œê³µë‹¨</option>
                                <option value="pohang_ind">í¬í•­ ì² ê°•ì‚°ì—…ë‹¨ì§€</option>
                            </optgroup>
                            <optgroup label="ğŸŒ² ëŒ€í•œë¯¼êµ­ ê´‘ì—­ ì§€ìì²´">
                                <option value="seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                <option value="gyeonggi">ê²½ê¸°ë„</option>
                                <option value="jeonnam">ì „ë¼ë‚¨ë„</option>
                                <option value="jeonbuk">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                                <option value="gyeongnam">ê²½ìƒë‚¨ë„</option>
                                <option value="jeju">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- [F-12] ìŠ¤ìº” íƒ€ì´ë¨¸ ë° ìƒíƒœì°½ -->
                    <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500">
                        <div class="flex justify-between items-center bg-slate-700/50 p-1.5 rounded border border-slate-600 mb-1">
                            <label for="scanDelay" class="text-[9px] font-bold text-cyan-300">API ì•ˆì „ ë”œë ˆì´</label>
                            <select id="scanDelay" class="bg-slate-900 text-[10px] font-mono border-none outline-none text-yellow-400" onchange="window.updateEstimatedTime()">
                                <option value="6000" selected>6ì´ˆ (ê¶Œì¥)</option>
                                <option value="3000">3ì´ˆ (ë¹ ë¦„/ì°¨ë‹¨ìœ„í—˜)</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-end"><div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400">00:00:00</div><div id="progressCount" class="text-[10px] text-gray-500 font-mono">0 / 20</div></div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden"><div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                        <div class="flex justify-between items-end mt-1 px-1"><div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div></div>
                        <div class="flex items-center gap-2 mb-2 mt-2">
                             <input type="checkbox" id="autoFollow" class="w-4 h-4 rounded border-gray-600 text-indigo-600 focus:ring-indigo-500 bg-gray-700" checked>
                             <label for="autoFollow" class="text-[10px] text-slate-300 cursor-pointer select-none">ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <button type="button" onclick="window.startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                            <button type="button" onclick="window.cancelMission(true)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â–  ì·¨ì†Œ(ìœ ì§€)</button>
                            <button type="button" onclick="window.downloadScanResults('geojson')" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">â¬‡ ê²°ê³¼ë‹¤ìš´</button>
                            <button type="button" onclick="window.cancelMission(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ë¦¬ì…‹</button>
                        </div>
                    </div>
                </div>

                <!-- 2. ì •ë°€ ë¶„ì„ íŒ¨ë„ -->
                <div id="panel-analysis" class="hidden space-y-4">
                    <!-- [F-10] D-Pad -->
                    <div class="bg-slate-800 p-2 rounded-lg border border-indigo-500/50 shadow-lg mb-2">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ë¯¸ì„¸ì¡°ì • (D-Pad)</span><button type="button" onclick="window.resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                        <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                             <div class="grid grid-cols-3 gap-2">
                                <div></div><button type="button" class="d-pad-btn" onclick="window.applyCalibration(0, 0.2)">â–²</button><div></div>
                                <button type="button" class="d-pad-btn" onclick="window.applyCalibration(-0.2, 0)">â—€</button>
                                <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                                <button type="button" class="d-pad-btn" onclick="window.applyCalibration(0.2, 0)">â–¶</button>
                                <div></div><button type="button" class="d-pad-btn" onclick="window.applyCalibration(0, -0.2)">â–¼</button><div></div>
                             </div>
                             <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                                <button type="button" class="d-pad-btn flex-1 text-[10px]" onclick="window.applyCalibration(0, 0, -2)">â†º íšŒì „</button>
                                <button type="button" class="d-pad-btn flex-1 text-[10px]" onclick="window.applyCalibration(0, 0, 2)">â†» íšŒì „</button>
                            </div>
                        </div>
                    </div>

                    <!-- [F-17] ìƒì„¸ PF ê²°ê³¼ í‘œì‹œ -->
                    <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                        <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right truncate w-40">-</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰(AC/DC):</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                            <!-- [F-25] í•œì „ìš©ëŸ‰ í™•ì¸í•„ìš” í‘œì‹œ -->
                            <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">í™•ì¸ í•„ìš”</span></div>
                        </div>
                        <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600 text-xs">
                            <div class="flex justify-between"><span>ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                            <div class="flex justify-between"><span>ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                        </div>
                        <!-- PF ìƒì„¸ -->
                        <div class="bg-indigo-900/40 p-2 rounded border border-indigo-500/30 text-[10px] space-y-1">
                            <div class="flex justify-between"><span class="text-indigo-200">ğŸ¦ ì›” ìƒí™˜ì•¡:</span><span id="resMonthlyDebt" class="text-white font-bold">0 ì›</span></div>
                            <div class="flex justify-between"><span class="text-indigo-200">ğŸ’³ ì´ ì´ìë¹„ìš©:</span><span id="resTotalInterest" class="text-white font-bold">0 ì›</span></div>
                            <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button type="button" onclick="window.saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition">ì €ì¥</button>
                             <!-- [F-20] ìƒì„¸ ë¦¬í¬íŠ¸ ì´ë™ -->
                             <button type="button" onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition">ìƒì„¸ ë¦¬í¬íŠ¸</button>
                        </div>
                    </div>
                </div>

                <!-- [F-15, F-16] AI ë¶„ì„ íŒ¨ë„ -->
                <div id="panel-legal" class="hidden space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                        <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> 8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­ & ì ìˆ˜</h3>
                        
                        <div id="aiScorePanel" class="hidden mb-4 bg-slate-900/50 p-3 rounded border border-slate-600 mt-2">
                             <div class="flex items-center justify-between mb-2">
                                 <span class="text-xs text-slate-300 font-bold">êµ¬ë§¤ë§¤ë ¥ë„ (AI Score)</span>
                                 <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                             </div>
                             <div class="w-full bg-slate-700 rounded-full h-2.5 mb-2 overflow-hidden">
                                 <div id="scoreBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                             </div>
                             <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                        </div>

                        <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                            <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ 8ëŒ€ í•­ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                        </div>

                        <div id="legalLoading" class="hidden text-center py-10">
                            <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                            <p class="text-xs text-purple-300 animate-pulse">ìƒì„¸ ê·œì œ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                        </div>

                        <div id="legalContent" class="hidden space-y-4 mt-2">
                             <!-- [F-15] 8ëŒ€ ì²´í¬í•­ëª© ë¦¬ìŠ¤íŠ¸ -->
                             <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2"></div>
                        </div>
                    </div>
                </div>

                <div id="panel-history" class="hidden space-y-4">
                    <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-2 border-b pb-1">
                            <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                            <div class="flex gap-2">
                                <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV ë‹¤ìš´</button>
                                <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
                
                <div id="loading" class="hidden flex flex-col items-center justify-center py-4"><div class="spinner mb-2"></div><p class="text-xs text-slate-500">ì²˜ë¦¬ ì¤‘...</p></div>
            </div>
        </div>
        
        <div class="h-24 bg-slate-900 border-t border-slate-700 p-3 font-mono text-[10px] overflow-y-auto text-slate-400" id="logWindow"><div class="text-green-500">> System Ready.</div></div>
    </div>
    
    <div id="sidebar-toggle-btn" onclick="window.toggleSidebar()" class="absolute top-1/2 transform -translate-y-1/2 bg-white w-6 h-12 rounded-r-lg shadow-md cursor-pointer flex items-center justify-center border border-l-0 border-gray-300 text-gray-400 hover:text-cyan-600"><i class="ph ph-caret-left font-bold transition-transform"></i></div>
    
    <!-- [F-4] ì£¼ì†Œ ê²€ìƒ‰ì°½ -->
    <div class="absolute top-5 left-1/2 transform -translate-x-1/2 z-[1000] flex flex-col items-center gap-2">
        <div class="bg-white p-1 rounded-lg shadow-xl border border-slate-200 flex items-center">
            <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" class="w-64 px-3 py-2 text-sm outline-none text-slate-700 font-medium" onkeypress="if(event.key==='Enter') window.searchAddress()">
            <button type="button" onclick="window.searchAddress()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-2 rounded-md transition shadow-md"><i class="ph ph-magnifying-glass font-bold"></i></button>
        </div>
    </div>
    
    <!-- ìš°ì¸¡ ì„¤ì • -->
    <div class="absolute top-5 right-5 z-[1000] bg-white p-2 rounded-lg shadow-lg border border-gray-200 text-xs w-44">
        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1"><i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •</div>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 rounded text-indigo-700 font-bold border border-indigo-200"><input type="checkbox" id="multiSelectToggle" onchange="window.toggleMultiSelect()"><span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span></label>
        <!-- [F-13] ìë™ ìŠ¤ìº” -->
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
            <input type="checkbox" id="autoScanToggle" onchange="window.toggleAutoScan()">
            <span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”(ì´ë™ì‹œ)</span>
        </label>
        <hr class="my-2 border-gray-200">
        <!-- [F-26, F-25] ë ˆì´ì–´ í† ê¸€ -->
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="existingPlantToggle" onchange="window.toggleLayer('existing')" checked><span>ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘(ê°€ìƒ)</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="substationToggle" onchange="window.toggleLayer('substation')" checked><span>ë³€ì „ì†Œ/ì„ ë¡œ(ê°€ìƒ)</span></label>
        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600"><input type="checkbox" id="cadastralToggle" onchange="window.toggleLayer('cadastral')" checked><span>ì§€ì ë„ (VWorld)</span></label>
        <div class="space-y-1 mt-2">
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="sat" checked onchange="window.setMap('sat')"> <span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span></label>
            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="base" onchange="window.setMap('base')"> <span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span></label>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText"></span></div>
    <div id="map"></div>

    <script>
        // VWorld API Key
        const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";
        
        // Backend URL Discovery
        (function(){
            try{
                const qs = new URLSearchParams(window.location.search || "");
                const b = qs.get("backend");
                if (b) {
                    let decoded = b;
                    try { decoded = decodeURIComponent(b); } catch(e) {}
                    window.BACKEND_URL = decoded.replace(/\/$/, "");
                }
            } catch(e) {}
            if (typeof window.BACKEND_URL !== "string") window.BACKEND_URL = "";
            window.BACKEND_URL = window.BACKEND_URL.replace(/\/$/, "");
        })();
        const BACKEND_URL = window.BACKEND_URL || "";
        const CLIENT_TOKEN = ""; // Not strictly enforced for public

        let map, layers, selectableGroup, panelGroup, cadastralLayer, analysisMarkerGroup, existingGroup, substationGroup;
        let scanTarget='building', currentAnalysisFeature=null, currentGeoState={x:0,y:0,rot:0}, autoScanMode=false, isMultiSelectMode=false, accumulatedPanelsCount=0;
        let selectedFeatures = new Map();
        let _autoScanBox = null;

        // Analysis Data State
        window.currentAnalysisData = {};
        
        // Panel Calibration Base
        let _basePanelsFC = null;
        let _currentPanelsLayer = null;
        
        // Mission State
        let stopScan = false;
        let missionPaused = false;
        let missionRunning = false;
        let _missionTimer = null;
        let _missionEndAt = null;
        let scanLock = false;

        // --- Utils ---
        window.showToast = function(m) { 
            const t = document.getElementById('toastMsg'); 
            const text = document.getElementById('toastText');
            if(t && text) {
                t.classList.remove('hidden'); 
                t.classList.add('flex'); 
                text.innerText = m; 
                setTimeout(() => t.classList.add('hidden'), 3000); 
            }
        };

        window.logSystem = function(msg) { 
            const w = document.getElementById('logWindow'); 
            if(w) { 
                const p = document.createElement('div'); 
                p.innerText = `> ${msg}`; 
                w.appendChild(p); 
                w.scrollTop = w.scrollHeight; 
            } 
        };

        window.safeGetItem = function(key) { try { return localStorage.getItem(key); } catch(e) { return null; } };
        window.safeSetItem = function(key, val) { try { localStorage.setItem(key, val); } catch(e) { } };

        // --- JSONP Helper for VWorld ---
        async function jsonpRequest(url) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                window[callbackName] = (data) => { 
                    delete window[callbackName]; 
                    const script = document.getElementById(callbackName);
                    if(script) document.body.removeChild(script); 
                    resolve(data); 
                };
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
                script.onerror = () => { 
                    delete window[callbackName]; 
                    document.body.removeChild(script); 
                    reject(new Error('JSONP failed')); 
                };
                document.body.appendChild(script);
            });
        }

        // --- Map Init ---
        window.initMap = function() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([36.5, 127.5], 7);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            layers = { 
                base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`), 
                sat: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
                hybrid: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Hybrid/{z}/{y}/{x}.png`) 
            };
            layers.sat.addTo(map);
            
            selectableGroup = L.layerGroup().addTo(map); 
            panelGroup = L.layerGroup().addTo(map); 
            analysisMarkerGroup = L.layerGroup().addTo(map);
            existingGroup = L.layerGroup().addTo(map); 
            substationGroup = L.layerGroup().addTo(map);
            
            cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', { 
                layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun', 
                styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun', 
                format: 'image/png', transparent: true, opacity: 0.7, key: VWORLD_TILE_KEY 
            });
            map.addLayer(cadastralLayer);
            
            // [F-6] Click handling
            map.on('click', (e) => window.scanBuildings(e.latlng.lat, e.latlng.lng));
            
            // [F-13] Auto scan on move
            map.on('moveend', () => { 
                if(autoScanMode) { 
                    if(document.getElementById('autoFollow')?.checked) return;
                    const c = map.getCenter(); 
                    window.scanBuildings(c.lat, c.lng); 
                } 
                try{ _updateAutoScanBox(); }catch(e){}
                try{ window.refreshInfraMarkers?.(); }catch(e){}
            });
            
            window.logSystem("Map Initialized.");
            window.updateEstimatedTime();
        };

        window.setMap = function(t) { 
            if(!map) return;
            if(t==='base') { map.addLayer(layers.base); map.removeLayer(layers.sat); } 
            else { map.addLayer(layers.sat); map.removeLayer(layers.base); } 
        };

        // --- Layers ---
        window.toggleLayer = function(type) {
            if(!map) return;
            if(type === 'cadastral') {
                if(document.getElementById('cadastralToggle').checked) map.addLayer(cadastralLayer);
                else map.removeLayer(cadastralLayer);
            } else if(type === 'existing' || type === 'substation') {
                const grp = type === 'existing' ? existingGroup : substationGroup;
                const chk = document.getElementById(type === 'existing' ? 'existingPlantToggle' : 'substationToggle');
                if(chk.checked) {
                    if(grp.getLayers().length === 0) window.createMockMarkers(map.getCenter(), type === 'existing'?'plant':'substation');
                    map.addLayer(grp);
                } else {
                    grp.clearLayers(); map.removeLayer(grp);
                }
            }
        };

        // --- Infra Markers (Mock, stable) [F-25/F-26 ì¤€ë¹„] ---
let _infraKeyPlant = null;
let _infraKeySub = null;

function _hashSeed(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
    }
    return h >>> 0;
}
function _rng(seed){
    // xorshift32
    let x = seed || 123456789;
    return function(){
        x ^= x << 13; x >>>= 0;
        x ^= x >> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x >>> 0) / 4294967296;
    }
}

function _makeMarkerIcon(type){
    const iconHtml = type === 'plant'
        ? `<div class="w-5 h-3 bg-red-500 border border-red-800 transform -skew-x-12 shadow"></div>`
        : `<div class="w-6 h-6 flex items-center justify-center bg-yellow-500 rounded text-white"><i class="ph-bold ph-lightning"></i></div>`;
    return L.divIcon({ className: '', html: iconHtml, iconSize: [24, 24] });
}

function _populateMockMarkers(type, key){
    const group = type === 'plant' ? existingGroup : substationGroup;
    const seed = _hashSeed(key + ":" + type);
    const rand = _rng(seed);

    group.clearLayers();

    // í˜„ì¬ í™”ë©´ bbox ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜(ì¤Œ ì¸/ì•„ì›ƒí•´ë„ ê°™ì€ keyë©´ ì¬ìƒì„± ì•ˆë¨)
    const b = map.getBounds();
    const minLat = b.getSouth(), maxLat = b.getNorth();
    const minLng = b.getWest(),  maxLng = b.getEast();

    const n = 6; // ì¡°ê¸ˆ ë” í’ë¶€í•˜ê²Œ
    for(let i=0;i<n;i++){
        const lat = minLat + (maxLat-minLat) * rand();
        const lng = minLng + (maxLng-minLng) * rand();
        L.marker([lat,lng], { icon: _makeMarkerIcon(type) }).addTo(group);
    }
}

// ì§€ë„ ì´ë™/ê²€ìƒ‰ í›„ ì¸í”„ë¼ ë§ˆì»¤ ê°±ì‹ : "ê°€ê¹Œì´ ë³´ë©´ ë§‰ ì›€ì§ì„" ë°©ì§€ (í‚¤ê°€ ë°”ë€” ë•Œë§Œ ì¬ìƒì„±)
window.refreshInfraMarkers = function(){
    if(!map) return;
    const z = map.getZoom();
    // í™•ëŒ€í–ˆì„ ë•Œë§Œ í‘œê¸° (ë¶€í•˜/ê°€ë…ì„±)
    if(z < 13){
        existingGroup.clearLayers();
        substationGroup.clearLayers();
        _infraKeyPlant = null;
        _infraKeySub = null;
        return;
    }

    const c = map.getCenter();
    const keyBase = `${Math.floor(c.lat*200)}_${Math.floor(c.lng*200)}_z${z}`; // ì•½ 500m ë‹¨ìœ„ + zoom
    if(document.getElementById('existingPlantToggle')?.checked){
        if(_infraKeyPlant !== keyBase){
            _infraKeyPlant = keyBase;
            _populateMockMarkers('plant', keyBase);
            if(!map.hasLayer(existingGroup)) map.addLayer(existingGroup);
        }
    }
    if(document.getElementById('substationToggle')?.checked){
        if(_infraKeySub !== keyBase){
            _infraKeySub = keyBase;
            _populateMockMarkers('substation', keyBase);
            if(!map.hasLayer(substationGroup)) map.addLayer(substationGroup);
        }
    }
};

// ì´ˆê¸° ìƒì„±(í† ê¸€ ì¼  ìƒíƒœë©´)
window.createMockMarkers = function(center, type) {
    // ê¸°ì¡´ í˜¸ì¶œ í˜¸í™˜ìš©: refreshInfraMarkersë¡œ ìœ„ì„
    try{ window.refreshInfraMarkers(); }catch(e){}
};

        // --- Address Search [F-4] ---
        window.searchAddress = async function() {
            const query = document.getElementById('addrInput').value;
            if(!query) return window.showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            try {
                // VWorld Geocoder 2.0
                const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(query)}&refine=true&simple=false&type=road&key=${VWORLD_TILE_KEY}`;
                const data = await jsonpRequest(url);
                if(data.response?.status === 'OK') {
                    const { x, y } = data.response.result.point;
                    map.setView([parseFloat(y), parseFloat(x)], 18);
                    // ì£¼ì†Œ ê²€ìƒ‰ í›„ ìë™ ìŠ¤ìº” + ì²«ë²ˆì§¸ í”¼ì²˜ ìë™ ë¶„ì„(íŒ¨ë„ ìë™ ìƒì„±)
                    await new Promise(r=>setTimeout(r, 450));
                    const scanRes = await window.scanBuildings(parseFloat(y), parseFloat(x), true);
                    if(scanRes && scanRes.features && scanRes.features.length>0){
                        window.analyzeFeature(scanRes.features[0]);
                    }
                    window.showToast("ì£¼ì†Œ ì´ë™ ì™„ë£Œ");
                } else window.showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            } catch(e) { console.error(e); } finally { loading.classList.add('hidden'); }
        };

        // --- Scan & Analyze Core [F-6] ---
        window.scanBuildings = async function(lat, lng, force=false) {
            if (!map || (scanLock && !force)) return;
            scanLock = true;
            
            let fetchedFeatures = [];
try {
                if (!isMultiSelectMode) {
                    if (selectableGroup) selectableGroup.clearLayers();
                    window.clearResults();
                }

                if (analysisMarkerGroup) analysisMarkerGroup.clearLayers();
                L.marker([lat, lng]).addTo(analysisMarkerGroup);

                // Fetch Geometry from VWorld
                const box = `${lng - 0.001},${lat - 0.001},${lng + 0.001},${lat + 0.001}`;
                const layerName = scanTarget === 'land' ? 'LP_PA_CBND_BUBUN' : 'LT_C_SPBD';
                const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${layerName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=20`;
                const data = await jsonpRequest(url);
                
                if(data.response?.status === 'OK') {
                    fetchedFeatures = (data.response.result.featureCollection && data.response.result.featureCollection.features) ? data.response.result.featureCollection.features : [];
                    L.geoJSON(data.response.result.featureCollection.features, {
                        style: scanTarget === 'land' 
                            ? { color: '#8d6e63', weight: 2, fillColor: '#8d6e63', fillOpacity: 0.3 } 
                            : { color: '#3b82f6', weight: 2, fillOpacity: 0.2 },
                        onEachFeature: (feature, layer) => {
                            layer.on('click', (e) => {
                                L.DomEvent.stopPropagation(e);
                                window.analyzeFeature(feature);
                            });
                    }}).addTo(selectableGroup);
                    const cnt = document.getElementById('foundCount');
                    if(cnt) cnt.innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${selectableGroup.getLayers().length}ê°œ`;
                }
                return {features: fetchedFeatures, count: fetchedFeatures.length};
            }
            return {features: fetchedFeatures, count: fetchedFeatures.length};
        } catch(e) { console.error(e); }
            finally { setTimeout(() => { scanLock = false; }, 800); }
        };

        window.analyzeFeature = async function(feature) {
            const center = turf.center(feature).geometry.coordinates;
            const featureId = feature.properties.pnu || `${center[1].toFixed(6)}_${center[0].toFixed(6)}`;
            
            if (selectedFeatures.has(featureId)) {
                if (isMultiSelectMode) {
                    const stored = selectedFeatures.get(featureId);
                    panelGroup.removeLayer(stored.layer);
                    selectedFeatures.delete(featureId);
                    reCalcTotal();
                }
                return;
            }

            if (!isMultiSelectMode) window.clearResults();

            window.switchTab('analysis');
            document.getElementById('resultCard').classList.remove('hidden');
            
            // [F-23] Address Fallback
            const props = feature.properties;
            const addr = props.road_nm_ad || props.jibun_addr || props.addr || (props.pnu ? `PNU:${props.pnu}` : '') || "ì£¼ì†Œ í™•ì¸ í•„ìš”";
            document.getElementById('analysisAddress').innerText = addr;
            
            // [F-6] Draw Panels (Auto)
            const drawResult = window.drawPanels(feature.geometry); 
            if (drawResult) {
                selectedFeatures.set(featureId, { layer: drawResult.layer, count: drawResult.count, address: addr });
                reCalcTotal();
            }

            // Prep Data
            Object.assign(currentAnalysisData, { address: addr, date: new Date().toLocaleDateString() });
            currentAnalysisFeature = feature;
            
            // [F-15] Call AI Analysis
            window.fetchAIData(center[1], center[0], addr);
        };

        function reCalcTotal() {
            let total = 0; 
            selectedFeatures.forEach(v => total += v.count);
            accumulatedPanelsCount = total;
            window.calculateFinance(total);
        }

        // --- Panel Generation Logic [F-8, F-7] ---
        function _buildPanelsGrid(geo) {
            let poly = turf.feature(geo);

            // [F-8] Setback Logic
            const setback = parseFloat(document.getElementById('setbackDist').value) || 0;
            if (setback > 0) {
                try {
                    // Turf buffer (negative for shrinking)
                    const buffered = turf.buffer(poly, -setback, { units: 'meters' });
                    if (!buffered || !buffered.geometry) return { count: 0, fc: {type:"FeatureCollection", features:[]} };
                    // Buffer can return MultiPolygon if shape splits
                    poly = buffered;
                } catch(e) {
                    console.error("Setback calculation error", e);
                    // Fallback to original if buffer fails (e.g. too complex)
                }
            }

            const modW = parseFloat(document.getElementById('modWidth').value) || 1.13;
            const modH = parseFloat(document.getElementById('modHeight').value) || 2.4;
            const angle = parseFloat(document.getElementById('installAngle').value) || 20;
            const projectedH = modH * Math.cos(angle * Math.PI / 180);
            const rowSpacing = parseFloat(document.getElementById('rowSpacing').value) || 1.2;

            const bbox = turf.bbox(poly);
            // Approx meters/degree logic (simplified)
            const centerLat = (bbox[1] + bbox[3]) / 2;
            const metersPerDegLng = 111320 * Math.cos(centerLat * Math.PI / 180);
            const metersPerDegLat = 111000;
            
            const dLng = (modW + 0.10) / metersPerDegLng;
            const dLat = (projectedH + rowSpacing) / metersPerDegLat;

            let tempPanels = [], count = 0, loopGuard = 0;
            const MAX_LOOP = 20000;

            for(let x = bbox[0]; x < bbox[2]; x += dLng) {
                for(let y = bbox[1]; y < bbox[3]; y += dLat) {
                    if(loopGuard++ > MAX_LOOP) break;
                    const centerPt = turf.point([x + dLng/2, y + dLat/2]);
                    if(turf.booleanPointInPolygon(centerPt, poly)) {
                        // Create panel rect
                        const pPoly = turf.bboxPolygon([x, y, x + (modW/metersPerDegLng), y + (projectedH/metersPerDegLat)]);
                        tempPanels.push(pPoly);
                        count++;
                    }
                }
            }
            return { fc: { type:"FeatureCollection", features: tempPanels }, count };
        }

        function _renderPanels(fc) {
            // [F-7] Land Mode Blue Panels
            const style = { 
                color: '#1e40af', 
                weight: 1, 
                fillColor: '#3b82f6', // Always blue for panels
                fillOpacity: 0.6 
            };
            const layer = L.geoJSON(fc, { style });
            layer.addTo(panelGroup);
            return layer;
        }

        function _applyCalibrationToFC(baseFC) {
            let fc = turf.clone(baseFC);
            if (currentGeoState.x || currentGeoState.y || currentGeoState.rot) {
                if (currentGeoState.rot) fc = turf.transformRotate(fc, currentGeoState.rot);
                if (currentGeoState.x || currentGeoState.y) fc = turf.transformTranslate(fc, currentGeoState.x / 1000, 90); // Simplified translation
                if (currentGeoState.y) fc = turf.transformTranslate(fc, currentGeoState.y / 1000, 0);
            }
            return fc;
        }

        window.drawPanels = function(geo) {
            try {
                const built = _buildPanelsGrid(geo);
                _basePanelsFC = built.fc;
                
                // Remove old layer if exists (in single mode)
                if (!isMultiSelectMode && _currentPanelsLayer) {
                    panelGroup.removeLayer(_currentPanelsLayer);
                }

                _currentPanelsLayer = _renderPanels(_basePanelsFC);
                return { layer: _currentPanelsLayer, count: built.count };
            } catch(e) { console.error("Panel Draw Error:", e); return null; } 
        };

        // --- Finance Calculation [F-17] ---
        window.calculateFinance = function(count, sunHoursOverride) {
            const modPowerW = parseFloat(document.getElementById('modPower').value) || 640;
            const dcKw = (count * modPowerW) / 1000;
            const acKw = dcKw / 1.15; // Inverter ratio
            
            // UI Updates
            if(document.getElementById('analysisCount')) document.getElementById('analysisCount').innerText = `${count} ì¥`;
            if(document.getElementById('analysisCapacity')) document.getElementById('analysisCapacity').innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;

            const costPerKw = (parseFloat(document.getElementById('costPerKw').value) || 90) * 10000;
            const modPrice = parseFloat(document.getElementById('modPrice').value) || 350;
            const smp = parseFloat(document.getElementById('smp').value) || 140;
            const rec = parseFloat(document.getElementById('rec').value) || 70;
            const pfRatio = parseFloat(document.getElementById('pfLoanRatio').value) || 90;
            const pfRate = parseFloat(document.getElementById('pfInterestRate').value) || 5.5;
            
            const sun = sunHoursOverride || 3.6;

            // Income
            const annualKwh = acKw * sun * 365 * 0.8; // PR 0.8
            const annualRev = annualKwh * (smp + rec);

            // Cost
            const moduleCost = (count * modPowerW) * modPrice;
            const bosCost = acKw * costPerKw;
            const totalCost = moduleCost + bosCost;

            // Loan
            const loan = totalCost * (pfRatio/100);
            const equity = totalCost - loan;
            const loanYears = 10;
            
            // PMT Calculation (Annual)
            const r = pfRate / 100;
            let annualDebt = 0;
            if (loan > 0 && r > 0) {
                annualDebt = loan * (r * Math.pow(1+r, loanYears)) / (Math.pow(1+r, loanYears) - 1);
            } else {
                annualDebt = loan / loanYears;
            }
            
            // [F-17] Detailed PF Stats
            const totalPayment = annualDebt * loanYears;
            const totalInterest = totalPayment - loan;
            const monthlyDebt = annualDebt / 12;

            // ROI Payback
            const annualOpex = acKw * 20000; // 2ë§Œì›/kW
            let payback = null;
            let cum = -equity;
            for(let y=1; y<=25; y++) {
                const debt = y <= loanYears ? annualDebt : 0;
                cum += (annualRev - annualOpex - debt);
                if(cum >= 0 && payback === null) payback = y;
            }

            // Render
            document.getElementById('resTotalCost').innerText = Math.round(totalCost).toLocaleString() + " ì›";
            document.getElementById('resAnnualRev').innerText = Math.round(annualRev).toLocaleString() + " ì›";
            
            document.getElementById('resMonthlyDebt').innerText = Math.round(monthlyDebt).toLocaleString() + " ì›";
            document.getElementById('resTotalInterest').innerText = Math.round(totalInterest).toLocaleString() + " ì›";
            document.getElementById('resPfPayback').innerText = payback ? `${payback}ë…„` : "> 25ë…„";

            // Save Data for Report
            currentAnalysisData.finance = {
                acCapacity: `${acKw.toFixed(1)} kW`,
                dcCapacity: `${dcKw.toFixed(1)} kW`,
                totalCost: `${Math.round(totalCost).toLocaleString()} ì›`,
                annualRev: `${Math.round(annualRev).toLocaleString()} ì›`,
                annualKwh: `${Math.round(annualKwh).toLocaleString()} kWh`,
                loan: `${Math.round(loan).toLocaleString()} ì›`,
                equity: `${Math.round(equity).toLocaleString()} ì›`,
                annualDebt: `${Math.round(annualDebt).toLocaleString()} ì›`,
                annualOpex: `${Math.round(annualOpex).toLocaleString()} ì›`,
                payback: payback ? `${payback}ë…„` : "25ë…„ ì´ìƒ",
                moduleCost: `${Math.round(moduleCost).toLocaleString()} ì›`,
                bosCost: `${Math.round(bosCost).toLocaleString()} ì›`
            };
        };

        // --- Recalculate Trigger [F-9] ---
        window.reCalculate = function() {
            if(!currentAnalysisFeature) return;
            // Re-draw with new setback/dimensions
            window.drawPanels(currentAnalysisFeature.geometry);
            
            // Re-calc finance
            window.calculateFinance(accumulatedPanelsCount, currentAnalysisData.ai_analysis?.sun_hours);
            window.showToast("ì¬ê³„ì‚° ì™„ë£Œ");
        };

        // --- AI Data Fetch [F-15] ---
        window.fetchAIData = async function(lat, lng, addr) {
            const loading = document.getElementById('legalLoading');
            const content = document.getElementById('legalContent');
            const placeholder = document.getElementById('legalPlaceholder');
            const scorePanel = document.getElementById('aiScorePanel');

            placeholder.classList.add('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            scorePanel.classList.add('hidden');

            try {
                const res = await fetch(`${BACKEND_URL}/api/analyze/comprehensive`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat, lng, address: addr})
                });
                const data = await res.json();
                
                loading.classList.add('hidden');
                content.classList.remove('hidden');

                if(data.status === 'OK' || data.ok) {
                    currentAnalysisData.ai_analysis = data;
                    
                    // Update Sun Hours
                    if(data.sun_hours) window.calculateFinance(accumulatedPanelsCount, data.sun_hours);
                    
                    // Score Panel
                    if(data.ai_score) {
                        scorePanel.classList.remove('hidden');
                        document.getElementById('scoreValue').innerText = `${data.ai_score.score}ì `;
                        document.getElementById('scoreBar').style.width = `${data.ai_score.score}%`;
                        if(data.ai_score.confidence) document.getElementById('confidenceValue').innerText = `ì‹ ë¢°ë„: ${data.ai_score.confidence}%`;
                    }

                    // [F-25] KEPCO Update
                    if(data.kepco_capacity) {
                        document.getElementById('kepcoCapacity').innerText = data.kepco_capacity;
                    }

                    // [F-15] 8 Major Checklist Rendering
                    const container = document.getElementById('aiAnalysisResult');
                    if(data.checks && Array.isArray(data.checks)) {
                        container.innerHTML = data.checks.map(item => `
                            <div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]">
                                <div class="flex items-center gap-2">
                                    <div class="text-cyan-400"><i class="ph ph-check-circle"></i></div>
                                    <div>
                                        <div class="text-slate-400 font-bold">${item.title}</div>
                                        <div class="text-white truncate w-32 ${item.result.includes('í™•ì¸í•„ìš”') ? 'text-yellow-300' : ''}">${item.result}</div>
                                    </div>
                                </div>
                                ${item.link ? `<a href="${item.link}" target="_blank" class="bg-slate-600 px-1.5 py-0.5 rounded transition hover:bg-slate-500">í™•ì¸</a>` : ''}
                            </div>
                        `).join('');
                    }
                }
            } catch(e) {
                console.error(e);
                loading.innerHTML = `<p class="text-red-400 text-xs">ë¶„ì„ ì‹¤íŒ¨</p>`;
            }
        };

        // --- Utils & UI Handlers ---
        window.toggleTarget = function() {
            const els = document.getElementsByName('scanTarget');
            els.forEach(e => { if(e.checked) scanTarget = e.value; });
            window.clearResults();
            window.showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === 'land' ? 'í† ì§€' : 'ì§€ë¶•'}`);
        };

        window.clearResults = function() {
            if(panelGroup) panelGroup.clearLayers();
            if(selectableGroup) selectableGroup.clearLayers();
            if(analysisMarkerGroup) analysisMarkerGroup.clearLayers();
            selectedFeatures.clear();
            accumulatedPanelsCount = 0;
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('legalContent').classList.add('hidden');
            document.getElementById('aiScorePanel').classList.add('hidden');
            document.getElementById('legalPlaceholder').classList.remove('hidden');
            window.currentAnalysisData = {};
        };

        // D-Pad
        window.resetCalibration = function() {
            currentGeoState = {x:0, y:0, rot:0};
            window.drawPanels(currentAnalysisFeature.geometry);
            reCalcTotal();
        };

        window.applyCalibration = function(dx, dy, drot=0) {
            currentGeoState.x += dx; currentGeoState.y += dy; currentGeoState.rot += drot;
            window.drawPanels(currentAnalysisFeature.geometry);
            reCalcTotal();
        };

        window.toggleMultiSelect = function() { isMultiSelectMode = document.getElementById('multiSelectToggle').checked; window.clearResults(); };
        window.toggleAutoScan = function() { autoScanMode = document.getElementById('autoScanToggle').checked; };
        
        window.switchTab = function(m) {
            ['scan','analysis','legal','history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`panel-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${m}`).classList.add('active');
            document.getElementById(`panel-${m}`).classList.remove('hidden');
        };

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('sidebar-toggle-btn').classList.toggle('collapsed');
        };

        // ------------------------------
// [F-11~F-12] ì „ìˆ˜ìŠ¤ìº” ì§€ì—­/ì‹œê°„/íƒ€ì´ë¨¸
// ------------------------------
const REGION_PLANS = {
    // stepsëŠ” "ì¡°íšŒ íšŸìˆ˜" ê¸°ì¤€ (API call ìˆ˜). ì‹¤ì œ ëŒ€ìƒ ì§€ì—­/ê²©ì í•´ìƒë„ í™•ì •ë˜ë©´ ì¡°ì •.
    "ansan_ind":     { name:"ì•ˆì‚° ë°˜ì›”/ì‹œí™”", steps: 120 },
    "incheon_ind":   { name:"ì¸ì²œ ë‚¨ë™ê³µë‹¨", steps: 120 },
    "hwaseong_ind":  { name:"í™”ì„± ì¼ë°˜ì‚°ë‹¨", steps: 140 },
    "pyeongtaek_ind":{ name:"í‰íƒ í¬ìŠ¹ê³µë‹¨", steps: 140 },
    "cheonan_ind":   { name:"ì²œì•ˆ ì¼ë°˜ì‚°ë‹¨", steps: 140 },
    "osan_ind":      { name:"ì˜¤ì°½ ê³¼í•™ì‚°ë‹¨", steps: 140 },
    "daejeon_ind":   { name:"ëŒ€ì „ ëŒ€ë•", steps: 140 },
    "gumi_ind":      { name:"êµ¬ë¯¸ êµ­ê°€ì‚°ë‹¨", steps: 160 },
    "changwon_ind":  { name:"ì°½ì› êµ­ê°€ì‚°ë‹¨", steps: 160 },
    "ulsan_ind":     { name:"ìš¸ì‚° ë¯¸í¬/ì˜¨ì‚°", steps: 160 },
    "daegu_ind":     { name:"ëŒ€êµ¬ ì„±ì„œ", steps: 160 },
    "pohang_ind":    { name:"í¬í•­ ì² ê°•", steps: 160 },
    // ê´‘ì—­ ì§€ìì²´ëŠ” í˜¸ì¶œ ìˆ˜ê°€ ë§ì•„ ë³´ìˆ˜ì ìœ¼ë¡œ ì„¤ì •
    "seoul":         { name:"ì„œìš¸", steps: 260 },
    "gyeonggi":      { name:"ê²½ê¸°", steps: 420 },
    "jeonnam":       { name:"ì „ë‚¨", steps: 360 },
    "jeonbuk":       { name:"ì „ë¶", steps: 320 },
    "gyeongnam":     { name:"ê²½ë‚¨", steps: 360 },
    "jeju":          { name:"ì œì£¼", steps: 240 },
};

let _selectedRegionKey = "";
let _missionTotalSteps = 20;
let _missionDoneSteps = 0;
let _missionDelayMs = 6000;
let _timerInterval = null;
let _remainingMs = 0;
let _pauseStartedAt = null;

function _fmt(ms){
    ms = Math.max(0, Math.floor(ms));
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
}

function _setTimerTextTotal(){
    const el = document.getElementById('timerRemaining');
    if(!el) return;
    el.innerText = _remainingMs > 0 ? _fmt(_remainingMs) : _fmt(_missionTotalSteps * _missionDelayMs);
}

function _stopTimer(){
    if(_timerInterval){ clearInterval(_timerInterval); _timerInterval = null; }
}

function _startTimer(){
    _stopTimer();
    const el = document.getElementById('timerRemaining');
    const startAt = Date.now();
    const baseRemaining = _remainingMs;
    _timerInterval = setInterval(()=>{
        if(!missionRunning){ _stopTimer(); return; }
        if(missionPaused) return;
        const passed = Date.now() - startAt;
        const left = Math.max(0, baseRemaining - passed);
        if(el) el.innerText = _fmt(left);
        if(left <= 0){ _stopTimer(); }
    }, 250);
}

window.setRegion = function(){
    const sel = document.getElementById('regionSelect');
    _selectedRegionKey = sel ? (sel.value || "") : "";
    window.updateEstimatedTime();
};

window.updateEstimatedTime = function() {
    _missionDelayMs = parseInt(document.getElementById('scanDelay')?.value || "6000");
    const plan = REGION_PLANS[_selectedRegionKey];
    _missionTotalSteps = plan ? plan.steps : 20; // region ë¯¸ì„ íƒ ì‹œ í˜„ì¬ í™”ë©´ ê¸°ì¤€ 20íšŒ(ê¸°ë³¸)
    // ì´ ì˜ˆìƒì‹œê°„ í‘œì‹œ(ì¹´ìš´íŠ¸ë‹¤ìš´ ì „)
    _remainingMs = _missionTotalSteps * _missionDelayMs;
    _setTimerTextTotal();
    const pc = document.getElementById('progressCount');
    if(pc) pc.innerText = `0 / ${_missionTotalSteps}`;
    const bar = document.getElementById('totalProgressBar');
    if(bar) bar.style.width = "0%";
};

// [F-11, F-12] Scan Mission
window.startMission = async function() {
    if(!map) return;

    // í† ê¸€: ì‹¤í–‰ ì¤‘ì´ë©´ ì¼ì‹œì •ì§€/ì¬ê°œ
    if(missionRunning) {
        missionPaused = !missionPaused;
        const btn = document.getElementById('startBtn');
        if(btn) btn.innerText = missionPaused ? "â–¶ ì¬ê°œ" : "â¸ ì¼ì‹œì •ì§€";
        if(missionPaused){
            _pauseStartedAt = Date.now();
            // ë‚¨ì€ì‹œê°„ ê³ ì •
        } else {
            // ì¬ê°œ: ë‚¨ì€ì‹œê°„ì—ì„œ pause duration ì œì™¸í•˜ê³  íƒ€ì´ë¨¸ ì¬ì‹œì‘
            if(_pauseStartedAt){
                const pausedFor = Date.now() - _pauseStartedAt;
                _remainingMs = Math.max(0, _remainingMs - pausedFor);
                _pauseStartedAt = null;
            }
            _startTimer();
        }
        return;
    }

    // ì‹œì‘
    stopScan = false;
    missionPaused = false;
    missionRunning = true;
    _missionDoneSteps = 0;

    window.updateEstimatedTime(); // region/ë”œë ˆì´ ë°˜ì˜
    const btn = document.getElementById('startBtn');
    if(btn) btn.innerText = "â¸ ì¼ì‹œì •ì§€";

    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    _startTimer();

    // ìŠ¤ìº” ëŒ€ìƒ: regionì´ë“  ì•„ë‹ˆë“  "í˜„ì¬ ì§€ë„ bounds"ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë¦¬ë“œë¡œ ìƒ˜í”Œë§
    const bounds = map.getBounds();
    const autoFollow = document.getElementById('autoFollow')?.checked;

    for(let i=0; i<_missionTotalSteps; i++) {
        if(stopScan) break;

        while(missionPaused) {
            await new Promise(r=>setTimeout(r, 200));
            if(stopScan) break;
        }
        if(stopScan) break;

        // bbox ë‚´ë¶€ì—ì„œ ê· ë“± ìƒ˜í”Œ(ë¬´ì‘ìœ„ ëŒ€ì‹  ì¼ì •í•œ ë¶„í¬ë¡œ)
        const t = (_missionTotalSteps <= 1) ? 0 : (i / (_missionTotalSteps-1));
        const lat = bounds.getSouth() + (bounds.getNorth()-bounds.getSouth()) * t;
        const lng = bounds.getWest() + (bounds.getEast()-bounds.getWest()) * ((i*7)%_missionTotalSteps) / _missionTotalSteps;

        if(autoFollow) map.panTo([lat,lng], {animate:false});

        await window.scanBuildings(lat, lng, true);

        _missionDoneSteps = i+1;
        // ì§„í–‰ UI
        const pc = document.getElementById('progressCount');
        if(pc) pc.innerText = `${_missionDoneSteps} / ${_missionTotalSteps}`;
        const bar = document.getElementById('totalProgressBar');
        if(bar) bar.style.width = `${(_missionDoneSteps/_missionTotalSteps)*100}%`;

        // ë‚¨ì€ì‹œê°„ ê°±ì‹ (ë”œë ˆì´ ê¸°ë°˜ìœ¼ë¡œ ë³´ìˆ˜ì  í‘œì‹œ)
        _remainingMs = Math.max(0, (_missionTotalSteps - _missionDoneSteps) * _missionDelayMs);

        await new Promise(r => setTimeout(r, _missionDelayMs));
    }

    // ì¢…ë£Œ
    missionRunning = false;
    missionPaused = false;
    _stopTimer();
    if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";
    if(stopScan) window.showToast("ìŠ¤ìº”ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    else window.showToast("ìŠ¤ìº” ì™„ë£Œ");
    stopScan = false;
};

window.cancelMission = function(keep) {
    stopScan = true;
    missionPaused = false;
    missionRunning = false;
    _stopTimer();
    _remainingMs = 0;
    if(!keep) window.clearResults();
    const btn = document.getElementById('startBtn');
    if(btn) btn.innerText = "â–¶ ìŠ¤ìº” ì‹œì‘";
    window.updateEstimatedTime();
};

        window.downloadScanResults = function() {
            if(!selectableGroup) return;
            const geojson = selectableGroup.toGeoJSON();
            const blob = new Blob([JSON.stringify(geojson)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "scan_results.geojson";
            a.click();
        };

        // [F-20] Full Report
        window.openFullReport = function() {
            const f = document.getElementById('reportForm');
            f.action = `${BACKEND_URL}/report`;
            document.getElementById('form_address').value = currentAnalysisData.address;
            document.getElementById('form_finance').value = JSON.stringify(currentAnalysisData.finance);
            document.getElementById('form_ai').value = JSON.stringify(currentAnalysisData.ai_analysis);
            f.submit();
        };

        // [F-14] Auto Scan Box
        function _updateAutoScanBox() {
            if(!map || !autoScanMode) {
                if(_autoScanBox) { map.removeLayer(_autoScanBox); _autoScanBox=null; }
                return;
            }
            const c = map.getCenter();
            const b = map.getBounds();
            // Show a smaller box in center
            const bounds = [[c.lat-0.002, c.lng-0.002], [c.lat+0.002, c.lng+0.002]];
            if(!_autoScanBox) {
                _autoScanBox = L.rectangle(bounds, {color: "#fbbf24", weight:2, fillOpacity:0, dashArray:"5,5"}).addTo(map);
            } else {
                _autoScanBox.setBounds(bounds);
            }
        }
        
        // --- Init ---
        window.onload = function() {
            window.initMap();
        };

    </script>
</body>
</html>
