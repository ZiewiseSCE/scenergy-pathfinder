<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 
    <title>SCEnergy íƒœì–‘ê´‘ Pathfinder</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜€ï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        
        /* ì„¤ì • ëª¨ë‹¬ ë’¤ ì–´ë‘ìš´ ë§‰ì„ ê±°ì˜ ì œê±°í•´ì„œ ì§€ë„ê°€ ë” ì˜ ë³´ì´ë„ë¡ */
        #settingsOverlay > .absolute.inset-0 {
          background-color: rgba(0,0,0,0.02) !important;
          backdrop-filter: blur(4px);
          -webkit-backdrop-filter: blur(4px);
        }

        /* Body ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ì„¤ì •í•´ì„œ ì§€ë„(Leaflet)ê°€ ë’¤ì—ì„œ ë³´ì´ë„ë¡ */
        body.bg-gray-100 {
          background-color: transparent !important;
        }

        #map { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; background: #0b1220; }
        
        /* ëª¨ë‹¬ ì•ˆì—ì„œ ì‚¬ì´ë“œë°”ë¥¼ ì •ìƒ ë¸”ë¡ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•œ override */
        #settingsOverlay #sidebar {
          position: relative;
          top: auto; left: auto; right: auto; bottom: auto;
          height: auto; max-height: none; width: 100%;
        }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #06b6d4; color: #06b6d4; font-weight: bold; background-color: rgba(15, 23, 42, 0.05); }
        
        /* ìŠ¤í”¼ë„ˆ */
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #06b6d4; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.8); }

        /* í•˜ë‹¨ ìƒíƒœ íŒ¨ë„ ì• ë‹ˆë©”ì´ì…˜ */
        #bottomStatusInner {
          transform: translateY(calc(100% - 32px));
          transition: transform 0.3s ease-out;
        }
        #bottomStatusInner.open {
          transform: translateY(0);
        }

        /* === Crystal Glass UI Styles === */
        /* ë©”ì¸ íŒ¨ë„ (ìœ ë¦¬ íš¨ê³¼) */
        .glass-main-panel {
          position: relative;
          background:
            radial-gradient(circle at 0% 0%, rgba(56,189,248,0.02), transparent 70%),
            radial-gradient(circle at 100% 100%, rgba(129,140,248,0.02), transparent 65%),
            linear-gradient(135deg, rgba(15,23,42,0.08), rgba(15,23,42,0.03));
          backdrop-filter: blur(22px) saturate(160%);
          -webkit-backdrop-filter: blur(22px) saturate(160%);
          border-radius: 1.2rem;
          border: 1px solid rgba(148,163,184,0.55);
          box-shadow: 0 18px 45px rgba(15,23,42,0.78), 0 0 0 1px rgba(15,23,42,0.72);
          overflow: hidden;
          color: #e9f2ff;
        }

        /* í—¤ë” (ìœ ë¦¬ íš¨ê³¼) */
        .glass-header {
          background:
            radial-gradient(circle at 0% 0%, rgba(56,189,248,0.35), transparent 55%),
            radial-gradient(circle at 100% 100%, rgba(236,72,153,0.32), transparent 55%),
            linear-gradient(135deg, rgba(15,23,42,0.45), rgba(15,23,42,0.08));
          backdrop-filter: blur(26px) saturate(160%);
          -webkit-backdrop-filter: blur(26px) saturate(160%);
          border-bottom: 1px solid rgba(148,163,184,0.80);
        }

        /* íƒ­ (ìœ ë¦¬ íš¨ê³¼) */
        .glass-tabs {
          background: linear-gradient(90deg, rgba(56,189,248,0.22), rgba(129,140,248,0.45), rgba(15,23,42,0.75));
          backdrop-filter: blur(18px);
          border-bottom: 1px solid rgba(148,163,184,0.65);
        }

        /* ë‚´ë¶€ ìš”ì†Œ ìœ ë¦¬ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
        .glass-main-panel .bg-white, .glass-main-panel .bg-slate-50, .glass-main-panel .bg-gray-50 {
          background-color: rgba(15,23,42,0.03) !important;
          color: #e9f2ff !important;
        }
        .glass-main-panel input, .glass-main-panel select {
          background-color: rgba(15,23,42,0.78) !important;
          border-color: rgba(148,163,184,0.75) !important;
          color: #e5f0ff !important;
        }
        .glass-main-panel label, .glass-main-panel .text-slate-700, .glass-main-panel .text-gray-700 {
          color: #e5edff !important;
        }

        /* 8ëŒ€ ì²´í¬ ìƒíƒœ ì»¬ëŸ¬ (ì¶”ê°€ë¨) */
        .checkRow { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; }
        .checkRow.pass .checkValue { color: #4ade80; font-weight: bold; }
        .checkRow.warn .checkValue { color: #facc15; font-weight: bold; }
        .checkRow.fail .checkValue { color: #f87171; font-weight: bold; }
        .checkTitle { color: #cbd5e1; font-weight: 600; width: 80px; }
        .checkValue { flex: 1; text-align: right; margin-right: 8px; }
        .checkMsg { display: none; } /* ê³µê°„ ì ˆì•½ ìœ„í•´ ë©”ì‹œì§€ëŠ” ìˆ¨ê¹€ */

        /* D-Pad Style */
        .d-pad-btn { width: 36px; height: 36px; background: #334155; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; box-shadow: 0 2px 0 #0f172a; }
        .d-pad-btn:active { transform: translateY(2px); box-shadow: none; }
        .crystal-dpad { background-color: rgba(15,23,42,0.6); backdrop-filter: blur(6px); border: 1px solid rgba(148,163,184,0.3); border-radius: 12px; }
    </style>
</head>
<body class="bg-gray-100">

    <form id="reportForm" method="POST" target="_blank" class="hidden">
        <input type="hidden" name="address" id="form_address">
        <input type="hidden" name="capacity" id="form_capacity">
        <input type="hidden" name="kepco_capacity" id="form_kepco">
        <input type="hidden" name="date" id="form_date">
        <input type="hidden" name="finance" id="form_finance">
        <input type="hidden" name="ai_analysis" id="form_ai">
        <input type="hidden" name="mode" id="form_mode">
        <input type="hidden" name="lat" id="form_lat">
        <input type="hidden" name="lng" id="form_lng">
        <input type="hidden" name="pnu" id="form_pnu">
        <input type="hidden" name="ai_score" id="form_score">
        <input type="hidden" name="solar_opt" id="form_solar">
        <input type="hidden" name="land_estimate" id="form_land">
        <input type="hidden" name="land_price" id="form_price">
    </form>

    <div id="settingsOverlay" class="fixed inset-0 z-[1900] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/10 backdrop-blur-sm" onclick="window.closeSettingsModal()"></div>
        <div class="relative w-[96%] max-w-5xl max-h-[90vh] flex flex-col items-stretch overflow-y-auto pt-4 pb-4">
            <div id="sidebar" class="sidebar absolute top-0 left-0 h-full w-[420px] bg-white shadow-2xl flex flex-col border-r border-gray-200 glass-main-panel">
                <div class="p-4 bg-slate-900 text-white shadow-lg shrink-0 glass-header">
                    <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-solar-panel text-yellow-400"></i> SCEnergy íƒœì–‘ê´‘ Pathfinder</h1>
                </div>
                <div class="flex border-b border-gray-200 shrink-0 bg-white shadow-sm glass-tabs">
                    <button type="button" onclick="window.switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-3 text-xs text-center"><i class="ph ph-radar text-lg"></i>ì „ìˆ˜ ìŠ¤ìº”</button>
                    <button type="button" onclick="window.switchTab('analysis')" id="tab-analysis" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-magnifying-glass-plus text-lg"></i>ì •ë°€ ë¶„ì„</button>
                    <button type="button" onclick="window.switchTab('legal')" id="tab-legal" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-sparkle text-lg"></i>ì¢…í•© ë¦¬í¬íŠ¸</button>
                    <button type="button" onclick="window.switchTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-xs text-center"><i class="ph ph-clock-counter-clockwise text-lg"></i>ê¸°ë¡</button>
                </div>

                <div class="flex-1 overflow-y-auto bg-slate-50 glass-scroll p-4">
                    <details class="bg-white rounded-lg border border-slate-200 shadow-sm group mb-4 crystal-accordion">
                        <summary class="p-3 text-xs font-bold text-slate-800 cursor-pointer flex items-center justify-between hover:bg-slate-50 bg-slate-100 rounded-t-lg">
                            <span class="flex items-center gap-1"><i class="ph ph-sliders-horizontal"></i> ë¶„ì„ íŒŒë¼ë¯¸í„°</span><i class="ph ph-caret-down group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="p-3 space-y-3 border-t border-white text-xs param-body">
                            <div class="bg-white/60 p-2 rounded border border-slate-200">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆ ì„ íƒ</label>
                                        <select id="moduleSelect" class="w-full border p-1 rounded"></select>
                                        <div class="text-[10px] text-slate-400 mt-1" id="moduleMeta"></div>
                                    </div>
                                    <div>
                                        <label class="block mb-0.5 text-[10px] font-bold">ì¸ë²„í„° ì„ íƒ</label>
                                        <select id="inverterSelect" class="w-full border p-1 rounded"></select>
                                        <div class="text-[10px] text-slate-400 mt-1" id="inverterMeta"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆ ê°€ë¡œ(m)</label><input type="number" id="modWidth" value="1.13" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆ ì„¸ë¡œ(m)</label><input type="number" id="modHeight" value="2.4" step="0.01" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ì„¤ì¹˜ ê°ë„(Â°)</label><input type="number" id="installAngle" value="20" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px] text-red-400 font-bold">ì´ê²©ê±°ë¦¬(m)</label><input type="number" id="setbackDist" value="0.0" step="0.5" class="w-full border p-1 rounded text-center text-red-300 font-bold" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="mt-2">
                                    <label class="block mb-0.5 text-[10px] font-bold">íŒ¨ë„ ê°„ê²©(Row, m)</label><input type="number" id="rowSpacing" value="1.2" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()">
                                </div>
                                <input type="hidden" id="modPower" value="640"> </div>
                            <div class="bg-green-50 p-2 rounded border border-green-200">
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px] font-bold">ëª¨ë“ˆë‹¨ê°€(ì›/W)</label><input type="number" id="modPrice" value="350" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px]">ì‹œê³µë¹„(ë§Œ/kW)</label><input type="number" id="costPerKw" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div><label class="block mb-0.5 text-[10px]">SMP</label><input type="number" id="smp" value="140" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px]">REC</label><input type="number" id="rec" value="70" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 border-t border-green-200 pt-2">
                                    <div><label class="block mb-0.5 text-[10px] text-blue-400 font-bold">PF ëŒ€ì¶œ(%)</label><input type="number" id="pfLoanRatio" value="90" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                    <div><label class="block mb-0.5 text-[10px] text-red-400 font-bold">PF ê¸ˆë¦¬(%)</label><input type="number" id="pfInterestRate" value="5.5" step="0.1" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()"></div>
                                </div>
                                <div class="pt-2">
                                    <label class="block mb-0.5 text-[10px] font-bold">PF ì›ê¸ˆ(ì›) (0=ìë™)</label>
                                    <input type="number" id="pfPrincipal" value="0" step="1000000" class="w-full border p-1 rounded text-center" onchange="window.reCalculate()">
                                    <input type="checkbox" id="pfAutoPrincipal" checked class="hidden">
                                </div>
                            </div>
                        </div>
                    </details>

                    <div id="panel-scan" class="space-y-4">
                        <div class="bg-slate-800 p-4 rounded-lg text-white space-y-3 relative overflow-hidden shadow-xl border-b-4 border-cyan-500 scan-panel-crystal">
                            <h3 class="text-xs font-bold text-cyan-300">ì§€ì—­ ìë™ ìŠ¤ìº”</h3>
                            <div class="flex justify-between items-end">
                                <div id="timerRemaining" class="text-xl font-mono font-bold text-yellow-400 scan-timer">00:00:00</div>
                                <div class="text-right">
                                    <div id="progressCount" class="text-[10px] text-gray-300 font-mono">0 / 20</div>
                                </div>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden scan-progress-outer">
                                <div id="totalProgressBar" class="bg-cyan-500 h-full transition-all duration-500 scan-progress-inner" style="width: 0%"></div>
                            </div>
                            <div class="text-[9px] text-cyan-400 font-bold" id="foundCount">ê²€ìƒ‰ëœ êµ¬ì—­: 0ê°œ</div>
                            <div class="flex items-center gap-2 mb-2 mt-2">
                                 <input type="checkbox" id="autoFollow" class="w-4 h-4 rounded border-gray-600 bg-gray-700" checked>
                                 <label for="autoFollow" class="text-[10px] text-slate-300 cursor-pointer">ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°</label>
                            </div>
                            <div class="grid grid-cols-2 gap-2 pt-1">
                                <button type="button" onclick="window.startMission()" id="startBtn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold text-xs transition">â–¶ ìŠ¤ìº” ì‹œì‘</button>
                                <button type="button" onclick="window.cancelMission(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded font-bold text-xs transition">ğŸ”„ ë¦¬ì…‹</button>
                            </div>
                        </div>
                    </div>

                    <div id="panel-analysis" class="hidden space-y-4">
                        <div id="resultCard" class="hidden result-card p-4 rounded-lg shadow-lg text-white space-y-3">
                            <h3 class="text-sm font-bold flex items-center gap-1 border-b border-slate-700 pb-2">ğŸ“Š í†µí•© ë¶„ì„ ê²°ê³¼</h3>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between"><span class="text-slate-400">ì£¼ì†Œ:</span><span id="analysisAddress" class="text-right truncate w-40">-</span></div>
                                <div class="flex justify-between"><span class="text-slate-400">ìˆ˜ëŸ‰:</span><span id="analysisCount">0 ì¥</span></div>
                                <div class="flex justify-between"><span class="text-slate-400">ìš©ëŸ‰(AC/DC):</span><span id="analysisCapacity" class="text-cyan-400 font-bold">0 kW</span></div>
                                <div class="flex justify-between items-center border-t border-slate-700 pt-2"><span class="text-slate-400">âš¡ í•œì „ ì„ ë¡œìš©ëŸ‰:</span><span id="kepcoCapacity" class="font-bold text-yellow-400 font-mono">í™•ì¸ í•„ìš”</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400">â˜€ï¸ ì¼ì‚¬ëŸ‰/ê°ë„:</span><span id="solarOpt" class="font-bold text-yellow-300 font-mono">í™•ì¸ í•„ìš”</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-400">ğŸï¸ í† ì§€ê°€ê²©:</span><span id="landPrice" class="font-bold text-amber-300 font-mono">í™•ì¸ í•„ìš”</span></div>
                            </div>
                            <div class="bg-slate-700/50 p-2 rounded space-y-1 mt-2 border border-slate-600 text-xs">
                                <div class="flex justify-between"><span>ğŸ’¸ ì´ ì‚¬ì—…ë¹„:</span><span id="resTotalCost" class="text-green-400 font-bold">0 ì›</span></div>
                                <div class="flex justify-between"><span>ğŸ’° ì—° ì´ìˆ˜ìµ:</span><span id="resAnnualRev" class="text-yellow-400 font-bold">0 ì›</span></div>
                            </div>
                            <div class="bg-indigo-900/40 p-2 rounded border border-indigo-500/30 text-[10px] space-y-1">
                                <div class="flex justify-between"><span class="text-indigo-200">ğŸ¦ ì›” ìƒí™˜ì•¡:</span><span id="resMonthlyDebt" class="text-white font-bold">0 ì›</span></div>
                                <div class="flex justify-between"><span class="text-indigo-200">ğŸ’³ ì´ ì´ìë¹„ìš©:</span><span id="resTotalInterest" class="text-white font-bold">0 ì›</span></div>
                                <div class="flex justify-between items-center mt-2"><span class="text-slate-200">DSCR(1ë…„ì°¨):</span><span id="resDscr" class="text-white font-semibold">-</span></div>
                                <div class="flex justify-between pt-1 border-t border-indigo-500/30 mt-1"><span class="text-indigo-200 font-bold">ğŸš€ ìë³¸íšŒìˆ˜ê¸°ê°„:</span><span id="resPfPayback" class="text-cyan-300 font-bold text-xs">0.0 ë…„</span></div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                 <button type="button" onclick="window.saveResult()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded text-xs font-bold border border-slate-600 transition">ì €ì¥</button>
                                 <button type="button" onclick="window.openFullReport()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-xs font-bold border border-blue-500 transition">ìƒì„¸ ë¦¬í¬íŠ¸</button>
                            </div>
                        </div>
                    </div>

                    <div id="panel-legal" class="hidden space-y-4">
                        <div class="bg-slate-800 p-4 rounded-lg shadow-lg text-white min-h-[300px]">
                            <h3 class="text-sm font-bold border-b border-slate-700 pb-2 flex items-center gap-2"><i class="ph ph-files"></i> 8ëŒ€ ì¤‘ëŒ€ ì²´í¬ì‚¬í•­</h3>
                            
                            <div id="aiScorePanel" class="hidden mb-4 bg-transparent p-3 rounded border border-slate-600 mt-2">
                                 <div class="flex items-center justify-between mb-2">
                                     <span class="text-xs text-slate-300 font-bold">êµ¬ë§¤ë§¤ë ¥ë„ (AI Score)</span>
                                     <span id="scoreValue" class="text-lg font-bold text-green-400">0ì </span>
                                 </div>
                                 <div class="w-full bg-slate-700 rounded-full h-2.5 mb-2 overflow-hidden">
                                     <div id="scoreBar" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                 </div>
                                 <p class="text-[9px] text-slate-400 text-right" id="confidenceValue"></p>
                            </div>

                            <div id="legalPlaceholder" class="text-center py-10 text-slate-400 text-xs">
                                <i class="ph ph-brain text-2xl mb-2 text-purple-300"></i><br>ê±´ë¬¼/í† ì§€ë¥¼ ì„ íƒí•˜ë©´<br>ìë™ìœ¼ë¡œ 8ëŒ€ í•­ëª©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                            </div>
                            <div id="legalLoading" class="hidden text-center py-10">
                                <div class="spinner mx-auto mb-2 !border-t-purple-500"></div>
                                <p class="text-xs text-purple-300 animate-pulse">ìƒì„¸ ê·œì œ ë°ì´í„° ë¶„ì„ ì¤‘...</p>
                            </div>
                            <div id="aiChecksContainer" class="grid grid-cols-1 gap-2 mt-2"></div>
                            
                            <div id="legalContent" class="hidden space-y-2 mt-2">
                                 <div id="aiAnalysisResult" class="grid grid-cols-1 gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-history" class="hidden space-y-4">
                        <div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-2 border-b pb-1">
                                <h3 class="text-xs font-bold text-gray-700">ğŸ“‚ ë¶„ì„ ê¸°ë¡</h3>
                                <div class="flex gap-2">
                                    <button type="button" onclick="window.downloadCSV()" class="text-[10px] text-blue-600 font-bold flex items-center gap-1"><i class="ph ph-file-csv"></i> CSV ë‹¤ìš´</button>
                                    <button type="button" onclick="window.clearHistory()" class="text-[10px] text-red-500 hover:underline">ì‚­ì œ</button>
                                </div>
                            </div>
                            <div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header class="absolute top-0 left-0 right-0 z-[1500] flex items-center justify-between px-4 py-3 pointer-events-none">
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="flex items-center gap-2 bg-transparent px-3 py-2 rounded-xl shadow-lg border border-slate-700/60 title-gradient">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHoAAABMCAYAAACieqNUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAHYcAAB2HAY/l8WUAABrdSURBVHhe7Z13eFRV3sc/996pmcxMyqRjEqrSpInrqyAICCgClhWFVdfu7stjWcur2BtWdPVdy4Kiomt5VRRRwKU3Iy10pCQQCCmTnkxmMn3O+0eSMTPJJCSAu0vyeZ7zPOT8zr0zc7/3nPP7/c65F6na7RF0ccYjh1d0cWbSJXQnoUvoTkKX0J2ELqE7CV1CdxK6hO4kdAndSegSupMg/aszY8LvR/h8SH5//b/9fgIeNwFHHcLrRVKpkKMNyBotkqKAooBKhaxWgySFn66LCPzmQgshEHV1+Kqq8FdW4jp4ANeePbgO7sd95AjewkL8NhsEAsFjJFlGNpnQpKejO/ts9APPRT9sGJqzMlBZLChmc5fobfCbCS38fnxlZbgP7sexdSuOrCwcm37GX10d3vSEkFQqtP36YRozluiRF6MbMBB1amp9r++iGadfaCHwlZVSu3YttatXYl+/Hu/x4wi/P7xlh5AkCZXFgnHcOEyXTSJ69GhUloTwZp2e0yu0ENSuXknlJ59gz8rCW1gA4jR9nCyjSeuG6bKJxP/xVnQDByKpVOGtOi2nTeiAzUbJa3Oo/nYhnry8U9aD20KOikI/YCBJsx4leszYeqeti9MjtDc/n+P33I1943oCdXXh5tOOJMuoEpNIm/M6MVdfHW7ulJxyoZ3791Nw5+04tmef8DAtG43oBgzEMGQwuoGD0PXogWyOASEIVFfiyj2Mc9dOnLt24Tywn0BtbfgpWkRSFDK/+gbzxInhpk7HqRM6EMC5ezeFDz+EfeOGVkWW1GrUcfHoBg8h5tprMU+egmI0hjdrEW+JleqFX1P95Zc49//SpuiyXk+PbxZhGHkxktx580OnRGgRCOA+dIiip57AtuSHkBg4BFlGnZxM9IgRxN9+J9EXjehw/BuoraX8vblUfvYZ7oMHWvUBdP36k/nRx+gGDAip9/v9+LzekDoaPHlFpUI5g0K1UyK0x2ql9JWXqPzoQwIuV7gZAEmjIWroMOJvvgXzlKkoMTHhTTqEfdPPlL7yCrWrViBaEA1A1mqJuepqUl5+BXVCYrC+1FpMXm4uPq8vpL1Or6N77z7ExceH1P8nc9JjmXA6sf3wPdVffRVRZFmnwzR2HKnPzSZ2+oxTJjJA9O8uIPX52ZivmFyfHm2BgNtN7Zo12BYvrh9tGkac8tJSdm7bypHcg1RVVQSLzWbD5/WEn+Y/GuWRJ554OryyPbhzcyl69GE8+fnhJmjIYEVfPIrU519AP3ToqY9tJQklLg5tRiaevDw8R/PCWwAQcNaB10fUsGH4KytRWSyUlZSQn5dH9969uWDExWR070FG9x6knZWOyWTG4XBQmJ+PrMgUHD1GzoH9BPx+DEYjsizj9Xg4evgw+/fsxlZdg9FkQq1W47DbKcjPp85RS+7Bg3jcbswxsVRWVLB/zy4qyyvw+XwUHT+OolJRVlJMXm4O8ZYEFEXBYbeTl5ODz+clyhCN1MHprSknJbTw+Sh9+UVql/8zovOl692H9HfnouvX77Q5Q/XhVCKSXo9zx/aW06pC4K+uQp2RjvtoHoahwygrLSU/Lw99VBT6KAN1Dgd1DgcABoMBa1ERP69fS86B/ZRaiykuLKCooACDwYA5JobNGzeyc9sWHHY7+XlHKCspoVtGBuWlJWzeuJ6Dv/xC0fEC9Ho9RrOZpd8upLiwkOrKSg4fOkBebi6x8RYqy8vI3rQJS1IyMbGx5B89yqb1a7EkJmFJTDwlQp/Ulffk5VH+wXxEBOdLUhTSXp2Drm/fDjtdJ4qkVmOeMBHz5ZMjjhq+qioc69fhWL8O97Fjwfqjubks/2GXw" alt="SC Energy Solution" class="h-7 w-auto rounded-sm shadow-sm" />
                <div class="leading-tight">
                    <div class="text-sm md:text-base font-bold text-slate-50 tracking-tight">SCEnergy íƒœì–‘ê´‘ Pathfinder</div>
                    <div class="text-[10px] md:text-[11px] text-slate-300">ì£¼ì†Œë¥¼ ì„ íƒí•˜ê³  íŒ¨ë„ì„ ë°°ì¹˜í•´ ë³´ì„¸ìš”.</div>
                </div>
            </div>
            <button type="button" onclick="window.openSettingsModal()" class="inline-flex items-center gap-2 rounded-full bg-slate-900/90 text-slate-50 text-xs md:text-sm px-3 py-2 shadow-lg border border-cyan-500/60 hover:bg-slate-800">
                <i class="ph ph-gear-six text-base md:text-lg text-cyan-300"></i><span class="font-semibold">ìƒì„¸ ì„¤ì •</span>
            </button>
        </div>

        <div class="pointer-events-auto flex-1 flex justify-center">
            <div class="inline-flex items-center gap-1 bg-slate-900/90 border border-slate-700/80 rounded-full px-1 py-1 shadow-lg">
                <button type="button" id="btnModeLand" onclick="window.setScanTargetMode('land')" class="px-3 py-1 text-[11px] md:text-xs rounded-full font-semibold flex items-center gap-1 bg-amber-500/10 text-amber-300 border border-transparent hover:bg-amber-400/20">
                    <i class="ph ph-tree"></i><span>í† ì§€</span>
                </button>
                <button type="button" id="btnModeRoof" onclick="window.setScanTargetMode('building')" class="px-3 py-1 text-[11px] md:text-xs rounded-full font-semibold flex items-center gap-1 text-slate-200 bg-slate-800/60 hover:bg-slate-700/80 border border-slate-600/60">
                    <i class="ph ph-building"></i><span>ì§€ë¶•</span>
                </button>
            </div>
        </div>

        <div class="pointer-events-auto flex items-center gap-3">
            <div class="bg-white/95 rounded-xl shadow-lg border border-slate-200 flex items-center px-2 py-1 w-[220px] md:w-[260px]">
                <input type="text" id="addrInput" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ëŒ€ë¡œ 123)" class="flex-1 text-xs md:text-sm px-2 py-1 outline-none bg-transparent text-slate-700 font-medium" onkeypress="if(event.key==='Enter') window.searchAddress()">
                <button type="button" onclick="window.searchAddress()" class="px-2 py-1 rounded-lg bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800" aria-label="ì£¼ì†Œ ê²€ìƒ‰" title="ì£¼ì†Œ ê²€ìƒ‰">
                    <i class="ph ph-magnifying-glass font-bold"></i>
                </button>
            </div>
            <div class="relative">
                <button type="button" onclick="window.toggleLayerMenu(event)" class="h-10 w-10 rounded-full bg-slate-900/95 text-slate-100 flex items-center justify-center shadow-lg border border-slate-700 hover:bg-slate-800">
                    <i class="ph ph-stack text-xl"></i>
                </button>
                <div id="layerMenuPanel" class="hidden absolute right-0 mt-2 z-[1600]">
                    <div class="bg-white p-2 rounded-lg shadow-xl border border-gray-200 text-xs w-56">
                        <div class="font-bold text-slate-600 mb-2 border-b pb-1 flex items-center gap-1"><i class="ph ph-stack"></i> ì§€ë„ ì„¤ì •</div>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 mb-2 bg-indigo-50 rounded text-indigo-700 font-bold border border-indigo-200">
                            <input type="checkbox" id="multiSelectToggle" onchange="window.toggleMultiSelect()"><span class="flex items-center gap-1"><i class="ph ph-plus-circle"></i> ê²°ê³¼ ëˆ„ì  ëª¨ë“œ</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="autoScanToggle" onchange="window.toggleAutoScan()"><span class="flex items-center gap-1"><i class="ph ph-radar"></i> ìë™ ìŠ¤ìº”(ì´ë™ì‹œ)</span>
                        </label>
                        <hr class="my-2 border-gray-200">
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="existingPlantToggle" onchange="window.toggleLayer('existing')" checked><span>ê¸°ì„¤ì¹˜ íƒœì–‘ê´‘(ê°€ìƒ)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="substationToggle" onchange="window.toggleLayer('substation')" checked><span>ë³€ì „ì†Œ/ì„ ë¡œ(ì¤Œ 15~16)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1.5 hover:bg-slate-50 rounded text-slate-600">
                            <input type="checkbox" id="cadastralToggle" onchange="window.toggleLayer('cadastral')" checked><span>ì§€ì ë„ (VWorld)</span>
                        </label>
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="sat" checked onchange="window.setMap('sat')"><span>ğŸ›°ï¸ ìœ„ì„± ì§€ë„</span></label>
                            <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-slate-50 rounded"><input type="radio" name="mapL" value="base" onchange="window.setMap('base')"><span>ğŸ—ºï¸ ì¼ë°˜ ì§€ë„</span></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="bottomStatusPanel" class="absolute left-0 right-0 bottom-0 z-[1450] pointer-events-none">
        <div id="bottomStatusInner" class="max-w-5xl mx-auto pb-2 pointer-events-auto">
            <div class="flex justify-center mb-1">
                <button type="button" onclick="window.toggleBottomStatus()" class="px-3 py-1 rounded-full bg-slate-900/80 border border-slate-600/80 shadow-lg text-[11px] text-slate-200 flex items-center gap-1">
                    <i id="bottomStatusHandleIcon" class="ph ph-caret-up text-xs"></i><span>ìƒíƒœ / ë¡œê·¸</span>
                </button>
            </div>
            <div class="bg-slate-900/95 text-slate-50 border-t border-slate-700 shadow-2xl rounded-t-2xl px-4 pt-2 pb-2 space-y-2">
                <div class="flex justify-between items-center text-[10px] text-slate-300">
                    <span class="font-semibold text-xs">Public Access</span>
                    <div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span><span class="text-[10px] text-emerald-300">System Ready</span></div>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-3 text-center text-[10px]">
                    <div class="bg-slate-900 rounded p-1 border border-slate-700"><div class="text-slate-500">Backend</div><div id="cnt-vworld" class="font-mono font-bold text-cyan-400 text-xs">0</div></div>
                    <div class="bg-slate-900 rounded p-1 border border-slate-700"><div class="text-slate-500">DB Sync (public)</div><div id="cnt-public" class="font-mono font-bold text-yellow-400 text-xs">0</div></div>
                    <div class="bg-slate-900 rounded p-1 border border-slate-700"><div class="text-slate-500">AI Analysis</div><div id="cnt-ai" class="font-mono font-bold text-purple-400 text-xs">0</div></div>
                </div>
                <div class="h-24 bg-slate-900 border-t border-slate-700 mt-2 flex flex-col text-[11px]">
                    <div class="px-3 py-1 flex items-center justify-between text-slate-300">
                        <div class="flex items-center gap-2"><i class="ph ph-activity"></i><span class="font-semibold text-[11px]">System Log</span></div>
                        <button type="button" onclick="window.clearLog && window.clearLog()" class="text-[10px] px-2 py-0.5 rounded bg-slate-800 border border-slate-600 hover:bg-slate-700">Clear</button>
                    </div>
                    <div class="flex-1 overflow-y-auto px-3 pb-2" id="logWindow"><div class="text-green-500">&gt; System Ready.</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastMsg" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[3000] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden items-center gap-2 border border-cyan-500"><i class="ph ph-info text-cyan-400"></i><span class="font-bold text-sm" id="toastText"></span></div>
    <div id="map">
        <div id="zoomIndicator" style="position:absolute; right:64px; bottom:34px; z-index:1200; background:rgba(0,0,0,0.7); color:#fff; padding:4px 10px; border-radius:10px; font-size:12px; pointer-events:none;">ğŸ” Zoom: -</div>
    </div>

    <div id="floatingDpadWrapper" class="absolute right-6 top-1/2 -translate-y-1/2 z-[1400] pointer-events-none">
        <div class="pointer-events-auto">
            <div class="crystal-dpad p-2 mb-2 text-slate-50">
                <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><span class="text-[11px] font-bold text-indigo-300 flex items-center gap-1"><i class="ph ph-crosshair"></i> íŒ¨ë„ ë¯¸ì„¸ì¡°ì • (D-Pad)</span><button type="button" onclick="window.resetCalibration()" class="text-[9px] bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-white border border-slate-600">ì´ˆê¸°í™”</button></div>
                <div class="flex flex-col items-center justify-center gap-2 pt-2 pb-1">
                    <div class="grid grid-cols-3 gap-2">
                        <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('up')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('up')" ontouchend="window.dpadHoldStop()">â–²</button><div></div>
                        <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('left')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('left')" ontouchend="window.dpadHoldStop()">â—€</button>
                        <div class="w-8 h-8 flex items-center justify-center text-[9px] font-mono text-slate-400 border border-slate-600 rounded">Mov</div>
                        <button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('right')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('right')" ontouchend="window.dpadHoldStop()">â–¶</button>
                        <div></div><button type="button" class="d-pad-btn" onmousedown="window.dpadHoldStart('down')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('down')" ontouchend="window.dpadHoldStop()">â–¼</button><div></div>
                    </div>
                    <div class="flex gap-2 w-full px-4 border-t border-slate-700 pt-2 mt-1">
                        <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotL')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotL')" ontouchend="window.dpadHoldStop()">â†º íšŒì „</button>
                        <button type="button" class="d-pad-btn flex-1 text-[10px]" onmousedown="window.dpadHoldStart('rotR')" onmouseup="window.dpadHoldStop()" onmouseleave="window.dpadHoldStop()" ontouchstart="window.dpadHoldStart('rotR')" ontouchend="window.dpadHoldStop()">â†» íšŒì „</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    /* =========================================================
       íƒœì–‘ê´‘ Pathfinder Upgrade (Features 1~5) - JS ONLY
       ========================================================= */
    const VWORLD_TILE_KEY = "2ABF83F5-5D52-322D-B58C-6B6655D1CB0F";

    (function(){
      try{
        const qs = new URLSearchParams(window.location.search || "");
        const b = qs.get("backend");
        if (b) {
          let decoded = b;
          try { decoded = decodeURIComponent(b); } catch(e) {}
          window.BACKEND_URL = decoded.replace(/\/$/, "");
        }
      } catch(e) {}
      if (typeof window.BACKEND_URL !== "string") window.BACKEND_URL = "";
      window.BACKEND_URL = window.BACKEND_URL.replace(/\/$/, "");
    })();
    const BACKEND_URL = window.BACKEND_URL || "";
    const FEATURE_LEVEL = parseInt(new URLSearchParams(location.search).get("feat") || "5", 10);
    window.FEATURE_LEVEL = FEATURE_LEVEL;

    /* === 8ëŒ€ ì²´í¬ì‚¬í•­ í†µí•© ë¡œì§ === */
    async function fetchEightChecks() {
      try {
        if(!window.currentAnalysisData) return;
        const payload = {
          address: currentAnalysisData.address || null,
          lat: currentAnalysisData.lat,
          lng: currentAnalysisData.lng,
          pnu: currentAnalysisData.pnu || null,
          capacity_kw: currentAnalysisData.ac_kw || currentAnalysisData.acKW || null,
          slope_deg: currentAnalysisData.slope_deg || currentAnalysisData.slopeDeg || null,
          sun_hours: currentAnalysisData.sun_hours || currentAnalysisData.sunHours || null,
          dist_road_m: currentAnalysisData.dist_road_m || null,
          dist_residential_m: currentAnalysisData.dist_residential_m || null,
          area_m2: currentAnalysisData.area_m2 || currentAnalysisData.areaM2 || null
        };

        const res = await fetch(`${BACKEND_URL}/api/checks/analyze`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderEightChecks(data);
        if(document.getElementById("aiScore")) document.getElementById("aiScore").innerText = data.total_score;
        if(document.getElementById("aiConfidence")) document.getElementById("aiConfidence").innerText = data.confidence;
      } catch(e) {
        console.error(e);
        const el = document.getElementById("aiChecksContainer");
        if(el) el.innerHTML = `<div style="padding:14px;color:#ffcc66;font-size:11px;">8ëŒ€ ì²´í¬ ë¶„ì„ ì‹¤íŒ¨ (ì¶”ê°€ í™•ì¸ í•„ìš”)</div>`;
      }
    }

    function statusToClass(st){
      if(st==="PASS") return "pass";
      if(st==="FAIL") return "fail";
      return "warn";
    }

    function renderEightChecks(resp){
      const el = document.getElementById("aiChecksContainer");
      if(!el) return;
      const order = [
        ["zoning","ìš©ë„ì§€ì—­"],
        ["ecology","ìƒíƒœìì—°ë„"],
        ["heritage","ë¬¸í™”ì¬ ê·œì œ"],
        ["setback","ì´ê²©ê±°ë¦¬"],
        ["grid","í•œì „ ì—¬ìœ ìš©ëŸ‰"],
        ["slope","ê²½ì‚¬ë„"],
        ["insolation","ì¼ì‚¬ëŸ‰"],
        ["land_price","í† ì§€ê°€ê²©"],
      ];
      const list = resp.check_list || {};
      el.innerHTML = order.map(([k,title])=>{
        const it = list[k] || {status:"WARNING", value:"í™•ì¸ í•„ìš”", msg:""};
        return `
          <div class="checkRow ${statusToClass(it.status)}">
            <div class="checkTitle">${title}</div>
            <div class="checkValue">${escapeHtml(it.value || "")}</div>
            <div class="checkMsg">${escapeHtml(it.msg || "")}</div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* === Click UX: temporary candidate visual === */
    let __tempCandidateLayer = null;
    function drawTemporaryCandidate(lat, lng){
      try{
        if(!window.map) return;
        if(__tempCandidateLayer){
          try{ window.map.removeLayer(__tempCandidateLayer); }catch(e){}
          __tempCandidateLayer = null;
        }
        __tempCandidateLayer = L.circle([lat,lng], { radius: 45, weight: 2, fillOpacity: 0.18 });
        __tempCandidateLayer.addTo(window.map);
      }catch(e){}
    }

    /* === Main Logic continued... === */
    let map, layers, selectableGroup, panelGroup, analysisMarkerGroup, cadastralLayer, existingGroup, substationGroup;
    let scanTarget = "building";
    let autoScanMode = true;
    let isMultiSelectMode = false;
    let currentAnalysisFeature = null;
    let currentAnalysisData = {};
    let selectedFeatures = new Map();
    let calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 };
    let dpadHoldTimer = null;
    let panelDragHandle = null;
    let _dragStartLatLng = null;
    let scanLock = false;
    let missionRunning = false;
    let missionPaused = false;
    let missionStop = false;
    let missionTotalSteps = 20;
    let missionDoneSteps = 0;
    let missionDelayMs = 6000;
    let missionTotalMs = 0;
    let missionRemainingMs = 0;
    let missionLastTick = 0;
    let missionTimerInterval = null;
    let autoScanBox = null;
    let autoScanDebounce = null;

    function el(id){ return document.getElementById(id); }

    window.toggleAutoScan = function(){
      try{
        const cb = document.getElementById('autoScanToggle');
        autoScanMode = !!(cb && cb.checked);
        updateAutoScanBox();
        if(autoScanMode && window.map){
          const c = window.map.getCenter();
          scanBuildings(c.lat, c.lng, true);
        }
      }catch(e){ console.warn('toggleAutoScan failed', e); }
    };

    function getAnalysisLatLng(){
      if(typeof currentAnalysisData.lat === "number" && typeof currentAnalysisData.lng === "number"){
        return {lat: currentAnalysisData.lat, lng: currentAnalysisData.lng};
      }
      if(map){
        const c = map.getCenter();
        return {lat: c.lat, lng: c.lng};
      }
      return {lat: null, lng: null};
    }

    function polygonAreaM2(geo){
      try{
        if(!geo || geo.type !== "Polygon" || !Array.isArray(geo.coordinates)) return 0;
        const ring = geo.coordinates[0];
        if(!Array.isArray(ring) || ring.length < 3) return 0;
        let lat0 = 0;
        for(const p of ring){ lat0 += p[1]; }
        lat0 /= ring.length;
        const cos = Math.cos(lat0 * Math.PI/180);
        const sx = 111320 * cos;
        const sy = 110540;
        let area = 0;
        for(let i=0;i<ring.length-1;i++){
          const x1 = ring[i][0] * sx;
          const y1 = ring[i][1] * sy;
          const x2 = ring[i+1][0] * sx;
          const y2 = ring[i+1][1] * sy;
          area += (x1*y2 - x2*y1);
        }
        return Math.abs(area) / 2;
      }catch(e){ return 0; }
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function deg2rad(d){ return d * Math.PI / 180; }
    function cosd(d){ return Math.cos(deg2rad(d)); }

    function estimateSunHoursHeuristic(lat){
      if(typeof lat !== "number" || !isFinite(lat)) return 3.6;
      const t = clamp((lat - 33) / (38.5 - 33), 0, 1);
      return 3.9 - 0.5 * t;
    }

    function orientationFactor(lat, azimuthDeg, tiltDeg){
      if(typeof azimuthDeg !== "number" || !isFinite(azimuthDeg)) azimuthDeg = 180;
      if(typeof tiltDeg !== "number" || !isFinite(tiltDeg)) tiltDeg = 20;
      const optAz = 180;
      const optTilt = clamp((typeof lat === "number" && isFinite(lat)) ? (lat - 10) : 20, 10, 35);
      let azErr = Math.abs(azimuthDeg - optAz);
      azErr = azErr > 180 ? 360 - azErr : azErr;
      const tiltErr = Math.abs(tiltDeg - optTilt);
      const fAz = clamp(cosd(azErr), 0.7, 1.0);
      const fTilt = clamp(cosd(tiltErr * 0.7), 0.8, 1.0);
      return clamp(fAz * fTilt, 0.75, 1.0);
    }

    function fmtWon(v){
      if(typeof v !== "number" || !isFinite(v)) return "í™•ì¸ í•„ìš”";
      return Math.round(v).toLocaleString() + " ì›";
    }
    function formatWon(v){ return fmtWon(v); }

    function updateSolarOptUI(data){
      const elOpt = el("solarOpt");
      if(!elOpt) return;
      if(!data){ elOpt.innerText = "í™•ì¸ í•„ìš”"; return; }
      const sun = (typeof data.sun_hours === "number") ? data.sun_hours.toFixed(2) : null;
      const az  = (typeof data.azimuth_deg === "number") ? Math.round(data.azimuth_deg) : null;
      const tilt= (typeof data.tilt_deg === "number") ? Math.round(data.tilt_deg) : null;
      if(sun || az || tilt){
        const parts = [];
        if(sun) parts.push(`ì¼ì‚¬ ${sun}h`);
        if(az !== null) parts.push(`ë°©ìœ„ ${az}Â°`);
        if(tilt !== null) parts.push(`ê²½ì‚¬ ${tilt}Â°`);
        elOpt.innerText = parts.join(" / ");
      }else{ elOpt.innerText = "í™•ì¸ í•„ìš”"; }
    }

    function updateLandPriceUI(won){
      const elLP = el("landPrice");
      if(!elLP) return;
      elLP.innerText = fmtWon(won);
    }

    window.refreshSolarLandEstimates = async function(){
      if(!BACKEND_URL) return;
      const {lat, lng} = getAnalysisLatLng();
      if(typeof lat !== "number" || typeof lng !== "number") return;
      const address = currentAnalysisData.address || "í™•ì¸ í•„ìš”";
      const mode = currentAnalysisData.mode || "roof";
      try{
        const r = await postJson(`${BACKEND_URL}/api/solar/optimize`, {lat, lng, address, mode});
        if(r.ok && r.data && r.data.ok){
          currentAnalysisData.solar_opt = r.data;
          updateSolarOptUI(r.data);
          if(typeof r.data.sun_hours === "number"){
            window.calculateFinance(getTotalPanelCount(), r.data.sun_hours);
          }
        }
      }catch(e){}
      try{
        const areaM2 = (typeof currentAnalysisData.area_m2 === "number") ? currentAnalysisData.area_m2 : null;
        const areaPyeong = (areaM2 && areaM2 > 0) ? (areaM2 / 3.3058) : null;
        const payload = { address, pnu: currentAnalysisData.pnu || null, area_m2: areaM2, area_pyeong: areaPyeong };
        const r2 = await postJson(`${BACKEND_URL}/api/land/estimate`, payload);
        if(r2.ok && r2.data && r2.data.ok){
          currentAnalysisData.land_estimate = r2.data;
          const landWon = (typeof r2.data.land_price_won === "number") ? r2.data.land_price_won : null;
          updateLandPriceUI(landWon);
          if(currentAnalysisData.finance?.roi25y){
            currentAnalysisData.finance.roi25y.land_price_won = landWon;
          }
        }
      }catch(e){}
    };

    function showToast(msg){
      const t = el("toastMsg");
      const txt = el("toastText");
      if(!t || !txt) return;
      txt.innerText = msg;
      t.classList.remove("hidden");
      t.classList.add("flex");
      setTimeout(()=>{ t.classList.add("hidden"); t.classList.remove("flex"); }, 2800);
    }

    function logSystem(msg){
      const w = el("logWindow");
      if(!w) return;
      const p = document.createElement("div");
      p.innerText = `> ${msg}`;
      w.appendChild(p);
      w.scrollTop = w.scrollHeight;
    }

    function fmtHHMMSS(ms){
      ms = Math.max(0, Math.floor(ms));
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function safeText(v, fallback="í™•ì¸ í•„ìš”"){
      if(v === undefined || v === null) return fallback;
      const s = String(v).trim();
      return s ? s : fallback;
    }

    async function jsonpRequest(url){
      return new Promise((resolve, reject) => {
        const callbackName = `jsonp_${Date.now()}_${Math.floor(Math.random()*1e9)}`;
        window[callbackName] = (data) => {
          try { delete window[callbackName]; } catch(e) {}
          const script = document.getElementById(callbackName);
          if(script) script.remove();
          resolve(data);
        };
        const script = document.createElement("script");
        script.id = callbackName;
        script.src = `${url}&format=json&callback=${callbackName}&domain=${window.location.hostname}`;
        script.onerror = () => {
          try { delete window[callbackName]; } catch(e) {}
          script.remove();
          reject(new Error("JSONP failed"));
        };
        document.body.appendChild(script);
      });
    }

    window.initMap = function(){
      if(map) return;
      map = L.map("map", { zoomControl: false }).setView([36.5, 127.5], 7);
      L.control.zoom({ position: "bottomright" }).addTo(map);

      function updateZoomIndicator(){
        try{
          const z = map.getZoom();
          const elz = document.getElementById("zoomIndicator");
          if(elz) elz.innerText = `ğŸ” Zoom: ${z}`;
        }catch(e){}
      }
      map.on("zoomend", updateZoomIndicator);
      map.on("moveend", updateZoomIndicator);
      updateZoomIndicator();

      layers = {
        base: L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`),
        sat:  L.tileLayer(`https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Satellite/{z}/{y}/{x}.jpeg`),
      };
      layers.sat.addTo(map);

      selectableGroup = L.layerGroup().addTo(map);
      panelGroup = L.layerGroup().addTo(map);
      analysisMarkerGroup = L.layerGroup().addTo(map);
      existingGroup = L.layerGroup().addTo(map);
      substationGroup = L.layerGroup().addTo(map);

      cadastralLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms/1.0.0', {
        layers: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
        styles: 'lp_pa_cbnd_bubun,lp_pa_cbnd_bonbun',
        format: 'image/png',
        transparent: true,
        opacity: 0.7,
        key: VWORLD_TILE_KEY
      });
      map.addLayer(cadastralLayer);

      let _lastMapClickTs = 0;
      map.on("click", (e) => {
        if(FEATURE_LEVEL < 3) return;
        if(map.dragging && map.dragging._draggable && map.dragging._draggable._moving) return;
        const now = Date.now();
        if(now - _lastMapClickTs < 250) return;
        _lastMapClickTs = now;
        try{ drawTemporaryCandidate(e.latlng.lat, e.latlng.lng); }catch(_e){}
        setTimeout(()=>{
          try{ scanBuildings(e.latlng.lat, e.latlng.lng, true); }catch(err){ console.warn(err); }
        }, 60);
      });

      map.on("moveend", () => {
        try { updateAutoScanBox(); } catch(e) {}
        if(FEATURE_LEVEL < 4) return;
        if(!autoScanMode) return;
        const autoFollow = el("autoFollow");
        if(autoFollow && autoFollow.checked) return;
        if(autoScanDebounce) clearTimeout(autoScanDebounce);
        autoScanDebounce = setTimeout(() => {
          const c = map.getCenter();
          scanBuildings(c.lat, c.lng, true);
        }, 450);
      });

      try{
        const chk = document.getElementById("autoScanToggle");
        if(chk) chk.checked = true;
        if(typeof window.toggleAutoScan === "function") window.toggleAutoScan(true);
      }catch(e){}
    };

    window.setMap = function(t){
      if(!map) return;
      if(t === "base"){ map.addLayer(layers.base); map.removeLayer(layers.sat); }
      else { map.addLayer(layers.sat); map.removeLayer(layers.base); }
    };

    window.toggleLayer = function(type){
      if(!map) return;
      if(type === "cadastral"){
        const chk = el("cadastralToggle");
        if(chk.checked) map.addLayer(cadastralLayer);
        else map.removeLayer(cadastralLayer);
      }
    };

    window.switchTab = function(tab){
      const tabs = ["scan","analysis","legal","history"];
      for(const t of tabs){
        const tb = el(`tab-${t}`);
        const pn = el(`panel-${t}`);
        if(tb) tb.classList.remove("active");
        if(pn) pn.classList.add("hidden");
      }
      const tb = el(`tab-${tab}`);
      const pn = el(`panel-${tab}`);
      if(tb) tb.classList.add("active");
      if(pn) pn.classList.remove("hidden");
    };

    window.toggleSidebar = function(){
      const sb = el("sidebar");
      const btn = el("sidebar-toggle-btn");
      if(sb) sb.classList.toggle("collapsed");
      if(btn) btn.classList.toggle("collapsed");
    };

    window.toggleTarget = function(){
      if(FEATURE_LEVEL < 2){ showToast("feat<2: ëª¨ë“œ ì „í™˜ ë¹„í™œì„±"); return; }
      const radios = document.getElementsByName("scanTarget");
      for(const r of radios){
        if(r.checked){ scanTarget = (r.value === "land") ? "land" : "building"; break; }
      }
      clearResults(true);
      showToast(`ëª¨ë“œ ë³€ê²½: ${scanTarget === "land" ? "í† ì§€" : "ì§€ë¶•"}`);
    };

    window.searchAddress = async function(){
      if(FEATURE_LEVEL < 1){ showToast("feat<1: ì£¼ì†Œê²€ìƒ‰ ë¹„í™œì„±"); return; }
      const input = el("addrInput");
      const q = (input ? input.value : "").trim();
      if(!q){ showToast("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
      try{
        const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(q)}&refine=true&simple=false&type=road&key=${VWORLD_TILE_KEY}`;
        const data = await jsonpRequest(url);
        if(data?.response?.status === "OK"){
          const {x,y} = data.response.result.point;
          const lat = parseFloat(y), lng = parseFloat(x);
          map.setView([lat,lng], 18);
          showToast("ì£¼ì†Œ ì´ë™ ì™„ë£Œ");
          if(FEATURE_LEVEL >= 3){
            await new Promise(r=>setTimeout(r, 350));
            const res = await scanBuildings(lat, lng, true);
            if(res?.features?.length){ analyzeFeature(res.features[0], true); }
          }
        } else { showToast("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"); }
      } catch(e){ showToast("ì£¼ì†Œê²€ìƒ‰ ì˜¤ë¥˜"); }
    };

    window.toggleMultiSelect = function(){
      const chk = el("multiSelectToggle");
      isMultiSelectMode = !!(chk && chk.checked);
      clearResults(true);
    };

    window.toggleAutoScan = function(){
      const chk = el("autoScanToggle");
      if(FEATURE_LEVEL < 4){
        if(chk) chk.checked = false;
        autoScanMode = false;
        showToast("feat<4: ìë™ ìŠ¤ìº” ë¹„í™œì„±");
        updateAutoScanBox();
        return;
      }
      autoScanMode = !!(chk && chk.checked);
      showToast(autoScanMode ? "ìë™ ìŠ¤ìº” ON" : "ìë™ ìŠ¤ìº” OFF");
      updateAutoScanBox();
    };

    function ensurePanelDragHandle(feature){
      try{
        if(!window.map || !feature?.geometry) return;
        if(panelDragHandle){ try{ window.map.removeLayer(panelDragHandle); }catch(e){} panelDragHandle = null; }
        const center = turf.center(feature).geometry.coordinates;
        const latlng = L.latLng(center[1], center[0]);
        const icon = L.divIcon({
          className:"",
          html:`<div style="width:28px;height:28px;border-radius:999px;background:rgba(34,211,238,0.95);border:2px solid rgba(15,23,42,0.9);box-shadow:0 6px 18px rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0f172a;">â†”</div>`,
          iconSize:[28,28],
          iconAnchor:[14,14]
        });
        panelDragHandle = L.marker(latlng, { icon, draggable:true });
        panelDragHandle.addTo(window.map);
        panelDragHandle.on("dragstart", (e)=>{ _dragStartLatLng = e.target.getLatLng(); try{ window.map.dragging.disable(); }catch(_e){} });
        panelDragHandle.on("dragend", (e)=>{
          try{ window.map.dragging.enable(); }catch(_e){}
          const end = e.target.getLatLng();
          const start = _dragStartLatLng || end;
          const eastRef = L.latLng(start.lat, end.lng);
          const northRef = L.latLng(end.lat, start.lng);
          const dx = window.map.distance(start, eastRef) * (end.lng >= start.lng ? 1 : -1);
          const dy = window.map.distance(start, northRef) * (end.lat >= start.lat ? 1 : -1);
          calibration.dx_m += dx;
          calibration.dy_m += dy;
          try{ if(typeof window.reCalculate === "function") window.reCalculate(); }catch(_e){}
          try{ const c = turf.center(currentAnalysisFeature).geometry.coordinates; e.target.setLatLng([c[1], c[0]]); }catch(_e){}
        });
      }catch(e){}
    }

    async function scanBuildings(lat, lng, force=false){
      if(!map) return null;
      if(scanLock && !force) return null;
      scanLock = true;
      let fetchedFeatures = [];
      try{
        if(!isMultiSelectMode){
          selectableGroup.clearLayers();
          panelGroup.clearLayers();
          selectedFeatures.clear();
          currentAnalysisFeature = null;
          resetCalibrationInternal(false);
          const rc = el("resultCard"); if(rc) rc.classList.add("hidden");
          const lp = el("legalPlaceholder"); const lc = el("legalContent"); const sp = el("aiScorePanel");
          if(lp) lp.classList.remove("hidden"); if(lc) lc.classList.add("hidden"); if(sp) sp.classList.add("hidden");
        }
        analysisMarkerGroup.clearLayers();
        L.marker([lat,lng]).addTo(analysisMarkerGroup);
        const z = map.getZoom();
        const d = (z >= 17) ? 0.0016 : (z >= 16 ? 0.0028 : 0.0042);
        const box = `${lng - d},${lat - d},${lng + d},${lat + d}`;
        const dataName = (scanTarget === "land") ? "LP_PA_CBND_BUBUN" : "LT_C_SPBD";
        const url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${dataName}&key=${VWORLD_TILE_KEY}&geomFilter=BOX(${box})&size=${(z>=17)?80:(z>=16?120:180)}`;
        const data = await jsonpRequest(url);
        const fc = data?.response?.result?.featureCollection;
        fetchedFeatures = fc?.features || [];
        L.geoJSON(fetchedFeatures, {
          style: (scanTarget === "land") ? { color:"#8d6e63", weight:2, fillColor:"#8d6e63", fillOpacity:0.25 } : { color:"#3b82f6", weight:2, fillOpacity:0.20 },
          onEachFeature: (feature, layer) => { layer.on("click", (e) => { L.DomEvent.stopPropagation(e); analyzeFeature(feature, true); }); }
        }).addTo(selectableGroup);
        const found = el("foundCount"); if(found) found.innerText = `ê²€ìƒ‰ëœ êµ¬ì—­: ${selectableGroup.getLayers().length}ê°œ`;
        return { features: fetchedFeatures, count: fetchedFeatures.length };
      } catch(e){ return null; } finally { setTimeout(()=>{ scanLock = false; }, 500); }
    }

    function metersToKm(m){ return (m || 0) / 1000; }
    function applyCalibrationToFC(fc){
      if(!window.turf || !fc) return fc;
      let out = turf.clone(fc);
      if(calibration.rot_deg){ try { out = turf.transformRotate(out, calibration.rot_deg); } catch(e) {} }
      if(calibration.dx_m){ try { out = turf.transformTranslate(out, metersToKm(calibration.dx_m), 90, {units:"kilometers"}); } catch(e) {} }
      if(calibration.dy_m){ try { out = turf.transformTranslate(out, metersToKm(calibration.dy_m), 0, {units:"kilometers"}); } catch(e) {} }
      return out;
    }

    function buildPanelsFCFromGeometry(geo){
      const fallback = () => {
        let bbox = null; try { bbox = turf.bbox(turf.feature(geo)); } catch(e) {}
        if(!bbox){ const c = map.getCenter(); bbox = [c.lng-0.0004, c.lat-0.0004, c.lng+0.0004, c.lat+0.0004]; }
        const lat = (bbox[1] + bbox[3]) / 2; const mpdLng = 111320 * Math.cos(lat * Math.PI / 180); const mpdLat = 111000;
        const w = 1.13 / mpdLng; const h = 2.2 / mpdLat;
        const feats = [];
        for(let i=0;i<3;i++){ for(let j=0;j<3;j++){ const x = bbox[0] + i*w*1.3; const y = bbox[1] + j*h*1.3; feats.push(turf.bboxPolygon([x,y,x+w,y+h])); } }
        return { type:"FeatureCollection", features: feats };
      };
      if(!window.turf) return fallback();
      const isPoly = geo && (geo.type === "Polygon" || geo.type === "MultiPolygon");
      if(!isPoly) return fallback();
      let poly = turf.feature(geo);
      let setback = 0; const sb = el("setbackDist"); if(sb) setback = parseFloat(sb.value || "0") || 0;
      if(setback > 0){ try{ const shrunk = turf.buffer(poly, -setback, {units:"meters"}); if(shrunk && shrunk.geometry) poly = shrunk; else return fallback(); } catch(e){ return fallback(); } }
      const modW = parseFloat(el("modWidth")?.value || "1.13") || 1.13;
      const modH = parseFloat(el("modHeight")?.value || "2.4") || 2.4;
      const angle = parseFloat(el("installAngle")?.value || "20") || 20;
      const rowSpacing = parseFloat(el("rowSpacing")?.value || "1.2") || 1.2;
      const projectedH = modH * Math.cos(angle * Math.PI / 180);
      const bbox = turf.bbox(poly);
      const centerLat = (bbox[1] + bbox[3]) / 2;
      const mpdLng = 111320 * Math.cos(centerLat * Math.PI / 180);
      const mpdLat = 111000;
      const dLng = (modW + 0.10) / mpdLng;
      const dLat = (projectedH + rowSpacing) / mpdLat;
      const feats = []; let guard = 0; const MAX = 45000;
      for(let x=bbox[0]; x<bbox[2]; x+=dLng){ for(let y=bbox[1]; y<bbox[3]; y+=dLat){ if(guard++ > MAX) break; const pt = turf.point([x + dLng/2, y + dLat/2]); try{ if(turf.booleanPointInPolygon(pt, poly)){ const w = modW / mpdLng; const h = projectedH / mpdLat; feats.push(turf.bboxPolygon([x, y, x+w, y+h])); } } catch(e) {} } }
      if(!feats.length) return fallback();
      return { type:"FeatureCollection", features: feats };
    }

    function renderPanelsFC(fc){
      const style = { color: "#0f172a", weight: 1, fillColor: "#0b3a8a", fillOpacity: 0.80 };
      return L.geoJSON(fc, { style });
    }

    function getFeatureId(feature){
      const props = feature?.properties || {};
      if(props.pnu) return `pnu:${props.pnu}`;
      try{ const c = turf.center(feature).geometry.coordinates; return `c:${c[1].toFixed(6)}:${c[0].toFixed(6)}`; } catch(e){ return `t:${Math.random()}`; }
    }

    function updateResultCardBasics(addr, panelCount){
      const rc = el("resultCard"); if(rc) rc.classList.remove("hidden");
      if(el("analysisAddress")) el("analysisAddress").innerText = safeText(addr);
      if(el("analysisCount")) el("analysisCount").innerText = `${panelCount} ì¥`;
      const modPower = parseFloat(el("modPower")?.value || "640") || 640;
      const dcKw = (panelCount * modPower) / 1000;
      const acKw = dcKw / 1.15;
      if(el("analysisCapacity")) el("analysisCapacity").innerText = `${acKw.toFixed(1)} kW (DC: ${dcKw.toFixed(1)})`;
      try{ if(typeof window.updateKepcoCapacity==="function") window.updateKepcoCapacity(addr, currentAnalysisData?.pnu); }catch(e){ if(el("kepcoCapacity")) el("kepcoCapacity").innerText = "í™•ì¸ í•„ìš”"; }
    }

    window.calculateFinance = function(panelCount, sunHoursOverride){
      try{
        const totalPanels = Math.max(0, parseInt(panelCount || 0, 10));
        const {lat} = getAnalysisLatLng();
        const solar = currentAnalysisData.solar_opt || {};
        const sun = (typeof sunHoursOverride === "number" && sunHoursOverride > 0) ? sunHoursOverride : estimateSunHoursHeuristic(lat);
        const modPowerW = (parseFloat(el("modPower")?.value || "640") || 640);
        const dcKw = (totalPanels * modPowerW) / 1000.0;
        const acKw = dcKw / 1.15;
        const PR = 0.90;
        const annualKwhY1 = dcKw * sun * 365 * PR;
        const smp = (parseFloat(el("smp")?.value || "140") || 140);
        const rec = (parseFloat(el("rec")?.value || "70") || 70);
        const effectivePrice = smp + rec;
        const costPerKw = (parseFloat(el("costPerKw")?.value || "90") || 90) * 10000;
        const totalCost = dcKw * costPerKw;
        const annualRevenueWon = annualKwhY1 * effectivePrice;
        
        // PF Calculation
        const annualRatePct = (parseFloat(el("pfInterestRate")?.value || "5.5") || 5.5);
        const years = 15;
        const loanRatioPct = (parseFloat(el("pfLoanRatio")?.value || "90") || 90);
        let principal = (parseFloat(el("pfPrincipal")?.value || "0") || 0);
        const autoPrincipal = !!(el("pfAutoPrincipal") && el("pfAutoPrincipal").checked);
        if(autoPrincipal){ principal = Math.round(totalCost * (loanRatioPct/100)); try{ el("pfPrincipal").value = principal; }catch(e){} }
        
        const r = (annualRatePct/100)/12;
        const n = years*12;
        const monthly = (principal * r * Math.pow(1+r, n)) / (Math.pow(1+r, n)-1);
        const totalInterest = (monthly * n) - principal;
        const payback = (totalCost / annualRevenueWon);

        if(el("resTotalCost")) el("resTotalCost").innerText = `${Math.round(totalCost).toLocaleString()} ì›`;
        if(el("resAnnualRev")) el("resAnnualRev").innerText = `${Math.round(annualRevenueWon).toLocaleString()} ì›`;
        if(el("resMonthlyDebt")) el("resMonthlyDebt").innerText = `${Math.round(monthly).toLocaleString()} ì›`;
        if(el("resTotalInterest")) el("resTotalInterest").innerText = `${Math.round(totalInterest).toLocaleString()} ì›`;
        if(el("resPfPayback")) el("resPfPayback").innerText = `${payback.toFixed(1)} ë…„`;

        currentAnalysisData.finance = { totalPanels, dcKw, acKw, annualKwhY1, annualRevenueWon, totalCostWon: totalCost, monthlyDebtWon: monthly, totalInterestWon: totalInterest, paybackYears: payback, roi25y: { land_price_won: null } };
      }catch(e){}
    };

    window.analyzeFeature = function(feature, focusTab){
      if(FEATURE_LEVEL < 3){ showToast("feat<3: íŒ¨ë„ ìƒì„± ë¹„í™œì„±"); return; }
      if(!feature?.geometry){ showToast("ì§€ì˜¤ë©”íŠ¸ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"); return; }
      if(focusTab) window.switchTab("analysis");
      const props = feature.properties || {};
      const addr = props.road_nm_ad || props.jibun_addr || props.addr || (props.pnu ? `PNU:${props.pnu}` : "") || "í™•ì¸ í•„ìš”";
      currentAnalysisData.pnu = props.pnu || null;
      const featureId = getFeatureId(feature);
      if(isMultiSelectMode && selectedFeatures.has(featureId)){
        const stored = selectedFeatures.get(featureId);
        if(stored?.layer) panelGroup.removeLayer(stored.layer);
        selectedFeatures.delete(featureId);
        recomputeTotalsAfterSelectionChange();
        return;
      }
      if(!isMultiSelectMode){
        panelGroup.clearLayers();
        selectedFeatures.clear();
        resetCalibrationInternal(false);
      }
      currentAnalysisFeature = feature;
      const baseFC = buildPanelsFCFromGeometry(feature.geometry);
      const fc = applyCalibrationToFC(baseFC);
      const layer = renderPanelsFC(fc);
      layer.addTo(panelGroup);
      const count = fc.features.length;
      selectedFeatures.set(featureId, { feature, layer, count, panelsFC: fc, basePanelsFC: baseFC, address: addr });
      try{ const c = L.geoJSON(feature).getBounds().getCenter(); currentAnalysisData.lat = c.lat; currentAnalysisData.lng = c.lng; }catch(e){ const c2 = map.getCenter(); currentAnalysisData.lat = c2.lat; currentAnalysisData.lng = c2.lng; }
      currentAnalysisData.area_m2 = polygonAreaM2(feature.geometry);
      const pc = getTotalPanelCount();
      updateResultCardBasics(addr, pc);
      setTimeout(()=>window.calculateFinance(pc, currentAnalysisData.solar_opt?.sun_hours),0);
      try{ window.refreshSolarLandEstimates(); }catch(e){}
      try{ ensurePanelDragHandle(feature); }catch(e){}
      currentAnalysisData.address = addr;
      currentAnalysisData.mode = (scanTarget === "land") ? "land" : "roof";
      if(FEATURE_LEVEL >= 5){ try{ const center = turf.center(feature).geometry.coordinates; fetchAIData(center[1], center[0], addr); }catch(e){ fetchAIData(null, null, addr); } }
    };

    function getTotalPanelCount(){
      let sum = 0;
      for(const v of selectedFeatures.values()) sum += (v.count || 0);
      return sum;
    }

    function recomputeTotalsAfterSelectionChange(){
      const total = getTotalPanelCount();
      if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
      window.calculateFinance(total, currentAnalysisData.solar_opt?.sun_hours);
      showToast(`ì„ íƒ: ${selectedFeatures.size}ê°œ / íŒ¨ë„ ${total}ì¥`);
    }

    window.reCalculate = function(){
      if(FEATURE_LEVEL < 3) return;
      if(!selectedFeatures.size){ showToast("ì„ íƒëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
      panelGroup.clearLayers();
      const updated = new Map();
      for(const [id, v] of selectedFeatures.entries()){
        const baseFC = buildPanelsFCFromGeometry(v.feature.geometry);
        const fc = (currentAnalysisFeature && id === getFeatureId(currentAnalysisFeature)) ? applyCalibrationToFC(baseFC) : baseFC;
        const layer = renderPanelsFC(fc);
        layer.addTo(panelGroup);
        updated.set(id, { ...v, layer, count: fc.features.length, panelsFC: fc, basePanelsFC: baseFC });
      }
      selectedFeatures = updated;
      const total = getTotalPanelCount();
      if(el("analysisCount")) el("analysisCount").innerText = `${total} ì¥`;
      window.calculateFinance(total, currentAnalysisData.solar_opt?.sun_hours);
      showToast("ì¬ê³„ì‚° ì™„ë£Œ");
    };

    function resetCalibrationInternal(recalc=true){ calibration = { dx_m: 0, dy_m: 0, rot_deg: 0 }; if(recalc) window.reCalculate(); }
    window.resetCalibration = function(){ resetCalibrationInternal(true); };
    window.applyCalibration = function(dx, dy, drot=0){ if(FEATURE_LEVEL < 3) return; calibration.dx_m += (dx || 0); calibration.dy_m += (dy || 0); calibration.rot_deg += (drot || 0); window.reCalculate(); };
    window.dpadHoldStart = function(dir){ if(FEATURE_LEVEL < 3) return; window.dpadHoldStop(); const step = 0.2; const tick = () => { if(dir === "up") window.applyCalibration(0, step); if(dir === "down") window.applyCalibration(0, -step); if(dir === "left") window.applyCalibration(-step, 0); if(dir === "right") window.applyCalibration(step, 0); if(dir === "rotL") window.applyCalibration(0, 0, -2); if(dir === "rotR") window.applyCalibration(0, 0, 2); }; tick(); dpadHoldTimer = setInterval(tick, 120); };
    window.dpadHoldStop = function(){ if(dpadHoldTimer){ clearInterval(dpadHoldTimer); dpadHoldTimer = null; } };

    async function postJson(url, body){
      const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body||{}), credentials:"include"});
      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch(e) { data = { raw: text }; }
      return { ok: res.ok, status: res.status, data };
    }

    function renderAIResult(payload){
      const container = el("aiAnalysisResult");
      if(container){
        const checks = Array.isArray(payload.checks) ? payload.checks : [];
        container.innerHTML = checks.map(item => {
          const title = safeText(item.title || item.category, "");
          const result = safeText(item.message || item.result || item.status || "", "í™•ì¸ í•„ìš”");
          const needs = item.needs_confirm || (String(result).includes("í™•ì¸") && String(result).includes("í•„ìš”"));
          return `<div class="bg-slate-700/50 p-2 rounded border border-slate-600 flex justify-between items-center text-[10px]"><div class="flex items-center gap-2"><div class="text-cyan-400">âœ“</div><div><div class="text-slate-300 font-bold">${title}</div><div class="${needs ? "text-yellow-300" : "text-white"} truncate w-60">${result}</div></div></div></div>`;
        }).join("") || `<div class="text-slate-300 text-xs">AI ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }
      const scorePanel = el("aiScorePanel");
      if(scorePanel){
        let score = null;
        if(typeof payload.attractiveness_score === "number") score = payload.attractiveness_score;
        else if(payload.ai_score && typeof payload.ai_score.score === "number") score = payload.ai_score.score;
        if(score === null) { scorePanel.classList.add("hidden"); }
        else {
          scorePanel.classList.remove("hidden");
          const s = Math.max(0, Math.min(100, Math.round(score)));
          if(el("scoreValue")) el("scoreValue").innerText = `${s}ì `;
          if(el("scoreBar")) el("scoreBar").style.width = `${s}%`;
        }
      }
    }

    window.fetchAIData = async function(lat, lng, addr){
      if(FEATURE_LEVEL < 5) return;
      if(!BACKEND_URL) return;
      const placeholder = el("legalPlaceholder");
      const loading = el("legalLoading");
      const content = el("legalContent");
      if(placeholder) placeholder.classList.add("hidden");
      if(content) content.classList.add("hidden");
      if(loading) loading.classList.remove("hidden");
      const ll = getAnalysisLatLng();
      const payload = { address: addr, mode: (scanTarget === "land") ? "land" : "roof", lat: lat||ll.lat, lng: lng||ll.lng, panel_count: getTotalPanelCount(), setback_m: parseFloat(el("setbackDist")?.value || "0") || 0 };
      try{
        let r = await postJson(`${BACKEND_URL}/api/analyze/basic`, payload);
        if(!r.ok) r = await postJson(`${BACKEND_URL}/api/ai/analyze`, payload);
        currentAnalysisData.ai_analysis = r.data;
        if(loading) loading.classList.add("hidden");
        if(content) content.classList.remove("hidden");
        renderAIResult(r.data);
        
        // [í†µí•©] 8ëŒ€ ì²´í¬ì‚¬í•­ ì¶”ê°€ ë¡œë”© (AI ë¶„ì„ í›„ ì‹¤í–‰)
        await fetchEightChecks();

        try{ window.refreshSolarLandEstimates(); }catch(e){}
      } catch(e){
        if(loading) loading.classList.add("hidden");
        if(placeholder) { placeholder.classList.remove("hidden"); placeholder.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs">ê¸°ë³¸ ë¶„ì„ ì‹¤íŒ¨</div>`; }
      }
    };

    window.openFullReport = function(){
      const form = el("reportForm");
      if(!form || !BACKEND_URL) return;
      if(el("form_address")) el("form_address").value = safeText(currentAnalysisData.address, "");
      if(el("form_capacity")) el("form_capacity").value = safeText(el("analysisCapacity")?.innerText, "");
      if(el("form_kepco")) el("form_kepco").value = safeText(el("kepcoCapacity")?.innerText, "í™•ì¸ í•„ìš”");
      if(el("form_date")) el("form_date").value = new Date().toLocaleString();
      if(el("form_mode")) el("form_mode").value = (scanTarget === "land") ? "land" : "roof";
      if(el("form_finance")) el("form_finance").value = JSON.stringify(currentAnalysisData.finance || {});
      if(el("form_ai")) el("form_ai").value = JSON.stringify(currentAnalysisData.ai_analysis || {});
      if(el("form_solar")) el("form_solar").value = JSON.stringify(currentAnalysisData.solar_opt || {});
      if(el("form_land")) el("form_land").value = JSON.stringify(currentAnalysisData.land_estimate || {});
      form.action = `${BACKEND_URL}/report`;
      form.submit();
    };

    window.onload = function(){
      window.addEventListener("blur", window.dpadHoldStop);
      window.initMap();
      if(el("analysisAddress")) el("analysisAddress").innerText = "í™•ì¸ í•„ìš”";
      autoScanMode = !!(el("autoScanToggle")?.checked);
      isMultiSelectMode = !!(el("multiSelectToggle")?.checked);
    };
    </script>
</body>
</html>
