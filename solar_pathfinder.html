<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solar Pathfinder Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @media print {
      html, body {
        background: #ffffff !important;
        color: #111827 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      body * {
        box-shadow: none !important;
        color: #111827 !important;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-indigo-950 text-slate-100">
  {% macro kfmt_signed(v) -%}
    {% if v is none %}
      -
    {% else %}
      {% set n = (v|float) / 1000.0 %}
      {% if n < 0 %}
        ({{ '{:,.0f}'.format(-n) }})
      {% else %}
        {{ '{:,.0f}'.format(n) }}
      {% endif %}
    {% endif %}
  {%- endmacro %}
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.05),0_20px_60px_rgba(0,0,0,0.35)] overflow-hidden">
      <div class="p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div>
            <div class="flex items-center gap-2">
              <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-cyan-400/20 to-indigo-400/20 border border-white/10 flex items-center justify-center">
                <span class="text-lg font-black">SP</span>
              </div>
              <div>
                <div class="text-xl font-extrabold tracking-tight">상세 리포트</div>
                <div class="text-xs text-slate-300/80 mt-0.5">{{ date }}</div>
              </div>
            </div>
            <div class="mt-4">
              <div class="text-xs text-slate-300/80 font-bold">주소</div>
              <div class="text-sm text-slate-100/90 break-words mt-1">{{ address }}</div>
            </div>
          </div>

          <div class="flex flex-col items-start md:items-end gap-3">
            <div class="flex items-center gap-2">
              <div class="px-3 py-1 rounded-full bg-emerald-400/10 border border-emerald-400/25 text-emerald-200 text-xs font-bold">
                구매매력도 <span class="ml-1 text-base text-emerald-100">{{ ai_score }}</span>
              </div>
              <div class="px-3 py-1 rounded-full bg-amber-400/10 border border-amber-400/25 text-amber-200 text-xs font-bold">
                한전 용량: <span class="ml-1 text-amber-100">{{ kepco_capacity }}</span>
              </div>
            </div>

            <div class="text-right">
              <div class="text-xs text-slate-300/80">용량</div>
              <div class="text-2xl font-extrabold text-cyan-200 tracking-tight">{{ capacity }}</div>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-2 justify-end">
              <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                <div class="text-[11px] text-slate-200/80 font-bold">토지</div>
                <button id="landOwnBtn" class="px-2 py-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-xs font-bold">보유</button>
                <button id="landBuyBtn" class="px-2 py-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-xs font-bold">구매</button>
              </div>

              <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                <div class="text-[11px] text-slate-200/80 font-bold">시나리오</div>
                <select id="scenarioSel" class="bg-slate-900/60 border border-white/10 rounded-lg px-2 py-1 text-xs">
                  <option value="0.90">보수</option>
                  <option value="1.00" selected>기본</option>
                  <option value="1.10">낙관</option>
                </select>
              </div>

              <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                <div class="text-[11px] text-slate-200/80 font-bold">할인율</div>
                <input id="discountRate" type="number" step="0.1" value="6.0" class="w-20 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
                <span class="text-[11px] text-slate-300/80">%</span>
                <button id="recalcRoi" class="px-3 py-1 rounded-lg bg-slate-100 text-slate-900 font-extrabold text-xs hover:bg-white">재계산</button>
              </div>
            </div>

          </div>
        </div>

        <!-- KPI cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-6">
          <div class="rounded-2xl bg-gradient-to-br from-slate-900/60 to-slate-900/20 border border-white/10 p-4">
            <div class="text-xs text-slate-300/80 font-bold">총 사업비</div>
            <div class="text-lg font-extrabold mt-1">{{ finance.totalCostWon|default(0) | int | format_won }}</div>
            <div class="text-[11px] text-slate-400/80 mt-2">※ 추정치</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-indigo-900/50 to-indigo-900/20 border border-white/10 p-4">
            <div class="text-xs text-indigo-200/90 font-bold">연 수익(기본)</div>
            <div class="text-lg font-extrabold mt-1">{{ finance.annualRevenueWon|default(0) | int | format_won }}</div>
            <div class="text-[11px] text-indigo-200/70 mt-2">시나리오로 변동</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-emerald-900/50 to-emerald-900/20 border border-white/10 p-4">
            <div class="text-xs text-emerald-200/90 font-bold">월 상환액(PF)</div>
            <div class="text-lg font-extrabold mt-1">{{ finance.monthlyDebtWon|default(0) | int | format_won }}</div>
            <div class="text-[11px] text-emerald-200/70 mt-2">총이자 {{ finance.totalInterestWon|default(0) | int | format_won }}</div>
          </div>

          <div class="rounded-2xl bg-gradient-to-br from-amber-900/50 to-amber-900/20 border border-white/10 p-4">
            <div class="text-xs text-amber-200/90 font-bold">자본회수기간</div>
            <div class="text-lg font-extrabold mt-1">{{ finance.paybackYears if finance.paybackYears else "> 25" }} 년</div>
            <div class="text-[11px] text-amber-200/70 mt-2">※ 보수적 추정</div>
          </div>
        </div>

        <!-- NPV/IRR -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">NPV / IRR (토지비 제외)</div>
            <div class="flex items-end justify-between">
              <div>
                <div class="text-[11px] text-slate-300/70">NPV</div>
                <div id="npvNo" class="text-lg font-extrabold">-</div>
              </div>
              <div class="text-right">
                <div class="text-[11px] text-slate-300/70">IRR</div>
                <div id="irrNo" class="text-lg font-extrabold">-</div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">NPV / IRR (토지비 포함)</div>
            <div class="flex items-end justify-between">
              <div>
                <div class="text-[11px] text-slate-300/70">NPV</div>
                <div id="npvWith" class="text-lg font-extrabold">-</div>
              </div>
              <div class="text-right">
                <div class="text-[11px] text-slate-300/70">IRR</div>
                <div id="irrWith" class="text-lg font-extrabold">-</div>
              </div>
            </div>
            <div id="landNote" class="text-[10px] text-amber-200/80 mt-2">※ 토지가격 데이터가 없으면 포함/제외 차이가 없을 수 있습니다.</div>
          </div>
        </div>

        
        <!-- DSCR -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">DSCR (PF 기간)</div>
            <div class="flex items-end justify-between">
              <div>
                <div class="text-[11px] text-slate-300/70">최소</div>
                <div id="dscrMin" class="text-lg font-extrabold">-</div>
              </div>
              <div class="text-right">
                <div class="text-[11px] text-slate-300/70">평균</div>
                <div id="dscrAvg" class="text-lg font-extrabold">-</div>
              </div>
            </div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">DSCR 기준</div>
            <div class="flex items-center gap-2">
              <input id="dscrThreshold" type="number" step="0.05" value="1.20" class="w-24 px-2 py-1 bg-slate-900/60 border border-white/10 rounded-lg text-xs" />
              <span class="text-[11px] text-slate-300/70">이상</span>
              <button id="recalcPf" class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-xs font-extrabold hover:bg-white/15">판정</button>
            </div>
            <div id="pfVerdict" class="mt-3 text-sm font-extrabold">-</div>
            <div class="text-[10px] text-slate-300/70 mt-1">※ DSCR은 (수익-운영비-교체CAPEX)/연부채상환으로 계산(보수)</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-xs font-extrabold text-slate-200/90 mb-2">DSCR 추이</div>
            <canvas id="dscrChart" height="110"></canvas>
          </div>
        </div>
<!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">25년 현금흐름(토지비 제외)</div>
            <canvas id="cfChartNoLand" height="170"></canvas>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">25년 현금흐름(토지비 포함)</div>
            <canvas id="cfChartWithLand" height="170"></canvas>
          </div>
        </div>

        <!-- Assumptions + Checklist -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">추정 가정(무데이터 보정 포함)</div>
            <div class="text-xs text-slate-200/80 space-y-2">
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">일사량</div>
                <div class="font-bold">{{ solar.sun_hours or "확인 필요" }} h/일</div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">방위/경사</div>
                <div class="font-bold">{{ solar.azimuth_deg or "확인 필요" }}° / {{ solar.tilt_deg or "확인 필요" }}°</div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">보정 계수</div>
                <div class="font-bold">{{ solar.ori_factor or "확인 필요" }}</div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">이격거리(조례 기준)</div>
                <div class="font-bold">
                  {% set sb = (ai_analysis.get("setback_m") if ai_analysis else None) %}
                  {% if sb is not none and sb > 0 %}
                    {{ sb }} m
                  {% else %}
                    확인 필요
                  {% endif %}
                </div>
              </div>
              <div class="flex justify-between gap-3">
                <div class="text-slate-300/70">토지가격</div>
                <div class="font-bold">{{ land_price }}</div>
              </div>
              <div class="text-[10px] text-amber-200/80 font-bold mt-2">
                ※ 데이터 소스 확정 전: 보수적 추정이며 "확인 필요"입니다.
              </div>
            </div>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">8대 중대 체크사항</div>
            <div class="space-y-2 text-xs">
              {% for c in ai_analysis.checks or [] %}
                <div class="p-3 rounded-xl border border-white/10 bg-black/10 flex items-center justify-between gap-3">
                  <div>
                    <div class="font-extrabold text-slate-100">{{ c.title or c.category }}</div>
                    <div class="text-slate-300/70 mt-1">{{ c.result }}</div>
                  </div>
                  {% if c.link %}
                    <a class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-cyan-200 font-bold hover:bg-white/15"
                       href="{{ c.link }}" target="_blank">링크</a>
                  {% endif %}
                </div>
              {% endfor %}
              {% if (ai_analysis.checks or [])|length == 0 %}
                <div class="text-slate-400">AI 분석 데이터가 없습니다.</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- 법·조례 / AI / 한전 요약 & 설비 사양 -->
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">법·조례 / 입지 요약</div>
            {% set _law = law_text if law_text else (ai_analysis.get("law_text") if ai_analysis else "") %}
            {% set _ai_sum = ai_summary if ai_summary else (ai_analysis.get("ai_summary") if ai_analysis else "") %}
            {% set _kepco_note = (ai_analysis.get("kepco_note") if ai_analysis else "") %}
            {% if _law %}
              <div class="text-xs text-slate-200/90 whitespace-pre-line leading-relaxed">
                {{ _law }}
              </div>
            {% else %}
              <div class="text-xs text-slate-400">
                법령/조례 요약 데이터가 없습니다. 관할 지자체의 용도지역·이격거리·경관/환경 규제를 별도로 확인해야 합니다.
              </div>
            {% endif %}
            {% if _ai_sum %}
              <div class="mt-3 text-[11px] text-slate-300/90">
                <span class="font-bold text-slate-100">AI 종합 코멘트:</span>
                {{ _ai_sum }}
              </div>
            {% endif %}
            {% if _kepco_note %}
              <div class="mt-3 text-[11px] text-amber-200/90">
                <span class="font-bold">한전·계통 메모:</span>
                {{ _kepco_note }}
              </div>
            {% endif %}
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-extrabold text-sm mb-2">주요 설비 사양</div>
            {% set hw = hardware or {} %}
            {% set mod = hw.get("selectedModule") or {} %}
            {% set inv = hw.get("selectedInverter") or {} %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
              <div>
                <div class="text-[11px] text-slate-300/80 font-bold mb-1">모듈</div>
                {% if mod %}
                  <div class="text-sm font-bold text-slate-100">
                    {{ mod.brand or "" }} {{ mod.model or "" }}
                  </div>
                  <div class="mt-1 text-[11px] text-slate-300/80">
                    정격출력 {{ mod.power_w or mod.powerW or "?" }} W
                  </div>
                  {% if mod.efficiency_pct %}
                    <div class="text-[11px] text-slate-300/80">
                      효율 {{ mod.efficiency_pct }}%
                    </div>
                  {% endif %}
                  {% if mod.module_type %}
                    <div class="text-[11px] text-slate-400">
                      타입 {{ mod.module_type }}
                    </div>
                  {% endif %}
                {% else %}
                  <div class="text-[11px] text-slate-400">
                    선택된 모듈 정보가 없습니다. 화면 상 입력값을 기준으로 시뮬레이션되었습니다.
                  </div>
                {% endif %}
              </div>

              <div>
                <div class="text-[11px] text-slate-300/80 font-bold mb-1">인버터</div>
                {% if inv %}
                  <div class="text-sm font-bold text-slate-100">
                    {{ inv.brand or "" }} {{ inv.model or "" }}
                  </div>
                  <div class="mt-1 text-[11px] text-slate-300/80">
                    정격용량 {{ inv.capacity_kw or inv.capacityKw or "?" }} kW
                  </div>
                  {% if inv.topology %}
                    <div class="text-[11px] text-slate-400">
                      형식 {{ inv.topology }}
                    </div>
                  {% endif %}
                {% else %}
                  <div class="text-[11px] text-slate-400">
                    선택된 인버터 정보가 없습니다. 화면 상 입력값을 기준으로 시뮬레이션되었습니다.
                  </div>
                {% endif %}
              </div>
            </div>
            {% set es = hw.get("electrical_spec") or {} %}
            {% if es %}
              <div class="mt-3 border-t border-white/10 pt-2 text-[11px] text-slate-300/80">
                <div class="font-bold mb-1">전기 배선 가이드(설계 검토용)</div>
                {% if es.dc_cable %}
                  <div>DC 케이블: {{ es.dc_cable }}</div>
                {% endif %}
                {% if es.ac_cable %}
                  <div>AC 케이블: {{ es.ac_cable }}</div>
                {% endif %}
                {% if es.connection_box_required is not none %}
                  <div>접속반: {{ "일체형(별도 필요 없음)" if not es.connection_box_required else "별도 설치 필요" }}</div>
                {% endif %}
              </div>
            {% endif %}

            {% set hw_ai_comment = hw.get("ai_comment") %}
            {% if hw_ai_comment %}
              <div class="mt-3 border-t border-white/10 pt-2 text-[11px] text-slate-300/80">
                <div class="font-bold mb-1">AI 전기·기자재 코멘트</div>
                <div class="whitespace-pre-line leading-relaxed">
                  {{ hw_ai_comment }}
                </div>
              </div>
            {% endif %}

            {% set hw_top3 = hardware_ai_top3 or [] %}
            {% if hw_top3 %}
              <div class="mt-3 border-t border-white/10 pt-2 text-[11px]">
                <div class="font-bold mb-1 text-slate-200/90">AI 추천 모듈/인버터 Top3 (CAPEX/효율/공사비 기준)</div>
                <div class="text-[10px] text-slate-400 mb-1">
                  hardware_master_2026 기준 단순 비교 결과이며, 실제 견적/설계와 다를 수 있습니다.
                </div>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-[10px] border border-slate-700/60">
                    <thead class="bg-slate-900/80">
                      <tr>
                        <th class="px-2 py-1 border border-slate-700/60 text-left">순위</th>
                        <th class="px-2 py-1 border border-slate-700/60 text-left">모듈</th>
                        <th class="px-2 py-1 border border-slate-700/60 text-left">인버터</th>
                        <th class="px-2 py-1 border border-slate-700/60 text-right">CAPEX/kW</th>
                        <th class="px-2 py-1 border border-slate-700/60 text-left">케이블/특이사항</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for cand in hw_top3 %}
                        <tr class="{{ 'bg-emerald-500/10' if cand.is_current else 'bg-transparent' }}">
                          <td class="px-2 py-1 border border-slate-700/60 text-center">{{ loop.index }}</td>
                          <td class="px-2 py-1 border border-slate-700/60">
                            {{ cand.module_brand }} {{ cand.module_model }}<br/>
                            <span class="text-[9px] text-slate-400">출력 {{ cand.module_power_w }} W / 효율 {{ cand.module_efficiency_pct or '-' }}%</span>
                          </td>
                          <td class="px-2 py-1 border border-slate-700/60">
                            {{ cand.inverter_brand }} {{ cand.inverter_model }}<br/>
                            <span class="text-[9px] text-slate-400">정격 {{ cand.inverter_capacity_kw }} kW / 접속반 {{ '일체형' if not cand.connection_box_required else '별도' }}</span>
                          </td>
                          <td class="px-2 py-1 border border-slate-700/60 text-right">
                            {{ cand.capex_per_kw_won|format_won }}
                          </td>
                          <td class="px-2 py-1 border border-slate-700/60">
                            <div class="text-[9px] text-slate-300">
                              DC {{ cand.dc_cable or '-' }} / AC {{ cand.ac_cable or '-' }}
                            </div>
                            {% if cand.ai_comment %}
                              <div class="mt-0.5 text-[9px] text-slate-400 leading-snug">
                                {{ cand.ai_comment }}
                              </div>
                            {% endif %}
                            {% if cand.is_current %}
                              <div class="mt-0.5 inline-flex items-center px-1.5 py-0.5 rounded-full bg-emerald-500/20 border border-emerald-400/40 text-[9px] text-emerald-100">
                                현재 선택 조합
                              </div>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% if hardware_ai_note %}
                  <div class="mt-1 text-[10px] text-slate-400">
                    {{ hardware_ai_note }}
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- 통합 분석 현금흐름 표 (화면 통합 분석 패널 원본) -->
        {% set pf = (finance or {}).get("pf_table") or {} %}
        <div class="mt-6 rounded-2xl bg-white/5 border border-white/10 p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-extrabold text-sm">현금흐름 요약 (천원)</div>
            <div class="text-[10px] text-slate-400">※ 화면의 통합 분석 패널과 동일한 구조 (PF기간 vs 25년)</div>
          </div>
          {% if pf %}
            {% set years_pf = pf.get("years_pf") or 15 %}
            {% set years_25 = pf.get("years_25") or 25 %}
            {% set cf = pf.get("cashflow") or {} %}
            {% set prof = pf.get("profit") or {} %}
            {% set cap = pf.get("capex") or {} %}
            <div class="overflow-x-auto">
              <table class="min-w-full text-[11px] border border-slate-700/60">
                <thead>
                  <tr class="bg-slate-900/80">
                    <th class="px-2 py-1 border border-slate-700/60 text-left">항목</th>
                    <th class="px-2 py-1 border border-slate-700/60 text-right">{{ years_25 }}년</th>
                    <th class="px-2 py-1 border border-slate-700/60 text-right">{{ years_pf }}년</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="bg-yellow-300/95 text-slate-900 font-bold">
                    <td class="px-2 py-1 border border-slate-700/60">영업활동</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("op_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("op_pf_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">영업이익</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(prof.get("ebit_25_total_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(prof.get("ebit_pf_total_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">감가상각비</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-prof.get("depr_25_total_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-prof.get("depr_pf_total_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">이자비용</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-prof.get("int_25_total_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-prof.get("int_pf_total_won")) }}</td>
                  </tr>

                  <tr class="bg-yellow-300/95 text-slate-900 font-bold">
                    <td class="px-2 py-1 border border-slate-700/60">투자활동</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("inv_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("inv_pf_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">토지구입</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("land_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("land_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">모듈구입</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("module_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("module_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">시공비</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("construction_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("construction_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">기타 자산</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("other_asset_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cap.get("other_asset_won")) }}</td>
                  </tr>

                  <tr class="bg-yellow-300/95 text-slate-900 font-bold">
                    <td class="px-2 py-1 border border-slate-700/60">재무활동</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("fin_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("fin_pf_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">대출실행(차입)</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("loan_draw_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("loan_draw_pf_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">대출상환</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cf.get("loan_repay_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(-cf.get("loan_repay_pf_won")) }}</td>
                  </tr>

                  <tr class="bg-yellow-300/95 text-slate-900 font-bold">
                    <td class="px-2 py-1 border border-slate-700/60">순현금흐름</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("net_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("net_pf_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">토지</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cap.get("land_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cap.get("land_won")) }}</td>
                  </tr>
                  <tr>
                    <td class="px-2 py-1 border border-slate-700/60">순현금흐름(토지 제외)</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("net_exland_25_won")) }}</td>
                    <td class="px-2 py-1 border border-slate-700/60 text-right">{{ kfmt_signed(cf.get("net_exland_pf_won")) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-2 text-[10px] text-slate-400">
              ※ 단위: 천원(KRW). 음수는 괄호()로 표기됩니다.
            </div>
            {% if ai_analysis and ai_analysis.ai_summary %}
              <div class="mt-3 text-[11px] text-slate-300/90">
                <span class="font-bold text-slate-100">AI 통합 분석 코멘트(원본):</span>
                {{ ai_analysis.ai_summary }}
              </div>
            {% endif %}
          {% else %}
            <div class="text-[11px] text-slate-400">
              통합 분석 계산 정보가 전달되지 않아 상세 현금흐름 표를 생성하지 못했습니다. /solar 화면에서 통합 분석을 실행한 뒤 다시 리포트를 생성하면 이 표가 채워집니다.
            </div>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2 mt-6">
          <form method="POST" action="/api/report/pdf">
            <input type="hidden" name="payload" value="{{ payload_json|e }}">
            <button class="px-4 py-2 rounded-xl bg-slate-100 text-slate-900 font-extrabold hover:bg-white" type="submit">PDF 즉시 출력</button>
          </form>
          <a class="px-4 py-2 rounded-xl bg-white/10 border border-white/10 font-extrabold hover:bg-white/15" href="javascript:window.print()">브라우저 인쇄</a>
        </div>
      </div>
    </div>
  </div>

<script>
  const payload = {{ payload_json|safe }};
  const roi = (payload.finance && payload.finance.roi25y) ? payload.finance.roi25y : {};
  const cfNoRaw = Array.isArray(roi.cashflows_no_land) ? roi.cashflows_no_land : [];
  const cfWithRaw = Array.isArray(roi.cashflows_with_land) ? roi.cashflows_with_land : cfNoRaw;
  const landPrice = (roi && typeof roi.land_price_won === "number") ? roi.land_price_won : null;

  const dscrYearsRaw = Array.isArray(roi.dscr_years) ? roi.dscr_years : [];
  const dscrMinRaw = (typeof roi.dscr_min === "number") ? roi.dscr_min : null;
  const dscrAvgRaw = (typeof roi.dscr_avg === "number") ? roi.dscr_avg : null;

  // State
  let landMode = (landPrice && landPrice > 0) ? "buy" : "own"; // buy | own
  let scenarioFactor = parseFloat(document.getElementById("scenarioSel")?.value || "1.0") || 1.0;

  // Buttons style
  function setBtnActive(id, active){
    const b = document.getElementById(id);
    if(!b) return;
    if(active){
      b.classList.add("bg-slate-100","text-slate-900");
      b.classList.remove("bg-white/10","text-slate-100");
    }else{
      b.classList.remove("bg-slate-100","text-slate-900");
      b.classList.add("bg-white/10","text-slate-100");
    }
  }

  function getSeries(){
    const cfNo = cfNoRaw.map(v => Math.round(v * scenarioFactor));
    const baseWith = (landMode === "own") ? cfNoRaw : cfWithRaw;
    const cfWith = baseWith.map(v => Math.round(v * scenarioFactor));
    return {cfNo, cfWith};
  }

  const labels = (cfNoRaw.length ? cfNoRaw : cfWithRaw).map((_, i) => `Y${i+1}`);

  // Charts
  function makeBar(elId, data){
    const el = document.getElementById(elId);
    if(!el) return null;
    const ctx = el.getContext('2d');
    return new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '현금흐름(원)', data }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" } },
          y: { ticks: { color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" } }
        }
      }
    });
  }

  const init = getSeries();
  const chartNo = makeBar('cfChartNoLand', init.cfNo);
  const chartWith = makeBar('cfChartWithLand', init.cfWith);

  // DSCR chart (line)
  function makeLine(elId, data){
    const el = document.getElementById(elId);
    if(!el) return null;
    const ctx = el.getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'DSCR', data, tension: 0.25 }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" } },
          y: { ticks: { color: "rgba(226,232,240,0.65)" }, grid: { color: "rgba(148,163,184,0.08)" }, suggestedMin: 0.8 }
        }
      }
    });
  }
  const dscrChart = makeLine("dscrChart", dscrYearsRaw);


  // NPV/IRR
  function fmtWon(n){
    try{ return Math.round(n).toLocaleString() + " 원"; }catch(e){ return "확인 필요"; }
  }

  function npv(ratePct, cashflows){
    const r = (ratePct/100);
    let v = 0;
    for(let i=0;i<cashflows.length;i++){
      const t = i+1;
      v += cashflows[i] / Math.pow(1+r, t);
    }
    return v;
  }

  function irr(cashflows){
    let hasNeg=false, hasPos=false;
    for(const c of cashflows){ if(c<0) hasNeg=true; if(c>0) hasPos=true; }
    if(!(hasNeg && hasPos)) return null;

    let x = 0.08;
    for(let it=0; it<40; it++){
      let f=0, df=0;
      for(let i=0;i<cashflows.length;i++){
        const t=i+1;
        const denom = Math.pow(1+x, t);
        f += cashflows[i]/denom;
        df += -t * cashflows[i] / (denom*(1+x));
      }
      if(Math.abs(df) < 1e-9) break;
      const nx = x - f/df;
      if(!isFinite(nx)) break;
      if(Math.abs(nx-x) < 1e-6) { x=nx; return x*100; }
      x = Math.max(-0.9, Math.min(2.0, nx));
    }

    let lo=-0.5, hi=1.5;
    function f(rate){
      let s=0;
      for(let i=0;i<cashflows.length;i++){
        const t=i+1;
        s += cashflows[i]/Math.pow(1+rate, t);
      }
      return s;
    }
    let flo=f(lo), fhi=f(hi);
    if(!isFinite(flo) || !isFinite(fhi) || flo*fhi>0) return null;

    for(let it=0; it<80; it++){
      const mid = (lo+hi)/2;
      const fm = f(mid);
      if(Math.abs(fm) < 1e-6) return mid*100;
      if(flo*fm <= 0){ hi=mid; fhi=fm; }
      else { lo=mid; flo=fm; }
    }
    return ((lo+hi)/2)*100;
  }

  function recomputeRoiMetrics(){
    const rate = parseFloat(document.getElementById("discountRate")?.value || "6") || 6;
    const {cfNo, cfWith} = getSeries();

    // Update charts
    if(chartNo){ chartNo.data.datasets[0].data = cfNo; chartNo.update(); }
    if(chartWith){ chartWith.data.datasets[0].data = cfWith; chartWith.update(); }

    // Update NPV/IRR
    const nNo = npv(rate, cfNo);
    const nWith = npv(rate, cfWith);
    const iNo = irr(cfNo);
    const iWith = irr(cfWith);

    const npvNoEl = document.getElementById("npvNo");
    const npvWithEl = document.getElementById("npvWith");
    const irrNoEl = document.getElementById("irrNo");
    const irrWithEl = document.getElementById("irrWith");

    if(npvNoEl) npvNoEl.innerText = fmtWon(nNo);
    if(npvWithEl) npvWithEl.innerText = fmtWon(nWith);
    if(irrNoEl) irrNoEl.innerText = (iNo===null ? "확인 필요" : (iNo.toFixed(2) + " %"));
    if(irrWithEl) irrWithEl.innerText = (iWith===null ? "확인 필요" : (iWith.toFixed(2) + " %"));

    const landNote = document.getElementById("landNote");
    if(landNote){
      if(landMode === "own"){
        landNote.innerText = "토지 보유 가정: 토지가격을 사업비에 반영하지 않습니다.";
      }else{
        landNote.innerText = landPrice ? ("토지 구매 가정: 1년차에 토지가격을 upfront로 반영합니다.") : "토지 구매 가정: 토지가격 데이터가 없어 포함/제외 차이가 없을 수 있습니다.";
      }
    }

    setBtnActive("landOwnBtn", landMode==="own");
    setBtnActive("landBuyBtn", landMode==="buy");

    // DSCR UI (PF 기간은 시나리오/토지모드와 무관하게 동일; 단, 시나리오에 따라 CADS가 바뀌므로 재계산)
    const dscrMinEl = document.getElementById("dscrMin");
    const dscrAvgEl = document.getElementById("dscrAvg");
    if(dscrMinEl) dscrMinEl.innerText = (dscrMinRaw===null ? "확인 필요" : dscrMinRaw.toFixed(2));
    if(dscrAvgEl) dscrAvgEl.innerText = (dscrAvgRaw===null ? "확인 필요" : dscrAvgRaw.toFixed(2));

    // Verdict
    const thr = parseFloat(document.getElementById("dscrThreshold")?.value || "1.2") || 1.2;
    const verdictEl = document.getElementById("pfVerdict");
    if(verdictEl){
      if(dscrMinRaw===null){
        verdictEl.innerText = "확인 필요";
        verdictEl.className = "mt-3 text-sm font-extrabold";
      }else if(dscrMinRaw >= thr){
        verdictEl.innerText = `PF 가능(보수) ✅  최소 DSCR ${dscrMinRaw.toFixed(2)} ≥ ${thr.toFixed(2)}`;
        verdictEl.className = "mt-3 text-sm font-extrabold text-emerald-200";
      }else{
        verdictEl.innerText = `PF 리스크 ⚠️  최소 DSCR ${dscrMinRaw.toFixed(2)} < ${thr.toFixed(2)}`;
        verdictEl.className = "mt-3 text-sm font-extrabold text-amber-200";
      }
    }
  }

    document.getElementById("recalcPf")?.addEventListener("click", (e)=>{ 
    e.preventDefault(); 
    recomputeRoiMetrics(); 
  });
  document.getElementById("recalcRoi")?.addEventListener("click", (e)=>{ 
    e.preventDefault(); 
    recomputeRoiMetrics(); 
  });
  document.getElementById("scenarioSel")?.addEventListener("change", (e)=>{ 
    scenarioFactor = parseFloat(e.target.value || "1") || 1; 
    recomputeRoiMetrics(); 
  });
  document.getElementById("landOwnBtn")?.addEventListener("click", (e)=>{ 
    e.preventDefault(); 
    landMode = "own"; 
    recomputeRoiMetrics(); 
  });
  document.getElementById("landBuyBtn")?.addEventListener("click", (e)=>{ 
    e.preventDefault(); 
    landMode = "buy"; 
    recomputeRoiMetrics(); 
  });

  // init state
  setBtnActive("landOwnBtn", landMode==="own");
  setBtnActive("landBuyBtn", landMode==="buy");
  recomputeRoiMetrics();
</script>
</body>
</html>
