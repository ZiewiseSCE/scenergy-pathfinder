<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar Pathfinder - Admin</title>
  
  <style>
    :root{
      --bg1:#040816;
      --bg2:#06122f;
      --card:#0c1636cc;
      --stroke:rgba(255,255,255,.14);
      --text:#e8eeff;
      --muted:#a9b8e8;
      --accent:#6ee7ff;
      --accent2:#34d399;
      --warn:#fbbf24;
      --bad:#ff6b6b;
      --ok:#34d399;
      --shadow: 0 24px 60px rgba(0,0,0,.55);
      --blur: 14px;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 700px at 10% 15%, rgba(110,231,255,0.08), transparent),
        radial-gradient(1000px 800px at 90% 85%, rgba(52,211,153,0.08), transparent),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }
    .wrap{
      max-width:900px; margin:0 auto; padding:40px 20px;
      display:flex; flex-direction:column; gap:30px;
    }
    header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
    }
    h1{ margin:0; font-size:1.8rem; font-weight:800; letter-spacing:-0.5px;
      background:linear-gradient(135deg, #fff 30%, var(--muted));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .status{ font-size:0.85rem; color:var(--muted); font-weight:500; }
    
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:24px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(var(--blur));
      transition:transform 0.2s;
    }
    .card:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,0.25); }
    h2{ margin:0 0 16px 0; font-size:1.1rem; color:var(--accent); display:flex; align-items:center; gap:8px;}
    
    label{ display:block; margin-bottom:6px; font-size:0.8rem; color:var(--muted); font-weight:600; }
    input, select{
      width:100%; padding:12px; border-radius:12px;
      background:rgba(0,0,0,0.3); border:1px solid var(--stroke);
      color:#fff; font-size:0.95rem; margin-bottom:16px;
      transition: all 0.2s;
    }
    input:focus{ outline:none; border-color:var(--accent); background:rgba(0,0,0,0.5); }
    
    .btns{ display:flex; gap:10px; }
    button{
      flex:1; cursor:pointer; font-weight:700; border:none; border-radius:12px;
      padding:12px; font-size:0.9rem; transition:filter 0.2s;
      color:#000;
    }
    button:hover{ filter:brightness(1.1); }
    button.primary{ background:var(--accent); }
    button.sec{ background:var(--muted); }
    button.del{ background:var(--bad); color:#fff; }

    table{
      width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px;
    }
    th{ text-align:left; color:var(--muted); padding:8px; border-bottom:1px solid var(--stroke); }
    td{ padding:12px 8px; border-bottom:1px solid rgba(255,255,255,0.05); color:#fff; vertical-align:middle; }
    tr:last-child td{ border-bottom:none; }
    .mono{ font-family:monospace; color:var(--accent2); font-size:0.95rem; }
    .bad{ color:var(--bad); }
    .ok{ color:var(--ok); }
    .revoked{ text-decoration:line-through; color:var(--muted); opacity:0.6; }

    .msg{
      margin-top:10px; padding:12px; border-radius:12px;
      background:rgba(0,0,0,0.4); border:1px solid var(--stroke);
      font-size:0.9rem; text-align:center; min-height:46px;
      display:flex; align-items:center; justify-content:center;
    }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div>
      <h1>Admin Dashboard</h1>
      <div class="status" id="connStatus">Connecting...</div>
    </div>
    <div style="text-align:right">
      <button class="sec" style="padding:8px 16px; font-size:0.8rem" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Login Form -->
  <div class="card" id="loginCard">
    <h2>ğŸ”’ Admin Access</h2>
    <label>Admin Secret Key</label>
    <input type="password" id="adminKey" placeholder="Enter admin key..." onkeydown="if(event.key==='Enter') login()" />
    <button class="primary" onclick="login()">Login</button>
    <div id="loginMsg" class="msg" style="display:none"></div>
  </div>

  <!-- Main Dashboard -->
  <div id="mainDash" style="display:none">
    
    <!-- Create License -->
    <div class="card">
      <h2>âœ¨ Create License</h2>
      <div style="display:flex; gap:10px;">
        <div style="flex:2">
          <label>Note (User Name / Memo)</label>
          <input type="text" id="newNote" placeholder="e.g. Kenny Yang" />
        </div>
        <div style="flex:1">
          <label>Valid Days</label>
          <input type="number" id="newDays" value="365" />
        </div>
      </div>
      <button class="primary" onclick="createLicense()">Issue New Key</button>
    </div>

    <!-- License List -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2>ğŸ“‹ License List</h2>
        <button class="sec" style="width:auto; padding:6px 12px; font-size:0.8rem" onclick="refreshList()">Refresh</button>
      </div>
      <div style="overflow-x:auto">
        <table id="listTable">
          <thead>
            <tr>
              <th>Token</th>
              <th>Note</th>
              <th>Expires (UTC)</th>
              <th>Status</th>
              <th>Device</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="dashMsg" class="msg">Ready.</div>
  </div>
</div>

<script>
  const API_BASE = window.location.origin; 
  const ADM_TOKEN = "solar_admin_token";

  function $(id){ return document.getElementById(id); }
  function setMsg(html){ 
    const el = $("dashMsg");
    if(el) el.innerHTML = html; 
    const l = $("loginMsg");
    if(l && l.style.display!=="none") l.innerHTML = html;
  }

  // API Wrapper with explicit logging and handling
  async function api(path, method="GET", body=null, auth=true){
    const headers = { "Content-Type": "application/json" };
    
    if(auth){
      const token = sessionStorage.getItem(ADM_TOKEN);
      if(token) {
        headers["Authorization"] = "Bearer " + token;
      } else {
        console.warn("[API] Token missing for auth request");
      }
    }

    const opts = { method, headers };
    if(body) opts.body = JSON.stringify(body);

    try {
      const res = await fetch(API_BASE + path, opts);
      const data = await res.json();
      return { res, data };
    } catch(e) {
      console.error("[API] Error:", e);
      return { res:{ok:false}, data:{msg: "Network Error"} };
    }
  }

  // --- Auth ---
  async function login(){
    const key = $("adminKey").value.trim();
    if(!key) return alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    
    $("loginMsg").style.display = "flex";
    $("loginMsg").innerText = "Checking...";
    
    const {res, data} = await api("/api/admin/login", "POST", { admin_key: key }, false);
    
    if(res.ok && data.ok){
      console.log("[Login] Success, Token:", data.token);
      sessionStorage.setItem(ADM_TOKEN, data.token);
      $("loginMsg").style.display="none";
      switchView(true);
      refreshList();
    } else {
      console.error("[Login] Failed", res.status);
      $("loginMsg").innerHTML = "<span class='bad'>Login Failed</span>";
    }
  }

  function logout(){
    sessionStorage.removeItem(ADM_TOKEN);
    window.location.reload();
  }

  async function session(){
    const t = sessionStorage.getItem(ADM_TOKEN);
    if(!t) return false;
    const {res} = await api("/api/auth/whoami", "GET");
    if(!res.ok) console.warn("[Session] check failed", res.status);
    return res.ok;
  }

  function switchView(isLoggedIn){
    if(isLoggedIn){
      $("loginCard").style.display = "none";
      $("mainDash").style.display = "block";
      $("connStatus").innerText = "Connected (Admin)";
      $("connStatus").style.color = "var(--ok)";
    } else {
      $("loginCard").style.display = "block";
      $("mainDash").style.display = "none";
      $("connStatus").innerText = "Disconnected";
      $("connStatus").style.color = "var(--muted)";
    }
  }

  // --- Logic ---
  async function createLicense(){
    const note = $("newNote").value.trim();
    const days = $("newDays").value;
    if(!note) return alert("Note(ì´ë¦„)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    
    setMsg("ìƒì„± ì¤‘...");
    // Check session first to avoid confusing 401s
    if(!sessionStorage.getItem(ADM_TOKEN)) return logout();

    const {res, data} = await api("/api/admin/license/create", "POST", {note, days}, true);
    
    if(res.ok && data.ok){
      setMsg("<span class='ok'>ìƒì„± ì™„ë£Œ!</span> " + data.item.token);
      $("newNote").value="";
      refreshList();
    } else {
      if(res.status === 401) {
        alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        logout();
        return;
      }
      setMsg("<span class='bad'>ì‹¤íŒ¨</span> " + (data.msg||"Error"));
    }
  }

  async function refreshList(){
    const {res, data} = await api("/api/admin/licenses", "GET", null, true);
    if(res.ok && data.ok){
      renderList(data.items);
      setMsg("ëª©ë¡ ê°±ì‹ ë¨ (" + new Date().toLocaleTimeString() + ")");
    } else {
      if(res.status===401) logout();
      setMsg("<span class='bad'>ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</span>");
    }
  }

  function renderList(items){
    const tbody = $("listTable").querySelector("tbody");
    tbody.innerHTML = "";
    if(!items || items.length===0){
      tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px'>ë°ì´í„° ì—†ìŒ</td></tr>";
      return;
    }
    
    items.forEach(it => {
      const isRevoked = it.revoked;
      const isExpired = new Date(it.expires_at) < new Date();
      const stClass = isRevoked ? "bad" : (isExpired ? "warn" : "ok");
      const status = isRevoked ? "REVOKED" : (isExpired ? "EXPIRED" : "ACTIVE");
      
      let fpDisplay = "-";
      if(it.bound_fp) fpDisplay = `<span title="${it.bound_fp}">ğŸ”’ Bound</span>`;
      else if(it.fingerprints && it.fingerprints.length > 0) fpDisplay = `<span title="${it.fingerprints[0]}">ğŸ”’ Bound</span>`;

      const tr = document.createElement("tr");
      if(isRevoked) tr.classList.add("revoked");
      
      tr.innerHTML = `
        <td class="mono" style="font-weight:bold">${it.token}</td>
        <td>${it.note}</td>
        <td class="mono" style="font-size:0.8rem">${it.expires_at.split('T')[0]}</td>
        <td class="${stClass}" style="font-weight:bold">${status}</td>
        <td>${fpDisplay}</td>
        <td>
           <button class="sec" style="padding:4px 8px; font-size:0.75rem" onclick="resetFP('${it.token}')">Reset</button>
           <button class="sec" style="padding:4px 8px; font-size:0.75rem" onclick="extendKey('${it.token}')">Extend</button>
           <button class="del" style="padding:4px 8px; font-size:0.75rem" onclick="deleteKey('${it.token}')">Del</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function resetFP(token){
    if(!confirm("ì´ í‚¤ì˜ ë°”ì¸ë”©(ë””ë°”ì´ìŠ¤ ì¸ì¦)ì„ ë¦¬ì…‹í• ê¹Œìš”?\n" + token)) return;
    setMsg("ë¦¬ì…‹ ì¤‘...");
    const {res,data} = await api("/api/admin/license/reset", "POST", {token}, true);
    if(res.ok && data.ok){
      setMsg("<span class='ok'>ë¦¬ì…‹ OK</span>");
      await refreshList(); return;
    }
    if(res.status===401) return logout();
    setMsg("<span class='bad'>ë¦¬ì…‹ ì‹¤íŒ¨</span> " + (data.msg||res.status));
  }

  async function extendKey(token){
    const days = parseInt(prompt("ì—°ì¥í•  ì¼ìˆ˜(days)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 30)", "30")||"",10);
    if(!days) return;
    setMsg("ì—°ì¥ ì¤‘...");
    const {res,data} = await api("/api/admin/license/extend", "POST", {token, days}, true);
    if(res.ok && data.ok){
      setMsg("<span class='ok'>ì—°ì¥ OK</span> (expires: " + data.expires_at + ")");
      await refreshList(); return;
    }
    if(res.status===401) return logout();
    setMsg("<span class='bad'>ì—°ì¥ ì‹¤íŒ¨</span> " + (data.msg||res.status));
  }

  async function deleteKey(token){
    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n" + token)) return;
    const {res,data} = await api("/api/admin/license/delete", "POST", {token}, true);
    if(res.ok && data.ok){
      setMsg("ì‚­ì œë¨");
      refreshList();
    } else {
      if(res.status===401) return logout();
      setMsg("ì‚­ì œ ì‹¤íŒ¨");
    }
  }

  // Init check
  (async ()=>{
    if(sessionStorage.getItem(ADM_TOKEN)){
      const ok = await session();
      if(ok){
        switchView(true);
        refreshList();
      } else {
        sessionStorage.removeItem(ADM_TOKEN);
        switchView(false);
      }
    } else {
      switchView(false);
    }
  })();
</script>

</body>
</html>
